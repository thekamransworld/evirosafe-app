
==================================================
FILE: .\bundle.js
==================================================

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const outputFile = 'full_project_code.txt';
// Extensions to include
const includedExtensions = ['.ts', '.tsx', '.js', '.jsx', '.css', '.sql', '.json'];
// Folders to ignore
const excludedDirs = ['node_modules', '.git', 'dist', 'build', 'coverage', '.vscode'];

function getAllFiles(dirPath, arrayOfFiles) {
  const files = fs.readdirSync(dirPath);
  arrayOfFiles = arrayOfFiles || [];

  files.forEach(function(file) {
    const fullPath = path.join(dirPath, file);
    if (fs.statSync(fullPath).isDirectory()) {
      if (!excludedDirs.includes(file)) {
        arrayOfFiles = getAllFiles(fullPath, arrayOfFiles);
      }
    } else {
      if (includedExtensions.includes(path.extname(file))) {
        arrayOfFiles.push(fullPath);
      }
    }
  });
  return arrayOfFiles;
}

const allFiles = getAllFiles(__dirname);
let outputContent = '';

console.log(`Bundling ${allFiles.length} files...`);

allFiles.forEach(filePath => {
  const relativePath = path.relative(__dirname, filePath);
  if (relativePath === 'bundle.js' || relativePath === outputFile) return;
  
  try {
    const content = fs.readFileSync(filePath, 'utf8');
    outputContent += `\n\n--- START OF FILE ${relativePath} ---\n\n`;
    outputContent += content;
  } catch (err) {
    console.error(`Error reading ${relativePath}`);
  }
});

fs.writeFileSync(outputFile, outputContent);
console.log(`Done! Please upload '${outputFile}' to the chat.`);

==================================================
FILE: .\cors.json
==================================================

'[{"origin": ["*"],"method": ["GET", "HEAD", "PUT", "POST", "DELETE"],"maxAgeSeconds": 3600}]' 


==================================================
FILE: .\db_schema.sql
==================================================

-- ENABLE UUID
create extension if not exists "uuid-ossp";

-- ORGANIZATIONS
create table organizations (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  slug text unique not null,
  domain text,
  status text default 'active',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- USERS
create table users (
  id uuid primary key, -- matches auth.users.id
  org_id uuid references organizations(id),
  email text not null,
  name text not null,
  role text not null default 'WORKER',
  status text default 'active',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- PROJECTS
create table projects (
  id uuid default uuid_generate_v4() primary key,
  org_id uuid references organizations(id),
  name text not null,
  location text,
  status text default 'active',
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- REPORTS (Incidents, Observations)
create table reports (
  id uuid default uuid_generate_v4() primary key,
  org_id uuid references organizations(id),
  project_id uuid references projects(id),
  reporter_id uuid references users(id),
  type text not null,
  description text,
  risk_severity int,
  risk_likelihood int,
  status text default 'submitted',
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- PERMITS (PTW)
create table ptws (
  id uuid default uuid_generate_v4() primary key,
  org_id uuid references organizations(id),
  project_id uuid references projects(id),
  type text not null,
  status text default 'DRAFT',
  payload jsonb default '{}'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- RLS POLICIES (Row Level Security)
alter table organizations enable row level security;
alter table users enable row level security;
alter table projects enable row level security;
alter table reports enable row level security;
alter table ptws enable row level security;

-- Example Policy: Users can read data from their own organization
create policy "Users can view own org data" on organizations
  for select using (id = (select org_id from users where id = auth.uid()));

==================================================
FILE: .\index.html
==================================================

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    />
    
    <!-- FIXED: Mobile Viewport & PWA Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="EviroSafe" />

    <!-- Clean Title -->
    <title>EviroSafe | Next-Gen HSE Command Center</title>

    <meta
      name="description"
      content="EviroSafe 3.0 - The intelligent HSE management platform for modern construction and industrial sites."
    />
    <meta name="theme-color" content="#020617" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-color: #f8fafc;
        --text-color: #0f172a;
      }
      .dark {
        --bg-color: #020617;
        --text-color: #f8fafc;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s ease, color 0.3s ease;
        overscroll-behavior-y: none; /* Prevents pull-to-refresh on mobile */
      }

      /* Glassmorphism utilities */
      .dark .glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .glass-panel {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .dark .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #334155;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      .dark ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "react": "https://aistudiocdn.com/react@^19.2.0",
          "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
          "react/": "https://aistudiocdn.com/react@^19.2.0/",
          "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
          "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0",
          "recharts": "https://aistudiocdn.com/recharts@^3.5.0",
          "vite": "https://aistudiocdn.com/vite@^7.2.4",
          "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
        }
      }
    </script>
    <link rel="stylesheet" href="/src/index.css" />
  </head>
  <body class="font-sans antialiased">
    <div id="root"></div>
    <script type="module" src="/src/index.tsx"></script>
  </body>
</html>

==================================================
FILE: .\metadata.json
==================================================

{
  "name": "EviroSafe",
  "description": "A smart HSE tool for comprehensive safety management, featuring AI-powered risk assessment, training, and reporting.",
  "requestFramePermissions": [
    "geolocation"
  ]
}

==================================================
FILE: .\package.json
==================================================

{
  "name": "evirosafe-app",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@emailjs/browser": "^4.1.0",
    "@google/generative-ai": "^0.1.3",
    "firebase": "^10.8.0",
    "html2canvas": "^1.4.1",
    "jspdf": "^2.5.1",
    "jspdf-autotable": "^3.8.2",
    "lucide-react": "^0.344.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-markdown": "^9.0.1",
    "recharts": "^2.12.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/react": "^18.2.56",
    "@types/react-dom": "^18.2.19",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.2.2",
    "vite": "^5.1.4",
    "vite-plugin-pwa": "^0.19.0"
  }
}

==================================================
FILE: .\postcss.config.js
==================================================

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

==================================================
FILE: .\tailwind.config.js
==================================================

/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}", // <--- FIXED: Only scans src folder to prevent build crashes
  ],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
      },
      colors: {
        primary: {
          50: '#f0fdfa',
          100: '#ccfbf1',
          200: '#99f6e4',
          300: '#5eead4',
          400: '#2dd4bf',
          500: '#14b8a6',
          600: '#0d9488',
          700: '#0f766e',
          800: '#115e59',
          900: '#134e4a',
          950: '#042f2e',
        },
        // Cinematic Dark Theme Colors
        background: 'transparent',
        'border-color': 'rgba(255, 255, 255, 0.08)',
        'text-primary': 'var(--text-color)', // Uses CSS variable from index.html
        'text-secondary': '#94a3b8', // Slate 400
        
        // Specific Overrides
        'dark-surface': '#0f172a', // Solid Slate 900
        'dark-background': '#030712', // Almost pure black blue
        'dark-card': 'rgba(17, 24, 39, 0.7)', // Deep blue-grey glass
        'dark-border': 'rgba(255, 255, 255, 0.08)',
        
        // Premium Neon Accents (High Luminance)
        'neon-green': '#34d399', // Emerald 400
        'neon-blue': '#38bdf8',   // Sky 400
        'neon-purple': '#c084fc', // Purple 400
        'neon-pink': '#f472b6',   // Pink 400
        'neon-orange': '#fb923c', // Orange 400
        'neon-yellow': '#facc15', // Yellow 400
      },
      boxShadow: {
        'neon': '0 0 20px rgba(52, 211, 153, 0.4)',
        'neon-blue': '0 0 20px rgba(56, 189, 248, 0.4)',
        'glass': '0 25px 50px -12px rgba(0, 0, 0, 0.5)',
        'glow-sm': '0 0 10px rgba(255,255,255,0.1)',
      },
      animation: {
        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        'glow-move': 'glowMove 20s ease-in-out infinite alternate',
        'pulse-glow': 'pulseGlow 3s infinite',
        'spin-slow': 'spin 15s linear infinite',
        'fade-in': 'fadeIn 0.6s ease-out forwards',
        'bump': 'bump 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
      },
      keyframes: {
        glowMove: {
          '0%': { backgroundPosition: '0% 0%' },
          '100%': { backgroundPosition: '100% 100%' },
        },
        pulseGlow: {
          '0%': { boxShadow: '0 0 0 rgba(248,113,113,0)', borderColor: 'rgba(248,113,113,0.3)' },
          '50%': { boxShadow: '0 0 20px rgba(248,113,113,0.4)', borderColor: 'rgba(248,113,113,0.8)' },
          '100%': { boxShadow: '0 0 0 rgba(248,113,113,0)', borderColor: 'rgba(248,113,113,0.3)' },
        },
        fadeIn: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        bump: {
          '0%': { transform: 'scale(1)' },
          '50%': { transform: 'scale(1.2)', filter: 'brightness(1.5)' },
          '100%': { transform: 'scale(1)' },
        }
      }
    }
  },
  plugins: [],
}

==================================================
FILE: .\tsconfig.json
==================================================

{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": [
      "ES2020",
      "DOM",
      "DOM.Iterable"
    ],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": false, 
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx",
    "vite.config.ts"
  ],
  "exclude": [
    "**/*.test.ts",
    "**/*.test.tsx",
    "dev-dist",
    "dev-dist/**",
    "dist",
    "node_modules"
  ]
}

==================================================
FILE: .\vercel.json
==================================================

{
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}

==================================================
FILE: .\vite.config.ts
==================================================

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'icons/evirosafe-192.png', 'icons/evirosafe-512.png'],
      manifest: {
        name: 'EviroSafe HSE Manager',
        short_name: 'EviroSafe',
        description: 'Next-Gen HSE Command Center',
        theme_color: '#020617',
        background_color: '#020617',
        display: 'standalone',
        icons: [
          {
            src: '/icons/evirosafe-192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: '/icons/evirosafe-512.png',
            sizes: '512x512',
            type: 'image/png'
          }
        ]
      },
      workbox: {
        maximumFileSizeToCacheInBytes: 5 * 1024 * 1024, // 5MB limit
        globPatterns: ['**/*.{js,css,html,ico,png,svg}']
      },
      devOptions: {
        enabled: true
      }
    })
  ],
  build: {
    chunkSizeWarningLimit: 1600, // Increase chunk size warning limit
    rollupOptions: {
      output: {
        manualChunks(id) {
          if (id.includes('node_modules')) {
            return 'vendor'; // Split vendor code into separate chunk
          }
        }
      }
    }
  }
});

==================================================
FILE: .\.vercel\project.json
==================================================

{"projectId":"prj_2gd264q7GjMdk1mfcmHqignbfWud","orgId":"team_m7AwtqnBhayLbk5zCQbWJkzE","projectName":"evirosafe-app-main"}

==================================================
FILE: .\dev-dist\registerSW.js
==================================================

if('serviceWorker' in navigator) navigator.serviceWorker.register('/dev-sw.js?dev-sw', { scope: '/', type: 'classic' })

==================================================
FILE: .\dev-dist\sw.js
==================================================

/**
 * Copyright 2018 Google Inc. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// If the loader is already loaded, just stop.
if (!self.define) {
  let registry = {};

  // Used for `eval` and `importScripts` where we can't get script URL by other means.
  // In both cases, it's safe to use a global var because those functions are synchronous.
  let nextDefineUri;

  const singleRequire = (uri, parentUri) => {
    uri = new URL(uri + ".js", parentUri).href;
    return registry[uri] || (
      
        new Promise(resolve => {
          if ("document" in self) {
            const script = document.createElement("script");
            script.src = uri;
            script.onload = resolve;
            document.head.appendChild(script);
          } else {
            nextDefineUri = uri;
            importScripts(uri);
            resolve();
          }
        })
      
      .then(() => {
        let promise = registry[uri];
        if (!promise) {
          throw new Error(`Module ${uri} didnâ€™t register its module`);
        }
        return promise;
      })
    );
  };

  self.define = (depsNames, factory) => {
    const uri = nextDefineUri || ("document" in self ? document.currentScript.src : "") || location.href;
    if (registry[uri]) {
      // Module is already loading or loaded.
      return;
    }
    let exports = {};
    const require = depUri => singleRequire(depUri, uri);
    const specialDeps = {
      module: { uri },
      exports,
      require
    };
    registry[uri] = Promise.all(depsNames.map(
      depName => specialDeps[depName] || require(depName)
    )).then(deps => {
      factory(...deps);
      return exports;
    });
  };
}
define(['./workbox-5a5d9309'], (function (workbox) { 'use strict';

  self.skipWaiting();
  workbox.clientsClaim();

  /**
   * The precacheAndRoute() method efficiently caches and responds to
   * requests for URLs in the manifest.
   * See https://goo.gl/S9QRab
   */
  workbox.precacheAndRoute([{
    "url": "registerSW.js",
    "revision": "3ca0b8505b4bec776b69afdba2768812"
  }, {
    "url": "index.html",
    "revision": "0.ihj0h30l92g"
  }], {});
  workbox.cleanupOutdatedCaches();
  workbox.registerRoute(new workbox.NavigationRoute(workbox.createHandlerBoundToURL("index.html"), {
    allowlist: [/^\/$/]
  }));

}));


==================================================
FILE: .\dev-dist\workbox-5a5d9309.js
==================================================

define(['exports'], (function (exports) { 'use strict';

    // @ts-ignore
    try {
      self['workbox:core:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Claim any currently available clients once the service worker
     * becomes active. This is normally used in conjunction with `skipWaiting()`.
     *
     * @memberof workbox-core
     */
    function clientsClaim() {
      self.addEventListener('activate', () => self.clients.claim());
    }

    /*
      Copyright 2019 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const logger = (() => {
      // Don't overwrite this value if it's already set.
      // See https://github.com/GoogleChrome/workbox/pull/2284#issuecomment-560470923
      if (!('__WB_DISABLE_DEV_LOGS' in globalThis)) {
        self.__WB_DISABLE_DEV_LOGS = false;
      }
      let inGroup = false;
      const methodToColorMap = {
        debug: `#7f8c8d`,
        log: `#2ecc71`,
        warn: `#f39c12`,
        error: `#c0392b`,
        groupCollapsed: `#3498db`,
        groupEnd: null // No colored prefix on groupEnd
      };
      const print = function (method, args) {
        if (self.__WB_DISABLE_DEV_LOGS) {
          return;
        }
        if (method === 'groupCollapsed') {
          // Safari doesn't print all console.groupCollapsed() arguments:
          // https://bugs.webkit.org/show_bug.cgi?id=182754
          if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
            console[method](...args);
            return;
          }
        }
        const styles = [`background: ${methodToColorMap[method]}`, `border-radius: 0.5em`, `color: white`, `font-weight: bold`, `padding: 2px 0.5em`];
        // When in a group, the workbox prefix is not displayed.
        const logPrefix = inGroup ? [] : ['%cworkbox', styles.join(';')];
        console[method](...logPrefix, ...args);
        if (method === 'groupCollapsed') {
          inGroup = true;
        }
        if (method === 'groupEnd') {
          inGroup = false;
        }
      };
      // eslint-disable-next-line @typescript-eslint/ban-types
      const api = {};
      const loggerMethods = Object.keys(methodToColorMap);
      for (const key of loggerMethods) {
        const method = key;
        api[method] = (...args) => {
          print(method, args);
        };
      }
      return api;
    })();

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const messages = {
      'invalid-value': ({
        paramName,
        validValueDescription,
        value
      }) => {
        if (!paramName || !validValueDescription) {
          throw new Error(`Unexpected input to 'invalid-value' error.`);
        }
        return `The '${paramName}' parameter was given a value with an ` + `unexpected value. ${validValueDescription} Received a value of ` + `${JSON.stringify(value)}.`;
      },
      'not-an-array': ({
        moduleName,
        className,
        funcName,
        paramName
      }) => {
        if (!moduleName || !className || !funcName || !paramName) {
          throw new Error(`Unexpected input to 'not-an-array' error.`);
        }
        return `The parameter '${paramName}' passed into ` + `'${moduleName}.${className}.${funcName}()' must be an array.`;
      },
      'incorrect-type': ({
        expectedType,
        paramName,
        moduleName,
        className,
        funcName
      }) => {
        if (!expectedType || !paramName || !moduleName || !funcName) {
          throw new Error(`Unexpected input to 'incorrect-type' error.`);
        }
        const classNameStr = className ? `${className}.` : '';
        return `The parameter '${paramName}' passed into ` + `'${moduleName}.${classNameStr}` + `${funcName}()' must be of type ${expectedType}.`;
      },
      'incorrect-class': ({
        expectedClassName,
        paramName,
        moduleName,
        className,
        funcName,
        isReturnValueProblem
      }) => {
        if (!expectedClassName || !moduleName || !funcName) {
          throw new Error(`Unexpected input to 'incorrect-class' error.`);
        }
        const classNameStr = className ? `${className}.` : '';
        if (isReturnValueProblem) {
          return `The return value from ` + `'${moduleName}.${classNameStr}${funcName}()' ` + `must be an instance of class ${expectedClassName}.`;
        }
        return `The parameter '${paramName}' passed into ` + `'${moduleName}.${classNameStr}${funcName}()' ` + `must be an instance of class ${expectedClassName}.`;
      },
      'missing-a-method': ({
        expectedMethod,
        paramName,
        moduleName,
        className,
        funcName
      }) => {
        if (!expectedMethod || !paramName || !moduleName || !className || !funcName) {
          throw new Error(`Unexpected input to 'missing-a-method' error.`);
        }
        return `${moduleName}.${className}.${funcName}() expected the ` + `'${paramName}' parameter to expose a '${expectedMethod}' method.`;
      },
      'add-to-cache-list-unexpected-type': ({
        entry
      }) => {
        return `An unexpected entry was passed to ` + `'workbox-precaching.PrecacheController.addToCacheList()' The entry ` + `'${JSON.stringify(entry)}' isn't supported. You must supply an array of ` + `strings with one or more characters, objects with a url property or ` + `Request objects.`;
      },
      'add-to-cache-list-conflicting-entries': ({
        firstEntry,
        secondEntry
      }) => {
        if (!firstEntry || !secondEntry) {
          throw new Error(`Unexpected input to ` + `'add-to-cache-list-duplicate-entries' error.`);
        }
        return `Two of the entries passed to ` + `'workbox-precaching.PrecacheController.addToCacheList()' had the URL ` + `${firstEntry} but different revision details. Workbox is ` + `unable to cache and version the asset correctly. Please remove one ` + `of the entries.`;
      },
      'plugin-error-request-will-fetch': ({
        thrownErrorMessage
      }) => {
        if (!thrownErrorMessage) {
          throw new Error(`Unexpected input to ` + `'plugin-error-request-will-fetch', error.`);
        }
        return `An error was thrown by a plugins 'requestWillFetch()' method. ` + `The thrown error message was: '${thrownErrorMessage}'.`;
      },
      'invalid-cache-name': ({
        cacheNameId,
        value
      }) => {
        if (!cacheNameId) {
          throw new Error(`Expected a 'cacheNameId' for error 'invalid-cache-name'`);
        }
        return `You must provide a name containing at least one character for ` + `setCacheDetails({${cacheNameId}: '...'}). Received a value of ` + `'${JSON.stringify(value)}'`;
      },
      'unregister-route-but-not-found-with-method': ({
        method
      }) => {
        if (!method) {
          throw new Error(`Unexpected input to ` + `'unregister-route-but-not-found-with-method' error.`);
        }
        return `The route you're trying to unregister was not  previously ` + `registered for the method type '${method}'.`;
      },
      'unregister-route-route-not-registered': () => {
        return `The route you're trying to unregister was not previously ` + `registered.`;
      },
      'queue-replay-failed': ({
        name
      }) => {
        return `Replaying the background sync queue '${name}' failed.`;
      },
      'duplicate-queue-name': ({
        name
      }) => {
        return `The Queue name '${name}' is already being used. ` + `All instances of backgroundSync.Queue must be given unique names.`;
      },
      'expired-test-without-max-age': ({
        methodName,
        paramName
      }) => {
        return `The '${methodName}()' method can only be used when the ` + `'${paramName}' is used in the constructor.`;
      },
      'unsupported-route-type': ({
        moduleName,
        className,
        funcName,
        paramName
      }) => {
        return `The supplied '${paramName}' parameter was an unsupported type. ` + `Please check the docs for ${moduleName}.${className}.${funcName} for ` + `valid input types.`;
      },
      'not-array-of-class': ({
        value,
        expectedClass,
        moduleName,
        className,
        funcName,
        paramName
      }) => {
        return `The supplied '${paramName}' parameter must be an array of ` + `'${expectedClass}' objects. Received '${JSON.stringify(value)},'. ` + `Please check the call to ${moduleName}.${className}.${funcName}() ` + `to fix the issue.`;
      },
      'max-entries-or-age-required': ({
        moduleName,
        className,
        funcName
      }) => {
        return `You must define either config.maxEntries or config.maxAgeSeconds` + `in ${moduleName}.${className}.${funcName}`;
      },
      'statuses-or-headers-required': ({
        moduleName,
        className,
        funcName
      }) => {
        return `You must define either config.statuses or config.headers` + `in ${moduleName}.${className}.${funcName}`;
      },
      'invalid-string': ({
        moduleName,
        funcName,
        paramName
      }) => {
        if (!paramName || !moduleName || !funcName) {
          throw new Error(`Unexpected input to 'invalid-string' error.`);
        }
        return `When using strings, the '${paramName}' parameter must start with ` + `'http' (for cross-origin matches) or '/' (for same-origin matches). ` + `Please see the docs for ${moduleName}.${funcName}() for ` + `more info.`;
      },
      'channel-name-required': () => {
        return `You must provide a channelName to construct a ` + `BroadcastCacheUpdate instance.`;
      },
      'invalid-responses-are-same-args': () => {
        return `The arguments passed into responsesAreSame() appear to be ` + `invalid. Please ensure valid Responses are used.`;
      },
      'expire-custom-caches-only': () => {
        return `You must provide a 'cacheName' property when using the ` + `expiration plugin with a runtime caching strategy.`;
      },
      'unit-must-be-bytes': ({
        normalizedRangeHeader
      }) => {
        if (!normalizedRangeHeader) {
          throw new Error(`Unexpected input to 'unit-must-be-bytes' error.`);
        }
        return `The 'unit' portion of the Range header must be set to 'bytes'. ` + `The Range header provided was "${normalizedRangeHeader}"`;
      },
      'single-range-only': ({
        normalizedRangeHeader
      }) => {
        if (!normalizedRangeHeader) {
          throw new Error(`Unexpected input to 'single-range-only' error.`);
        }
        return `Multiple ranges are not supported. Please use a  single start ` + `value, and optional end value. The Range header provided was ` + `"${normalizedRangeHeader}"`;
      },
      'invalid-range-values': ({
        normalizedRangeHeader
      }) => {
        if (!normalizedRangeHeader) {
          throw new Error(`Unexpected input to 'invalid-range-values' error.`);
        }
        return `The Range header is missing both start and end values. At least ` + `one of those values is needed. The Range header provided was ` + `"${normalizedRangeHeader}"`;
      },
      'no-range-header': () => {
        return `No Range header was found in the Request provided.`;
      },
      'range-not-satisfiable': ({
        size,
        start,
        end
      }) => {
        return `The start (${start}) and end (${end}) values in the Range are ` + `not satisfiable by the cached response, which is ${size} bytes.`;
      },
      'attempt-to-cache-non-get-request': ({
        url,
        method
      }) => {
        return `Unable to cache '${url}' because it is a '${method}' request and ` + `only 'GET' requests can be cached.`;
      },
      'cache-put-with-no-response': ({
        url
      }) => {
        return `There was an attempt to cache '${url}' but the response was not ` + `defined.`;
      },
      'no-response': ({
        url,
        error
      }) => {
        let message = `The strategy could not generate a response for '${url}'.`;
        if (error) {
          message += ` The underlying error is ${error}.`;
        }
        return message;
      },
      'bad-precaching-response': ({
        url,
        status
      }) => {
        return `The precaching request for '${url}' failed` + (status ? ` with an HTTP status of ${status}.` : `.`);
      },
      'non-precached-url': ({
        url
      }) => {
        return `createHandlerBoundToURL('${url}') was called, but that URL is ` + `not precached. Please pass in a URL that is precached instead.`;
      },
      'add-to-cache-list-conflicting-integrities': ({
        url
      }) => {
        return `Two of the entries passed to ` + `'workbox-precaching.PrecacheController.addToCacheList()' had the URL ` + `${url} with different integrity values. Please remove one of them.`;
      },
      'missing-precache-entry': ({
        cacheName,
        url
      }) => {
        return `Unable to find a precached response in ${cacheName} for ${url}.`;
      },
      'cross-origin-copy-response': ({
        origin
      }) => {
        return `workbox-core.copyResponse() can only be used with same-origin ` + `responses. It was passed a response with origin ${origin}.`;
      },
      'opaque-streams-source': ({
        type
      }) => {
        const message = `One of the workbox-streams sources resulted in an ` + `'${type}' response.`;
        if (type === 'opaqueredirect') {
          return `${message} Please do not use a navigation request that results ` + `in a redirect as a source.`;
        }
        return `${message} Please ensure your sources are CORS-enabled.`;
      }
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const generatorFunction = (code, details = {}) => {
      const message = messages[code];
      if (!message) {
        throw new Error(`Unable to find message for code '${code}'.`);
      }
      return message(details);
    };
    const messageGenerator = generatorFunction;

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Workbox errors should be thrown with this class.
     * This allows use to ensure the type easily in tests,
     * helps developers identify errors from workbox
     * easily and allows use to optimise error
     * messages correctly.
     *
     * @private
     */
    class WorkboxError extends Error {
      /**
       *
       * @param {string} errorCode The error code that
       * identifies this particular error.
       * @param {Object=} details Any relevant arguments
       * that will help developers identify issues should
       * be added as a key on the context object.
       */
      constructor(errorCode, details) {
        const message = messageGenerator(errorCode, details);
        super(message);
        this.name = errorCode;
        this.details = details;
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /*
     * This method throws if the supplied value is not an array.
     * The destructed values are required to produce a meaningful error for users.
     * The destructed and restructured object is so it's clear what is
     * needed.
     */
    const isArray = (value, details) => {
      if (!Array.isArray(value)) {
        throw new WorkboxError('not-an-array', details);
      }
    };
    const hasMethod = (object, expectedMethod, details) => {
      const type = typeof object[expectedMethod];
      if (type !== 'function') {
        details['expectedMethod'] = expectedMethod;
        throw new WorkboxError('missing-a-method', details);
      }
    };
    const isType = (object, expectedType, details) => {
      if (typeof object !== expectedType) {
        details['expectedType'] = expectedType;
        throw new WorkboxError('incorrect-type', details);
      }
    };
    const isInstance = (object,
    // Need the general type to do the check later.
    // eslint-disable-next-line @typescript-eslint/ban-types
    expectedClass, details) => {
      if (!(object instanceof expectedClass)) {
        details['expectedClassName'] = expectedClass.name;
        throw new WorkboxError('incorrect-class', details);
      }
    };
    const isOneOf = (value, validValues, details) => {
      if (!validValues.includes(value)) {
        details['validValueDescription'] = `Valid values are ${JSON.stringify(validValues)}.`;
        throw new WorkboxError('invalid-value', details);
      }
    };
    const isArrayOfClass = (value,
    // Need general type to do check later.
    expectedClass,
    // eslint-disable-line
    details) => {
      const error = new WorkboxError('not-array-of-class', details);
      if (!Array.isArray(value)) {
        throw error;
      }
      for (const item of value) {
        if (!(item instanceof expectedClass)) {
          throw error;
        }
      }
    };
    const finalAssertExports = {
      hasMethod,
      isArray,
      isInstance,
      isOneOf,
      isType,
      isArrayOfClass
    };

    // @ts-ignore
    try {
      self['workbox:routing:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * The default HTTP method, 'GET', used when there's no specific method
     * configured for a route.
     *
     * @type {string}
     *
     * @private
     */
    const defaultMethod = 'GET';
    /**
     * The list of valid HTTP methods associated with requests that could be routed.
     *
     * @type {Array<string>}
     *
     * @private
     */
    const validMethods = ['DELETE', 'GET', 'HEAD', 'PATCH', 'POST', 'PUT'];

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * @param {function()|Object} handler Either a function, or an object with a
     * 'handle' method.
     * @return {Object} An object with a handle method.
     *
     * @private
     */
    const normalizeHandler = handler => {
      if (handler && typeof handler === 'object') {
        {
          finalAssertExports.hasMethod(handler, 'handle', {
            moduleName: 'workbox-routing',
            className: 'Route',
            funcName: 'constructor',
            paramName: 'handler'
          });
        }
        return handler;
      } else {
        {
          finalAssertExports.isType(handler, 'function', {
            moduleName: 'workbox-routing',
            className: 'Route',
            funcName: 'constructor',
            paramName: 'handler'
          });
        }
        return {
          handle: handler
        };
      }
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A `Route` consists of a pair of callback functions, "match" and "handler".
     * The "match" callback determine if a route should be used to "handle" a
     * request by returning a non-falsy value if it can. The "handler" callback
     * is called when there is a match and should return a Promise that resolves
     * to a `Response`.
     *
     * @memberof workbox-routing
     */
    class Route {
      /**
       * Constructor for Route class.
       *
       * @param {workbox-routing~matchCallback} match
       * A callback function that determines whether the route matches a given
       * `fetch` event by returning a non-falsy value.
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resolving to a Response.
       * @param {string} [method='GET'] The HTTP method to match the Route
       * against.
       */
      constructor(match, handler, method = defaultMethod) {
        {
          finalAssertExports.isType(match, 'function', {
            moduleName: 'workbox-routing',
            className: 'Route',
            funcName: 'constructor',
            paramName: 'match'
          });
          if (method) {
            finalAssertExports.isOneOf(method, validMethods, {
              paramName: 'method'
            });
          }
        }
        // These values are referenced directly by Router so cannot be
        // altered by minificaton.
        this.handler = normalizeHandler(handler);
        this.match = match;
        this.method = method;
      }
      /**
       *
       * @param {workbox-routing-handlerCallback} handler A callback
       * function that returns a Promise resolving to a Response
       */
      setCatchHandler(handler) {
        this.catchHandler = normalizeHandler(handler);
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * RegExpRoute makes it easy to create a regular expression based
     * {@link workbox-routing.Route}.
     *
     * For same-origin requests the RegExp only needs to match part of the URL. For
     * requests against third-party servers, you must define a RegExp that matches
     * the start of the URL.
     *
     * @memberof workbox-routing
     * @extends workbox-routing.Route
     */
    class RegExpRoute extends Route {
      /**
       * If the regular expression contains
       * [capture groups]{@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp#grouping-back-references},
       * the captured values will be passed to the
       * {@link workbox-routing~handlerCallback} `params`
       * argument.
       *
       * @param {RegExp} regExp The regular expression to match against URLs.
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       * @param {string} [method='GET'] The HTTP method to match the Route
       * against.
       */
      constructor(regExp, handler, method) {
        {
          finalAssertExports.isInstance(regExp, RegExp, {
            moduleName: 'workbox-routing',
            className: 'RegExpRoute',
            funcName: 'constructor',
            paramName: 'pattern'
          });
        }
        const match = ({
          url
        }) => {
          const result = regExp.exec(url.href);
          // Return immediately if there's no match.
          if (!result) {
            return;
          }
          // Require that the match start at the first character in the URL string
          // if it's a cross-origin request.
          // See https://github.com/GoogleChrome/workbox/issues/281 for the context
          // behind this behavior.
          if (url.origin !== location.origin && result.index !== 0) {
            {
              logger.debug(`The regular expression '${regExp.toString()}' only partially matched ` + `against the cross-origin URL '${url.toString()}'. RegExpRoute's will only ` + `handle cross-origin requests if they match the entire URL.`);
            }
            return;
          }
          // If the route matches, but there aren't any capture groups defined, then
          // this will return [], which is truthy and therefore sufficient to
          // indicate a match.
          // If there are capture groups, then it will return their values.
          return result.slice(1);
        };
        super(match, handler, method);
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const getFriendlyURL = url => {
      const urlObj = new URL(String(url), location.href);
      // See https://github.com/GoogleChrome/workbox/issues/2323
      // We want to include everything, except for the origin if it's same-origin.
      return urlObj.href.replace(new RegExp(`^${location.origin}`), '');
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * The Router can be used to process a `FetchEvent` using one or more
     * {@link workbox-routing.Route}, responding with a `Response` if
     * a matching route exists.
     *
     * If no route matches a given a request, the Router will use a "default"
     * handler if one is defined.
     *
     * Should the matching Route throw an error, the Router will use a "catch"
     * handler if one is defined to gracefully deal with issues and respond with a
     * Request.
     *
     * If a request matches multiple routes, the **earliest** registered route will
     * be used to respond to the request.
     *
     * @memberof workbox-routing
     */
    class Router {
      /**
       * Initializes a new Router.
       */
      constructor() {
        this._routes = new Map();
        this._defaultHandlerMap = new Map();
      }
      /**
       * @return {Map<string, Array<workbox-routing.Route>>} routes A `Map` of HTTP
       * method name ('GET', etc.) to an array of all the corresponding `Route`
       * instances that are registered.
       */
      get routes() {
        return this._routes;
      }
      /**
       * Adds a fetch event listener to respond to events when a route matches
       * the event's request.
       */
      addFetchListener() {
        // See https://github.com/Microsoft/TypeScript/issues/28357#issuecomment-436484705
        self.addEventListener('fetch', event => {
          const {
            request
          } = event;
          const responsePromise = this.handleRequest({
            request,
            event
          });
          if (responsePromise) {
            event.respondWith(responsePromise);
          }
        });
      }
      /**
       * Adds a message event listener for URLs to cache from the window.
       * This is useful to cache resources loaded on the page prior to when the
       * service worker started controlling it.
       *
       * The format of the message data sent from the window should be as follows.
       * Where the `urlsToCache` array may consist of URL strings or an array of
       * URL string + `requestInit` object (the same as you'd pass to `fetch()`).
       *
       * ```
       * {
       *   type: 'CACHE_URLS',
       *   payload: {
       *     urlsToCache: [
       *       './script1.js',
       *       './script2.js',
       *       ['./script3.js', {mode: 'no-cors'}],
       *     ],
       *   },
       * }
       * ```
       */
      addCacheListener() {
        // See https://github.com/Microsoft/TypeScript/issues/28357#issuecomment-436484705
        self.addEventListener('message', event => {
          // event.data is type 'any'
          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
          if (event.data && event.data.type === 'CACHE_URLS') {
            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
            const {
              payload
            } = event.data;
            {
              logger.debug(`Caching URLs from the window`, payload.urlsToCache);
            }
            const requestPromises = Promise.all(payload.urlsToCache.map(entry => {
              if (typeof entry === 'string') {
                entry = [entry];
              }
              const request = new Request(...entry);
              return this.handleRequest({
                request,
                event
              });
              // TODO(philipwalton): TypeScript errors without this typecast for
              // some reason (probably a bug). The real type here should work but
              // doesn't: `Array<Promise<Response> | undefined>`.
            })); // TypeScript
            event.waitUntil(requestPromises);
            // If a MessageChannel was used, reply to the message on success.
            if (event.ports && event.ports[0]) {
              void requestPromises.then(() => event.ports[0].postMessage(true));
            }
          }
        });
      }
      /**
       * Apply the routing rules to a FetchEvent object to get a Response from an
       * appropriate Route's handler.
       *
       * @param {Object} options
       * @param {Request} options.request The request to handle.
       * @param {ExtendableEvent} options.event The event that triggered the
       *     request.
       * @return {Promise<Response>|undefined} A promise is returned if a
       *     registered route can handle the request. If there is no matching
       *     route and there's no `defaultHandler`, `undefined` is returned.
       */
      handleRequest({
        request,
        event
      }) {
        {
          finalAssertExports.isInstance(request, Request, {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'handleRequest',
            paramName: 'options.request'
          });
        }
        const url = new URL(request.url, location.href);
        if (!url.protocol.startsWith('http')) {
          {
            logger.debug(`Workbox Router only supports URLs that start with 'http'.`);
          }
          return;
        }
        const sameOrigin = url.origin === location.origin;
        const {
          params,
          route
        } = this.findMatchingRoute({
          event,
          request,
          sameOrigin,
          url
        });
        let handler = route && route.handler;
        const debugMessages = [];
        {
          if (handler) {
            debugMessages.push([`Found a route to handle this request:`, route]);
            if (params) {
              debugMessages.push([`Passing the following params to the route's handler:`, params]);
            }
          }
        }
        // If we don't have a handler because there was no matching route, then
        // fall back to defaultHandler if that's defined.
        const method = request.method;
        if (!handler && this._defaultHandlerMap.has(method)) {
          {
            debugMessages.push(`Failed to find a matching route. Falling ` + `back to the default handler for ${method}.`);
          }
          handler = this._defaultHandlerMap.get(method);
        }
        if (!handler) {
          {
            // No handler so Workbox will do nothing. If logs is set of debug
            // i.e. verbose, we should print out this information.
            logger.debug(`No route found for: ${getFriendlyURL(url)}`);
          }
          return;
        }
        {
          // We have a handler, meaning Workbox is going to handle the route.
          // print the routing details to the console.
          logger.groupCollapsed(`Router is responding to: ${getFriendlyURL(url)}`);
          debugMessages.forEach(msg => {
            if (Array.isArray(msg)) {
              logger.log(...msg);
            } else {
              logger.log(msg);
            }
          });
          logger.groupEnd();
        }
        // Wrap in try and catch in case the handle method throws a synchronous
        // error. It should still callback to the catch handler.
        let responsePromise;
        try {
          responsePromise = handler.handle({
            url,
            request,
            event,
            params
          });
        } catch (err) {
          responsePromise = Promise.reject(err);
        }
        // Get route's catch handler, if it exists
        const catchHandler = route && route.catchHandler;
        if (responsePromise instanceof Promise && (this._catchHandler || catchHandler)) {
          responsePromise = responsePromise.catch(async err => {
            // If there's a route catch handler, process that first
            if (catchHandler) {
              {
                // Still include URL here as it will be async from the console group
                // and may not make sense without the URL
                logger.groupCollapsed(`Error thrown when responding to: ` + ` ${getFriendlyURL(url)}. Falling back to route's Catch Handler.`);
                logger.error(`Error thrown by:`, route);
                logger.error(err);
                logger.groupEnd();
              }
              try {
                return await catchHandler.handle({
                  url,
                  request,
                  event,
                  params
                });
              } catch (catchErr) {
                if (catchErr instanceof Error) {
                  err = catchErr;
                }
              }
            }
            if (this._catchHandler) {
              {
                // Still include URL here as it will be async from the console group
                // and may not make sense without the URL
                logger.groupCollapsed(`Error thrown when responding to: ` + ` ${getFriendlyURL(url)}. Falling back to global Catch Handler.`);
                logger.error(`Error thrown by:`, route);
                logger.error(err);
                logger.groupEnd();
              }
              return this._catchHandler.handle({
                url,
                request,
                event
              });
            }
            throw err;
          });
        }
        return responsePromise;
      }
      /**
       * Checks a request and URL (and optionally an event) against the list of
       * registered routes, and if there's a match, returns the corresponding
       * route along with any params generated by the match.
       *
       * @param {Object} options
       * @param {URL} options.url
       * @param {boolean} options.sameOrigin The result of comparing `url.origin`
       *     against the current origin.
       * @param {Request} options.request The request to match.
       * @param {Event} options.event The corresponding event.
       * @return {Object} An object with `route` and `params` properties.
       *     They are populated if a matching route was found or `undefined`
       *     otherwise.
       */
      findMatchingRoute({
        url,
        sameOrigin,
        request,
        event
      }) {
        const routes = this._routes.get(request.method) || [];
        for (const route of routes) {
          let params;
          // route.match returns type any, not possible to change right now.
          // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
          const matchResult = route.match({
            url,
            sameOrigin,
            request,
            event
          });
          if (matchResult) {
            {
              // Warn developers that using an async matchCallback is almost always
              // not the right thing to do.
              if (matchResult instanceof Promise) {
                logger.warn(`While routing ${getFriendlyURL(url)}, an async ` + `matchCallback function was used. Please convert the ` + `following route to use a synchronous matchCallback function:`, route);
              }
            }
            // See https://github.com/GoogleChrome/workbox/issues/2079
            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
            params = matchResult;
            if (Array.isArray(params) && params.length === 0) {
              // Instead of passing an empty array in as params, use undefined.
              params = undefined;
            } else if (matchResult.constructor === Object &&
            // eslint-disable-line
            Object.keys(matchResult).length === 0) {
              // Instead of passing an empty object in as params, use undefined.
              params = undefined;
            } else if (typeof matchResult === 'boolean') {
              // For the boolean value true (rather than just something truth-y),
              // don't set params.
              // See https://github.com/GoogleChrome/workbox/pull/2134#issuecomment-513924353
              params = undefined;
            }
            // Return early if have a match.
            return {
              route,
              params
            };
          }
        }
        // If no match was found above, return and empty object.
        return {};
      }
      /**
       * Define a default `handler` that's called when no routes explicitly
       * match the incoming request.
       *
       * Each HTTP method ('GET', 'POST', etc.) gets its own default handler.
       *
       * Without a default handler, unmatched requests will go against the
       * network as if there were no service worker present.
       *
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       * @param {string} [method='GET'] The HTTP method to associate with this
       * default handler. Each method has its own default.
       */
      setDefaultHandler(handler, method = defaultMethod) {
        this._defaultHandlerMap.set(method, normalizeHandler(handler));
      }
      /**
       * If a Route throws an error while handling a request, this `handler`
       * will be called and given a chance to provide a response.
       *
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       */
      setCatchHandler(handler) {
        this._catchHandler = normalizeHandler(handler);
      }
      /**
       * Registers a route with the router.
       *
       * @param {workbox-routing.Route} route The route to register.
       */
      registerRoute(route) {
        {
          finalAssertExports.isType(route, 'object', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route'
          });
          finalAssertExports.hasMethod(route, 'match', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route'
          });
          finalAssertExports.isType(route.handler, 'object', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route'
          });
          finalAssertExports.hasMethod(route.handler, 'handle', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route.handler'
          });
          finalAssertExports.isType(route.method, 'string', {
            moduleName: 'workbox-routing',
            className: 'Router',
            funcName: 'registerRoute',
            paramName: 'route.method'
          });
        }
        if (!this._routes.has(route.method)) {
          this._routes.set(route.method, []);
        }
        // Give precedence to all of the earlier routes by adding this additional
        // route to the end of the array.
        this._routes.get(route.method).push(route);
      }
      /**
       * Unregisters a route with the router.
       *
       * @param {workbox-routing.Route} route The route to unregister.
       */
      unregisterRoute(route) {
        if (!this._routes.has(route.method)) {
          throw new WorkboxError('unregister-route-but-not-found-with-method', {
            method: route.method
          });
        }
        const routeIndex = this._routes.get(route.method).indexOf(route);
        if (routeIndex > -1) {
          this._routes.get(route.method).splice(routeIndex, 1);
        } else {
          throw new WorkboxError('unregister-route-route-not-registered');
        }
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    let defaultRouter;
    /**
     * Creates a new, singleton Router instance if one does not exist. If one
     * does already exist, that instance is returned.
     *
     * @private
     * @return {Router}
     */
    const getOrCreateDefaultRouter = () => {
      if (!defaultRouter) {
        defaultRouter = new Router();
        // The helpers that use the default Router assume these listeners exist.
        defaultRouter.addFetchListener();
        defaultRouter.addCacheListener();
      }
      return defaultRouter;
    };

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Easily register a RegExp, string, or function with a caching
     * strategy to a singleton Router instance.
     *
     * This method will generate a Route for you if needed and
     * call {@link workbox-routing.Router#registerRoute}.
     *
     * @param {RegExp|string|workbox-routing.Route~matchCallback|workbox-routing.Route} capture
     * If the capture param is a `Route`, all other arguments will be ignored.
     * @param {workbox-routing~handlerCallback} [handler] A callback
     * function that returns a Promise resulting in a Response. This parameter
     * is required if `capture` is not a `Route` object.
     * @param {string} [method='GET'] The HTTP method to match the Route
     * against.
     * @return {workbox-routing.Route} The generated `Route`.
     *
     * @memberof workbox-routing
     */
    function registerRoute(capture, handler, method) {
      let route;
      if (typeof capture === 'string') {
        const captureUrl = new URL(capture, location.href);
        {
          if (!(capture.startsWith('/') || capture.startsWith('http'))) {
            throw new WorkboxError('invalid-string', {
              moduleName: 'workbox-routing',
              funcName: 'registerRoute',
              paramName: 'capture'
            });
          }
          // We want to check if Express-style wildcards are in the pathname only.
          // TODO: Remove this log message in v4.
          const valueToCheck = capture.startsWith('http') ? captureUrl.pathname : capture;
          // See https://github.com/pillarjs/path-to-regexp#parameters
          const wildcards = '[*:?+]';
          if (new RegExp(`${wildcards}`).exec(valueToCheck)) {
            logger.debug(`The '$capture' parameter contains an Express-style wildcard ` + `character (${wildcards}). Strings are now always interpreted as ` + `exact matches; use a RegExp for partial or wildcard matches.`);
          }
        }
        const matchCallback = ({
          url
        }) => {
          {
            if (url.pathname === captureUrl.pathname && url.origin !== captureUrl.origin) {
              logger.debug(`${capture} only partially matches the cross-origin URL ` + `${url.toString()}. This route will only handle cross-origin requests ` + `if they match the entire URL.`);
            }
          }
          return url.href === captureUrl.href;
        };
        // If `capture` is a string then `handler` and `method` must be present.
        route = new Route(matchCallback, handler, method);
      } else if (capture instanceof RegExp) {
        // If `capture` is a `RegExp` then `handler` and `method` must be present.
        route = new RegExpRoute(capture, handler, method);
      } else if (typeof capture === 'function') {
        // If `capture` is a function then `handler` and `method` must be present.
        route = new Route(capture, handler, method);
      } else if (capture instanceof Route) {
        route = capture;
      } else {
        throw new WorkboxError('unsupported-route-type', {
          moduleName: 'workbox-routing',
          funcName: 'registerRoute',
          paramName: 'capture'
        });
      }
      const defaultRouter = getOrCreateDefaultRouter();
      defaultRouter.registerRoute(route);
      return route;
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const _cacheNameDetails = {
      googleAnalytics: 'googleAnalytics',
      precache: 'precache-v2',
      prefix: 'workbox',
      runtime: 'runtime',
      suffix: typeof registration !== 'undefined' ? registration.scope : ''
    };
    const _createCacheName = cacheName => {
      return [_cacheNameDetails.prefix, cacheName, _cacheNameDetails.suffix].filter(value => value && value.length > 0).join('-');
    };
    const eachCacheNameDetail = fn => {
      for (const key of Object.keys(_cacheNameDetails)) {
        fn(key);
      }
    };
    const cacheNames = {
      updateDetails: details => {
        eachCacheNameDetail(key => {
          if (typeof details[key] === 'string') {
            _cacheNameDetails[key] = details[key];
          }
        });
      },
      getGoogleAnalyticsName: userCacheName => {
        return userCacheName || _createCacheName(_cacheNameDetails.googleAnalytics);
      },
      getPrecacheName: userCacheName => {
        return userCacheName || _createCacheName(_cacheNameDetails.precache);
      },
      getPrefix: () => {
        return _cacheNameDetails.prefix;
      },
      getRuntimeName: userCacheName => {
        return userCacheName || _createCacheName(_cacheNameDetails.runtime);
      },
      getSuffix: () => {
        return _cacheNameDetails.suffix;
      }
    };

    /*
      Copyright 2020 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A utility method that makes it easier to use `event.waitUntil` with
     * async functions and return the result.
     *
     * @param {ExtendableEvent} event
     * @param {Function} asyncFn
     * @return {Function}
     * @private
     */
    function waitUntil(event, asyncFn) {
      const returnPromise = asyncFn();
      event.waitUntil(returnPromise);
      return returnPromise;
    }

    // @ts-ignore
    try {
      self['workbox:precaching:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    // Name of the search parameter used to store revision info.
    const REVISION_SEARCH_PARAM = '__WB_REVISION__';
    /**
     * Converts a manifest entry into a versioned URL suitable for precaching.
     *
     * @param {Object|string} entry
     * @return {string} A URL with versioning info.
     *
     * @private
     * @memberof workbox-precaching
     */
    function createCacheKey(entry) {
      if (!entry) {
        throw new WorkboxError('add-to-cache-list-unexpected-type', {
          entry
        });
      }
      // If a precache manifest entry is a string, it's assumed to be a versioned
      // URL, like '/app.abcd1234.js'. Return as-is.
      if (typeof entry === 'string') {
        const urlObject = new URL(entry, location.href);
        return {
          cacheKey: urlObject.href,
          url: urlObject.href
        };
      }
      const {
        revision,
        url
      } = entry;
      if (!url) {
        throw new WorkboxError('add-to-cache-list-unexpected-type', {
          entry
        });
      }
      // If there's just a URL and no revision, then it's also assumed to be a
      // versioned URL.
      if (!revision) {
        const urlObject = new URL(url, location.href);
        return {
          cacheKey: urlObject.href,
          url: urlObject.href
        };
      }
      // Otherwise, construct a properly versioned URL using the custom Workbox
      // search parameter along with the revision info.
      const cacheKeyURL = new URL(url, location.href);
      const originalURL = new URL(url, location.href);
      cacheKeyURL.searchParams.set(REVISION_SEARCH_PARAM, revision);
      return {
        cacheKey: cacheKeyURL.href,
        url: originalURL.href
      };
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A plugin, designed to be used with PrecacheController, to determine the
     * of assets that were updated (or not updated) during the install event.
     *
     * @private
     */
    class PrecacheInstallReportPlugin {
      constructor() {
        this.updatedURLs = [];
        this.notUpdatedURLs = [];
        this.handlerWillStart = async ({
          request,
          state
        }) => {
          // TODO: `state` should never be undefined...
          if (state) {
            state.originalRequest = request;
          }
        };
        this.cachedResponseWillBeUsed = async ({
          event,
          state,
          cachedResponse
        }) => {
          if (event.type === 'install') {
            if (state && state.originalRequest && state.originalRequest instanceof Request) {
              // TODO: `state` should never be undefined...
              const url = state.originalRequest.url;
              if (cachedResponse) {
                this.notUpdatedURLs.push(url);
              } else {
                this.updatedURLs.push(url);
              }
            }
          }
          return cachedResponse;
        };
      }
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A plugin, designed to be used with PrecacheController, to translate URLs into
     * the corresponding cache key, based on the current revision info.
     *
     * @private
     */
    class PrecacheCacheKeyPlugin {
      constructor({
        precacheController
      }) {
        this.cacheKeyWillBeUsed = async ({
          request,
          params
        }) => {
          // Params is type any, can't change right now.
          /* eslint-disable */
          const cacheKey = (params === null || params === void 0 ? void 0 : params.cacheKey) || this._precacheController.getCacheKeyForURL(request.url);
          /* eslint-enable */
          return cacheKey ? new Request(cacheKey, {
            headers: request.headers
          }) : request;
        };
        this._precacheController = precacheController;
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * @param {string} groupTitle
     * @param {Array<string>} deletedURLs
     *
     * @private
     */
    const logGroup = (groupTitle, deletedURLs) => {
      logger.groupCollapsed(groupTitle);
      for (const url of deletedURLs) {
        logger.log(url);
      }
      logger.groupEnd();
    };
    /**
     * @param {Array<string>} deletedURLs
     *
     * @private
     * @memberof workbox-precaching
     */
    function printCleanupDetails(deletedURLs) {
      const deletionCount = deletedURLs.length;
      if (deletionCount > 0) {
        logger.groupCollapsed(`During precaching cleanup, ` + `${deletionCount} cached ` + `request${deletionCount === 1 ? ' was' : 's were'} deleted.`);
        logGroup('Deleted Cache Requests', deletedURLs);
        logger.groupEnd();
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * @param {string} groupTitle
     * @param {Array<string>} urls
     *
     * @private
     */
    function _nestedGroup(groupTitle, urls) {
      if (urls.length === 0) {
        return;
      }
      logger.groupCollapsed(groupTitle);
      for (const url of urls) {
        logger.log(url);
      }
      logger.groupEnd();
    }
    /**
     * @param {Array<string>} urlsToPrecache
     * @param {Array<string>} urlsAlreadyPrecached
     *
     * @private
     * @memberof workbox-precaching
     */
    function printInstallDetails(urlsToPrecache, urlsAlreadyPrecached) {
      const precachedCount = urlsToPrecache.length;
      const alreadyPrecachedCount = urlsAlreadyPrecached.length;
      if (precachedCount || alreadyPrecachedCount) {
        let message = `Precaching ${precachedCount} file${precachedCount === 1 ? '' : 's'}.`;
        if (alreadyPrecachedCount > 0) {
          message += ` ${alreadyPrecachedCount} ` + `file${alreadyPrecachedCount === 1 ? ' is' : 's are'} already cached.`;
        }
        logger.groupCollapsed(message);
        _nestedGroup(`View newly precached URLs.`, urlsToPrecache);
        _nestedGroup(`View previously precached URLs.`, urlsAlreadyPrecached);
        logger.groupEnd();
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    let supportStatus;
    /**
     * A utility function that determines whether the current browser supports
     * constructing a new `Response` from a `response.body` stream.
     *
     * @return {boolean} `true`, if the current browser can successfully
     *     construct a `Response` from a `response.body` stream, `false` otherwise.
     *
     * @private
     */
    function canConstructResponseFromBodyStream() {
      if (supportStatus === undefined) {
        const testResponse = new Response('');
        if ('body' in testResponse) {
          try {
            new Response(testResponse.body);
            supportStatus = true;
          } catch (error) {
            supportStatus = false;
          }
        }
        supportStatus = false;
      }
      return supportStatus;
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Allows developers to copy a response and modify its `headers`, `status`,
     * or `statusText` values (the values settable via a
     * [`ResponseInit`]{@link https://developer.mozilla.org/en-US/docs/Web/API/Response/Response#Syntax}
     * object in the constructor).
     * To modify these values, pass a function as the second argument. That
     * function will be invoked with a single object with the response properties
     * `{headers, status, statusText}`. The return value of this function will
     * be used as the `ResponseInit` for the new `Response`. To change the values
     * either modify the passed parameter(s) and return it, or return a totally
     * new object.
     *
     * This method is intentionally limited to same-origin responses, regardless of
     * whether CORS was used or not.
     *
     * @param {Response} response
     * @param {Function} modifier
     * @memberof workbox-core
     */
    async function copyResponse(response, modifier) {
      let origin = null;
      // If response.url isn't set, assume it's cross-origin and keep origin null.
      if (response.url) {
        const responseURL = new URL(response.url);
        origin = responseURL.origin;
      }
      if (origin !== self.location.origin) {
        throw new WorkboxError('cross-origin-copy-response', {
          origin
        });
      }
      const clonedResponse = response.clone();
      // Create a fresh `ResponseInit` object by cloning the headers.
      const responseInit = {
        headers: new Headers(clonedResponse.headers),
        status: clonedResponse.status,
        statusText: clonedResponse.statusText
      };
      // Apply any user modifications.
      const modifiedResponseInit = modifier ? modifier(responseInit) : responseInit;
      // Create the new response from the body stream and `ResponseInit`
      // modifications. Note: not all browsers support the Response.body stream,
      // so fall back to reading the entire body into memory as a blob.
      const body = canConstructResponseFromBodyStream() ? clonedResponse.body : await clonedResponse.blob();
      return new Response(body, modifiedResponseInit);
    }

    /*
      Copyright 2020 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    function stripParams(fullURL, ignoreParams) {
      const strippedURL = new URL(fullURL);
      for (const param of ignoreParams) {
        strippedURL.searchParams.delete(param);
      }
      return strippedURL.href;
    }
    /**
     * Matches an item in the cache, ignoring specific URL params. This is similar
     * to the `ignoreSearch` option, but it allows you to ignore just specific
     * params (while continuing to match on the others).
     *
     * @private
     * @param {Cache} cache
     * @param {Request} request
     * @param {Object} matchOptions
     * @param {Array<string>} ignoreParams
     * @return {Promise<Response|undefined>}
     */
    async function cacheMatchIgnoreParams(cache, request, ignoreParams, matchOptions) {
      const strippedRequestURL = stripParams(request.url, ignoreParams);
      // If the request doesn't include any ignored params, match as normal.
      if (request.url === strippedRequestURL) {
        return cache.match(request, matchOptions);
      }
      // Otherwise, match by comparing keys
      const keysOptions = Object.assign(Object.assign({}, matchOptions), {
        ignoreSearch: true
      });
      const cacheKeys = await cache.keys(request, keysOptions);
      for (const cacheKey of cacheKeys) {
        const strippedCacheKeyURL = stripParams(cacheKey.url, ignoreParams);
        if (strippedRequestURL === strippedCacheKeyURL) {
          return cache.match(cacheKey, matchOptions);
        }
      }
      return;
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * The Deferred class composes Promises in a way that allows for them to be
     * resolved or rejected from outside the constructor. In most cases promises
     * should be used directly, but Deferreds can be necessary when the logic to
     * resolve a promise must be separate.
     *
     * @private
     */
    class Deferred {
      /**
       * Creates a promise and exposes its resolve and reject functions as methods.
       */
      constructor() {
        this.promise = new Promise((resolve, reject) => {
          this.resolve = resolve;
          this.reject = reject;
        });
      }
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    // Callbacks to be executed whenever there's a quota error.
    // Can't change Function type right now.
    // eslint-disable-next-line @typescript-eslint/ban-types
    const quotaErrorCallbacks = new Set();

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Runs all of the callback functions, one at a time sequentially, in the order
     * in which they were registered.
     *
     * @memberof workbox-core
     * @private
     */
    async function executeQuotaErrorCallbacks() {
      {
        logger.log(`About to run ${quotaErrorCallbacks.size} ` + `callbacks to clean up caches.`);
      }
      for (const callback of quotaErrorCallbacks) {
        await callback();
        {
          logger.log(callback, 'is complete.');
        }
      }
      {
        logger.log('Finished running callbacks.');
      }
    }

    /*
      Copyright 2019 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Returns a promise that resolves and the passed number of milliseconds.
     * This utility is an async/await-friendly version of `setTimeout`.
     *
     * @param {number} ms
     * @return {Promise}
     * @private
     */
    function timeout(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // @ts-ignore
    try {
      self['workbox:strategies:7.3.0'] && _();
    } catch (e) {}

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    function toRequest(input) {
      return typeof input === 'string' ? new Request(input) : input;
    }
    /**
     * A class created every time a Strategy instance calls
     * {@link workbox-strategies.Strategy~handle} or
     * {@link workbox-strategies.Strategy~handleAll} that wraps all fetch and
     * cache actions around plugin callbacks and keeps track of when the strategy
     * is "done" (i.e. all added `event.waitUntil()` promises have resolved).
     *
     * @memberof workbox-strategies
     */
    class StrategyHandler {
      /**
       * Creates a new instance associated with the passed strategy and event
       * that's handling the request.
       *
       * The constructor also initializes the state that will be passed to each of
       * the plugins handling this request.
       *
       * @param {workbox-strategies.Strategy} strategy
       * @param {Object} options
       * @param {Request|string} options.request A request to run this strategy for.
       * @param {ExtendableEvent} options.event The event associated with the
       *     request.
       * @param {URL} [options.url]
       * @param {*} [options.params] The return value from the
       *     {@link workbox-routing~matchCallback} (if applicable).
       */
      constructor(strategy, options) {
        this._cacheKeys = {};
        /**
         * The request the strategy is performing (passed to the strategy's
         * `handle()` or `handleAll()` method).
         * @name request
         * @instance
         * @type {Request}
         * @memberof workbox-strategies.StrategyHandler
         */
        /**
         * The event associated with this request.
         * @name event
         * @instance
         * @type {ExtendableEvent}
         * @memberof workbox-strategies.StrategyHandler
         */
        /**
         * A `URL` instance of `request.url` (if passed to the strategy's
         * `handle()` or `handleAll()` method).
         * Note: the `url` param will be present if the strategy was invoked
         * from a workbox `Route` object.
         * @name url
         * @instance
         * @type {URL|undefined}
         * @memberof workbox-strategies.StrategyHandler
         */
        /**
         * A `param` value (if passed to the strategy's
         * `handle()` or `handleAll()` method).
         * Note: the `param` param will be present if the strategy was invoked
         * from a workbox `Route` object and the
         * {@link workbox-routing~matchCallback} returned
         * a truthy value (it will be that value).
         * @name params
         * @instance
         * @type {*|undefined}
         * @memberof workbox-strategies.StrategyHandler
         */
        {
          finalAssertExports.isInstance(options.event, ExtendableEvent, {
            moduleName: 'workbox-strategies',
            className: 'StrategyHandler',
            funcName: 'constructor',
            paramName: 'options.event'
          });
        }
        Object.assign(this, options);
        this.event = options.event;
        this._strategy = strategy;
        this._handlerDeferred = new Deferred();
        this._extendLifetimePromises = [];
        // Copy the plugins list (since it's mutable on the strategy),
        // so any mutations don't affect this handler instance.
        this._plugins = [...strategy.plugins];
        this._pluginStateMap = new Map();
        for (const plugin of this._plugins) {
          this._pluginStateMap.set(plugin, {});
        }
        this.event.waitUntil(this._handlerDeferred.promise);
      }
      /**
       * Fetches a given request (and invokes any applicable plugin callback
       * methods) using the `fetchOptions` (for non-navigation requests) and
       * `plugins` defined on the `Strategy` object.
       *
       * The following plugin lifecycle methods are invoked when using this method:
       * - `requestWillFetch()`
       * - `fetchDidSucceed()`
       * - `fetchDidFail()`
       *
       * @param {Request|string} input The URL or request to fetch.
       * @return {Promise<Response>}
       */
      async fetch(input) {
        const {
          event
        } = this;
        let request = toRequest(input);
        if (request.mode === 'navigate' && event instanceof FetchEvent && event.preloadResponse) {
          const possiblePreloadResponse = await event.preloadResponse;
          if (possiblePreloadResponse) {
            {
              logger.log(`Using a preloaded navigation response for ` + `'${getFriendlyURL(request.url)}'`);
            }
            return possiblePreloadResponse;
          }
        }
        // If there is a fetchDidFail plugin, we need to save a clone of the
        // original request before it's either modified by a requestWillFetch
        // plugin or before the original request's body is consumed via fetch().
        const originalRequest = this.hasCallback('fetchDidFail') ? request.clone() : null;
        try {
          for (const cb of this.iterateCallbacks('requestWillFetch')) {
            request = await cb({
              request: request.clone(),
              event
            });
          }
        } catch (err) {
          if (err instanceof Error) {
            throw new WorkboxError('plugin-error-request-will-fetch', {
              thrownErrorMessage: err.message
            });
          }
        }
        // The request can be altered by plugins with `requestWillFetch` making
        // the original request (most likely from a `fetch` event) different
        // from the Request we make. Pass both to `fetchDidFail` to aid debugging.
        const pluginFilteredRequest = request.clone();
        try {
          let fetchResponse;
          // See https://github.com/GoogleChrome/workbox/issues/1796
          fetchResponse = await fetch(request, request.mode === 'navigate' ? undefined : this._strategy.fetchOptions);
          if ("development" !== 'production') {
            logger.debug(`Network request for ` + `'${getFriendlyURL(request.url)}' returned a response with ` + `status '${fetchResponse.status}'.`);
          }
          for (const callback of this.iterateCallbacks('fetchDidSucceed')) {
            fetchResponse = await callback({
              event,
              request: pluginFilteredRequest,
              response: fetchResponse
            });
          }
          return fetchResponse;
        } catch (error) {
          {
            logger.log(`Network request for ` + `'${getFriendlyURL(request.url)}' threw an error.`, error);
          }
          // `originalRequest` will only exist if a `fetchDidFail` callback
          // is being used (see above).
          if (originalRequest) {
            await this.runCallbacks('fetchDidFail', {
              error: error,
              event,
              originalRequest: originalRequest.clone(),
              request: pluginFilteredRequest.clone()
            });
          }
          throw error;
        }
      }
      /**
       * Calls `this.fetch()` and (in the background) runs `this.cachePut()` on
       * the response generated by `this.fetch()`.
       *
       * The call to `this.cachePut()` automatically invokes `this.waitUntil()`,
       * so you do not have to manually call `waitUntil()` on the event.
       *
       * @param {Request|string} input The request or URL to fetch and cache.
       * @return {Promise<Response>}
       */
      async fetchAndCachePut(input) {
        const response = await this.fetch(input);
        const responseClone = response.clone();
        void this.waitUntil(this.cachePut(input, responseClone));
        return response;
      }
      /**
       * Matches a request from the cache (and invokes any applicable plugin
       * callback methods) using the `cacheName`, `matchOptions`, and `plugins`
       * defined on the strategy object.
       *
       * The following plugin lifecycle methods are invoked when using this method:
       * - cacheKeyWillBeUsed()
       * - cachedResponseWillBeUsed()
       *
       * @param {Request|string} key The Request or URL to use as the cache key.
       * @return {Promise<Response|undefined>} A matching response, if found.
       */
      async cacheMatch(key) {
        const request = toRequest(key);
        let cachedResponse;
        const {
          cacheName,
          matchOptions
        } = this._strategy;
        const effectiveRequest = await this.getCacheKey(request, 'read');
        const multiMatchOptions = Object.assign(Object.assign({}, matchOptions), {
          cacheName
        });
        cachedResponse = await caches.match(effectiveRequest, multiMatchOptions);
        {
          if (cachedResponse) {
            logger.debug(`Found a cached response in '${cacheName}'.`);
          } else {
            logger.debug(`No cached response found in '${cacheName}'.`);
          }
        }
        for (const callback of this.iterateCallbacks('cachedResponseWillBeUsed')) {
          cachedResponse = (await callback({
            cacheName,
            matchOptions,
            cachedResponse,
            request: effectiveRequest,
            event: this.event
          })) || undefined;
        }
        return cachedResponse;
      }
      /**
       * Puts a request/response pair in the cache (and invokes any applicable
       * plugin callback methods) using the `cacheName` and `plugins` defined on
       * the strategy object.
       *
       * The following plugin lifecycle methods are invoked when using this method:
       * - cacheKeyWillBeUsed()
       * - cacheWillUpdate()
       * - cacheDidUpdate()
       *
       * @param {Request|string} key The request or URL to use as the cache key.
       * @param {Response} response The response to cache.
       * @return {Promise<boolean>} `false` if a cacheWillUpdate caused the response
       * not be cached, and `true` otherwise.
       */
      async cachePut(key, response) {
        const request = toRequest(key);
        // Run in the next task to avoid blocking other cache reads.
        // https://github.com/w3c/ServiceWorker/issues/1397
        await timeout(0);
        const effectiveRequest = await this.getCacheKey(request, 'write');
        {
          if (effectiveRequest.method && effectiveRequest.method !== 'GET') {
            throw new WorkboxError('attempt-to-cache-non-get-request', {
              url: getFriendlyURL(effectiveRequest.url),
              method: effectiveRequest.method
            });
          }
          // See https://github.com/GoogleChrome/workbox/issues/2818
          const vary = response.headers.get('Vary');
          if (vary) {
            logger.debug(`The response for ${getFriendlyURL(effectiveRequest.url)} ` + `has a 'Vary: ${vary}' header. ` + `Consider setting the {ignoreVary: true} option on your strategy ` + `to ensure cache matching and deletion works as expected.`);
          }
        }
        if (!response) {
          {
            logger.error(`Cannot cache non-existent response for ` + `'${getFriendlyURL(effectiveRequest.url)}'.`);
          }
          throw new WorkboxError('cache-put-with-no-response', {
            url: getFriendlyURL(effectiveRequest.url)
          });
        }
        const responseToCache = await this._ensureResponseSafeToCache(response);
        if (!responseToCache) {
          {
            logger.debug(`Response '${getFriendlyURL(effectiveRequest.url)}' ` + `will not be cached.`, responseToCache);
          }
          return false;
        }
        const {
          cacheName,
          matchOptions
        } = this._strategy;
        const cache = await self.caches.open(cacheName);
        const hasCacheUpdateCallback = this.hasCallback('cacheDidUpdate');
        const oldResponse = hasCacheUpdateCallback ? await cacheMatchIgnoreParams(
        // TODO(philipwalton): the `__WB_REVISION__` param is a precaching
        // feature. Consider into ways to only add this behavior if using
        // precaching.
        cache, effectiveRequest.clone(), ['__WB_REVISION__'], matchOptions) : null;
        {
          logger.debug(`Updating the '${cacheName}' cache with a new Response ` + `for ${getFriendlyURL(effectiveRequest.url)}.`);
        }
        try {
          await cache.put(effectiveRequest, hasCacheUpdateCallback ? responseToCache.clone() : responseToCache);
        } catch (error) {
          if (error instanceof Error) {
            // See https://developer.mozilla.org/en-US/docs/Web/API/DOMException#exception-QuotaExceededError
            if (error.name === 'QuotaExceededError') {
              await executeQuotaErrorCallbacks();
            }
            throw error;
          }
        }
        for (const callback of this.iterateCallbacks('cacheDidUpdate')) {
          await callback({
            cacheName,
            oldResponse,
            newResponse: responseToCache.clone(),
            request: effectiveRequest,
            event: this.event
          });
        }
        return true;
      }
      /**
       * Checks the list of plugins for the `cacheKeyWillBeUsed` callback, and
       * executes any of those callbacks found in sequence. The final `Request`
       * object returned by the last plugin is treated as the cache key for cache
       * reads and/or writes. If no `cacheKeyWillBeUsed` plugin callbacks have
       * been registered, the passed request is returned unmodified
       *
       * @param {Request} request
       * @param {string} mode
       * @return {Promise<Request>}
       */
      async getCacheKey(request, mode) {
        const key = `${request.url} | ${mode}`;
        if (!this._cacheKeys[key]) {
          let effectiveRequest = request;
          for (const callback of this.iterateCallbacks('cacheKeyWillBeUsed')) {
            effectiveRequest = toRequest(await callback({
              mode,
              request: effectiveRequest,
              event: this.event,
              // params has a type any can't change right now.
              params: this.params // eslint-disable-line
            }));
          }
          this._cacheKeys[key] = effectiveRequest;
        }
        return this._cacheKeys[key];
      }
      /**
       * Returns true if the strategy has at least one plugin with the given
       * callback.
       *
       * @param {string} name The name of the callback to check for.
       * @return {boolean}
       */
      hasCallback(name) {
        for (const plugin of this._strategy.plugins) {
          if (name in plugin) {
            return true;
          }
        }
        return false;
      }
      /**
       * Runs all plugin callbacks matching the given name, in order, passing the
       * given param object (merged ith the current plugin state) as the only
       * argument.
       *
       * Note: since this method runs all plugins, it's not suitable for cases
       * where the return value of a callback needs to be applied prior to calling
       * the next callback. See
       * {@link workbox-strategies.StrategyHandler#iterateCallbacks}
       * below for how to handle that case.
       *
       * @param {string} name The name of the callback to run within each plugin.
       * @param {Object} param The object to pass as the first (and only) param
       *     when executing each callback. This object will be merged with the
       *     current plugin state prior to callback execution.
       */
      async runCallbacks(name, param) {
        for (const callback of this.iterateCallbacks(name)) {
          // TODO(philipwalton): not sure why `any` is needed. It seems like
          // this should work with `as WorkboxPluginCallbackParam[C]`.
          await callback(param);
        }
      }
      /**
       * Accepts a callback and returns an iterable of matching plugin callbacks,
       * where each callback is wrapped with the current handler state (i.e. when
       * you call each callback, whatever object parameter you pass it will
       * be merged with the plugin's current state).
       *
       * @param {string} name The name fo the callback to run
       * @return {Array<Function>}
       */
      *iterateCallbacks(name) {
        for (const plugin of this._strategy.plugins) {
          if (typeof plugin[name] === 'function') {
            const state = this._pluginStateMap.get(plugin);
            const statefulCallback = param => {
              const statefulParam = Object.assign(Object.assign({}, param), {
                state
              });
              // TODO(philipwalton): not sure why `any` is needed. It seems like
              // this should work with `as WorkboxPluginCallbackParam[C]`.
              return plugin[name](statefulParam);
            };
            yield statefulCallback;
          }
        }
      }
      /**
       * Adds a promise to the
       * [extend lifetime promises]{@link https://w3c.github.io/ServiceWorker/#extendableevent-extend-lifetime-promises}
       * of the event associated with the request being handled (usually a
       * `FetchEvent`).
       *
       * Note: you can await
       * {@link workbox-strategies.StrategyHandler~doneWaiting}
       * to know when all added promises have settled.
       *
       * @param {Promise} promise A promise to add to the extend lifetime promises
       *     of the event that triggered the request.
       */
      waitUntil(promise) {
        this._extendLifetimePromises.push(promise);
        return promise;
      }
      /**
       * Returns a promise that resolves once all promises passed to
       * {@link workbox-strategies.StrategyHandler~waitUntil}
       * have settled.
       *
       * Note: any work done after `doneWaiting()` settles should be manually
       * passed to an event's `waitUntil()` method (not this handler's
       * `waitUntil()` method), otherwise the service worker thread may be killed
       * prior to your work completing.
       */
      async doneWaiting() {
        while (this._extendLifetimePromises.length) {
          const promises = this._extendLifetimePromises.splice(0);
          const result = await Promise.allSettled(promises);
          const firstRejection = result.find(i => i.status === 'rejected');
          if (firstRejection) {
            throw firstRejection.reason;
          }
        }
      }
      /**
       * Stops running the strategy and immediately resolves any pending
       * `waitUntil()` promises.
       */
      destroy() {
        this._handlerDeferred.resolve(null);
      }
      /**
       * This method will call cacheWillUpdate on the available plugins (or use
       * status === 200) to determine if the Response is safe and valid to cache.
       *
       * @param {Request} options.request
       * @param {Response} options.response
       * @return {Promise<Response|undefined>}
       *
       * @private
       */
      async _ensureResponseSafeToCache(response) {
        let responseToCache = response;
        let pluginsUsed = false;
        for (const callback of this.iterateCallbacks('cacheWillUpdate')) {
          responseToCache = (await callback({
            request: this.request,
            response: responseToCache,
            event: this.event
          })) || undefined;
          pluginsUsed = true;
          if (!responseToCache) {
            break;
          }
        }
        if (!pluginsUsed) {
          if (responseToCache && responseToCache.status !== 200) {
            responseToCache = undefined;
          }
          {
            if (responseToCache) {
              if (responseToCache.status !== 200) {
                if (responseToCache.status === 0) {
                  logger.warn(`The response for '${this.request.url}' ` + `is an opaque response. The caching strategy that you're ` + `using will not cache opaque responses by default.`);
                } else {
                  logger.debug(`The response for '${this.request.url}' ` + `returned a status code of '${response.status}' and won't ` + `be cached as a result.`);
                }
              }
            }
          }
        }
        return responseToCache;
      }
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * An abstract base class that all other strategy classes must extend from:
     *
     * @memberof workbox-strategies
     */
    class Strategy {
      /**
       * Creates a new instance of the strategy and sets all documented option
       * properties as public instance properties.
       *
       * Note: if a custom strategy class extends the base Strategy class and does
       * not need more than these properties, it does not need to define its own
       * constructor.
       *
       * @param {Object} [options]
       * @param {string} [options.cacheName] Cache name to store and retrieve
       * requests. Defaults to the cache names provided by
       * {@link workbox-core.cacheNames}.
       * @param {Array<Object>} [options.plugins] [Plugins]{@link https://developers.google.com/web/tools/workbox/guides/using-plugins}
       * to use in conjunction with this caching strategy.
       * @param {Object} [options.fetchOptions] Values passed along to the
       * [`init`](https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters)
       * of [non-navigation](https://github.com/GoogleChrome/workbox/issues/1796)
       * `fetch()` requests made by this strategy.
       * @param {Object} [options.matchOptions] The
       * [`CacheQueryOptions`]{@link https://w3c.github.io/ServiceWorker/#dictdef-cachequeryoptions}
       * for any `cache.match()` or `cache.put()` calls made by this strategy.
       */
      constructor(options = {}) {
        /**
         * Cache name to store and retrieve
         * requests. Defaults to the cache names provided by
         * {@link workbox-core.cacheNames}.
         *
         * @type {string}
         */
        this.cacheName = cacheNames.getRuntimeName(options.cacheName);
        /**
         * The list
         * [Plugins]{@link https://developers.google.com/web/tools/workbox/guides/using-plugins}
         * used by this strategy.
         *
         * @type {Array<Object>}
         */
        this.plugins = options.plugins || [];
        /**
         * Values passed along to the
         * [`init`]{@link https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters}
         * of all fetch() requests made by this strategy.
         *
         * @type {Object}
         */
        this.fetchOptions = options.fetchOptions;
        /**
         * The
         * [`CacheQueryOptions`]{@link https://w3c.github.io/ServiceWorker/#dictdef-cachequeryoptions}
         * for any `cache.match()` or `cache.put()` calls made by this strategy.
         *
         * @type {Object}
         */
        this.matchOptions = options.matchOptions;
      }
      /**
       * Perform a request strategy and returns a `Promise` that will resolve with
       * a `Response`, invoking all relevant plugin callbacks.
       *
       * When a strategy instance is registered with a Workbox
       * {@link workbox-routing.Route}, this method is automatically
       * called when the route matches.
       *
       * Alternatively, this method can be used in a standalone `FetchEvent`
       * listener by passing it to `event.respondWith()`.
       *
       * @param {FetchEvent|Object} options A `FetchEvent` or an object with the
       *     properties listed below.
       * @param {Request|string} options.request A request to run this strategy for.
       * @param {ExtendableEvent} options.event The event associated with the
       *     request.
       * @param {URL} [options.url]
       * @param {*} [options.params]
       */
      handle(options) {
        const [responseDone] = this.handleAll(options);
        return responseDone;
      }
      /**
       * Similar to {@link workbox-strategies.Strategy~handle}, but
       * instead of just returning a `Promise` that resolves to a `Response` it
       * it will return an tuple of `[response, done]` promises, where the former
       * (`response`) is equivalent to what `handle()` returns, and the latter is a
       * Promise that will resolve once any promises that were added to
       * `event.waitUntil()` as part of performing the strategy have completed.
       *
       * You can await the `done` promise to ensure any extra work performed by
       * the strategy (usually caching responses) completes successfully.
       *
       * @param {FetchEvent|Object} options A `FetchEvent` or an object with the
       *     properties listed below.
       * @param {Request|string} options.request A request to run this strategy for.
       * @param {ExtendableEvent} options.event The event associated with the
       *     request.
       * @param {URL} [options.url]
       * @param {*} [options.params]
       * @return {Array<Promise>} A tuple of [response, done]
       *     promises that can be used to determine when the response resolves as
       *     well as when the handler has completed all its work.
       */
      handleAll(options) {
        // Allow for flexible options to be passed.
        if (options instanceof FetchEvent) {
          options = {
            event: options,
            request: options.request
          };
        }
        const event = options.event;
        const request = typeof options.request === 'string' ? new Request(options.request) : options.request;
        const params = 'params' in options ? options.params : undefined;
        const handler = new StrategyHandler(this, {
          event,
          request,
          params
        });
        const responseDone = this._getResponse(handler, request, event);
        const handlerDone = this._awaitComplete(responseDone, handler, request, event);
        // Return an array of promises, suitable for use with Promise.all().
        return [responseDone, handlerDone];
      }
      async _getResponse(handler, request, event) {
        await handler.runCallbacks('handlerWillStart', {
          event,
          request
        });
        let response = undefined;
        try {
          response = await this._handle(request, handler);
          // The "official" Strategy subclasses all throw this error automatically,
          // but in case a third-party Strategy doesn't, ensure that we have a
          // consistent failure when there's no response or an error response.
          if (!response || response.type === 'error') {
            throw new WorkboxError('no-response', {
              url: request.url
            });
          }
        } catch (error) {
          if (error instanceof Error) {
            for (const callback of handler.iterateCallbacks('handlerDidError')) {
              response = await callback({
                error,
                event,
                request
              });
              if (response) {
                break;
              }
            }
          }
          if (!response) {
            throw error;
          } else {
            logger.log(`While responding to '${getFriendlyURL(request.url)}', ` + `an ${error instanceof Error ? error.toString() : ''} error occurred. Using a fallback response provided by ` + `a handlerDidError plugin.`);
          }
        }
        for (const callback of handler.iterateCallbacks('handlerWillRespond')) {
          response = await callback({
            event,
            request,
            response
          });
        }
        return response;
      }
      async _awaitComplete(responseDone, handler, request, event) {
        let response;
        let error;
        try {
          response = await responseDone;
        } catch (error) {
          // Ignore errors, as response errors should be caught via the `response`
          // promise above. The `done` promise will only throw for errors in
          // promises passed to `handler.waitUntil()`.
        }
        try {
          await handler.runCallbacks('handlerDidRespond', {
            event,
            request,
            response
          });
          await handler.doneWaiting();
        } catch (waitUntilError) {
          if (waitUntilError instanceof Error) {
            error = waitUntilError;
          }
        }
        await handler.runCallbacks('handlerDidComplete', {
          event,
          request,
          response,
          error: error
        });
        handler.destroy();
        if (error) {
          throw error;
        }
      }
    }
    /**
     * Classes extending the `Strategy` based class should implement this method,
     * and leverage the {@link workbox-strategies.StrategyHandler}
     * arg to perform all fetching and cache logic, which will ensure all relevant
     * cache, cache options, fetch options and plugins are used (per the current
     * strategy instance).
     *
     * @name _handle
     * @instance
     * @abstract
     * @function
     * @param {Request} request
     * @param {workbox-strategies.StrategyHandler} handler
     * @return {Promise<Response>}
     *
     * @memberof workbox-strategies.Strategy
     */

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A {@link workbox-strategies.Strategy} implementation
     * specifically designed to work with
     * {@link workbox-precaching.PrecacheController}
     * to both cache and fetch precached assets.
     *
     * Note: an instance of this class is created automatically when creating a
     * `PrecacheController`; it's generally not necessary to create this yourself.
     *
     * @extends workbox-strategies.Strategy
     * @memberof workbox-precaching
     */
    class PrecacheStrategy extends Strategy {
      /**
       *
       * @param {Object} [options]
       * @param {string} [options.cacheName] Cache name to store and retrieve
       * requests. Defaults to the cache names provided by
       * {@link workbox-core.cacheNames}.
       * @param {Array<Object>} [options.plugins] {@link https://developers.google.com/web/tools/workbox/guides/using-plugins|Plugins}
       * to use in conjunction with this caching strategy.
       * @param {Object} [options.fetchOptions] Values passed along to the
       * {@link https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch#Parameters|init}
       * of all fetch() requests made by this strategy.
       * @param {Object} [options.matchOptions] The
       * {@link https://w3c.github.io/ServiceWorker/#dictdef-cachequeryoptions|CacheQueryOptions}
       * for any `cache.match()` or `cache.put()` calls made by this strategy.
       * @param {boolean} [options.fallbackToNetwork=true] Whether to attempt to
       * get the response from the network if there's a precache miss.
       */
      constructor(options = {}) {
        options.cacheName = cacheNames.getPrecacheName(options.cacheName);
        super(options);
        this._fallbackToNetwork = options.fallbackToNetwork === false ? false : true;
        // Redirected responses cannot be used to satisfy a navigation request, so
        // any redirected response must be "copied" rather than cloned, so the new
        // response doesn't contain the `redirected` flag. See:
        // https://bugs.chromium.org/p/chromium/issues/detail?id=669363&desc=2#c1
        this.plugins.push(PrecacheStrategy.copyRedirectedCacheableResponsesPlugin);
      }
      /**
       * @private
       * @param {Request|string} request A request to run this strategy for.
       * @param {workbox-strategies.StrategyHandler} handler The event that
       *     triggered the request.
       * @return {Promise<Response>}
       */
      async _handle(request, handler) {
        const response = await handler.cacheMatch(request);
        if (response) {
          return response;
        }
        // If this is an `install` event for an entry that isn't already cached,
        // then populate the cache.
        if (handler.event && handler.event.type === 'install') {
          return await this._handleInstall(request, handler);
        }
        // Getting here means something went wrong. An entry that should have been
        // precached wasn't found in the cache.
        return await this._handleFetch(request, handler);
      }
      async _handleFetch(request, handler) {
        let response;
        const params = handler.params || {};
        // Fall back to the network if we're configured to do so.
        if (this._fallbackToNetwork) {
          {
            logger.warn(`The precached response for ` + `${getFriendlyURL(request.url)} in ${this.cacheName} was not ` + `found. Falling back to the network.`);
          }
          const integrityInManifest = params.integrity;
          const integrityInRequest = request.integrity;
          const noIntegrityConflict = !integrityInRequest || integrityInRequest === integrityInManifest;
          // Do not add integrity if the original request is no-cors
          // See https://github.com/GoogleChrome/workbox/issues/3096
          response = await handler.fetch(new Request(request, {
            integrity: request.mode !== 'no-cors' ? integrityInRequest || integrityInManifest : undefined
          }));
          // It's only "safe" to repair the cache if we're using SRI to guarantee
          // that the response matches the precache manifest's expectations,
          // and there's either a) no integrity property in the incoming request
          // or b) there is an integrity, and it matches the precache manifest.
          // See https://github.com/GoogleChrome/workbox/issues/2858
          // Also if the original request users no-cors we don't use integrity.
          // See https://github.com/GoogleChrome/workbox/issues/3096
          if (integrityInManifest && noIntegrityConflict && request.mode !== 'no-cors') {
            this._useDefaultCacheabilityPluginIfNeeded();
            const wasCached = await handler.cachePut(request, response.clone());
            {
              if (wasCached) {
                logger.log(`A response for ${getFriendlyURL(request.url)} ` + `was used to "repair" the precache.`);
              }
            }
          }
        } else {
          // This shouldn't normally happen, but there are edge cases:
          // https://github.com/GoogleChrome/workbox/issues/1441
          throw new WorkboxError('missing-precache-entry', {
            cacheName: this.cacheName,
            url: request.url
          });
        }
        {
          const cacheKey = params.cacheKey || (await handler.getCacheKey(request, 'read'));
          // Workbox is going to handle the route.
          // print the routing details to the console.
          logger.groupCollapsed(`Precaching is responding to: ` + getFriendlyURL(request.url));
          logger.log(`Serving the precached url: ${getFriendlyURL(cacheKey instanceof Request ? cacheKey.url : cacheKey)}`);
          logger.groupCollapsed(`View request details here.`);
          logger.log(request);
          logger.groupEnd();
          logger.groupCollapsed(`View response details here.`);
          logger.log(response);
          logger.groupEnd();
          logger.groupEnd();
        }
        return response;
      }
      async _handleInstall(request, handler) {
        this._useDefaultCacheabilityPluginIfNeeded();
        const response = await handler.fetch(request);
        // Make sure we defer cachePut() until after we know the response
        // should be cached; see https://github.com/GoogleChrome/workbox/issues/2737
        const wasCached = await handler.cachePut(request, response.clone());
        if (!wasCached) {
          // Throwing here will lead to the `install` handler failing, which
          // we want to do if *any* of the responses aren't safe to cache.
          throw new WorkboxError('bad-precaching-response', {
            url: request.url,
            status: response.status
          });
        }
        return response;
      }
      /**
       * This method is complex, as there a number of things to account for:
       *
       * The `plugins` array can be set at construction, and/or it might be added to
       * to at any time before the strategy is used.
       *
       * At the time the strategy is used (i.e. during an `install` event), there
       * needs to be at least one plugin that implements `cacheWillUpdate` in the
       * array, other than `copyRedirectedCacheableResponsesPlugin`.
       *
       * - If this method is called and there are no suitable `cacheWillUpdate`
       * plugins, we need to add `defaultPrecacheCacheabilityPlugin`.
       *
       * - If this method is called and there is exactly one `cacheWillUpdate`, then
       * we don't have to do anything (this might be a previously added
       * `defaultPrecacheCacheabilityPlugin`, or it might be a custom plugin).
       *
       * - If this method is called and there is more than one `cacheWillUpdate`,
       * then we need to check if one is `defaultPrecacheCacheabilityPlugin`. If so,
       * we need to remove it. (This situation is unlikely, but it could happen if
       * the strategy is used multiple times, the first without a `cacheWillUpdate`,
       * and then later on after manually adding a custom `cacheWillUpdate`.)
       *
       * See https://github.com/GoogleChrome/workbox/issues/2737 for more context.
       *
       * @private
       */
      _useDefaultCacheabilityPluginIfNeeded() {
        let defaultPluginIndex = null;
        let cacheWillUpdatePluginCount = 0;
        for (const [index, plugin] of this.plugins.entries()) {
          // Ignore the copy redirected plugin when determining what to do.
          if (plugin === PrecacheStrategy.copyRedirectedCacheableResponsesPlugin) {
            continue;
          }
          // Save the default plugin's index, in case it needs to be removed.
          if (plugin === PrecacheStrategy.defaultPrecacheCacheabilityPlugin) {
            defaultPluginIndex = index;
          }
          if (plugin.cacheWillUpdate) {
            cacheWillUpdatePluginCount++;
          }
        }
        if (cacheWillUpdatePluginCount === 0) {
          this.plugins.push(PrecacheStrategy.defaultPrecacheCacheabilityPlugin);
        } else if (cacheWillUpdatePluginCount > 1 && defaultPluginIndex !== null) {
          // Only remove the default plugin; multiple custom plugins are allowed.
          this.plugins.splice(defaultPluginIndex, 1);
        }
        // Nothing needs to be done if cacheWillUpdatePluginCount is 1
      }
    }
    PrecacheStrategy.defaultPrecacheCacheabilityPlugin = {
      async cacheWillUpdate({
        response
      }) {
        if (!response || response.status >= 400) {
          return null;
        }
        return response;
      }
    };
    PrecacheStrategy.copyRedirectedCacheableResponsesPlugin = {
      async cacheWillUpdate({
        response
      }) {
        return response.redirected ? await copyResponse(response) : response;
      }
    };

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Performs efficient precaching of assets.
     *
     * @memberof workbox-precaching
     */
    class PrecacheController {
      /**
       * Create a new PrecacheController.
       *
       * @param {Object} [options]
       * @param {string} [options.cacheName] The cache to use for precaching.
       * @param {string} [options.plugins] Plugins to use when precaching as well
       * as responding to fetch events for precached assets.
       * @param {boolean} [options.fallbackToNetwork=true] Whether to attempt to
       * get the response from the network if there's a precache miss.
       */
      constructor({
        cacheName,
        plugins = [],
        fallbackToNetwork = true
      } = {}) {
        this._urlsToCacheKeys = new Map();
        this._urlsToCacheModes = new Map();
        this._cacheKeysToIntegrities = new Map();
        this._strategy = new PrecacheStrategy({
          cacheName: cacheNames.getPrecacheName(cacheName),
          plugins: [...plugins, new PrecacheCacheKeyPlugin({
            precacheController: this
          })],
          fallbackToNetwork
        });
        // Bind the install and activate methods to the instance.
        this.install = this.install.bind(this);
        this.activate = this.activate.bind(this);
      }
      /**
       * @type {workbox-precaching.PrecacheStrategy} The strategy created by this controller and
       * used to cache assets and respond to fetch events.
       */
      get strategy() {
        return this._strategy;
      }
      /**
       * Adds items to the precache list, removing any duplicates and
       * stores the files in the
       * {@link workbox-core.cacheNames|"precache cache"} when the service
       * worker installs.
       *
       * This method can be called multiple times.
       *
       * @param {Array<Object|string>} [entries=[]] Array of entries to precache.
       */
      precache(entries) {
        this.addToCacheList(entries);
        if (!this._installAndActiveListenersAdded) {
          self.addEventListener('install', this.install);
          self.addEventListener('activate', this.activate);
          this._installAndActiveListenersAdded = true;
        }
      }
      /**
       * This method will add items to the precache list, removing duplicates
       * and ensuring the information is valid.
       *
       * @param {Array<workbox-precaching.PrecacheController.PrecacheEntry|string>} entries
       *     Array of entries to precache.
       */
      addToCacheList(entries) {
        {
          finalAssertExports.isArray(entries, {
            moduleName: 'workbox-precaching',
            className: 'PrecacheController',
            funcName: 'addToCacheList',
            paramName: 'entries'
          });
        }
        const urlsToWarnAbout = [];
        for (const entry of entries) {
          // See https://github.com/GoogleChrome/workbox/issues/2259
          if (typeof entry === 'string') {
            urlsToWarnAbout.push(entry);
          } else if (entry && entry.revision === undefined) {
            urlsToWarnAbout.push(entry.url);
          }
          const {
            cacheKey,
            url
          } = createCacheKey(entry);
          const cacheMode = typeof entry !== 'string' && entry.revision ? 'reload' : 'default';
          if (this._urlsToCacheKeys.has(url) && this._urlsToCacheKeys.get(url) !== cacheKey) {
            throw new WorkboxError('add-to-cache-list-conflicting-entries', {
              firstEntry: this._urlsToCacheKeys.get(url),
              secondEntry: cacheKey
            });
          }
          if (typeof entry !== 'string' && entry.integrity) {
            if (this._cacheKeysToIntegrities.has(cacheKey) && this._cacheKeysToIntegrities.get(cacheKey) !== entry.integrity) {
              throw new WorkboxError('add-to-cache-list-conflicting-integrities', {
                url
              });
            }
            this._cacheKeysToIntegrities.set(cacheKey, entry.integrity);
          }
          this._urlsToCacheKeys.set(url, cacheKey);
          this._urlsToCacheModes.set(url, cacheMode);
          if (urlsToWarnAbout.length > 0) {
            const warningMessage = `Workbox is precaching URLs without revision ` + `info: ${urlsToWarnAbout.join(', ')}\nThis is generally NOT safe. ` + `Learn more at https://bit.ly/wb-precache`;
            {
              logger.warn(warningMessage);
            }
          }
        }
      }
      /**
       * Precaches new and updated assets. Call this method from the service worker
       * install event.
       *
       * Note: this method calls `event.waitUntil()` for you, so you do not need
       * to call it yourself in your event handlers.
       *
       * @param {ExtendableEvent} event
       * @return {Promise<workbox-precaching.InstallResult>}
       */
      install(event) {
        // waitUntil returns Promise<any>
        // eslint-disable-next-line @typescript-eslint/no-unsafe-return
        return waitUntil(event, async () => {
          const installReportPlugin = new PrecacheInstallReportPlugin();
          this.strategy.plugins.push(installReportPlugin);
          // Cache entries one at a time.
          // See https://github.com/GoogleChrome/workbox/issues/2528
          for (const [url, cacheKey] of this._urlsToCacheKeys) {
            const integrity = this._cacheKeysToIntegrities.get(cacheKey);
            const cacheMode = this._urlsToCacheModes.get(url);
            const request = new Request(url, {
              integrity,
              cache: cacheMode,
              credentials: 'same-origin'
            });
            await Promise.all(this.strategy.handleAll({
              params: {
                cacheKey
              },
              request,
              event
            }));
          }
          const {
            updatedURLs,
            notUpdatedURLs
          } = installReportPlugin;
          {
            printInstallDetails(updatedURLs, notUpdatedURLs);
          }
          return {
            updatedURLs,
            notUpdatedURLs
          };
        });
      }
      /**
       * Deletes assets that are no longer present in the current precache manifest.
       * Call this method from the service worker activate event.
       *
       * Note: this method calls `event.waitUntil()` for you, so you do not need
       * to call it yourself in your event handlers.
       *
       * @param {ExtendableEvent} event
       * @return {Promise<workbox-precaching.CleanupResult>}
       */
      activate(event) {
        // waitUntil returns Promise<any>
        // eslint-disable-next-line @typescript-eslint/no-unsafe-return
        return waitUntil(event, async () => {
          const cache = await self.caches.open(this.strategy.cacheName);
          const currentlyCachedRequests = await cache.keys();
          const expectedCacheKeys = new Set(this._urlsToCacheKeys.values());
          const deletedURLs = [];
          for (const request of currentlyCachedRequests) {
            if (!expectedCacheKeys.has(request.url)) {
              await cache.delete(request);
              deletedURLs.push(request.url);
            }
          }
          {
            printCleanupDetails(deletedURLs);
          }
          return {
            deletedURLs
          };
        });
      }
      /**
       * Returns a mapping of a precached URL to the corresponding cache key, taking
       * into account the revision information for the URL.
       *
       * @return {Map<string, string>} A URL to cache key mapping.
       */
      getURLsToCacheKeys() {
        return this._urlsToCacheKeys;
      }
      /**
       * Returns a list of all the URLs that have been precached by the current
       * service worker.
       *
       * @return {Array<string>} The precached URLs.
       */
      getCachedURLs() {
        return [...this._urlsToCacheKeys.keys()];
      }
      /**
       * Returns the cache key used for storing a given URL. If that URL is
       * unversioned, like `/index.html', then the cache key will be the original
       * URL with a search parameter appended to it.
       *
       * @param {string} url A URL whose cache key you want to look up.
       * @return {string} The versioned URL that corresponds to a cache key
       * for the original URL, or undefined if that URL isn't precached.
       */
      getCacheKeyForURL(url) {
        const urlObject = new URL(url, location.href);
        return this._urlsToCacheKeys.get(urlObject.href);
      }
      /**
       * @param {string} url A cache key whose SRI you want to look up.
       * @return {string} The subresource integrity associated with the cache key,
       * or undefined if it's not set.
       */
      getIntegrityForCacheKey(cacheKey) {
        return this._cacheKeysToIntegrities.get(cacheKey);
      }
      /**
       * This acts as a drop-in replacement for
       * [`cache.match()`](https://developer.mozilla.org/en-US/docs/Web/API/Cache/match)
       * with the following differences:
       *
       * - It knows what the name of the precache is, and only checks in that cache.
       * - It allows you to pass in an "original" URL without versioning parameters,
       * and it will automatically look up the correct cache key for the currently
       * active revision of that URL.
       *
       * E.g., `matchPrecache('index.html')` will find the correct precached
       * response for the currently active service worker, even if the actual cache
       * key is `'/index.html?__WB_REVISION__=1234abcd'`.
       *
       * @param {string|Request} request The key (without revisioning parameters)
       * to look up in the precache.
       * @return {Promise<Response|undefined>}
       */
      async matchPrecache(request) {
        const url = request instanceof Request ? request.url : request;
        const cacheKey = this.getCacheKeyForURL(url);
        if (cacheKey) {
          const cache = await self.caches.open(this.strategy.cacheName);
          return cache.match(cacheKey);
        }
        return undefined;
      }
      /**
       * Returns a function that looks up `url` in the precache (taking into
       * account revision information), and returns the corresponding `Response`.
       *
       * @param {string} url The precached URL which will be used to lookup the
       * `Response`.
       * @return {workbox-routing~handlerCallback}
       */
      createHandlerBoundToURL(url) {
        const cacheKey = this.getCacheKeyForURL(url);
        if (!cacheKey) {
          throw new WorkboxError('non-precached-url', {
            url
          });
        }
        return options => {
          options.request = new Request(url);
          options.params = Object.assign({
            cacheKey
          }, options.params);
          return this.strategy.handle(options);
        };
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    let precacheController;
    /**
     * @return {PrecacheController}
     * @private
     */
    const getOrCreatePrecacheController = () => {
      if (!precacheController) {
        precacheController = new PrecacheController();
      }
      return precacheController;
    };

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Removes any URL search parameters that should be ignored.
     *
     * @param {URL} urlObject The original URL.
     * @param {Array<RegExp>} ignoreURLParametersMatching RegExps to test against
     * each search parameter name. Matches mean that the search parameter should be
     * ignored.
     * @return {URL} The URL with any ignored search parameters removed.
     *
     * @private
     * @memberof workbox-precaching
     */
    function removeIgnoredSearchParams(urlObject, ignoreURLParametersMatching = []) {
      // Convert the iterable into an array at the start of the loop to make sure
      // deletion doesn't mess up iteration.
      for (const paramName of [...urlObject.searchParams.keys()]) {
        if (ignoreURLParametersMatching.some(regExp => regExp.test(paramName))) {
          urlObject.searchParams.delete(paramName);
        }
      }
      return urlObject;
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Generator function that yields possible variations on the original URL to
     * check, one at a time.
     *
     * @param {string} url
     * @param {Object} options
     *
     * @private
     * @memberof workbox-precaching
     */
    function* generateURLVariations(url, {
      ignoreURLParametersMatching = [/^utm_/, /^fbclid$/],
      directoryIndex = 'index.html',
      cleanURLs = true,
      urlManipulation
    } = {}) {
      const urlObject = new URL(url, location.href);
      urlObject.hash = '';
      yield urlObject.href;
      const urlWithoutIgnoredParams = removeIgnoredSearchParams(urlObject, ignoreURLParametersMatching);
      yield urlWithoutIgnoredParams.href;
      if (directoryIndex && urlWithoutIgnoredParams.pathname.endsWith('/')) {
        const directoryURL = new URL(urlWithoutIgnoredParams.href);
        directoryURL.pathname += directoryIndex;
        yield directoryURL.href;
      }
      if (cleanURLs) {
        const cleanURL = new URL(urlWithoutIgnoredParams.href);
        cleanURL.pathname += '.html';
        yield cleanURL.href;
      }
      if (urlManipulation) {
        const additionalURLs = urlManipulation({
          url: urlObject
        });
        for (const urlToAttempt of additionalURLs) {
          yield urlToAttempt.href;
        }
      }
    }

    /*
      Copyright 2020 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * A subclass of {@link workbox-routing.Route} that takes a
     * {@link workbox-precaching.PrecacheController}
     * instance and uses it to match incoming requests and handle fetching
     * responses from the precache.
     *
     * @memberof workbox-precaching
     * @extends workbox-routing.Route
     */
    class PrecacheRoute extends Route {
      /**
       * @param {PrecacheController} precacheController A `PrecacheController`
       * instance used to both match requests and respond to fetch events.
       * @param {Object} [options] Options to control how requests are matched
       * against the list of precached URLs.
       * @param {string} [options.directoryIndex=index.html] The `directoryIndex` will
       * check cache entries for a URLs ending with '/' to see if there is a hit when
       * appending the `directoryIndex` value.
       * @param {Array<RegExp>} [options.ignoreURLParametersMatching=[/^utm_/, /^fbclid$/]] An
       * array of regex's to remove search params when looking for a cache match.
       * @param {boolean} [options.cleanURLs=true] The `cleanURLs` option will
       * check the cache for the URL with a `.html` added to the end of the end.
       * @param {workbox-precaching~urlManipulation} [options.urlManipulation]
       * This is a function that should take a URL and return an array of
       * alternative URLs that should be checked for precache matches.
       */
      constructor(precacheController, options) {
        const match = ({
          request
        }) => {
          const urlsToCacheKeys = precacheController.getURLsToCacheKeys();
          for (const possibleURL of generateURLVariations(request.url, options)) {
            const cacheKey = urlsToCacheKeys.get(possibleURL);
            if (cacheKey) {
              const integrity = precacheController.getIntegrityForCacheKey(cacheKey);
              return {
                cacheKey,
                integrity
              };
            }
          }
          {
            logger.debug(`Precaching did not find a match for ` + getFriendlyURL(request.url));
          }
          return;
        };
        super(match, precacheController.strategy);
      }
    }

    /*
      Copyright 2019 Google LLC
      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Add a `fetch` listener to the service worker that will
     * respond to
     * [network requests]{@link https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers#Custom_responses_to_requests}
     * with precached assets.
     *
     * Requests for assets that aren't precached, the `FetchEvent` will not be
     * responded to, allowing the event to fall through to other `fetch` event
     * listeners.
     *
     * @param {Object} [options] See the {@link workbox-precaching.PrecacheRoute}
     * options.
     *
     * @memberof workbox-precaching
     */
    function addRoute(options) {
      const precacheController = getOrCreatePrecacheController();
      const precacheRoute = new PrecacheRoute(precacheController, options);
      registerRoute(precacheRoute);
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Adds items to the precache list, removing any duplicates and
     * stores the files in the
     * {@link workbox-core.cacheNames|"precache cache"} when the service
     * worker installs.
     *
     * This method can be called multiple times.
     *
     * Please note: This method **will not** serve any of the cached files for you.
     * It only precaches files. To respond to a network request you call
     * {@link workbox-precaching.addRoute}.
     *
     * If you have a single array of files to precache, you can just call
     * {@link workbox-precaching.precacheAndRoute}.
     *
     * @param {Array<Object|string>} [entries=[]] Array of entries to precache.
     *
     * @memberof workbox-precaching
     */
    function precache(entries) {
      const precacheController = getOrCreatePrecacheController();
      precacheController.precache(entries);
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * This method will add entries to the precache list and add a route to
     * respond to fetch events.
     *
     * This is a convenience method that will call
     * {@link workbox-precaching.precache} and
     * {@link workbox-precaching.addRoute} in a single call.
     *
     * @param {Array<Object|string>} entries Array of entries to precache.
     * @param {Object} [options] See the
     * {@link workbox-precaching.PrecacheRoute} options.
     *
     * @memberof workbox-precaching
     */
    function precacheAndRoute(entries, options) {
      precache(entries);
      addRoute(options);
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    const SUBSTRING_TO_FIND = '-precache-';
    /**
     * Cleans up incompatible precaches that were created by older versions of
     * Workbox, by a service worker registered under the current scope.
     *
     * This is meant to be called as part of the `activate` event.
     *
     * This should be safe to use as long as you don't include `substringToFind`
     * (defaulting to `-precache-`) in your non-precache cache names.
     *
     * @param {string} currentPrecacheName The cache name currently in use for
     * precaching. This cache won't be deleted.
     * @param {string} [substringToFind='-precache-'] Cache names which include this
     * substring will be deleted (excluding `currentPrecacheName`).
     * @return {Array<string>} A list of all the cache names that were deleted.
     *
     * @private
     * @memberof workbox-precaching
     */
    const deleteOutdatedCaches = async (currentPrecacheName, substringToFind = SUBSTRING_TO_FIND) => {
      const cacheNames = await self.caches.keys();
      const cacheNamesToDelete = cacheNames.filter(cacheName => {
        return cacheName.includes(substringToFind) && cacheName.includes(self.registration.scope) && cacheName !== currentPrecacheName;
      });
      await Promise.all(cacheNamesToDelete.map(cacheName => self.caches.delete(cacheName)));
      return cacheNamesToDelete;
    };

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Adds an `activate` event listener which will clean up incompatible
     * precaches that were created by older versions of Workbox.
     *
     * @memberof workbox-precaching
     */
    function cleanupOutdatedCaches() {
      // See https://github.com/Microsoft/TypeScript/issues/28357#issuecomment-436484705
      self.addEventListener('activate', event => {
        const cacheName = cacheNames.getPrecacheName();
        event.waitUntil(deleteOutdatedCaches(cacheName).then(cachesDeleted => {
          {
            if (cachesDeleted.length > 0) {
              logger.log(`The following out-of-date precaches were cleaned up ` + `automatically:`, cachesDeleted);
            }
          }
        }));
      });
    }

    /*
      Copyright 2018 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * NavigationRoute makes it easy to create a
     * {@link workbox-routing.Route} that matches for browser
     * [navigation requests]{@link https://developers.google.com/web/fundamentals/primers/service-workers/high-performance-loading#first_what_are_navigation_requests}.
     *
     * It will only match incoming Requests whose
     * {@link https://fetch.spec.whatwg.org/#concept-request-mode|mode}
     * is set to `navigate`.
     *
     * You can optionally only apply this route to a subset of navigation requests
     * by using one or both of the `denylist` and `allowlist` parameters.
     *
     * @memberof workbox-routing
     * @extends workbox-routing.Route
     */
    class NavigationRoute extends Route {
      /**
       * If both `denylist` and `allowlist` are provided, the `denylist` will
       * take precedence and the request will not match this route.
       *
       * The regular expressions in `allowlist` and `denylist`
       * are matched against the concatenated
       * [`pathname`]{@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/pathname}
       * and [`search`]{@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/search}
       * portions of the requested URL.
       *
       * *Note*: These RegExps may be evaluated against every destination URL during
       * a navigation. Avoid using
       * [complex RegExps](https://github.com/GoogleChrome/workbox/issues/3077),
       * or else your users may see delays when navigating your site.
       *
       * @param {workbox-routing~handlerCallback} handler A callback
       * function that returns a Promise resulting in a Response.
       * @param {Object} options
       * @param {Array<RegExp>} [options.denylist] If any of these patterns match,
       * the route will not handle the request (even if a allowlist RegExp matches).
       * @param {Array<RegExp>} [options.allowlist=[/./]] If any of these patterns
       * match the URL's pathname and search parameter, the route will handle the
       * request (assuming the denylist doesn't match).
       */
      constructor(handler, {
        allowlist = [/./],
        denylist = []
      } = {}) {
        {
          finalAssertExports.isArrayOfClass(allowlist, RegExp, {
            moduleName: 'workbox-routing',
            className: 'NavigationRoute',
            funcName: 'constructor',
            paramName: 'options.allowlist'
          });
          finalAssertExports.isArrayOfClass(denylist, RegExp, {
            moduleName: 'workbox-routing',
            className: 'NavigationRoute',
            funcName: 'constructor',
            paramName: 'options.denylist'
          });
        }
        super(options => this._match(options), handler);
        this._allowlist = allowlist;
        this._denylist = denylist;
      }
      /**
       * Routes match handler.
       *
       * @param {Object} options
       * @param {URL} options.url
       * @param {Request} options.request
       * @return {boolean}
       *
       * @private
       */
      _match({
        url,
        request
      }) {
        if (request && request.mode !== 'navigate') {
          return false;
        }
        const pathnameAndSearch = url.pathname + url.search;
        for (const regExp of this._denylist) {
          if (regExp.test(pathnameAndSearch)) {
            {
              logger.log(`The navigation route ${pathnameAndSearch} is not ` + `being used, since the URL matches this denylist pattern: ` + `${regExp.toString()}`);
            }
            return false;
          }
        }
        if (this._allowlist.some(regExp => regExp.test(pathnameAndSearch))) {
          {
            logger.debug(`The navigation route ${pathnameAndSearch} ` + `is being used.`);
          }
          return true;
        }
        {
          logger.log(`The navigation route ${pathnameAndSearch} is not ` + `being used, since the URL being navigated to doesn't ` + `match the allowlist.`);
        }
        return false;
      }
    }

    /*
      Copyright 2019 Google LLC

      Use of this source code is governed by an MIT-style
      license that can be found in the LICENSE file or at
      https://opensource.org/licenses/MIT.
    */
    /**
     * Helper function that calls
     * {@link PrecacheController#createHandlerBoundToURL} on the default
     * {@link PrecacheController} instance.
     *
     * If you are creating your own {@link PrecacheController}, then call the
     * {@link PrecacheController#createHandlerBoundToURL} on that instance,
     * instead of using this function.
     *
     * @param {string} url The precached URL which will be used to lookup the
     * `Response`.
     * @param {boolean} [fallbackToNetwork=true] Whether to attempt to get the
     * response from the network if there's a precache miss.
     * @return {workbox-routing~handlerCallback}
     *
     * @memberof workbox-precaching
     */
    function createHandlerBoundToURL(url) {
      const precacheController = getOrCreatePrecacheController();
      return precacheController.createHandlerBoundToURL(url);
    }

    exports.NavigationRoute = NavigationRoute;
    exports.cleanupOutdatedCaches = cleanupOutdatedCaches;
    exports.clientsClaim = clientsClaim;
    exports.createHandlerBoundToURL = createHandlerBoundToURL;
    exports.precacheAndRoute = precacheAndRoute;
    exports.registerRoute = registerRoute;

}));


==================================================
FILE: .\legacy\Auth.tsx
==================================================

import React, { useState } from 'react';
import { auth } from './firebase';
import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'firebase/auth';

interface AuthProps {
  onLogin: (user: any) => void;
}

export default function Auth({ onLogin }: AuthProps) {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    try {
      if (isLogin) {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        onLogin(userCredential.user);
      } else {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        onLogin(userCredential.user);
      }
    } catch (err: any) {
      setError(err.message.replace('Firebase: ', '').replace(' (auth/', ': ').replace(')', ''));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-[#0f172a] p-4">
      <div className="w-full max-w-md p-8 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-2xl">
        <h2 className="text-3xl font-bold text-center text-white mb-2">
          {isLogin ? 'EviroSafe Login' : 'Create Account'}
        </h2>
        {error && <div className="mb-4 p-3 bg-red-500/20 text-red-200 text-sm rounded">{error}</div>}
        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label className="text-gray-300 text-sm">Email</label>
            <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)}
              className="w-full px-4 py-3 mt-1 rounded-lg bg-black/20 border border-white/10 text-white focus:border-blue-500 outline-none" placeholder="Enter email" />
          </div>
          <div>
            <label className="text-gray-300 text-sm">Password</label>
            <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-3 mt-1 rounded-lg bg-black/20 border border-white/10 text-white focus:border-blue-500 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <button type="submit" disabled={loading} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all">
            {loading ? 'Processing...' : (isLogin ? 'Enter System' : 'Sign Up')}
          </button>
        </form>
        <p className="mt-6 text-center text-gray-400 text-sm cursor-pointer hover:text-white" onClick={() => setIsLogin(!isLogin)}>
          {isLogin ? "Need an account? Sign Up" : "Have an account? Login"}
        </p>
      </div>
    </div>
  );
}

==================================================
FILE: .\legacy\constants.ts
==================================================



==================================================
FILE: .\legacy\IncidentList.tsx
==================================================

import React, { useEffect, useState } from 'react';
import { db } from './firebase';
import { collection, query, orderBy, onSnapshot } from 'firebase/firestore';

export default function IncidentList() {
  const [incidents, setIncidents] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Listen for updates in real-time
    const q = query(collection(db, "incidents"), orderBy("date", "desc"));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const list = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setIncidents(list);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  if (loading) return <div className="text-gray-400 text-center p-4">Loading feed...</div>;

  return (
    <div className="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
      {incidents.length === 0 ? (
        <p className="text-gray-500 text-center py-10">No incidents reported yet.</p>
      ) : (
        incidents.map((item) => (
          <div key={item.id} className="bg-white/5 border border-white/10 p-4 rounded-lg hover:bg-white/10 transition-colors">
            <div className="flex justify-between items-start mb-2">
              <h4 className="font-bold text-white text-lg">{item.title}</h4>
              <span className={`px-2 py-1 rounded text-xs font-bold ${
                item.severity === 'Critical' ? 'bg-red-500 text-white animate-pulse' :
                item.severity === 'High' ? 'bg-orange-500 text-white' :
                item.severity === 'Medium' ? 'bg-yellow-500 text-black' :
                'bg-green-500 text-white'
              }`}>
                {item.severity}
              </span>
            </div>
            <p className="text-gray-300 text-sm mb-3">{item.description}</p>
            <div className="flex justify-between items-center text-xs text-gray-500 border-t border-white/5 pt-2">
              <span>Reported by: {item.reporter}</span>
              <span>{new Date(item.date).toLocaleDateString()}</span>
            </div>
          </div>
        ))
      )}
    </div>
  );
}

==================================================
FILE: .\legacy\index.tsx
==================================================

import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App';
import { ToastProvider } from './components/ui/Toast';

const root = ReactDOM.createRoot(document.getElementById('root') as HTMLElement);
root.render(
  <React.StrictMode>
    <ToastProvider>
      <App />
    </ToastProvider>
  </React.StrictMode>
);

==================================================
FILE: .\legacy\ReportForm.tsx
==================================================

import React, { useState } from 'react';
import { db, auth } from './firebase';
import { collection, addDoc } from 'firebase/firestore'; 

export default function ReportForm() {
  const [title, setTitle] = useState('');
  const [severity, setSeverity] = useState('Low');
  const [description, setDescription] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      // THIS SAVES DATA TO FIRESTORE
      await addDoc(collection(db, "incidents"), {
        title: title,
        severity: severity,
        description: description,
        reporter: auth.currentUser?.email,
        date: new Date().toISOString()
      });
      
      alert("Report Submitted Successfully!");
      setTitle('');
      setDescription('');
    } catch (error) {
      console.error("Error adding document: ", error);
      alert("Error submitting report");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-white/5 border border-white/10 p-6 rounded-xl backdrop-blur-sm">
      <h3 className="text-xl font-bold text-white mb-4">Report Safety Incident</h3>
      
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-gray-400 text-sm mb-1">Incident Title</label>
          <input 
            type="text" 
            required
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
            placeholder="e.g. Chemical Spill in Sector 4"
          />
        </div>

        <div>
          <label className="block text-gray-400 text-sm mb-1">Severity Level</label>
          <select 
            value={severity}
            onChange={(e) => setSeverity(e.target.value)}
            className="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
          >
            <option value="Low">ðŸŸ¢ Low Risk</option>
            <option value="Medium">ðŸŸ¡ Medium Risk</option>
            <option value="High">ðŸ”´ High Risk</option>
            <option value="Critical">ðŸ”¥ Critical</option>
          </select>
        </div>

        <div>
          <label className="block text-gray-400 text-sm mb-1">Description</label>
          <textarea 
            required
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            className="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-white h-24 focus:outline-none focus:border-blue-500"
            placeholder="Describe what happened..."
          />
        </div>

        <button 
          type="submit" 
          disabled={loading}
          className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition-colors disabled:opacity-50"
        >
          {loading ? 'Sending...' : 'Submit Report'}
        </button>
      </form>
    </div>
  );
}

==================================================
FILE: .\src\App.tsx
==================================================

import React, { useState, useEffect } from 'react';
import { AppProvider, DataProvider, ModalProvider, useAppContext, useDataContext, useModalContext } from './contexts';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { LoginScreen } from './components/LoginScreen';
import { DemoBanner } from './components/DemoBanner';
import { ToastProvider } from './components/ui/Toast';
import { Sidebar } from './components/Sidebar';
import { roles as rolesConfig } from './config';
import { Loader2 } from 'lucide-react';
import type { User } from './types'; // Added import for type safety

// --- Import Feature Components ---
import { Dashboard } from './components/Dashboard';
import { Reports } from './components/Reports';
import { Inspections } from './components/Inspections';
import { Ptw } from './components/Ptw';
import { Rams } from './components/Rams';
import { Plans } from './components/Plans';
import { Actions } from './components/Actions';
import { Checklists } from './components/Checklists';
import { Tbt } from './components/Tbt';
import { Trainings } from './components/Trainings';
import { People } from './components/People';
import { Roles } from './components/Roles';
import { Organizations } from './components/Organizations';
import { Projects } from './components/Projects';
import { Signage } from './components/Signage';
import { AiInsights } from './components/AiInsights';
import { Settings } from './components/Settings';
import { SiteMap } from './components/SiteMap';
import { Housekeeping } from './components/Housekeeping';
import { CertifiedProfile } from './components/CertifiedProfile';
import { HseStatistics } from './components/HseStatistics';

// --- Import Modals ---
import { ReportCreationModal } from './components/ReportCreationModal';
import { ReportDetailModal } from './components/ReportDetailModal';
import { PtwCreationModal } from './components/PtwCreationModal';
import { PtwDetailModal } from './components/PtwDetailModal';
import { PlanCreationModal } from './components/PlanCreationModal';
import { PlanEditorModal } from './components/PlanEditorModal';
import { PlanDetailModal } from './components/PlanDetailModal';
import { RamsCreationModal } from './components/RamsCreationModal';
import { RamsEditorModal } from './components/RamsEditorModal';
import { RamsDetailModal } from './components/RamsDetailModal';
import { TbtCreationModal } from './components/TbtCreationModal';
import { TbtSessionModal } from './components/TbtSessionModal';
import { TrainingCourseModal } from './components/TrainingCourseModal';
import { TrainingSessionModal } from './components/TrainingSessionModal';
import { SessionAttendanceModal } from './components/SessionAttendanceModal';
import { ActionCreationModal } from './components/ActionCreationModal';
import { InspectionCreationModal } from './components/InspectionCreationModal';
import { InspectionConductModal } from './components/InspectionConductModal';
import { ChecklistRunModal } from './components/ChecklistRunModal';
import { ChecklistDetailModal } from './components/ChecklistDetailModal';

// --- Auth Sync: Bridge Firebase Auth -> EviroSafe "activeUser" ---
const AuthSync: React.FC = () => {
  const { currentUser } = useAuth();
  const { usersList, setUsersList, login, logout, activeOrg } = useAppContext();

  useEffect(() => {
    if (!currentUser) {
      logout();
      return;
    }

    const uid = currentUser.uid;
    const email = currentUser.email || `user-${uid.slice(0, 6)}@evirosafe.local`;
    const displayName = currentUser.displayName || email.split('@')[0];

    // Ensure user exists in local state
    setUsersList(prev => {
      if (prev.some(u => u.id === uid)) return prev;

      const existingUser = prev[0];
      
      // FIX: Explicitly typed to match User interface
      const defaultPreferences: User['preferences'] = {
          language: 'en',
          default_view: 'dashboard',
          units: { 
            temperature: 'C', 
            wind_speed: 'km/h', 
            height: 'm', 
            weight: 'kg' 
          }
      };

      const template = existingUser ? {
        ...existingUser,
        preferences: existingUser.preferences || defaultPreferences
      } : {
        id: uid,
        org_id: activeOrg?.id || 'org1',
        email,
        name: displayName,
        avatar_url: '',
        role: 'ADMIN',
        status: 'active',
        preferences: defaultPreferences
      };

      // Explicitly cast to User to satisfy TypeScript
      const newUser: User = {
        ...template,
        id: uid,
        org_id: activeOrg?.id || template.org_id,
        email,
        name: displayName,
        status: 'active'
      } as User;

      return [newUser, ...prev];
    });

    // Force login to set activeUser
    login(uid);
  }, [currentUser, activeOrg?.id]);

  return null;
};

// --- Global Modals Component ---
const GlobalModals = () => {
  const { activeUser, usersList } = useAppContext();
  const {
    isReportCreationModalOpen, setIsReportCreationModalOpen, selectedReport, setSelectedReport, reportInitialData,
    isPtwCreationModalOpen, setIsPtwCreationModalOpen, ptwCreationMode, selectedPtw, setSelectedPtw,
    isPlanCreationModalOpen, setIsPlanCreationModalOpen, selectedPlan, setSelectedPlan, selectedPlanForEdit, setSelectedPlanForEdit,
    isRamsCreationModalOpen, setIsRamsCreationModalOpen, selectedRams, setSelectedRams, selectedRamsForEdit, setSelectedRamsForEdit,
    isTbtCreationModalOpen, setIsTbtCreationModalOpen, selectedTbt, setSelectedTbt,
    isCourseModalOpen, setCourseModalOpen, isSessionModalOpen, setSessionModalOpen, isAttendanceModalOpen, setAttendanceModalOpen,
    courseForSession, sessionForAttendance,
    isActionCreationModalOpen, setIsActionCreationModalOpen,
    isInspectionCreationModalOpen, setIsInspectionCreationModalOpen
  } = useModalContext();

  const {
    handleCreateReport, handleStatusChange, handleCapaActionChange, handleAcknowledgeReport,
    handleCreatePtw, handleUpdatePtw,
    handleCreatePlan, handlePlanStatusChange, handleUpdatePlan,
    handleCreateRams, handleRamsStatusChange, handleUpdateRams,
    handleCreateTbt, handleUpdateTbt,
    handleCreateOrUpdateCourse, handleScheduleSession, handleCloseSession,
    handleCreateStandaloneAction, handleCreateInspection,
    projects, trainingCourseList, checklistTemplates
  } = useDataContext();

  if (!activeUser) return null;

  return (
    <>
      <ReportCreationModal isOpen={isReportCreationModalOpen} onClose={() => setIsReportCreationModalOpen(false)} initialData={reportInitialData} />
      {selectedReport && <ReportDetailModal report={selectedReport} users={usersList} activeUser={activeUser} onClose={() => setSelectedReport(null)} onStatusChange={handleStatusChange} onCapaActionChange={handleCapaActionChange} onAcknowledgeReport={handleAcknowledgeReport} />}
      <PtwCreationModal isOpen={isPtwCreationModalOpen} onClose={() => setIsPtwCreationModalOpen(false)} onSubmit={handleCreatePtw} mode={ptwCreationMode} />
      {selectedPtw && <PtwDetailModal ptw={selectedPtw} onClose={() => setSelectedPtw(null)} onUpdate={handleUpdatePtw} />}
      <PlanCreationModal isOpen={isPlanCreationModalOpen} onClose={() => setIsPlanCreationModalOpen(false)} onSubmit={handleCreatePlan} projects={projects} />
      {selectedPlan && <PlanDetailModal plan={selectedPlan} onClose={() => setSelectedPlan(null)} onStatusChange={handlePlanStatusChange} />}
      {selectedPlanForEdit && <PlanEditorModal plan={selectedPlanForEdit} onClose={() => setSelectedPlanForEdit(null)} onSave={handleUpdatePlan} onSubmitForReview={handlePlanStatusChange} />}
      <RamsCreationModal isOpen={isRamsCreationModalOpen} onClose={() => setIsRamsCreationModalOpen(false)} onSubmit={handleCreateRams} projects={projects} activeUser={activeUser} />
      {selectedRams && <RamsDetailModal rams={selectedRams} onClose={() => setSelectedRams(null)} onStatusChange={handleRamsStatusChange} />}
      {selectedRamsForEdit && <RamsEditorModal rams={selectedRamsForEdit} onClose={() => setSelectedRamsForEdit(null)} onSave={handleUpdateRams} onSubmitForReview={handleRamsStatusChange} />}
      <TbtCreationModal isOpen={isTbtCreationModalOpen} onClose={() => setIsTbtCreationModalOpen(false)} onSubmit={handleCreateTbt} projects={projects} activeUser={activeUser} />
      {selectedTbt && <TbtSessionModal session={selectedTbt} onClose={() => setSelectedTbt(null)} onUpdate={handleUpdateTbt} users={usersList} />}
      <TrainingCourseModal isOpen={isCourseModalOpen} onClose={() => setCourseModalOpen(false)} courses={trainingCourseList} onUpdateCourse={handleCreateOrUpdateCourse} />
      {courseForSession && <TrainingSessionModal isOpen={isSessionModalOpen} onClose={() => setSessionModalOpen(false)} onSubmit={handleScheduleSession} course={courseForSession} projects={projects} users={usersList} />}
      {sessionForAttendance && <SessionAttendanceModal isOpen={isAttendanceModalOpen} onClose={() => setAttendanceModalOpen(false)} onSubmit={handleCloseSession} session={sessionForAttendance} users={usersList} />}
      <ActionCreationModal isOpen={isActionCreationModalOpen} onClose={() => setIsActionCreationModalOpen(false)} onSubmit={handleCreateStandaloneAction} users={usersList} projects={projects} />
      <InspectionCreationModal isOpen={isInspectionCreationModalOpen} onClose={() => setIsInspectionCreationModalOpen(false)} onSubmit={handleCreateInspection} projects={projects} users={usersList} checklistTemplates={checklistTemplates} />
    </>
  );
};

// --- Main App Content ---
const AppContent = () => {
  const { currentView, setCurrentView, activeUser } = useAppContext();
  const { currentUser, loading: authLoading } = useAuth();
  const { isLoading: dataLoading } = useDataContext();

  const {
    projects, ptwList, trainingCourseList, trainingRecordList, trainingSessionList,
  } = useDataContext();

  const {
    setSelectedPlan, setSelectedPlanForEdit, setIsPlanCreationModalOpen,
    setSelectedRams, setSelectedRamsForEdit, setIsRamsCreationModalOpen,
    setCourseModalOpen, setSessionModalOpen, setCourseForSession, setAttendanceModalOpen, setSessionForAttendance,
    setIsPtwCreationModalOpen, setPtwCreationMode, setSelectedPtw,
  } = useModalContext();

  const [sidebarOpen, setSidebarOpen] = useState(true);

  // --- LOADING STATE ---
  if (authLoading || (currentUser && dataLoading)) {
    return (
      <div className="flex h-screen items-center justify-center bg-slate-950 text-white flex-col gap-4">
        <Loader2 className="w-10 h-10 animate-spin text-cyan-500" />
        <p className="text-slate-400 animate-pulse">Loading EviroSafe...</p>
      </div>
    );
  }

  if (!currentUser) {
    return <LoginScreen />;
  }

  return (
    <div className="flex min-h-screen bg-slate-950 text-slate-100 transition-all duration-300">
      <Sidebar
        currentView={currentView}
        setCurrentView={setCurrentView}
        isOpen={sidebarOpen}
        setOpen={setSidebarOpen}
      />

      <main className="flex-1 min-h-screen flex flex-col transition-all duration-300">
        <DemoBanner />
        <div className="flex-1 p-8 overflow-y-auto">
          {currentView === 'dashboard' && <Dashboard />}
          {currentView === 'site-map' && <div className="h-[calc(100vh-8rem)]"><SiteMap /></div>}
          {currentView === 'reports' && <Reports />}
          {currentView === 'ptw' && (
            <Ptw
              ptws={ptwList}
              users={[]}
              projects={projects}
              onCreatePtw={() => { setPtwCreationMode('new'); setIsPtwCreationModalOpen(true); }}
              onAddExistingPtw={() => { setPtwCreationMode('existing'); setIsPtwCreationModalOpen(true); }}
              onSelectPtw={setSelectedPtw}
            />
          )}
          {currentView === 'inspections' && <Inspections />}
          {currentView === 'actions' && <Actions />}
          {currentView === 'plans' && (
            <Plans
              onSelectPlan={(plan) => plan.status === 'draft' ? setSelectedPlanForEdit(plan) : setSelectedPlan(plan)}
              onNewPlan={() => setIsPlanCreationModalOpen(true)}
            />
          )}
          {currentView === 'rams' && (
            <Rams
              onSelectRams={(rams) => rams.status === 'draft' ? setSelectedRamsForEdit(rams) : setSelectedRams(rams)}
              onNewRams={() => setIsRamsCreationModalOpen(true)}
            />
          )}
          {currentView === 'checklists' && <Checklists />}
          {currentView === 'tbt' && <Tbt />}
          {currentView === 'training' && (
            <Trainings
              courses={trainingCourseList}
              records={trainingRecordList}
              sessions={trainingSessionList}
              users={[]}
              projects={projects}
              onManageCourses={() => setCourseModalOpen(true)}
              onScheduleSession={(course) => { setCourseForSession(course); setSessionModalOpen(true); }}
              onManageAttendance={(session) => { setSessionForAttendance(session); setAttendanceModalOpen(true); }}
            />
          )}
          {currentView === 'people' && <People />}
          {currentView === 'roles' && <Roles roles={rolesConfig} />}
          {currentView === 'organizations' && <Organizations />}
          {currentView === 'projects' && <Projects />}
          {currentView === 'signage' && <Signage />}
          {currentView === 'ai-insights' && <AiInsights />}
          {currentView === 'settings' && <Settings />}
          {currentView === 'housekeeping' && <Housekeeping />}
          {currentView === 'certification' && <CertifiedProfile />}
          {currentView === 'hse-statistics' && <HseStatistics />}
        </div>
      </main>
      <GlobalModals />
    </div>
  );
};

export default function App() {
  return (
    <AuthProvider>
      <ToastProvider>
        <AppProvider>
          <AuthSync />
          <DataProvider>
            <ModalProvider>
              <AppContent />
            </ModalProvider>
          </DataProvider>
        </AppProvider>
      </ToastProvider>
    </AuthProvider>
  );
}

==================================================
FILE: .\src\config.ts
==================================================

import type { Role, Resource, Action, Scope, PlanType, PlanContentSection, Rams as RamsType, PtwType, PtwSafetyRequirement, PtwSignoff, PtwSignature, PtwExtension, PtwClosure, SignCategory } from './types';

// Logo Source - pointing to local file
export const logoSrc = '/logo.svg';

export const supportedLanguages: { code: string; name: string; dir: 'ltr' | 'rtl' }[] = [
  { code: 'en', name: 'English', dir: 'ltr' },
  { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', dir: 'rtl' },
  { code: 'ur', name: 'Ø§Ø±Ø¯Ùˆ', dir: 'rtl' },
  { code: 'hi', name: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', dir: 'ltr' },
  { code: 'fr', name: 'FranÃ§ais', dir: 'ltr' },
  { code: 'es', name: 'EspaÃ±ol', dir: 'ltr' },
];

export const translations: Record<string, Record<string, string>> = {
  en: {
    'sidebar.dashboard': 'Dashboard',
    'sidebar.ai_insights': 'AI Insights',
    'sidebar.reporting': 'Reporting',
    'sidebar.inspections': 'Inspections',
    'sidebar.ptw': 'Permit to Work',
    'sidebar.checklists': 'Checklists',
    'sidebar.plans': 'Plans',
    'sidebar.rams': 'RAMS',
    'sidebar.signage': 'Signage',
    'sidebar.tbt': 'Toolbox Talks',
    'sidebar.training': 'Trainings',
    'sidebar.housekeeping': 'Housekeeping',
    'sidebar.actions': 'Action Tracker',
    'sidebar.site_map': 'Site Map',
    'sidebar.certification': 'My Certificate',
    'sidebar.organizations': 'Organizations',
    'sidebar.projects': 'Projects',
    'sidebar.people': 'People & Access',
    'sidebar.roles': 'Roles & Permissions',
    'sidebar.settings': 'Settings & Logs',
    'sidebar.hse-statistics': 'HSE Statistics',
  },
  ar: {
    'sidebar.dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
    'sidebar.ai_insights': 'Ø±Ø¤Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
    'sidebar.reporting': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
    'sidebar.inspections': 'Ø§Ù„ØªÙØªÙŠØ´',
    'sidebar.ptw': 'ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„',
    'sidebar.checklists': 'Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
    'sidebar.plans': 'Ø§Ù„Ø®Ø·Ø·',
    'sidebar.rams': 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±',
    'sidebar.signage': 'Ø§Ù„Ù„Ø§ÙØªØ§Øª',
    'sidebar.tbt': 'Ø­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø§Ù…Ø©',
    'sidebar.training': 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨',
    'sidebar.housekeeping': 'Ø§Ù„ØªØ¯Ø¨ÙŠØ± Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ',
    'sidebar.actions': 'Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
    'sidebar.site_map': 'Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹',
    'sidebar.certification': 'Ø´Ù‡Ø§Ø¯ØªÙŠ',
    'sidebar.organizations': 'Ø§Ù„Ù…Ù†Ø¸Ù…Ø§Øª',
    'sidebar.projects': 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
    'sidebar.people': 'Ø§Ù„Ø£ÙØ±Ø§Ø¯ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª',
    'sidebar.roles': 'Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª',
    'sidebar.settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª',
    'sidebar.hse-statistics': 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©',
  },
};

const allActions: Action[] = ['read', 'create', 'update', 'approve', 'delete', 'export', 'assign'];
const readCreateUpdate: Action[] = ['read', 'create', 'update'];

export const allPossiblePermissions: { resource: Resource; actions: Action[]; scopes: Scope[] }[] = [
    { resource: 'dashboard', actions: ['read'], scopes: ['org'] },
    { resource: 'reports', actions: allActions, scopes: ['org', 'project', 'own'] },
    { resource: 'inspections', actions: allActions, scopes: ['org', 'project', 'own'] },
    { resource: 'ptw', actions: allActions, scopes: ['org', 'project', 'own'] },
    { resource: 'checklists', actions: allActions, scopes: ['org', 'project'] },
    { resource: 'housekeeping', actions: readCreateUpdate, scopes: ['org', 'project'] },
    { resource: 'plans', actions: allActions, scopes: ['org', 'project'] },
    { resource: 'rams', actions: allActions, scopes: ['org', 'project'] },
    { resource: 'signage', actions: readCreateUpdate, scopes: ['org'] },
    { resource: 'tbt', actions: allActions, scopes: ['org', 'project'] },
    { resource: 'training', actions: allActions, scopes: ['org', 'project'] },
    { resource: 'actions', actions: ['read', 'update', 'assign'], scopes: ['org', 'project', 'own'] },
    { resource: 'site-map', actions: ['read'], scopes: ['org', 'project'] },
    { resource: 'certification', actions: ['read', 'update'], scopes: ['own'] },
    { resource: 'organizations', actions: readCreateUpdate, scopes: ['org'] },
    { resource: 'projects', actions: readCreateUpdate, scopes: ['org'] },
    { resource: 'people', actions: ['read', 'create', 'update', 'delete'], scopes: ['org'] },
    { resource: 'roles', actions: ['read', 'create', 'update'], scopes: ['org'] },
    { resource: 'settings', actions: ['read', 'update'], scopes: ['org', 'own'] },
    { resource: 'hse-statistics', actions: ['read'], scopes: ['org'] },
];

export const roles: Role[] = [
  { 
    org_id: null, key: 'ADMIN', label: 'Administrator', is_system: true,
    permissions: allPossiblePermissions.map(p => ({
        resource: p.resource,
        actions: p.actions,
        scope: 'org' as Scope,
    }))
  },
  { 
    org_id: null, key: 'ORG_ADMIN', label: 'Organization Admin', is_system: true,
    permissions: allPossiblePermissions.map(p => ({
        resource: p.resource,
        actions: p.actions,
        scope: 'org' as Scope,
    }))
  },
  { 
    org_id: null, key: 'HSE_MANAGER', label: 'HSE Manager', is_system: true,
    permissions: allPossiblePermissions.map(p => ({
        resource: p.resource,
        actions: p.actions,
        scope: 'org' as Scope,
    }))
  },
  {
    org_id: null, key: 'SUPERVISOR', label: 'Supervisor', is_system: true,
    permissions: allPossiblePermissions.map(p => ({
        resource: p.resource,
        actions: ['read', 'create', 'update'],
        scope: 'project' as Scope,
    }))
  },
  {
    org_id: null, key: 'WORKER', label: 'Worker', is_system: true,
    permissions: [
        { resource: 'dashboard', actions: ['read'], scope: 'own' },
        { resource: 'reports', actions: ['read', 'create'], scope: 'own' },
        { resource: 'training', actions: ['read'], scope: 'own' },
        { resource: 'certification', actions: ['read', 'update'], scope: 'own' },
    ]
  }
];

export const planTypes: PlanType[] = ['HSEMP', 'Lifting', 'Work at Height', 'Confined Space', 'Fire', 'ERP', 'EMP', 'Waste'];

export const planTemplates: Record<PlanType, PlanContentSection[]> = {
    'HSEMP': [
        { title: '1. Purpose', content: 'Define the objectives of this plan...', is_complete: false },
        { title: '2. Scope', content: 'This plan covers...', is_complete: false },
    ],
    'Lifting': [
        { title: '1. Lift Details', content: 'Specify the load, location, and equipment.', is_complete: false },
    ],
    'Work at Height': [
        { title: '1. Access Method', content: 'Describe the method of access.', is_complete: false },
    ],
    'Confined Space': [], 'Fire': [], 'ERP': [], 'EMP': [], 'Waste': [],
};

export const tbtTopicsLibrary = {
    'General Safety': ['Slips, Trips, and Falls', 'PPE'],
    'High Risk': ['Working at Height', 'Confined Space'],
};

export const ramsTemplate: Omit<RamsType, 'id'|'org_id'|'project_id'|'activity'|'location'|'audit_log'|'prepared_by'> = {
    status: 'draft',
    version: 'v0.1',
    reviewed_by: { name: '', email: '', role: '' },
    approved_by_client: { name: '', email: '', role: '' },
    times: { created_at: '', updated_at: '', approved_at: '', valid_from: '', valid_until: '' },
    method_statement: { overview: '', competence: '', sequence_of_operations: [], emergency_arrangements: '' },
    overall_risk_before: 0,
    overall_risk_after: 0,
    attachments: [],
    linked_ptw_types: [],
};

export const ptwTypeDetails: Record<PtwType, { icon: string; description: string; color: string; hex: string; }> = {
    'General Work': { icon: 'ðŸ”¹', description: 'Baseline, low-risk work', color: 'blue-500', hex: '#3B82F6' },
    'Hot Work': { icon: 'ðŸ”¥', description: 'Welding, cutting, sparks', color: 'red-500', hex: '#EF4444' },
    'Electrical Work': { icon: 'âš¡', description: 'Live electrical systems', color: 'amber-500', hex: '#F59E0B' },
    'Excavation': { icon: 'â›ï¸', description: 'Ground works, trenching', color: 'brown-500', hex: '#78350F' },
    'Lifting': { icon: 'ðŸ—ï¸', description: 'Crane lifts, suspended loads', color: 'orange-500', hex: '#F97316' },
    'Work at Height': { icon: 'ðŸ§—', description: 'Scaffolds, ladders, fall risks', color: 'sky-500', hex: '#0EA5E9' },
    'Confined Space Entry': { icon: 'ðŸ•³ï¸', description: 'Tanks, pits, enclosed areas', color: 'purple-500', hex: '#8B5CF6' },
    'Night Work': { icon: 'ðŸŒ™', description: 'After-hours, low visibility', color: 'indigo-500', hex: '#6366F1' },
    'Road Closure': { icon: 'ðŸš§', description: 'Traffic management', color: 'orange-600', hex: '#EA580C' },
    'Utility Work': { icon: 'ðŸ› ï¸', description: 'Service lines, LOTO', color: 'teal-500', hex: '#14B8A6' },
};

export const ptwChecklistData: Record<string, Omit<PtwSafetyRequirement, 'response' | 'is_critical' | 'evidence_urls' | 'comment'>[]> = {
    'General Work': [{ id: 'gw_1', text: 'RAMS approved and available' }],
    'Hot Work': [{ id: 'hw_1', text: 'Fire watch assigned' }],
    'Work at Height': [{ id: 'wah_1', text: 'Scaffolding inspected' }],
};

export const emptySignoff: PtwSignoff = { name: '', designation: '', email: '', mobile: '', remarks: '', signature: '', signed_at: '' };
export const emptySignature: PtwSignature = { signature: '', signed_at: '' };
export const emptyExtension: PtwExtension = { is_requested: false, reason: '', days: { from: '', to: '' }, hours: { from: '', to: '' }, requester: emptySignature, client_proponent: emptySignature, client_hs: emptySignature };
export const emptyClosure: PtwClosure = { note: '', permit_requester: emptySignature, client_proponent: emptySignature, client_hs: emptySignature };

export const signageConfig: Record<SignCategory, { shape: 'circle' | 'triangle' | 'rectangle'; bgColor: string; textColor: string; symbolColor?: string; borderColor?: string; hasSlash?: boolean; }> = {
    'Prohibition': { shape: 'circle', bgColor: 'bg-white', textColor: 'text-black', borderColor: 'border-red-600', hasSlash: true },
    'Mandatory': { shape: 'circle', bgColor: 'bg-blue-600', textColor: 'text-white', symbolColor: 'text-white' },
    'Warning': { shape: 'triangle', bgColor: 'bg-yellow-400', textColor: 'text-black', borderColor: 'border-black', symbolColor: 'text-black' },
    'Emergency': { shape: 'rectangle', bgColor: 'bg-green-600', textColor: 'text-white', symbolColor: 'text-white' },
    'Fire': { shape: 'rectangle', bgColor: 'bg-red-600', textColor: 'text-white', symbolColor: 'text-white' },
    'Environmental': { shape: 'rectangle', bgColor: 'bg-green-700', textColor: 'text-white', symbolColor: 'text-white' },
    'Traffic': { shape: 'rectangle', bgColor: 'bg-blue-700', textColor: 'text-white', symbolColor: 'text-white' },
    'Informational': { shape: 'rectangle', bgColor: 'bg-blue-500', textColor: 'text-white', symbolColor: 'text-white' },
};

==================================================
FILE: .\src\contexts.tsx
==================================================

import React, { createContext, useState, useMemo, useContext, useEffect } from 'react';
import { 
  organizations as initialOrganizations, 
  users as initialUsers,
  projects as initialProjects,
  checklistTemplates as initialTemplates,
  signs as initialSigns,
  plans as initialPlans,
  rams as initialRams
} from './data';
import { translations, supportedLanguages, roles } from './config';
import type { 
  Organization, User, Report, ChecklistRun, Inspection, Plan as PlanType, 
  Rams as RamsType, TbtSession, TrainingCourse, TrainingRecord, TrainingSession, 
  Project, View, Ptw, Action, Resource, Sign, ChecklistTemplate, ActionItem, Notification, CapaAction
} from './types';
import { useToast } from './components/ui/Toast';

// --- FIREBASE IMPORTS ---
import { db } from './firebase';
import { collection, getDocs, doc, setDoc, updateDoc, addDoc } from 'firebase/firestore';
import { useAuth } from './contexts/AuthContext';

// --- APP CONTEXT ---
type InvitedUser = { name: string; email: string; role: User['role']; org_id: string };

interface AppContextType {
  currentView: View;
  setCurrentView: React.Dispatch<React.SetStateAction<View>>;
  activeOrg: Organization;
  setActiveOrg: React.Dispatch<React.SetStateAction<Organization>>;
  isSidebarOpen: boolean;
  setSidebarOpen: React.Dispatch<React.SetStateAction<boolean>>;
  usersList: User[];
  setUsersList: React.Dispatch<React.SetStateAction<User[]>>;
  activeUser: User | null;
  handleUpdateUser: (updatedUser: User) => void;
  organizations: Organization[];
  handleCreateOrganization: (data: any) => void;
  invitedEmails: InvitedUser[];
  handleInviteUser: (userData: any) => void;
  handleSignUp: (email: string) => void;
  handleApproveUser: (userId: string) => void;
  language: string;
  dir: 'ltr' | 'rtl';
  t: (key: string, fallback?: string) => string;
  login: (userId: string) => void;
  logout: () => void;
  can: (action: Action, resource: Resource) => boolean;
  impersonatingAdmin: User | null;
  impersonateUser: (userId: string) => void;
  stopImpersonating: () => void;
  theme: 'light' | 'dark';
  toggleTheme: () => void;
}

const AppContext = createContext<AppContextType>(null!);

export const AppProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  // FIX: Load saved view from localStorage to persist navigation on refresh
  const [currentView, setCurrentView] = useState<View>(() => {
    return (localStorage.getItem('currentView') as View) || 'dashboard';
  });

  // Save view whenever it changes
  useEffect(() => {
    localStorage.setItem('currentView', currentView);
  }, [currentView]);
  
  // Initialize with static data to prevent empty states before Firebase loads
  const [organizations, setOrganizations] = useState<Organization[]>(initialOrganizations || []);
  const [activeOrg, setActiveOrg] = useState<Organization>(organizations[0] || initialOrganizations[0]);
  
  const [isSidebarOpen, setSidebarOpen] = useState(true);
  const [usersList, setUsersList] = useState<User[]>(initialUsers || []);
  const [activeUserId, setActiveUserId] = useState<string | null>(() => localStorage.getItem('activeUserId'));
  const [impersonatingAdmin, setImpersonatingAdmin] = useState<User | null>(null);
  const [invitedEmails, setInvitedEmails] = useState<InvitedUser[]>([]);
  const [theme, setTheme] = useState<'light' | 'dark'>('dark');

  const toast = useToast();

  useEffect(() => {
      const root = window.document.documentElement;
      root.classList.remove('light', 'dark');
      root.classList.add(theme);
  }, [theme]);

  const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');

  // --- CRITICAL FIX: Fallback to initialUsers if usersList (from Firebase) hasn't loaded yet ---
  const activeUser = useMemo(() => {
    if (!activeUserId) return null;
    
    // 1. Try to find in current state (Firebase data)
    const foundInState = usersList.find(u => u.id === activeUserId);
    if (foundInState) return foundInState;

    // 2. Fallback to static data (prevents "missing buttons" on refresh)
    const foundInStatic = initialUsers.find(u => u.id === activeUserId);
    if (foundInStatic) return foundInStatic;

    return null;
  }, [activeUserId, usersList]);

  const login = (userId: string) => {
    // Check both lists to ensure valid login even if offline
    const user = usersList.find(u => u.id === userId) || initialUsers.find(u => u.id === userId);
    
    if (user) {
        localStorage.setItem('activeUserId', userId);
        setActiveUserId(userId);
        
        // Only set view if not already set (respects the localStorage load)
        if (!localStorage.getItem('currentView')) {
            const defaultView = user.preferences?.default_view || 'dashboard';
            setCurrentView(defaultView);
        }
        
        // Ensure Org is set
        const userOrg = organizations.find(o => o.id === user.org_id) || initialOrganizations.find(o => o.id === user.org_id);
        if(userOrg) setActiveOrg(userOrg);
    }
  };
  
  const logout = () => {
    localStorage.removeItem('activeUserId');
    setActiveUserId(null);
    setImpersonatingAdmin(null);
  };

  const impersonateUser = (userId: string) => {
    if (activeUser) {
      setImpersonatingAdmin(activeUser);
      login(userId);
    }
  };

  const stopImpersonating = () => {
    if (impersonatingAdmin) {
      login(impersonatingAdmin.id);
      setImpersonatingAdmin(null);
    }
  };

  const can = (action: Action, resource: Resource): boolean => {
    if (!activeUser) return false;
    
    // Find role definition
    const userRole = roles.find(r => r.key === activeUser.role);
    if (!userRole) return false; // Fail safe

    // Check specific resource permission
    const permission = userRole.permissions.find(p => p.resource === resource);
    return permission ? permission.actions.includes(action) : false;
  };

  const language = activeUser?.preferences?.language || 'en';
  const dir = useMemo(() => supportedLanguages.find(l => l.code === language)?.dir || 'ltr', [language]);

  const handleUpdateUser = (updatedUser: User) => setUsersList(prev => prev.map(u => u.id === updatedUser.id ? updatedUser : u));
  const handleCreateOrganization = (data: any) => setOrganizations(prev => [...prev, { ...data, id: `org_${Date.now()}`, status: 'active' }]);
  const handleInviteUser = (userData: any) => { setInvitedEmails(prev => [...prev, userData]); toast.success("Invited"); };
  const handleSignUp = () => {};
  const handleApproveUser = (id: string) => setUsersList(prev => prev.map(u => u.id === id ? { ...u, status: 'active' } : u));
  const t = (key: string, fallback: string = key) => translations[language]?.[key] || translations['en']?.[key] || fallback;

  const value = {
    currentView, setCurrentView, activeOrg, setActiveOrg, isSidebarOpen, setSidebarOpen,
    usersList, setUsersList, activeUser, handleUpdateUser, organizations, handleCreateOrganization,
    invitedEmails, handleInviteUser, handleSignUp, handleApproveUser, language, dir, t,
    login, logout, can, impersonatingAdmin, impersonateUser, stopImpersonating, theme, toggleTheme
  };

  return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
};

export const useAppContext = () => useContext(AppContext);

// --- DATA CONTEXT ---
interface DataContextType {
  isLoading: boolean;
  projects: Project[];
  reportList: Report[];
  inspectionList: Inspection[];
  checklistRunList: ChecklistRun[];
  planList: PlanType[];
  ramsList: RamsType[];
  tbtList: TbtSession[];
  trainingCourseList: TrainingCourse[];
  trainingRecordList: TrainingRecord[];
  trainingSessionList: TrainingSession[];
  notifications: Notification[];
  signs: Sign[];
  checklistTemplates: ChecklistTemplate[];
  ptwList: Ptw[];
  actionItems: ActionItem[];
  
  setInspectionList: React.Dispatch<React.SetStateAction<Inspection[]>>;
  setChecklistRunList: React.Dispatch<React.SetStateAction<ChecklistRun[]>>;
  setPtwList: React.Dispatch<React.SetStateAction<Ptw[]>>;
  
  handleCreateProject: (data: any) => void;
  handleCreateReport: (data: any) => void;
  handleStatusChange: (id: string, status: any) => void;
  handleCapaActionChange: (id: string, index: number, status: any) => void;
  handleAcknowledgeReport: (id: string) => void;
  handleUpdateInspection: (data: any, action?: any) => void;
  handleCreatePtw: (data: any) => void;
  handleUpdatePtw: (data: any, action?: any) => void;
  handleCreatePlan: (data: any) => void;
  handleUpdatePlan: (data: any) => void;
  handlePlanStatusChange: (id: string, status: any) => void;
  handleCreateRams: (data: any) => void;
  handleUpdateRams: (data: any) => void;
  handleRamsStatusChange: (id: string, status: any) => void;
  handleCreateTbt: (data: any) => void;
  handleUpdateTbt: (data: any) => void;
  handleCreateOrUpdateCourse: (data: any) => void;
  handleScheduleSession: (data: any) => void;
  handleCloseSession: (id: string, attendance: any) => void;
  handleUpdateActionStatus: (origin: any, status: any) => void;
  handleCreateInspection: (data: any) => void;
  handleCreateStandaloneAction: (data: any) => void;
  handleCreateChecklistTemplate: (data: any) => void;
}

const DataContext = createContext<DataContextType>(null!);

export const DataProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const { activeOrg, activeUser, setUsersList } = useAppContext();
    const { currentUser } = useAuth();
    const toast = useToast();
    
    const [isLoading, setIsLoading] = useState(true);
    
    // Initialize with static data to ensure UI paints immediately
    const [projects, setProjects] = useState<Project[]>(initialProjects || []);
    const [reportList, setReportList] = useState<Report[]>([]); // Reports typically fetched fresh
    const [inspectionList, setInspectionList] = useState<Inspection[]>([]);
    const [checklistRunList, setChecklistRunList] = useState<ChecklistRun[]>([]);
    const [planList, setPlanList] = useState<PlanType[]>(initialPlans || []);
    const [ramsList, setRamsList] = useState<RamsType[]>(initialRams || []);
    const [tbtList, setTbtList] = useState<TbtSession[]>([]);
    const [trainingCourseList, setTrainingCourseList] = useState<TrainingCourse[]>([]);
    const [trainingRecordList, setTrainingRecordList] = useState<TrainingRecord[]>([]);
    const [trainingSessionList, setTrainingSessionList] = useState<TrainingSession[]>([]);
    const [notifications, setNotifications] = useState<Notification[]>([]);
    const [ptwList, setPtwList] = useState<Ptw[]>([]);
    const [signs, setSigns] = useState<Sign[]>(initialSigns || []);
    const [checklistTemplates, setChecklistTemplates] = useState<ChecklistTemplate[]>(initialTemplates || []);
    const [standaloneActions, setStandaloneActions] = useState<ActionItem[]>([]);

    useEffect(() => {
      // If no user, stop loading immediately
      if (!currentUser) {
          setIsLoading(false);
          return;
      }

      const fetchData = async () => {
        try {
          // Helper to fetch and MERGE with existing data if needed
          const fetchCol = async (name: string, setter: any, initialData: any[] = []) => {
            const snap = await getDocs(collection(db, name));
            const data = snap.docs.map(d => d.data());
            if (data.length > 0) {
                 setter(data);
            } else {
                 // If Firebase is empty, keep initial data
                 setter(initialData); 
            }
          };

          await Promise.all([
            fetchCol('users', setUsersList, initialUsers),
            fetchCol('projects', setProjects, initialProjects),
            fetchCol('reports', setReportList),
            fetchCol('inspections', setInspectionList),
            fetchCol('ptws', setPtwList),
            fetchCol('checklist_templates', setChecklistTemplates, initialTemplates),
            fetchCol('checklist_runs', setChecklistRunList),
            fetchCol('plans', setPlanList, initialPlans),
            fetchCol('rams', setRamsList, initialRams),
            fetchCol('signs', setSigns, initialSigns),
            fetchCol('actions', setStandaloneActions),
            fetchCol('tbt_sessions', setTbtList),
            fetchCol('training_courses', setTrainingCourseList),
            fetchCol('training_records', setTrainingRecordList),
            fetchCol('training_sessions', setTrainingSessionList),
            fetchCol('notifications', setNotifications),
          ]);
        } catch (e) {
          console.error("Error fetching data:", e);
        } finally {
          setIsLoading(false);
        }
      };

      fetchData();
    }, [currentUser, setUsersList]);

    const updateDB = async (collectionName: string, id: string, data: any) => {
        try {
            await updateDoc(doc(db, collectionName, id), data);
        } catch (e) {
            console.error(`Error updating ${collectionName}:`, e);
        }
    };

    const handleCreateReport = async (reportData: any) => {
        const newReport = {
            ...reportData,
            id: `rep_${Date.now()}`,
            org_id: activeOrg.id,
            reporter_id: activeUser?.id || 'unknown',
            status: 'submitted',
            audit_trail: [{ user_id: activeUser?.id || 'system', timestamp: new Date().toISOString(), action: 'Report Created' }],
            capa: [],
            acknowledgements: []
        };
        setReportList(prev => [newReport, ...prev]);
        try { await setDoc(doc(db, 'reports', newReport.id), newReport); toast.success("Report saved."); } catch (e) { console.error(e); }
    };

    const handleCreateInspection = async (data: any) => {
        const newInspection = {
            ...data,
            id: `insp_${Date.now()}`,
            org_id: activeOrg.id,
            findings: [],
            status: data.status || 'Ongoing',
            audit_trail: [{ user_id: activeUser?.id || 'system', timestamp: new Date().toISOString(), action: 'Inspection Created' }]
        };
        setInspectionList(prev => [newInspection, ...prev]);
        try { await setDoc(doc(db, 'inspections', newInspection.id), newInspection); toast.success("Inspection created."); } catch (e) { console.error(e); }
    };

    const handleCreateStandaloneAction = async (data: any) => {
        const newAction = {
            id: `act_${Date.now()}`,
            action: data.action,
            owner_id: data.owner_id,
            due_date: data.due_date,
            status: 'Open',
            priority: data.priority,
            project_id: data.project_id,
            source: { type: 'Standalone', id: '-', description: 'Direct Entry' },
            origin: { type: 'standalone', parentId: '', itemId: '' }
        };
        setStandaloneActions(prev => [newAction as any, ...prev]);
        try { await setDoc(doc(db, 'actions', newAction.id), newAction); toast.success("Action created."); } catch (e) { console.error(e); }
    };
    
    // --- FIX: Use addDoc for Projects to avoid collision ---
    const handleCreateProject = async (data: any) => {
        try {
            const projectData = {
                ...data,
                org_id: activeOrg.id,
                status: 'active',
                created_at: new Date().toISOString()
            };
            
            // Use addDoc to let Firestore auto-generate ID
            const docRef = await addDoc(collection(db, 'projects'), projectData);
            
            const newProj = { id: docRef.id, ...projectData };
            setProjects(prev => [newProj, ...prev]);
            toast.success("Project created.");
        } catch (e) { 
            console.error(e);
            toast.error("Failed to create project");
        }
    };

    const handleCreatePtw = async (data: any) => {
        const newPtw = { ...data, id: `ptw_${Date.now()}`, status: 'DRAFT' };
        setPtwList(prev => [newPtw, ...prev]);
        try { await setDoc(doc(db, 'ptws', newPtw.id), newPtw); toast.success("Permit created."); } catch (e) { console.error(e); }
    };

    const handleCreateChecklistTemplate = async (data: any) => {
        const newTemplate = { ...data, id: `ct_${Date.now()}`, org_id: activeOrg.id };
        setChecklistTemplates(prev => [...prev, newTemplate]);
        try { await setDoc(doc(db, 'checklist_templates', newTemplate.id), newTemplate); toast.success("Template created."); } catch (e) { console.error(e); }
    };

    const handleStatusChange = (id: string, status: any) => {
        setReportList(prev => prev.map(r => r.id === id ? { ...r, status } : r));
        updateDB('reports', id, { status });
    };

    const handleCapaActionChange = (reportId: string, capaIndex: number, newStatus: CapaAction['status']) => {
        const report = reportList.find(r => r.id === reportId);
        if (report) {
            const newCapa = [...report.capa];
            if (newCapa[capaIndex]) {
                newCapa[capaIndex] = { ...newCapa[capaIndex], status: newStatus };
                setReportList(prev => prev.map(r => r.id === reportId ? { ...r, capa: newCapa } : r));
                updateDB('reports', reportId, { capa: newCapa });
            }
        }
    };

    const handleUpdateActionStatus = (origin: any, newStatus: any) => {
        if (origin.type === 'report-capa') {
            handleCapaActionChange(origin.parentId, parseInt(origin.itemId), newStatus);
        } else if (origin.type === 'standalone') {
             setStandaloneActions(prev => prev.map(a => a.id === origin.parentId ? { ...a, status: newStatus } : a));
             updateDB('actions', origin.parentId, { status: newStatus });
        }
    };

    const handleUpdateInspection = (inspection: any, action?: any) => {
        let updatedInspection = { ...inspection };
        if (action === 'submit') updatedInspection.status = 'Submitted';
        if (action === 'approve') updatedInspection.status = 'Approved';
        if (action === 'close') updatedInspection.status = 'Closed';
        if (action === 'request_revision') updatedInspection.status = 'Ongoing';

        setInspectionList(prev => prev.map(x => x.id === inspection.id ? updatedInspection : x));
        updateDB('inspections', inspection.id, updatedInspection);
        toast.success("Inspection updated.");
    };

    const handleUpdatePtw = (ptw: any, action?: any) => {
        let updatedPtw = { ...ptw };
        if (action === 'submit') updatedPtw.status = 'SUBMITTED';
        if (action === 'approve_proponent') updatedPtw.status = 'APPROVAL';
        if (action === 'approve_hse') updatedPtw.status = 'ACTIVE';
        if (action === 'reject') updatedPtw.status = 'DRAFT';
        if (action === 'suspend') updatedPtw.status = 'HOLD';
        if (action === 'resume') updatedPtw.status = 'ACTIVE';
        if (action === 'close') updatedPtw.status = 'CLOSED';

        setPtwList(prev => prev.map(p => p.id === ptw.id ? updatedPtw : p));
        updateDB('ptws', ptw.id, updatedPtw);
        toast.success("Permit updated.");
    };

    const handleUpdatePlan = (plan: any) => {
        setPlanList(prev => prev.map(p => p.id === plan.id ? plan : p));
        updateDB('plans', plan.id, plan);
        toast.success("Plan saved.");
    };

    const handlePlanStatusChange = (id: string, status: any) => {
        setPlanList(prev => prev.map(p => p.id === id ? { ...p, status } : p));
        updateDB('plans', id, { status });
    };

    const handleUpdateRams = (rams: any) => {
        setRamsList(prev => prev.map(r => r.id === rams.id ? rams : r));
        updateDB('rams', rams.id, rams);
        toast.success("RAMS saved.");
    };

    const handleRamsStatusChange = (id: string, status: any) => {
        setRamsList(prev => prev.map(r => r.id === id ? { ...r, status } : r));
        updateDB('rams', id, { status });
    };

    const handleUpdateTbt = (tbt: any) => {
        setTbtList(prev => prev.map(t => t.id === tbt.id ? tbt : t));
        updateDB('tbt_sessions', tbt.id, tbt);
        toast.success("TBT updated.");
    };

    const handleAcknowledgeReport = (id: string) => {
        const report = reportList.find(r => r.id === id);
        if (report) {
            const newAcks = [...report.acknowledgements, { user_id: activeUser?.id || '', acknowledged_at: new Date().toISOString() }];
            setReportList(prev => prev.map(r => r.id === id ? { ...r, acknowledgements: newAcks } : r));
            updateDB('reports', id, { acknowledgements: newAcks });
        }
    };

    const handleCreateOrUpdateCourse = (c: any) => setTrainingCourseList(prev => [...prev.filter(x => x.id !== c.id), c]);
    const handleScheduleSession = (d: any) => setTrainingSessionList(prev => [{ ...d, id: `ts_${Date.now()}`, roster: [] } as any, ...prev]);
    const handleCloseSession = (id: string, att: any) => setTrainingSessionList(prev => prev.map(s => s.id === id ? { ...s, status: 'completed', attendance: att } : s));

    // --- FIXED: Correct mapping of sections for Plans ---
    const handleCreatePlan = (d: any) => {
        const newPlan: any = {
            id: `plan_${Date.now()}`,
            org_id: activeOrg.id,
            project_id: d.project_id,
            type: d.type,
            title: d.title,
            version: 'v1.0',
            status: 'draft',
            people: {
                prepared_by: {
                    name: activeUser?.name || 'Unknown',
                    email: activeUser?.email || '',
                    signed_at: new Date().toISOString()
                }
            },
            dates: {
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                next_review_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            },
            content: {
                body_json: d.sections || [], 
                attachments: []
            },
            meta: { tags: [], change_note: 'Initial creation' },
            audit_trail: []
        };
        
        setPlanList(prev => [newPlan, ...prev]);
        try {
            setDoc(doc(db, 'plans', newPlan.id), newPlan);
            toast.success("Plan created successfully.");
        } catch(e) { console.error(e); }
    };

    // --- FIXED: Correct mapping of AI Content for RAMS ---
    const handleCreateRams = (d: any) => {
        const newRams: any = {
            id: `rams_${Date.now()}`,
            org_id: activeOrg.id,
            project_id: d.project_id,
            activity: d.activity,
            location: d.location,
            status: 'draft',
            version: 'v1.0',
            prepared_by: {
                name: activeUser?.name || 'Unknown',
                email: activeUser?.email || '',
                role: activeUser?.role || 'User',
                signed_at: new Date().toISOString()
            },
            times: {
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                valid_from: new Date().toISOString(),
                valid_until: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
            },
            method_statement: d.aiContent ? {
                overview: d.aiContent.overview || '',
                competence: d.aiContent.competence || '',
                sequence_of_operations: d.aiContent.sequence_of_operations || [],
                emergency_arrangements: d.aiContent.emergency_arrangements || ''
            } : { overview: '', competence: '', sequence_of_operations: [], emergency_arrangements: '' },
            overall_risk_before: 0,
            overall_risk_after: 0,
            attachments: [],
            linked_ptw_types: [],
            audit_log: []
        };

        setRamsList(prev => [newRams, ...prev]);
        try {
            setDoc(doc(db, 'rams', newRams.id), newRams);
            toast.success("RAMS created successfully.");
        } catch(e) { console.error(e); }
    };

    const handleCreateTbt = (d: any) => setTbtList(prev => [{ ...d, id: `tbt_${Date.now()}`, attendees: [] } as any, ...prev]);

    const actionItems = useMemo<ActionItem[]>(() => {
        const items: ActionItem[] = [];
        (reportList || []).forEach(report => {
            if (report.capa) {
                report.capa.forEach((action, index) => {
                    items.push({
                        id: `report-${report.id}-capa-${index}`,
                        action: action.action,
                        owner_id: action.owner_id,
                        due_date: action.due_date,
                        status: action.status,
                        project_id: report.project_id,
                        source: { type: 'Report', id: report.id, description: report.description },
                        origin: { type: 'report-capa', parentId: report.id, itemId: index.toString() }
                    });
                });
            }
        });
        return [...items, ...standaloneActions];
    }, [reportList, standaloneActions]);

    const value = {
        isLoading,
        projects, reportList, inspectionList, checklistRunList, planList, ramsList, tbtList, 
        trainingCourseList, trainingRecordList, trainingSessionList, notifications, signs, checklistTemplates, ptwList,
        actionItems,
        setInspectionList, setChecklistRunList, setPtwList,
        handleCreateProject, handleCreateReport, handleStatusChange, handleCapaActionChange, handleAcknowledgeReport,
        handleUpdateInspection, handleCreatePtw, handleUpdatePtw, handleCreatePlan, handleUpdatePlan, handlePlanStatusChange,
        handleCreateRams, handleUpdateRams, handleRamsStatusChange, handleCreateTbt, handleUpdateTbt,
        handleCreateOrUpdateCourse, handleScheduleSession, handleCloseSession,
        handleUpdateActionStatus, handleCreateInspection, handleCreateStandaloneAction,
        handleCreateChecklistTemplate
    };

    return <DataContext.Provider value={value}>{children}</DataContext.Provider>;
};

export const useDataContext = () => useContext(DataContext);

// --- MODAL CONTEXT ---
interface ModalContextType {
  selectedReport: any; setSelectedReport: any;
  isReportCreationModalOpen: any; setIsReportCreationModalOpen: any;
  reportInitialData: any; setReportInitialData: any;
  isActionCreationModalOpen: any; setIsActionCreationModalOpen: any;
  openActionCreationModal: any; openActionDetailModal: any;
  selectedPtw: any; setSelectedPtw: any;
  isPtwCreationModalOpen: any; setIsPtwCreationModalOpen: any;
  ptwCreationMode: any; setPtwCreationMode: any;
  selectedPlan: any; setSelectedPlan: any;
  selectedPlanForEdit: any; setSelectedPlanForEdit: any;
  isPlanCreationModalOpen: any; setIsPlanCreationModalOpen: any;
  selectedRams: any; setSelectedRams: any;
  selectedRamsForEdit: any; setSelectedRamsForEdit: any;
  isRamsCreationModalOpen: any; setIsRamsCreationModalOpen: any;
  selectedTbt: any; setSelectedTbt: any;
  isTbtCreationModalOpen: any; setIsTbtCreationModalOpen: any;
  isCourseModalOpen: any; setCourseModalOpen: any;
  isSessionModalOpen: any; setSessionModalOpen: any;
  isAttendanceModalOpen: any; setAttendanceModalOpen: any;
  courseForSession: any; setCourseForSession: any;
  sessionForAttendance: any; setSessionForAttendance: any;
  isInspectionCreationModalOpen: any; setIsInspectionCreationModalOpen: any;
}

const ModalContext = createContext<ModalContextType>(null!);

export const ModalProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [selectedReport, setSelectedReport] = useState(null);
  const [isReportCreationModalOpen, setIsReportCreationModalOpen] = useState(false);
  const [reportInitialData, setReportInitialData] = useState(null);
  const [isActionCreationModalOpen, setIsActionCreationModalOpen] = useState(false);
  const [selectedPtw, setSelectedPtw] = useState(null);
  const [isPtwCreationModalOpen, setIsPtwCreationModalOpen] = useState(false);
  const [ptwCreationMode, setPtwCreationMode] = useState('new');
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [selectedPlanForEdit, setSelectedPlanForEdit] = useState(null);
  const [isPlanCreationModalOpen, setIsPlanCreationModalOpen] = useState(false);
  const [selectedRams, setSelectedRams] = useState(null);
  const [selectedRamsForEdit, setSelectedRamsForEdit] = useState(null);
  const [isRamsCreationModalOpen, setIsRamsCreationModalOpen] = useState(false);
  const [selectedTbt, setSelectedTbt] = useState(null);
  const [isTbtCreationModalOpen, setIsTbtCreationModalOpen] = useState(false);
  const [isCourseModalOpen, setCourseModalOpen] = useState(false);
  const [isSessionModalOpen, setSessionModalOpen] = useState(false);
  const [isAttendanceModalOpen, setAttendanceModalOpen] = useState(false);
  const [courseForSession, setCourseForSession] = useState(null);
  const [sessionForAttendance, setSessionForAttendance] = useState(null);
  const [isInspectionCreationModalOpen, setIsInspectionCreationModalOpen] = useState(false);

  const openActionCreationModal = () => setIsActionCreationModalOpen(true);
  const openActionDetailModal = () => {};

  const value = {
    selectedReport, setSelectedReport, isReportCreationModalOpen, setIsReportCreationModalOpen, reportInitialData, setReportInitialData,
    isActionCreationModalOpen, setIsActionCreationModalOpen, openActionCreationModal, openActionDetailModal,
    selectedPtw, setSelectedPtw, isPtwCreationModalOpen, setIsPtwCreationModalOpen, ptwCreationMode, setPtwCreationMode,
    selectedPlan, setSelectedPlan, selectedPlanForEdit, setSelectedPlanForEdit, isPlanCreationModalOpen, setIsPlanCreationModalOpen,
    selectedRams, setSelectedRams, selectedRamsForEdit, setSelectedRamsForEdit, isRamsCreationModalOpen, setIsRamsCreationModalOpen,
    selectedTbt, setSelectedTbt, isTbtCreationModalOpen, setIsTbtCreationModalOpen,
    isCourseModalOpen, setCourseModalOpen, isSessionModalOpen, setSessionModalOpen, isAttendanceModalOpen, setAttendanceModalOpen,
    courseForSession, setCourseForSession, sessionForAttendance, setSessionForAttendance, isInspectionCreationModalOpen, setIsInspectionCreationModalOpen
  };

  return <ModalContext.Provider value={value}>{children}</ModalContext.Provider>;
};

export const useModalContext = () => useContext(ModalContext);

==================================================
FILE: .\src\data.ts
==================================================

import type { Organization, User, Project, Report, Inspection, ChecklistTemplate, ChecklistRun, Plan, Rams, Sign, TbtSession, TrainingCourse, TrainingRecord, TrainingSession, Notification, Ptw, CertificationProfile } from './types';
import { logoSrc } from './config';

// --- ORGANIZATIONS ---
export const organizations: Organization[] = [
  {
    id: 'org_1',
    name: 'Clint Operations',
    slug: 'clint-ops',
    domain: 'clint.com',
    status: 'active',
    timezone: 'GMT+3',
    primaryLanguage: 'en',
    secondaryLanguages: ['ar', 'ur'],
    branding: { logoUrl: logoSrc, primaryColor: '#00A86B' },
    industry: 'Construction',
    country: 'AE',
  }
];

// --- USERS ---
export const users: User[] = [
  {
    id: 'user_kamran',
    org_id: 'org_1',
    email: 'thekamransworld@gmail.com',
    name: 'Kamran (Super Admin)',
    avatar_url: 'https://ui-avatars.com/api/?name=Kamran&background=0D8ABC&color=fff',
    role: 'ADMIN',
    status: 'active',
    preferences: { language: 'en', default_view: 'dashboard', units: { temperature: 'C', wind_speed: 'km/h', height: 'm', weight: 'kg' } }
  },
  {
    id: 'user_alex',
    org_id: 'org_1',
    email: 'alex@clint.com',
    name: 'Alex Johnson',
    avatar_url: 'https://ui-avatars.com/api/?name=Alex&background=random',
    role: 'HSE_MANAGER',
    status: 'active',
    preferences: { language: 'en', default_view: 'dashboard', units: { temperature: 'C', wind_speed: 'km/h', height: 'm', weight: 'kg' } }
  }
];

// --- PROJECTS ---
export const projects: Project[] = [
  {
    id: 'proj_1',
    org_id: 'org_1',
    name: 'Downtown Construction',
    code: 'DTC-001',
    status: 'active',
    location: 'City Center',
    start_date: '2023-01-01',
    finish_date: '2025-12-31',
    manager_id: 'user_kamran',
    type: 'Construction',
  },
  {
    id: 'proj_2',
    org_id: 'org_1',
    name: 'Refinery Maintenance',
    code: 'REF-002',
    status: 'active',
    location: 'Industrial Zone',
    start_date: '2024-02-01',
    finish_date: '2024-11-30',
    manager_id: 'user_alex',
    type: 'Maintenance',
  }
];

// --- 50 HSE CHECKLIST TEMPLATES ---
const createChecklist = (id: string, cat: string, title: string, items: string[]) => ({
    id, org_id: 'org_1', category: cat, title: { en: title },
    items: items.map((text, i) => ({ id: `${id}_${i}`, text: { en: text }, description: { en: 'Verify compliance' } }))
});

export const checklistTemplates: ChecklistTemplate[] = [
    // General Safety
    createChecklist('cl_1', 'General', 'Daily Site Safety Inspection', ['PPE compliance', 'Housekeeping', 'Access/Egress clear', 'Signage in place']),
    createChecklist('cl_2', 'General', 'Weekly HSE Walkdown', ['Scaffolding tags', 'Electrical panels locked', 'Fire extinguishers checked', 'Welfare facilities clean']),
    createChecklist('cl_3', 'General', 'PPE Compliance Check', ['Helmets', 'Safety Shoes', 'High-Vis Vests', 'Eye Protection', 'Gloves']),
    createChecklist('cl_4', 'General', 'Site Perimeter & Security', ['Fencing intact', 'Gates secured', 'Security guard present', 'Lighting functional']),
    createChecklist('cl_5', 'General', 'Welfare Facilities', ['Drinking water available', 'Toilets clean', 'Rest area shaded', 'Hand wash available']),
    
    // Work at Height
    createChecklist('cl_6', 'Work at Height', 'Scaffolding Inspection (Weekly)', ['Base plates secure', 'Bracing complete', 'Guardrails installed', 'Tag (Green/Red) updated']),
    createChecklist('cl_7', 'Work at Height', 'Ladder Safety', ['Rungs in good condition', 'Secured at top/bottom', 'Correct angle (1:4)', 'Non-conductive if near electrical']),
    createChecklist('cl_8', 'Work at Height', 'Mobile Elevating Work Platform (MEWP)', ['Operator certified', 'Outriggers deployed', 'Emergency controls functional', 'Harness worn']),
    createChecklist('cl_9', 'Work at Height', 'Safety Harness & Lanyard', ['Webbing intact', 'Buckles functional', 'Shock absorber undeployed', 'Inspection tag valid']),
    createChecklist('cl_10', 'Work at Height', 'Roof Work', ['Edge protection', 'Fragile roof signs', 'Crawling boards used', 'Weather conditions suitable']),

    // Electrical
    createChecklist('cl_11', 'Electrical', 'Portable Power Tools', ['Cables undamaged', 'Guards in place', 'PAT test valid', 'Dead man switch functional']),
    createChecklist('cl_12', 'Electrical', 'Temporary Electrical Supply', ['DBs locked', 'ELCB/RCD tested', 'Cables elevated/buried', 'Warning signs posted']),
    createChecklist('cl_13', 'Electrical', 'Lock Out Tag Out (LOTO)', ['Isolation verified', 'Locks applied', 'Tags completed', 'Keys secured']),
    createChecklist('cl_14', 'Electrical', 'Generator Inspection', ['Earthing connected', 'Drip tray present', 'Fire extinguisher nearby', 'No leaks']),
    createChecklist('cl_15', 'Electrical', 'Cable Management', ['No trip hazards', 'Cables hung on hooks', 'Joints proper (no tape)', 'Protected from damage']),

    // Lifting & Rigging
    createChecklist('cl_16', 'Lifting', 'Mobile Crane Pre-Use', ['Operator license valid', 'Load chart available', 'Outriggers fully extended', 'Ground conditions stable']),
    createChecklist('cl_17', 'Lifting', 'Lifting Gear (Slings/Shackles)', ['SWL marked', 'Color code current', 'No cuts/frays', 'Safety latches on hooks']),
    createChecklist('cl_18', 'Lifting', 'Tower Crane Weekly', ['Limit switches tested', 'Brakes functional', 'Structure bolts tight', 'Wind speed monitor working']),
    createChecklist('cl_19', 'Lifting', 'Forklift Inspection', ['Horn/Reverse alarm', 'Forks condition', 'Hydraulics (no leaks)', 'Seatbelt functional']),
    createChecklist('cl_20', 'Lifting', 'Rigging Plan Verification', ['Load weight confirmed', 'Radius measured', 'Ground bearing pressure checked', 'Wind speed within limits']),

    // Fire Safety
    createChecklist('cl_21', 'Fire', 'Fire Extinguisher Monthly', ['Pressure gauge in green', 'Pin & seal intact', 'Hose clear', 'Inspection tag updated']),
    createChecklist('cl_22', 'Fire', 'Hot Work Area', ['Combustibles removed (10m)', 'Fire watcher present', 'Extinguisher available', 'Gas test done']),
    createChecklist('cl_23', 'Fire', 'Emergency Evacuation Route', ['Routes clear', 'Exit signs visible', 'Emergency lighting functional', 'Assembly point marked']),
    createChecklist('cl_24', 'Fire', 'Flammable Storage', ['Ventilation adequate', 'Bunded area', 'MSDS available', 'No smoking signs']),
    createChecklist('cl_25', 'Fire', 'Fire Alarm System', ['Panel normal', 'Call points accessible', 'Sounders audible', 'Weekly test log']),

    // Excavation
    createChecklist('cl_26', 'Excavation', 'Excavation Daily', ['Shoring/Benching intact', 'Access/Egress (ladder)', 'Spoil pile 1m back', 'Barriers & signage']),
    createChecklist('cl_27', 'Excavation', 'Underground Utilities', ['Scanning done', 'Services marked', 'Hand digging near cables', 'Permit active']),
    createChecklist('cl_28', 'Excavation', 'Dewatering', ['Pumps functional', 'Discharge hose secured', 'Sediment tank used', 'No oil leaks']),

    // Confined Space
    createChecklist('cl_29', 'Confined Space', 'Pre-Entry Check', ['Gas test (O2, LEL, H2S, CO)', 'Ventilation running', 'Attendant at entry', 'Rescue tripod ready']),
    createChecklist('cl_30', 'Confined Space', 'BA Set Inspection', ['Cylinder pressure', 'Mask seal', 'Straps condition', 'Whistle test']),

    // Plant & Machinery
    createChecklist('cl_31', 'Machinery', 'Heavy Equipment Daily', ['Brakes/Steering', 'Reverse alarm/Camera', 'Lights/Mirrors', 'No fluid leaks']),
    createChecklist('cl_32', 'Machinery', 'Vehicle Marshalling', ['Banksman present', 'Hi-vis clothing', 'Communication clear', 'Pedestrian segregation']),
    createChecklist('cl_33', 'Machinery', 'Concrete Mixer/Pump', ['Pipe connections secure', 'Whip checks fitted', 'Washout area used', 'Operator PPE']),

    // Environmental
    createChecklist('cl_34', 'Environment', 'Waste Management', ['Bins segregated (Gen/Haz)', 'No overflowing', 'Skip covered', 'Collection schedule']),
    createChecklist('cl_35', 'Environment', 'Spill Control', ['Spill kits available', 'Drip trays under plant', 'Chemicals stored correctly', 'Soil contamination check']),
    createChecklist('cl_36', 'Environment', 'Dust & Noise', ['Water spraying used', 'Equipment covers closed', 'Ear protection zones', 'Work hours respected']),

    // Health & Hygiene
    createChecklist('cl_37', 'Health', 'First Aid Box', ['Contents complete', 'Nothing expired', 'Box clean/marked', 'Eyewash station check']),
    createChecklist('cl_38', 'Health', 'Heat Stress Management', ['Rest areas shaded', 'Cool water available', 'Flag system active', 'Rehydration salts']),
    createChecklist('cl_39', 'Health', 'Canteen/Dining', ['Cleanliness', 'Hand wash soap', 'Pest control', 'Food storage']),
    createChecklist('cl_40', 'Health', 'Camp Inspection', ['Room density', 'Fire safety', 'Kitchen hygiene', 'Toilet facilities']),

    // Specialized
    createChecklist('cl_41', 'Special', 'Night Work', ['Lighting adequate', 'Hi-vis reflective', 'Lone worker check', 'Emergency comms']),
    createChecklist('cl_42', 'Special', 'Road Works', ['Traffic cones/barriers', 'Flagman present', 'Diversion signs', 'Safety buffer zone']),
    createChecklist('cl_43', 'Special', 'Demolition', ['Services disconnected', 'Exclusion zone', 'Dust suppression', 'Falling debris protection']),
    createChecklist('cl_44', 'Special', 'Piling Operations', ['Auger guarded', 'Platform stable', 'Concrete delivery safe', 'Noise control']),
    createChecklist('cl_45', 'Special', 'Steel Erection', ['Fall arrest nets', 'Wind speed check', 'Bolt tightening', 'Crane coordination']),
    createChecklist('cl_46', 'Special', 'Painting/Coating', ['Ventilation (if indoor)', 'Respirators worn', 'Flammables storage', 'Spill protection']),
    createChecklist('cl_47', 'Special', 'Manual Handling', ['Load weight assessed', 'Team lifting used', 'Mechanical aids available', 'Gloves worn']),
    createChecklist('cl_48', 'Special', 'Office Safety', ['Cables tidied', 'Ergonomics', 'Fire exits clear', 'PAT testing']),
    createChecklist('cl_49', 'Special', 'Warehouse/Stores', ['Racking condition', 'Aisles clear', 'Stacking height', 'Ladder safety']),
    createChecklist('cl_50', 'Special', 'Security Gate', ['Logbook maintained', 'Visitor induction', 'Vehicle search', 'PPE check']),
];

// --- SAMPLE PLANS ---
export const plans: Plan[] = [
    {
        id: 'plan_1', org_id: 'org_1', project_id: 'proj_1', type: 'HSEMP', title: 'Project HSE Plan', version: 'v1.0', status: 'approved',
        people: { prepared_by: { name: 'Alex Johnson', email: 'alex@clint.com', signed_at: '2024-01-01' } },
        dates: { created_at: '2024-01-01', updated_at: '2024-01-05', next_review_at: '2024-06-01' },
        content: { body_json: [], attachments: [] }, meta: { tags: ['Master'], change_note: '' }, audit_trail: []
    },
    {
        id: 'plan_2', org_id: 'org_1', project_id: 'proj_1', type: 'Lifting', title: 'Heavy Lift Plan - Chiller', version: 'v2.0', status: 'draft',
        people: { prepared_by: { name: 'Maria Garcia', email: 'maria@clint.com' } },
        dates: { created_at: '2024-02-10', updated_at: '2024-02-10', next_review_at: '2024-02-20' },
        content: { body_json: [], attachments: [] }, meta: { tags: ['Crane'], change_note: '' }, audit_trail: []
    }
];

// --- SAMPLE RAMS ---
export const rams: Rams[] = [
    {
        id: 'rams_1', org_id: 'org_1', project_id: 'proj_1', activity: 'Excavation for Foundation', location: 'Zone A', status: 'approved', version: 'v1',
        prepared_by: { name: 'Alex Johnson', email: 'alex@clint.com', role: 'HSE Manager', signed_at: '2024-01-15' },
        times: { created_at: '2024-01-10', updated_at: '2024-01-15', valid_from: '2024-01-20', valid_until: '2024-02-20' },
        method_statement: { overview: 'Excavation using 20T excavator...', competence: 'Certified Operator', sequence_of_operations: [], emergency_arrangements: 'Muster Point B' },
        overall_risk_before: 15, overall_risk_after: 5, attachments: [], linked_ptw_types: ['Excavation'], audit_log: []
    }
];

// --- EMPTY PLACEHOLDERS (To prevent crashes) ---
export const reports: Report[] = [];
export const inspections: Inspection[] = [];
export const checklistRuns: ChecklistRun[] = [];
export const signs: Sign[] = [];
export const tbtSessions: TbtSession[] = [];
export const trainingCourses: TrainingCourse[] = [];
export const trainingRecords: TrainingRecord[] = [];
export const trainingSessions: TrainingSession[] = [];
export const notifications: Notification[] = [];
export const ptws: Ptw[] = [];

export const certificationProfile: CertificationProfile = {
    user_id: 'user_kamran',
    org_id: 'org_1',
    level: 'Advanced',
    role_title: 'HSE Manager',
    safe_working_hours: 3680,
    total_years_experience: 7,
    qualifications: [],
    requirements_met: { training: true, experience: true, safe_hours: false, behavior: true }
};

==================================================
FILE: .\src\firebase.ts
==================================================

import { initializeApp, getApps, getApp } from "firebase/app";
import { getFirestore, enableIndexedDbPersistence } from "firebase/firestore";
import { getAuth } from "firebase/auth";
import { getStorage } from "firebase/storage";

const firebaseConfig = {
  apiKey: "AIzaSyBsG6olIcDkJpNNVcK3RPoH0jScmocZanM",
  authDomain: "evirosafe-auth.firebaseapp.com",
  projectId: "evirosafe-auth",
  storageBucket: "evirosafe-auth.firebasestorage.app",
  messagingSenderId: "549739145640",
  appId: "1:549739145640:web:aa0d67ab931bfc7cdcd59d",
  measurementId: "G-NLZV3LWNEM"
};

// Initialize Firebase
const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();

const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

// --- ENABLE OFFLINE PERSISTENCE ---
// This allows the app to work without internet
enableIndexedDbPersistence(db).catch((err) => {
    if (err.code == 'failed-precondition') {
        console.warn("Offline persistence failed: Multiple tabs open.");
    } else if (err.code == 'unimplemented') {
        console.warn("Offline persistence not supported by browser.");
    }
});

export { app, db, auth, storage };

==================================================
FILE: .\src\index.css
==================================================

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --bg-primary: #0f172a; /* slate-900 */
  --bg-secondary: #1e293b; /* slate-800 */
  --text-primary: #f1f5f9; /* slate-100 */
  --text-secondary: #cbd5e1; /* slate-300 */
  --accent-color: #0ea5e9; /* sky-500 */
}

body {
  @apply bg-slate-950 text-slate-100 transition-colors duration-300;
  overflow-x: hidden;
  min-height: 100vh;
  background: radial-gradient(
    circle at 50% 0%,
    rgba(30, 41, 59, 0.4) 0%,
    rgba(15, 23, 42, 0.8) 30%,
    rgba(2, 6, 23, 1) 70%
  );
}

/* Improved text contrast classes */
.text-high-contrast {
  @apply text-slate-50;
}

.text-medium-contrast {
  @apply text-slate-200;
}

.text-subtle {
  @apply text-slate-300;
}

/* Consistent background layers */
.bg-layer-1 {
  @apply bg-slate-900;
}

.bg-layer-2 {
  @apply bg-slate-800;
}

.bg-layer-3 {
  @apply bg-slate-700;
}

@layer components {
  /* Enhanced Global Input Styles */
  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="number"],
  input[type="date"],
  input[type="datetime-local"],
  input[type="time"],
  input[type="tel"],
  input[type="search"],
  textarea,
  select {
    @apply bg-slate-900 border border-slate-700 text-slate-100 placeholder:text-slate-400 rounded-xl shadow-sm transition-all duration-200;
  }
  
  input:not(:placeholder-shown),
  textarea:not(:placeholder-shown),
  select:not(:placeholder-shown) {
    @apply bg-slate-800;
  }
  
  input:focus, textarea:focus, select:focus {
    @apply outline-none border-sky-500 ring-2 ring-sky-500/20 bg-slate-800;
  }

  input:disabled, textarea:disabled, select:disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  /* Enhanced Dashboard Background */
  .dashboard-bg {
    min-height: 100vh;
    background: linear-gradient(
      135deg,
      rgba(15, 23, 42, 0.95) 0%,
      rgba(2, 6, 23, 0.98) 100%
    );
    padding: 24px 32px;
    color: #f1f5f9;
    position: relative;
  }

  .dashboard-bg::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.2), transparent);
  }

  /* Enhanced Glass Card */
  .glass-card {
    background: rgba(30, 41, 59, 0.85); /* More opaque for better contrast */
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border-radius: 20px;
    border: 1px solid rgba(71, 85, 105, 0.3);
    box-shadow: 
      0 4px 6px -1px rgba(0, 0, 0, 0.3),
      0 2px 4px -1px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.05);
    color: #f1f5f9;
    transition: all 0.3s ease;
  }

  .glass-card:hover {
    transform: translateY(-2px);
    border-color: rgba(56, 189, 248, 0.4);
    box-shadow: 
      0 10px 25px -5px rgba(0, 0, 0, 0.4),
      0 8px 10px -6px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  .glass-card .card-title {
    @apply text-slate-100 font-semibold;
  }

  .glass-card .card-content {
    @apply text-slate-300;
  }

  /* Enhanced Hero Cards with better contrast */
  .hero-card-high {
    background: linear-gradient(
      135deg, 
      rgba(239, 68, 68, 0.2) 0%,
      rgba(30, 41, 59, 0.95) 100%
    );
    backdrop-filter: blur(20px);
    border: 1px solid rgba(248, 113, 113, 0.3);
    box-shadow: 
      0 0 30px rgba(239, 68, 68, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    color: #fecaca; /* red-200 for better contrast on red theme */
  }

  .hero-card-normal {
    background: linear-gradient(
      135deg, 
      rgba(16, 185, 129, 0.2) 0%,
      rgba(30, 41, 59, 0.95) 100%
    );
    backdrop-filter: blur(20px);
    border: 1px solid rgba(16, 185, 129, 0.3);
    box-shadow: 
      0 0 30px rgba(16, 185, 129, 0.15),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    color: #a7f3d0; /* emerald-200 for better contrast on green theme */
  }

  /* Text visibility helper classes */
  .text-on-dark {
    color: #f8fafc; /* slate-50 */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .text-on-light {
    color: #1e293b; /* slate-800 */
  }

  /* Live Dot Animation - Enhanced */
  .live-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f87171, #ef4444);
    box-shadow: 
      0 0 15px #f87171,
      0 0 30px rgba(239, 68, 68, 0.3);
    animation: livePulse 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
    position: relative;
  }

  .live-dot::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 50%;
    border: 1px solid rgba(248, 113, 113, 0.3);
    animation: livePulseOuter 1.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
  }

  @keyframes livePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.8; }
  }

  @keyframes livePulseOuter {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0; }
  }

  /* Custom Scrollbar - Enhanced */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: rgba(30, 41, 59, 0.5);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #475569, #64748b);
    border-radius: 4px;
    border: 2px solid rgba(30, 41, 59, 0.5);
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #64748b, #94a3b8);
  }

  /* Utility classes for text contrast */
  .contrast-helper {
    --text-shadow-color: rgba(0, 0, 0, 0.3);
    text-shadow: 
      0 1px 1px var(--text-shadow-color),
      0 2px 2px var(--text-shadow-color);
  }

  /* Smooth transitions for theme changes */
  .theme-transition {
    @apply transition-all duration-300 ease-in-out;
  }
}

/* Print styles for better visibility */
@media print {
  body {
    background: white !important;
    color: black !important;
  }
  
  .glass-card {
    background: white !important;
    border: 1px solid #ccc !important;
    box-shadow: none !important;
    color: black !important;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  body {
    background: #0f172a !important;
  }
  
  .glass-card {
    background: #1e293b !important;
    border: 2px solid #475569 !important;
  }
  
  input, textarea, select {
    border: 2px solid #475569 !important;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

==================================================
FILE: .\src\index.tsx
==================================================

import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';
import { ErrorBoundary } from './components/ErrorBoundary';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <ErrorBoundary>
      <App />
    </ErrorBoundary>
  </React.StrictMode>
);

==================================================
FILE: .\src\types.ts
==================================================

// src/types.ts

// --- CORE ---
export interface Organization {
  id: string;
  name: string;
  slug: string;
  domain: string;
  status: 'active' | 'suspended';
  timezone: string;
  primaryLanguage: string;
  secondaryLanguages: string[];
  branding: {
    logoUrl: string;
    primaryColor?: string;
  };
  industry: string;
  country: string;
}

export interface User {
  id: string;
  org_id: string;
  email: string;
  name: string;
  avatar_url: string;
  role: 'ADMIN' | 'ORG_ADMIN' | 'HSE_MANAGER' | 'HSE_OFFICER' | 'SUPERVISOR' | 'INSPECTOR' | 'WORKER' | 'CLIENT_VIEWER' | 'CUSTOM_SITE_LEAD';
  status: 'active' | 'inactive' | 'invited' | 'pending_approval' | string; 
  mobile?: string;
  designation?: string;
  company?: string;
  preferences: {
    language: string;
    default_view: string; // Relaxed type to avoid conflicts
    units: {
      temperature: 'C' | 'F';
      wind_speed?: 'km/h' | 'mph'; // Made optional
      height?: 'm' | 'ft';         // Made optional
      weight: 'kg' | 'lbs';
      distance?: 'km' | 'mi';      // Added distance
    };
  };
  project_ids?: string[];
}

export interface Project {
  id: string;
  org_id: string;
  name: string;
  code: string;
  status: 'active' | 'pending' | 'archived';
  location: string;
  start_date: string;
  finish_date: string;
  manager_id: string;
  type: string;
  safety_score?: number;
  progress?: number;
  budget?: number;
  budget_spent?: number;
}

export type Resource = 
  | 'dashboard' | 'reports' | 'inspections' | 'plans' | 'rams' | 'training' | 'people' | 'settings' | 'files' | 'analytics' | 'checklists' | 'signage' | 'tbt' | 'organizations' | 'projects' | 'roles' | 'ptw' | 'housekeeping' | 'actions' | 'site-map' | 'certification' | 'hse-statistics' | 'ai-insights';

export type View = Resource | string; // Relaxed to string to fix Sidebar error
export type Action = 'read' | 'create' | 'update' | 'approve' | 'delete' | 'export' | 'assign';
export type Scope = 'org' | 'project' | 'own';

export interface Permission {
  resource: Resource;
  actions: Action[];
  scope: Scope;
}

export interface Role {
  org_id: string | null;
  key: string;
  label: string;
  is_system: boolean;
  permissions: Permission[];
}

export interface Notification {
  id: string;
  user_id: string;
  report_id: string;
  message: string;
  timestamp: string;
  is_read: boolean;
}

export interface AuditLogEntry {
  user_id: string;
  timestamp: string;
  action: string;
  details?: string;
}

export interface ActionItem {
  id: string;
  action: string;
  owner_id: string;
  due_date: string;
  status: 'Open' | 'In Progress' | 'Closed';
  project_id: string;
  priority?: 'Low' | 'Medium' | 'High' | 'Critical';
  source: {
    type: 'Report' | 'Inspection' | 'Standalone';
    id: string;
    description: string;
  };
  origin: {
      type: 'report-capa' | 'standalone';
      parentId: string;
      itemId: string;
  }
}

export interface ActivityItem {
    id: string;
    type: 'report' | 'inspection' | 'ptw' | 'rams' | 'equipment' | 'training' | 'message' | 'incident' | 'milestone';
    title: string;
    description: string;
    user: User;
    timestamp: string;
    data: any;
    status?: string;
    priority?: 'low' | 'medium' | 'high';
}

export type ReportStatus = 'draft' | 'submitted' | 'under_review' | 'closed';
export type ReportClassification = 'To Be Determined' | 'Minor' | 'Moderate' | 'Major' | 'Fatal';
export type ImpactedParty = 'Employee' | 'Contractor' | 'Visitor' | 'Public' | 'Environment';
export type RootCause = 'Human Error' | 'Equipment Failure' | 'Process Deficiency' | 'Environment' | 'Other';
export type Severity = 1 | 2 | 3 | 4 | 5;
export type Likelihood = 1 | 2 | 3 | 4 | 5;

export type ReportType = 
  | 'Incident' | 'Accident' | 'Near Miss' | 'Unsafe Act' | 'Unsafe Condition'
  | 'First Aid Case (FAC)' | 'Medical Treatment Case (MTC)' | 'Lost Time Injury (LTI)'
  | 'Restricted Work Case (RWC)' | 'Property / Asset Damage' | 'Environmental Incident'
  | 'Fire Event' | 'Leadership Event' | 'Positive Observation';

export interface RiskMatrix {
  severity: Severity;
  likelihood: Likelihood;
}

export interface CapaAction {
  type: 'Corrective' | 'Preventive';
  action: string;
  owner_id: string;
  due_date: string;
  status: 'Open' | 'In Progress' | 'Closed';
  verified_at?: string;
  verified_by_id?: string;
}

export interface ReportDistribution {
  user_ids: string[];
  additional_recipients?: string[];
  send_alert_on_submit: boolean;
  notify_on_update: boolean;
  cc_role_key?: string;
}

export interface ReportAcknowledgement {
  user_id: string;
  acknowledged_at: string;
}

export interface AccidentDetails { person_name: string; designation: string; nature_of_injury: string; body_part_affected: string; treatment_given: string; days_lost?: number; medical_report_urls?: string[]; }
export interface IncidentDetails { property_damage_details?: string; environmental_impact: { type_of_impact: string; quantity_extent: string; containment_action: string; authority_notified: boolean; notification_ref?: string; } | null; }
export interface NearMissDetails { potential_consequence: string; }
export interface UnsafeActDetails { act_category: string; coaching_given: boolean; coaching_notes?: string; }
export interface UnsafeConditionDetails { condition_category: string; temporary_control_applied: string; }
export interface LeadershipEventDetails { event_type_code: string; leader_name?: string; attendees_count?: number; key_observations?: string; }

export type ReportDetails = AccidentDetails | IncidentDetails | NearMissDetails | UnsafeActDetails | UnsafeConditionDetails | LeadershipEventDetails;

export interface Report {
    id: string;
    creator_id: string;
    org_id: string;
    project_id: string;
    type: ReportType;
    status: ReportStatus;
    classification: ReportClassification;
    reporter_id: string;
    reported_at: string;
    work_related: boolean;
    impacted_party: ImpactedParty[];
    occurred_at: string;
    location: { text: string; specific_area: string; geo?: { lat: number; lng: number }; };
    description: string;
    conditions?: string;
    immediate_actions: string;
    further_corrective_action_required: boolean;
    evidence_urls: string[];
    ai_evidence_summary?: string;
    ai_suggested_evidence?: string[];
    risk_pre_control: RiskMatrix;
    root_cause?: RootCause;
    capa: CapaAction[];
    distribution: ReportDistribution;
    acknowledgements: ReportAcknowledgement[];
    audit_trail: AuditLogEntry[];
    details: ReportDetails;
    identification?: { was_fire: boolean; was_injury: boolean; was_environment: boolean; };
    classification_codes?: string[];
    created_at?: string;
}

export type InspectionStatus = 'Draft' | 'Ongoing' | 'Submitted' | 'Under Review' | 'Approved' | 'Closed' | 'Archived' | 'In Progress' | 'Scheduled' | 'Pending Review' | 'Overdue';

export interface InspectionFinding {
    id: string;
    checklist_item_id?: string;
    description: string;
    risk_level: 'Low' | 'Medium' | 'High';
    category: 'Unsafe Act' | 'Unsafe Condition' | 'Documentation' | 'Equipment' | 'Environmental';
    evidence_urls: string[];
    corrective_action_required: boolean;
    responsible_person_id?: string;
    due_date?: string;
    gps_tag?: { lat: number, lng: number };
}

export interface Inspection {
    id: string;
    org_id: string;
    project_id: string;
    title: string;
    type: 'Safety' | 'Quality' | 'Environmental' | 'Fire' | 'Equipment';
    status: InspectionStatus;
    person_responsible_id: string;
    checklist_template_id: string;
    schedule_at: string;
    team_member_ids: string[];
    observers: string[];
    findings: InspectionFinding[];
    overall_comments?: string;
    audit_trail: AuditLogEntry[];
    inspection_id?: string;
}

export interface ChecklistItem { id: string; text: Record<string, string>; description: Record<string, string>; riskLevel?: string; }
export interface ChecklistTemplate { id: string; org_id: string; category: string; title: Record<string, string>; items: ChecklistItem[]; popularity?: number; estimatedTime?: number; aiGenerated?: boolean; }
export interface ChecklistRunResult { item_id: string; result: 'pass' | 'fail' | 'na'; remarks?: string; evidence_urls?: string[]; }
export interface ChecklistRun { id: string; org_id: string; project_id: string; template_id: string; executed_by_id: string; executed_at: string; status: 'in_progress' | 'completed'; score?: number; results: ChecklistRunResult[]; }

export type PlanStatus = 'draft' | 'under_review' | 'approved' | 'published' | 'archived';
export type PlanType = 'HSEMP' | 'Lifting' | 'Work at Height' | 'Confined Space' | 'Fire' | 'ERP' | 'EMP' | 'Waste';
export interface PlanContentSection { title: string; content: string; is_complete: boolean; }
export interface Plan {
    id: string;
    org_id: string;
    project_id: string;
    type: PlanType;
    title: string;
    version: string;
    status: PlanStatus;
    people: { prepared_by: any; reviewed_by?: any; approved_by_client?: any; };
    dates: { created_at: string; updated_at: string; approved_at?: string; published_at?: string; next_review_at: string; };
    content: { body_json: PlanContentSection[]; attachments: { name: string, url: string }[]; };
    meta: { tags: string[]; change_note: string; };
    audit_trail: AuditLogEntry[];
}

export type RamsStatus = 'draft' | 'under_review' | 'approved' | 'published' | 'archived';
export type RamsHierarchy = 'elimination' | 'substitution' | 'engineering' | 'administrative' | 'ppe';
export interface RamsHazard { id: string; description: string; }
export interface RamsControl { id: string; description: string; hierarchy: RamsHierarchy; }
export interface RamsStep { step_no: number; description: string; hazards: RamsHazard[]; controls: RamsControl[]; risk_before: RiskMatrix; risk_after: RiskMatrix; }
export interface Rams {
    id: string;
    org_id: string;
    project_id: string;
    activity: string;
    location: string;
    status: RamsStatus;
    version: string;
    prepared_by: any; reviewed_by?: any; approved_by_client?: any;
    times: { created_at: string; updated_at: string; approved_at?: string; valid_from: string; valid_until: string; };
    method_statement: { overview: string; competence: string; sequence_of_operations: RamsStep[]; emergency_arrangements: string; };
    overall_risk_before: number;
    overall_risk_after: number;
    attachments: { name: string, url: string }[];
    linked_ptw_types: PtwType[];
    audit_log: AuditLogEntry[];
}

export type SignCategory = 'Prohibition' | 'Mandatory' | 'Warning' | 'Emergency' | 'Fire' | 'Environmental' | 'Traffic' | 'Informational';
export type HazardType = 'Fire' | 'Fall' | 'Electrical' | 'Chemical' | 'Noise' | 'Dropped Object' | 'Overhead Load' | 'Trip' | 'Slippery' | 'Explosion' | 'Moving Machinery' | 'Confined Space' | 'Excavation';
export interface Sign { id: string; org_id: string; category: SignCategory; title: Record<string, string>; icon_url: string; description: Record<string, string>; matched_activities: PtwType[]; hazards: HazardType[]; }

export interface TbtAttendee { name: string; company: string; role: string; signature: string; attendance_time: string; }
export interface TbtSession {
    id: string; org_id: string; project_id: string; title: string; topic_category: string; method: 'daily' | 'weekly' | 'ad-hoc'; location: string;
    conducted_by: { name: string; role: string; signature: string; };
    date: string; time: string; summary: string; hazards_discussed: string[]; controls_discussed: string[]; discussion_points: string[];
    attendees: TbtAttendee[]; attachments: { name: string, url: string }[]; linked_rams_ids: string[]; linked_ptw_types: PtwType[]; linked_plan_ids: string[];
    status: 'draft' | 'scheduled' | 'delivered' | 'closed' | 'archived'; audit_log: AuditLogEntry[];
}

export interface TrainingCourse { id: string; org_id: string; title: string; category: string; validity_months: number; syllabus: string; learning_objectives: string[]; requires_assessment: boolean; }
export interface TrainingSession { id: string; course_id: string; project_id: string; scheduled_at: string; trainer_id: string; status: 'scheduled' | 'completed' | 'cancelled'; roster: string[]; attendance: { user_id: string; attended: boolean; score?: number; }[]; }
export interface TrainingRecord { id: string; org_id: string; user_id: string; course_id: string; session_id: string; issued_at: string; expires_at: string; score?: number; status: 'valid' | 'expiring_soon' | 'expired'; }

export type PtwType = 'General Work' | 'Hot Work' | 'Electrical Work' | 'Excavation' | 'Lifting' | 'Work at Height' | 'Confined Space Entry' | 'Night Work' | 'Road Closure' | 'Utility Work';
export type PtwStatus = 'DRAFT' | 'SUBMITTED' | 'PRE_SCREEN' | 'SITE_INSPECTION' | 'APPROVAL' | 'ACTIVE' | 'HOLD' | 'COMPLETED' | 'CLOSED' | 'REQUESTED' | 'ISSUER_REVIEW' | 'ISSUER_SIGNED' | 'IV_REVIEW' | 'PENDING_APPROVAL' | 'APPROVER_SIGNED' | 'AUTHORIZATION' | 'HANDOVER_PENDING' | 'SITE_HANDOVER' | 'SUSPENDED' | 'COMPLETION_PENDING' | 'JOINT_INSPECTION' | 'CANCELLED' | 'ARCHIVED' | 'REJECTED';
export type PtwCategory = 'standard' | 'high_risk' | 'operational' | 'emergency' | 'urgent';
export type PtwWorkflowStage = PtwStatus;

export interface PtwWorkflowLog {
  stage: PtwWorkflowStage;
  action: string;
  user_id: string;
  timestamp: string;
  comments?: string;
  signoff_type?: string;
}

export interface PtwPpe { hard_hat: boolean; safety_shoes: boolean; goggles: boolean; safety_harness: boolean; coverall: boolean; respirator: boolean; safety_gloves: boolean; vest: boolean; other?: string; }
export interface PtwSafetyRequirement { id: string; text: string; response: 'Yes' | 'No' | 'N/A'; is_critical?: boolean; comment?: string; evidence_urls?: string[]; }
export interface PtwSignature { signature: string; signed_at: string; }
export interface PtwSignoff { name: string; designation: string; email: string; mobile: string; remarks: string; signature: string; signed_at: string; }
export interface PtwStoppage { time: string; reason: string; stopped_by: string; informed_to: string; restarted_time: string; signature: string; }
export interface PtwExtension { is_requested: boolean; reason: string; days: { from: string; to: string }; hours: { from: string; to: string }; requester: PtwSignature; client_proponent: PtwSignature; client_hs: PtwSignature; }
export interface PtwClosure { note: string; permit_requester: PtwSignature; client_proponent: PtwSignature; client_hs: PtwSignature; }
export interface CanonicalPtwPayload {
    creator_id: string; permit_no: string; category: PtwCategory;
    requester: any; contractor_safety_personnel?: any;
    work: { location: string; description: string; coverage: { start_date: string; end_date: string; start_time: string; end_time: string; }; associated_permits?: string[]; number_of_workers?: number; risk_assessment_ref?: string; emergency_contact?: string; };
    safety_requirements: PtwSafetyRequirement[]; ppe: PtwPpe;
    signoffs?: { client_proponent: PtwSignoff; other_stakeholders: PtwSignoff[]; client_hs: PtwSignoff; };
    joint_inspection?: { remarks: string; requester: PtwSignature; client_proponent: PtwSignature; client_hs: PtwSignature; };
    holding_or_stoppage?: PtwStoppage[]; extension?: PtwExtension; closure?: PtwClosure; attachments?: { name: string; url: string }[]; audit?: AuditLogEntry[];
    global_compliance?: { standards: string[] };
}
export interface PtwHotWorkPayload extends CanonicalPtwPayload { fire_watcher: { name: string; mobile: string; }; post_watch_minutes: number; }
export interface PtwWorkAtHeightPayload extends CanonicalPtwPayload { access_equipment: any; }
export interface GasTestLogEntry { time: string; o2: number; lel: number; co: number; h2s: number; tester_name: string; }
export interface PersonnelEntryLogEntry { name: string; time_in: string; time_out: string; }
export interface PtwConfinedSpacePayload extends CanonicalPtwPayload { gas_tests: GasTestLogEntry[]; entry_log: PersonnelEntryLogEntry[]; }
export interface PtwExcavationPayload extends CanonicalPtwPayload { soil_type: 'A' | 'B' | 'C'; cave_in_protection: any[]; }
export interface PtwRoadClosurePayload extends CanonicalPtwPayload { closure_type: 'full' | 'partial' | 'rolling'; }
export interface PtwLiftingPayload extends CanonicalPtwPayload { 
    load_calculation: { 
        hook_rigging_weight?: number; 
        load_weight: number; 
        total_weight?: number; 
        boom_length?: number; 
        max_working_radius?: number; 
        crane_capacity_at_radius?: number; 
        crane_capacity: number; 
        utilization_percent: number; 
        lift_plan_ref?: string; 
        crane_certification_no?: string; 
        operator_certification_no?: string; 
    }; 
}
export interface PtwNightWorkPayload extends CanonicalPtwPayload {}
export interface PtwElectricalWorkPayload extends CanonicalPtwPayload {}
export interface PtwUtilityWorkPayload extends CanonicalPtwPayload {}
export interface PtwGeneralWorkPayload extends CanonicalPtwPayload {}

export type PtwPayload = CanonicalPtwPayload | PtwHotWorkPayload | PtwWorkAtHeightPayload | PtwConfinedSpacePayload | PtwExcavationPayload | PtwRoadClosurePayload | PtwLiftingPayload;
export interface Ptw { id: string; org_id: string; project_id: string; type: PtwType; status: PtwStatus; title: string; payload: PtwPayload; approvals: any[]; audit_log: AuditLogEntry[]; compliance_level?: 'FULL' | 'PARTIAL' | 'NONE'; updated_at: string; workflow_log?: PtwWorkflowLog[]; }

export type CertificationLevel = 'Beginner' | 'Competent' | 'Advanced' | 'Expert' | 'Certified Professional';
export interface Qualification { id: string; title: string; issuer: string; date_obtained: string; expiry_date?: string; verification_status: 'Pending' | 'Verified' | 'Rejected'; attachment_url?: string; }
export interface CertificationProfile { user_id: string; org_id: string; level: CertificationLevel; role_title: string; safe_working_hours: number; total_years_experience: number; last_incident_date?: string; qualifications: Qualification[]; requirements_met: { training: boolean; experience: boolean; safe_hours: boolean; behavior: boolean; }; certificate_id?: string; certificate_issued_at?: string; supervisor_approval?: { name: string; approved_at: string; comments: string; }; }

export interface PtwRiskAnalysis {
    base_score: number;
    complexity_factor: number;
    weather_factor: number;
    time_factor: number;
    total_risk_score: number;
    risk_level: 'Low' | 'Medium' | 'High' | 'Critical';
    auto_controls: string[];
}

export interface SimopsConflict {
    conflicting_ptw_id: string;
    conflict_type: 'Spatial' | 'Temporal' | 'Resource';
    description: string;
}

==================================================
FILE: .\src\components\ActionCreationModal.tsx
==================================================

import React, { useState } from 'react';
import { Button } from './ui/Button';
import { FormField } from './ui/FormField';

interface ActionCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: any) => void;
  users: any[];
  projects: any[];
}

export const ActionCreationModal: React.FC<ActionCreationModalProps> = ({ 
  isOpen, 
  onClose, 
  onSubmit, 
  users = [], 
  projects = [] 
}) => {
    const [formData, setFormData] = useState({
        action: '',
        owner_id: '',
        project_id: '',
        due_date: new Date().toISOString().slice(0, 10),
        priority: 'Medium'
    });

    const handleSubmit = () => {
        if(!formData.action || !formData.project_id || !formData.due_date) {
            alert("Please fill in the Action description, Project, and Due Date.");
            return;
        }
        onSubmit(formData);
        setFormData({
            action: '',
            owner_id: '',
            project_id: '',
            due_date: new Date().toISOString().slice(0, 10),
            priority: 'Medium'
        });
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b dark:border-gray-700">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">Create Standalone Action</h3>
                </div>
                <div className="p-6 space-y-4">
                    <FormField label="Action Description">
                        <textarea 
                            className="w-full p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                            rows={3}
                            value={formData.action}
                            onChange={e => setFormData(p => ({...p, action: e.target.value}))}
                            placeholder="Describe the corrective action..."
                        />
                    </FormField>
                    <div className="grid grid-cols-2 gap-4">
                        <FormField label="Project">
                            <select 
                                className="w-full p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                                value={formData.project_id}
                                onChange={e => setFormData(p => ({...p, project_id: e.target.value}))}
                            >
                                <option value="">Select Project</option>
                                {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                        </FormField>
                        <FormField label="Priority">
                            <select 
                                className="w-full p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                                value={formData.priority}
                                onChange={e => setFormData(p => ({...p, priority: e.target.value}))}
                            >
                                <option>Low</option>
                                <option>Medium</option>
                                <option>High</option>
                                <option>Critical</option>
                            </select>
                        </FormField>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <FormField label="Owner">
                            <select 
                                className="w-full p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                                value={formData.owner_id}
                                onChange={e => setFormData(p => ({...p, owner_id: e.target.value}))}
                            >
                                <option value="">Unassigned</option>
                                {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                            </select>
                        </FormField>
                        <FormField label="Due Date">
                            <input 
                                type="date" 
                                className="w-full p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                                value={formData.due_date}
                                onChange={e => setFormData(p => ({...p, due_date: e.target.value}))}
                            />
                        </FormField>
                    </div>
                </div>
                <div className="p-6 border-t dark:border-gray-700 flex justify-end gap-2">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSubmit}>Create Action</Button>
                </div>
            </div>
        </div>
    );
};

==================================================
FILE: .\src\components\ActionDetailModal.tsx
==================================================

import React, { useState } from 'react';
import type { ActionItem, User } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext } from '../contexts';

interface ActionDetailModalProps {
  actionItem: ActionItem;
  onClose: () => void;
  onUpdateStatus: (newStatus: ActionItem['status']) => void;
  users: User[];
}

export const ActionDetailModal: React.FC<ActionDetailModalProps> = ({ actionItem, onClose, onUpdateStatus, users }) => {
  const { activeUser } = useAppContext();
  const [comment, setComment] = useState('');

  const owner = users.find(u => u.id === actionItem.owner_id);
  
  // Mock History Generator
  const history = [
    { date: new Date().toISOString(), user: activeUser?.name || 'System', text: `Viewing action details`, type: 'view' },
    { date: actionItem.due_date, user: 'System', text: 'Action due date set', type: 'system' },
    { date: new Date(Date.now() - 86400000).toISOString(), user: 'System', text: 'Action created', type: 'create' },
  ];

  // FIX: Ensure returned colors match BadgeProps
  const getPriorityColor = (p?: string): 'red' | 'yellow' | 'green' => {
      switch(p) {
          case 'Critical': return 'red';
          case 'High': return 'red'; // Changed from orange to red
          case 'Medium': return 'yellow';
          default: return 'green';
      }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-dark-border flex justify-between items-start">
            <div>
                <div className="flex items-center gap-3 mb-2">
                    <Badge color={actionItem.status === 'Closed' ? 'green' : 'blue'}>{actionItem.status}</Badge>
                    {actionItem.priority && <Badge color={getPriorityColor(actionItem.priority)}>{actionItem.priority}</Badge>}
                </div>
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">Action #{actionItem.id.slice(-6)}</h2>
            </div>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">âœ•</button>
        </div>

        <div className="p-6 overflow-y-auto space-y-8">
            {/* Details */}
            <div className="space-y-4">
                <div>
                    <label className="text-xs font-bold text-gray-500 uppercase">Description</label>
                    <p className="text-gray-900 dark:text-gray-100 mt-1 bg-gray-50 dark:bg-white/5 p-3 rounded-lg border dark:border-white/10">
                        {actionItem.action}
                    </p>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="text-xs font-bold text-gray-500 uppercase">Assigned To</label>
                        <div className="flex items-center gap-2 mt-1">
                            <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                                {owner?.name.charAt(0) || '?'}
                            </div>
                            <span className="text-sm text-gray-900 dark:text-white">{owner?.name || 'Unassigned'}</span>
                        </div>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-500 uppercase">Due Date</label>
                        <p className="text-sm text-gray-900 dark:text-white mt-1">{new Date(actionItem.due_date).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-500 uppercase">Source</label>
                        <p className="text-sm text-gray-900 dark:text-white mt-1">{actionItem.source.type} ({actionItem.source.id})</p>
                    </div>
                </div>
            </div>

            {/* History / Timeline */}
            <div>
                <h3 className="text-sm font-bold text-gray-900 dark:text-white mb-4 border-b dark:border-dark-border pb-2">Activity History</h3>
                <div className="space-y-6 relative pl-4 border-l-2 border-gray-200 dark:border-gray-700 ml-2">
                    {history.map((item, idx) => (
                        <div key={idx} className="relative">
                            <div className={`absolute -left-[21px] top-0 w-4 h-4 rounded-full border-2 border-white dark:border-dark-card ${item.type === 'create' ? 'bg-green-500' : 'bg-blue-500'}`}></div>
                            <p className="text-xs text-gray-500 mb-0.5">{new Date(item.date).toLocaleString()}</p>
                            <p className="text-sm text-gray-800 dark:text-gray-200">
                                <span className="font-semibold">{item.user}</span>: {item.text}
                            </p>
                        </div>
                    ))}
                </div>
            </div>
            
            {/* Add Comment (Visual Only for Demo) */}
            <div className="flex gap-2">
                <input 
                    type="text" 
                    value={comment}
                    onChange={(e) => setComment(e.target.value)}
                    placeholder="Add a note or update..." 
                    className="flex-1 p-2 text-sm border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white"
                />
                <Button size="sm" variant="secondary" onClick={() => setComment('')}>Post</Button>
            </div>
        </div>

        {/* Footer Actions */}
        <div className="p-4 border-t dark:border-dark-border bg-gray-50 dark:bg-black/20 flex justify-end gap-2 rounded-b-xl">
            {actionItem.status !== 'Closed' && (
                <Button onClick={() => { onUpdateStatus('Closed'); onClose(); }} className="bg-green-600 hover:bg-green-700 text-white border-none">
                    Mark as Closed
                </Button>
            )}
            {actionItem.status === 'Open' && (
                <Button onClick={() => { onUpdateStatus('In Progress'); onClose(); }} className="bg-blue-600 hover:bg-blue-700 text-white border-none">
                    Start Progress
                </Button>
            )}
            <Button variant="secondary" onClick={onClose}>Close</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Actions.tsx
==================================================

import React, { useMemo, useState } from 'react';
import type { ActionItem, CapaAction, Report } from '../types';
import { Card } from './ui/Card';
import { Badge } from './ui/Badge';
import { Button } from './ui/Button';
import { useAppContext, useDataContext, useModalContext } from '../contexts';
import { 
  Calendar, 
  Eye, 
  Search, 
  Plus, 
  AlertTriangle,
  CheckCircle,
  Clock,
  FileText,
  TrendingUp,
  Download,
  Upload,
  History
} from 'lucide-react';
import { ActionCreationModal } from './ActionCreationModal';

// Enhanced Action Item Interface for History
interface EnhancedActionItem extends ActionItem {
  history?: {
    date: string;
    action: string;
    user: string;
    status: string;
  }[];
  noticePeriod?: number; // Days
}

type ActionPriority = 'Critical' | 'High' | 'Medium' | 'Low';
type ActionStatus = 'Open' | 'In Progress' | 'Pending Review' | 'On Hold' | 'Closed' | 'Verified';

function getPriority(action: ActionItem): ActionPriority {
  if (action.priority) return action.priority as ActionPriority;
  if (action.status === 'Closed') return 'Low';
  const due = new Date(action.due_date);
  const now = new Date();
  const days = Math.ceil((due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
  if (days < 0) return 'Critical';
  if (days <= 3) return 'High';
  if (days <= 7) return 'Medium';
  return 'Low';
}

function priorityPill(priority: ActionPriority) {
  switch (priority) {
    case 'Critical': return 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800';
    case 'High': return 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800';
    case 'Medium': return 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800';
    default: return 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800';
  }
}

const StatCard: React.FC<{ title: string, value: number, color?: string, icon?: React.ReactNode }> = ({ title, value, color, icon }) => (
    <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 flex flex-col shadow-sm">
        <div className="flex justify-between items-start mb-2">
            <span className="text-gray-500 dark:text-gray-400 text-sm font-medium">{title}</span>
            {icon && <span className={`p-1.5 rounded-lg bg-gray-50 dark:bg-gray-700 ${color?.replace('text-', 'text-')}`}>{icon}</span>}
        </div>
        <span className={`text-2xl font-bold ${color || 'text-gray-900 dark:text-white'}`}>{value}</span>
    </div>
);

// History Modal Component
const HistoryModal = ({ action, onClose }: { action: EnhancedActionItem, onClose: () => void }) => (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
      <div className="p-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h3 className="font-bold text-gray-900 dark:text-white">Action History</h3>
        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
      </div>
      <div className="p-4 max-h-[60vh] overflow-y-auto">
        <div className="mb-4">
          <p className="text-sm font-semibold text-gray-700 dark:text-gray-300">Action: {action.action}</p>
        </div>
        <div className="space-y-4">
          {/* Mock History Data if none exists */}
          {(action.history || [
            { date: new Date(Date.now() - 86400000).toISOString(), action: 'Action Created', user: 'System', status: 'Open' },
            { date: new Date().toISOString(), action: 'Status Updated', user: 'Admin', status: action.status }
          ]).map((log, i) => (
            <div key={i} className="flex gap-3">
              <div className="mt-1 flex flex-col items-center">
                <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                {i < (action.history?.length || 2) - 1 && <div className="w-0.5 h-full bg-gray-200 dark:bg-gray-700 mt-1"></div>}
              </div>
              <div>
                <p className="text-sm text-gray-900 dark:text-white font-medium">{log.action}</p>
                <p className="text-xs text-gray-500">{new Date(log.date).toLocaleString()} by {log.user}</p>
                <p className="text-xs text-gray-500">Status: {log.status}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
);

export const Actions: React.FC = () => {
  const { actionItems, projects, reportList, handleUpdateActionStatus, handleCreateStandaloneAction } = useDataContext();
  const { usersList, activeUser, can } = useAppContext();
  const { 
      setSelectedReport, 
      setIsReportCreationModalOpen, 
      setReportInitialData,
      isActionCreationModalOpen,
      setIsActionCreationModalOpen
  } = useModalContext();

  const [projectFilter, setProjectFilter] = useState<'All' | string>('All');
  const [statusFilter, setStatusFilter] = useState<'All' | ActionStatus>('All');
  const [ownerFilter, setOwnerFilter] = useState<'All' | string>('All');
  const [search, setSearch] = useState('');
  const [selectedHistoryAction, setSelectedHistoryAction] = useState<EnhancedActionItem | null>(null);

  const filtered = useMemo(() => {
    const q = search.trim().toLowerCase();
    return actionItems.filter((a) => {
      const projectOk = projectFilter === 'All' || a.project_id === projectFilter;
      const statusOk = statusFilter === 'All' || a.status === statusFilter;
      const ownerOk = ownerFilter === 'All' || a.owner_id === ownerFilter;
      const searchOk =
        q.length === 0 ||
        a.action.toLowerCase().includes(q) ||
        a.source.description.toLowerCase().includes(q) ||
        a.source.id.toLowerCase().includes(q);

      return projectOk && statusOk && ownerOk && searchOk;
    });
  }, [actionItems, ownerFilter, projectFilter, search, statusFilter]);

  const stats = useMemo(() => {
    const total = filtered.length;
    const open = filtered.filter((a) => a.status === 'Open').length;
    const inProgress = filtered.filter((a) => a.status === 'In Progress').length;
    const closed = filtered.filter((a) => a.status === 'Closed').length;
    const overdue = filtered.filter((a) => new Date(a.due_date) < new Date() && a.status !== 'Closed').length;
    const critical = filtered.filter(a => getPriority(a) === 'Critical' && a.status !== 'Closed').length;
    return { total, open, inProgress, closed, overdue, critical };
  }, [filtered]);

  const openSource = (action: ActionItem) => {
    if (action.source.type === 'Report') {
      const report = reportList.find((r: Report) => r.id === action.source.id);
      if (report) setSelectedReport(report);
    }
  };

  const handleStatusChange = (action: ActionItem, newStatus: ActionStatus) => {
    handleUpdateActionStatus(action.origin, newStatus as CapaAction['status']);
  };

  const quickCreateReportWithCapa = () => {
    if (!can('create', 'reports')) return;
    setReportInitialData({
      further_corrective_action_required: true,
      capa: [
        {
          type: 'Corrective',
          action: '',
          owner_id: activeUser?.id || usersList[0]?.id || '',
          due_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),
          status: 'Open',
        } as CapaAction,
      ],
    });
    setIsReportCreationModalOpen(true);
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 dark:text-white">Action Tracker</h1>
          <p className="text-gray-500 dark:text-gray-400 mt-1">
              Monitor corrective actions, deadlines, and completion history.
          </p>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
        <StatCard title="Total" value={stats.total} icon={<FileText size={16} />} />
        <StatCard title="Open" value={stats.open} color="text-yellow-600" icon={<Clock size={16} />} />
        <StatCard title="In Progress" value={stats.inProgress} color="text-blue-600" icon={<TrendingUp size={16} />} />
        <StatCard title="Closed" value={stats.closed} color="text-green-600" icon={<CheckCircle size={16} />} />
        <StatCard title="Overdue" value={stats.overdue} color="text-red-600" icon={<AlertTriangle size={16} />} />
        <StatCard title="Critical" value={stats.critical} color="text-red-700" icon={<AlertTriangle size={16} />} />
      </div>

      <div className="flex flex-wrap gap-3">
          {can('create', 'reports') && (
            <Button onClick={quickCreateReportWithCapa} leftIcon={<Plus className="w-5 h-5" />} className="bg-emerald-600 hover:bg-emerald-700 text-white border-transparent">
              New Report - CAPA
            </Button>
          )}
          <Button variant="secondary" onClick={() => setIsActionCreationModalOpen(true)} leftIcon={<Plus className="w-5 h-5" />}>
              Create Standalone Action
          </Button>
          <Button variant="outline" leftIcon={<Upload className="w-4 h-4" />}>Import</Button>
          <Button variant="outline" leftIcon={<Download className="w-4 h-4" />}>Export</Button>
      </div>

      <Card className="p-4">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Project</label>
            <select
              value={projectFilter}
              onChange={(e) => setProjectFilter(e.target.value)}
              className="w-full p-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm text-gray-900 dark:text-white"
            >
              <option value="All">All Projects</option>
              {projects.map((p) => <option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
          </div>

          <div>
             <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Status</label>
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value as any)}
              className="w-full p-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm text-gray-900 dark:text-white"
            >
              <option value="All">All Status</option>
              <option value="Open">Open</option>
              <option value="In Progress">In Progress</option>
              <option value="Closed">Closed</option>
            </select>
          </div>

          <div>
             <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Owner</label>
            <select
              value={ownerFilter}
              onChange={(e) => setOwnerFilter(e.target.value)}
              className="w-full p-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm text-gray-900 dark:text-white"
            >
              <option value="All">All Users</option>
              {activeUser?.id && <option value={activeUser.id}>Me ({activeUser.name})</option>}
              {usersList.map((u) => <option key={u.id} value={u.id}>{u.name}</option>)}
            </select>
          </div>

          <div>
             <label className="text-xs font-bold uppercase text-gray-500 mb-1 block">Search</label>
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
              <input
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="Action / source..."
                className="w-full pl-9 p-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-md text-sm text-gray-900 dark:text-white"
              />
            </div>
          </div>
        </div>
      </Card>

      <Card className="overflow-hidden">
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead className="bg-gray-50 dark:bg-gray-800/50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Priority</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Action</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Owner</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Due Date</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Source</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">History</th>
              </tr>
            </thead>
            <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-800">
              {filtered.map((action) => {
                const owner = usersList.find((u) => u.id === action.owner_id);
                const project = projects.find((p) => p.id === action.project_id);
                const overdue = new Date(action.due_date) < new Date() && action.status !== 'Closed';
                const priority = getPriority(action);
                const daysRemaining = Math.ceil((new Date(action.due_date).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));

                return (
                  <tr key={action.id} className="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${priorityPill(priority)}`}>
                        {priority}
                      </span>
                    </td>

                    <td className="px-6 py-4">
                      <div className="text-sm font-medium text-gray-900 dark:text-white line-clamp-2" title={action.action}>{action.action}</div>
                      <div className="text-xs text-gray-500 mt-1">
                        {project?.name || 'No project'}
                      </div>
                    </td>

                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center gap-2">
                         <div className="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs font-bold text-gray-600 dark:text-gray-300">
                             {owner?.name.charAt(0) || '?'}
                         </div>
                         <div className="text-sm text-gray-700 dark:text-gray-300">{owner?.name || 'Unassigned'}</div>
                      </div>
                    </td>

                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className={`text-sm flex items-center gap-1 ${overdue ? 'text-red-600 font-bold' : 'text-gray-600 dark:text-gray-400'}`}>
                        <Calendar size={14} />
                        {new Date(action.due_date).toLocaleDateString()}
                      </div>
                       <div className="text-xs text-gray-500 mt-1">
                           {action.status !== 'Closed' && (
                               daysRemaining < 0 ? `${Math.abs(daysRemaining)} days overdue` : `${daysRemaining} days left`
                           )}
                       </div>
                    </td>

                    <td className="px-6 py-4 whitespace-nowrap">
                         <select
                          value={action.status}
                          onChange={(e) => handleStatusChange(action, e.target.value as ActionStatus)}
                          className="text-xs font-medium border rounded px-2 py-1 bg-transparent dark:bg-gray-800 dark:text-white dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          disabled={!activeUser}
                        >
                          <option value="Open">Open</option>
                          <option value="In Progress">In Progress</option>
                          <option value="Closed">Closed</option>
                        </select>
                    </td>

                    <td className="px-6 py-4 whitespace-nowrap">
                        <Badge color="gray">{action.source.type}</Badge>
                        {action.source.type === 'Report' && (
                             <button
                                onClick={() => openSource(action)}
                                className="ml-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-medium inline-flex items-center gap-1"
                            >
                                <Eye size={12} /> View
                            </button>
                        )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                         <button
                            onClick={() => setSelectedHistoryAction(action as EnhancedActionItem)}
                            className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                            title="View History"
                        >
                            <History size={18} />
                        </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </Card>
      
      {/* Modal for creating standalone actions */}
      <ActionCreationModal 
          isOpen={isActionCreationModalOpen}
          onClose={() => setIsActionCreationModalOpen(false)}
          onSubmit={handleCreateStandaloneAction}
          users={usersList}
          projects={projects}
      />

      {/* Modal for viewing history */}
      {selectedHistoryAction && (
          <HistoryModal action={selectedHistoryAction} onClose={() => setSelectedHistoryAction(null)} />
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\AiInsights.tsx
==================================================

import React, { useState } from 'react';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { generateResponse, generateAiRiskForecast } from '../services/geminiService';
import ReactMarkdown from 'react-markdown';
import { Sparkles } from 'lucide-react';

export const AiInsights: React.FC = () => {
  const [prompt, setPrompt] = useState<string>('');
  const [response, setResponse] = useState<string>('');
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [forecast, setForecast] = useState<any>(null);

  const handleAskAi = async () => {
    if (!prompt.trim()) return;
    setIsLoading(true);
    setResponse('');
    try {
      const result = await generateResponse(prompt);
      setResponse(result);
    } catch (e) {
      setResponse("Error generating response. Please check your API Key.");
    } finally {
      setIsLoading(false);
    }
  };

  const handleGetForecast = async () => {
      const data = await generateAiRiskForecast();
      setForecast(data);
  };

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-text-primary dark:text-white mb-6">AI Safety Insights</h1>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Chat Interface */}
          <div className="md:col-span-2">
            <Card title="Ask EviroSafe AI">
                <div className="space-y-4">
                <p className="text-sm text-gray-500 dark:text-gray-400">
                    Ask about safety regulations, risk assessments, or analyze a specific scenario.
                </p>
                <textarea
                    rows={4}
                    className="w-full p-3 border rounded-lg dark:bg-dark-background dark:border-dark-border dark:text-white focus:ring-2 focus:ring-primary-500"
                    value={prompt}
                    onChange={(e) => setPrompt(e.target.value)}
                    placeholder="e.g., What are the key risks for working in a confined space with welding?"
                />
                <div className="flex justify-end">
                    <Button onClick={handleAskAi} disabled={isLoading} leftIcon={<Sparkles className="w-4 h-4"/>}>
                        {isLoading ? 'Thinking...' : 'Ask AI'}
                    </Button>
                </div>
                
                {response && (
                    <div className="mt-6 p-4 bg-gray-50 dark:bg-white/5 rounded-lg border dark:border-dark-border">
                        <h3 className="font-bold text-sm text-gray-700 dark:text-gray-300 mb-2">AI Response:</h3>
                        <div className="prose prose-sm dark:prose-invert max-w-none">
                            <ReactMarkdown>{response}</ReactMarkdown>
                        </div>
                    </div>
                )}
                </div>
            </Card>
          </div>

          {/* Predictive Insights */}
          <div>
              <Card title="Predictive Risk Forecast">
                  <div className="text-center py-6">
                      {!forecast ? (
                          <Button variant="secondary" onClick={handleGetForecast}>Generate Forecast</Button>
                      ) : (
                          <div className="space-y-4">
                              <div className={`text-4xl font-black ${forecast.risk_level === 'High' ? 'text-red-500' : 'text-yellow-500'}`}>
                                  {forecast.risk_level}
                              </div>
                              <p className="text-sm text-gray-600 dark:text-gray-300">{forecast.summary}</p>
                              <div className="text-left bg-gray-50 dark:bg-white/5 p-3 rounded text-xs">
                                  <p className="font-bold mb-1">Recommendations:</p>
                                  <ul className="list-disc list-inside space-y-1">
                                      {forecast.recommendations.map((r: string, i: number) => <li key={i}>{r}</li>)}
                                  </ul>
                              </div>
                          </div>
                      )}
                  </div>
              </Card>
          </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\AuditTrail.tsx
==================================================

import React from 'react';
import type { AuditLogEntry, User } from '../types';
import { Card } from './ui/Card';

interface AuditTrailProps {
  logs: AuditLogEntry[];
  users: User[];
}

export const AuditTrail: React.FC<AuditTrailProps> = ({ logs, users }) => {
  const getUser = (userId: string) => users.find(u => u.id === userId);

  return (
    <Card title="Audit Trail">
      <div className="flow-root">
        <ul role="list" className="-mb-8">
          {logs.map((log, logIdx) => {
            const user = getUser(log.user_id);
            return (
              <li key={logIdx}>
                <div className="relative pb-8">
                  {logIdx !== logs.length - 1 ? (
                    <span className="absolute left-4 top-4 -ml-px h-full w-0.5 bg-gray-200 dark:bg-gray-700" aria-hidden="true" />
                  ) : null}
                  <div className="relative flex space-x-3">
                    <div>
                      <span className="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white dark:ring-dark-card">
                        <img
                          className="h-8 w-8 rounded-full"
                          src={user?.avatar_url || 'https://i.pravatar.cc/150'}
                          alt={user?.name || 'Unknown User'}
                        />
                      </span>
                    </div>
                    <div className="min-w-0 flex-1 pt-1.5">
                      <p className="text-sm text-gray-500 dark:text-gray-400">
                        <span className="font-medium text-gray-900 dark:text-gray-100">{user?.name || 'System'}</span>
                        {' '}{log.action.toLowerCase()}{log.details && <span className="italic"> {log.details}</span>}
                      </p>
                      <p className="mt-1 text-xs text-gray-500 dark:text-gray-500">
                        {new Date(log.timestamp).toLocaleString()}
                      </p>
                    </div>
                  </div>
                </div>
              </li>
            )
          })}
        </ul>
      </div>
    </Card>
  );
};

==================================================
FILE: .\src\components\CertifiedProfile.tsx
==================================================

import React, { useEffect, useMemo, useState } from 'react';
import { useAppContext } from '../contexts';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { certificationProfile as mockProfile } from '../data';
import { generateCertificationInsight } from '../services/geminiService';
import { generatePdf } from '../services/pdfService';
import type { CertificationProfile } from '../types';
import { 
  Globe, ShieldCheck, FileText, Clock, Award, 
  CheckCircle, XCircle, AlertTriangle, 
  BookOpen, Target, BarChart, ExternalLink, 
  Shield, Plus, RefreshCw
} from 'lucide-react';

// ================================
// 1. TYPES & STANDARDS
// ================================
type EducationLevel = 'Below Secondary' | 'Secondary' | 'Diploma' | 'Bachelor' | 'Master' | 'Doctorate';
type CertApplicationStatus = 'draft' | 'submitted' | 'under_review' | 'approved' | 'rejected' | 'suspended' | 'renewal_pending' | 'expired';
type CertificateLevel = 'Trainee' | 'Basic' | 'Professional' | 'Expert' | 'Master' | 'Fellow';

type InternationalCertType = 
  | 'NEBOSH' | 'IOSH' | 'OSHA' | 'ISO45001' | 'ISO14001' 
  | 'CSP' | 'CRSP' | 'CMIOSH' | 'CERTIOSH' | 'NVQ'
  | 'RSP' | 'DipNEBOSH' | 'Other';

type CompetencyLevel = 'Beginner' | 'Intermediate' | 'Advanced' | 'Expert';

interface InternationalCert {
  type: InternationalCertType;
  certificateNumber: string;
  issuingBody: string;
  issueDate: string;
  expiryDate: string;
  level: string;
  verificationStatus: 'pending' | 'verified' | 'rejected' | 'expired';
  verifiedBy?: string;
  verifiedAt?: string;
  documentUrl?: string;
  creditHours?: number;
}

interface CPDActivity {
  id: string;
  title: string;
  provider: string;
  date: string;
  hours: number;
  category: 'training' | 'conference' | 'publication' | 'mentoring' | 'examination';
  verificationStatus: 'pending' | 'verified';
  description?: string;
}

interface CertificateApplication {
  status: CertApplicationStatus;
  joinedEviroSafeDate: string;
  educationLevel: EducationLevel;
  educationInstitute: string;
  educationYear: string;
  professionalMemberships: string[];
  hseExperienceMonths: number;
  currentPosition: string;
  organizationType: string;
  industrySector: string;
  previousPositions: Array<{title: string; organization: string; duration: string}>;
  idType: 'National ID' | 'Passport' | 'Driving License';
  idNumber: string;
  idIssuingCountry: string;
  idExpiryDate: string;
  internationalCerts: InternationalCert[];
  competencies: {
    riskAssessment: CompetencyLevel;
    incidentInvestigation: CompetencyLevel;
    auditConduction: CompetencyLevel;
    emergencyResponse: CompetencyLevel;
    legalCompliance: CompetencyLevel;
    environmentalManagement: CompetencyLevel;
    trainingDelivery: CompetencyLevel;
    behavioralSafety: CompetencyLevel;
  };
  docs: {
    idProof?: string;
    educationProof?: string;
    professionalPhoto?: string;
    employerLetter?: string;
    experienceLetters?: string[];
    cvResume?: string;
    passportPhoto?: string;
    backgroundCheck?: string;
  };
  cpdActivities: CPDActivity[];
  cpdHoursCurrentYear: number;
  cpdHoursPreviousYear: number;
  acceptedTerms: boolean;
  acceptedPrivacy: boolean;
  acceptedCodeOfConduct: boolean;
  acceptedContinuousEducation: boolean;
  confirmedTrueInfo: boolean;
  consentForVerification: boolean;
  submittedAt?: string;
  reviewedAt?: string;
  approvedAt?: string;
  rejectedAt?: string;
  approvalNotes?: string;
  reviewerId?: string;
  certificateId?: string;
  certificateLevel?: CertificateLevel;
  certificateIssuedAt?: string;
  certificateValidUntil?: string;
  certificateQRCode?: string;
  accreditationBody?: string;
  certificateVersion?: string;
}

type AccreditationBody = 'IOSH' | 'NEBOSH' | 'BCSP' | 'OHSAS' | 'ANSI' | 'ISO' | 'EviroSafe Global';

const GLOBAL_STANDARDS = {
  MIN_SERVICE_MONTHS: { Trainee: 0, Basic: 6, Professional: 24, Expert: 60, Master: 120, Fellow: 180 },
  MIN_HSE_EXPERIENCE: { Trainee: 0, Basic: 6, Professional: 24, Expert: 60, Master: 120, Fellow: 180 },
  MIN_EDUCATION: { 
    Trainee: 'Secondary', 
    Basic: 'Secondary', 
    Professional: 'Diploma', 
    Expert: 'Bachelor', 
    Master: 'Master', 
    Fellow: 'Master' 
  } as Record<CertificateLevel, EducationLevel>,
  CPD_REQUIREMENTS: { Trainee: 10, Basic: 20, Professional: 30, Expert: 40, Master: 50, Fellow: 60 },
  SAFE_HOURS_REQUIREMENTS: { Trainee: 0, Basic: 1000, Professional: 5000, Expert: 15000, Master: 30000, Fellow: 50000 },
  VALIDITY_PERIODS: { Trainee: 1, Basic: 2, Professional: 3, Expert: 4, Master: 5, Fellow: 5 },
  RECOGNIZED_CERTS: {
    NEBOSH: { level: 'Professional', credit: 40 },
    IOSH: { level: 'Professional', credit: 35 },
    OSHA: { level: 'Basic', credit: 20 },
    CSP: { level: 'Expert', credit: 60 },
    CRSP: { level: 'Expert', credit: 60 },
    CMIOSH: { level: 'Master', credit: 80 },
    'DipNEBOSH': { level: 'Expert', credit: 70 },
    ISO45001: { level: 'Professional', credit: 30 },
  } as Record<string, { level: string; credit: number }>,
};

const ACCREDITATION_REQUIREMENTS = {
  IOSH: { name: 'Institution of Occupational Safety and Health', requirements: ['Continuous CPD', 'Code of Conduct', 'Experience Portfolio', 'Peer Review'], validity: 'Annual renewal', website: 'https://iosh.com' },
  NEBOSH: { name: 'National Examination Board in Occupational Safety and Health', requirements: ['Examination', 'Practical Assessment', 'Experience Evidence'], validity: 'Lifetime with CPD', website: 'https://nebosh.org.uk' },
  BCSP: { name: 'Board of Certified Safety Professionals', requirements: ['Examination', 'Degree Requirement', 'Experience Verification'], validity: '5 years', website: 'https://bcsp.org' }
};

const DEFAULT_APP: CertificateApplication = {
  status: 'draft',
  joinedEviroSafeDate: '',
  educationLevel: 'Secondary',
  educationInstitute: '',
  educationYear: '',
  professionalMemberships: [],
  hseExperienceMonths: 0,
  currentPosition: '',
  organizationType: 'Other',
  industrySector: '',
  previousPositions: [],
  idType: 'National ID',
  idNumber: '',
  idIssuingCountry: '',
  idExpiryDate: '',
  internationalCerts: [],
  competencies: {
    riskAssessment: 'Beginner',
    incidentInvestigation: 'Beginner',
    auditConduction: 'Beginner',
    emergencyResponse: 'Beginner',
    legalCompliance: 'Beginner',
    environmentalManagement: 'Beginner',
    trainingDelivery: 'Beginner',
    behavioralSafety: 'Beginner'
  },
  docs: {},
  cpdActivities: [],
  cpdHoursCurrentYear: 0,
  cpdHoursPreviousYear: 0,
  acceptedTerms: false,
  acceptedPrivacy: false,
  acceptedCodeOfConduct: false,
  acceptedContinuousEducation: false,
  confirmedTrueInfo: false,
  consentForVerification: false
};

// ================================
// 2. HELPER FUNCTIONS
// ================================

function statusColor(status: CertApplicationStatus): 'green' | 'blue' | 'yellow' | 'red' | 'gray' {
  switch (status) {
    case 'approved': return 'green';
    case 'submitted': return 'blue';
    case 'under_review': return 'yellow';
    case 'rejected':
    case 'suspended': return 'red';
    default: return 'gray';
  }
}

function formatDateLong(dateStr: string) {
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return dateStr;
  return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
}

function determineCertificateLevel(profile: CertificationProfile, app: CertificateApplication): CertificateLevel {
  let score = 0;
  score += (app.hseExperienceMonths / 12) * 15;
  score += (profile.safe_working_hours / 1000) * 10;
  
  const educationScores: Record<EducationLevel, number> = {
    'Below Secondary': 0, 'Secondary': 10, 'Diploma': 25, 'Bachelor': 40, 'Master': 60, 'Doctorate': 80
  };
  score += educationScores[app.educationLevel] || 0;
  
  app.internationalCerts.forEach(cert => {
    if (cert.verificationStatus === 'verified') {
      score += GLOBAL_STANDARDS.RECOGNIZED_CERTS[cert.type]?.credit || 10;
    }
  });
  
  score += (app.cpdHoursCurrentYear / 10);
  
  if (score >= 300) return 'Fellow';
  if (score >= 200) return 'Master';
  if (score >= 140) return 'Expert';
  if (score >= 90) return 'Professional';
  if (score >= 50) return 'Basic';
  return 'Trainee';
}

// FIX: Added safety check for 'level' being undefined
function generateCertificateId(level: CertificateLevel, countryCode: string, accreditationBody?: string): string {
  const prefix = accreditationBody ? accreditationBody.substring(0, 3).toUpperCase() : 'EVS';
  const levelCode = (level || 'T').charAt(0); 
  const year = new Date().getFullYear();
  const random = Math.random().toString(36).substring(2, 8).toUpperCase();
  const cc = (countryCode || 'XX').toUpperCase().slice(0, 2);
  return `${prefix}-${levelCode}-${cc}-${year}-${random}`;
}

function getAccreditationBody(level: CertificateLevel): AccreditationBody {
  if (level === 'Fellow' || level === 'Master') return 'BCSP';
  if (level === 'Expert' || level === 'Professional') return 'IOSH';
  return 'EviroSafe Global';
}

function calculateCertificateValidity(level: CertificateLevel, issueDate: string): { validUntil: string; renewalDate: string } {
  const validityYears = GLOBAL_STANDARDS.VALIDITY_PERIODS[level];
  const issue = new Date(issueDate);
  const validUntil = new Date(issue);
  validUntil.setFullYear(issue.getFullYear() + validityYears);
  const renewalDate = new Date(validUntil);
  renewalDate.setMonth(renewalDate.getMonth() - 3);
  return {
    validUntil: validUntil.toISOString().split('T')[0],
    renewalDate: renewalDate.toISOString().split('T')[0]
  };
}

function verifyInternationalCert(cert: InternationalCert): { isValid: boolean; issues: string[]; creditPoints: number; } {
  const issues: string[] = [];
  let creditPoints = 0;
  if (new Date(cert.expiryDate) < new Date()) issues.push('Certificate has expired');
  if (!cert.certificateNumber || !cert.issuingBody || !cert.issueDate) issues.push('Missing required certificate information');
  creditPoints = GLOBAL_STANDARDS.RECOGNIZED_CERTS[cert.type]?.credit || 10;
  return { isValid: issues.length === 0 && cert.verificationStatus === 'verified', issues, creditPoints };
}

function generateQRCodeData(certificateId: string, name: string, level: CertificateLevel, issueDate: string, expiryDate: string): string {
  return JSON.stringify({ certId: certificateId, name, level, issueDate, expiryDate, verificationUrl: `https://verify.evirosafe.org/${certificateId}` });
}

// ================================
// 3. VISUAL COMPONENTS
// ================================

const GlobalStandardsBadge: React.FC<{ standard: string; verified: boolean }> = ({ standard, verified }) => (
  <Badge color={verified ? 'green' : 'gray'} className="flex items-center gap-1">
    {verified ? <CheckCircle className="w-3 h-3" /> : <AlertTriangle className="w-3 h-3" />}
    {standard}
  </Badge>
);

const ProgressBar: React.FC<{ current: number; target: number; label: string; unit?: string; color?: 'green' | 'blue' | 'amber' | 'purple'; }> = ({ current, target, label, unit = '', color = 'green' }) => {
  const percentage = Math.min(100, Math.max(0, (current / target) * 100));
  const colorClasses = { green: 'bg-emerald-500', blue: 'bg-blue-500', amber: 'bg-amber-500', purple: 'bg-purple-500' };
  return (
    <div className="w-full">
      <div className="flex justify-between text-sm mb-2">
        <div className="flex items-center gap-2">
          <span className="text-gray-300">{label}</span>
          {percentage >= 100 && <CheckCircle className="w-4 h-4 text-emerald-400" />}
        </div>
        <span className="text-gray-400">{current.toLocaleString()} / {target.toLocaleString()} {unit}</span>
      </div>
      <div className="w-full bg-gray-800 rounded-full h-2.5">
        <div className={`${colorClasses[color]} h-2.5 rounded-full transition-all duration-500`} style={{ width: `${percentage}%` }} />
      </div>
    </div>
  );
};

const VerificationStatus: React.FC<{ status: string }> = ({ status }) => {
  const config = {
    verified: { color: 'green', icon: ShieldCheck, text: 'Verified' },
    pending: { color: 'yellow', icon: Clock, text: 'Pending Review' },
    rejected: { color: 'red', icon: XCircle, text: 'Rejected' },
    expired: { color: 'gray', icon: AlertTriangle, text: 'Expired' }
  }[status] || { color: 'gray', icon: AlertTriangle, text: 'Unknown' };
  const Icon = config.icon;
  return (
    // @ts-ignore
    <Badge color={config.color as any} className="flex items-center gap-1">
      <Icon className="w-3 h-3" />
      {config.text}
    </Badge>
  );
};

const InternationalCertificateCard: React.FC<{ cert: InternationalCert }> = ({ cert }) => {
  const verification = verifyInternationalCert(cert);
  return (
    <div className="p-4 border border-gray-700 rounded-lg bg-gray-900/50">
      <div className="flex justify-between items-start mb-3">
        <div>
          <h4 className="font-bold text-white">{cert.type}</h4>
          <p className="text-sm text-gray-400">{cert.issuingBody}</p>
        </div>
        <VerificationStatus status={cert.verificationStatus} />
      </div>
      <div className="grid grid-cols-2 gap-2 text-sm">
        <div><span className="text-gray-500">Cert #:</span><span className="ml-2 font-mono text-gray-300">{cert.certificateNumber}</span></div>
        <div><span className="text-gray-500">Level:</span><span className="ml-2 text-white">{cert.level}</span></div>
        <div><span className="text-gray-500">Issued:</span><span className="ml-2 text-gray-300">{new Date(cert.issueDate).toLocaleDateString()}</span></div>
        <div><span className="text-gray-500">Expires:</span><span className="ml-2 text-gray-300">{new Date(cert.expiryDate).toLocaleDateString()}</span></div>
      </div>
      {verification.creditPoints > 0 && (
        <div className="mt-3 p-2 bg-gray-800/50 rounded"><span className="text-sm text-gray-400">Credit Points: </span><span className="text-emerald-400 font-bold">{verification.creditPoints}</span></div>
      )}
    </div>
  );
};

const GoldenSeal: React.FC = () => (
    <div className="relative w-32 h-32 flex items-center justify-center drop-shadow-lg">
      <svg viewBox="0 0 200 200" className="w-full h-full">
        <defs>
          <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="#F1D87E" />
            <stop offset="25%" stopColor="#D4AF37" />
            <stop offset="50%" stopColor="#AA6C39" />
            <stop offset="75%" stopColor="#D4AF37" />
            <stop offset="100%" stopColor="#F1D87E" />
          </linearGradient>
        </defs>
        <polygon points="100,10 115,35 140,30 145,55 170,60 160,85 185,100 160,115 170,140 145,145 140,170 115,165 100,190 85,165 60,170 55,145 30,140 40,115 15,100 40,85 30,60 55,55 60,30 85,35" fill="url(#goldGradient)" stroke="#AA6C39" strokeWidth="2" />
        <circle cx="100" cy="100" r="70" fill="none" stroke="#AA6C39" strokeWidth="2" />
        <circle cx="100" cy="100" r="65" fill="none" stroke="#F1D87E" strokeWidth="1" />
        <path id="textCurveTop" d="M 50,100 A 50,50 0 1,1 150,100" fill="none" />
        <text fontSize="13" fontWeight="bold" fill="#5C3A1E" letterSpacing="1"><textPath xlinkHref="#textCurveTop" startOffset="50%" textAnchor="middle">EVIROSAFE CERTIFIED</textPath></text>
        <path id="textCurveBottom" d="M 45,100 A 55,55 0 0,0 155,100" fill="none" />
        <text fontSize="10" fontWeight="bold" fill="#5C3A1E" letterSpacing="1"><textPath xlinkHref="#textCurveBottom" startOffset="50%" textAnchor="middle">OFFICIAL STANDARD</textPath></text>
        <path transform="translate(85, 80) scale(1.2)" d="M12 2L3 7v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-9-5z" fill="none" stroke="#5C3A1E" strokeWidth="2" />
        <text x="100" y="108" textAnchor="middle" fontSize="16" fontWeight="900" fill="#5C3A1E">ES</text>
      </svg>
    </div>
);

const InternationalCertificateDocument: React.FC<{ profile: CertificationProfile; user: any; app: CertificateApplication; }> = ({ profile, user, app }) => {
  const level = app.certificateLevel || determineCertificateLevel(profile, app);
  const issueDate = app.certificateIssuedAt || new Date().toISOString().slice(0, 10);
  const validUntil = app.certificateValidUntil || new Date().toISOString().slice(0, 10);
  const certId = app.certificateId || generateCertificateId(level, app.idIssuingCountry);
  const qrData = generateQRCodeData(certId, user?.name, level, issueDate, validUntil);

  return (
    <div id="printable-certificate" className="relative mx-auto overflow-hidden shadow-2xl print:shadow-none bg-white" style={{ width: '297mm', height: '210mm', printColorAdjust: 'exact' }}>
      <div className="absolute inset-0 border-[15mm] border-emerald-900" />
      <div className="absolute inset-[5mm] border-[2mm] border-amber-600/30" />
      <div className="absolute inset-0 opacity-5" style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2300597c' fill-opacity='0.4'/%3E%3C/svg%3E")` }}></div>
      <div className="relative z-10 h-full px-20 py-16 flex flex-col justify-between font-serif">
        <div className="text-center space-y-4">
            <div className="flex justify-center items-center gap-3 mb-2">
                 <img src="/icons/evirosafe-512.png" alt="Logo" className="h-16 w-16 drop-shadow-md" />
                 <div className="text-left">
                     <h2 className="text-2xl font-bold text-emerald-900 uppercase tracking-widest leading-none">EviroSafe</h2>
                     <p className="text-[10px] text-[#c5a059] font-bold uppercase tracking-[0.3em]">International Safety Standards</p>
                 </div>
            </div>
            <div className="border-b-2 border-[#c5a059] w-24 mx-auto mb-6"></div>
            <h1 className="text-5xl font-black text-emerald-950 uppercase tracking-wider font-serif" style={{ textShadow: '1px 1px 0px rgba(197, 160, 89, 0.5)' }}>Certificate of Competence</h1>
            <p className="text-lg text-emerald-800 italic font-medium">Health, Safety & Environment Proficiency</p>
        </div>
        <div className="text-center mt-4">
            <p className="text-sm text-slate-500 uppercase tracking-widest mb-4">This certifies that</p>
            <div className="relative inline-block px-12 py-2">
                {/* FIX: Added safety check for user.name */}
                <h2 className="text-4xl font-bold text-slate-900 font-serif border-b-2 border-slate-900/10 pb-2 mb-2">{(user?.name || 'Recipient Name').toUpperCase()}</h2>
                <div className="w-full h-1 bg-gradient-to-r from-transparent via-[#c5a059] to-transparent opacity-50"></div>
            </div>
            <p className="mt-6 text-sm text-slate-700 max-w-3xl mx-auto leading-loose">
                Has successfully fulfilled the rigorous requirements set forth by the <strong>EviroSafe Global Certification Board</strong>. 
                The holder has demonstrated exceptional knowledge, practical experience, and commitment to maintaining the highest 
                standards of operational safety and risk management in accordance with <strong> ISO 45001:2018</strong> frameworks.
            </p>
            <div className="mt-8 flex justify-center gap-8">
                <div className="px-6 py-2 border border-[#c5a059] rounded bg-[#fffdf5] shadow-sm">
                    <span className="block text-[10px] uppercase text-[#c5a059] font-bold tracking-wider">Certification Level</span>
                    <span className="block text-xl font-bold text-emerald-900">{level}</span>
                </div>
                <div className="px-6 py-2 border border-[#c5a059] rounded bg-[#fffdf5] shadow-sm">
                    <span className="block text-[10px] uppercase text-[#c5a059] font-bold tracking-wider">Specialization</span>
                    <span className="block text-xl font-bold text-emerald-900">{profile.role_title || 'General HSE'}</span>
                </div>
            </div>
        </div>
        <div className="mt-auto pt-8 flex items-end justify-between border-t border-emerald-900/10">
            <div className="text-center">
                 <div className="w-48 border-b border-slate-400 mb-2">
                     <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Signature_sample.svg" alt="Sig" className="h-10 mx-auto opacity-70" />
                 </div>
                 <p className="text-xs font-bold text-emerald-900 uppercase">Director of Certification</p>
                 <p className="text-[10px] text-slate-500">EviroSafe Global HQ</p>
            </div>
            <div className="flex flex-col items-center mb-1"><GoldenSeal /></div>
            <div className="text-right flex flex-col items-end">
                <img 
                    src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}&color=064e3b`}
                    alt="Verification QR"
                    className="w-20 h-20"
                />
                <div className="mt-2 text-[10px] text-slate-600 font-mono">
                    <p>Issue Date: <span className="font-bold">{formatDateLong(issueDate)}</span></p>
                    <p>Expiry Date: <span className="font-bold">{formatDateLong(validUntil)}</span></p>
                    <p className="mt-1 text-[#c5a059] font-bold">Verify at evirosafe.org/verify</p>
                </div>
            </div>
        </div>
        <div className="absolute bottom-0 left-0 right-0 h-3 bg-gradient-to-r from-emerald-900 via-[#c5a059] to-emerald-900"></div>
      </div>
    </div>
  );
};

// ================================
// 4. MAIN COMPONENT
// ================================
export const CertifiedProfile: React.FC = () => {
  const { activeUser } = useAppContext();
  const [activeTab, setActiveTab] = useState<'overview' | 'requirements' | 'evidence' | 'certificate' | 'verification' | 'cpd'>('overview');
  const [profile] = useState<CertificationProfile>(mockProfile);
  const [aiInsight, setAiInsight] = useState<{ nextLevelRecommendation: string; missingItems: string[]; globalStandardsMet: string[]; improvementAreas: string[]; } | null>(null);
  const [loadingInsight, setLoadingInsight] = useState(false);
  const [verificationFile, setVerificationFile] = useState<File | null>(null);
  const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

  const storageKey = useMemo(() => `evirosafe_cert_app_${activeUser?.id || 'anonymous'}`, [activeUser?.id]);
  const [app, setApp] = useState<CertificateApplication>(DEFAULT_APP);
  const [reviewNote, setReviewNote] = useState('');
  const [verificationStep, setVerificationStep] = useState(1);
  const [selectedCertType, setSelectedCertType] = useState<InternationalCertType>('OSHA');

  useEffect(() => {
    try {
      const raw = localStorage.getItem(storageKey);
      if (raw) setApp((prev) => ({ ...prev, ...JSON.parse(raw) }));
    } catch (e) { console.error(e); }
  }, [storageKey]);

  useEffect(() => {
    try {
      localStorage.setItem(storageKey, JSON.stringify(app));
    } catch (e) { console.error(e); }
  }, [app, storageKey]);

  useEffect(() => {
    const run = async () => {
      setLoadingInsight(true);
      try {
        const insight = await generateCertificationInsight(profile);
        setAiInsight(insight);
      } catch (e) { console.error("AI Insight failed", e); }
      setLoadingInsight(false);
    };
    run();
  }, [profile]);

  const eligibility = useMemo(() => {
    const issues: string[] = [];
    const warnings: string[] = [];
    const level = determineCertificateLevel(profile, app);
    const targetLevel = app.certificateLevel || level;
    
    const serviceMonths = app.joinedEviroSafeDate ? Math.floor((new Date().getTime() - new Date(app.joinedEviroSafeDate).getTime()) / (1000 * 60 * 60 * 24 * 30)) : 0;
    if (serviceMonths < GLOBAL_STANDARDS.MIN_SERVICE_MONTHS[targetLevel]) issues.push(`Minimum service required for ${targetLevel}: ${GLOBAL_STANDARDS.MIN_SERVICE_MONTHS[targetLevel]} months`);
    if (app.hseExperienceMonths < GLOBAL_STANDARDS.MIN_HSE_EXPERIENCE[targetLevel]) issues.push(`Minimum HSE experience for ${targetLevel}: ${GLOBAL_STANDARDS.MIN_HSE_EXPERIENCE[targetLevel]} months`);
    
    const educationRank: Record<EducationLevel, number> = { 'Below Secondary': 0, 'Secondary': 1, 'Diploma': 2, 'Bachelor': 3, 'Master': 4, 'Doctorate': 5 };
    if (educationRank[app.educationLevel] < educationRank[GLOBAL_STANDARDS.MIN_EDUCATION[targetLevel]]) issues.push(`Minimum education for ${targetLevel}: ${GLOBAL_STANDARDS.MIN_EDUCATION[targetLevel]}`);
    
    if (profile.safe_working_hours < GLOBAL_STANDARDS.SAFE_HOURS_REQUIREMENTS[targetLevel]) issues.push(`Minimum safe working hours for ${targetLevel}: ${GLOBAL_STANDARDS.SAFE_HOURS_REQUIREMENTS[targetLevel]} hours`);
    
    const requiredCpd = GLOBAL_STANDARDS.CPD_REQUIREMENTS[targetLevel];
    if (app.cpdHoursCurrentYear < requiredCpd) warnings.push(`CPD hours for ${targetLevel}: ${app.cpdHoursCurrentYear}/${requiredCpd} hours`);
    
    const requiredDocs = ['idProof', 'educationProof', 'professionalPhoto', 'employerLetter'];
    const missingDocs = requiredDocs.filter(doc => !app.docs[doc as keyof typeof app.docs]);
    if (missingDocs.length > 0) issues.push(`Missing required documents: ${missingDocs.join(', ')}`);
    
    const declarations = ['acceptedTerms', 'acceptedPrivacy', 'acceptedCodeOfConduct', 'acceptedContinuousEducation', 'confirmedTrueInfo', 'consentForVerification'];
    const missingDeclarations = declarations.filter(d => !app[d as keyof CertificateApplication]);
    if (missingDeclarations.length > 0) issues.push(`Missing declarations`);

    return { serviceMonths, issues, warnings, isEligible: issues.length === 0, currentLevel: level, targetLevel };
  }, [app, profile, verificationFile]);

  const canSubmit = app.status === 'draft' && eligibility.isEligible;

  const handleSubmit = () => {
    if (!canSubmit) return;
    const level = determineCertificateLevel(profile, app);
    const accreditationBody = getAccreditationBody(level);
    const certificateId = generateCertificateId(level, app.idIssuingCountry, accreditationBody);
    const issueDate = new Date().toISOString().split('T')[0];
    const validity = calculateCertificateValidity(level, issueDate);
    setApp(prev => ({ ...prev, status: 'submitted', submittedAt: new Date().toISOString(), certificateLevel: level, certificateId, certificateIssuedAt: issueDate, certificateValidUntil: validity.validUntil, accreditationBody }));
    setActiveTab('overview');
  };

  const isAdmin = String(activeUser?.role || '').toUpperCase() === 'ADMIN';

  const handleApprove = () => {
    if (!isAdmin) return;
    const level = determineCertificateLevel(profile, app);
    const accreditationBody = getAccreditationBody(level);
    const certificateId = generateCertificateId(level, app.idIssuingCountry, accreditationBody);
    const issueDate = new Date().toISOString().split('T')[0];
    const validity = calculateCertificateValidity(level, issueDate);
    // FIX: Added safety check for activeUser?.name
    const qrData = generateQRCodeData(certificateId, activeUser?.name || 'Admin', level, issueDate, validity.validUntil);
    setApp(prev => ({ ...prev, status: 'approved', approvedAt: new Date().toISOString(), approvalNotes: reviewNote, certificateLevel: level, certificateId, certificateIssuedAt: issueDate, certificateValidUntil: validity.validUntil, accreditationBody, certificateQRCode: qrData }));
    setActiveTab('certificate');
  };

  const handleReject = () => {
    if (!isAdmin) return;
    setApp(prev => ({ ...prev, status: 'rejected', rejectedAt: new Date().toISOString(), approvalNotes: reviewNote }));
    setActiveTab('overview');
  };

  const handleDownloadPDF = async () => {
    setIsGeneratingPdf(true);
    await generatePdf('printable-certificate', `EviroSafe-Certificate-${app.certificateId}`);
    setIsGeneratingPdf(false);
  };

  const handlePrint = () => {
    const content = document.getElementById('printable-certificate');
    if (!content) return;
    const printWindow = window.open('', '_blank', 'height=900,width=1200');
    if (!printWindow) return;
    printWindow.document.write(`<html><head><title>EviroSafe Certificate</title><link href="https://cdn.tailwindcss.com" rel="stylesheet"><style>@media print {@page { size: landscape; margin: 0; } body { margin: 0; padding: 0; } #printable-certificate { width: 100%; height: 100%; }}</style></head><body class="bg-white">${content.outerHTML}</body></html>`);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
  };

  const addInternationalCert = () => {
    const newCert: InternationalCert = { type: selectedCertType, certificateNumber: '', issuingBody: '', issueDate: new Date().toISOString().split('T')[0], expiryDate: new Date(new Date().setFullYear(new Date().getFullYear() + 5)).toISOString().split('T')[0], level: 'Professional', verificationStatus: 'pending' };
    setApp(prev => ({ ...prev, internationalCerts: [...prev.internationalCerts, newCert] }));
  };

  const updateCert = (index: number, updates: Partial<InternationalCert>) => {
    setApp(prev => ({ ...prev, internationalCerts: prev.internationalCerts.map((cert, i) => i === index ? { ...cert, ...updates } : cert) }));
  };

  const addCPDActivity = () => {
    const newActivity: CPDActivity = { id: `cpd_${Date.now()}`, title: '', provider: '', date: new Date().toISOString().split('T')[0], hours: 0, category: 'training', verificationStatus: 'pending' };
    setApp(prev => ({ ...prev, cpdActivities: [...prev.cpdActivities, newActivity] }));
  };

  const calculateCPDHours = () => {
    const currentYear = new Date().getFullYear();
    const currentYearHours = app.cpdActivities.filter(a => new Date(a.date).getFullYear() === currentYear && a.verificationStatus === 'verified').reduce((sum, a) => sum + a.hours, 0);
    const previousYearHours = app.cpdActivities.filter(a => new Date(a.date).getFullYear() === currentYear - 1 && a.verificationStatus === 'verified').reduce((sum, a) => sum + a.hours, 0);
    setApp(prev => ({ ...prev, cpdHoursCurrentYear: currentYearHours, cpdHoursPreviousYear: previousYearHours }));
  };

  if (!activeUser) return <div className="p-8 text-center text-gray-400">Please sign in.</div>;

  return (
    <div className="max-w-7xl mx-auto p-6 space-y-6">
      <div className="bg-gradient-to-r from-gray-900 to-emerald-900/50 rounded-2xl p-6 border border-gray-800">
        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
          <div className="flex items-start gap-4">
            <div className="p-3 rounded-xl bg-emerald-900/30 border border-emerald-700/50"><Award className="w-8 h-8 text-emerald-400" /></div>
            <div>
              <h1 className="text-3xl font-bold text-white">Global Certification System</h1>
              <p className="text-gray-300 mt-1 flex items-center gap-2"><Globe className="w-4 h-4" /> Internationally recognized certifications â€¢ ISO 17024 compliant â€¢ Global verification</p>
              <div className="flex flex-wrap gap-2 mt-3">
                <Badge color="blue">ISO 17024</Badge><Badge color="green">Global Recognition</Badge><Badge color="purple">Blockchain Verified</Badge><Badge color="amber">Digital Credentials</Badge>
              </div>
            </div>
          </div>
          <div className="flex flex-col gap-2">
            <div className="text-right"><div className="text-sm text-gray-400">Current Status</div><Badge color={statusColor(app.status)} className="text-lg px-4 py-1.5">{app.status.toUpperCase().replace(/_/g, ' ')}</Badge></div>
            {app.certificateLevel && <div className="text-right"><div className="text-sm text-gray-400">Certification Level</div><div className="text-xl font-bold text-white">{app.certificateLevel}</div></div>}
          </div>
        </div>
      </div>

      <div className="bg-gray-900/50 rounded-xl p-2 border border-gray-800">
        <div className="flex overflow-x-auto gap-1 pb-2">
          {[{ key: 'overview', label: 'Dashboard', icon: BarChart }, { key: 'requirements', label: 'Global Standards', icon: Target }, { key: 'evidence', label: 'Application', icon: FileText }, { key: 'verification', label: 'Verification', icon: ShieldCheck }, { key: 'cpd', label: 'CPD Tracker', icon: BookOpen }, { key: 'certificate', label: 'Certificate', icon: Award }].map(tab => {
            const Icon = tab.icon;
            return <button key={tab.key} onClick={() => setActiveTab(tab.key as any)} className={`flex items-center gap-2 px-4 py-3 rounded-lg font-medium transition-all whitespace-nowrap ${activeTab === tab.key ? 'bg-emerald-900/50 text-emerald-300 border border-emerald-700/50' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}><Icon className="w-4 h-4" />{tab.label}</button>;
          })}
        </div>
      </div>

      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 space-y-6">
            <Card title="Certification Progress">
              <div className="space-y-6">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-4">
                    {/* FIX: Safety check for charAt */}
                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-emerald-900 to-cyan-900 flex items-center justify-center text-2xl font-bold text-white">{(activeUser.name || 'U').charAt(0)}</div>
                    <div><div className="text-2xl font-bold text-white">{activeUser.name}</div><div className="text-gray-400">{profile.role_title}</div><div className="text-sm text-gray-500 mt-1">Member since: {app.joinedEviroSafeDate || 'Not specified'}</div></div>
                  </div>
                  <div className="text-right"><div className="text-sm text-gray-400">Target Level</div><div className="text-2xl font-bold text-emerald-400">{eligibility.targetLevel}</div><div className="text-xs text-gray-500 mt-1">Current: {eligibility.currentLevel}</div></div>
                </div>
                <div className="space-y-4">
                  <ProgressBar current={profile.safe_working_hours} target={GLOBAL_STANDARDS.SAFE_HOURS_REQUIREMENTS[eligibility.targetLevel]} label="Safe Working Hours" unit="hours" color="green" />
                  <ProgressBar current={eligibility.serviceMonths} target={GLOBAL_STANDARDS.MIN_SERVICE_MONTHS[eligibility.targetLevel]} label="Service Months" unit="months" color="blue" />
                  <ProgressBar current={app.cpdHoursCurrentYear} target={GLOBAL_STANDARDS.CPD_REQUIREMENTS[eligibility.targetLevel]} label="CPD Hours (Current Year)" unit="hours" color="purple" />
                  <ProgressBar current={app.hseExperienceMonths} target={GLOBAL_STANDARDS.MIN_HSE_EXPERIENCE[eligibility.targetLevel]} label="HSE Experience" unit="months" color="amber" />
                </div>
                {eligibility.issues.length > 0 && <div className="mt-6 p-4 rounded-xl border border-red-400/40 bg-red-500/10"><div className="flex items-center gap-2 mb-2"><AlertTriangle className="w-5 h-5 text-red-400" /><div className="font-bold text-red-200">Eligibility Requirements Missing</div></div><ul className="text-sm text-red-100 space-y-1">{eligibility.issues.map((x, i) => <li key={i} className="flex items-start gap-2"><XCircle className="w-3 h-3 mt-1 flex-shrink-0" />{x}</li>)}</ul><div className="mt-4"><Button variant="outline" onClick={() => setActiveTab('evidence')}>Complete Application</Button></div></div>}
              </div>
            </Card>
          </div>
          <div className="space-y-6">
            <Card title="Quick Actions">
              <div className="space-y-3">
                <Button variant="outline" onClick={() => setActiveTab('evidence')} className="w-full justify-start" leftIcon={<FileText className="w-4 h-4" />}>Continue Application</Button>
                <Button variant="outline" onClick={() => setActiveTab('verification')} className="w-full justify-start" leftIcon={<ShieldCheck className="w-4 h-4" />}>Upload Verification</Button>
                <Button variant="outline" onClick={() => setActiveTab('cpd')} className="w-full justify-start" leftIcon={<BookOpen className="w-4 h-4" />}>Log CPD Hours</Button>
                <Button variant="outline" onClick={handleSubmit} disabled={!canSubmit} className="w-full justify-start" leftIcon={<CheckCircle className="w-4 h-4" />}>Submit Application</Button>
              </div>
            </Card>
            <Card title="Global Standards Met">
              <div className="space-y-2">
                <GlobalStandardsBadge standard="ISO 17024" verified={true} />
                <GlobalStandardsBadge standard="Continuous CPD" verified={app.cpdHoursCurrentYear >= 20} />
                <GlobalStandardsBadge standard="Experience Portfolio" verified={app.hseExperienceMonths >= 24} />
                <GlobalStandardsBadge standard="International Recognition" verified={app.internationalCerts.length > 0} />
                <GlobalStandardsBadge standard="Digital Verification" verified={app.certificateQRCode !== undefined} />
              </div>
            </Card>
          </div>
        </div>
      )}

      {activeTab === 'requirements' && (
        <Card title="Global Certification Standards & Requirements">
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {Object.entries(ACCREDITATION_REQUIREMENTS).map(([key, body]) => (
                <div key={key} className="p-4 border border-gray-700 rounded-xl bg-gray-900/50">
                  <div className="flex items-center gap-3 mb-3"><Shield className="w-8 h-8 text-emerald-400" /><div><h3 className="font-bold text-white">{body.name}</h3><p className="text-sm text-gray-400">{key}</p></div></div>
                  <div className="space-y-2 mb-4"><h4 className="text-sm font-bold text-gray-300">Requirements:</h4><ul className="text-sm text-gray-400 space-y-1">{body.requirements.map((req, i) => <li key={i} className="flex items-center gap-2"><CheckCircle className="w-3 h-3 text-emerald-400" />{req}</li>)}</ul></div>
                  <div className="text-sm text-gray-400"><span className="font-bold">Validity:</span> {body.validity}</div>
                  <a href={body.website} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 text-sm text-emerald-400 hover:text-emerald-300 mt-2">Visit website <ExternalLink className="w-3 h-3" /></a>
                </div>
              ))}
            </div>
          </div>
        </Card>
      )}

      {activeTab === 'evidence' && (
        <Card title="Global Certification Application">
          <div className="space-y-8">
            <div className="flex items-center justify-between">
              {['Personal', 'Experience', 'Certifications', 'Documents', 'Review'].map((step, index) => (
                <div key={step} className="flex flex-col items-center">
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${verificationStep > index + 1 ? 'bg-emerald-900 text-emerald-300' : verificationStep === index + 1 ? 'bg-emerald-700 text-white' : 'bg-gray-800 text-gray-400'}`}>{verificationStep > index + 1 ? 'âœ“' : index + 1}</div>
                  <div className="text-xs mt-1 text-gray-400">{step}</div>
                </div>
              ))}
            </div>
            {verificationStep === 1 && (
              <div className="space-y-4">
                <h3 className="text-lg font-bold text-white">Personal Information</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label className="block text-sm text-gray-400 mb-1">Full Name</label><input type="text" value={activeUser?.name || ''} disabled className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-gray-300" /></div>
                  <div><label className="block text-sm text-gray-400 mb-1">Email</label><input type="email" value={activeUser?.email || ''} disabled className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-gray-300" /></div>
                  <div><label className="block text-sm text-gray-400 mb-1">Education Level</label><select value={app.educationLevel} onChange={e => setApp(p => ({...p, educationLevel: e.target.value as EducationLevel}))} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white"><option value="Secondary">Secondary</option><option value="Diploma">Diploma</option><option value="Bachelor">Bachelor's Degree</option><option value="Master">Master's Degree</option><option value="Doctorate">Doctorate</option></select></div>
                  <div><label className="block text-sm text-gray-400 mb-1">Institution</label><input type="text" value={app.educationInstitute} onChange={e => setApp(p => ({...p, educationInstitute: e.target.value}))} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white" placeholder="University/College name" /></div>
                </div>
                <div className="flex justify-between"><Button variant="outline" onClick={() => setVerificationStep(5)}>Skip to Review</Button><Button onClick={() => setVerificationStep(2)}>Next: Experience</Button></div>
              </div>
            )}
            {verificationStep === 2 && (
              <div className="space-y-4">
                <h3 className="text-lg font-bold text-white">Professional Experience</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label className="block text-sm text-gray-400 mb-1">HSE Experience (Months)</label><input type="number" value={app.hseExperienceMonths} onChange={e => setApp(p => ({...p, hseExperienceMonths: parseInt(e.target.value) || 0}))} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white" /></div>
                  <div><label className="block text-sm text-gray-400 mb-1">Current Position</label><input type="text" value={app.currentPosition} onChange={e => setApp(p => ({...p, currentPosition: e.target.value}))} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white" /></div>
                </div>
                <div className="flex justify-between"><Button variant="outline" onClick={() => setVerificationStep(1)}>Back</Button><Button onClick={() => setVerificationStep(3)}>Next: Certifications</Button></div>
              </div>
            )}
            {verificationStep === 3 && (
              <div className="space-y-4">
                <div className="flex justify-between items-center"><h3 className="text-lg font-bold text-white">International Certifications</h3><Button variant="outline" onClick={addInternationalCert} leftIcon={<Plus className="w-4 h-4" />}>Add Certification</Button></div>
                <div className="space-y-4">
                  {app.internationalCerts.map((cert, index) => (
                    <div key={index} className="p-4 border border-gray-700 rounded-lg bg-gray-900/30">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label className="block text-sm text-gray-400 mb-1">Certification Type</label><select value={cert.type} onChange={e => updateCert(index, { type: e.target.value as InternationalCertType })} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white"><option value="NEBOSH">NEBOSH</option><option value="IOSH">IOSH</option><option value="OSHA">OSHA</option><option value="Other">Other</option></select></div>
                        <div><label className="block text-sm text-gray-400 mb-1">Certificate Number</label><input type="text" value={cert.certificateNumber} onChange={e => updateCert(index, { certificateNumber: e.target.value })} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white" /></div>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="flex justify-between"><Button variant="outline" onClick={() => setVerificationStep(2)}>Back</Button><Button onClick={() => setVerificationStep(4)}>Next: Documents</Button></div>
              </div>
            )}
            {verificationStep === 4 && (
              <div className="space-y-4">
                <h3 className="text-lg font-bold text-white">Required Documents</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {[{ key: 'idProof', label: 'Government ID Proof', required: true }, { key: 'educationProof', label: 'Education Certificate', required: true }].map((doc) => (
                    <div key={doc.key} className="p-4 border border-gray-700 rounded-lg"><div className="flex items-center justify-between mb-2"><span className="text-white">{doc.label}</span>{doc.required && <Badge color="red" size="sm">Required</Badge>}</div><input type="file" className="w-full text-gray-400 text-sm" onChange={(e) => { const file = e.target.files?.[0]; if (file) setApp(p => ({ ...p, docs: { ...p.docs, [doc.key]: URL.createObjectURL(file) } })); }} /></div>
                  ))}
                </div>
                <div className="flex justify-between"><Button variant="outline" onClick={() => setVerificationStep(3)}>Back</Button><Button onClick={() => setVerificationStep(5)}>Next: Review</Button></div>
              </div>
            )}
            {verificationStep === 5 && (
              <div className="space-y-6">
                <h3 className="text-lg font-bold text-white">Review & Submit</h3>
                <div className="p-4 border border-gray-700 rounded-lg"><h4 className="font-bold text-white mb-3">Declarations</h4><div className="space-y-3"><label className="flex items-center gap-3 text-gray-300 hover:text-white cursor-pointer"><input type="checkbox" checked={app.acceptedTerms} onChange={(e) => setApp(p => ({ ...p, acceptedTerms: e.target.checked }))} className="w-4 h-4 text-emerald-500 bg-gray-800 border-gray-700 rounded focus:ring-emerald-500" />I accept the Terms and Conditions</label></div></div>
                <div className="flex justify-between"><Button variant="outline" onClick={() => setVerificationStep(4)}>Back</Button><Button onClick={handleSubmit} disabled={!canSubmit} className={!canSubmit ? 'opacity-50 cursor-not-allowed' : ''} leftIcon={<CheckCircle className="w-4 h-4" />}>Submit Application</Button></div>
              </div>
            )}
          </div>
        </Card>
      )}

      {activeTab === 'verification' && (
        <Card title="Verification Portal">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <h3 className="text-lg font-bold text-white">International Certification Verification</h3>
              <div className="p-6 border-2 border-dashed border-emerald-700/30 rounded-xl bg-emerald-900/10">
                <div className="text-center mb-4"><ShieldCheck className="w-12 h-12 text-emerald-400 mx-auto mb-3" /><h4 className="font-bold text-white">Upload Certification for Verification</h4></div>
                <div className="space-y-4">
                  <div><label className="block text-sm text-gray-400 mb-2">Select Certification Type</label><select value={selectedCertType} onChange={e => setSelectedCertType(e.target.value as InternationalCertType)} className="w-full bg-gray-900/50 border border-gray-700 rounded p-2 text-white"><option value="NEBOSH">NEBOSH</option><option value="IOSH">IOSH</option><option value="OSHA">OSHA</option></select></div>
                  <div><label className="block text-sm text-gray-400 mb-2">Upload Certificate</label><div className="border border-gray-700 rounded-lg p-4 bg-gray-900/30"><input type="file" accept=".pdf,.jpg,.png,.jpeg" onChange={e => setVerificationFile(e.target.files?.[0] || null)} className="w-full text-gray-400" /></div></div>
                </div>
              </div>
              <div className="space-y-4"><h4 className="font-bold text-white">Verification Status</h4><div className="space-y-3">{app.internationalCerts.map((cert, index) => <InternationalCertificateCard key={index} cert={cert} />)}</div></div>
            </div>
          </div>
        </Card>
      )}

      {activeTab === 'cpd' && (
        <Card title="Continuous Professional Development (CPD) Tracker">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <div className="flex justify-between items-center"><h3 className="text-lg font-bold text-white">CPD Activities</h3><Button variant="outline" onClick={addCPDActivity} leftIcon={<Plus className="w-4 h-4" />}>Add Activity</Button></div>
              <div className="space-y-4">{app.cpdActivities.map((activity, index) => <div key={activity.id} className="p-4 border border-gray-700 rounded-lg bg-gray-900/30"><h4 className="font-bold text-white">{activity.title || 'Untitled Activity'}</h4></div>)}</div>
            </div>
            <div className="space-y-6"><Card title="CPD Summary"><div className="space-y-4"><div className="p-4 bg-gray-900/50 rounded-lg"><div className="text-center mb-3"><div className="text-3xl font-bold text-emerald-400">{app.cpdHoursCurrentYear}</div><div className="text-sm text-gray-400">Hours This Year</div></div><ProgressBar current={app.cpdHoursCurrentYear} target={GLOBAL_STANDARDS.CPD_REQUIREMENTS[eligibility.targetLevel]} label="Annual Target" unit="hours" /></div><Button onClick={calculateCPDHours} className="w-full" leftIcon={<RefreshCw className="w-4 h-4" />}>Recalculate CPD Hours</Button></div></Card></div>
          </div>
        </Card>
      )}

      {activeTab === 'certificate' && (
        <div className="space-y-6">
          {app.status === 'approved' ? (
            <div className="bg-white rounded-xl overflow-hidden shadow-2xl">
              <InternationalCertificateDocument profile={profile} user={activeUser} app={app} />
            </div>
          ) : (
            <Card>
              <div className="text-center py-12">
                <Clock className="w-16 h-16 text-amber-400 mx-auto mb-4" />
                <h3 className="text-xl font-bold text-white mb-2">Application Under Review</h3>
                <p className="text-gray-400">Your certification application is currently being reviewed.</p>
              </div>
            </Card>
          )}
        </div>
      )}

      {isAdmin && app.status === 'submitted' && (
        <Card title="Admin Review Panel" className="mt-6 border border-emerald-800/50">
          <div className="space-y-4">
            <div><label className="block text-sm text-gray-400 mb-2">Review Notes</label><textarea value={reviewNote} onChange={e => setReviewNote(e.target.value)} className="w-full h-32 bg-gray-900/50 border border-gray-700 rounded p-3 text-white" placeholder="Enter review notes..." /></div>
            <div className="grid grid-cols-2 gap-4"><Button onClick={handleApprove} className="bg-emerald-900 hover:bg-emerald-800 border-emerald-700" leftIcon={<CheckCircle className="w-4 h-4" />}>Approve & Issue Certificate</Button><Button variant="danger" onClick={handleReject} leftIcon={<XCircle className="w-4 h-4" />}>Reject Application</Button></div>
          </div>
        </Card>
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistAISuggestor.tsx
==================================================

import React, { useState } from 'react';
import { Button } from './ui/Button';
import { Loader2, Zap, Target, Shield, AlertTriangle, Brain } from 'lucide-react';

interface ChecklistAISuggestorProps {
  isOpen: boolean;
  onClose: () => void;
  onGenerate: (criteria: any) => void;
  projectType?: string;
  workType?: string;
}

export const ChecklistAISuggestor: React.FC<ChecklistAISuggestorProps> = ({
  isOpen,
  onClose,
  onGenerate,
  projectType,
  workType
}) => {
  const [step, setStep] = useState(1);
  const [isGenerating, setIsGenerating] = useState(false);
  const [criteria, setCriteria] = useState({
    workType: workType || '',
    hazards: [] as string[],
    regulations: ['OSHA', 'ISO 45001'],
    complexity: 'Medium',
    teamSize: '5-10',
    duration: '1-4 hours'
  });

  const hazardOptions = [
    'Work at Height', 'Electrical', 'Chemical', 'Fire', 'Confined Space',
    'Heavy Machinery', 'Excavation', 'Lifting Operations', 'Hot Work',
    'Noise Exposure', 'Dust/Silica', 'Extreme Temperatures', 'Biological'
  ];

  const regulationOptions = [
    'OSHA', 'ISO 45001', 'ISO 14001', 'ANSI', 'NEBOSH', 
    'Local Regulations', 'Client Standards', 'Industry Best Practices'
  ];

  const generateAIItems = () => {
    setIsGenerating(true);
    // Simulate AI generation
    setTimeout(() => {
      onGenerate(criteria);
      setIsGenerating(false);
    }, 2000);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 z-[60] flex justify-center items-center p-4">
      <div className="bg-gradient-to-br from-white to-gray-50 dark:from-gray-900 dark:to-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl">
        <div className="p-6 border-b dark:border-gray-800">
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center mr-4">
                <Brain className="w-6 h-6 text-white" />
              </div>
              <div>
                <h3 className="text-xl font-bold text-gray-900 dark:text-white">
                  AI Checklist Generator
                </h3>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Generate custom checklists based on your specific requirements
                </p>
              </div>
            </div>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              âœ•
            </button>
          </div>
        </div>

        <div className="p-6">
          {/* Progress Steps */}
          <div className="flex items-center justify-between mb-8 relative">
            <div className="absolute top-4 left-0 right-0 h-0.5 bg-gray-200 dark:bg-gray-700"></div>
            {[1, 2, 3].map((s) => (
              <div key={s} className="relative z-10">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                  step >= s 
                    ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white' 
                    : 'bg-gray-200 dark:bg-gray-700 text-gray-500'
                }`}>
                  {step > s ? 'âœ“' : s}
                </div>
                <div className="text-xs text-center mt-2">
                  {s === 1 ? 'Work Details' : s === 2 ? 'Hazards' : 'Generate'}
                </div>
              </div>
            ))}
          </div>

          {/* Step 1: Work Details */}
          {step === 1 && (
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Work Type / Activity
                </label>
                <input
                  type="text"
                  value={criteria.workType}
                  onChange={(e) => setCriteria({...criteria, workType: e.target.value})}
                  placeholder="e.g., Scaffolding Erection, Confined Space Entry, Electrical Installation"
                  className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-800 dark:text-white"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Team Size
                  </label>
                  <select 
                    value={criteria.teamSize}
                    onChange={(e) => setCriteria({...criteria, teamSize: e.target.value})}
                    className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-800 dark:text-white"
                  >
                    <option value="1-5">1-5 workers</option>
                    <option value="5-10">5-10 workers</option>
                    <option value="10-20">10-20 workers</option>
                    <option value="20+">20+ workers</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Work Duration
                  </label>
                  <select 
                    value={criteria.duration}
                    onChange={(e) => setCriteria({...criteria, duration: e.target.value})}
                    className="w-full p-3 border border-gray-300 dark:border-gray-700 rounded-lg dark:bg-gray-800 dark:text-white"
                  >
                    <option value="<1 hour">Less than 1 hour</option>
                    <option value="1-4 hours">1-4 hours</option>
                    <option value="4-8 hours">4-8 hours</option>
                    <option value="Multiple days">Multiple days</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Risk Complexity
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {['Low', 'Medium', 'High'].map(level => (
                    <button
                      key={level}
                      type="button"
                      onClick={() => setCriteria({...criteria, complexity: level})}
                      className={`p-3 rounded-lg border ${
                        criteria.complexity === level
                          ? level === 'Low' ? 'border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300'
                          : level === 'Medium' ? 'border-amber-500 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300'
                          : 'border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300'
                          : 'border-gray-300 dark:border-gray-700'
                      }`}
                    >
                      <div className="flex flex-col items-center">
                        {level === 'Low' && <Shield className="w-5 h-5 mb-1" />}
                        {level === 'Medium' && <Target className="w-5 h-5 mb-1" />}
                        {level === 'High' && <AlertTriangle className="w-5 h-5 mb-1" />}
                        <span className="text-sm font-medium">{level}</span>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Step 2: Hazards & Regulations */}
          {step === 2 && (
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                  Select Applicable Hazards
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {hazardOptions.map(hazard => (
                    <button
                      key={hazard}
                      type="button"
                      onClick={() => {
                        const newHazards = criteria.hazards.includes(hazard)
                          ? criteria.hazards.filter(h => h !== hazard)
                          : [...criteria.hazards, hazard];
                        setCriteria({...criteria, hazards: newHazards});
                      }}
                      className={`p-2 rounded-lg border text-sm ${
                        criteria.hazards.includes(hazard)
                          ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300'
                          : 'border-gray-300 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-600'
                      }`}
                    >
                      {hazard}
                    </button>
                  ))}
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                  Compliance Standards
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {regulationOptions.map(regulation => (
                    <button
                      key={regulation}
                      type="button"
                      onClick={() => {
                        const newRegs = criteria.regulations.includes(regulation)
                          ? criteria.regulations.filter(r => r !== regulation)
                          : [...criteria.regulations, regulation];
                        setCriteria({...criteria, regulations: newRegs});
                      }}
                      className={`p-2 rounded-lg border text-sm ${
                        criteria.regulations.includes(regulation)
                          ? 'border-green-500 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300'
                          : 'border-gray-300 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-600'
                      }`}
                    >
                      {regulation}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Step 3: Generate */}
          {step === 3 && (
            <div className="text-center py-8">
              <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-purple-100 to-blue-100 dark:from-purple-900/30 dark:to-blue-900/30 flex items-center justify-center">
                <Zap className="w-10 h-10 text-purple-600 dark:text-purple-400" />
              </div>
              <h4 className="text-lg font-bold text-gray-900 dark:text-white mb-2">
                Ready to Generate
              </h4>
              <p className="text-gray-600 dark:text-gray-400 mb-6">
                AI will create a customized checklist based on your specifications
              </p>
              
              <div className="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4 mb-6 text-left">
                <h5 className="font-semibold text-gray-700 dark:text-gray-300 mb-2">Summary</h5>
                <ul className="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                  <li>â€¢ Work Type: {criteria.workType}</li>
                  <li>â€¢ Hazards: {criteria.hazards.join(', ')}</li>
                  <li>â€¢ Regulations: {criteria.regulations.join(', ')}</li>
                  <li>â€¢ Complexity: {criteria.complexity}</li>
                </ul>
              </div>
            </div>
          )}
        </div>

        <div className="p-6 border-t dark:border-gray-800 flex justify-between">
          {step > 1 ? (
            <Button variant="secondary" onClick={() => setStep(step - 1)}>
              Back
            </Button>
          ) : (
            <Button variant="secondary" onClick={onClose}>
              Cancel
            </Button>
          )}
          
          {step < 3 ? (
            <Button onClick={() => setStep(step + 1)}>
              Continue
            </Button>
          ) : (
            <Button 
              onClick={generateAIItems}
              disabled={isGenerating}
              className="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
            >
              {isGenerating ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  Generating...
                </>
              ) : (
                <>
                  <Zap className="w-4 h-4 mr-2" />
                  Generate Checklist
                </>
              )}
            </Button>
          )}
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistBuilder.tsx
==================================================

import React, { useState } from 'react';
import type { ChecklistTemplate, ChecklistItem } from '../types';
import { Button } from './ui/Button';
import { Card } from './ui/Card';
import { PlusIcon, TrashIcon } from 'lucide-react';
import { useAppContext, useDataContext } from '../contexts';

interface ChecklistBuilderProps {
  onClose: () => void;
  onSave: (template: ChecklistTemplate) => void;
}

export const ChecklistBuilder: React.FC<ChecklistBuilderProps> = ({ onClose, onSave }) => {
  const { activeOrg } = useAppContext();
  const { checklistTemplates } = useDataContext();

  const [titleEn, setTitleEn] = useState('');
  const [titleAr, setTitleAr] = useState('');
  const [category, setCategory] = useState('General');
  const [items, setItems] = useState<Omit<ChecklistItem, 'id'>[]>([
      { text: { en: '', ar: '' }, description: { en: '', ar: '' } }
  ]);

  const handleItemChange = (index: number, field: 'text' | 'description', lang: 'en' | 'ar', value: string) => {
    const newItems = [...items];
    newItems[index][field][lang] = value;
    setItems(newItems);
  };

  const addItem = () => {
    setItems([...items, { text: { en: '', ar: '' }, description: { en: '', ar: '' } }]);
  };

  const removeItem = (index: number) => {
    if (items.length === 1) return;
    setItems(items.filter((_, i) => i !== index));
  };

  const handleSave = () => {
    if (!titleEn) return alert('Please enter a checklist title.');
    
    const newTemplate: ChecklistTemplate = {
        id: `ct_custom_${Date.now()}`,
        org_id: activeOrg.id,
        category,
        title: { en: titleEn, ar: titleAr || titleEn },
        items: items.map((item, idx) => ({
            id: `ci_${Date.now()}_${idx}`,
            text: { en: item.text.en, ar: item.text.ar || item.text.en },
            description: { en: item.description.en, ar: item.description.ar || item.description.en }
        }))
    };
    
    onSave(newTemplate);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
      <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div className="p-6 border-b dark:border-dark-border flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-900 dark:text-white">Checklist Builder</h2>
            <button onClick={onClose} className="text-gray-500 hover:text-red-500">Close</button>
        </div>

        <div className="p-6 overflow-y-auto flex-1 space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Title (English)</label>
                    <input 
                        className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border"
                        placeholder="e.g. Weekly Scaffold Check"
                        value={titleEn}
                        onChange={e => setTitleEn(e.target.value)}
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Title (Arabic) - Optional</label>
                    <input 
                        className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border text-right"
                        placeholder="...Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ"
                        value={titleAr}
                        onChange={e => setTitleAr(e.target.value)}
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Category</label>
                    <select 
                        className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border"
                        value={category}
                        onChange={e => setCategory(e.target.value)}
                    >
                        <option>General</option>
                        <option>Safety</option>
                        <option>High Risk</option>
                        <option>Environmental</option>
                        <option>Quality</option>
                        <option>Fire</option>
                    </select>
                </div>
            </div>

            <div className="border-t dark:border-dark-border pt-4">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="font-bold text-lg dark:text-white">Checklist Items</h3>
                    <Button size="sm" variant="secondary" onClick={addItem} leftIcon={<PlusIcon className="w-4 h-4"/>}>Add Item</Button>
                </div>

                <div className="space-y-3">
                    {items.map((item, idx) => (
                        <div key={idx} className="flex gap-3 items-start p-3 bg-gray-50 dark:bg-dark-background rounded-lg border dark:border-dark-border group">
                            <span className="text-gray-400 font-mono mt-2">{idx + 1}</span>
                            <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="space-y-2">
                                    <input 
                                        placeholder="Item Check (English)" 
                                        className="w-full p-2 text-sm border rounded dark:bg-dark-card dark:border-dark-border"
                                        value={item.text.en}
                                        onChange={e => handleItemChange(idx, 'text', 'en', e.target.value)}
                                    />
                                    <input 
                                        placeholder="Description / Guide (English)" 
                                        className="w-full p-2 text-xs border rounded text-gray-600 dark:bg-dark-card dark:border-dark-border"
                                        value={item.description.en}
                                        onChange={e => handleItemChange(idx, 'description', 'en', e.target.value)}
                                    />
                                </div>
                                <div className="space-y-2">
                                    <input 
                                        placeholder="Ø¹Ù†ØµØ± Ø§Ù„ØªØ­Ù‚Ù‚ (Ø¹Ø±Ø¨ÙŠ)" 
                                        className="w-full p-2 text-sm border rounded text-right dark:bg-dark-card dark:border-dark-border"
                                        value={item.text.ar}
                                        onChange={e => handleItemChange(idx, 'text', 'ar', e.target.value)}
                                    />
                                    <input 
                                        placeholder="ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)" 
                                        className="w-full p-2 text-xs border rounded text-gray-600 text-right dark:bg-dark-card dark:border-dark-border"
                                        value={item.description.ar}
                                        onChange={e => handleItemChange(idx, 'description', 'ar', e.target.value)}
                                    />
                                </div>
                            </div>
                            <button 
                                onClick={() => removeItem(idx)}
                                className="p-2 text-gray-400 hover:text-red-500 mt-1 opacity-50 group-hover:opacity-100"
                            >
                                <TrashIcon className="w-5 h-5" />
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <div className="p-6 border-t dark:border-dark-border bg-gray-50 dark:bg-dark-background flex justify-end gap-3 rounded-b-xl">
            <Button variant="secondary" onClick={onClose}>Cancel</Button>
            <Button onClick={handleSave}>Save Custom Template</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistCreationModal.tsx
==================================================

import React, { useState } from 'react';
import type { ChecklistTemplate, ChecklistItem } from '../types';
import { Button } from './ui/Button';
import { Plus, Trash2, X } from 'lucide-react';
import { useAppContext } from '../contexts';

interface ChecklistCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (template: ChecklistTemplate) => void;
}

export const ChecklistCreationModal: React.FC<ChecklistCreationModalProps> = ({ isOpen, onClose, onSubmit }) => {
  const { activeOrg } = useAppContext();
  const [title, setTitle] = useState('');
  const [category, setCategory] = useState('General');
  const [items, setItems] = useState<ChecklistItem[]>([
    { id: '1', text: { en: '' }, description: { en: '' }, riskLevel: 'Low' }
  ]);

  const handleAddItem = () => {
    setItems(prev => [
      ...prev, 
      { id: Date.now().toString(), text: { en: '' }, description: { en: '' }, riskLevel: 'Low' }
    ]);
  };

  const handleRemoveItem = (index: number) => {
    setItems(prev => prev.filter((_, i) => i !== index));
  };

  const handleItemChange = (index: number, field: 'text' | 'description' | 'riskLevel', value: string) => {
    setItems(prev => {
      const newItems = [...prev];
      if (field === 'text' || field === 'description') {
          newItems[index] = { ...newItems[index], [field]: { en: value } };
      } else {
          newItems[index] = { ...newItems[index], [field]: value };
      }
      return newItems;
    });
  };

  const handleSubmit = () => {
    if (!title.trim()) return alert("Title is required");
    const validItems = items.filter(i => i.text.en && i.text.en.trim() !== '');
    if (validItems.length === 0) return alert("Add at least one checklist item");

    const newTemplate: ChecklistTemplate = {
      id: `ct_${Date.now()}`,
      org_id: activeOrg.id,
      category,
      title: { en: title },
      items: validItems,
      popularity: 0,
      estimatedTime: validItems.length * 2, // approx 2 min per item
      aiGenerated: false
    };

    onSubmit(newTemplate);
    onClose();
    // Reset form
    setTitle('');
    setCategory('General');
    setItems([{ id: '1', text: { en: '' }, description: { en: '' }, riskLevel: 'Low' }]);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4 backdrop-blur-sm" onClick={onClose}>
      <div className="bg-white dark:bg-slate-900 w-full max-w-3xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-slate-800 flex justify-between items-center bg-white dark:bg-slate-900 rounded-t-2xl">
          <h2 className="text-xl font-bold text-gray-900 dark:text-white">Create Custom Checklist</h2>
          <button onClick={onClose}><X className="w-6 h-6 text-gray-500" /></button>
        </div>

        {/* Body */}
        <div className="p-6 overflow-y-auto space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Checklist Title</label>
              <input 
                value={title} 
                onChange={e => setTitle(e.target.value)} 
                placeholder="e.g. Daily Crane Inspection" 
                className="w-full p-2 border rounded-lg dark:bg-slate-800 dark:border-slate-700 dark:text-white"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
              <select 
                value={category} 
                onChange={e => setCategory(e.target.value)} 
                className="w-full p-2 border rounded-lg dark:bg-slate-800 dark:border-slate-700 dark:text-white"
              >
                <option>General</option>
                <option>Safety</option>
                <option>Quality</option>
                <option>Environmental</option>
                <option>Maintenance</option>
              </select>
            </div>
          </div>

          <div>
            <div className="flex justify-between items-center mb-2">
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Checklist Items</label>
              <button onClick={handleAddItem} className="text-blue-600 text-sm font-bold flex items-center hover:underline">
                <Plus className="w-4 h-4 mr-1" /> Add Item
              </button>
            </div>
            
            <div className="space-y-3">
              {items.map((item, idx) => (
                <div key={idx} className="flex gap-2 items-start p-3 bg-gray-50 dark:bg-slate-800/50 rounded-lg border dark:border-slate-700">
                  <span className="text-slate-400 mt-2 text-sm">{idx + 1}.</span>
                  <div className="flex-1 space-y-2">
                    <input 
                      placeholder="Requirement / Question" 
                      value={item.text.en} 
                      onChange={e => handleItemChange(idx, 'text', e.target.value)}
                      className="w-full p-2 text-sm border rounded dark:bg-slate-800 dark:border-slate-600 dark:text-white"
                    />
                    <div className="flex gap-2">
                      <input 
                        placeholder="Description / Guidance (Optional)" 
                        value={item.description.en} 
                        onChange={e => handleItemChange(idx, 'description', e.target.value)}
                        className="flex-1 p-2 text-xs border rounded dark:bg-slate-800 dark:border-slate-600 dark:text-white"
                      />
                      <select 
                        value={item.riskLevel} 
                        onChange={e => handleItemChange(idx, 'riskLevel', e.target.value)}
                        className="p-2 text-xs border rounded w-24 dark:bg-slate-800 dark:border-slate-600 dark:text-white"
                      >
                        <option>Low</option>
                        <option>Medium</option>
                        <option>High</option>
                        <option>Critical</option>
                      </select>
                    </div>
                  </div>
                  <button onClick={() => handleRemoveItem(idx)} className="p-2 text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded">
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="p-6 border-t dark:border-slate-800 bg-gray-50 dark:bg-slate-900/50 flex justify-end gap-3 rounded-b-2xl">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Create Checklist</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistDetailModal.tsx
==================================================

import React, { useState } from 'react';
import type { ChecklistTemplate, Organization, Project, User } from '../types';
import { Button } from './ui/Button';
import { useAppContext } from '../contexts';
import { X, Printer, Download } from 'lucide-react';

interface ChecklistDetailModalProps {
  template: ChecklistTemplate;
  organization: Organization;
  project: Project;
  user: User;
  onClose: () => void;
}

export const ChecklistDetailModal: React.FC<ChecklistDetailModalProps> = ({ template, organization, project, user, onClose }) => {
  const { language: userLang, activeOrg } = useAppContext();
  const [displayLang, setDisplayLang] = useState(userLang);

  const handlePrint = () => {
    window.print();
  };
  
  const getTranslated = (textRecord: string | Record<string, string> | undefined) => {
      if (!textRecord) return '';
      if (typeof textRecord === 'string') return textRecord;
      return textRecord[displayLang] || textRecord[activeOrg.primaryLanguage] || textRecord['en'] || Object.values(textRecord)[0] || '';
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-start p-4 print:p-0" onClick={onClose}>
        <div id="printable-checklist" className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col print:max-h-full print:shadow-none print:border-none" onClick={e => e.stopPropagation()}>
          <div className="p-4 flex justify-between items-center border-b dark:border-dark-border print:hidden">
            <h2 className="text-xl font-bold text-gray-900 dark:text-white">Checklist Preview</h2>
            <div className="flex items-center space-x-2">
               <div className="flex items-center space-x-2">
                    <span className="text-sm font-medium text-gray-600 dark:text-gray-300">{activeOrg.primaryLanguage.toUpperCase()}</span>
                    <button onClick={() => setDisplayLang(lang => lang === activeOrg.primaryLanguage ? (activeOrg.secondaryLanguages[0] || 'en') : activeOrg.primaryLanguage)} className={`relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none ${displayLang !== activeOrg.primaryLanguage ? 'bg-primary-600' : 'bg-gray-300'}`}>
                        <span className={`inline-block w-5 h-5 transform bg-white rounded-full transition-transform ease-in-out duration-200 ${displayLang !== activeOrg.primaryLanguage ? 'translate-x-5' : 'translate-x-0'}`} />
                    </button>
                    <span className="text-sm font-medium text-gray-600 dark:text-gray-300">{(activeOrg.secondaryLanguages[0] || 'en').toUpperCase()}</span>
                </div>
              <Button variant="secondary" onClick={handlePrint} leftIcon={<Printer className="w-4 h-4"/>}>Print</Button>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><X className="w-6 h-6" /></button>
            </div>
          </div>
          <div className="p-8 overflow-y-auto print:overflow-visible">
            <header className="flex justify-between items-start mb-8 border-b dark:border-dark-border pb-4">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900 dark:text-white">{getTranslated(template.title)}</h1>
                    <p className="text-gray-600 dark:text-gray-400">{template.category}</p>
                    <div className="mt-4 text-sm space-y-1 text-gray-700 dark:text-gray-300">
                        <p><strong>Project:</strong> {project.name}</p>
                        <p><strong>Inspector:</strong> {user.name}</p>
                        <p><strong>Date:</strong> {new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                <div className="flex flex-col items-end">
                    <img src={organization.branding.logoUrl} alt={`${organization.name} Logo`} className="h-16 w-auto mb-2" />
                    <div className="w-24 h-24 bg-gray-200 dark:bg-white/10 flex items-center justify-center text-xs text-gray-500">QR CODE</div>
                </div>
            </header>
            <main>
                <table className="w-full border-collapse text-sm">
                    <thead>
                        <tr className="border-b-2 border-gray-400 dark:border-gray-600 text-gray-900 dark:text-gray-100">
                            <th className="w-12 text-left p-2">#</th>
                            <th className="text-left p-2">Item</th>
                            <th className="w-48 text-left p-2">Result</th>
                            <th className="w-64 text-left p-2">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        {template.items.map((item, index) => (
                            <tr key={item.id} className="border-b border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200">
                                <td className="p-3 align-top font-semibold">{index + 1}</td>
                                <td className="p-3 align-top">
                                    <p className="font-semibold">{getTranslated(item.text)}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">{getTranslated(item.description)}</p>
                                </td>
                                <td className="p-3 align-top"><div className="h-6 w-full border-b border-gray-300 dark:border-gray-600"></div></td>
                                <td className="p-3 align-top"><div className="h-6 w-full border-b border-gray-300 dark:border-gray-600"></div></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </main>
          </div>
        </div>
      <style>{`
        @media print {
          body * { visibility: hidden; }
          #printable-checklist, #printable-checklist * { visibility: visible; }
          #printable-checklist { position: absolute; left: 0; top: 0; width: 100%; color: black !important; background: white !important; }
        }
      `}</style>
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistLibraryModal.tsx
==================================================

import React, { useState, useMemo } from 'react';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { MASTER_CHECKLIST_LIBRARY } from '../data/checklistLibrary';
import { Search, Plus, Check } from 'lucide-react';
import { useAppContext } from '../contexts';

interface ChecklistLibraryModalProps {
  isOpen: boolean;
  onClose: () => void;
  onImport: (template: any) => void;
}

export const ChecklistLibraryModal: React.FC<ChecklistLibraryModalProps> = ({ isOpen, onClose, onImport }) => {
  const { activeOrg } = useAppContext();
  const [search, setSearch] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('All');
  const [importedIds, setImportedIds] = useState<string[]>([]);

  const categories = useMemo(() => ['All', ...Array.from(new Set(MASTER_CHECKLIST_LIBRARY.map(t => t.category)))], []);

  const filteredTemplates = useMemo(() => {
    return MASTER_CHECKLIST_LIBRARY.filter(t => {
      const matchesSearch = t.title.en.toLowerCase().includes(search.toLowerCase());
      const matchesCategory = categoryFilter === 'All' || t.category === categoryFilter;
      return matchesSearch && matchesCategory;
    });
  }, [search, categoryFilter]);

  const handleImport = (template: typeof MASTER_CHECKLIST_LIBRARY[0], index: number) => {
    // Create a new template object for the organization
    const newTemplate = {
      ...template,
      org_id: activeOrg.id,
      // Generate a unique ID for the new template
      id: `ct_${Date.now()}_${index}` 
    };
    
    onImport(newTemplate);
    setImportedIds(prev => [...prev, template.title.en]);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-gray-800 flex justify-between items-center bg-white dark:bg-gray-900 rounded-t-2xl">
          <div>
            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Checklist Library</h2>
            <p className="text-sm text-gray-500 dark:text-gray-400">Import industry-standard checklists to your project.</p>
          </div>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>

        {/* Filters */}
        <div className="p-4 border-b dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50 flex flex-col md:flex-row gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
            <input 
              type="text" 
              placeholder="Search templates..." 
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500"
            />
          </div>
          <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0">
            {categories.map(cat => (
              <button
                key={cat}
                onClick={() => setCategoryFilter(cat)}
                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${
                  categoryFilter === cat 
                    ? 'bg-primary-600 text-white' 
                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700'
                }`}
              >
                {cat}
              </button>
            ))}
          </div>
        </div>

        {/* Grid */}
        <div className="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-gray-950">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredTemplates.map((template, index) => {
              const isImported = importedIds.includes(template.title.en);
              return (
                <div key={index} className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-5 hover:shadow-lg transition-shadow flex flex-col">
                  <div className="flex justify-between items-start mb-3">
                    <Badge color="blue">{template.category}</Badge>
                    <span className="text-xs text-gray-400">{template.items.length} items</span>
                  </div>
                  <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">{template.title.en}</h3>
                  <div className="flex-1">
                    <ul className="text-sm text-gray-500 dark:text-gray-400 space-y-1 mb-4">
                      {template.items.slice(0, 3).map(item => (
                        <li key={item.id} className="truncate">â€¢ {item.text.en}</li>
                      ))}
                      {template.items.length > 3 && <li className="text-xs italic">+ {template.items.length - 3} more...</li>}
                    </ul>
                  </div>
                  <Button 
                    onClick={() => handleImport(template, index)} 
                    disabled={isImported}
                    className={`w-full justify-center ${isImported ? 'bg-green-100 text-green-700 border-green-200 hover:bg-green-100' : ''}`}
                    variant={isImported ? 'outline' : 'primary'}
                  >
                    {isImported ? (
                      <>
                        <Check className="w-4 h-4 mr-2" /> Imported
                      </>
                    ) : (
                      <>
                        <Plus className="w-4 h-4 mr-2" /> Import Template
                      </>
                    )}
                  </Button>
                </div>
              );
            })}
          </div>
        </div>

      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistRunDetailModal.tsx
==================================================

import React from 'react';
import type { ChecklistRun, ChecklistTemplate } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext } from '../contexts';
import { X, Printer } from 'lucide-react';

interface ChecklistRunDetailModalProps {
  run: ChecklistRun;
  template: ChecklistTemplate;
  onClose: () => void;
}

export const ChecklistRunDetailModal: React.FC<ChecklistRunDetailModalProps> = ({ run, template, onClose }) => {
  const { language, activeOrg } = useAppContext();

  // Helper to handle both string and object titles
  const getTranslated = (textRecord: string | Record<string, string> | undefined) => {
    if (!textRecord) return '';
    if (typeof textRecord === 'string') return textRecord;
    return textRecord[language] || textRecord[activeOrg.primaryLanguage] || textRecord['en'] || Object.values(textRecord)[0] || '';
  };

  const getResultIcon = (result: string) => {
    switch (result) {
      case 'pass': return 'âœ…';
      case 'fail': return 'âŒ';
      case 'na': return 'âž–';
      default: return 'â“';
    }
  };

  const getResultColor = (result: string) => {
    switch (result) {
      case 'pass': return 'text-green-600 bg-green-50 dark:bg-green-900/30 dark:text-green-300';
      case 'fail': return 'text-red-600 bg-red-50 dark:bg-red-900/30 dark:text-red-300';
      case 'na': return 'text-gray-600 bg-gray-50 dark:bg-gray-800 dark:text-gray-400';
      default: return 'text-gray-600 bg-gray-50';
    }
  };

  const getItemById = (itemId: string) => {
    return template.items.find(item => item.id === itemId);
  };

  const passedItems = run.results?.filter(r => r.result === 'pass').length || 0;
  const totalItems = run.results?.length || template.items.length;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-start p-4 overflow-y-auto" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-2xl w-full max-w-5xl my-8" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="p-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-card rounded-t-lg sticky top-0 z-10">
          <div className="flex justify-between items-start">
            <div>
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
                {getTranslated(template.title)}
              </h2>
              <div className="flex items-center space-x-4 mt-2">
                <Badge color={run.score >= 90 ? 'green' : run.score >= 70 ? 'yellow' : 'red'}>
                  Score: {run.score}%
                </Badge>
                <Badge color={run.status === 'completed' ? 'green' : 'blue'}>
                  {run.status.replace('_', ' ')}
                </Badge>
                <span className="text-sm text-gray-500">
                  {passedItems}/{totalItems} items passed
                </span>
                <span className="text-sm text-gray-500">
                  {new Date(run.executed_at).toLocaleString()}
                </span>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              <Button variant="ghost" size="sm">
                <Printer className="w-4 h-4 mr-1" />
                Print
              </Button>
              <button
                onClick={onClose}
                className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-500"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6">
          {/* Score Overview */}
          <div className="mb-8">
            <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Score Overview</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-green-50 dark:bg-green-900/10 p-4 rounded-lg border border-green-100 dark:border-green-900/30">
                <div className="text-3xl font-bold text-green-600 dark:text-green-400">{passedItems}</div>
                <div className="text-sm text-green-800 dark:text-green-300">Items Passed</div>
              </div>
              <div className="bg-red-50 dark:bg-red-900/10 p-4 rounded-lg border border-red-100 dark:border-red-900/30">
                <div className="text-3xl font-bold text-red-600 dark:text-red-400">{run.results?.filter(r => r.result === 'fail').length || 0}</div>
                <div className="text-sm text-red-800 dark:text-red-300">Items Failed</div>
              </div>
              <div className="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-lg border border-blue-100 dark:border-blue-900/30">
                <div className="text-3xl font-bold text-blue-600 dark:text-blue-400">{run.results?.filter(r => r.result === 'na').length || 0}</div>
                <div className="text-sm text-blue-800 dark:text-blue-300">Not Applicable</div>
              </div>
            </div>
          </div>

          {/* Results Table */}
          <div className="overflow-hidden border border-gray-200 dark:border-gray-700 rounded-lg">
            <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead className="bg-gray-50 dark:bg-gray-800">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">#</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Result</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks & Evidence</th>
                </tr>
              </thead>
              <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                {run.results?.map((result, index) => {
                  const item = getItemById(result.item_id);
                  if (!item) return null;

                  return (
                    <tr key={result.item_id}>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        {index + 1}
                      </td>
                      <td className="px-6 py-4">
                        <div>
                          <p className="text-sm font-medium text-gray-900 dark:text-white">
                            {getTranslated(item.text)}
                          </p>
                          <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                            {getTranslated(item.description)}
                          </p>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getResultColor(result.result)}`}>
                          {getResultIcon(result.result)} {result.result.toUpperCase()}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        {result.remarks ? (
                          <div className="text-sm text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-white/5 p-2 rounded">
                            <span className="font-semibold text-xs text-gray-500 block mb-1">Remarks:</span>
                            {result.remarks}
                          </div>
                        ) : (
                          <span className="text-sm text-gray-400 italic">No remarks</span>
                        )}
                        {result.evidence_urls && result.evidence_urls.length > 0 && (
                          <div className="mt-2 flex gap-2">
                             {result.evidence_urls.map((url, i) => (
                                <a key={i} href={url} target="_blank" rel="noreferrer" className="text-xs text-blue-600 hover:underline">
                                    Evidence {i+1}
                                </a>
                             ))}
                          </div>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Summary */}
          <div className="mt-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <h4 className="font-semibold text-blue-800 dark:text-blue-300 mb-2">Summary & Recommendations</h4>
            {run.score >= 90 ? (
              <p className="text-sm text-green-700 dark:text-green-300">
                âœ… Excellent compliance level. All critical items passed. No immediate action required.
              </p>
            ) : run.score >= 70 ? (
              <p className="text-sm text-amber-700 dark:text-amber-300">
                âš ï¸ Satisfactory compliance with minor issues. Review failed items and implement corrective actions.
              </p>
            ) : (
              <p className="text-sm text-red-700 dark:text-red-300">
                âŒ Unsatisfactory compliance level. Immediate corrective actions required before proceeding.
              </p>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-dark-card flex justify-end rounded-b-lg">
          <Button variant="secondary" onClick={onClose}>
            Close Detail View
          </Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ChecklistRunModal.tsx
==================================================

import React, { useState } from 'react';
import type { ChecklistTemplate, Project, User, ChecklistRun, ChecklistRunResult } from '../types';
import { Button } from './ui/Button';
import { useAppContext } from '../contexts';
import { X } from 'lucide-react';

interface ChecklistRunModalProps {
  template: ChecklistTemplate;
  project: Project;
  user: User;
  onClose: () => void;
  onSubmit: (data: Omit<ChecklistRun, 'id' | 'org_id' | 'executed_by_id' | 'executed_at'>) => void;
}

type ResultValue = ChecklistRunResult['result'];

export const ChecklistRunModal: React.FC<ChecklistRunModalProps> = ({ template, project, user, onClose, onSubmit }) => {
  const { language, activeOrg } = useAppContext();
  
  const [results, setResults] = useState<Record<string, ChecklistRunResult>>(() => {
    const initial: Record<string, ChecklistRunResult> = {};
    template.items.forEach(item => {
        initial[item.id] = { item_id: item.id, result: 'na' };
    });
    return initial;
  });

  const getTranslated = (textRecord: string | Record<string, string> | undefined) => {
      if (!textRecord) return '';
      if (typeof textRecord === 'string') return textRecord;
      return textRecord[language] || textRecord[activeOrg.primaryLanguage] || textRecord['en'] || Object.values(textRecord)[0] || '';
  };

  const handleResultChange = (itemId: string, result: ResultValue) => {
    setResults(prev => ({
        ...prev,
        [itemId]: { ...prev[itemId], result }
    }));
  };
  
  const handleRemarksChange = (itemId: string, remarks: string) => {
    setResults(prev => ({
        ...prev,
        [itemId]: { ...prev[itemId], remarks }
    }));
  };

  const calculateScore = () => {
    const resultValues = Object.values(results);
    const applicableItems = resultValues.filter(r => (r as ChecklistRunResult).result !== 'na');
    if (applicableItems.length === 0) return 100;
    const passedItems = applicableItems.filter(r => (r as ChecklistRunResult).result === 'pass');
    return Math.round((passedItems.length / applicableItems.length) * 100);
  };

  const handleSubmit = () => {
    const finalRun: Omit<ChecklistRun, 'id' | 'org_id' | 'executed_by_id' | 'executed_at'> = {
        template_id: template.id,
        project_id: project.id,
        status: 'completed',
        score: calculateScore(),
        results: Object.values(results),
    };
    onSubmit(finalRun);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-start p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <header className="p-4 border-b dark:border-dark-border sticky top-0 bg-white dark:bg-dark-card z-10 flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold text-gray-900 dark:text-white">{getTranslated(template.title)}</h2>
            <p className="text-sm text-gray-500 dark:text-gray-400">Project: {project.name}</p>
          </div>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
             <X className="w-6 h-6" />
          </button>
        </header>

        <main className="p-6 overflow-y-auto">
            <div className="space-y-4">
                {template.items.map((item, index) => (
                    <div key={item.id} className="p-4 border border-gray-200 dark:border-dark-border rounded-lg bg-gray-50 dark:bg-white/5">
                        <div className="flex justify-between items-start">
                           <div>
                             <p className="font-semibold text-gray-900 dark:text-white">{index + 1}. {getTranslated(item.text)}</p>
                             <p className="text-xs text-gray-500 dark:text-gray-400 ml-5">{getTranslated(item.description)}</p>
                           </div>
                           <div className="flex-shrink-0 flex items-center space-x-1">
                             <ResultButton active={results[item.id].result === 'pass'} onClick={() => handleResultChange(item.id, 'pass')} color="green">Pass</ResultButton>
                             <ResultButton active={results[item.id].result === 'fail'} onClick={() => handleResultChange(item.id, 'fail')} color="red">Fail</ResultButton>
                             <ResultButton active={results[item.id].result === 'na'} onClick={() => handleResultChange(item.id, 'na')} color="gray">N/A</ResultButton>
                           </div>
                        </div>
                        <div className="mt-2 ml-5">
                            <textarea
                                value={results[item.id].remarks || ''}
                                onChange={e => handleRemarksChange(item.id, e.target.value)}
                                placeholder="Add remarks..."
                                rows={2}
                                className="w-full text-sm p-2 border border-gray-200 dark:border-dark-border dark:bg-dark-background dark:text-white rounded-md shadow-sm"
                            />
                        </div>
                    </div>
                ))}
            </div>
        </main>
        
        <footer className="p-4 border-t bg-gray-50 dark:bg-dark-card dark:border-dark-border sticky bottom-0 z-10 flex justify-between items-center">
            <div>
                <span className="font-semibold text-gray-900 dark:text-white">Score: {calculateScore()}%</span>
            </div>
            <div className="space-x-2">
                <Button variant="secondary" onClick={onClose}>Cancel</Button>
                <Button onClick={handleSubmit}>Submit Checklist</Button>
            </div>
        </footer>
      </div>
    </div>
  );
};

const ResultButton: React.FC<{active: boolean, onClick: () => void, color: 'green' | 'red' | 'gray', children: React.ReactNode}> = ({ active, onClick, color, children }) => {
    const colorClasses = {
        green: 'border-green-500 bg-green-50 text-green-700 dark:bg-green-900/50 dark:text-green-300',
        red: 'border-red-500 bg-red-50 text-red-700 dark:bg-red-900/50 dark:text-red-300',
        gray: 'border-gray-500 bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300',
    }
    const inactiveClasses = 'border-gray-300 bg-white text-gray-600 hover:bg-gray-100 dark:bg-dark-background dark:border-dark-border dark:text-gray-400 dark:hover:bg-white/5'
    return (
        <button
            onClick={onClick}
            className={`px-3 py-1 text-sm font-bold rounded-full border-2 transition-colors ${active ? colorClasses[color] : inactiveClasses}`}
        >
            {children}
        </button>
    )
}

==================================================
FILE: .\src\components\Checklists.tsx
==================================================

import React, { useState } from 'react';
import type { ChecklistTemplate, ChecklistRun } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { ChecklistDetailModal } from './ChecklistDetailModal';
import { ChecklistRunModal } from './ChecklistRunModal';
import { ChecklistLibraryModal } from './ChecklistLibraryModal';
import { useAppContext, useDataContext } from '../contexts';
import { Plus, Download } from 'lucide-react';

export const Checklists: React.FC = () => {
  const { activeOrg, activeUser, language, can } = useAppContext();
  const { checklistRunList, setChecklistRunList, projects, checklistTemplates, handleCreateChecklistTemplate } = useDataContext();
    
  const [selectedTemplate, setSelectedTemplate] = useState<ChecklistTemplate | null>(null);
  const [projectForRun, setProjectForRun] = useState(projects[0] || null);
  
  const [isDetailModalOpen, setDetailModalOpen] = useState(false);
  const [isSetupModalOpen, setSetupModalOpen] = useState(false);
  const [isRunModalOpen, setRunModalOpen] = useState(false);
  const [isLibraryOpen, setIsLibraryOpen] = useState(false);
  
  const getTranslated = (textRecord: Record<string, string> | string) => {
      if (typeof textRecord === 'string') return textRecord;
      return textRecord[language] || textRecord[activeOrg.primaryLanguage] || textRecord['en'] || Object.values(textRecord)[0] || '';
  }

  const getTemplateTitle = (templateId: string) => {
    const template = checklistTemplates.find(t => t.id === templateId);
    if (!template) return 'Unknown Template';
    return getTranslated(template.title);
  };
  const getUserName = (userId: string) => 'User'; // Simplified

  const handleViewTemplate = (template: ChecklistTemplate) => {
    setSelectedTemplate(template);
    setDetailModalOpen(true);
  };

  const handleInitiateRun = (template: ChecklistTemplate) => {
    setSelectedTemplate(template);
    if (projects.length > 0 && !projectForRun) {
        setProjectForRun(projects[0]);
    }
    setSetupModalOpen(true);
  };

  const handleStartRun = () => {
    if (selectedTemplate && projectForRun) {
        setSetupModalOpen(false);
        setRunModalOpen(true);
    }
  };
  
  const handleSubmitRun = (data: any) => {
    const newRun = { 
        ...data, 
        id: `cr_${Date.now()}`, 
        org_id: activeOrg.id, 
        executed_by_id: activeUser.id, 
        executed_at: new Date().toISOString() 
    };
    setChecklistRunList(prev => [newRun, ...prev]);
    setRunModalOpen(false);
    setSelectedTemplate(null);
    setProjectForRun(null);
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-text-primary dark:text-white">Checklists</h1>
        <div className="flex gap-2">
            {can('create', 'checklists') && (
                <Button variant="secondary" onClick={() => setIsLibraryOpen(true)}>
                    <Download className="w-5 h-5 mr-2" />
                    Import Template
                </Button>
            )}
            {can('create', 'checklists') && (
                <Button onClick={() => checklistTemplates.length > 0 && handleInitiateRun(checklistTemplates[0])}>
                    <Plus className="w-5 h-5 mr-2" />
                    Run Checklist
                </Button>
            )}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-1">
            <Card title="My Templates">
                {checklistTemplates.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                        <p>No templates found.</p>
                        <Button variant="ghost" size="sm" className="mt-2" onClick={() => setIsLibraryOpen(true)}>Browse Library</Button>
                    </div>
                ) : (
                    <ul className="divide-y divide-gray-200 dark:divide-gray-700">
                        {checklistTemplates.map(template => (
                            <li key={template.id} className="py-3">
                            <div className="flex justify-between items-center">
                                <div>
                                    <p className="text-sm font-medium text-gray-900 dark:text-white">{getTranslated(template.title)}</p>
                                    <p className="text-xs text-gray-500">{template.category}</p>
                                </div>
                                <div className="space-x-2">
                                    <Button variant="ghost" size="sm" onClick={() => handleViewTemplate(template)}>View</Button>
                                    {can('create', 'checklists') && <Button variant="primary" size="sm" onClick={() => handleInitiateRun(template)}>Run</Button>}
                                </div>
                            </div>
                            </li>
                        ))}
                    </ul>
                )}
            </Card>
        </div>
        <div className="lg:col-span-2">
            <Card title="Recent Checklist Runs">
                <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead className="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Checklist</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Executed By</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th className="px-6 py-3"><span className="sr-only">Actions</span></th>
                    </tr>
                    </thead>
                    <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                    {checklistRunList.map((run) => (
                        <tr key={run.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{getTemplateTitle(run.template_id)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{getUserName(run.executed_by_id)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">{run.status === 'completed' ? `${run.score}%` : 'N/A'}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                            {/* SAFE CHECK ADDED HERE */}
                            <Badge color={run.status === 'completed' ? 'green' : 'blue'}>{(run.status || 'Unknown').replace('_', ' ')}</Badge>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="#" className="text-primary-600 hover:text-primary-900">View</a>
                        </td>
                        </tr>
                    ))}
                    </tbody>
                </table>
                </div>
            </Card>
        </div>
      </div>
      
      {/* Modals */}
      {isDetailModalOpen && selectedTemplate && (
        <ChecklistDetailModal 
            template={selectedTemplate}
            onClose={() => setDetailModalOpen(false)}
            organization={activeOrg}
            project={projects[0]}
            user={activeUser}
        />
      )}

      {isSetupModalOpen && selectedTemplate && (
         <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center" onClick={() => setSetupModalOpen(false)}>
            <div className="bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                <div className="p-6">
                    <h3 className="text-lg font-bold text-gray-900 dark:text-white">Run Checklist</h3>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">Setup the details for this checklist run.</p>
                    <div className="mt-4 space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Checklist Template</label>
                            <input type="text" readOnly value={getTranslated(selectedTemplate.title)} className="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-md text-gray-900 dark:text-white" />
                        </div>
                        <div>
                             <label htmlFor="project" className="block text-sm font-medium text-gray-700 dark:text-gray-300">Select Project</label>
                             <select id="project" value={projectForRun?.id} onChange={e => setProjectForRun(projects.find(p => p.id === e.target.value) || null)} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">
                                 {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                             </select>
                        </div>
                    </div>
                </div>
                <div className="bg-gray-50 dark:bg-gray-800 px-6 py-3 flex justify-end space-x-2 rounded-b-lg">
                    <Button variant="secondary" onClick={() => setSetupModalOpen(false)}>Cancel</Button>
                    <Button onClick={handleStartRun}>Start Run</Button>
                </div>
            </div>
         </div>
      )}
      
      {isRunModalOpen && selectedTemplate && projectForRun && (
        <ChecklistRunModal
            template={selectedTemplate}
            project={projectForRun}
            user={activeUser}
            onClose={() => setRunModalOpen(false)}
            onSubmit={handleSubmitRun}
        />
      )}

      <ChecklistLibraryModal 
        isOpen={isLibraryOpen}
        onClose={() => setIsLibraryOpen(false)}
        onImport={handleCreateChecklistTemplate}
      />
    </div>
  );
};

==================================================
FILE: .\src\components\Dashboard.tsx
==================================================

import React, { useState, useEffect, useMemo, useRef } from 'react';
import { SafetyPulseWidget } from './SafetyPulseWidget';
import { SafetyPulseModal } from './SafetyPulseModal';
import { useAppContext, useDataContext, useModalContext } from '../contexts';
import { SiteMap } from './SiteMap';

// --- Helper Component for Micro-Animations ---
const AnimatedMetric: React.FC<{ value: string | number; className?: string }> = ({ value, className }) => {
    const [animating, setAnimating] = useState(false);
    const prevValue = useRef(value);

    useEffect(() => {
        if (prevValue.current !== value) {
            setAnimating(true);
            const timer = setTimeout(() => setAnimating(false), 300);
            prevValue.current = value;
            return () => clearTimeout(timer);
        }
    }, [value]);

    return (
        <span className={`${className} inline-block transition-colors duration-300 ${animating ? 'animate-bump text-white drop-shadow-[0_0_8px_rgba(255,255,255,0.8)]' : ''}`}>
            {value}
        </span>
    );
};

// --- Components ---

const DashboardHeader: React.FC<{ riskLevel: string; workforceCount: number; temperature: number }> = ({ riskLevel, workforceCount, temperature }) => {
    const { activeOrg } = useAppContext();
    const [time, setTime] = useState(new Date());

    useEffect(() => {
        const timer = setInterval(() => setTime(new Date()), 1000);
        return () => clearInterval(timer);
    }, []);

    const isHighRisk = riskLevel === 'High' || riskLevel === 'Critical';

    return (
        <header className="mb-6 rounded-2xl border border-slate-700/60 bg-slate-900/95 backdrop-blur-xl px-6 py-3 flex flex-col md:flex-row items-center justify-between shadow-[0_12px_35px_rgba(0,0,0,0.65)]">
            <div className="flex items-center gap-4 mb-2 md:mb-0">
                <div className="text-sm font-medium tracking-[0.17em] text-slate-300 uppercase">
                    EviroSafe 3.0
                </div>
                <div className="hidden md:block w-px h-4 bg-slate-700"></div>
                <span className="text-xs text-slate-500 font-mono uppercase tracking-wider">{activeOrg?.name || 'Organization'}</span>
            </div>
            
            <div className="flex items-center gap-6 text-xs font-medium text-slate-400">
                <div className="flex items-center gap-2">
                    <span className={`w-2 h-2 rounded-full ${isHighRisk ? 'bg-red-500 animate-pulse' : 'bg-emerald-500'}`}></span>
                    <span className={isHighRisk ? 'text-red-400' : 'text-emerald-400'}>RISK: {riskLevel.toUpperCase()}</span>
                </div>
                <div className="flex items-center gap-2">
                    <SunIcon className="w-3 h-3 text-orange-400" />
                    <span>HEAT: <AnimatedMetric value={temperature} className="text-orange-400 font-bold" />Â°C</span>
                </div>
                <div className="flex items-center gap-2">
                    <UsersIcon className="w-3 h-3 text-blue-400" />
                    <span>WORKFORCE: <AnimatedMetric value={workforceCount} className="text-blue-400 font-bold" /></span>
                </div>
                <div className="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
                    <div className="live-dot"></div>
                    <span className="text-slate-200 font-mono">{time.toLocaleTimeString([], { hour12: false })}</span>
                </div>
            </div>
        </header>
    );
};

const RiskLevelCard: React.FC<{ 
    riskLevel: string; 
    aiSummary: string; 
    recommendations: string[]; 
    className?: string 
}> = ({ riskLevel, aiSummary, recommendations, className }) => {
    const isHighRisk = riskLevel === 'High' || riskLevel === 'Critical';
    const baseClass = "rounded-3xl p-6 text-slate-100 transition-all duration-300 shadow-[0_18px_45px_rgba(0,0,0,0.55)]";
    const themeClass = isHighRisk ? "hero-card-high" : "hero-card-normal";
    
    const safeRecs = Array.isArray(recommendations) ? recommendations : [];

    return (
        <div className={`${baseClass} ${themeClass} ${className} flex flex-col justify-between`}>
            <div className={`pointer-events-none absolute -right-24 -top-24 h-64 w-64 rounded-full blur-3xl opacity-20 ${isHighRisk ? 'bg-red-500' : 'bg-emerald-500'}`} />

            <div>
                <div className="flex items-center justify-between mb-4 relative z-10">
                    <div className="space-y-1">
                        <p className="text-[11px] tracking-[0.25em] uppercase text-slate-300 font-semibold opacity-80">
                            Today&apos;s Risk Level
                        </p>
                        <div className="flex items-baseline gap-4">
                            <span className={`text-6xl font-black tracking-tighter ${isHighRisk ? 'text-transparent bg-clip-text bg-gradient-to-br from-white via-red-200 to-red-500 drop-shadow-sm' : 'text-emerald-300'}`}>
                                {riskLevel.toUpperCase()}
                            </span>
                            {isHighRisk && (
                                <span className="rounded-full border border-red-400/60 bg-red-500/20 px-3 py-1 text-[10px] font-bold uppercase text-red-200 tracking-[0.15em] animate-pulse">
                                    Alert
                                </span>
                            )}
                        </div>
                    </div>
                </div>

                <div className="mt-2 flex items-start gap-3 relative z-10">
                    <div className="flex-shrink-0 flex h-8 w-8 items-center justify-center rounded-full bg-sky-500/20 border border-sky-400/50 text-sky-300 text-xs font-bold shadow-[0_0_15px_rgba(56,189,248,0.3)]">
                        AI
                    </div>
                    <div className="flex-1 rounded-2xl bg-slate-950/40 border border-slate-700/50 px-5 py-4 text-sm leading-relaxed text-slate-200 backdrop-blur-sm">
                        <span className="text-sky-400 font-bold">Insight: </span>
                        {aiSummary}
                    </div>
                </div>
            </div>

            <div className="mt-6 border-t border-white/10 pt-5">
                <p className="mb-3 text-[10px] tracking-[0.2em] uppercase text-slate-400 font-bold">
                    Recommended Actions
                </p>
                <ul className="space-y-2">
                    {safeRecs.slice(0, 3).map((rec, idx) => (
                        <li key={idx} className="flex gap-3 items-center text-xs text-slate-300 bg-white/5 px-3 py-2 rounded-lg border border-white/5 hover:bg-white/10 transition-colors cursor-default">
                            <span className={`flex-shrink-0 h-1.5 w-1.5 rounded-full ${idx === 0 ? 'bg-sky-400' : idx === 1 ? 'bg-amber-400' : 'bg-emerald-400'}`} />
                            <span>{rec}</span>
                        </li>
                    ))}
                </ul>
            </div>
        </div>
    );
};

const QuickAction: React.FC<{ label: string; hotkey?: string; icon?: React.ReactNode; onClick?: () => void; disabled?: boolean }> = ({ label, hotkey, icon, onClick, disabled }) => (
    <button
        onClick={onClick}
        disabled={disabled}
        className={`w-full flex items-center justify-between rounded-2xl border px-4 py-3 text-xs transition-all group
        ${disabled 
            ? "border-slate-700/40 bg-slate-900/40 text-slate-600 cursor-not-allowed" 
            : "border-slate-600/70 bg-slate-900/60 hover:bg-slate-800 hover:border-sky-500/50 text-slate-200 hover:text-white hover:shadow-[0_0_20px_rgba(14,165,233,0.15)]"
        }`}
    >
        <div className="flex items-center gap-3">
            <span className={`h-8 w-8 rounded-xl flex items-center justify-center text-lg transition-colors ${disabled ? 'bg-slate-800/50 text-slate-600' : 'bg-slate-800 text-slate-400 group-hover:text-sky-400 group-hover:bg-sky-500/20'}`}>
                {icon || '+'}
            </span>
            <span className="font-medium tracking-wide">{label}</span>
        </div>
        {hotkey && (
            <span className="rounded-md border border-white/10 bg-black/20 px-1.5 py-0.5 text-[10px] font-mono text-slate-500">
                {hotkey}
            </span>
        )}
    </button>
);

const WidgetCard: React.FC<{ title: string; children: React.ReactNode; className?: string }> = ({ title, children, className }) => (
    <div className={`glass-card flex flex-col ${className}`}>
        <div className="flex justify-between items-center mb-4">
            <h3 className="text-sm font-bold text-slate-300 uppercase tracking-[0.1em]">{title}</h3>
            <div className="h-1 w-8 bg-slate-700 rounded-full"></div>
        </div>
        <div className="flex-1 relative">
            {children}
        </div>
    </div>
);

export const Dashboard: React.FC = () => {
    const { reportList, ptwList } = useDataContext();
    const { usersList } = useAppContext(); // Fixed: Get usersList from AppContext
    const { setIsReportCreationModalOpen, setIsTbtCreationModalOpen, setSelectedReport, setIsInspectionCreationModalOpen } = useModalContext();
    const { setCurrentView } = useAppContext();
    
    const [isSafetyPulseModalOpen, setIsSafetyPulseModalOpen] = useState(false);
    const [simulatedTemp, setSimulatedTemp] = useState(38);

    const safePtwList = Array.isArray(ptwList) ? ptwList : [];
    const safeReportList = Array.isArray(reportList) ? reportList : [];
    const safeUsersList = Array.isArray(usersList) ? usersList : [];

    const activePermits = useMemo(() => safePtwList.filter(p => p.status === 'ACTIVE').length, [safePtwList]);
    const pendingReports = useMemo(() => safeReportList.filter(r => r.status === 'under_review' || r.status === 'submitted'), [safeReportList]);
    
    const riskAnalysis = useMemo(() => {
        const openIncidents = safeReportList.filter(r => r.status !== 'closed');
        const criticalCount = openIncidents.filter(r => (r.risk_pre_control.severity * r.risk_pre_control.likelihood) >= 15).length;
        const highCount = openIncidents.filter(r => (r.risk_pre_control.severity * r.risk_pre_control.likelihood) >= 9).length;

        if (criticalCount > 0) return { level: 'Critical', summary: `${criticalCount} Critical Incidents Open. Immediate Action Required.` };
        if (highCount > 0) return { level: 'High', summary: `${highCount} High Risk Incidents Open. Monitor closely.` };
        if (openIncidents.length > 5) return { level: 'Medium', summary: 'Multiple open reports. Review control measures.' };
        return { level: 'Low', summary: 'Site operations are stable. No major incidents.' };
    }, [safeReportList]);

    const pulseStats = useMemo(() => ({
        incidents: safeReportList.filter(r => ['Incident', 'Accident', 'Fire Event'].includes(r.type)).length,
        unsafeActs: safeReportList.filter(r => r.type === 'Unsafe Act').length,
        unsafeConditions: safeReportList.filter(r => r.type === 'Unsafe Condition').length,
        positiveObs: safeReportList.filter(r => r.type === 'Positive Observation').length,
    }), [safeReportList]);

    const workforceCount = safeUsersList.length + (activePermits * 4);

    const recommendations = useMemo(() => {
        if (riskAnalysis.level === 'Critical') return ['Stop work in affected areas', 'Conduct emergency meeting', 'Review all active permits'];
        if (riskAnalysis.level === 'High') return ['Increase inspection frequency', 'Verify all PTW controls', 'Conduct TBT on recent incidents'];
        return ['Maintain housekeeping standards', 'Ensure hydration breaks', 'Routine equipment checks'];
    }, [riskAnalysis.level]);

    useEffect(() => {
        const interval = setInterval(() => {
            setSimulatedTemp(prev => parseFloat((prev + (Math.random() > 0.5 ? 0.1 : -0.1)).toFixed(1)));
        }, 5000);
        return () => clearInterval(interval);
    }, []);

    return (
        <div className="dashboard-bg">
            <DashboardHeader riskLevel={riskAnalysis.level} workforceCount={workforceCount} temperature={simulatedTemp} />

            {/* ROW 1: HERO & ACTIONS */}
            <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 mb-6">
                <div className="xl:col-span-8">
                    <RiskLevelCard 
                        riskLevel={riskAnalysis.level} 
                        aiSummary={riskAnalysis.summary} 
                        recommendations={recommendations}
                        className="h-full"
                    />
                </div>

                <div className="xl:col-span-4 flex flex-col gap-6">
                    <div className="glass-card p-5">
                        <h2 className="mb-4 text-xs font-bold tracking-[0.2em] uppercase text-slate-400">
                            Quick Actions
                        </h2>
                        <div className="space-y-3">
                            <QuickAction label="New Incident Report" hotkey="N" icon={<AlertIcon/>} onClick={() => setIsReportCreationModalOpen(true)} />
                            <QuickAction 
                                label="Start Inspection" 
                                hotkey="I" 
                                icon={<ClipboardIcon/>} 
                                onClick={() => {
                                    setCurrentView('inspections');
                                    setIsInspectionCreationModalOpen(true);
                                }} 
                            />
                            <QuickAction label="Conduct Toolbox Talk" hotkey="T" icon={<MegaphoneIcon/>} onClick={() => setIsTbtCreationModalOpen(true)} />
                        </div>
                    </div>

                    <div className="glass-card flex-1 p-5 flex flex-col">
                        <h2 className="mb-4 text-xs font-bold tracking-[0.2em] uppercase text-slate-400 flex justify-between">
                            <span>Approvals</span>
                            <span className="text-sky-400">{pendingReports.length}</span>
                        </h2>
                        <div className="space-y-2 flex-1 overflow-y-auto pr-1 custom-scrollbar">
                            {pendingReports.length > 0 ? pendingReports.slice(0, 3).map(r => (
                                <button key={r.id} onClick={() => setSelectedReport(r)} className="w-full text-left p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/20 transition-all group">
                                    <div className="flex justify-between items-start">
                                        <span className="text-xs font-bold text-slate-200 group-hover:text-white">{r.type}</span>
                                        <span className="text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Pending</span>
                                    </div>
                                    <p className="text-[10px] text-slate-500 mt-1 truncate">#{r.id ? r.id.slice(-6) : '???'} â€¢ {new Date(r.reported_at).toLocaleDateString()}</p>
                                </button>
                            )) : (
                                <p className="text-xs text-slate-600 italic text-center py-4">All clear. No pending items.</p>
                            )}
                        </div>
                    </div>
                </div>
            </div>

            {/* ROW 2: SITE TWIN & ENVIRONMENT */}
            <div className="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
                <div className="xl:col-span-2 h-96">
                    <WidgetCard title="3D Site Digital Twin" className="h-full p-0 overflow-hidden relative group">
                        <div className="absolute top-4 right-4 z-10 flex gap-2 pointer-events-none opacity-50 group-hover:opacity-100 transition-opacity">
                            <span className="px-2 py-1 bg-black/60 rounded text-[10px] text-red-300 border border-red-900/50">Incident</span>
                            <span className="px-2 py-1 bg-black/60 rounded text-[10px] text-blue-300 border border-blue-900/50">Permit</span>
                        </div>
                        <SiteMap embedded={true} />
                    </WidgetCard>
                </div>

                <div className="space-y-6 flex flex-col h-96">
                    <WidgetCard title="Environment" className="flex-1 relative overflow-hidden">
                        <div className="absolute -right-6 -top-6 text-orange-500/20 animate-spin-slow">
                            <SunIcon className="w-32 h-32" />
                        </div>
                        <div className="relative z-10">
                            <div className="flex items-baseline gap-2">
                                <AnimatedMetric value={simulatedTemp} className="text-5xl font-black text-slate-100" />
                                <span className="text-lg text-slate-400">Â°C</span>
                            </div>
                            <p className="text-xs font-bold text-orange-400 mt-1 uppercase tracking-wider animate-pulse">Heat Stress Warning</p>
                            
                            <div className="grid grid-cols-2 gap-3 mt-6">
                                <div className="bg-slate-950/50 p-2 rounded-lg border border-white/5">
                                    <p className="text-[10px] text-slate-500 uppercase">Wind</p>
                                    <p className="text-sm font-mono text-cyan-400">25 km/h</p>
                                </div>
                                <div className="bg-slate-950/50 p-2 rounded-lg border border-white/5">
                                    <p className="text-[10px] text-slate-500 uppercase">AQI</p>
                                    <p className="text-sm font-mono text-emerald-400">Good</p>
                                </div>
                            </div>
                        </div>
                    </WidgetCard>

                    <WidgetCard title="Live Workforce" className="flex-1">
                        <div className="flex justify-between items-end">
                            <div>
                                <AnimatedMetric value={workforceCount} className="text-4xl font-black text-slate-100" />
                                <span className="text-xs text-slate-500 block">Active Personnel</span>
                            </div>
                            <div className="text-right">
                                <p className="text-xs text-slate-400">Permits Active</p>
                                <p className="text-xl font-bold text-sky-400 font-mono">{activePermits}</p>
                            </div>
                        </div>
                        <div className="mt-auto pt-4">
                            <div className="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                <div className="h-full bg-emerald-500 w-[85%] rounded-full"></div>
                            </div>
                            <div className="flex justify-between mt-1 text-[10px] text-slate-500">
                                <span>Compliance</span>
                                <span>85%</span>
                            </div>
                        </div>
                    </WidgetCard>
                </div>
            </div>

            {/* ROW 3: SAFETY PULSE */}
            <div className="h-80">
                 <SafetyPulseWidget onExpand={() => setIsSafetyPulseModalOpen(true)} stats={pulseStats} />
            </div>

            <SafetyPulseModal isOpen={isSafetyPulseModalOpen} onClose={() => setIsSafetyPulseModalOpen(false)} />
        </div>
    );
};

// Icons
const SunIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>;
const UsersIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>;
const AlertIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>;
const ClipboardIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504 1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>;
const MegaphoneIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 110-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 01-1.44-4.282m3.102.069a18.03 18.03 0 01-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 018.835 2.535M10.34 6.66a23.847 23.847 0 008.835-2.535m0 0A23.74 23.74 0 0018.795 3m.38 1.125a23.91 23.91 0 011.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 001.014-5.395m0-3.46c.495.43.816 1.035.816 1.73 0 .695-.32 1.3-.816 1.73m0-3.46a24.347 24.347 0 010 3.46" /></svg>;

==================================================
FILE: .\src\components\DemoBanner.tsx
==================================================

import React from "react";

export const DemoBanner: React.FC = () => {
  return (
    <div className="w-full bg-amber-500/10 border-b border-amber-400/40 text-amber-900 text-sm">
      <div className="max-w-6xl mx-auto px-4 py-2 flex flex-wrap items-center justify-between gap-2">
        <div className="flex items-center gap-2">
          <span className="inline-flex h-6 w-6 items-center justify-center rounded-full bg-amber-400/40 text-xs font-bold">
            DEMO
          </span>
          <p className="font-medium">
            This is a <span className="font-semibold">demo / mock</span> EviroSafe
            environment. Data does not represent a live project.
          </p>
        </div>
        <p className="text-xs text-amber-800/80">
          Use it to explore incident reporting, PTW, RAMS and inspection workflows.
        </p>
      </div>
    </div>
  );
};


==================================================
FILE: .\src\components\ErrorBoundary.tsx
==================================================

import React, { Component, ErrorInfo, ReactNode } from 'react';
import { Button } from './ui/Button';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false,
    error: null,
  };

  public static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error("Uncaught error:", error, errorInfo);
  }

  private handleReset = () => {
    // Clear local storage to remove any bad cached state
    localStorage.clear();
    // Reload the page
    window.location.href = '/';
  };

  public render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center">
          <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md border border-slate-700">
            <h1 className="text-3xl font-bold text-red-500 mb-4">System Error</h1>
            <p className="text-slate-300 mb-6">
              The application encountered an unexpected error while loading data.
            </p>
            <div className="bg-black/30 p-4 rounded-lg mb-6 text-left overflow-auto max-h-32">
              <code className="text-xs text-red-300 font-mono">
                {this.state.error?.message || 'Unknown Error'}
              </code>
            </div>
            <p className="text-sm text-slate-400 mb-6">
              Click below to clear your local cache and restart the application.
            </p>
            <Button onClick={this.handleReset} className="w-full">
              ðŸ”„ Reset Application
            </Button>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

==================================================
FILE: .\src\components\GasTestLogSection.tsx
==================================================

import React from 'react';
import type { GasTestLogEntry } from '../types';
import { Button } from './ui/Button';

interface GasTestLogSectionProps {
  gasTests: GasTestLogEntry[];
  onChange: (tests: GasTestLogEntry[]) => void;
  disabled: boolean;
}

export const GasTestLogSection: React.FC<GasTestLogSectionProps> = ({ gasTests, onChange, disabled }) => {
  const addRow = () => {
    onChange([...gasTests, { time: '', o2: 20.9, lel: 0, co: 0, h2s: 0, tester_name: '' }]);
  };

  const updateRow = (index: number, field: keyof GasTestLogEntry, value: any) => {
    const newTests = [...gasTests];
    newTests[index] = { ...newTests[index], [field]: value };
    onChange(newTests);
  };

  const removeRow = (index: number) => {
    onChange(gasTests.filter((_, i) => i !== index));
  };

  return (
    <div className="border rounded-lg p-4 mb-6">
      <div className="flex justify-between items-center mb-4">
        <h4 className="font-bold text-gray-800 dark:text-gray-200">Gas Test Log</h4>
        {!disabled && <Button size="sm" onClick={addRow}>+ Add Test</Button>}
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm text-left">
          <thead className="bg-gray-100 dark:bg-gray-800">
            <tr>
              <th className="p-2">Time</th>
              <th className="p-2">O2 (%)</th>
              <th className="p-2">LEL (%)</th>
              <th className="p-2">CO (ppm)</th>
              <th className="p-2">H2S (ppm)</th>
              <th className="p-2">Tester</th>
              {!disabled && <th className="p-2"></th>}
            </tr>
          </thead>
          <tbody>
            {gasTests.map((test, i) => (
              <tr key={i} className="border-b dark:border-gray-700">
                <td className="p-2"><input type="time" value={test.time} onChange={e => updateRow(i, 'time', e.target.value)} disabled={disabled} className="w-full bg-transparent border rounded p-1" /></td>
                <td className="p-2"><input type="number" value={test.o2} onChange={e => updateRow(i, 'o2', parseFloat(e.target.value))} disabled={disabled} className="w-16 bg-transparent border rounded p-1" /></td>
                <td className="p-2"><input type="number" value={test.lel} onChange={e => updateRow(i, 'lel', parseFloat(e.target.value))} disabled={disabled} className="w-16 bg-transparent border rounded p-1" /></td>
                <td className="p-2"><input type="number" value={test.co} onChange={e => updateRow(i, 'co', parseFloat(e.target.value))} disabled={disabled} className="w-16 bg-transparent border rounded p-1" /></td>
                <td className="p-2"><input type="number" value={test.h2s} onChange={e => updateRow(i, 'h2s', parseFloat(e.target.value))} disabled={disabled} className="w-16 bg-transparent border rounded p-1" /></td>
                <td className="p-2"><input type="text" value={test.tester_name} onChange={e => updateRow(i, 'tester_name', e.target.value)} disabled={disabled} className="w-full bg-transparent border rounded p-1" /></td>
                {!disabled && <td className="p-2"><button onClick={() => removeRow(i)} className="text-red-500">Ã—</button></td>}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Housekeeping.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { ChecklistTemplate, ChecklistRun } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext, useDataContext } from '../contexts';
import { ChecklistRunModal } from './ChecklistRunModal';
import { ChecklistDetailModal } from './ChecklistDetailModal';
import { ChecklistLibraryModal } from './ChecklistLibraryModal';

const StatCard: React.FC<{ title: string; value: string | number; change?: string }> = ({ title, value, change }) => (
    <div className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-white/10 rounded-2xl shadow-lg p-4">
        <p className="text-sm text-text-secondary dark:text-dark-text-secondary">{title}</p>
        <p className="text-3xl font-bold text-text-primary dark:text-dark-text-primary mt-1">{value}</p>
        {change && <p className="text-xs text-green-500 mt-1">{change}</p>}
    </div>
);

export const Housekeeping: React.FC = () => {
    const { activeOrg, activeUser, language, usersList } = useAppContext();
    const { checklistRunList, setChecklistRunList, projects, checklistTemplates, handleCreateChecklistTemplate } = useDataContext();

    const [isRunModalOpen, setRunModalOpen] = useState(false);
    const [isDetailModalOpen, setDetailModalOpen] = useState(false);
    const [isLibraryOpen, setIsLibraryOpen] = useState(false);
    const [selectedTemplate, setSelectedTemplate] = useState<ChecklistTemplate | null>(null);

    const housekeepingTemplates = useMemo(() => checklistTemplates.filter(t => t.category === 'Housekeeping'), [checklistTemplates]);
    const housekeepingRuns = useMemo(() => {
        const templateIds = housekeepingTemplates.map(t => t.id);
        return checklistRunList.filter(run => templateIds.includes(run.template_id));
    }, [checklistRunList, housekeepingTemplates]);
    
    const getTranslated = (textRecord: any) => {
      if (typeof textRecord === 'string') return textRecord;
      return textRecord[language] || textRecord[activeOrg.primaryLanguage] || textRecord['en'] || '';
    };

    const handleRunChecklist = (template: ChecklistTemplate) => {
        setSelectedTemplate(template);
        setRunModalOpen(true);
    };

    const handleViewChecklist = (template: ChecklistTemplate) => {
        setSelectedTemplate(template);
        setDetailModalOpen(true);
    }
    
    const handleSubmitRun = (data: Omit<ChecklistRun, 'id' | 'org_id' | 'executed_by_id' | 'executed_at'>) => {
        if (!activeUser) return;
        const newRun: ChecklistRun = {
            ...data,
            id: `cr_${Date.now()}`,
            org_id: activeOrg.id,
            executed_by_id: activeUser.id,
            executed_at: new Date().toISOString(),
        };
        setChecklistRunList(prev => [newRun, ...prev]);
        setRunModalOpen(false);
        setSelectedTemplate(null);
    };

    if (!activeUser) return null;

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold text-text-primary dark:text-dark-text-primary">Site Housekeeping & Welfare</h1>
                    <p className="text-text-secondary dark:text-dark-text-secondary">Manage cleanliness, waste, and welfare facilities.</p>
                </div>
                <div className="flex gap-2">
                    <Button variant="secondary" onClick={() => setIsLibraryOpen(true)}>
                        Import Checklist
                    </Button>
                    <Button onClick={() => {}}>
                        <PlusIcon className="w-5 h-5 mr-2" />
                        New Inspection
                    </Button>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <StatCard title="Overall Score" value="92%" change="+1.5% this week" />
                <StatCard title="Daily Compliance" value="98%" />
                <StatCard title="Open Findings" value="3" />
                <StatCard title="Inspections Today" value="8" />
            </div>

            <Card title="Housekeeping Checklists">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {housekeepingTemplates.map(template => (
                        <div key={template.id} className="p-4 bg-gray-50 dark:bg-slate-800/50 rounded-lg border dark:border-slate-700 flex justify-between items-center">
                            <div>
                                <h4 className="font-semibold text-text-primary dark:text-white">{getTranslated(template.title)}</h4>
                                <p className="text-sm text-text-secondary dark:text-gray-400">{template.items.length} items</p>
                            </div>
                            <div className="space-x-2">
                                <Button size="sm" variant="secondary" onClick={() => handleViewChecklist(template)}>View</Button>
                                <Button size="sm" onClick={() => handleRunChecklist(template)}>Run</Button>
                            </div>
                        </div>
                    ))}
                    {housekeepingTemplates.length === 0 && (
                        <div className="col-span-2 text-center py-8 text-gray-500 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl">
                            <p>No housekeeping checklists found.</p>
                            <Button variant="ghost" className="mt-2" onClick={() => setIsLibraryOpen(true)}>Browse Library</Button>
                        </div>
                    )}
                </div>
            </Card>

            <Card title="Recent Activity">
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                        <thead className="bg-gray-50 dark:bg-slate-800">
                            <tr>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Checklist</th>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Executor</th>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700">
                            {housekeepingRuns.slice(0, 5).map(run => {
                                const template = housekeepingTemplates.find(t => t.id === run.template_id);
                                const user = usersList.find(u => u.id === run.executed_by_id);
                                return (
                                <tr key={run.id}>
                                    <td className="px-4 py-3 font-medium text-gray-900 dark:text-white">{template ? getTranslated(template.title) : 'Unknown'}</td>
                                    <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">{user?.name || 'Unknown'}</td>
                                    <td className="px-4 py-3"><Badge color={run.score && run.score >= 85 ? 'green' : 'yellow'}>{run.score}%</Badge></td>
                                    <td className="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">{new Date(run.executed_at).toLocaleDateString()}</td>
                                    <td className="px-4 py-3 text-right"><Button size="sm" variant="ghost">View</Button></td>
                                </tr>
                                )
                            })}
                            {housekeepingRuns.length === 0 && (
                                <tr>
                                    <td colSpan={5} className="text-center py-8 text-sm text-gray-500">No housekeeping inspections have been recorded yet.</td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </Card>

            {isRunModalOpen && selectedTemplate && projects[0] && (
                <ChecklistRunModal
                    template={selectedTemplate}
                    project={projects.find(p => p.org_id === activeOrg.id) || projects[0]}
                    user={activeUser}
                    onClose={() => setRunModalOpen(false)}
                    onSubmit={handleSubmitRun}
                />
            )}
            
            {isDetailModalOpen && selectedTemplate && projects[0] && (
                 <ChecklistDetailModal
                    template={selectedTemplate}
                    organization={activeOrg}
                    project={projects.find(p => p.org_id === activeOrg.id) || projects[0]}
                    user={activeUser}
                    onClose={() => setDetailModalOpen(false)}
                />
            )}

            {/* Library Modal */}
            <ChecklistLibraryModal 
                isOpen={isLibraryOpen} 
                onClose={() => setIsLibraryOpen(false)} 
                onImport={handleCreateChecklistTemplate}
            />

        </div>
    );
};

const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
    </svg>
);

==================================================
FILE: .\src\components\HousekeepingRunDetailModal.tsx
==================================================

import React, { useState } from 'react';
import type { ChecklistRun, ChecklistTemplate, User } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';

interface HousekeepingRunDetailModalProps {
  run: ChecklistRun;
  template: ChecklistTemplate;
  executor: User | undefined;
  onClose: () => void;
}

export const HousekeepingRunDetailModal: React.FC<HousekeepingRunDetailModalProps> = ({ run, template, executor, onClose }) => {
  const [reviewerNote, setReviewerNote] = useState('');

  const getResultColor = (result: string) => {
      switch(result) {
          case 'pass': return 'text-green-600 bg-green-50 border-green-200';
          case 'fail': return 'text-red-600 bg-red-50 border-red-200';
          default: return 'text-gray-500 bg-gray-50 border-gray-200';
      }
  };

  const handlePrint = () => {
      window.print();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-dark-border flex justify-between items-start">
            <div>
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">Housekeeping Inspection Record</h2>
                <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    {template?.title['en'] || 'Checklist'} â€¢ {new Date(run.executed_at).toLocaleString()}
                </p>
            </div>
            <div className="text-right">
                <div className="text-3xl font-bold text-emerald-600">{run.score}%</div>
                <div className="text-xs text-gray-500 uppercase font-bold">Compliance Score</div>
            </div>
        </div>

        {/* Body */}
        <div className="p-6 overflow-y-auto space-y-6">
            
            {/* Meta Data */}
            <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 dark:bg-white/5 rounded-lg border dark:border-dark-border">
                <div>
                    <p className="text-xs text-gray-500 uppercase font-bold">Inspected By</p>
                    <div className="flex items-center gap-2 mt-1">
                        <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                            {executor?.name.charAt(0)}
                        </div>
                        <span className="text-sm font-medium text-gray-900 dark:text-white">{executor?.name || 'Unknown'}</span>
                    </div>
                </div>
                <div>
                    <p className="text-xs text-gray-500 uppercase font-bold">Status</p>
                    <div className="mt-1">
                        <Badge color={run.status === 'completed' ? 'green' : 'yellow'}>
                            {run.status.toUpperCase()}
                        </Badge>
                    </div>
                </div>
            </div>

            {/* Checklist Results */}
            <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3">Checklist Results</h3>
                <div className="space-y-3">
                    {run.results.map((result, idx) => {
                        const item = template.items.find(i => i.id === result.item_id);
                        return (
                            <div key={idx} className="flex justify-between items-start p-3 border-b dark:border-dark-border last:border-0">
                                <div className="flex-1">
                                    <p className="text-sm font-medium text-gray-900 dark:text-white">
                                        {item?.text['en'] || 'Unknown Item'}
                                    </p>
                                    {result.remarks && (
                                        <p className="text-xs text-gray-500 mt-1 italic">
                                            Note: {result.remarks}
                                        </p>
                                    )}
                                </div>
                                <div className={`px-3 py-1 rounded-full text-xs font-bold border ${getResultColor(result.result)}`}>
                                    {result.result.toUpperCase()}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Reviewer Section (Workflow) */}
            <div className="pt-4 border-t dark:border-dark-border">
                <h3 className="text-sm font-bold text-gray-900 dark:text-white mb-2">Supervisor Review</h3>
                <textarea 
                    className="w-full p-3 border rounded-lg text-sm dark:bg-dark-background dark:border-dark-border dark:text-white"
                    rows={3}
                    placeholder="Add review comments or corrective actions..."
                    value={reviewerNote}
                    onChange={(e) => setReviewerNote(e.target.value)}
                />
            </div>

        </div>

        {/* Footer */}
        <div className="p-6 border-t dark:border-dark-border bg-gray-50 dark:bg-black/20 flex justify-end gap-3 rounded-b-lg">
            <Button variant="secondary" onClick={handlePrint}>Print Report</Button>
            <Button variant="secondary" onClick={onClose}>Close</Button>
            <Button onClick={onClose}>Verify & Archive</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\HseStatistics.tsx
==================================================

import React, { useState, useMemo, useRef } from 'react';
import { 
  Activity, Users, Clock, AlertTriangle, 
  RefreshCw, Download, Shield, Leaf, Heart, 
  Settings, BarChart3, DollarSign, EyeOff, Eye,
  FileText, Calendar, TrendingUp, TrendingDown,
  ChevronLeft, ChevronRight, Plus, Trash2,
  FileSpreadsheet, Printer, Search,
  Save, Upload, Target, Award,
  Thermometer, Database, PieChart, LineChart
} from 'lucide-react';
import { 
  ResponsiveContainer, ComposedChart, Line, Area, XAxis, YAxis, 
  CartesianGrid, Tooltip, Legend, Bar, Pie, Cell, Radar, RadarChart,
  PolarGrid, PolarAngleAxis, PolarRadiusAxis
} from 'recharts';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import * as XLSX from 'xlsx';

// --- Enhanced Types ---
type MetricCategory = 'Core & Workforce' | 'Compliance' | 'Environment' | 'Health' | 'Process' | 'Behavioral' | 'Financial' | 'Performance';
type HsePeriod = 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'yearly';
type HseStatus = 'pending' | 'in-progress' | 'completed' | 'approved' | 'rejected';

interface HseMetric {
  id: string;
  label: string;
  description: string;
  prev: number;
  curr: number;
  target: number | null;
  unit: string;
  category: MetricCategory;
  status: HseStatus;
  lastUpdated: string;
  department?: string;
  location?: string;
  riskLevel?: 'low' | 'medium' | 'high' | 'critical';
  trend?: 'improving' | 'declining' | 'stable';
}

interface MonthlyData {
  id: string;
  month: string;
  year: number;
  metrics: Record<string, number>;
  status: HseStatus;
  submittedBy?: string;
  submittedAt?: string;
  approvedBy?: string;
  approvedAt?: string;
  notes?: string;
}

interface DepartmentData {
  id: string;
  name: string;
  manpower: number;
  manhours: number;
  incidents: number;
  target: number;
  color: string;
}

interface HseReport {
  id: string;
  title: string;
  period: string;
  generatedAt: string;
  data: MonthlyData;
  pdfUrl?: string;
  excelUrl?: string;
}

// --- HSE Standards & Requirements ---
const HSE_STANDARDS = {
  OSHA: {
    TRIR_TARGET: 2.5,
    LTIFR_TARGET: 1.2,
    DART_RATE_TARGET: 2.0,
    FATALITY_TARGET: 0,
  }
};

// --- Mock Data Generation ---
const generateMonthlyData = (year: number = 2024) => {
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  
  return months.map((month, index) => ({
    id: `${year}-${String(index + 1).padStart(2, '0')}`,
    month,
    year,
    metrics: {
      totalManpower: Math.floor(Math.random() * 200) + 150,
      totalManhours: Math.floor(Math.random() * 40000) + 20000,
      totalIncidents: Math.floor(Math.random() * 5),
      lostTimeInjuries: Math.random() > 0.9 ? 1 : 0,
      firstAidCases: Math.floor(Math.random() * 8),
      nearMisses: Math.floor(Math.random() * 15),
      environmentalIncidents: Math.floor(Math.random() * 3),
      wasteGenerated: Math.floor(Math.random() * 600) + 300,
      energyConsumption: Math.floor(Math.random() * 6000) + 4000,
      safetyObservations: Math.floor(Math.random() * 50) + 30,
      inspectionsCompleted: Math.floor(Math.random() * 20) + 10,
      trainingHours: Math.floor(Math.random() * 100) + 50,
    },
    status: (index < months.length - 1 ? 'approved' : 'pending') as HseStatus,
    submittedAt: new Date(year, index, 15).toISOString(),
    approvedAt: new Date(year, index, 20).toISOString(),
  }));
};

const generateDepartments = (): DepartmentData[] => [
  { id: 'dept-1', name: 'Construction', manpower: 65, manhours: 13000, incidents: 2, target: 1, color: '#3b82f6' },
  { id: 'dept-2', name: 'Electrical', manpower: 28, manhours: 5600, incidents: 1, target: 0, color: '#8b5cf6' },
  { id: 'dept-3', name: 'Mechanical', manpower: 42, manhours: 8400, incidents: 0, target: 0, color: '#f59e0b' },
  { id: 'dept-4', name: 'Civil', manpower: 35, manhours: 7000, incidents: 1, target: 1, color: '#10b981' },
  { id: 'dept-5', name: 'Safety', manpower: 8, manhours: 1600, incidents: 0, target: 0, color: '#ef4444' },
  { id: 'dept-6', name: 'Administration', manpower: 20, manhours: 4000, incidents: 0, target: 0, color: '#06b6d4' },
];

// --- Main Component ---
export const HseStatistics: React.FC = () => {
  // State Management
  const [activeTab, setActiveTab] = useState<MetricCategory>('Core & Workforce');
  const [selectedPeriod, setSelectedPeriod] = useState<HsePeriod>('monthly');
  const [selectedMonth, setSelectedMonth] = useState<string>('2024-12');
  const [showTargets, setShowTargets] = useState(true);
  const [monthlyData] = useState<MonthlyData[]>(generateMonthlyData());
  const [departments] = useState<DepartmentData[]>(generateDepartments());
  const [reports, setReports] = useState<HseReport[]>([]);
  const [newMetric, setNewMetric] = useState<Partial<HseMetric>>({});
  const [searchQuery, setSearchQuery] = useState('');
  const [isExporting, setIsExporting] = useState(false);
  
  const reportRef = useRef<HTMLDivElement>(null);

  // Enhanced Metrics State
  const [metrics, setMetrics] = useState<HseMetric[]>([
    // Core & Workforce
    { id: 'mp_total', label: 'Total Manpower', description: 'Total workforce count', prev: 190, curr: 198, target: 200, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'mh_total', label: 'Total Manhours', description: 'Total work hours logged', prev: 35000, curr: 39080, target: 40000, unit: 'Hours', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'inc_tri', label: 'Total Recordable Incidents', description: 'OSHA recordable incidents', prev: 2, curr: 0, target: 0, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'inc_lti', label: 'Lost Time Injuries (LTI)', description: 'Injuries resulting in lost work days', prev: 0, curr: 0, target: 0, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'inc_fac', label: 'First Aid Cases', description: 'Minor injuries requiring first aid', prev: 5, curr: 2, target: 1, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'inc_nm', label: 'Near Misses', description: 'Potential incidents that did not occur', prev: 12, curr: 8, target: 10, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'inc_mtc', label: 'Medical Treatment Cases', description: 'Injuries requiring medical treatment', prev: 1, curr: 0, target: 0, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'inc_fatal', label: 'Fatalities', description: 'Work-related fatalities', prev: 0, curr: 0, target: 0, unit: 'Count', category: 'Core & Workforce', status: 'completed', lastUpdated: '2024-12-15' },
    
    // Environment
    { id: 'env_spills', label: 'Chemical Spills', description: 'Environmental spills and releases', prev: 0, curr: 0, target: 0, unit: 'Count', category: 'Environment', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'env_waste', label: 'Waste Generated', description: 'Total waste produced', prev: 500, curr: 450, target: 400, unit: 'kg', category: 'Environment', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'env_energy', label: 'Energy Consumption', description: 'Total energy usage', prev: 5500, curr: 4800, target: 4500, unit: 'kWh', category: 'Environment', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'env_water', label: 'Water Consumption', description: 'Total water usage', prev: 2500, curr: 2300, target: 2000, unit: 'mÂ³', category: 'Environment', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'env_co2', label: 'CO2 Emissions', description: 'Carbon dioxide emissions', prev: 12.5, curr: 11.8, target: 10, unit: 'tons', category: 'Environment', status: 'completed', lastUpdated: '2024-12-15' },
    
    // Health
    { id: 'health_sick', label: 'Sickness Absence', description: 'Work-related sickness days', prev: 3, curr: 1, target: 0, unit: 'Days', category: 'Health', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'health_screen', label: 'Health Screenings', description: 'Employee health assessments', prev: 85, curr: 95, target: 100, unit: 'Count', category: 'Health', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'health_ergo', label: 'Ergonomic Assessments', description: 'Workstation evaluations', prev: 15, curr: 20, target: 25, unit: 'Count', category: 'Health', status: 'completed', lastUpdated: '2024-12-15' },
    
    // Compliance
    { id: 'comp_insp', label: 'Safety Inspections', description: 'Completed safety inspections', prev: 10, curr: 12, target: 15, unit: 'Count', category: 'Compliance', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'comp_audit', label: 'Safety Audits', description: 'Internal safety audits', prev: 4, curr: 6, target: 8, unit: 'Count', category: 'Compliance', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'comp_training', label: 'Training Hours', description: 'Safety training delivered', prev: 320, curr: 380, target: 400, unit: 'Hours', category: 'Compliance', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'comp_tt', label: 'Toolbox Talks', description: 'Safety briefings conducted', prev: 25, curr: 30, target: 35, unit: 'Count', category: 'Compliance', status: 'completed', lastUpdated: '2024-12-15' },
    
    // Process
    { id: 'proc_psm', label: 'PSM Compliance', description: 'Process Safety Management compliance', prev: 92, curr: 95, target: 100, unit: '%', category: 'Process', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'proc_hazop', label: 'HAZOP Actions', description: 'Hazard analysis actions completed', prev: 45, curr: 52, target: 60, unit: 'Count', category: 'Process', status: 'completed', lastUpdated: '2024-12-15' },
    
    // Financial
    { id: 'fin_safety', label: 'Safety Investment', description: 'Safety equipment and training investment', prev: 50000, curr: 65000, target: 75000, unit: '$', category: 'Financial', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'fin_incident', label: 'Incident Costs', description: 'Cost of incidents and injuries', prev: 15000, curr: 8000, target: 5000, unit: '$', category: 'Financial', status: 'completed', lastUpdated: '2024-12-15' },
    { id: 'fin_insurance', label: 'Insurance Premiums', description: 'Workers compensation insurance', prev: 120000, curr: 115000, target: 110000, unit: '$', category: 'Financial', status: 'completed', lastUpdated: '2024-12-15' },
  ]);

  // Calculations
  const totals = useMemo(() => {
    const totalManhours = metrics.find(m => m.id === 'mh_total')?.curr || 1;
    const totalManpower = metrics.find(m => m.id === 'mp_total')?.curr || 0;
    const totalLTI = metrics.find(m => m.id === 'inc_lti')?.curr || 0;
    const totalRecordable = metrics.find(m => m.id === 'inc_tri')?.curr || 0;
    const totalFatalities = metrics.find(m => m.id === 'inc_fatal')?.curr || 0;
    const totalDART = metrics.find(m => m.id === 'inc_mtc')?.curr || 0;

    // OSHA Calculations
    const trir = ((totalRecordable * 200000) / totalManhours).toFixed(2);
    const ltifr = ((totalLTI * 1000000) / totalManhours).toFixed(2);
    const dartRate = ((totalDART * 200000) / totalManhours).toFixed(2);
    const fatalityRate = ((totalFatalities * 1000000) / totalManhours).toFixed(4);

    // Safety Performance Index
    const performanceMetrics = [
      { metric: metrics.find(m => m.id === 'inc_tri'), weight: 30 },
      { metric: metrics.find(m => m.id === 'inc_lti'), weight: 25 },
      { metric: metrics.find(m => m.id === 'comp_insp'), weight: 15 },
      { metric: metrics.find(m => m.id === 'comp_training'), weight: 15 },
      { metric: metrics.find(m => m.id === 'health_sick'), weight: 15 },
    ];

    const spi = performanceMetrics.reduce((score, item) => {
      if (item.metric && item.metric.target) {
        const achievement = (item.metric.curr / item.metric.target) * 100;
        return score + (Math.min(achievement, 100) * (item.weight / 100));
      }
      return score;
    }, 0).toFixed(1);

    return { 
      totalManhours, 
      totalManpower, 
      trir, 
      ltifr, 
      dartRate, 
      fatalityRate, 
      spi 
    };
  }, [metrics]);

  // Filtered Metrics
  const filteredMetrics = useMemo(() => {
    let filtered = metrics.filter(m => m.category === activeTab);
    
    if (searchQuery) {
      filtered = filtered.filter(m => 
        m.label.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.description.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }
    
    return filtered;
  }, [metrics, activeTab, searchQuery]);

  // Chart Data
  const chartData = useMemo(() => {
    return monthlyData.map(month => ({
      name: month.month.substring(0, 3),
      fullMonth: month.month,
      manhours: month.metrics.totalManhours || 0,
      incidents: month.metrics.totalIncidents || 0,
      manpower: month.metrics.totalManpower || 0,
      nearMisses: month.metrics.nearMisses || 0,
      waste: month.metrics.wasteGenerated || 0,
      inspections: month.metrics.inspectionsCompleted || 0,
    }));
  }, [monthlyData]);

  // Department Performance Data
  const departmentPerformance = useMemo(() => {
    return departments.map(dept => ({
      subject: dept.name,
      A: dept.incidents,
      B: dept.manpower,
      C: dept.manhours / 1000,
      fullMark: Math.max(dept.target, dept.incidents) + 5,
    }));
  }, [departments]);

  // Handlers
  const handleInputChange = (id: string, value: string) => {
    const numValue = parseFloat(value) || 0;
    setMetrics(prev => prev.map(m => 
      m.id === id ? { 
        ...m, 
        curr: numValue,
        trend: numValue > m.prev ? 'declining' : numValue < m.prev ? 'improving' : 'stable',
        lastUpdated: new Date().toISOString().split('T')[0]
      } : m
    ));
  };

  const handleAddMetric = () => {
    if (newMetric.label && newMetric.category) {
      const metric: HseMetric = {
        id: `metric_${Date.now()}`,
        label: newMetric.label,
        description: newMetric.description || '',
        prev: 0,
        curr: 0,
        target: newMetric.target || null,
        unit: newMetric.unit || 'Count',
        category: newMetric.category as MetricCategory,
        status: 'pending',
        lastUpdated: new Date().toISOString().split('T')[0]
      };
      
      setMetrics(prev => [...prev, metric]);
      setNewMetric({});
    }
  };

  const handleDeleteMetric = (id: string) => {
    setMetrics(prev => prev.filter(m => m.id !== id));
  };

  const handleRefresh = () => {
    const updatedMetrics = metrics.map(m => ({
      ...m,
      prev: m.curr,
      curr: m.curr + (Math.random() > 0.5 ? 1 : -1) * Math.floor(Math.random() * 10),
      lastUpdated: new Date().toISOString().split('T')[0]
    }));
    setMetrics(updatedMetrics);
  };

  // --- PROFESSIONAL PDF EXPORT (FIXED) ---
  const exportToPDF = () => {
    setIsExporting(true);
    const doc = new jsPDF('p', 'mm', 'a4');
    const pageWidth = doc.internal.pageSize.getWidth();
    const today = new Date().toLocaleDateString();

    // 1. Header Background
    doc.setFillColor(11, 17, 32); // Dark Blue/Black
    doc.rect(0, 0, pageWidth, 40, 'F');

    // 2. Logo (Vector Shield)
    doc.setFillColor(16, 185, 129); // Emerald
    doc.roundedRect(14, 10, 15, 15, 3, 3, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text("ES", 16.5, 19);

    // Title
    doc.setFontSize(22);
    doc.text("EviroSafe HSE Report", 35, 20);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated: ${today}`, 35, 28);
    doc.text(`Period: ${selectedPeriod.toUpperCase()} - ${selectedMonth}`, 35, 33);

    // 3. Executive Summary (KPIs)
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text("Executive Summary", 14, 50);

    const kpiData = [
        ['Total Manpower', totals.totalManpower.toString()],
        ['Total Manhours', totals.totalManhours.toLocaleString()],
        ['TRIR (per 200k)', totals.trir],
        ['LTIFR (per 1M)', totals.ltifr],
        ['DART Rate', totals.dartRate],
        ['Safety Index', totals.spi]
    ];

    autoTable(doc, {
        startY: 55,
        head: [['KPI', 'Value']],
        body: kpiData,
        theme: 'grid',
        headStyles: { fillColor: [16, 185, 129], textColor: 255, fontStyle: 'bold' }, // Emerald Green
        styles: { fontSize: 10, cellPadding: 3 },
        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 80 } }
    });

    // 4. Detailed Metrics Table
    const finalY = (doc as any).lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.text("Detailed Metrics", 14, finalY);

    const tableBody = filteredMetrics.map(m => [
        m.label,
        m.prev.toString(),
        m.curr.toString(),
        m.target?.toString() || '-',
        m.unit,
        m.status.toUpperCase()
    ]);

    autoTable(doc, {
        startY: finalY + 5,
        head: [['Metric', 'Prev', 'Curr', 'Target', 'Unit', 'Status']],
        body: tableBody,
        theme: 'striped',
        headStyles: { fillColor: [30, 41, 59], textColor: 255 }, // Slate Dark
        styles: { fontSize: 9 },
        alternateRowStyles: { fillColor: [241, 245, 249] }
    });

    // 5. Footer
    const pageCount = (doc as any).internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Page ${i} of ${pageCount} - EviroSafe Enterprise System`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
    }

    doc.save(`HSE_Report_${selectedMonth}.pdf`);
    setIsExporting(false);
  };

  const exportToExcel = () => {
    setIsExporting(true);
    try {
      const worksheetData = [
        ['HSE STATISTICS REPORT', '', '', '', ''],
        ['Generated', new Date().toLocaleString(), '', '', ''],
        ['Period', selectedPeriod, 'Month', selectedMonth.split('-')[1], 'Year', selectedMonth.split('-')[0]],
        ['', '', '', '', ''],
        ['METRIC', 'PREVIOUS', 'CURRENT', 'TARGET', 'UNIT', 'TREND', 'STATUS']
      ];
      metrics.forEach(metric => {
        worksheetData.push([
          metric.label,
          metric.prev.toString(),
          metric.curr.toString(),
          metric.target?.toString() || '-',
          metric.unit,
          metric.trend || 'stable',
          metric.status
        ]);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(worksheetData);
      XLSX.utils.book_append_sheet(wb, ws, 'HSE Statistics');
      XLSX.writeFile(wb, `HSE_Statistics_${new Date().toISOString().slice(0, 10)}.xlsx`);
    } catch (error) {
      console.error('Excel export failed:', error);
    } finally {
      setIsExporting(false);
    }
  };

  // Component for Monthly Selector
  const MonthSelector = () => {
    const months = monthlyData.map(m => ({
      id: m.id,
      label: `${m.month} ${m.year}`,
      status: m.status
    }));
    const currentIndex = months.findIndex(m => m.id === selectedMonth);
    
    return (
      <div className="flex items-center gap-4">
        <button 
          onClick={() => { if (currentIndex > 0) setSelectedMonth(months[currentIndex - 1].id); }}
          disabled={currentIndex <= 0}
          className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 disabled:opacity-30"
        >
          <ChevronLeft className="w-4 h-4" />
        </button>
        <div className="flex gap-2">
          {months.slice(Math.max(0, currentIndex - 2), currentIndex + 3).map(month => (
            <button
              key={month.id}
              onClick={() => setSelectedMonth(month.id)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                selectedMonth === month.id
                  ? 'bg-sky-900 text-sky-300 border border-sky-700'
                  : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
              }`}
            >
              {month.label.split(' ')[0]}
              {month.status === 'pending' && <span className="ml-2 w-2 h-2 bg-amber-500 rounded-full inline-block"></span>}
            </button>
          ))}
        </div>
        <button 
          onClick={() => { if (currentIndex < months.length - 1) setSelectedMonth(months[currentIndex + 1].id); }}
          disabled={currentIndex >= months.length - 1}
          className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 disabled:opacity-30"
        >
          <ChevronRight className="w-4 h-4" />
        </button>
        <div className="flex gap-2 ml-4">
          <button className="px-3 py-2 bg-emerald-900/50 text-emerald-300 text-sm rounded-lg border border-emerald-700/50 hover:bg-emerald-900">
            <Plus className="w-4 h-4" />
          </button>
          <button className="px-3 py-2 bg-slate-800 text-slate-400 text-sm rounded-lg border border-slate-700 hover:bg-slate-700 hover:text-white">
            <Calendar className="w-4 h-4" />
          </button>
        </div>
      </div>
    );
  };

  // Component for Performance Indicators
  const PerformanceIndicators = () => {
    const indicators = [
      { 
        label: 'TRIR', 
        value: totals.trir, 
        target: HSE_STANDARDS.OSHA.TRIR_TARGET, 
        icon: <AlertTriangle className="w-5 h-5" />,
        color: parseFloat(totals.trir) <= HSE_STANDARDS.OSHA.TRIR_TARGET ? 'text-emerald-400' : 'text-red-400',
        bgColor: parseFloat(totals.trir) <= HSE_STANDARDS.OSHA.TRIR_TARGET ? 'bg-emerald-900/30' : 'bg-red-900/30'
      },
      { 
        label: 'LTIFR', 
        value: totals.ltifr, 
        target: HSE_STANDARDS.OSHA.LTIFR_TARGET, 
        icon: <Activity className="w-5 h-5" />,
        color: parseFloat(totals.ltifr) <= HSE_STANDARDS.OSHA.LTIFR_TARGET ? 'text-emerald-400' : 'text-red-400',
        bgColor: parseFloat(totals.ltifr) <= HSE_STANDARDS.OSHA.LTIFR_TARGET ? 'bg-emerald-900/30' : 'bg-red-900/30'
      },
      { 
        label: 'DART Rate', 
        value: totals.dartRate, 
        target: HSE_STANDARDS.OSHA.DART_RATE_TARGET, 
        icon: <Thermometer className="w-5 h-5" />,
        color: parseFloat(totals.dartRate) <= HSE_STANDARDS.OSHA.DART_RATE_TARGET ? 'text-emerald-400' : 'text-amber-400',
        bgColor: parseFloat(totals.dartRate) <= HSE_STANDARDS.OSHA.DART_RATE_TARGET ? 'bg-emerald-900/30' : 'bg-amber-900/30'
      },
      { 
        label: 'SPI', 
        value: totals.spi, 
        target: 90, 
        icon: <Award className="w-5 h-5" />,
        color: parseFloat(totals.spi) >= 90 ? 'text-emerald-400' : parseFloat(totals.spi) >= 80 ? 'text-amber-400' : 'text-red-400',
        bgColor: parseFloat(totals.spi) >= 90 ? 'bg-emerald-900/30' : parseFloat(totals.spi) >= 80 ? 'bg-amber-900/30' : 'bg-red-900/30'
      },
    ];
    
    return (
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        {indicators.map(indicator => (
          <div key={indicator.label} className={`p-4 rounded-xl border border-slate-800 ${indicator.bgColor}`}>
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                {indicator.icon}
                <span className="text-sm font-bold text-slate-400">{indicator.label}</span>
              </div>
              <span className="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-400">
                Target: {indicator.target}
              </span>
            </div>
            <div className={`text-3xl font-black ${indicator.color} mb-1`}>
              {indicator.value}
            </div>
            <div className="text-xs text-slate-500">
              {parseFloat(indicator.value) <= indicator.target ? 'Meeting Target' : 'Needs Improvement'}
            </div>
          </div>
        ))}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-[#0B1120] text-slate-200 p-6">
      <div ref={reportRef} className="bg-[#0B1120] p-8">
        
        {/* Header */}
        <div className="flex justify-between items-center mb-8">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-slate-800 rounded-xl border border-slate-700">
              <Shield className="w-6 h-6 text-sky-400" />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-white">HSE Statistics Dashboard</h1>
              <p className="text-slate-400 mt-1">
                ISO 45001 â€¢ OSHA Compliant â€¢ Monthly Reporting
              </p>
            </div>
          </div>

          <div className="flex gap-4">
            <div className="bg-slate-800 rounded-lg p-2 px-4 border border-slate-700">
              <p className="text-[10px] text-slate-400 uppercase tracking-wider">Manpower</p>
              <div className="flex items-center gap-2">
                <Users className="w-4 h-4 text-blue-400" />
                <span className="text-xl font-bold text-white">{totals.totalManpower}</span>
              </div>
            </div>
            <div className="bg-slate-800 rounded-lg p-2 px-4 border border-slate-700">
              <p className="text-[10px] text-slate-400 uppercase tracking-wider">Manhours</p>
              <div className="flex items-center gap-2">
                <Clock className="w-4 h-4 text-emerald-400" />
                <span className="text-xl font-bold text-white">{totals.totalManhours.toLocaleString()}</span>
              </div>
            </div>
            <div className="bg-slate-800 rounded-lg p-2 px-4 border border-slate-700">
              <p className="text-[10px] text-slate-400 uppercase tracking-wider">TRIR</p>
              <div className="flex items-center gap-2">
                <AlertTriangle className="w-4 h-4 text-red-400" />
                <span className="text-xl font-bold text-white">{totals.trir}</span>
              </div>
            </div>
          </div>
        </div>

        {/* Navigation Tabs (MOVED TO TOP) */}
        <div className="flex items-center justify-between border-b border-slate-800 pb-1 mb-8 overflow-x-auto sticky top-0 z-10 bg-[#0B1120] pt-2">
          <div className="flex gap-1">
            {[
              { id: 'Core & Workforce', icon: <Shield className="w-4 h-4" /> },
              { id: 'Compliance', icon: <Activity className="w-4 h-4" /> },
              { id: 'Environment', icon: <Leaf className="w-4 h-4" /> },
              { id: 'Health', icon: <Heart className="w-4 h-4" /> },
              { id: 'Process', icon: <Settings className="w-4 h-4" /> },
              { id: 'Behavioral', icon: <Users className="w-4 h-4" /> },
              { id: 'Financial', icon: <DollarSign className="w-4 h-4" /> },
              { id: 'Performance', icon: <BarChart3 className="w-4 h-4" /> },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as MetricCategory)}
                className={`flex items-center gap-2 px-4 py-3 text-sm font-medium transition-all rounded-t-lg border-b-2 ${
                  activeTab === tab.id
                    ? 'border-sky-500 text-sky-400 bg-slate-800/50'
                    : 'border-transparent text-slate-500 hover:text-slate-300 hover:bg-slate-800/30'
                }`}
              >
                {tab.icon}
                {tab.id}
              </button>
            ))}
          </div>
          
          <div className="flex items-center gap-4">
            <div className="text-xs text-slate-500">
              Data as of: <span className="text-slate-300 font-bold">{new Date().toLocaleDateString()}</span>
            </div>
            <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
          </div>
        </div>

        {/* Period Selector */}
        <div className="mb-8 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
          <div className="flex items-center justify-between mb-4">
            <h2 className="font-bold text-white">Monthly Statistics</h2>
            <div className="flex items-center gap-2 text-sm">
              <span className="text-slate-400">Reporting Period:</span>
              <select 
                value={selectedPeriod}
                onChange={(e) => setSelectedPeriod(e.target.value as HsePeriod)}
                className="bg-slate-800 border border-slate-700 rounded px-3 py-1 text-white"
              >
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          </div>
          
          <MonthSelector />
          
          <div className="mt-4 flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-emerald-500/20 border border-emerald-500"></div>
                <span className="text-sm text-slate-400">Approved</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-amber-500/20 border border-amber-500"></div>
                <span className="text-sm text-slate-400">Pending</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-3 h-3 rounded-full bg-blue-500/20 border border-blue-500"></div>
                <span className="text-sm text-slate-400">In Progress</span>
              </div>
            </div>
            
            <div className="flex items-center gap-2">
              <button className="px-3 py-1.5 bg-slate-800 text-slate-400 text-sm rounded-lg border border-slate-700 hover:bg-slate-700 hover:text-white">
                <Save className="w-4 h-4" />
              </button>
              <button className="px-3 py-1.5 bg-blue-900/50 text-blue-300 text-sm rounded-lg border border-blue-700/50 hover:bg-blue-900">
                <Upload className="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>

        {/* Performance Indicators */}
        <PerformanceIndicators />

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
          
          {/* Data Table (2/3 width) */}
          <div className="lg:col-span-2 space-y-6">
            {/* Controls */}
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-500" />
                  <input
                    type="text"
                    placeholder="Search metrics..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-10 pr-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white text-sm w-64 focus:outline-none focus:border-sky-500"
                  />
                </div>
                <button 
                  onClick={() => setShowTargets(!showTargets)}
                  className="flex items-center gap-2 px-3 py-2 bg-slate-800 text-slate-400 text-sm rounded-lg border border-slate-700 hover:bg-slate-700 hover:text-white"
                >
                  {showTargets ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                  {showTargets ? 'Hide Targets' : 'Show Targets'}
                </button>
              </div>
              
              <div className="flex items-center gap-2">
                <button 
                  onClick={handleRefresh}
                  className="flex items-center gap-2 px-3 py-2 bg-slate-800 text-slate-400 text-sm rounded-lg border border-slate-700 hover:bg-slate-700 hover:text-white"
                >
                  <RefreshCw className="w-4 h-4" />
                  Refresh
                </button>
                <button 
                  onClick={exportToExcel}
                  disabled={isExporting}
                  className="flex items-center gap-2 px-3 py-2 bg-emerald-900/50 text-emerald-300 text-sm rounded-lg border border-emerald-700/50 hover:bg-emerald-900 disabled:opacity-50"
                >
                  <FileSpreadsheet className="w-4 h-4" />
                  {isExporting ? 'Exporting...' : 'Export Excel'}
                </button>
              </div>
            </div>

            {/* Data Table */}
            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
              <div className="px-6 py-4 border-b border-slate-800 flex justify-between items-center">
                <div>
                  <h3 className="font-bold text-white">{activeTab} Metrics</h3>
                  <p className="text-sm text-slate-500">
                    {filteredMetrics.length} metrics â€¢ Last updated: {new Date().toLocaleDateString()}
                  </p>
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={exportToPDF}
                    disabled={isExporting}
                    className="flex items-center gap-2 px-3 py-2 bg-red-900/50 text-red-300 text-sm rounded-lg border border-red-700/50 hover:bg-red-900 disabled:opacity-50"
                  >
                    <FileText className="w-4 h-4" />
                    {isExporting ? 'Generating...' : 'Export PDF'}
                  </button>
                  <button className="flex items-center gap-2 px-3 py-2 bg-blue-900/50 text-blue-300 text-sm rounded-lg border border-blue-700/50 hover:bg-blue-900">
                    <Printer className="w-4 h-4" />
                    Print
                  </button>
                </div>
              </div>
              
              <div className="overflow-x-auto">
                <table className="w-full text-sm text-left">
                  <thead className="text-xs text-slate-500 uppercase bg-slate-950/50 border-b border-slate-800">
                    <tr>
                      <th className="px-6 py-3 font-bold">Metric</th>
                      <th className="px-6 py-3 font-bold text-center">Previous</th>
                      <th className="px-6 py-3 font-bold text-center">Current</th>
                      {showTargets && (
                        <th className="px-6 py-3 font-bold text-center">Target</th>
                      )}
                      <th className="px-6 py-3 font-bold text-center">Unit</th>
                      <th className="px-6 py-3 font-bold text-center">Trend</th>
                      <th className="px-6 py-3 font-bold text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800">
                    {filteredMetrics.map((metric) => (
                      <tr key={metric.id} className="hover:bg-slate-800/50 transition-colors">
                        <td className="px-6 py-4">
                          <div>
                            <div className="font-medium text-slate-300">{metric.label}</div>
                            <div className="text-xs text-slate-500 mt-1">{metric.description}</div>
                          </div>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className="px-3 py-1 rounded-full bg-slate-800 text-slate-400 font-mono text-xs border border-slate-700">
                            {metric.prev}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <input 
                            type="number" 
                            value={metric.curr}
                            onChange={(e) => handleInputChange(metric.id, e.target.value)}
                            className="w-24 bg-slate-950 border border-slate-700 text-white text-center rounded-lg py-1.5 px-2 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500 font-bold transition-all"
                          />
                        </td>
                        {showTargets && (
                          <td className="px-6 py-4 text-center">
                            {metric.target !== null ? (
                              <span className="px-3 py-1 rounded-full bg-amber-900/30 text-amber-400 font-mono text-xs border border-amber-700/50">
                                {metric.target}
                              </span>
                            ) : (
                              <span className="text-slate-500">-</span>
                            )}
                          </td>
                        )}
                        <td className="px-6 py-4 text-center text-slate-400 text-xs">
                          {metric.unit}
                        </td>
                        <td className="px-6 py-4 text-center">
                          {metric.trend === 'improving' && (
                            <div className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-900/30 text-emerald-400 text-xs border border-emerald-700/50">
                              <TrendingDown className="w-3 h-3" />
                              Improving
                            </div>
                          )}
                          {metric.trend === 'declining' && (
                            <div className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-900/30 text-red-400 text-xs border border-red-700/50">
                              <TrendingUp className="w-3 h-3" />
                              Declining
                            </div>
                          )}
                          {metric.trend === 'stable' && (
                            <div className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-800 text-slate-400 text-xs border border-slate-700">
                              <Activity className="w-3 h-3" />
                              Stable
                            </div>
                          )}
                        </td>
                        <td className="px-6 py-4 text-center">
                          <button
                            onClick={() => handleDeleteMetric(metric.id)}
                            className="p-1 text-slate-500 hover:text-red-400 transition-colors"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </td>
                      </tr>
                    ))}
                    
                    {/* Add Metric Row */}
                    <tr className="bg-slate-950/30 border-t border-slate-800">
                      <td colSpan={showTargets ? 7 : 6} className="px-6 py-4">
                        <div className="flex items-center gap-4">
                          <input
                            type="text"
                            placeholder="New metric label"
                            value={newMetric.label || ''}
                            onChange={(e) => setNewMetric({...newMetric, label: e.target.value})}
                            className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm flex-1"
                          />
                          <input
                            type="text"
                            placeholder="Description"
                            value={newMetric.description || ''}
                            onChange={(e) => setNewMetric({...newMetric, description: e.target.value})}
                            className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm flex-1"
                          />
                          <input
                            type="number"
                            placeholder="Target"
                            value={newMetric.target || ''}
                            onChange={(e) => setNewMetric({...newMetric, target: parseFloat(e.target.value)})}
                            className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm w-32"
                          />
                          <select
                            value={newMetric.category || ''}
                            onChange={(e) => setNewMetric({...newMetric, category: e.target.value as MetricCategory})}
                            className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"
                          >
                            <option value="">Select Category</option>
                            <option value="Core & Workforce">Core & Workforce</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Environment">Environment</option>
                            <option value="Health">Health</option>
                            <option value="Process">Process</option>
                            <option value="Behavioral">Behavioral</option>
                            <option value="Financial">Financial</option>
                          </select>
                          <button
                            onClick={handleAddMetric}
                            className="px-4 py-2 bg-emerald-900/50 text-emerald-300 rounded-lg border border-emerald-700/50 hover:bg-emerald-900"
                          >
                            <Plus className="w-4 h-4" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          {/* Charts & Visualizations (1/3 width) */}
          <div className="space-y-6">
            {/* Trend Analysis */}
            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
              <h3 className="font-bold text-white mb-6 flex items-center gap-2">
                <LineChart className="w-5 h-5 text-sky-400" />
                Trend Analysis
              </h3>
              <div className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <ComposedChart data={chartData}>
                    <defs>
                      <linearGradient id="colorManhours" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                    <XAxis dataKey="name" tick={{fill: '#64748b', fontSize: 10}} axisLine={false} tickLine={false} />
                    <YAxis tick={{fill: '#64748b', fontSize: 10}} axisLine={false} tickLine={false} />
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', color: '#fff', borderRadius: '8px' }}
                      itemStyle={{ fontSize: 12 }}
                    />
                    <Area type="monotone" dataKey="manhours" stroke="#3b82f6" fill="url(#colorManhours)" strokeWidth={2} />
                    <Line type="monotone" dataKey="incidents" stroke="#ef4444" strokeWidth={2} dot={{r: 3, fill: '#ef4444'}} />
                    <Line type="monotone" dataKey="inspections" stroke="#10b981" strokeWidth={2} dot={{r: 3, fill: '#10b981'}} />
                  </ComposedChart>
                </ResponsiveContainer>
              </div>
              <div className="mt-4 flex justify-center gap-4 text-xs">
                <div className="flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full bg-blue-500/20 border border-blue-500"></span>
                  <span className="text-slate-400">Manhours</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full bg-red-500/20 border border-red-500"></span>
                  <span className="text-slate-400">Incidents</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="w-3 h-3 rounded-full bg-emerald-500/20 border border-emerald-500"></span>
                  <span className="text-slate-400">Inspections</span>
                </div>
              </div>
            </div>

            {/* Department Performance */}
            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
              <h3 className="font-bold text-white mb-6 flex items-center gap-2">
                <PieChart className="w-5 h-5 text-purple-400" />
                Department Performance
              </h3>
              <div className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={departments}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={({ name, incidents }) => `${name}: ${incidents}`}
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="incidents"
                    >
                      {departments.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', color: '#fff', borderRadius: '8px' }}
                    />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* KPI Summary */}
            <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
              <h3 className="font-bold text-white mb-4">KPI Summary</h3>
              <div className="space-y-3">
                {[
                  { label: 'Manpower Growth', value: '+4.2%', icon: <Users className="w-4 h-4" />, color: 'text-blue-400' },
                  { label: 'Incident Reduction', value: '-60%', icon: <AlertTriangle className="w-4 h-4" />, color: 'text-emerald-400' },
                  { label: 'Waste Reduction', value: '-10%', icon: <Leaf className="w-4 h-4" />, color: 'text-green-400' },
                  { label: 'Training Completion', value: '95%', icon: <Award className="w-4 h-4" />, color: 'text-purple-400' },
                ].map((kpi) => (
                  <div key={kpi.label} className="flex items-center justify-between p-2 hover:bg-slate-800/50 rounded-lg">
                    <div className="flex items-center gap-3">
                      <div className={`p-2 rounded-lg ${kpi.color.replace('text-', 'bg-')}/20`}>
                        <div className={kpi.color}>{kpi.icon}</div>
                      </div>
                      <span className="text-sm text-slate-300">{kpi.label}</span>
                    </div>
                    <span className={`font-bold ${kpi.color}`}>{kpi.value}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Additional Charts Section */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          {/* Department Radar Chart */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h3 className="font-bold text-white mb-6 flex items-center gap-2">
              <Target className="w-5 h-5 text-red-400" />
              Department Performance Radar
            </h3>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <RadarChart cx="50%" cy="50%" outerRadius="80%" data={departmentPerformance}>
                  <PolarGrid />
                  <PolarAngleAxis dataKey="subject" tick={{ fill: '#94a3b8' }} />
                  <PolarRadiusAxis angle={30} domain={[0, 10]} tick={{ fill: '#94a3b8' }} />
                  <Radar name="Performance" dataKey="A" stroke="#ef4444" fill="#ef4444" fillOpacity={0.3} />
                  <Radar name="Capacity" dataKey="B" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.3} />
                  <Radar name="Hours" dataKey="C" stroke="#10b981" fill="#10b981" fillOpacity={0.3} />
                  <Legend />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', color: '#fff', borderRadius: '8px' }}
                  />
                </RadarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* Monthly Comparison */}
          <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
            <h3 className="font-bold text-white mb-6 flex items-center gap-2">
              <BarChart3 className="w-5 h-5 text-amber-400" />
              Monthly Comparison
            </h3>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <ComposedChart data={chartData.slice(-6)}>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" />
                  <XAxis dataKey="name" tick={{ fill: '#94a3b8' }} />
                  <YAxis tick={{ fill: '#94a3b8' }} />
                  <Tooltip 
                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#1e293b', color: '#fff', borderRadius: '8px' }}
                  />
                  <Legend />
                  <Bar dataKey="manhours" fill="#3b82f6" name="Manhours" />
                  <Bar dataKey="incidents" fill="#ef4444" name="Incidents" />
                  <Line type="monotone" dataKey="nearMisses" stroke="#f59e0b" strokeWidth={2} name="Near Misses" />
                </ComposedChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>

        {/* Reports History */}
        <div className="bg-slate-900 border border-slate-800 rounded-xl p-6">
          <div className="flex items-center justify-between mb-6">
            <h3 className="font-bold text-white">Recent Reports</h3>
            <button className="text-sm text-sky-400 hover:text-sky-300 flex items-center gap-1">
              <Database className="w-4 h-4" />
              View All Reports
            </button>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="text-xs text-slate-500 uppercase border-b border-slate-800">
                <tr>
                  <th className="pb-3 font-bold text-left">Report Title</th>
                  <th className="pb-3 font-bold text-center">Period</th>
                  <th className="pb-3 font-bold text-center">Generated</th>
                  <th className="pb-3 font-bold text-center">Status</th>
                  <th className="pb-3 font-bold text-center">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-800">
                {reports.length > 0 ? (
                  reports.map(report => (
                    <tr key={report.id} className="hover:bg-slate-800/50">
                      <td className="py-3">
                        <div className="font-medium text-slate-300">{report.title}</div>
                        <div className="text-xs text-slate-500">{report.id}</div>
                      </td>
                      <td className="py-3 text-center text-slate-400">{report.period}</td>
                      <td className="py-3 text-center text-slate-400">
                        {new Date(report.generatedAt).toLocaleDateString()}
                      </td>
                      <td className="py-3 text-center">
                        <span className="px-2 py-1 rounded-full bg-emerald-900/30 text-emerald-400 text-xs border border-emerald-700/50">
                          Generated
                        </span>
                      </td>
                      <td className="py-3 text-center">
                        <div className="flex justify-center gap-2">
                          <button className="p-1 text-slate-500 hover:text-sky-400">
                            <Download className="w-4 h-4" />
                          </button>
                          <button className="p-1 text-slate-500 hover:text-emerald-400">
                            <Eye className="w-4 h-4" />
                          </button>
                          <button className="p-1 text-slate-500 hover:text-red-400">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td colSpan={5} className="py-8 text-center text-slate-500">
                      <FileText className="w-12 h-12 mx-auto mb-3 opacity-30" />
                      <p>No reports generated yet</p>
                      <p className="text-sm mt-1">Generate your first report using the export buttons above</p>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\InspectionConductModal.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Inspection, InspectionFinding, ChecklistTemplate, User, Project } from '../types';
import { Button } from './ui/Button';
import { useAppContext } from '../contexts';

interface InspectionConductModalProps {
  isOpen: boolean;
  onClose: () => void;
  inspection: Inspection;
  onUpdate: (inspection: Inspection, action?: 'submit' | 'approve' | 'request_revision' | 'close' | 'save') => void;
  onConvertToReport: (finding: InspectionFinding) => void;
  checklistTemplates: ChecklistTemplate[];
  users: User[];
  projects: Project[];
}

// --- ICONS ---
const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
const CameraIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>;
const MapPinIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>;

const FindingForm: React.FC<{
    finding: Partial<InspectionFinding>;
    onSave: (finding: InspectionFinding) => void;
    onCancel: () => void;
    users: User[];
}> = ({ finding, onSave, onCancel }) => {
    const [formData, setFormData] = useState({
        description: finding.description || '',
        risk_level: finding.risk_level || 'Low',
        category: finding.category || 'Unsafe Condition',
        evidence_urls: finding.evidence_urls || [],
        corrective_action_required: finding.corrective_action_required ?? true,
        responsible_person_id: finding.responsible_person_id || '',
        due_date: finding.due_date || '',
        gps_tag: finding.gps_tag
    });

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files) {
            // Mock upload for demo
            const newUrls = Array.from(e.target.files).map(() => `https://source.unsplash.com/random/200x200?sig=${Math.random()}`);
            setFormData(prev => ({ ...prev, evidence_urls: [...prev.evidence_urls, ...newUrls] }));
        }
    };

    const handleGetGps = () => {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                setFormData(prev => ({...prev, gps_tag: { lat: position.coords.latitude, lng: position.coords.longitude }}));
            },
            (error) => alert("Could not get location.")
        );
    };

    const handleSave = () => {
        if (!formData.description) return alert("Description is required");
        onSave({
            ...finding,
            ...formData,
            id: finding.id || `find_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
            status: 'Open'
        } as InspectionFinding);
    };

    return (
        <div className="p-4 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 mt-2 rounded-lg space-y-3 animate-fade-in">
            <div className="flex justify-between items-center">
                <h4 className="font-bold text-gray-900 dark:text-white text-sm">{finding.id ? 'Edit Finding' : 'New Finding'}</h4>
                <button onClick={onCancel} className="text-gray-400 hover:text-gray-600"><CloseIcon className="w-4 h-4"/></button>
            </div>
            
            <textarea
                value={formData.description}
                onChange={e => setFormData(p => ({ ...p, description: e.target.value }))}
                placeholder="Describe the non-conformance or hazard..."
                rows={2} 
                className="w-full text-sm p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-black/20 text-gray-900 dark:text-white focus:ring-2 focus:ring-red-500 outline-none"
            />
            
            <div className="grid grid-cols-2 gap-3">
                <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">Risk Level</label>
                    <select 
                        value={formData.risk_level} 
                        onChange={e => setFormData(p => ({ ...p, risk_level: e.target.value as any}))} 
                        className="w-full text-sm p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-black/20 text-gray-900 dark:text-white"
                    >
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">Category</label>
                    <select 
                        value={formData.category} 
                        onChange={e => setFormData(p => ({ ...p, category: e.target.value as any }))} 
                        className="w-full text-sm p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-black/20 text-gray-900 dark:text-white"
                    >
                        <option>Unsafe Act</option>
                        <option>Unsafe Condition</option>
                        <option>Documentation</option>
                        <option>Equipment</option>
                        <option>Environmental</option>
                    </select>
                </div>
            </div>

            <div className="flex items-center gap-3">
                <label className="flex items-center gap-2 text-sm text-blue-600 cursor-pointer hover:text-blue-700">
                    <CameraIcon className="w-4 h-4" />
                    <span>Add Photo</span>
                    <input type="file" multiple accept="image/*" className="hidden" onChange={handleFileChange} />
                </label>
                <button onClick={handleGetGps} className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800 dark:text-gray-400">
                    <MapPinIcon className="w-4 h-4" />
                    <span>{formData.gps_tag ? 'Location Tagged' : 'Tag Location'}</span>
                </button>
            </div>

            {formData.evidence_urls.length > 0 && (
                <div className="flex gap-2 overflow-x-auto py-2">
                    {formData.evidence_urls.map((url, i) => (
                        <img key={i} src={url} alt="Evidence" className="h-12 w-12 object-cover rounded border border-gray-300" />
                    ))}
                </div>
            )}

            <div className="pt-2 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
                <Button variant="secondary" size="sm" onClick={onCancel}>Cancel</Button>
                <Button size="sm" onClick={handleSave} className="bg-red-600 hover:bg-red-700 text-white border-none">Save Finding</Button>
            </div>
        </div>
    );
};

const FindingDisplay: React.FC<{ finding: InspectionFinding, onConvertToReport: () => void, onEdit: () => void, isReviewer: boolean }> = ({ finding, onConvertToReport, onEdit, isReviewer }) => (
    <div className="mt-3 p-3 bg-red-50 dark:bg-red-900/10 border-l-4 border-red-500 rounded-r-md shadow-sm">
        <div className="flex justify-between items-start">
            <div>
                <div className="flex items-center gap-2 mb-1">
                    <span className={`text-xs font-bold px-2 py-0.5 rounded text-white ${finding.risk_level === 'High' ? 'bg-red-600' : finding.risk_level === 'Medium' ? 'bg-orange-500' : 'bg-yellow-500'}`}>
                        {finding.risk_level}
                    </span>
                    <span className="text-xs text-gray-500 dark:text-gray-400">{finding.category}</span>
                </div>
                <p className="text-sm font-medium text-gray-900 dark:text-gray-100">{finding.description}</p>
                
                {finding.evidence_urls.length > 0 && (
                    <div className="mt-2 flex gap-2">
                        {finding.evidence_urls.map((url, i) => (
                            <a key={i} href={url} target="_blank" rel="noreferrer">
                                <img src={url} alt="Evidence" className="h-10 w-10 object-cover rounded border border-red-200" />
                            </a>
                        ))}
                    </div>
                )}
            </div>
            <div className="flex flex-col gap-2">
                {!isReviewer && <Button variant="ghost" size="sm" onClick={onEdit}>Edit</Button>}
                <Button variant="secondary" size="sm" onClick={onConvertToReport} className="text-xs">Create Report</Button>
            </div>
        </div>
    </div>
);

export const InspectionConductModal: React.FC<InspectionConductModalProps> = (props) => {
    const { isOpen, onClose, inspection, onUpdate, onConvertToReport, checklistTemplates, users } = props;
    const { activeUser, language, activeOrg } = useAppContext();
    const [currentInspection, setCurrentInspection] = useState(inspection);
    const [editingFinding, setEditingFinding] = useState<Partial<InspectionFinding> | null>(null);

    // Helper to safely get translated string
    const getTranslated = (textRecord: string | Record<string, string> | undefined) => {
        if (!textRecord) return '';
        if (typeof textRecord === 'string') return textRecord;
        return textRecord[language] || textRecord[activeOrg.primaryLanguage] || textRecord['en'] || Object.values(textRecord)[0] || '';
    };

    const template = useMemo(() => checklistTemplates.find(t => t.id === inspection.checklist_template_id), [checklistTemplates, inspection]);
    const isReviewer = useMemo(() => ['HSE_MANAGER', 'SUPERVISOR', 'ADMIN'].includes(activeUser?.role || ''), [activeUser?.role]);
    const isSubmitted = useMemo(() => ['Submitted', 'Under Review', 'Approved', 'Closed'].includes(currentInspection.status), [currentInspection.status]);
    
    const itemFindings = useMemo(() => (currentInspection.findings || []).filter(f => f.checklist_item_id), [currentInspection.findings]);
    const generalFindings = useMemo(() => (currentInspection.findings || []).filter(f => !f.checklist_item_id), [currentInspection.findings]);

    const handleSaveFinding = (finding: InspectionFinding) => {
        setCurrentInspection(prev => {
            const findings = prev.findings || [];
            const existingIndex = findings.findIndex(f => f.id === finding.id);
            let newFindings;
            if (existingIndex > -1) {
                newFindings = [...findings];
                newFindings[existingIndex] = finding;
            } else {
                newFindings = [...findings, finding];
            }
            return { ...prev, findings: newFindings };
        });
        setEditingFinding(null);
    };

    if (!isOpen || !template) return null;

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center items-start p-4 overflow-y-auto" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-5xl my-8 flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <header className="p-5 border-b dark:border-dark-border bg-white dark:bg-dark-card rounded-t-xl sticky top-0 z-10 flex justify-between items-center">
             <div>
                <div className="flex items-center gap-2">
                    <h2 className="text-xl font-bold text-gray-900 dark:text-white">{inspection.title}</h2>
                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${inspection.status === 'Ongoing' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}`}>
                        {inspection.status}
                    </span>
                </div>
                <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Template: {getTranslated(template.title)}</p>
             </div>
            <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full transition-colors">
                <CloseIcon className="w-6 h-6 text-gray-500" />
            </button>
        </header>

        <main className="p-6 space-y-8">
            {/* Checklist Items Section */}
            <section>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 dark:border-gray-700">Checklist Items</h3>
                <div className="space-y-4">
                    {template.items.map((item, index) => {
                        const finding = itemFindings.find(f => f.checklist_item_id === item.id);
                        const isEditingThis = editingFinding?.checklist_item_id === item.id;
                        
                        return (
                            <div key={item.id} className={`p-4 border rounded-lg transition-all ${finding ? 'border-red-300 bg-red-50/30 dark:border-red-900/50' : 'border-gray-200 dark:border-gray-700'}`}>
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            <span className="flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-800 text-xs font-bold text-gray-600 dark:text-gray-300">
                                                {index + 1}
                                            </span>
                                            <p className="font-medium text-gray-900 dark:text-white">{getTranslated(item.text)}</p>
                                        </div>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 ml-8 mt-1">{getTranslated(item.description)}</p>
                                    </div>
                                    
                                    {!finding && !isEditingThis && !isSubmitted && (
                                        <div className="flex gap-2">
                                            <button className="px-3 py-1 rounded border border-green-200 bg-green-50 text-green-700 text-xs font-medium hover:bg-green-100">Pass</button>
                                            <button 
                                                onClick={() => setEditingFinding({ checklist_item_id: item.id })}
                                                className="px-3 py-1 rounded border border-red-200 bg-red-50 text-red-700 text-xs font-medium hover:bg-red-100 flex items-center gap-1"
                                            >
                                                <CameraIcon className="w-3 h-3"/> Fail / Finding
                                            </button>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Finding Form or Display */}
                                {isEditingThis ? (
                                    <FindingForm
                                        finding={editingFinding!}
                                        onSave={handleSaveFinding}
                                        onCancel={() => setEditingFinding(null)}
                                        users={users}
                                    />
                                ) : finding ? (
                                    <div className="ml-8">
                                        <FindingDisplay
                                            finding={finding}
                                            onEdit={() => setEditingFinding(finding)}
                                            onConvertToReport={() => onConvertToReport(finding)}
                                            isReviewer={isReviewer && isSubmitted}
                                        />
                                    </div>
                                ) : null}
                            </div>
                        );
                    })}
                </div>
            </section>

            {/* General Findings Section */}
            <section>
                <div className="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-700">
                    <h3 className="text-lg font-bold text-gray-900 dark:text-white">General Observations</h3>
                    {!isSubmitted && (
                        <Button variant="secondary" size="sm" onClick={() => setEditingFinding({})} leftIcon={<CameraIcon className="w-4 h-4"/>}>
                            Add General Finding
                        </Button>
                    )}
                </div>

                {/* New General Finding Form */}
                {editingFinding && !editingFinding.checklist_item_id && (
                     <FindingForm
                        finding={editingFinding}
                        onSave={handleSaveFinding}
                        onCancel={() => setEditingFinding(null)}
                        users={users}
                    />
                )}

                <div className="space-y-4 mt-4">
                    {generalFindings.map(finding => (
                        editingFinding?.id === finding.id ? (
                             <FindingForm
                                key={finding.id}
                                finding={editingFinding!}
                                onSave={handleSaveFinding}
                                onCancel={() => setEditingFinding(null)}
                                users={users}
                            />
                        ) : (
                            <div key={finding.id} className="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <FindingDisplay
                                    finding={finding}
                                    onEdit={() => setEditingFinding(finding)}
                                    onConvertToReport={() => onConvertToReport(finding)}
                                    isReviewer={isReviewer && isSubmitted}
                                />
                            </div>
                        )
                    ))}
                    {generalFindings.length === 0 && !editingFinding && (
                        <p className="text-sm text-gray-500 italic text-center py-4">No general observations recorded.</p>
                    )}
                </div>
            </section>

             {/* Review Section */}
             {(isReviewer && isSubmitted) && (
                <section className="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-lg border border-blue-100 dark:border-blue-800">
                    <h3 className="text-md font-bold mb-2 text-blue-900 dark:text-blue-200">Reviewer Comments</h3>
                    <textarea 
                        placeholder="Add overall comments regarding this inspection..."
                        rows={3}
                        className="w-full p-3 border border-blue-200 dark:border-blue-800 rounded bg-white dark:bg-black/20 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                        value={currentInspection.overall_comments || ''}
                        onChange={e => setCurrentInspection(p => ({...p, overall_comments: e.target.value}))}
                    />
                </section>
            )}
        </main>
        
        {/* Footer Actions */}
        <footer className="p-5 border-t dark:border-dark-border bg-gray-50 dark:bg-dark-card rounded-b-xl flex justify-between items-center sticky bottom-0">
            <Button variant="secondary" onClick={onClose}>Close</Button>
            <div className="space-x-3">
                {!isSubmitted && <Button variant="secondary" onClick={() => onUpdate(currentInspection, 'save')}>Save Draft</Button>}
                {!isSubmitted && <Button onClick={() => onUpdate(currentInspection, 'submit')} className="bg-green-600 hover:bg-green-700 text-white border-none">Submit Inspection</Button>}
                
                {(isReviewer && isSubmitted) && (
                    <>
                        <Button variant="secondary" onClick={() => onUpdate(currentInspection, 'request_revision')}>Request Revision</Button>
                        <Button onClick={() => onUpdate(currentInspection, 'approve')} className="bg-blue-600 hover:bg-blue-700 text-white border-none">Approve</Button>
                    </>
                )}
                 {currentInspection.status === 'Approved' && isReviewer && (
                    <Button onClick={() => onUpdate(currentInspection, 'close')} className="bg-gray-800 text-white">Archive Inspection</Button>
                 )}
            </div>
        </footer>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\InspectionCreationModal.tsx
==================================================

import React, { useEffect, useMemo, useState } from 'react';
import type { ChecklistTemplate, Inspection, Project, User } from '../types';
import { Button } from './ui/Button';
import { useAppContext } from '../contexts';
import { 
  X, Check, AlertTriangle, Upload, 
  ChevronRight, Building, Calendar, Shield, Users
} from 'lucide-react';

// ================================
// GLOBAL / INTERNATIONAL INSPECTION SETUP
// ================================

type StdRef = 'ISO 45001' | 'OSHA' | 'ISO 14001' | 'ILO' | 'NFPA' | 'NEOM' | 'Local Regs';
type InspectionFrequency = 'One-off' | 'Daily' | 'Weekly' | 'Monthly' | 'Quarterly';

type HseComplianceKey =
  | 'risk_assessment_done'
  | 'ptw_required'
  | 'ptw_ready'
  | 'rams_jsa_available'
  | 'toolbox_talk_done'
  | 'competency_verified'
  | 'ppe_ready'
  | 'equipment_cert_valid'
  | 'housekeeping_ready'
  | 'emergency_plan_confirmed'
  | 'first_aid_available'
  | 'fire_extinguishers_checked'
  | 'environmental_controls_ready'
  | 'msds_available'
  | 'stop_work_authority_confirmed';

const DEFAULT_COMPLIANCE: Record<HseComplianceKey, boolean> = {
  risk_assessment_done: false,
  ptw_required: false,
  ptw_ready: false,
  rams_jsa_available: false,
  toolbox_talk_done: false,
  competency_verified: false,
  ppe_ready: false,
  equipment_cert_valid: false,
  housekeeping_ready: false,
  emergency_plan_confirmed: false,
  first_aid_available: false,
  fire_extinguishers_checked: false,
  environmental_controls_ready: false,
  msds_available: false,
  stop_work_authority_confirmed: false,
};

const complianceLabels: Array<{ key: HseComplianceKey; label: string; critical?: boolean }> = [
  { key: 'risk_assessment_done', label: 'Risk Assessment / JSA completed', critical: true },
  { key: 'ptw_required', label: 'Permit to Work required?', critical: true },
  { key: 'ptw_ready', label: 'PTW authorized (if required)', critical: true },
  { key: 'rams_jsa_available', label: 'RAMS / Method Statement briefed', critical: true },
  { key: 'toolbox_talk_done', label: 'Toolbox Talk conducted', critical: false },
  { key: 'competency_verified', label: 'Worker competency verified', critical: false },
  { key: 'ppe_ready', label: 'PPE suitable and available', critical: true },
  { key: 'equipment_cert_valid', label: 'Equipment certificates valid', critical: false },
  { key: 'housekeeping_ready', label: 'Access routes clear', critical: false },
  { key: 'emergency_plan_confirmed', label: 'Emergency plan confirmed', critical: true },
  { key: 'first_aid_available', label: 'First aid available', critical: false },
  { key: 'fire_extinguishers_checked', label: 'Fire extinguishers checked', critical: false },
  { key: 'environmental_controls_ready', label: 'Spill kits/Waste bins ready', critical: false },
  { key: 'msds_available', label: 'MSDS available (if chemical)', critical: false },
  { key: 'stop_work_authority_confirmed', label: 'Stop Work Authority communicated', critical: true },
];

const stdRefs: StdRef[] = ['ISO 45001', 'OSHA', 'ISO 14001', 'ILO', 'NFPA', 'NEOM', 'Local Regs'];

// Helper for tabs
const TabButton: React.FC<{ active: boolean; onClick: () => void; icon: React.ReactNode; label: string }> = ({ active, onClick, icon, label }) => (
    <button
        onClick={onClick}
        className={`px-4 py-3 font-bold text-sm flex items-center gap-2 border-b-2 transition-all ${
            active ? 'border-blue-600 text-blue-700 dark:text-blue-400 dark:border-blue-400' : 'border-transparent text-gray-700 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
        }`}
    >
        {icon}
        {label}
    </button>
);

// Card Section Wrapper
const CardSection: React.FC<{ title: string; children: React.ReactNode; className?: string }> = ({ title, children, className }) => (
    <div className={`border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden mb-6 ${className}`}>
        <div className="bg-gray-100 dark:bg-gray-800 px-4 py-3 border-b border-gray-300 dark:border-gray-700">
            <h3 className="text-sm font-black text-gray-900 dark:text-white uppercase tracking-wide">{title}</h3>
        </div>
        <div className="p-4 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
            {children}
        </div>
    </div>
);

export const InspectionCreationModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (inspection: Omit<Inspection, 'id' | 'org_id' | 'created_by_id' | 'audit_trail'>) => void;
  projects?: Project[];
  users?: User[];
  checklistTemplates?: ChecklistTemplate[];
}> = ({ isOpen, onClose, onSubmit, projects = [], users = [], checklistTemplates = [] }) => {
  const { activeOrg } = useAppContext();
  const [activeTab, setActiveTab] = useState<'identification' | 'schedule' | 'properties' | 'team'>('identification');

  // Base form state
  const [title, setTitle] = useState('');
  const [type, setType] = useState<Inspection['type']>('Safety');
  const [projectId, setProjectId] = useState('');
  const [personResponsibleId, setPersonResponsibleId] = useState('');
  const [checklistTemplateId, setChecklistTemplateId] = useState('');
  const [scheduleAt, setScheduleAt] = useState('');
  const [teamMemberIds, setTeamMemberIds] = useState<string[]>([]);
  const [observers, setObservers] = useState<string[]>([]);

  // Global enhancement fields
  const [locationArea, setLocationArea] = useState('');
  const [contractorName, setContractorName] = useState('');
  const [frequency, setFrequency] = useState<InspectionFrequency>('One-off');
  const [selectedStandards, setSelectedStandards] = useState<StdRef[]>(['ISO 45001']);
  const [preInspectionBriefing, setPreInspectionBriefing] = useState('');
  const [ppeRequirements, setPpeRequirements] = useState('');
  const [hseCompliance, setHseCompliance] = useState<Record<HseComplianceKey, boolean>>(DEFAULT_COMPLIANCE);
  const [evidenceFiles, setEvidenceFiles] = useState<File[]>([]);

  // Reset when opened
  useEffect(() => {
    if (!isOpen) return;

    const now = new Date();
    // Adjust to local ISO string manually to keep timezone offset correct for inputs
    const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

    setTitle('');
    setType('Safety');
    setProjectId((projects && projects.length > 0) ? projects[0].id : '');
    setPersonResponsibleId('');
    setChecklistTemplateId((checklistTemplates && checklistTemplates.length > 0) ? checklistTemplates[0].id : '');
    setScheduleAt(localIso);
    setTeamMemberIds([]);
    setObservers([]);

    setLocationArea('');
    setContractorName('');
    setFrequency('One-off');
    setSelectedStandards(['ISO 45001']);
    setPreInspectionBriefing('');
    setPpeRequirements('');
    setHseCompliance(DEFAULT_COMPLIANCE);
    setEvidenceFiles([]);
  }, [isOpen, projects, checklistTemplates]);

  const selectedProject = useMemo(() => (projects || []).find(p => p.id === projectId), [projects, projectId]);

  // Filter templates safely
  const filteredTemplates = useMemo(() => {
    const safeTemplates = checklistTemplates || [];
    const byType = safeTemplates.filter(tpl => (tpl.category || '').toLowerCase().includes(type.toLowerCase()));
    return byType.length > 0 ? byType : safeTemplates;
  }, [checklistTemplates, type]);

  // Readiness score
  const readiness = useMemo(() => {
    const total = complianceLabels.length;
    const done = complianceLabels.filter(i => hseCompliance[i.key]).length;
    const criticalMissing = complianceLabels
      .filter(i => i.critical)
      .filter(i => !hseCompliance[i.key])
      .map(i => i.label);
    const score = total === 0 ? 0 : Math.round((done / total) * 100);
    return { total, done, score, criticalMissing };
  }, [hseCompliance]);

  const autoTitle = useMemo(() => {
    const projName = selectedProject?.name ? ` - ${selectedProject.name}` : '';
    const datePart = scheduleAt ? ` - ${new Date(scheduleAt).toLocaleDateString()}` : '';
    return `${type} Inspection${projName}${datePart}`;
  }, [type, selectedProject?.name, scheduleAt]);

  const validationStatus = useMemo(() => {
      if (!projectId) return 'Select a Project';
      if (!checklistTemplateId) return 'Select a Checklist';
      if (!scheduleAt) return 'Set a Date/Time';
      if (readiness.criticalMissing.length > 0) return `${readiness.criticalMissing.length} Critical Checks Missing`;
      return 'ready';
  }, [projectId, checklistTemplateId, scheduleAt, readiness.criticalMissing]);

  const canCreate = validationStatus === 'ready';

  const toggleArray = (arr: string[], v: string) => (arr.includes(v) ? arr.filter(x => x !== v) : [...arr, v]);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
        setEvidenceFiles(prev => [...prev, ...Array.from(e.target.files!)]);
    }
  };

  const handleRemoveFile = (index: number) => {
    setEvidenceFiles(prev => prev.filter((_, i) => i !== index));
  };

  const handleSelectAllCompliance = () => {
      const allChecked: any = {};
      complianceLabels.forEach(item => {
          allChecked[item.key] = true;
      });
      setHseCompliance(allChecked);
  };

  const handleJumpToFix = () => {
    if (readiness.criticalMissing.length > 0) {
        setActiveTab('schedule');
    } else if (!projectId) {
        setActiveTab('identification');
    }
  };

  const getTemplateTitle = (tpl: ChecklistTemplate): string => {
    if (!tpl) return '';
    if (typeof tpl.title === 'string') return tpl.title;
    // @ts-ignore
    return tpl.title['en'] || Object.values(tpl.title)[0] || 'Untitled';
  };

  const handleCreate = () => {
    if (!canCreate) return;

    const finalTitle = title.trim() || autoTitle;
    const fakeUrls = evidenceFiles.map(() => `https://source.unsplash.com/random/200x200?sig=${Math.random()}`);

    const meta = [
      `Scope: ${locationArea || 'N/A'}`,
      `Contractor: ${contractorName || 'N/A'}`,
      `Ref: ${selectedStandards.join(', ')}`,
      `Brief: ${preInspectionBriefing || 'N/A'}`,
      `PPE: ${ppeRequirements || 'N/A'}`,
      `Readiness: ${readiness.score}%`,
      `Evidence: ${evidenceFiles.length} files`,
    ].join('\n');

    const newInspection = {
      project_id: projectId,
      title: finalTitle,
      type,
      status: 'Ongoing' as const,
      person_responsible_id: personResponsibleId,
      checklist_template_id: checklistTemplateId,
      schedule_at: scheduleAt,
      team_member_ids: teamMemberIds,
      observers,
      findings: [],
      overall_comments: meta,
      // @ts-ignore
      hse_compliance: hseCompliance,
      evidence_urls: fakeUrls,
    };

    onSubmit(newInspection);
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-slate-900 w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] border border-gray-200 dark:border-gray-800" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-5 border-b dark:border-gray-800 flex items-start justify-between shrink-0 bg-white dark:bg-slate-900 sticky top-0 z-10">
          <div>
            <h2 className="text-xl font-black text-gray-900 dark:text-white flex items-center gap-2">
              Create Modern Inspection
            </h2>
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Planning â†’ Readiness â†’ Evidence â†’ Checklist
            </p>
          </div>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-white/10 text-gray-500 transition-colors">
             <X className="w-5 h-5" />
          </button>
        </div>

        {/* Tabs Navigation */}
        <div className="flex border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 overflow-x-auto">
            <TabButton active={activeTab === 'identification'} onClick={() => setActiveTab('identification')} icon={<Building className="w-4 h-4"/>} label="Identification" />
            <TabButton active={activeTab === 'schedule'} onClick={() => setActiveTab('schedule')} icon={<Calendar className="w-4 h-4"/>} label="Readiness" />
            <TabButton active={activeTab === 'properties'} onClick={() => setActiveTab('properties')} icon={<Shield className="w-4 h-4"/>} label="Details" />
            <TabButton active={activeTab === 'team'} onClick={() => setActiveTab('team')} icon={<Users className="w-4 h-4"/>} label="Team" />
        </div>

        <div className="p-6 space-y-6 overflow-y-auto flex-1 bg-white dark:bg-slate-900">
          
          {/* TAB 1: IDENTIFICATION */}
          {activeTab === 'identification' && (
            <div className="space-y-6">
                <CardSection title="Core Information">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="md:col-span-2">
                            <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Inspection Title</label>
                            <input
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                placeholder={autoTitle}
                                className="w-full rounded-lg border border-gray-300 px-3 py-2.5 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Type</label>
                            <div className="relative">
                              <select
                                  value={type}
                                  onChange={(e) => setType(e.target.value as Inspection['type'])}
                                  className="w-full rounded-lg border border-gray-300 px-3 py-2.5 bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white appearance-none"
                              >
                                  <option value="Safety">Safety</option>
                                  <option value="Quality">Quality</option>
                                  <option value="Environmental">Environmental</option>
                                  <option value="Fire">Fire</option>
                                  <option value="Equipment">Equipment</option>
                              </select>
                              <ChevronRight className="w-4 h-4 text-gray-400 absolute right-3 top-4 rotate-90 pointer-events-none" />
                            </div>
                        </div>
                        <div>
                            <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Project</label>
                            <div className="relative">
                              <select
                                  value={projectId}
                                  onChange={(e) => setProjectId(e.target.value)}
                                  className={`w-full rounded-lg border px-3 py-2.5 bg-white text-gray-900 dark:bg-gray-800 dark:text-white appearance-none ${!projectId ? 'border-red-400 ring-1 ring-red-200' : 'border-gray-300 dark:border-gray-700'}`}
                              >
                                  <option value="">Select project...</option>
                                  {(projects || []).map(p => (
                                  <option key={p.id} value={p.id}>{p.name}</option>
                                  ))}
                              </select>
                              <ChevronRight className="w-4 h-4 text-gray-400 absolute right-3 top-4 rotate-90 pointer-events-none" />
                            </div>
                        </div>
                        <div className="md:col-span-2">
                             <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Scope / Location / Area</label>
                            <input
                                value={locationArea}
                                onChange={(e) => setLocationArea(e.target.value)}
                                placeholder="e.g., Area-03, Workshop, Roof..."
                                className="w-full rounded-lg border border-gray-300 px-3 py-2.5 bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                            />
                        </div>
                    </div>
                </CardSection>
            </div>
          )}

          {/* TAB 2: SCHEDULE & READINESS */}
          {activeTab === 'schedule' && (
              <div className="space-y-6">
                <div className="rounded-xl border border-blue-200 bg-blue-50 dark:border-blue-900/30 dark:bg-blue-900/10 p-5 space-y-4">
                    <div className="flex items-center justify-between">
                        <h3 className="font-bold text-blue-900 dark:text-blue-200 flex items-center gap-2">
                            <AlertTriangle className="w-5 h-5 text-blue-500" />
                            Pre-Inspection Readiness Check
                        </h3>
                        <div className="flex gap-2">
                            <button 
                                onClick={handleSelectAllCompliance} 
                                className="text-xs font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 flex items-center gap-1 hover:underline"
                            >
                                <Check className="w-4 h-4" /> Mark All Ready
                            </button>
                            <span className={`text-sm font-bold px-3 py-1 rounded-full ${readiness.score === 100 ? 'bg-green-100 text-green-700' : 'bg-white text-blue-700 shadow-sm border border-blue-100'}`}>
                                {readiness.score}% Ready
                            </span>
                        </div>
                    </div>

                    {/* Checkbox Grid - MOVED UP */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
                      {complianceLabels.map(item => (
                        <label key={item.key} className={`flex items-start gap-3 text-sm cursor-pointer p-3 rounded-lg border transition-all ${hseCompliance[item.key] ? 'bg-green-50 border-green-200 dark:bg-green-900/20 dark:border-green-800' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-blue-300'}`}>
                          <input
                            type="checkbox"
                            checked={hseCompliance[item.key]}
                            onChange={(e) => setHseCompliance(prev => ({ ...prev, [item.key]: e.target.checked }))}
                            className="mt-0.5 rounded text-blue-600 focus:ring-blue-500 w-4 h-4 border-gray-300"
                          />
                          <span className={`${item.critical ? 'font-bold text-slate-900 dark:text-white' : 'text-slate-600 dark:text-slate-300'}`}>
                            {item.label} {item.critical && <span className="text-red-500 ml-1" title="Required">*</span>}
                          </span>
                        </label>
                      ))}
                    </div>

                    {/* Warning Box - MOVED DOWN */}
                    {readiness.criticalMissing.length > 0 && (
                        <div className="mt-4 bg-red-50 dark:bg-red-950/40 border border-red-200 dark:border-red-900/50 rounded-lg p-3 text-sm text-red-700 dark:text-red-300">
                            <p className="font-bold mb-1">Action Required: {readiness.criticalMissing.length} Critical Items Missing</p>
                            <ul className="list-disc ml-5 space-y-0.5 text-xs">
                                {readiness.criticalMissing.slice(0, 3).map((x, i) => <li key={i}>{x}</li>)}
                                {readiness.criticalMissing.length > 3 && <li>...and {readiness.criticalMissing.length - 3} more</li>}
                            </ul>
                        </div>
                    )}
                </div>

                <CardSection title="Timing">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Schedule Date</label>
                            <input
                                type="datetime-local"
                                value={scheduleAt}
                                onChange={(e) => setScheduleAt(e.target.value)}
                                className="w-full rounded-lg border border-gray-300 px-3 py-2 bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                            />
                        </div>
                    </div>
                </CardSection>
            </div>
          )}

          {/* TAB 3: PROPERTIES */}
          {activeTab === 'properties' && (
              <div className="space-y-6">
                <CardSection title="Checklist & Standards">
                     <div className="mb-4">
                        <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Checklist Template</label>
                        <select
                            value={checklistTemplateId}
                            onChange={(e) => setChecklistTemplateId(e.target.value)}
                            className="w-full rounded-lg border border-gray-300 px-3 py-2 bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                        >
                            <option value="">Select checklist template</option>
                            {filteredTemplates.map(tpl => (
                            <option key={tpl.id} value={tpl.id}>
                                {tpl.category} - {getTemplateTitle(tpl)}
                            </option>
                            ))}
                        </select>
                    </div>

                     <div>
                        <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-2 block">Reference Standards</label>
                        <div className="flex flex-wrap gap-2">
                            {stdRefs.map(std => (
                            <button
                                key={std}
                                type="button"
                                onClick={() =>
                                setSelectedStandards(prev => prev.includes(std) ? prev.filter(x => x !== std) : [...prev, std])
                                }
                                className={`px-3 py-1.5 rounded-full text-xs font-semibold border transition-colors ${
                                selectedStandards.includes(std)
                                    ? 'bg-primary-600 text-white border-primary-600 shadow-sm'
                                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600'
                                }`}
                            >
                                {std}
                            </button>
                            ))}
                        </div>
                    </div>
                </CardSection>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <CardSection title="Briefing & Hazards" className="h-full">
                         <textarea 
                            value={preInspectionBriefing}
                            onChange={(e) => setPreInspectionBriefing(e.target.value)}
                            className="w-full h-32 p-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 focus:outline-none" 
                            placeholder="Key hazards discussed..."
                        />
                    </CardSection>
                    <CardSection title="PPE Requirements" className="h-full">
                         <textarea 
                            value={ppeRequirements}
                            onChange={(e) => setPpeRequirements(e.target.value)}
                            className="w-full h-32 p-2 text-sm border border-gray-300 rounded-lg bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:ring-2 focus:ring-primary-500 focus:outline-none" 
                            placeholder="Helmet, Boots, Vest..."
                         />
                    </CardSection>
                </div>
              </div>
          )}

          {/* TAB 4: TEAM */}
          {activeTab === 'team' && (
              <div className="space-y-6">
                <CardSection title="Inspection Team">
                    <div className="mb-6">
                        <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-1 block">Lead Inspector</label>
                        <select
                            value={personResponsibleId}
                            onChange={(e) => setPersonResponsibleId(e.target.value)}
                            className="w-full rounded-lg border border-gray-300 px-3 py-2 bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                        >
                            <option value="">Select person</option>
                            {(users || []).map(u => (
                            <option key={u.id} value={u.id}>{u.name}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label className="text-sm font-bold text-gray-900 dark:text-gray-100 mb-2 block">Additional Members</label>
                        <div className="flex flex-wrap gap-2">
                            {(users || []).slice(0, 10).map(u => (
                                <button
                                key={u.id}
                                type="button"
                                onClick={() => setTeamMemberIds(prev => toggleArray(prev, u.id))}
                                className={`px-3 py-1.5 rounded-full text-xs font-semibold border transition-all ${
                                    teamMemberIds.includes(u.id)
                                    ? 'bg-emerald-600 text-white border-emerald-600 shadow-sm'
                                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300'
                                }`}
                                >
                                {u.name}
                                </button>
                            ))}
                        </div>
                    </div>
                </CardSection>

                {/* Evidence Upload */}
                <CardSection title="Pre-Inspection Media / Evidence">
                    <div className="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-8 text-center hover:bg-gray-50 dark:hover:bg-white/5 transition-colors cursor-pointer relative group">
                        <input 
                            type="file" 
                            multiple 
                            accept="image/*,video/*" 
                            onChange={handleFileChange} 
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                        />
                        <div className="flex flex-col items-center gap-2 text-gray-500 dark:text-gray-400 group-hover:scale-105 transition-transform">
                            <div className="p-3 bg-gray-100 dark:bg-gray-800 rounded-full">
                              <Upload className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-medium">Click to upload photos or videos</span>
                            <span className="text-xs text-gray-400">Supports JPG, PNG, MP4</span>
                        </div>
                    </div>
                    
                    {evidenceFiles.length > 0 && (
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                            {evidenceFiles.map((file, i) => (
                                <div key={i} className="relative group bg-gray-100 dark:bg-gray-800 p-2 rounded-lg flex items-center gap-2 border border-gray-200 dark:border-gray-700">
                                    <div className="w-8 h-8 bg-gray-300 dark:bg-gray-600 rounded flex-shrink-0 flex items-center justify-center text-xs font-bold text-white">IMG</div>
                                    <span className="text-xs truncate flex-1 text-gray-700 dark:text-gray-300">{file.name}</span>
                                    <button 
                                        onClick={() => handleRemoveFile(i)}
                                        className="text-gray-400 hover:text-red-500 p-1"
                                    >
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </CardSection>
              </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-5 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 flex items-center justify-between gap-3 shrink-0">
          <div className="text-sm text-gray-500 flex items-center gap-2">
            {selectedProject ? (
              <>
                  <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                  <span className="text-gray-600 dark:text-gray-300">Linked to: <span className="font-bold text-gray-900 dark:text-white">{selectedProject.name}</span></span>
              </>
            ) : (
               <>
                  <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                  <span className="text-red-500 font-medium">Select a Project</span>
              </>
            )}
          </div>

          <div className="flex gap-3 items-center">
            {!canCreate && (
                <button 
                    onClick={handleJumpToFix}
                    className="text-xs font-bold text-red-500 mr-2 text-right hover:underline"
                >
                    {validationStatus}
                </button>
            )}
            <Button variant="secondary" onClick={onClose}>
              Cancel
            </Button>
            <Button 
                onClick={handleCreate} 
                disabled={!canCreate} 
                className={!canCreate ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-emerald-600 hover:bg-emerald-700 text-white shadow-lg'}
            >
              Create Inspection
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Inspections.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Inspection, InspectionStatus, InspectionFinding } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { InspectionCreationModal } from './InspectionCreationModal';
import { InspectionConductModal } from './InspectionConductModal';
import { useAppContext, useDataContext, useModalContext } from '../contexts';

// ICONS
const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>;
const ClipboardIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504 1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>;

const InspectionCard: React.FC<{
    inspection: Inspection;
    onConduct: (inspection: Inspection) => void;
}> = ({ inspection, onConduct }) => {
    const { usersList } = useAppContext();
    const { projects } = useDataContext();
    const responsible = usersList.find(u => u.id === inspection.person_responsible_id)?.name || 'Unknown';
    const project = projects.find(p => p.id === inspection.project_id)?.name || 'Unknown';
    
    const getStatusColor = (status: Inspection['status']): 'green' | 'blue' | 'yellow' | 'red' | 'gray' => {
        switch (status) {
            case 'Closed':
            case 'Approved': return 'green';
            case 'In Progress': return 'blue';
            case 'Scheduled': return 'blue';
            case 'Pending Review': return 'yellow';
            case 'Draft': return 'gray';
            case 'Overdue': return 'red';
            default: return 'gray';
        }
    };
    
    const findingsCount = inspection.findings?.length || 0;
    const statusText = inspection.status ? inspection.status.replace(/_/g, ' ') : 'Unknown';

    return (
        <Card className="hover:border-blue-300 transition-colors">
            <div className="flex justify-between items-start">
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <ClipboardIcon className="w-6 h-6 text-blue-600 dark:text-blue-400" />
                    </div>
                    <div>
                        <h3 className="font-bold text-md text-text-primary pr-2">{inspection.title}</h3>
                        <p className="text-xs text-text-secondary">{inspection.id || 'ID Pending'}</p>
                    </div>
                </div>
                <Badge color={getStatusColor(inspection.status)}>{statusText}</Badge>
            </div>
            
            <div className="grid grid-cols-2 gap-4 mt-4 py-3 border-t border-b border-gray-100 dark:border-gray-800">
                 <div>
                    <span className="text-xs text-gray-500 block">Project</span>
                    <span className="text-sm font-medium">{project}</span>
                 </div>
                 <div>
                    <span className="text-xs text-gray-500 block">Assigned To</span>
                    <span className="text-sm font-medium">{responsible}</span>
                 </div>
            </div>

            <div className="flex justify-between items-center mt-4">
                <div className="text-xs font-semibold text-red-500">
                    {findingsCount > 0 ? `${findingsCount} Findings` : 'No Findings'}
                </div>
                <Button size="sm" onClick={() => onConduct(inspection)}>
                    {inspection.status === 'Draft' || inspection.status === 'Scheduled' ? 'Start' : 'Continue'}
                </Button>
            </div>
        </Card>
    );
};

export const Inspections: React.FC = () => {
  const { activeOrg, usersList, can } = useAppContext();
  const { inspectionList, setInspectionList, projects, handleUpdateInspection, checklistTemplates, handleCreateInspection } = useDataContext();
  
  // FIX: Destructure report modal controls
  const { 
    isInspectionCreationModalOpen, 
    setIsInspectionCreationModalOpen,
    setIsReportCreationModalOpen,
    setReportInitialData
  } = useModalContext();

  const [isConductModalOpen, setConductModalOpen] = useState(false);
  const [selectedInspection, setSelectedInspection] = useState<Inspection | null>(null);

  const handleStartConduct = (inspection: Inspection) => {
    let inspectionToConduct = inspection;
    // Auto-transition status when starting
    if (inspection.status === 'Draft' || inspection.status === 'Scheduled') {
        inspectionToConduct = { ...inspection, status: 'In Progress' };
        handleUpdateInspection(inspectionToConduct);
    }
    setSelectedInspection(inspectionToConduct);
    setConductModalOpen(true);
  };

  const handleUpdateAndCloseConduct = (inspection: Inspection, action?: 'submit' | 'save' | 'approve' | 'close') => {
    // Logic to handle status transitions based on action
    let newStatus = inspection.status;
    if (action === 'submit') newStatus = 'Pending Review';
    if (action === 'approve') newStatus = 'Approved';
    if (action === 'close') newStatus = 'Closed';

    const updated = { ...inspection, status: newStatus };
    handleUpdateInspection(updated);
    
    if (action !== 'save') {
        setConductModalOpen(false);
        setSelectedInspection(null);
    }
  };

  // FIX: Added handler to convert finding to report
  const handleConvertToReport = (finding: InspectionFinding) => {
    setReportInitialData({
        description: finding.description,
        type: 'Unsafe Condition', // Default type
        risk_pre_control: { 
            severity: finding.risk_level === 'High' ? 3 : finding.risk_level === 'Medium' ? 2 : 1, 
            likelihood: 2 
        },
        evidence_urls: finding.evidence_urls
    });
    // Close inspection modal and open report modal
    // setConductModalOpen(false); // Optional: keep inspection open or close it
    setIsReportCreationModalOpen(true);
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <div>
            <h1 className="text-3xl font-bold text-text-primary dark:text-dark-text-primary">Inspections</h1>
            <p className="text-text-secondary">Manage and conduct safety audits.</p>
        </div>
        {can('create', 'inspections') && (
            <Button onClick={() => setIsInspectionCreationModalOpen(true)}>
              <PlusIcon className="w-5 h-5 mr-2" />
              New Inspection
            </Button>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {inspectionList.map((inspection) => (
            <InspectionCard 
                key={inspection.id}
                inspection={inspection}
                onConduct={handleStartConduct}
            />
        ))}
         {inspectionList.length === 0 && (
            <div className="col-span-full text-center py-12 text-gray-500 border-2 border-dashed rounded-lg">
                <p>No inspections scheduled. Create one to get started.</p>
            </div>
        )}
      </div>

      {isInspectionCreationModalOpen && (
        <InspectionCreationModal
            isOpen={isInspectionCreationModalOpen}
            onClose={() => setIsInspectionCreationModalOpen(false)}
            onSubmit={handleCreateInspection}
            projects={projects}
            users={usersList}
            checklistTemplates={checklistTemplates}
        />
      )}

      {isConductModalOpen && selectedInspection && (
        <InspectionConductModal
            isOpen={isConductModalOpen}
            onClose={() => setConductModalOpen(false)}
            inspection={selectedInspection}
            onUpdate={handleUpdateAndCloseConduct}
            onConvertToReport={handleConvertToReport} // <--- Passed the handler here
            projects={projects}
            users={usersList}
            checklistTemplates={checklistTemplates}
        />
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\LoadCalculationSection.tsx
==================================================

import React from 'react';
import type { PtwLiftingPayload } from '../types/ptw';

interface LoadCalculationSectionProps {
  loadCalc: PtwLiftingPayload['load_calculation'];
  onChange: (calc: PtwLiftingPayload['load_calculation']) => void;
  disabled: boolean;
}

export const LoadCalculationSection: React.FC<LoadCalculationSectionProps> = ({ 
  loadCalc, 
  onChange, 
  disabled 
}) => {
  
  const calculateTotalWeight = (hook: number, load: number) => {
    return (hook || 0) + (load || 0);
  };
  
  const calculateUtilization = (total: number, capacity: number) => {
    return capacity > 0 ? (total / capacity) * 100 : 0;
  };
  
  const handleChange = (field: keyof typeof loadCalc, value: string) => {
    // Handle numeric fields
    if (field !== 'lift_plan_ref' && field !== 'crane_certification_no' && field !== 'operator_certification_no') {
        const numValue = parseFloat(value) || 0;
        const newCalc = { ...loadCalc, [field]: numValue };
        
        // Auto-calculate derived values
        if (field === 'hook_rigging_weight' || field === 'load_weight') {
            newCalc.total_weight = calculateTotalWeight(
                field === 'hook_rigging_weight' ? numValue : (loadCalc.hook_rigging_weight || 0),
                field === 'load_weight' ? numValue : (loadCalc.load_weight || 0)
            );
            // Recalculate utilization if total changed
            newCalc.utilization_percent = calculateUtilization(newCalc.total_weight, loadCalc.crane_capacity_at_radius || 0);
        }
        
        if (field === 'crane_capacity_at_radius') {
             const total = loadCalc.total_weight || 0;
             newCalc.utilization_percent = calculateUtilization(total, numValue);
        }

        onChange(newCalc);
    } else {
        // Handle string fields
        onChange({ ...loadCalc, [field]: value });
    }
  };
  
  const utilization = loadCalc.utilization_percent || 0;
  const isHighRisk = utilization > 85;
  const isCritical = utilization > 75;

  const inputClass = "w-full p-2 text-sm border rounded-md dark:bg-black dark:border-gray-700 dark:text-white disabled:bg-gray-100 dark:disabled:bg-white/5";

  return (
    <div className="mb-6 border rounded-lg p-4 bg-white dark:bg-dark-card border-gray-200 dark:border-dark-border">
      <div className="flex items-center justify-between mb-4">
        <h4 className="font-bold text-base text-gray-800 dark:text-gray-200">Lifting Load Calculation</h4>
        <div className={`px-3 py-1 rounded-full text-xs font-bold ${
          isHighRisk ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' :
          isCritical ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
          'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
        }`}>
          {isHighRisk ? 'HIGH RISK' : isCritical ? 'CRITICAL LIFT' : 'SAFE'} {utilization.toFixed(1)}%
        </div>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        {/* Row 1: Weights */}
        <div className="p-3 border rounded-lg bg-blue-50 dark:bg-blue-900/10 border-blue-100 dark:border-blue-800">
          <label className="block text-xs font-bold text-blue-600 dark:text-blue-400 mb-1">Hook + Rigging (Ton)</label>
          <input
            type="number"
            value={loadCalc.hook_rigging_weight || ''}
            onChange={(e) => handleChange('hook_rigging_weight', e.target.value)}
            disabled={disabled}
            className={inputClass}
            placeholder="0.0"
            step="0.1"
          />
        </div>

        <div className="p-3 border rounded-lg bg-blue-50 dark:bg-blue-900/10 border-blue-100 dark:border-blue-800">
          <label className="block text-xs font-bold text-blue-600 dark:text-blue-400 mb-1">Load Weight (Ton)</label>
          <input
            type="number"
            value={loadCalc.load_weight || ''}
            onChange={(e) => handleChange('load_weight', e.target.value)}
            disabled={disabled}
            className={inputClass}
            placeholder="0.0"
            step="0.1"
          />
        </div>

        <div className="p-3 border rounded-lg bg-gray-100 dark:bg-white/5 border-gray-200 dark:border-gray-700">
          <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">Total Weight (A+B)</label>
          <input
            type="number"
            value={loadCalc.total_weight || 0}
            readOnly
            className={`${inputClass} font-bold`}
          />
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* Row 2: Capacity */}
        <div>
            <label className="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Boom Length (m)</label>
            <input
                type="number"
                value={loadCalc.boom_length || ''}
                onChange={(e) => handleChange('boom_length', e.target.value)}
                disabled={disabled}
                className={inputClass}
            />
        </div>
        
        <div>
            <label className="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Max Radius (m)</label>
            <input
                type="number"
                value={loadCalc.max_working_radius || ''}
                onChange={(e) => handleChange('max_working_radius', e.target.value)}
                disabled={disabled}
                className={inputClass}
            />
        </div>

        <div className="p-3 border rounded-lg bg-green-50 dark:bg-green-900/10 border-green-100 dark:border-green-800">
          <label className="block text-xs font-bold text-green-700 dark:text-green-400 mb-1">Capacity at Radius (Ton)</label>
          <input
            type="number"
            value={loadCalc.crane_capacity_at_radius || ''}
            onChange={(e) => handleChange('crane_capacity_at_radius', e.target.value)}
            disabled={disabled}
            className={inputClass}
            placeholder="From Load Chart"
          />
        </div>
      </div>
      
      <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Lift Plan Reference #</label>
            <input
                type="text"
                value={loadCalc.lift_plan_ref || ''}
                onChange={(e) => handleChange('lift_plan_ref', e.target.value)}
                disabled={disabled}
                className={inputClass}
            />
          </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\login.js
==================================================

import React, { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { Shield, Lock, Mail, AlertCircle } from 'lucide-react';

export default function Login() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isSigningUp, setIsSigningUp] = useState(false); // Toggle between Login and Sign Up
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  
  const { login, signup } = useAuth();

  async function handleSubmit(e) {
    e.preventDefault();
    
    // Basic validation
    if(password.length < 6) {
        return setError("Password must be at least 6 characters");
    }

    try {
      setError('');
      setLoading(true);
      if (isSigningUp) {
        await signup(email, password);
      } else {
        await login(email, password);
      }
    } catch (err) {
      setError('Failed to ' + (isSigningUp ? 'create account' : 'log in') + ': ' + err.message);
    }
    setLoading(false);
  }

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
      <div className="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-slate-700">
        
        {/* Header */}
        <div className="text-center mb-8">
          <div className="bg-blue-600/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <Shield className="w-8 h-8 text-blue-500" />
          </div>
          <h2 className="text-2xl font-bold text-white">Safety System</h2>
          <p className="text-slate-400">
            {isSigningUp ? "Create a secure account" : "Sign in to access dashboard"}
          </p>
        </div>

        {/* Error Message */}
        {error && (
          <div className="bg-red-500/10 border border-red-500/50 text-red-500 p-3 rounded-lg mb-4 flex items-center gap-2 text-sm">
            <AlertCircle className="w-4 h-4" />
            {error}
          </div>
        )}

        {/* Form */}
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-slate-400 text-sm mb-1">Email</label>
            <div className="relative">
              <Mail className="w-5 h-5 text-slate-500 absolute left-3 top-2.5" />
              <input 
                type="email" 
                required
                className="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-blue-500"
                placeholder="safety@company.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>
          </div>

          <div>
            <label className="block text-slate-400 text-sm mb-1">Password</label>
            <div className="relative">
              <Lock className="w-5 h-5 text-slate-500 absolute left-3 top-2.5" />
              <input 
                type="password" 
                required
                className="w-full bg-slate-900 border border-slate-700 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:border-blue-500"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          <button 
            disabled={loading}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50"
          >
            {loading ? 'Processing...' : (isSigningUp ? 'Sign Up' : 'Log In')}
          </button>
        </form>

        {/* Toggle */}
        <div className="mt-6 text-center text-sm text-slate-400">
          {isSigningUp ? "Already have an account? " : "Need an account? "}
          <button 
            onClick={() => setIsSigningUp(!isSigningUp)}
            className="text-blue-400 hover:text-blue-300 font-medium"
          >
            {isSigningUp ? "Log In" : "Sign Up"}
          </button>
        </div>

      </div>
    </div>
  );
}

==================================================
FILE: .\src\components\LoginScreen.tsx
==================================================

import React, { useState, useEffect } from 'react';
import { logoSrc } from '../config';
import { useAuth } from '../contexts/AuthContext';
import { ShieldCheck, Mail, Lock, ArrowRight, Loader2, AlertCircle } from 'lucide-react';

export const LoginScreen: React.FC = () => {
  const { login, signup } = useAuth();
  
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });

  // Mouse move effect for background
  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      setMousePosition({
        x: (e.clientX / window.innerWidth) * 20,
        y: (e.clientY / window.innerHeight) * 20,
      });
    };
    window.addEventListener('mousemove', handleMouseMove);
    return () => window.removeEventListener('mousemove', handleMouseMove);
  }, []);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      if (isLogin) {
        await login(email, password);
      } else {
        await signup(email, password);
      }
    } catch (err: any) {
      console.error(err);
      setError(err.message.replace('Firebase: ', ''));
    }
    setLoading(false);
  }

  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center relative overflow-hidden">
      
      {/* Dynamic Background */}
      <div 
        className="absolute inset-0 transition-transform duration-200 ease-out"
        style={{ transform: `translate(${mousePosition.x}px, ${mousePosition.y}px)` }}
      >
        <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] bg-blue-600/10 rounded-full blur-[120px] animate-pulse" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-cyan-500/10 rounded-full blur-[120px] animate-pulse" style={{ animationDelay: '2s' }} />
        <div className="absolute top-[40%] left-[40%] w-[30%] h-[30%] bg-purple-500/10 rounded-full blur-[100px]" />
      </div>

      {/* Grid Overlay */}
      <div className="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:50px_50px] [mask-image:radial-gradient(ellipse_at_center,black_40%,transparent_100%)] pointer-events-none" />

      {/* Main Card */}
      <div className="w-full max-w-md relative z-10 p-6">
        
        {/* Logo Section */}
        <div className="text-center mb-8 relative">
          <div className="inline-flex items-center justify-center p-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-white/10 shadow-2xl shadow-cyan-900/20 mb-4 group">
            <img src={logoSrc} alt="EviroSafe" className="w-12 h-12 rounded-lg object-contain group-hover:scale-110 transition-transform duration-300" />
          </div>
          <h1 className="text-4xl font-black text-white tracking-tight mb-2">
            EviroSafe <span className="text-cyan-400">ID</span>
          </h1>
          <p className="text-slate-400 text-sm font-medium tracking-wide">
            ENTERPRISE SAFETY INTELLIGENCE
          </p>
        </div>

        {/* Login Form */}
        <div className="bg-slate-900/60 backdrop-blur-xl border border-white/10 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
          
          {/* Top glow line */}
          <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50" />

          {error && (
            <div className="mb-6 p-4 rounded-xl bg-rose-500/10 border border-rose-500/20 flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-rose-400 shrink-0 mt-0.5" />
              <p className="text-sm text-rose-200">{error}</p>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="space-y-1.5">
              <label className="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Work Email</label>
              <div className="relative group">
                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <Mail className="h-5 w-5 text-slate-500 group-focus-within:text-cyan-400 transition-colors" />
                </div>
                <input
                  type="email"
                  required
                  className="w-full pl-11 pr-4 py-3.5 bg-black/20 border border-white/10 rounded-xl text-white placeholder:text-slate-600 focus:outline-none focus:border-cyan-500/50 focus:bg-black/40 transition-all"
                  placeholder="name@company.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <label className="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Password</label>
              <div className="relative group">
                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-slate-500 group-focus-within:text-cyan-400 transition-colors" />
                </div>
                <input
                  type="password"
                  required
                  minLength={6}
                  className="w-full pl-11 pr-4 py-3.5 bg-black/20 border border-white/10 rounded-xl text-white placeholder:text-slate-600 focus:outline-none focus:border-cyan-500/50 focus:bg-black/40 transition-all"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
            </div>

            <button
              disabled={loading}
              className="w-full group relative overflow-hidden rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 p-px focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 focus:ring-offset-slate-900 disabled:opacity-70 disabled:cursor-not-allowed mt-2"
            >
              <span className="relative flex items-center justify-center gap-2 w-full bg-slate-900/0 px-6 py-3.5 rounded-xl transition-all group-hover:bg-opacity-0">
                {loading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin text-white" />
                    <span className="font-bold text-white">Authenticating...</span>
                  </>
                ) : (
                  <>
                    <span className="font-bold text-white">{isLogin ? 'Sign In' : 'Create Account'}</span>
                    <ArrowRight className="w-5 h-5 text-white group-hover:translate-x-1 transition-transform" />
                  </>
                )}
              </span>
            </button>
          </form>

          <div className="mt-8 flex items-center justify-between text-sm">
            <button 
              type="button"
              onClick={() => setIsLogin(!isLogin)}
              className="text-slate-400 hover:text-white transition-colors"
            >
              {isLogin ? "Need an account?" : "Already have one?"} <span className="text-cyan-400 font-bold ml-1">{isLogin ? 'Sign Up' : 'Log In'}</span>
            </button>
            <button className="text-slate-500 hover:text-slate-300 transition-colors">
              Forgot Password?
            </button>
          </div>
        </div>

        {/* Footer */}
        <div className="mt-8 text-center">
          <div className="flex items-center justify-center gap-2 text-xs text-slate-600 font-medium">
            <ShieldCheck className="w-4 h-4 text-emerald-500" />
            <span>256-bit Secure Connection</span>
          </div>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\NotificationsPanel.tsx
==================================================

import React from 'react';
import { useAppContext, useDataContext } from '../contexts';
import { Card } from './ui/Card';
import { Badge } from './ui/Badge';
import { Button } from './ui/Button';
import { Bell, Check, Trash2 } from 'lucide-react';
import { doc, updateDoc, deleteDoc } from 'firebase/firestore';
import { db } from '../firebase';

interface NotificationsPanelProps {
  onClose: () => void;
}

export const NotificationsPanel: React.FC<NotificationsPanelProps> = ({ onClose }) => {
  const { notifications } = useDataContext();
  const { activeUser } = useAppContext(); // <--- FIXED: activeUser from AppContext

  // Filter notifications for the current user
  const myNotifications = notifications.filter(n => n.user_id === activeUser?.id);
  const unreadCount = myNotifications.filter(n => !n.is_read).length;

  const handleMarkAsRead = async (id: string) => {
    try {
      await updateDoc(doc(db, 'notifications', id), { is_read: true });
    } catch (e) { console.error(e); }
  };

  const handleDelete = async (id: string) => {
    try {
      await deleteDoc(doc(db, 'notifications', id));
    } catch (e) { console.error(e); }
  };

  return (
    <div className="fixed inset-0 z-50 flex justify-end" onClick={onClose}>
      <div className="w-full max-w-md h-full bg-white dark:bg-slate-900 shadow-2xl border-l dark:border-slate-800 flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-4 border-b dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
          <div className="flex items-center gap-2">
            <Bell className="w-5 h-5 text-primary-600" />
            <h2 className="font-bold text-lg text-slate-900 dark:text-white">Notifications</h2>
            {unreadCount > 0 && (
              <Badge color="red">{unreadCount} New</Badge>
            )}
          </div>
          <button onClick={onClose} className="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
            âœ•
          </button>
        </div>

        {/* List */}
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {myNotifications.length === 0 ? (
            <div className="text-center py-10 text-slate-500">
              <Bell className="w-12 h-12 mx-auto mb-3 opacity-20" />
              <p>No notifications yet.</p>
            </div>
          ) : (
            myNotifications.map(notif => (
              <div 
                key={notif.id} 
                className={`p-3 rounded-lg border transition-all ${
                  notif.is_read 
                    ? 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 opacity-70' 
                    : 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 shadow-sm'
                }`}
              >
                <div className="flex justify-between items-start">
                  <p className={`text-sm ${notif.is_read ? 'text-slate-600 dark:text-slate-400' : 'text-slate-900 dark:text-white font-semibold'}`}>
                    {notif.message}
                  </p>
                  {!notif.is_read && <div className="w-2 h-2 bg-blue-500 rounded-full mt-1.5"></div>}
                </div>
                
                <div className="flex justify-between items-center mt-3">
                  <span className="text-xs text-slate-400">
                    {new Date(notif.timestamp).toLocaleString()}
                  </span>
                  <div className="flex gap-2">
                    {!notif.is_read && (
                      <button 
                        onClick={() => handleMarkAsRead(notif.id)}
                        className="p-1 hover:bg-blue-100 dark:hover:bg-blue-900 rounded text-blue-600"
                        title="Mark as read"
                      >
                        <Check size={14} />
                      </button>
                    )}
                    <button 
                      onClick={() => handleDelete(notif.id)}
                      className="p-1 hover:bg-red-100 dark:hover:bg-red-900 rounded text-red-500"
                      title="Delete"
                    >
                      <Trash2 size={14} />
                    </button>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50">
          <Button variant="secondary" className="w-full" onClick={onClose}>Close</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\OrganizationDetails.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Organization } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext, useDataContext } from '../contexts';
import { ProjectCreationModal } from './ProjectCreationModal';
import { ProjectDetails } from './ProjectDetails';

interface OrganizationDetailsProps {
  org: Organization;
  onBack: () => void;
}

type Tab = 'Overview' | 'Projects' | 'People' | 'Settings';

export const OrganizationDetails: React.FC<OrganizationDetailsProps> = ({ org, onBack }) => {
  const { usersList } = useAppContext();
  const { projects, handleCreateProject } = useDataContext();
  const [activeTab, setActiveTab] = useState<Tab>('Overview');
  const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
  const [selectedProject, setSelectedProject] = useState<any>(null);

  // Filter data for this specific organization
  const orgProjects = useMemo(() => projects.filter(p => p.org_id === org.id), [projects, org.id]);
  const orgUsers = useMemo(() => usersList.filter(u => u.org_id === org.id), [usersList, org.id]);

  const stats = {
    activeProjects: orgProjects.filter(p => p.status === 'active').length,
    totalUsers: orgUsers.length,
    admins: orgUsers.filter(u => u.role === 'ORG_ADMIN').length,
  };

  const handleProjectSubmit = (data: any) => {
      handleCreateProject({ ...data, org_id: org.id });
      setIsProjectModalOpen(false);
  };

  // If a project is selected, show its details
  if (selectedProject) {
      return (
          <ProjectDetails 
              project={selectedProject} 
              onBack={() => setSelectedProject(null)}
              onEdit={() => console.log("Edit project clicked")} // <--- FIXED: Added missing prop
          />
      );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between bg-white dark:bg-dark-card p-6 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border">
        <div className="flex items-center gap-4">
          <Button variant="secondary" size="sm" onClick={onBack} leftIcon={<ArrowLeftIcon />}>
            Back
          </Button>
          <div className="h-12 w-12 rounded-lg bg-gray-100 dark:bg-white/5 flex items-center justify-center p-2">
            <img src={org.branding.logoUrl} alt={org.name} className="max-h-full max-w-full" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gray-900 dark:text-white">{org.name}</h1>
            <div className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
              <span>{org.domain}</span>
              <span>â€¢</span>
              <Badge color={org.status === 'active' ? 'green' : 'gray'}>{org.status}</Badge>
            </div>
          </div>
        </div>
        <div className="flex gap-2">
           <Button variant="outline">Edit Details</Button>
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-200 dark:border-dark-border">
        <nav className="-mb-px flex space-x-8">
          {['Overview', 'Projects', 'People', 'Settings'].map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab as Tab)}
              className={`
                whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors
                ${activeTab === tab
                  ? 'border-primary-500 text-primary-600 dark:text-primary-400'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'}
              `}
            >
              {tab}
            </button>
          ))}
        </nav>
      </div>

      {/* Content */}
      <div className="min-h-[400px]">
        {activeTab === 'Overview' && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card>
              <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400">Active Projects</h3>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">{stats.activeProjects}</p>
            </Card>
            <Card>
              <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400">Total Team Members</h3>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">{stats.totalUsers}</p>
            </Card>
            <Card>
              <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400">Org Admins</h3>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">{stats.admins}</p>
            </Card>
            
            <Card className="md:col-span-3">
                <h3 className="text-lg font-bold mb-4 text-gray-900 dark:text-white">Organization Details</h3>
                <div className="grid grid-cols-2 gap-4 text-sm text-gray-700 dark:text-gray-300">
                    <div>
                        <p className="text-gray-500">Industry</p>
                        <p className="font-medium">{org.industry || 'N/A'}</p>
                    </div>
                    <div>
                        <p className="text-gray-500">Country</p>
                        <p className="font-medium">{org.country || 'N/A'}</p>
                    </div>
                    <div>
                        <p className="text-gray-500">Timezone</p>
                        <p className="font-medium">{org.timezone}</p>
                    </div>
                    <div>
                        <p className="text-gray-500">Primary Language</p>
                        <p className="font-medium uppercase">{org.primaryLanguage}</p>
                    </div>
                </div>
            </Card>
          </div>
        )}

        {activeTab === 'Projects' && (
            <div className="space-y-4">
                <div className="flex justify-between items-center">
                    <h3 className="text-lg font-bold text-gray-900 dark:text-white">Projects List</h3>
                    <Button onClick={() => setIsProjectModalOpen(true)}>
                        <PlusIcon className="w-5 h-5 mr-2" />
                        New Project
                    </Button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {orgProjects.map(p => (
                        <Card 
                            key={p.id} 
                            className="hover:border-primary-500 transition-colors cursor-pointer"
                            onClick={() => setSelectedProject(p)}
                        >
                            <div className="flex justify-between items-start">
                                <div>
                                    <h4 className="font-bold text-lg text-gray-900 dark:text-white">{p.name}</h4>
                                    <p className="text-sm text-gray-500">{p.code}</p>
                                </div>
                                <Badge color={p.status === 'active' ? 'green' : 'gray'}>{p.status}</Badge>
                            </div>
                            <div className="mt-4 text-sm text-gray-600 dark:text-gray-300">
                                <p>ðŸ“ {p.location}</p>
                                <p className="text-xs text-gray-500 mt-1">Manager: {usersList.find(u => u.id === p.manager_id)?.name || 'Unassigned'}</p>
                            </div>
                        </Card>
                    ))}
                    {orgProjects.length === 0 && (
                        <div className="col-span-2 text-center py-12 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
                            <p className="text-gray-500">No projects found for this organization.</p>
                            <Button variant="ghost" className="mt-2" onClick={() => setIsProjectModalOpen(true)}>Create First Project</Button>
                        </div>
                    )}
                </div>
            </div>
        )}

        {activeTab === 'People' && (
             <div className="space-y-4">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white">Team Members</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {orgUsers.map(u => (
                        <Card key={u.id} className="flex items-center gap-4">
                            <img src={u.avatar_url} alt={u.name} className="w-10 h-10 rounded-full bg-gray-200" />
                            <div>
                                <p className="font-bold text-gray-900 dark:text-white">{u.name}</p>
                                <p className="text-xs text-gray-500">{u.role}</p>
                            </div>
                        </Card>
                    ))}
                    {orgUsers.length === 0 && <p className="text-gray-500">No users found.</p>}
                </div>
             </div>
        )}

        {activeTab === 'Settings' && (
            <Card>
                <h3 className="text-lg font-bold mb-4 text-gray-900 dark:text-white">Organization Settings</h3>
                <p className="text-gray-500">Global settings for {org.name} will go here.</p>
            </Card>
        )}
      </div>

      <ProjectCreationModal 
        isOpen={isProjectModalOpen} 
        onClose={() => setIsProjectModalOpen(false)}
        onSubmit={handleProjectSubmit}
        users={orgUsers}
      />
    </div>
  );
};

const ArrowLeftIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4">
    <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
  </svg>
);

const PlusIcon = ({ className }: { className?: string }) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" className={className}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
  </svg>
);

==================================================
FILE: .\src\components\Organizations.tsx
==================================================

import React, { useState } from 'react';
import type { Organization } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext, useDataContext } from '../contexts';
import { OrganizationDetails } from './OrganizationDetails'; // <--- Import Details

// --- Organization Creation Modal ---
interface OrganizationCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: { name: string; industry: string; country: string }) => void;
}

const OrganizationCreationModal: React.FC<OrganizationCreationModalProps> = ({ isOpen, onClose, onSubmit }) => {
    const [formData, setFormData] = useState({
        name: '',
        industry: 'Construction',
        country: 'United Arab Emirates',
    });
    const [error, setError] = useState('');

    const handleSubmit = () => {
        if (!formData.name.trim() || !formData.industry.trim() || !formData.country.trim()) {
            setError('All fields are required.');
            return;
        }
        onSubmit(formData);
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b dark:border-dark-border">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">Create Organization</h3>
                </div>
                <div className="p-6 space-y-4">
                     <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Organization Name</label>
                        <input type="text" value={formData.name} onChange={e => setFormData(p => ({...p, name: e.target.value}))} className="mt-1 w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" placeholder="e.g. EGO Corporation" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Industry</label>
                        <input type="text" value={formData.industry} onChange={e => setFormData(p => ({...p, industry: e.target.value}))} className="mt-1 w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" />
                    </div>
                     <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Country</label>
                        <input type="text" value={formData.country} onChange={e => setFormData(p => ({...p, country: e.target.value}))} className="mt-1 w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" />
                    </div>
                    {error && <p className="text-sm text-red-500">{error}</p>}
                </div>
                <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSubmit}>Create</Button>
                </div>
            </div>
        </div>
    );
};

export const Organizations: React.FC = () => {
  const { organizations, usersList, activeUser, handleCreateOrganization } = useAppContext();
  const { projects } = useDataContext();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedOrg, setSelectedOrg] = useState<Organization | null>(null); // <--- State for selected org

  const getStatusColor = (status: Organization['status']): 'green' | 'gray' => {
    switch (status) {
      case 'active': return 'green';
      case 'suspended': return 'gray';
      default: return 'gray';
    }
  };

  const handleSubmit = (data: { name: string, industry: string, country: string }) => {
    handleCreateOrganization(data);
    setIsModalOpen(false);
  }

  // If an organization is selected, show its details view
  if (selectedOrg) {
      return <OrganizationDetails org={selectedOrg} onBack={() => setSelectedOrg(null)} />;
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-text-primary dark:text-white">Organizations</h1>
        {activeUser?.role === 'ADMIN' && (
            <Button onClick={() => setIsModalOpen(true)}>
                <PlusIcon className="w-5 h-5 mr-2" />
                New Organization
            </Button>
        )}
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {organizations.map(org => {
          const projectCount = projects.filter(p => p.org_id === org.id).length;
          const userCount = usersList.filter(u => u.org_id === org.id).length;

          return (
            <Card 
                key={org.id} 
                className="flex flex-col cursor-pointer hover:border-primary-500 transition-colors"
                onClick={() => setSelectedOrg(org)} // <--- Click to view details
            >
              <div className="flex-1">
                  <div className="flex justify-between items-start">
                      <div className="flex items-center space-x-4">
                        <img src={org.branding?.logoUrl || 'https://via.placeholder.com/50'} alt={org.name} className="h-12 w-12 rounded-lg" />
                        <div>
                          <h3 className="text-lg font-bold text-text-primary dark:text-white">{org.name}</h3>
                          <p className="text-sm text-text-secondary dark:text-gray-400 font-mono">{org.domain}</p>
                        </div>
                      </div>
                      <Badge color={getStatusColor(org.status)}>
                          {org.status.charAt(0).toUpperCase() + org.status.slice(1)}
                      </Badge>
                  </div>
                  <div className="mt-4 flex space-x-6 text-sm text-gray-600 dark:text-gray-300">
                    <div>
                      <div className="font-bold text-gray-900 dark:text-white">{projectCount}</div>
                      <div>Projects</div>
                    </div>
                    <div>
                      <div className="font-bold text-gray-900 dark:text-white">{userCount}</div>
                      <div>Users</div>
                    </div>
                  </div>
              </div>
              <div className="mt-6 border-t dark:border-dark-border pt-4 flex justify-end space-x-2">
                  <Button variant="secondary" size="sm">Settings</Button>
              </div>
            </Card>
          )
        })}
      </div>

      <OrganizationCreationModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSubmit={handleSubmit}
      />
    </div>
  );
};

const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
    </svg>
);

==================================================
FILE: .\src\components\OrganizationSettings.tsx
==================================================

import React, { useState, useEffect } from 'react';
import { useAppContext } from '../contexts';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { roles } from '../config';
import { doc, updateDoc, collection, query, where, getDocs } from 'firebase/firestore';
import { db } from '../firebase';
import { useToast } from './ui/Toast';

export const OrganizationSettings: React.FC = () => {
  const { activeOrg, activeUser } = useAppContext();
  const [users, setUsers] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const toast = useToast();

  // Fetch users from Firebase
  useEffect(() => {
    const fetchUsers = async () => {
      if (!activeOrg?.id) return;
      try {
        const q = query(collection(db, 'users'), where('org_id', '==', activeOrg.id));
        const snapshot = await getDocs(q);
        const userList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setUsers(userList);
      } catch (error) {
        console.error("Error fetching users:", error);
      } finally {
        setLoading(false);
      }
    };
    fetchUsers();
  }, [activeOrg]);

  const handleRoleChange = async (userId: string, newRole: string) => {
    try {
      const userRef = doc(db, 'users', userId);
      await updateDoc(userRef, { role: newRole });
      
      // Update local state
      setUsers(prev => prev.map(u => u.id === userId ? { ...u, role: newRole } : u));
      toast.success("User role updated successfully.");
    } catch (error) {
      console.error("Error updating role:", error);
      toast.error("Failed to update role.");
    }
  };

  const handleStatusChange = async (userId: string, newStatus: string) => {
    try {
      const userRef = doc(db, 'users', userId);
      await updateDoc(userRef, { status: newStatus });
      
      setUsers(prev => prev.map(u => u.id === userId ? { ...u, status: newStatus } : u));
      toast.success(`User marked as ${newStatus}.`);
    } catch (error) {
      toast.error("Failed to update status.");
    }
  };

  if (loading) return <div className="p-8 text-center">Loading users...</div>;

  return (
    <div className="space-y-6">
      <Card>
        <div className="flex justify-between items-center mb-6 border-b pb-4 dark:border-gray-700">
          <div>
            <h2 className="text-xl font-bold text-gray-900 dark:text-white">{activeOrg.name} Team</h2>
            <p className="text-sm text-gray-500">Manage user access and permissions.</p>
          </div>
          <div className="text-right">
            <p className="text-xs text-gray-400 uppercase">Total Users</p>
            <p className="text-2xl font-bold text-primary-600">{users.length}</p>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="min-w-full text-sm text-left">
            <thead className="text-xs text-gray-500 uppercase bg-gray-50 dark:bg-gray-800">
              <tr>
                <th className="px-6 py-3">User</th>
                <th className="px-6 py-3">Email</th>
                <th className="px-6 py-3">Current Role</th>
                <th className="px-6 py-3">Status</th>
                <th className="px-6 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
              {users.map((user) => (
                <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-gray-900/50">
                  <td className="px-6 py-4 font-medium text-gray-900 dark:text-white">
                    {user.name}
                  </td>
                  <td className="px-6 py-4 text-gray-500">{user.email}</td>
                  <td className="px-6 py-4">
                    <select 
                      value={user.role}
                      onChange={(e) => handleRoleChange(user.id, e.target.value)}
                      className="bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-primary-500"
                      disabled={user.id === activeUser?.id} // Prevent changing own role
                    >
                      {roles.map(r => (
                        <option key={r.key} value={r.key}>{r.label}</option>
                      ))}
                    </select>
                  </td>
                  <td className="px-6 py-4">
                    <Badge color={user.status === 'active' ? 'green' : 'red'}>
                      {user.status}
                    </Badge>
                  </td>
                  <td className="px-6 py-4 text-right">
                    {user.id !== activeUser?.id && (
                      <Button 
                        size="sm" 
                        variant="secondary"
                        onClick={() => handleStatusChange(user.id, user.status === 'active' ? 'inactive' : 'active')}
                      >
                        {user.status === 'active' ? 'Deactivate' : 'Activate'}
                      </Button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

==================================================
FILE: .\src\components\People.tsx
==================================================

import React, { useState } from 'react';
import type { User } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext, useDataContext } from '../contexts';
import { roles as rolesData } from '../config';
import { FormField } from './ui/FormField';
import { UserPlus, RefreshCw, MoreVertical } from 'lucide-react';

// --- Invite User Modal ---
const InviteUserModal: React.FC<{ isOpen: boolean, onClose: () => void }> = ({ isOpen, onClose }) => {
    const { activeOrg, handleInviteUser } = useAppContext();
    const { projects } = useDataContext();
    const orgProjects = projects.filter(p => p.org_id === activeOrg.id);

    const [formData, setFormData] = useState({
        name: '',
        email: '',
        role: 'WORKER' as User['role'],
        project_id: '',
    });
    const [error, setError] = useState('');

    const handleSubmit = () => {
        if (!formData.name.trim() || !formData.email.trim()) {
            setError('Full Name and Email are required.');
            return;
        }
        
        handleInviteUser({
            org_id: activeOrg.id,
            name: formData.name,
            email: formData.email,
            role: formData.role,
            project_id: formData.project_id
        });
        
        onClose();
        setFormData({ name: '', email: '', role: 'WORKER', project_id: '' });
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b dark:border-dark-border">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">Invite New User</h3>
                    <p className="text-sm text-gray-500">to {activeOrg.name}</p>
                </div>
                <div className="p-6 space-y-4">
                    <FormField label="Full Name"><input type="text" value={formData.name} onChange={e => setFormData(p => ({...p, name: e.target.value}))} className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" /></FormField>
                    <FormField label="Email Address"><input type="email" value={formData.email} onChange={e => setFormData(p => ({...p, email: e.target.value}))} className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" /></FormField>
                    <div className="grid grid-cols-2 gap-4">
                        <FormField label="Role">
                            <select value={formData.role} onChange={e => setFormData(p => ({...p, role: e.target.value as User['role']}))} className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white">
                                {rolesData.map(r => <option key={r.key} value={r.key}>{r.label}</option>)}
                            </select>
                        </FormField>
                        <FormField label="Assign Project">
                            <select value={formData.project_id} onChange={e => setFormData(p => ({...p, project_id: e.target.value}))} className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white">
                                <option value="">No Project (Org Level)</option>
                                {orgProjects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                        </FormField>
                    </div>
                    {error && <p className="text-sm text-red-500">{error}</p>}
                </div>
                <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSubmit}>Send Invitation</Button>
                </div>
            </div>
        </div>
    );
};

// --- Reassign Project Modal ---
const ReassignModal: React.FC<{ isOpen: boolean, onClose: () => void, user: User | null }> = ({ isOpen, onClose, user }) => {
    const { activeOrg, handleUpdateUser } = useAppContext();
    const { projects } = useDataContext();
    const orgProjects = projects.filter(p => p.org_id === activeOrg.id);
    const [selectedProject, setSelectedProject] = useState('');

    const handleReassign = () => {
        if (user) {
            const updatedUser = { ...user, project_id: selectedProject }; 
            handleUpdateUser(updatedUser);
        }
        onClose();
    };

    if (!isOpen || !user) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b dark:border-dark-border">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">Reassign Project</h3>
                    <p className="text-sm text-gray-500">Move {user.name} to a new project.</p>
                </div>
                <div className="p-6">
                    <FormField label="Select New Project">
                        <select value={selectedProject} onChange={e => setSelectedProject(e.target.value)} className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white">
                            <option value="">Unassigned</option>
                            {orgProjects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                    </FormField>
                </div>
                <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleReassign}>Confirm Reassignment</Button>
                </div>
            </div>
        </div>
    );
};

export const People: React.FC = () => {
  const { usersList, activeOrg, can, activeUser, impersonateUser, invitedEmails } = useAppContext();
  const { projects } = useDataContext();
  const [isInviteModalOpen, setIsInviteModalOpen] = useState(false);
  const [reassignUser, setReassignUser] = useState<User | null>(null);

  const getProjectName = (projectId?: string) => {
      if (!projectId) return 'Unassigned';
      return projects.find(p => p.id === projectId)?.name || 'Unknown Project';
  };

  const allPersonnel = [
    ...usersList.filter(u => u.org_id === activeOrg.id),
    ...invitedEmails.filter(i => i.org_id === activeOrg.id).map(i => ({
        id: i.email, name: i.name, email: i.email, role: i.role, status: 'invited' as const, org_id: i.org_id, avatar_url: '', project_id: (i as any).project_id
    }))
  ].sort((a, b) => (a.name || '').localeCompare(b.name || '')); // <--- FIXED: Safe localeCompare

  return (
    <div>
        <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-text-primary dark:text-white">People & Access</h1>
            {can('create', 'people') && (
                <Button onClick={() => setIsInviteModalOpen(true)}>
                    <UserPlus className="w-5 h-5 mr-2" />
                    Invite User
                </Button>
            )}
        </div>
      
      <Card>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200 dark:divide-dark-border">
            <thead className="bg-gray-50 dark:bg-white/5">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Project</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 dark:divide-dark-border">
              {allPersonnel.map((user: any) => (
                <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-white/5">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      <div className="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold">
                        {user.avatar_url ? <img src={user.avatar_url} className="h-10 w-10 rounded-full"/> : (user.name || '?').charAt(0)}
                      </div>
                      <div className="ml-4">
                        <div className="text-sm font-medium text-gray-900 dark:text-white">{user.name || 'Unknown'}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                     {/* FIXED: Safe replace */}
                     <Badge color="blue">{(user.role || 'Unknown').replace(/_/g, ' ')}</Badge>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                      {getProjectName(user.project_id)}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <Badge color={user.status === 'active' ? 'green' : 'yellow'}>{user.status}</Badge>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                    {can('update', 'people') && user.status !== 'invited' && (
                        <button onClick={() => setReassignUser(user)} className="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" title="Reassign Project">
                            <RefreshCw className="w-4 h-4" />
                        </button>
                    )}
                    {activeUser?.role === 'ADMIN' && user.status !== 'invited' && (
                        <Button variant="ghost" size="sm" onClick={() => impersonateUser(user.id)}>View As</Button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>

      <InviteUserModal isOpen={isInviteModalOpen} onClose={() => setIsInviteModalOpen(false)} />
      <ReassignModal isOpen={!!reassignUser} onClose={() => setReassignUser(null)} user={reassignUser} />
    </div>
  );
};

==================================================
FILE: .\src\components\PersonnelEntryLogSection.tsx
==================================================

import React from 'react';
import type { PersonnelEntryLogEntry } from '../types';
import { Button } from './ui/Button';

interface PersonnelEntryLogSectionProps {
  entries: PersonnelEntryLogEntry[];
  onChange: (entries: PersonnelEntryLogEntry[]) => void;
  disabled: boolean;
}

export const PersonnelEntryLogSection: React.FC<PersonnelEntryLogSectionProps> = ({ entries, onChange, disabled }) => {
  const addRow = () => {
    onChange([...entries, { name: '', time_in: '', time_out: '' }]);
  };

  const updateRow = (index: number, field: keyof PersonnelEntryLogEntry, value: string) => {
    const newEntries = [...entries];
    newEntries[index] = { ...newEntries[index], [field]: value };
    onChange(newEntries);
  };

  const removeRow = (index: number) => {
    onChange(entries.filter((_, i) => i !== index));
  };

  return (
    <div className="border rounded-lg p-4 mb-6">
      <div className="flex justify-between items-center mb-4">
        <h4 className="font-bold text-gray-800 dark:text-gray-200">Personnel Entry/Exit Log</h4>
        {!disabled && <Button size="sm" onClick={addRow}>+ Add Person</Button>}
      </div>
      <table className="w-full text-sm text-left">
        <thead className="bg-gray-100 dark:bg-gray-800">
          <tr>
            <th className="p-2">Name</th>
            <th className="p-2">Time In</th>
            <th className="p-2">Time Out</th>
            {!disabled && <th className="p-2"></th>}
          </tr>
        </thead>
        <tbody>
          {entries.map((entry, i) => (
            <tr key={i} className="border-b dark:border-gray-700">
              <td className="p-2"><input type="text" value={entry.name} onChange={e => updateRow(i, 'name', e.target.value)} disabled={disabled} className="w-full bg-transparent border rounded p-1" placeholder="Name" /></td>
              <td className="p-2"><input type="time" value={entry.time_in} onChange={e => updateRow(i, 'time_in', e.target.value)} disabled={disabled} className="w-full bg-transparent border rounded p-1" /></td>
              <td className="p-2"><input type="time" value={entry.time_out} onChange={e => updateRow(i, 'time_out', e.target.value)} disabled={disabled} className="w-full bg-transparent border rounded p-1" /></td>
              {!disabled && <td className="p-2"><button onClick={() => removeRow(i)} className="text-red-500">Ã—</button></td>}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

==================================================
FILE: .\src\components\PlanCreationModal.tsx
==================================================

import React, { useState } from 'react';
import type { Project, PlanType, PlanContentSection } from '../types';
import { Button } from './ui/Button';
import { planTypes, planTemplates } from '../config';

interface PlanCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: { title: string; type: PlanType; project_id: string; sections: PlanContentSection[] }) => void;
  projects: Project[];
}

const FormField: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{label}</label>
        <div className="mt-1">{children}</div>
    </div>
);

export const PlanCreationModal: React.FC<PlanCreationModalProps> = ({ isOpen, onClose, onSubmit, projects }) => {
  const [formData, setFormData] = useState({
    title: '',
    type: 'HSEMP' as PlanType,
    project_id: projects[0]?.id || '',
  });
  
  const [error, setError] = useState('');

  const handleChange = (field: keyof typeof formData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleSubmit = () => {
    if (!formData.title.trim() || !formData.project_id) {
        setError('Please fill out all fields.');
        return;
    }

    // Get the specific sections for this plan type from config
    const templateSections = planTemplates[formData.type] || [];

    onSubmit({
        ...formData,
        sections: templateSections
    });
    
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b dark:border-dark-border">
          <h3 className="text-xl font-bold text-gray-900 dark:text-white">Create New Plan</h3>
          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">Start a new HSE plan from a template.</p>
        </div>
        <div className="p-6 space-y-4">
          <FormField label="Plan Title">
            <input 
                type="text" 
                value={formData.title} 
                onChange={e => handleChange('title', e.target.value)} 
                className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                placeholder="e.g., Lifting Plan for Section B"
            />
          </FormField>
          <div className="grid grid-cols-2 gap-4">
              <FormField label="Plan Type">
                  <select 
                    value={formData.type} 
                    onChange={e => handleChange('type', e.target.value)} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                  >
                      {planTypes.map(type => <option key={type} value={type}>{type}</option>)}
                  </select>
              </FormField>
              <FormField label="Project">
                  <select 
                    value={formData.project_id} 
                    onChange={e => handleChange('project_id', e.target.value)} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                  >
                      {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
              </FormField>
          </div>
          
          <div className="mt-2 p-3 bg-gray-50 dark:bg-white/5 rounded border dark:border-dark-border">
              <p className="text-xs font-bold text-gray-500 uppercase mb-2">Sections included in this template:</p>
              <ul className="text-xs text-gray-600 dark:text-gray-300 list-disc list-inside">
                  {(planTemplates[formData.type] || []).length > 0 ? (
                      (planTemplates[formData.type] || []).map((s, i) => (
                          <li key={i}>{s.title}</li>
                      ))
                  ) : (
                      <li className="italic text-gray-400">No default sections defined (Blank Plan)</li>
                  )}
              </ul>
          </div>

          {error && <p className="text-sm text-red-600">{error}</p>}
        </div>
        <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Create Plan</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\PlanDetailModal.tsx
==================================================

import React, { useState } from 'react';
import type { Plan, PlanStatus, User } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import ReactMarkdown from 'react-markdown';
import { useAppContext } from '../contexts';
import { ActionsBar } from './ui/ActionsBar';
import { EmailModal } from './ui/EmailModal';

interface PlanDetailModalProps {
  plan: Plan;
  onClose: () => void;
  onStatusChange: (planId: string, newStatus: PlanStatus) => void;
}

const getStatusColor = (status: PlanStatus | undefined): 'green' | 'blue' | 'yellow' | 'red' | 'gray' => {
  switch (status) {
    case 'published': return 'green';
    case 'approved': return 'blue';
    case 'under_review': return 'yellow';
    case 'archived': return 'gray';
    case 'draft':
    default: return 'gray';
  }
};

const DetailItem: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
  <div>
    <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">{label}</p>
    <div className="text-sm text-gray-800 dark:text-gray-200 mt-1">{children}</div>
  </div>
);

const PersonDetail: React.FC<{ person?: { name: string, email: string, signed_at?: string } }> = ({ person }) => {
    if (!person) return <span className="text-gray-400">N/A</span>;
    return (
        <div>
            <p className="font-semibold">{person.name}</p>
            <p className="text-xs text-gray-500">{person.email}</p>
            {person.signed_at && <p className="text-xs text-green-600">Signed at {new Date(person.signed_at).toLocaleString()}</p>}
        </div>
    );
}

const WorkflowActions: React.FC<{ status: PlanStatus, onAction: (newStatus: PlanStatus) => void }> = ({ status, onAction }) => {
    const { can } = useAppContext();
    const canApprove = can('approve', 'plans');
    return (
        <div className="flex items-center space-x-2">
            {status === 'draft' && <Button onClick={() => onAction('under_review')}>Submit for Review</Button>}
            {status === 'under_review' && canApprove && (
                <>
                    <Button variant="secondary" onClick={() => onAction('draft')}>Request Changes</Button>
                    <Button onClick={() => onAction('approved')}>Approve</Button>
                </>
            )}
             {status === 'approved' && canApprove && <Button onClick={() => onAction('published')}>Publish</Button>}
             {status === 'published' && canApprove && <Button variant="danger" onClick={() => onAction('archived')}>Archive</Button>}
        </div>
    );
}

export const PlanDetailModal: React.FC<PlanDetailModalProps> = ({ plan, onClose, onStatusChange }) => {
  // Safety check: if plan is null/undefined, don't render
  if (!plan) return null;

  // Safe access to nested properties
  const bodyJson = plan.content?.body_json || [];
  const attachments = plan.content?.attachments || [];
  const status = plan.status || 'draft'; // Default to draft if missing

  const [activeSection, setActiveSection] = useState(bodyJson[0]?.title || '');
  const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);

  const handlePrint = () => window.print();

  return (
    <>
    <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <header className="p-4 border-b dark:border-dark-border flex justify-between items-center flex-shrink-0">
          <div>
            <h2 className="text-xl font-bold text-gray-900 dark:text-white">{plan.title} ({plan.version})</h2>
            <p className="text-sm text-gray-500 dark:text-gray-400">{plan.type} Plan</p>
          </div>
          <div className="flex items-center gap-4">
             <ActionsBar onPrint={handlePrint} onDownloadPdf={handlePrint} onEmail={() => setIsEmailModalOpen(true)} />
             {/* FIX: Added safety check for status.replace */}
             <Badge color={getStatusColor(status)}>{(status || '').replace('_', ' ')}</Badge>
             <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><CloseIcon className="w-6 h-6" /></button>
          </div>
        </header>

        <div className="flex-grow flex overflow-hidden">
            <nav className="w-64 bg-gray-50 dark:bg-dark-background border-r dark:border-dark-border overflow-y-auto p-4 flex-shrink-0">
                <h3 className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">Sections</h3>
                <ul>
                    {bodyJson.map(section => (
                        <li key={section.title}>
                            <button
                                onClick={() => setActiveSection(section.title)}
                                className={`w-full text-left p-2 rounded-md text-sm font-medium ${activeSection === section.title ? 'bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300' : 'hover:bg-gray-200 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300'}`}
                            >
                                {section.title}
                            </button>
                        </li>
                    ))}
                     {bodyJson.length === 0 && <p className="text-sm text-gray-500">No content sections.</p>}
                </ul>
            </nav>

            <main className="flex-1 p-8 overflow-y-auto">
                 {status === 'under_review' && (
                    <div className="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
                        <div className="flex">
                            <div className="flex-shrink-0">
                                <MailIcon className="h-5 w-5 text-yellow-400" aria-hidden="true" />
                            </div>
                            <div className="ml-3">
                                <p className="text-sm text-yellow-700 dark:text-yellow-300">
                                A review request has been sent to the Client. This plan is pending approval.
                                </p>
                            </div>
                        </div>
                    </div>
                )}
                {bodyJson.map(section => (
                    <div key={section.title} className={activeSection === section.title ? '' : 'hidden'}>
                        <h1 className="text-2xl font-bold border-b dark:border-dark-border pb-2 mb-4 text-gray-900 dark:text-white">{section.title}</h1>
                        <div className="prose max-w-none dark:prose-invert text-gray-800 dark:text-gray-300">
                            <ReactMarkdown>{section.content}</ReactMarkdown>
                        </div>
                    </div>
                ))}
                 {bodyJson.length === 0 && <p className="text-center text-gray-500">This plan has no content yet.</p>}
            </main>

            <aside className="w-80 bg-gray-50 dark:bg-dark-background border-l dark:border-dark-border p-6 overflow-y-auto flex-shrink-0">
                <h3 className="text-lg font-bold mb-4 text-gray-900 dark:text-white">Details</h3>
                <div className="space-y-4">
                    <DetailItem label="Prepared By"><PersonDetail person={plan.people?.prepared_by} /></DetailItem>
                    <DetailItem label="Reviewed By"><PersonDetail person={plan.people?.reviewed_by} /></DetailItem>
                    <DetailItem label="Client Approved By"><PersonDetail person={plan.people?.approved_by_client} /></DetailItem>
                    <DetailItem label="Last Updated">{plan.dates?.updated_at ? new Date(plan.dates.updated_at).toLocaleDateString() : 'N/A'}</DetailItem>
                    <DetailItem label="Next Review">{plan.dates?.next_review_at ? new Date(plan.dates.next_review_at).toLocaleDateString() : 'N/A'}</DetailItem>
                    <DetailItem label="Tags">
                        <div className="flex flex-wrap gap-1">
                            {plan.meta?.tags?.map(tag => <Badge key={tag} color="gray" size="sm">{tag}</Badge>)}
                        </div>
                    </DetailItem>
                </div>
                 <h3 className="text-lg font-bold mt-6 mb-4 text-gray-900 dark:text-white">Attachments</h3>
                 <ul className="space-y-2">
                     {attachments.map(att => (
                         <li key={att.name} className="flex items-center p-2 bg-white dark:bg-dark-card border dark:border-dark-border rounded-md">
                             <PaperClipIcon className="w-5 h-5 text-gray-400 mr-2" />
                             <a href={att.url} target="_blank" rel="noopener noreferrer" className="text-sm text-primary-600 hover:underline flex-1 truncate">{att.name}</a>
                         </li>
                     ))}
                     {attachments.length === 0 && <p className="text-sm text-gray-500">No attachments.</p>}
                 </ul>
            </aside>
        </div>

        <footer className="p-4 border-t bg-gray-100 dark:bg-dark-card dark:border-dark-border flex justify-end items-center flex-shrink-0">
            <WorkflowActions status={status} onAction={(newStatus) => onStatusChange(plan.id, newStatus)} />
        </footer>
      </div>
    </div>
    <EmailModal 
        isOpen={isEmailModalOpen}
        onClose={() => setIsEmailModalOpen(false)}
        documentTitle={`Plan: ${plan.title}`}
        documentLink={`${window.location.href}?plan=${plan.id}`}
        defaultRecipients={[plan.people?.prepared_by, plan.people?.reviewed_by, plan.people?.approved_by_client].filter(Boolean) as User[]}
    />
    </>
  );
};


// Icons
const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
const PaperClipIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" />
    </svg>
);
const MailIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>;

==================================================
FILE: .\src\components\PlanEditorModal.tsx
==================================================

import React, { useState, useEffect } from 'react';
import type { Plan, PlanContentSection, PlanStatus } from '../types';
import { Button } from './ui/Button';
import ReactMarkdown from 'react-markdown';
import { useToast } from './ui/Toast'; // Import Toast for feedback

interface PlanEditorModalProps {
  plan: Plan;
  onClose: () => void;
  onSave: (plan: Plan) => void;
  onSubmitForReview: (planId: string, newStatus: PlanStatus) => void;
}

const RightRailSection: React.FC<{ title: string, children: React.ReactNode, action?: React.ReactNode }> = ({ title, children, action }) => (
    <div className="mb-6">
        <div className="flex justify-between items-center mb-2">
            <h3 className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 tracking-wider">{title}</h3>
            {action}
        </div>
        <div className="p-3 bg-white dark:bg-dark-card border dark:border-dark-border rounded-lg space-y-2 shadow-sm">
            {children}
        </div>
    </div>
);

export const PlanEditorModal: React.FC<PlanEditorModalProps> = ({ plan, onClose, onSave, onSubmitForReview }) => {
  const [editedPlan, setEditedPlan] = useState<Plan>(JSON.parse(JSON.stringify(plan)));
  const [activeSection, setActiveSection] = useState<PlanContentSection | null>(editedPlan.content.body_json[0] || null);
  const toast = useToast();

  useEffect(() => {
    // If the active section is deleted from the plan, reset to the first one
    if (activeSection && !editedPlan.content.body_json.find(s => s.title === activeSection.title)) {
        setActiveSection(editedPlan.content.body_json[0] || null);
    }
  }, [editedPlan.content.body_json, activeSection]);

  const handleSectionContentChange = (newContent: string) => {
    if (!activeSection) return;
    const newSections = editedPlan.content.body_json.map(s => 
        s.title === activeSection.title ? { ...s, content: newContent } : s
    );
    setEditedPlan(p => ({ ...p, content: { ...p.content, body_json: newSections } }));
    setActiveSection(s => s ? { ...s, content: newContent } : null);
  };
  
  const handleSectionCompletionChange = (title: string, isComplete: boolean) => {
    const newSections = editedPlan.content.body_json.map(s => 
        s.title === title ? { ...s, is_complete: isComplete } : s
    );
    setEditedPlan(p => ({ ...p, content: { ...p.content, body_json: newSections } }));
  };

  const handleMetaChange = (field: keyof Plan['meta'], value: string | string[]) => {
      setEditedPlan(p => ({ ...p, meta: { ...p.meta, [field]: value }}));
  }

  const handleSaveDraft = () => {
      onSave(editedPlan);
      toast.success("Draft saved successfully.");
      onClose();
  };

  const handleSaveAndSubmit = () => {
    // 1. Save the current state of the plan
    onSave(editedPlan);
    // 2. Trigger the status change
    onSubmitForReview(editedPlan.id, 'under_review');
    // 3. Close the modal
    toast.success("Plan submitted for review.");
    onClose();
  };

  const handleLinkItem = (type: string) => {
      // Placeholder for linking functionality
      // In a real app, this would open a selector modal
      toast.info(`Link ${type} feature coming soon.`);
  };

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-gray-100 dark:bg-black rounded-xl shadow-2xl w-full max-w-7xl h-[95vh] flex flex-col overflow-hidden border border-gray-200 dark:border-gray-800" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <header className="p-4 border-b bg-white dark:bg-dark-card dark:border-dark-border flex justify-between items-center flex-shrink-0">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                <FileTextIcon className="w-6 h-6" />
            </div>
            <div>
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">Plan Editor: {editedPlan.title}</h2>
                <div className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                    <span>Status: {editedPlan.status}</span>
                    <span>â€¢</span>
                    <span>Version: {editedPlan.version}</span>
                </div>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full text-gray-500 transition-colors">
            <CloseIcon className="w-6 h-6" />
          </button>
        </header>

        <div className="flex-grow flex overflow-hidden">
            {/* Left Navigation */}
            <nav className="w-72 bg-white dark:bg-dark-card border-r dark:border-dark-border overflow-y-auto p-4 flex-shrink-0">
                <div className="flex justify-between items-center mb-4 px-2">
                    <h3 className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 tracking-wider">Sections</h3>
                    <button className="text-blue-600 hover:text-blue-700 text-xs font-bold" onClick={() => toast.info("Add Section feature coming soon")}>+ ADD</button>
                </div>
                <ul className="space-y-1">
                    {editedPlan.content.body_json.map(section => (
                        <li key={section.title}>
                            <button
                                onClick={() => setActiveSection(section)}
                                className={`w-full text-left p-3 rounded-lg text-sm flex items-center justify-between transition-all ${
                                    activeSection?.title === section.title 
                                    ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300 ring-1 ring-blue-200 dark:ring-blue-800' 
                                    : 'hover:bg-gray-50 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300'
                                }`}
                            >
                                <span className="truncate pr-2 font-medium">{section.title}</span>
                                <input 
                                    type="checkbox" 
                                    checked={section.is_complete}
                                    onChange={(e) => handleSectionCompletionChange(section.title, e.target.checked)}
                                    onClick={(e) => e.stopPropagation()}
                                    className="h-4 w-4 rounded text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 dark:bg-gray-800"
                                />
                            </button>
                        </li>
                    ))}
                </ul>
            </nav>

            {/* Center Content Editor */}
            <main className="flex-1 flex flex-col bg-white dark:bg-dark-background relative">
                {activeSection ? (
                    <>
                        <div className="p-6 border-b dark:border-dark-border">
                            <input 
                                type="text" 
                                value={activeSection.title} 
                                readOnly 
                                className="text-2xl font-bold w-full bg-transparent focus:outline-none text-gray-900 dark:text-white placeholder-gray-400"
                            />
                        </div>
                        <textarea 
                            value={activeSection.content}
                            onChange={(e) => handleSectionContentChange(e.target.value)}
                            className="flex-1 w-full p-6 resize-none focus:outline-none font-mono text-sm leading-relaxed text-gray-800 dark:text-gray-300 bg-transparent"
                            placeholder="Enter section content here. Markdown is supported."
                        />
                    </>
                ) : (
                    <div className="flex flex-col items-center justify-center h-full text-gray-400">
                        <FileTextIcon className="w-16 h-16 mb-4 opacity-20" />
                        <p>Select a section from the left to begin editing.</p>
                    </div>
                )}
            </main>

            {/* Right Metadata Rail */}
            <aside className="w-80 bg-gray-50 dark:bg-dark-background border-l dark:border-dark-border p-6 overflow-y-auto flex-shrink-0">
                <RightRailSection title="Metadata">
                    <div className="text-sm space-y-4">
                        <div>
                            <label className="block text-xs font-semibold text-gray-500 mb-1">VERSION</label>
                            <input 
                                type="text" 
                                value={editedPlan.version} 
                                onChange={e => setEditedPlan(p => ({...p, version: e.target.value}))} 
                                className="w-full p-2 border rounded-md bg-white dark:bg-dark-card dark:border-dark-border dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                        </div>
                         <div>
                            <label className="block text-xs font-semibold text-gray-500 mb-1">TAGS</label>
                            <input 
                                type="text" 
                                value={editedPlan.meta.tags?.join(', ') || ''} 
                                onChange={e => handleMetaChange('tags', e.target.value.split(',').map(t=>t.trim()))} 
                                className="w-full p-2 border rounded-md bg-white dark:bg-dark-card dark:border-dark-border dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder="Comma separated"
                            />
                        </div>
                    </div>
                </RightRailSection>

                <RightRailSection title="Attachments" action={<button onClick={() => handleLinkItem('Attachment')} className="text-blue-600 hover:text-blue-700 text-lg font-bold">+</button>}>
                    {editedPlan.content.attachments.length > 0 ? (
                        editedPlan.content.attachments.map(att => (
                            <div key={att.name} className="flex items-center text-sm p-2 hover:bg-gray-50 dark:hover:bg-white/5 rounded">
                                <PaperClipIcon className="w-4 h-4 mr-2 text-gray-400 shrink-0"/>
                                <span className="truncate text-gray-700 dark:text-gray-300">{att.name}</span>
                            </div>
                        ))
                    ) : (
                        <p className="text-xs text-gray-400 italic p-2">No attachments uploaded.</p>
                    )}
                </RightRailSection>
                
                <RightRailSection title="Linked RAMS" action={<button onClick={() => handleLinkItem('RAMS')} className="text-sm font-medium text-blue-600 hover:underline">Link</button>}>
                    <p className="text-xs text-gray-400 italic p-2">No linked RAMS.</p>
                </RightRailSection>

                <RightRailSection title="Linked PTWs" action={<button onClick={() => handleLinkItem('PTW')} className="text-sm font-medium text-blue-600 hover:underline">Link</button>}>
                    <p className="text-xs text-gray-400 italic p-2">No linked PTWs.</p>
                </RightRailSection>
            </aside>
        </div>

        <footer className="p-4 border-t bg-white dark:bg-dark-card dark:border-dark-border flex justify-between items-center flex-shrink-0">
            <Button variant="secondary" onClick={onClose}>Cancel</Button>
            <div className="flex gap-3">
                <Button variant="secondary" onClick={handleSaveDraft}>Save Draft</Button>
                <Button onClick={handleSaveAndSubmit} className="bg-emerald-600 hover:bg-emerald-700 text-white">
                    Save & Submit for Review
                </Button>
            </div>
        </footer>
      </div>
    </div>
  );
};


// Icons
const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
const PaperClipIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" />
    </svg>
);
const FileTextIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
    </svg>
);

==================================================
FILE: .\src\components\Plans.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Plan, PlanStatus } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { planTypes } from '../config';
import { useDataContext, useModalContext, useAppContext } from '../contexts';

interface PlansProps {
  onSelectPlan: (plan: Plan) => void;
  onNewPlan: () => void;
}

const getStatusColor = (status: PlanStatus): 'green' | 'blue' | 'yellow' | 'red' | 'gray' => {
  switch (status) {
    case 'published': return 'green';
    case 'approved': return 'blue';
    case 'under_review': return 'yellow';
    case 'archived': return 'gray';
    case 'draft':
    default: return 'gray';
  }
};

const PlanCard: React.FC<{ plan: Plan; onSelect: (plan: Plan) => void }> = ({ plan, onSelect }) => {
  // FIX: Ensure status string exists
  const safeStatus = plan.status || 'draft';
  
  return (
    <Card className="flex flex-col hover:shadow-lg transition-shadow duration-300">
      <div className="flex-grow">
        <div className="flex justify-between items-start">
          <span className="text-xs font-semibold uppercase tracking-wider text-primary-700 bg-primary-100 dark:bg-primary-900/30 dark:text-primary-300 px-2 py-1 rounded-full">{plan.type}</span>
          <Badge color={getStatusColor(safeStatus)}>{safeStatus.replace('_', ' ')}</Badge>
        </div>
        <h3 className="text-lg font-bold text-text-primary dark:text-white mt-3">{plan.title}</h3>
        <p className="text-sm text-text-secondary dark:text-gray-400">{plan.version}</p>
        {plan.people?.approved_by_client?.signed_at && (
            <div className="mt-3 flex items-center text-green-600 dark:text-green-400">
                <CheckCircleIcon className="w-5 h-5 mr-2" />
                <span className="text-sm font-semibold">Client Approved</span>
            </div>
        )}
      </div>
      <div className="border-t dark:border-dark-border mt-4 pt-4 text-xs text-gray-500 dark:text-gray-400 space-y-2">
        <p><strong>Prepared By:</strong> {plan.people?.prepared_by?.name || 'Unknown'}</p>
        <p><strong>Next Review:</strong> {plan.dates?.next_review_at ? new Date(plan.dates.next_review_at).toLocaleDateString() : 'N/A'}</p>
      </div>
      <div className="mt-4 flex justify-end">
        <Button variant="primary" size="sm" onClick={() => onSelect(plan)}>
          {safeStatus === 'draft' ? 'Edit Plan' : 'View Details'}
        </Button>
      </div>
    </Card>
  );
};

const FilterButton: React.FC<{ label: string, value: string, currentFilter: string, setFilter: (val: string) => void }> = ({ label, value, currentFilter, setFilter }) => (
    <button
        onClick={() => setFilter(value)}
        className={`px-3 py-1 text-sm font-medium rounded-full transition-colors duration-200 ${
            currentFilter === value ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-white/10 dark:text-gray-300 dark:hover:bg-white/20'
        }`}
    >
        {label}
    </button>
)

export const Plans: React.FC<PlansProps> = ({ onSelectPlan, onNewPlan }) => {
  const { planList, projects } = useDataContext();
  const { can } = useAppContext();
  const [typeFilter, setTypeFilter] = useState('All');
  const [statusFilter, setStatusFilter] = useState<PlanStatus | 'All'>('All');
  const [projectFilter, setProjectFilter] = useState('All');

  const filteredPlans = useMemo(() => {
    return planList.filter(plan => {
      const typeMatch = typeFilter === 'All' || plan.type === typeFilter;
      const statusMatch = statusFilter === 'All' || plan.status === statusFilter;
      const projectMatch = projectFilter === 'All' || plan.project_id === projectFilter;
      return typeMatch && statusMatch && projectMatch;
    });
  }, [planList, typeFilter, statusFilter, projectFilter]);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-text-primary dark:text-white">HSE Plans Library</h1>
        {can('create', 'plans') && (
            <Button onClick={onNewPlan}>
              <PlusIcon className="w-5 h-5 mr-2" />
              New Plan
            </Button>
        )}
      </div>
      
      <Card className="mb-6">
          <div className="space-y-4">
              <div>
                  <label className="text-sm font-semibold text-gray-600 dark:text-gray-400">Project</label>
                  <div className="flex flex-wrap gap-2 mt-2">
                      <FilterButton label="All Projects" value="All" currentFilter={projectFilter} setFilter={setProjectFilter} />
                      {projects.map(p => <FilterButton key={p.id} label={p.name} value={p.id} currentFilter={projectFilter} setFilter={setProjectFilter} />)}
                  </div>
              </div>
              <div>
                  <label className="text-sm font-semibold text-gray-600 dark:text-gray-400">Plan Type</label>
                  <div className="flex flex-wrap gap-2 mt-2">
                      <FilterButton label="All" value="All" currentFilter={typeFilter} setFilter={setTypeFilter} />
                      {planTypes.map(t => <FilterButton key={t} label={t} value={t} currentFilter={typeFilter} setFilter={setTypeFilter} />)}
                  </div>
              </div>
              <div>
                  <label className="text-sm font-semibold text-gray-600 dark:text-gray-400">Status</label>
                  <div className="flex flex-wrap gap-2 mt-2">
                      <FilterButton label="All" value="All" currentFilter={statusFilter} setFilter={setStatusFilter as any} />
                      {['draft', 'under_review', 'approved', 'published', 'archived'].map(s => <FilterButton key={s} label={s.replace('_', ' ')} value={s} currentFilter={statusFilter} setFilter={setStatusFilter as any} />)}
                  </div>
              </div>
          </div>
      </Card>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredPlans.map((plan) => (
          <PlanCard key={plan.id} plan={plan} onSelect={onSelectPlan} />
        ))}
        {filteredPlans.length === 0 && (
            <div className="col-span-full text-center py-12 text-gray-500">
                <p>No plans match the current filters.</p>
            </div>
        )}
      </div>
    </div>
  );
};

const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
  </svg>
);
const CheckCircleIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
);

==================================================
FILE: .\src\components\ProjectCreationModal.tsx
==================================================

import React, { useState } from 'react';
import type { Project, User } from '../types';
import { Button } from './ui/Button';

interface ProjectCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<Project, 'id' | 'org_id' | 'status'>) => void;
  users: User[];
}

export const ProjectCreationModal: React.FC<ProjectCreationModalProps> = ({ isOpen, onClose, onSubmit, users }) => {
    const [formData, setFormData] = useState({
        name: '',
        code: '',
        location: '',
        start_date: new Date().toISOString().split('T')[0],
        finish_date: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        manager_id: users.find(u => u.role === 'SUPERVISOR' || u.role === 'HSE_MANAGER')?.id || '',
        type: 'Construction'
    });
    const [error, setError] = useState('');

    const handleSubmit = () => {
        if (!formData.name.trim() || !formData.code.trim()) {
            setError('Project Name and Code are required.');
            return;
        }
        onSubmit(formData);
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b dark:border-dark-border">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">Create New Project</h3>
                </div>
                <div className="p-6 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Project Name</label>
                            <input type="text" value={formData.name} onChange={e => setFormData(p => ({...p, name: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" placeholder="e.g. Tower A" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Project Code</label>
                            <input type="text" value={formData.code} onChange={e => setFormData(p => ({...p, code: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" placeholder="e.g. PRJ-001" />
                        </div>
                    </div>
                     <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Location</label>
                            <input type="text" value={formData.location} onChange={e => setFormData(p => ({...p, location: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                            <select value={formData.type} onChange={e => setFormData(p => ({...p, type: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white">
                                <option>Construction</option>
                                <option>Shutdown</option>
                                <option>Operations</option>
                                <option>Maintenance</option>
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                            <input type="date" value={formData.start_date} onChange={e => setFormData(p => ({...p, start_date: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Finish Date</label>
                            <input type="date" value={formData.finish_date} onChange={e => setFormData(p => ({...p, finish_date: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Project Manager</label>
                        <select value={formData.manager_id} onChange={e => setFormData(p => ({...p, manager_id: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white">
                            <option value="">Select Manager</option>
                            {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                        </select>
                    </div>
                    {error && <p className="text-sm text-red-500">{error}</p>}
                </div>
                <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSubmit}>Create Project</Button>
                </div>
            </div>
        </div>
    );
};

==================================================
FILE: .\src\components\ProjectDashboard.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Project } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useDataContext, useAppContext } from '../contexts';
import { 
  PieChart, Pie, Cell, Tooltip, ResponsiveContainer, 
  AreaChart, Area, XAxis, YAxis, CartesianGrid
} from 'recharts';
import { 
  ArrowLeft, AlertTriangle, FileText, 
  Users, Shield, MapPin, TrendingUp, TrendingDown, 
  BarChart3, Activity as ActivityIcon, ShieldAlert, 
  Download, Share2, Printer, Thermometer, Droplets, Wind, CloudLightning
} from 'lucide-react';

interface ProjectDetailsProps {
  project: Project;
  onBack: () => void;
}

const COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6'];

const DashboardWidget: React.FC<{ title: string; children: React.ReactNode; className?: string; actions?: React.ReactNode }> = ({ title, children, className, actions }) => (
    <div className={`bg-gradient-to-br from-slate-900/60 to-slate-800/40 border border-white/10 backdrop-blur-lg rounded-2xl p-6 flex flex-col shadow-2xl ${className}`}>
        <div className="flex justify-between items-center mb-6">
            <h3 className="text-sm font-bold text-slate-300 uppercase tracking-wider flex items-center gap-2">{title}</h3>
            {actions && <div className="flex gap-2">{actions}</div>}
        </div>
        <div className="flex-1 min-h-0">{children}</div>
    </div>
);

const StatBox: React.FC<{ label: string; value: string | number; icon: React.ReactNode; color: string; change?: number; trend?: 'up' | 'down' }> = ({ label, value, icon, color, change, trend }) => (
    <div className="bg-gradient-to-br from-slate-800/50 to-slate-900/50 border border-white/5 p-6 rounded-2xl flex items-center justify-between hover:border-white/10 transition-all duration-300 group hover:scale-[1.02] hover:shadow-xl">
        <div>
            <p className="text-slate-400 text-xs uppercase font-semibold tracking-wide mb-2">{label}</p>
            <p className="text-3xl font-black text-white mb-1">{value}</p>
            {change !== undefined && (
                <div className="flex items-center gap-1 mt-2">
                    {trend === 'up' ? <TrendingUp className="w-4 h-4 text-green-500" /> : <TrendingDown className="w-4 h-4 text-red-500" />}
                    <span className={`text-xs font-medium ${trend === 'up' ? 'text-green-400' : 'text-red-400'}`}>{change}% from last month</span>
                </div>
            )}
        </div>
        <div className={`p-4 rounded-xl bg-white/5 ${color} group-hover:scale-110 transition-transform duration-300 shadow-lg`}>{icon}</div>
    </div>
);

export const ProjectDetails: React.FC<ProjectDetailsProps> = ({ project, onBack }) => {
  const { reportList, ptwList, inspectionList } = useDataContext();
  const { usersList } = useAppContext();
  const [activeTab, setActiveTab] = useState('Overview');

  // Filter Data for this Project
  const projectReports = useMemo(() => reportList.filter(r => r.project_id === project.id), [reportList, project.id]);
  const projectPtws = useMemo(() => ptwList.filter(p => p.project_id === project.id), [ptwList, project.id]);
  const projectInspections = useMemo(() => inspectionList.filter(i => i.project_id === project.id), [inspectionList, project.id]);
  const projectTeam = useMemo(() => usersList.filter(u => u.org_id === project.org_id), [usersList, project.org_id]);

  const stats = {
      openReports: projectReports.filter(r => r.status !== 'closed').length,
      activePtws: projectPtws.filter(p => p.status === 'ACTIVE').length,
      pendingInspections: projectInspections.filter(i => i.status !== 'Closed').length,
      safetyScore: 92, // Mock
      progress: 65, // Mock
  };

  return (
    <div className="space-y-6 animate-fade-in pb-10 bg-gradient-to-b from-slate-950 to-slate-900 min-h-screen">
      {/* Header */}
      <div className="bg-gradient-to-r from-slate-900/50 to-slate-800/30 border border-white/10 rounded-2xl p-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
          <div className="flex items-center gap-6">
            <Button variant="secondary" onClick={onBack} leftIcon={<ArrowLeft className="w-4 h-4" />} className="bg-white/5 hover:bg-white/10 border-white/10">Back</Button>
            <div className="flex items-center gap-6">
              <div className="h-20 w-20 rounded-2xl bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 flex items-center justify-center text-3xl font-bold text-white shadow-2xl border-4 border-white/20">
                {project.name.charAt(0)}
              </div>
              <div>
                <div className="flex items-center gap-4 mb-2">
                  <h1 className="text-3xl font-bold text-white">{project.name}</h1>
                  <Badge color={project.status === 'active' ? 'green' : 'yellow'}>{project.status.toUpperCase()}</Badge>
                </div>
                <div className="flex flex-wrap items-center gap-4 text-slate-300 text-sm">
                  <span className="font-mono bg-white/10 px-3 py-1 rounded-lg text-xs">{project.code || 'PRJ-001'}</span>
                  <span className="flex items-center gap-2"><MapPin className="w-4 h-4"/> {project.location}</span>
                  <span className="flex items-center gap-2"><Users className="w-4 h-4"/> {projectTeam.length} members</span>
                </div>
              </div>
            </div>
          </div>
          <div className="flex gap-3">
             <Button variant="outline" className="border-white/10 text-white hover:bg-white/10"><Download className="w-4 h-4" /></Button>
             <Button variant="outline" className="border-white/10 text-white hover:bg-white/10"><Share2 className="w-4 h-4" /></Button>
             <Button variant="outline" onClick={() => window.print()} className="border-white/10 text-white hover:bg-white/10"><Printer className="w-4 h-4" /></Button>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-slate-900/50 border border-white/10 rounded-xl overflow-hidden px-6 py-3">
        <nav className="flex space-x-8">
          {['Overview', 'Safety', 'Team', 'Documents'].map((tab) => (
            <button key={tab} onClick={() => setActiveTab(tab)} className={`relative py-3 font-medium text-sm transition-colors flex items-center gap-2 ${activeTab === tab ? 'text-emerald-400' : 'text-slate-400 hover:text-slate-200'}`}>
              {tab}
              {activeTab === tab && <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-emerald-500 to-green-500"></span>}
            </button>
          ))}
        </nav>
      </div>

      {/* Content */}
      {activeTab === 'Overview' && (
        <div className="space-y-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatBox label="Safe Man Hours" value="125,000" icon={<Shield className="w-6 h-6" />} color="text-emerald-500" change={12} trend="up" />
                <StatBox label="Active Permits" value={stats.activePtws} icon={<FileText className="w-6 h-6" />} color="text-blue-500" change={-5} trend="down" />
                <StatBox label="Open Incidents" value={stats.openReports} icon={<AlertTriangle className="w-6 h-6" />} color="text-red-500" change={2} trend="up" />
                <StatBox label="Safety Score" value={`${stats.safetyScore}%`} icon={<ShieldAlert className="w-6 h-6" />} color="text-amber-500" change={3} trend="up" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <DashboardWidget title="Incident Trend">
                    <div className="h-72">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={[{name: 'Mon', val: 2}, {name: 'Tue', val: 1}, {name: 'Wed', val: 3}, {name: 'Thu', val: 0}, {name: 'Fri', val: 1}]}>
                                <defs><linearGradient id="colorVal" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#EF4444" stopOpacity={0.4}/><stop offset="95%" stopColor="#EF4444" stopOpacity={0}/></linearGradient></defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                                <XAxis dataKey="name" tick={{ fill: '#94a3b8', fontSize: 11 }} axisLine={false} tickLine={false} />
                                <YAxis tick={{ fill: '#94a3b8', fontSize: 11 }} axisLine={false} tickLine={false} />
                                <Tooltip contentStyle={{ backgroundColor: '#0f172a', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff' }} />
                                <Area type="monotone" dataKey="val" stroke="#EF4444" strokeWidth={2} fillOpacity={1} fill="url(#colorVal)" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </DashboardWidget>
                <DashboardWidget title="Environmental Monitoring">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Temp</span><Thermometer className="w-5 h-5 text-blue-400"/></div><p className="text-2xl font-bold text-white">32Â°C</p></div>
                        <div className="p-4 rounded-xl bg-cyan-500/10 border border-cyan-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Humidity</span><Droplets className="w-5 h-5 text-cyan-400"/></div><p className="text-2xl font-bold text-white">65%</p></div>
                        <div className="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Air Quality</span><Wind className="w-5 h-5 text-emerald-400"/></div><p className="text-2xl font-bold text-white">Good</p></div>
                        <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Noise</span><CloudLightning className="w-5 h-5 text-amber-400"/></div><p className="text-2xl font-bold text-white">85 dB</p></div>
                    </div>
                </DashboardWidget>
            </div>
        </div>
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\ProjectDetails.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Project, User } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useDataContext, useAppContext } from '../contexts';
import { 
  PieChart, Pie, Cell, Tooltip, ResponsiveContainer, 
  AreaChart, Area, XAxis, YAxis, CartesianGrid
} from 'recharts';
import { 
  ArrowLeft, AlertTriangle, FileText, ClipboardCheck, 
  Users, Shield, MapPin, Calendar, TrendingUp, TrendingDown, 
  BarChart3, Activity, ShieldAlert, Wrench, 
  Download, Share2, Printer, Thermometer, Droplets, Wind, CloudLightning,
  Clock, MessageSquare, Eye,
  Plus, MoreVertical, 
  Award, Trophy,
  FileCheck,
  Activity as ActivityIcon,
  List
} from 'lucide-react';

interface ProjectDetailsProps {
  project: Project;
  onBack: () => void;
  onEdit: () => void;
}

const COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6'];

// --- Reusable Dashboard Widget Component ---
const DashboardWidget: React.FC<{ 
  title: string; 
  children: React.ReactNode; 
  className?: string;
  actions?: React.ReactNode;
}> = ({ title, children, className, actions }) => (
  <div className={`bg-gradient-to-br from-slate-900/50 to-slate-800/30 border border-white/10 backdrop-blur-md rounded-xl p-6 flex flex-col shadow-xl ${className}`}>
    <div className="flex justify-between items-center mb-6">
      <h3 className="text-sm font-bold text-slate-300 uppercase tracking-wider flex items-center gap-2">
        {title}
      </h3>
      {actions && (
        <div className="flex gap-2">
          {actions}
        </div>
      )}
    </div>
    <div className="flex-1 min-h-0">
      {children}
    </div>
  </div>
);

// --- Stat Box Component ---
const StatBox: React.FC<{ 
  label: string; 
  value: string | number; 
  icon: React.ReactNode; 
  color: string;
  change?: number;
  trend?: 'up' | 'down' | 'neutral';
}> = ({ label, value, icon, color, change, trend }) => (
  <div className="bg-gradient-to-br from-slate-800/40 to-slate-900/40 border border-white/5 p-5 rounded-xl flex items-center justify-between hover:border-white/10 transition-all duration-300 group hover:scale-[1.02]">
    <div>
      <p className="text-slate-400 text-xs uppercase font-semibold tracking-wide mb-2">{label}</p>
      <p className="text-3xl font-black text-white mb-1">{value}</p>
      {change !== undefined && (
        <div className="flex items-center gap-1">
          {trend === 'up' ? (
            <TrendingUp className="w-4 h-4 text-green-500" />
          ) : trend === 'down' ? (
            <TrendingDown className="w-4 h-4 text-red-500" />
          ) : (
            <Activity className="w-4 h-4 text-blue-500" />
          )}
          <span className={`text-xs font-medium ${trend === 'up' ? 'text-green-400' : trend === 'down' ? 'text-red-400' : 'text-blue-400'}`}>
            {trend === 'up' ? '+' : ''}{change}% from last month
          </span>
        </div>
      )}
    </div>
    <div className={`p-3 rounded-lg bg-white/5 ${color} group-hover:scale-110 transition-transform duration-300`}>
      {icon}
    </div>
  </div>
);

// --- Activity Feed Item ---
interface ActivityItem {
    id: string;
    type: 'report' | 'inspection' | 'ptw' | 'rams' | 'equipment' | 'training' | 'message' | 'incident' | 'milestone';
    title: string;
    description: string;
    user: User;
    timestamp: string;
    data: any;
    status?: string;
    priority?: 'low' | 'medium' | 'high';
}

const ActivityFeedItem: React.FC<{ activity: ActivityItem }> = ({ activity }) => {
    const getIcon = () => {
        switch (activity.type) {
            case 'report': return <FileText className="w-5 h-5 text-blue-500" />;
            case 'inspection': return <ClipboardCheck className="w-5 h-5 text-emerald-500" />;
            case 'ptw': return <FileCheck className="w-5 h-5 text-purple-500" />;
            case 'rams': return <ShieldAlert className="w-5 h-5 text-amber-500" />;
            case 'equipment': return <Wrench className="w-5 h-5 text-blue-500" />;
            case 'training': return <Award className="w-5 h-5 text-purple-500" />;
            case 'message': return <MessageSquare className="w-5 h-5 text-slate-400" />;
            case 'incident': return <AlertTriangle className="w-5 h-5 text-red-500" />;
            case 'milestone': return <Trophy className="w-5 h-5 text-yellow-500" />;
            default: return <ActivityIcon className="w-5 h-5 text-slate-400" />;
        }
    };

    const getBadgeColor = () => {
        switch (activity.type) {
            case 'report': return 'blue';
            case 'inspection': return 'green';
            case 'ptw': return 'purple';
            case 'rams': return 'amber';
            case 'equipment': return 'blue';
            case 'training': return 'purple';
            case 'message': return 'gray';
            case 'incident': return 'red';
            case 'milestone': return 'yellow';
            default: return 'gray';
        }
    };

    // SAFE GUARD: Type
    const typeLabel = activity.type ? (activity.type.charAt(0).toUpperCase() + activity.type.slice(1)) : 'Unknown';

    return (
        <div className="flex items-start gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:border-white/10 transition-colors group">
            <div className="flex-shrink-0">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold">
                    {activity.user?.name?.charAt(0) || '?'}
                </div>
            </div>
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                    <span className="font-semibold text-white">{activity.user?.name || 'Unknown User'}</span>
                    <Badge color={getBadgeColor()} size="sm">
                        {typeLabel}
                    </Badge>
                    {activity.priority && (
                        <Badge color={activity.priority === 'high' ? 'red' : activity.priority === 'medium' ? 'amber' : 'green'} size="sm">
                            {activity.priority}
                        </Badge>
                    )}
                </div>
                <p className="text-white font-medium mb-1">{activity.title}</p>
                <p className="text-slate-400 text-sm mb-2">{activity.description}</p>
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4 text-xs text-slate-500">
                        <span className="flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {new Date(activity.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </span>
                        <span className="flex items-center gap-1">
                            <Calendar className="w-3 h-3" />
                            {new Date(activity.timestamp).toLocaleDateString()}
                        </span>
                        {activity.status && (
                            <span className={`flex items-center gap-1 ${activity.status === 'completed' ? 'text-emerald-400' : 'text-amber-400'}`}>
                                <span className="w-1.5 h-1.5 rounded-full bg-current"></span>
                                {activity.status}
                            </span>
                        )}
                    </div>
                    <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <Button size="sm" variant="ghost" className="h-8 w-8 p-0">
                            <Eye className="w-4 h-4" />
                        </Button>
                        <Button size="sm" variant="ghost" className="h-8 w-8 p-0">
                            <MessageSquare className="w-4 h-4" />
                        </Button>
                    </div>
                </div>
            </div>
            <div className="flex-shrink-0">
                {getIcon()}
            </div>
        </div>
    );
};

// --- Team Member Card ---
const TeamMemberCard: React.FC<{ user: User; activities: ActivityItem[] }> = ({ user, activities }) => {
    const userActivities = activities.filter(a => a.user?.id === user.id);
    const recentActivity = userActivities[0];

    // SAFE GUARD: Role check
    const roleLabel = (user.role || 'Unknown').replace(/_/g, ' ');

    return (
        <div className="p-4 rounded-xl bg-white/5 border border-white/5 hover:border-white/10 transition-colors">
            <div className="flex items-start justify-between mb-4">
                <div className="flex items-center gap-3">
                    <div className="relative">
                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg">
                            {user.name?.charAt(0) || '?'}
                        </div>
                        <div className="absolute -bottom-1 -right-1 w-4 h-4 rounded-full bg-green-500 border-2 border-slate-900"></div>
                    </div>
                    <div>
                        <h4 className="font-bold text-white">{user.name || 'Unknown'}</h4>
                        <p className="text-xs text-slate-400">{user.email}</p>
                        <Badge color={
                            user.role === 'ADMIN' ? 'purple' :
                            user.role === 'HSE_MANAGER' ? 'blue' :
                            user.role === 'SUPERVISOR' ? 'green' :
                            user.role === 'INSPECTOR' ? 'amber' : 'gray'
                        } size="sm">
                            {roleLabel}
                        </Badge>
                    </div>
                </div>
                <button className="text-slate-400 hover:text-white">
                    <MoreVertical className="w-5 h-5" />
                </button>
            </div>

            <div className="space-y-3">
                <div className="flex items-center justify-between text-sm">
                    <span className="text-slate-400">Activities Today</span>
                    <span className="text-white font-bold">{userActivities.length}</span>
                </div>

                {recentActivity && (
                    <div className="pt-3 border-t border-white/5">
                        <p className="text-xs text-slate-400 mb-1">Recent Activity</p>
                        <p className="text-sm text-white truncate">{recentActivity.title}</p>
                        <p className="text-xs text-slate-500 mt-1">
                            {new Date(recentActivity.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </p>
                    </div>
                )}

                <div className="pt-3 border-t border-white/5">
                    <div className="flex gap-2">
                        <Button size="sm" variant="ghost" className="flex-1">
                            <MessageSquare className="w-4 h-4 mr-2" />
                            Message
                        </Button>
                        <Button size="sm" variant="ghost" className="flex-1">
                            <Eye className="w-4 h-4 mr-2" />
                            View
                        </Button>
                    </div>
                </div>
            </div>
        </div>
    );
};

export const ProjectDetails: React.FC<ProjectDetailsProps> = ({ project, onBack, onEdit }) => {
  const { 
    reportList, 
    ptwList, 
    inspectionList, 
    ramsList, 
    trainingSessionList, 
    tbtList
  } = useDataContext();
  
  const { usersList } = useAppContext();
  
  const [activeTab, setActiveTab] = useState('Overview');
  const [activityFilter, setActivityFilter] = useState<string>('all');
  const [teamView, setTeamView] = useState<'grid' | 'list'>('grid');

  // Filter Data for this Project
  const projectReports = useMemo(() => reportList.filter(r => r.project_id === project.id), [reportList, project.id]);
  const projectPtws = useMemo(() => ptwList.filter(p => p.project_id === project.id), [ptwList, project.id]);
  const projectInspections = useMemo(() => inspectionList.filter(i => i.project_id === project.id), [inspectionList, project.id]);
  const projectRams = useMemo(() => ramsList.filter(r => r.project_id === project.id), [ramsList, project.id]);
  const projectTraining = useMemo(() => trainingSessionList.filter(t => t.project_id === project.id), [trainingSessionList, project.id]);
  const projectTbt = useMemo(() => tbtList.filter(t => t.project_id === project.id), [tbtList, project.id]);

  // Get project team members
  const projectTeam = useMemo(() => {
    return usersList.filter(u => 
      u.org_id === project.org_id && 
      (u.role === 'ADMIN' || 
       u.role === 'ORG_ADMIN' ||
       u.role === 'HSE_MANAGER' ||
       u.role === 'SUPERVISOR' ||
       u.role === 'INSPECTOR')
    );
  }, [usersList, project.org_id]);

  // Create comprehensive activity feed
  const activityFeed = useMemo(() => {
    const activities: ActivityItem[] = [];

    // Add reports
    projectReports.forEach(report => {
      const user = usersList.find(u => u.id === report.reporter_id);
      if (user) {
        activities.push({
          id: report.id,
          type: 'report',
          title: `${report.type} Report`,
          description: report.description || 'No description provided',
          user,
          timestamp: report.reported_at || new Date().toISOString(),
          data: report,
          status: report.status,
          priority: report.risk_pre_control.severity > 3 ? 'high' : 'medium'
        });
      }
    });

    // Add inspections
    projectInspections.forEach(inspection => {
      const user = usersList.find(u => u.id === inspection.person_responsible_id);
      if (user) {
        activities.push({
          id: inspection.id,
          type: 'inspection',
          title: `${inspection.type} Inspection`,
          description: inspection.overall_comments || 'Inspection completed',
          user,
          timestamp: inspection.schedule_at || new Date().toISOString(),
          data: inspection,
          status: inspection.status,
          priority: 'medium'
        });
      }
    });

    // Add PTW
    projectPtws.forEach(ptw => {
      const user = usersList.find(u => u.id === ptw.payload.creator_id);
      if (user) {
        activities.push({
          id: ptw.id,
          type: 'ptw',
          title: `PTW: ${ptw.type}`,
          description: ptw.payload.work.description || 'Permit to Work',
          user,
          timestamp: ptw.updated_at || new Date().toISOString(),
          data: ptw,
          status: ptw.status.toLowerCase(),
          priority: 'medium'
        });
      }
    });

    // Sort by timestamp (newest first)
    return activities.sort((a, b) => 
      new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
    );
  }, [projectReports, projectInspections, projectPtws, usersList]);

  // Filter activities based on selected filter
  const filteredActivities = useMemo(() => {
    if (activityFilter === 'all') return activityFeed;
    return activityFeed.filter(activity => activity.type === activityFilter);
  }, [activityFeed, activityFilter]);

  // Calculate statistics
  const stats = useMemo(() => {
    const today = new Date();
    const todayActivities = activityFeed.filter(a => 
      new Date(a.timestamp).toDateString() === today.toDateString()
    );

    const userActivityCounts = projectTeam.reduce((acc, user) => {
      acc[user.id] = activityFeed.filter(a => a.user.id === user.id).length;
      return acc;
    }, {} as Record<string, number>);

    // SAFE GUARD: Empty project team check
    const mostActiveUser = projectTeam.length > 0 ? projectTeam.reduce((mostActive, user) => {
      return userActivityCounts[user.id] > (userActivityCounts[mostActive.id] || 0) ? user : mostActive;
    }, projectTeam[0]) : { id: '', name: 'No users' };

    return {
      openReports: projectReports.filter(r => r.status !== 'closed').length,
      activePtws: projectPtws.filter(p => p.status === 'ACTIVE').length,
      pendingInspections: projectInspections.filter(i => i.status !== 'Closed').length,
      safetyScore: 92, // Mock
      progress: 0, // Mock
      totalActivities: activityFeed.length,
      todayActivities: todayActivities.length,
      teamSize: projectTeam.length,
      mostActiveUser: mostActiveUser.name,
      mostActiveCount: mostActiveUser.id ? userActivityCounts[mostActiveUser.id] : 0,
      activityByType: {
        reports: projectReports.length,
        inspections: projectInspections.length,
        ptws: projectPtws.length,
        rams: projectRams.length,
        training: projectTraining.length,
        tbt: projectTbt.length
      }
    };
  }, [projectReports, projectPtws, projectInspections, projectRams, projectTraining, projectTbt, activityFeed, projectTeam]);

  // SAFE GUARD: Project Status
  const projectStatus = (project.status || 'Unknown').toUpperCase();

  return (
    <div className="space-y-6 animate-fade-in pb-10 bg-gradient-to-b from-slate-950 to-slate-900 min-h-screen">
      {/* Header */}
      <div className="bg-gradient-to-r from-slate-900/50 to-slate-800/30 border border-white/10 rounded-2xl p-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
          <div className="flex items-center gap-6">
            <Button variant="secondary" onClick={onBack} leftIcon={<ArrowLeft className="w-4 h-4" />} className="bg-white/5 hover:bg-white/10 border-white/10">Back</Button>
            <div className="flex items-center gap-6">
              <div className="h-20 w-20 rounded-2xl bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 flex items-center justify-center text-3xl font-bold text-white shadow-2xl border-4 border-white/20">
                {project.name.charAt(0)}
              </div>
              <div>
                <div className="flex items-center gap-4 mb-2">
                  <h1 className="text-3xl font-bold text-white">{project.name}</h1>
                  <Badge color={project.status === 'active' ? 'green' : 'yellow'}>{projectStatus}</Badge>
                </div>
                <div className="flex flex-wrap items-center gap-4 text-slate-300 text-sm">
                  <span className="font-mono bg-white/10 px-3 py-1 rounded-lg text-xs">{project.code || 'PRJ-001'}</span>
                  <span className="flex items-center gap-2"><MapPin className="w-4 h-4"/> {project.location}</span>
                  <span className="flex items-center gap-2"><Users className="w-4 h-4"/> {stats.teamSize} members</span>
                  <span className="flex items-center gap-2"><ActivityIcon className="w-4 h-4"/> {stats.totalActivities} activities</span>
                </div>
              </div>
            </div>
          </div>
          <div className="flex gap-3">
             <Button variant="outline" className="border-white/10 text-white hover:bg-white/10"><Download className="w-4 h-4" /></Button>
             <Button variant="outline" className="border-white/10 text-white hover:bg-white/10"><Share2 className="w-4 h-4" /></Button>
             <Button variant="outline" onClick={() => window.print()} className="border-white/10 text-white hover:bg-white/10"><Printer className="w-4 h-4" /></Button>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-slate-900/50 border border-white/10 rounded-xl overflow-hidden px-6 py-3">
        <nav className="flex space-x-8">
          {['Overview', 'Team', 'Activities', 'Safety', 'Documents'].map((tab) => (
            <button key={tab} onClick={() => setActiveTab(tab)} className={`relative py-3 font-medium text-sm transition-colors flex items-center gap-2 ${activeTab === tab ? 'text-emerald-400' : 'text-slate-400 hover:text-slate-200'}`}>
              {tab === 'Overview' && <BarChart3 className="w-4 h-4" />}
              {tab === 'Team' && <Users className="w-4 h-4" />}
              {tab === 'Activities' && <ActivityIcon className="w-4 h-4" />}
              {tab === 'Safety' && <Shield className="w-4 h-4" />}
              {tab === 'Documents' && <FileText className="w-4 h-4" />}
              {tab}
              {activeTab === tab && <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-emerald-500 to-green-500"></span>}
            </button>
          ))}
        </nav>
      </div>

      {/* Tab Content */}
      {activeTab === 'Overview' && (
        <div className="space-y-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatBox label="Team Members" value={stats.teamSize} icon={<Users className="w-6 h-6" />} color="text-blue-500" change={8} trend="up" />
                <StatBox label="Total Activities" value={stats.totalActivities} icon={<ActivityIcon className="w-6 h-6" />} color="text-purple-500" change={15} trend="up" />
                <StatBox label="Open Issues" value={stats.openReports} icon={<AlertTriangle className="w-6 h-6" />} color="text-red-500" change={2} trend="up" />
                <StatBox label="Safety Score" value={`${stats.safetyScore}%`} icon={<ShieldAlert className="w-6 h-6" />} color="text-amber-500" change={3} trend="up" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <DashboardWidget title="Recent Team Activities">
                    <div className="space-y-4 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        {filteredActivities.length > 0 ? (
                            filteredActivities.slice(0, 5).map(activity => (
                                <ActivityFeedItem key={activity.id} activity={activity} />
                            ))
                        ) : (
                            <div className="text-center py-12">
                                <ActivityIcon className="w-16 h-16 text-slate-700 mx-auto mb-4" />
                                <p className="text-slate-500">No activities found</p>
                            </div>
                        )}
                    </div>
                </DashboardWidget>

                <DashboardWidget title="Activity by Type">
                    <div className="h-64">
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={Object.entries(stats.activityByType).map(([key, value]) => ({
                                        name: key.charAt(0).toUpperCase() + key.slice(1),
                                        value
                                    }))}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={40}
                                    outerRadius={70}
                                    paddingAngle={2}
                                    dataKey="value"
                                >
                                    {Object.keys(stats.activityByType).map((_, index) => (
                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                    ))}
                                </Pie>
                                <Tooltip contentStyle={{ backgroundColor: '#0f172a', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff' }} />
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                </DashboardWidget>
            </div>
        </div>
      )}

      {activeTab === 'Team' && (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-xl font-bold text-white mb-1">Project Team</h2>
                    <p className="text-slate-400 text-sm">{stats.teamSize} members working on this project</p>
                </div>
                <div className="flex gap-3">
                    <div className="flex border rounded-lg border-white/10">
                        <button 
                            onClick={() => setTeamView('grid')}
                            className={`p-2 ${teamView === 'grid' ? 'bg-white/10' : ''}`}
                        >
                            <BarChart3 className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setTeamView('list')}
                            className={`p-2 ${teamView === 'list' ? 'bg-white/10' : ''}`}
                        >
                            <List className="w-4 h-4" />
                        </button>
                    </div>
                    <Button className="bg-gradient-to-r from-blue-600 to-indigo-600" onClick={onEdit}>
                        <Plus className="w-4 h-4 mr-2" />
                        Add Member
                    </Button>
                </div>
            </div>

            {teamView === 'grid' ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {projectTeam.map(user => (
                        <TeamMemberCard 
                            key={user.id} 
                            user={user} 
                            activities={activityFeed} 
                        />
                    ))}
                    {projectTeam.length === 0 && (
                        <p className="text-slate-500 italic col-span-full text-center">No team members assigned.</p>
                    )}
                </div>
            ) : (
                <DashboardWidget title="Team Members List">
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead>
                                <tr className="border-b border-white/10">
                                    <th className="pb-3 text-left text-slate-400 font-medium">Member</th>
                                    <th className="pb-3 text-left text-slate-400 font-medium">Role</th>
                                    <th className="pb-3 text-left text-slate-400 font-medium">Activities</th>
                                    <th className="pb-3 text-left text-slate-400 font-medium">Last Active</th>
                                    <th className="pb-3 text-left text-slate-400 font-medium">Status</th>
                                    <th className="pb-3 text-left text-slate-400 font-medium">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                                {projectTeam.map(user => {
                                    const userActivities = activityFeed.filter(a => a.user?.id === user.id);
                                    const lastActivity = userActivities[0];
                                    
                                    // SAFE GUARD: Role check
                                    const roleLabel = (user.role || 'Unknown').replace(/_/g, ' ');

                                    return (
                                        <tr key={user.id} className="hover:bg-white/5 transition-colors">
                                            <td className="py-3">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold">
                                                        {user.name?.charAt(0) || '?'}
                                                    </div>
                                                    <div>
                                                        <p className="font-medium text-white">{user.name}</p>
                                                        <p className="text-xs text-slate-500">{user.email}</p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="py-3">
                                                <Badge color={
                                                    user.role === 'ADMIN' ? 'purple' :
                                                    user.role === 'HSE_MANAGER' ? 'blue' :
                                                    user.role === 'SUPERVISOR' ? 'green' :
                                                    user.role === 'INSPECTOR' ? 'amber' : 'gray'
                                                } size="sm">
                                                    {roleLabel}
                                                </Badge>
                                            </td>
                                            <td className="py-3">
                                                <div className="text-white font-medium">{userActivities.length}</div>
                                                <div className="text-xs text-slate-500">total activities</div>
                                            </td>
                                            <td className="py-3">
                                                {lastActivity ? (
                                                    <>
                                                        <div className="text-white text-sm">
                                                            {new Date(lastActivity.timestamp).toLocaleDateString()}
                                                        </div>
                                                        <div className="text-xs text-slate-500">
                                                            {lastActivity.type}
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className="text-slate-500 text-sm">No activity</div>
                                                )}
                                            </td>
                                            <td className="py-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                                    <span className="text-sm text-slate-300">Active</span>
                                                </div>
                                            </td>
                                            <td className="py-3">
                                                <div className="flex gap-2">
                                                    <Button size="sm" variant="ghost">
                                                        <MessageSquare className="w-4 h-4" />
                                                    </Button>
                                                    <Button size="sm" variant="ghost">
                                                        <Eye className="w-4 h-4" />
                                                    </Button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </DashboardWidget>
            )}
        </div>
      )}

      {activeTab === 'Safety' && (
        <div className="space-y-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatBox label="Safe Man Hours" value="125,000" icon={<Shield className="w-6 h-6" />} color="text-emerald-500" change={12} trend="up" />
                <StatBox label="Active Permits" value={stats.activePtws} icon={<FileText className="w-6 h-6" />} color="text-blue-500" change={-5} trend="down" />
                <StatBox label="Open Incidents" value={stats.openReports} icon={<AlertTriangle className="w-6 h-6" />} color="text-red-500" change={2} trend="up" />
                <StatBox label="Safety Score" value={`${stats.safetyScore}%`} icon={<ShieldAlert className="w-6 h-6" />} color="text-amber-500" change={3} trend="up" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <DashboardWidget title="Incident Trend">
                    <div className="h-72">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={[{name: 'Mon', val: 2}, {name: 'Tue', val: 1}, {name: 'Wed', val: 3}, {name: 'Thu', val: 0}, {name: 'Fri', val: 1}]}>
                                <defs><linearGradient id="colorVal" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#EF4444" stopOpacity={0.4}/><stop offset="95%" stopColor="#EF4444" stopOpacity={0}/></linearGradient></defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                                <XAxis dataKey="name" tick={{ fill: '#94a3b8', fontSize: 11 }} axisLine={false} tickLine={false} />
                                <YAxis tick={{ fill: '#94a3b8', fontSize: 11 }} axisLine={false} tickLine={false} />
                                <Tooltip contentStyle={{ backgroundColor: '#0f172a', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff' }} />
                                <Area type="monotone" dataKey="val" stroke="#EF4444" strokeWidth={2} fillOpacity={1} fill="url(#colorVal)" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </DashboardWidget>
                <DashboardWidget title="Environmental Monitoring">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-4 rounded-xl bg-blue-500/10 border border-blue-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Temp</span><Thermometer className="w-5 h-5 text-blue-400"/></div><p className="text-2xl font-bold text-white">32Â°C</p></div>
                        <div className="p-4 rounded-xl bg-cyan-500/10 border border-cyan-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Humidity</span><Droplets className="w-5 h-5 text-cyan-400"/></div><p className="text-2xl font-bold text-white">65%</p></div>
                        <div className="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Air Quality</span><Wind className="w-5 h-5 text-emerald-400"/></div><p className="text-2xl font-bold text-white">Good</p></div>
                        <div className="p-4 rounded-xl bg-amber-500/10 border border-amber-500/20"><div className="flex justify-between mb-2"><span className="text-sm text-slate-300">Noise</span><CloudLightning className="w-5 h-5 text-amber-400"/></div><p className="text-2xl font-bold text-white">85 dB</p></div>
                    </div>
                </DashboardWidget>
            </div>
        </div>
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\Projects.tsx
==================================================

import React, { useMemo, useState } from 'react';
import type { Project, User } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext, useDataContext } from '../contexts';
import { 
    Briefcase, Calendar, MapPin, Users, Activity, 
    AlertTriangle, FileText, CheckSquare, ArrowLeft, 
    Plus, Settings, MoreVertical 
} from 'lucide-react';
import { roles } from '../config';

// --- Project Creation/Edit Modal ---
interface ProjectModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<Project, 'id' | 'org_id' | 'status'>) => void;
  users: User[];
  initialData?: Project;
}

const ProjectModal: React.FC<ProjectModalProps> = ({ isOpen, onClose, onSubmit, users, initialData }) => {
    const [formData, setFormData] = useState({
        name: initialData?.name || '',
        code: initialData?.code || '',
        location: initialData?.location || '',
        start_date: initialData?.start_date || new Date().toISOString().split('T')[0],
        finish_date: initialData?.finish_date || new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        manager_id: initialData?.manager_id || '',
        type: initialData?.type || 'Construction'
    });
    const [error, setError] = useState('');

    const handleSubmit = () => {
        if (!formData.name.trim() || !formData.code.trim()) {
            setError('Project Name and Code are required.');
            return;
        }
        onSubmit(formData);
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b dark:border-dark-border">
                    <h3 className="text-xl font-bold text-gray-900 dark:text-white">Create New Project</h3>
                </div>
                <div className="p-6 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Project Name</label>
                            <input type="text" value={formData.name} onChange={e => setFormData(p => ({...p, name: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" placeholder="e.g. Tower A" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Project Code</label>
                            <input type="text" value={formData.code} onChange={e => setFormData(p => ({...p, code: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" placeholder="e.g. PRJ-001" />
                        </div>
                    </div>
                     <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Location</label>
                            <input type="text" value={formData.location} onChange={e => setFormData(p => ({...p, location: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                            <select value={formData.type} onChange={e => setFormData(p => ({...p, type: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white">
                                <option>Construction</option>
                                <option>Shutdown</option>
                                <option>Operations</option>
                                <option>Maintenance</option>
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                            <input type="date" value={formData.start_date} onChange={e => setFormData(p => ({...p, start_date: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Finish Date</label>
                            <input type="date" value={formData.finish_date} onChange={e => setFormData(p => ({...p, finish_date: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Project Manager</label>
                        <select value={formData.manager_id} onChange={e => setFormData(p => ({...p, manager_id: e.target.value}))} className="mt-1 w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white">
                            <option value="">Select Manager</option>
                            {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                        </select>
                    </div>
                    {error && <p className="text-sm text-red-500">{error}</p>}
                </div>
                <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
                    <Button variant="secondary" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSubmit}>Create Project</Button>
                </div>
            </div>
        </div>
    );
};

// --- Project Card Component ---
const ProjectCard: React.FC<{ 
    project: Project; 
    users: User[]; 
    onView: () => void; 
}> = ({ project, users, onView }) => {
    const getStatusColor = (status: Project['status']): 'green' | 'yellow' | 'gray' => {
        switch (status) { case 'active': return 'green'; case 'pending': return 'yellow'; case 'archived': return 'gray'; }
    };

    const crew = useMemo(() => users.filter(u => u.org_id === project.org_id), [users, project.org_id]);
    const crewCounts = useMemo(() => ({
        managers: crew.filter(c => c.role === 'HSE_MANAGER').length,
        supervisors: crew.filter(c => c.role === 'SUPERVISOR').length,
        officers: crew.filter(c => c.role === 'HSE_OFFICER').length,
        inspectors: crew.filter(c => c.role === 'INSPECTOR').length,
        workers: crew.filter(c => c.role === 'WORKER').length,
    }), [crew]);

    return (
        <Card className="hover:shadow-lg transition-all cursor-pointer flex flex-col" onClick={onView}>
            <div className="flex justify-between items-start">
                <div>
                    <h3 className="text-lg font-bold text-gray-900 dark:text-white">{project.name} <span className="font-normal text-base text-gray-500">({project.code})</span></h3>
                    <p className="text-sm text-gray-500">{project.location}</p>
                </div>
                <Badge color={getStatusColor(project.status)}>{project.status}</Badge>
            </div>
            <div className="mt-4 border-t border-gray-100 dark:border-dark-border pt-4">
                <h4 className="text-sm font-bold mb-2 text-gray-700 dark:text-gray-300">Crew Overview</h4>
                <div className="grid grid-cols-3 gap-2 text-center text-xs">
                    <div className="bg-gray-100 dark:bg-white/5 p-1 rounded text-gray-700 dark:text-gray-300"><strong>{crewCounts.managers}</strong> Managers</div>
                    <div className="bg-gray-100 dark:bg-white/5 p-1 rounded text-gray-700 dark:text-gray-300"><strong>{crewCounts.officers}</strong> HSE Officers</div>
                    <div className="bg-gray-100 dark:bg-white/5 p-1 rounded text-gray-700 dark:text-gray-300"><strong>{crewCounts.supervisors}</strong> Supervisors</div>
                    <div className="bg-gray-100 dark:bg-white/5 p-1 rounded text-gray-700 dark:text-gray-300"><strong>{crewCounts.inspectors}</strong> Inspectors</div>
                    <div className="bg-gray-100 dark:bg-white/5 p-1 rounded col-span-2 text-gray-700 dark:text-gray-300"><strong>{crewCounts.workers}</strong> Workers</div>
                </div>
            </div>
             <div className="mt-4 border-t border-gray-100 dark:border-dark-border pt-4 grid grid-cols-3 gap-2 text-center">
                 <div><p className="text-2xl font-bold text-gray-900 dark:text-white">82%</p><p className="text-xs text-gray-500">Training</p></div>
                 <div><p className="text-2xl font-bold text-gray-900 dark:text-white">17</p><p className="text-xs text-gray-500">PTW Today</p></div>
                 <div><p className="text-2xl font-bold text-green-600">0</p><p className="text-xs text-gray-500">Incidents</p></div>
            </div>
            <div className="mt-auto pt-4 flex justify-end">
                <Button 
                    variant="secondary" 
                    size="sm" 
                    onClick={(e) => {
                        e.stopPropagation(); 
                        onView();
                    }}
                >
                    View Dashboard
                </Button>
            </div>
        </Card>
    );
}

// --- Main Projects List ---
export const Projects: React.FC = () => {
  const { activeOrg, usersList, can } = useAppContext();
  const { projects, handleCreateProject, isLoading } = useDataContext();
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedProject, setSelectedProject] = useState<Project | null>(null);

  const orgProjects = useMemo(() => projects.filter(p => p.org_id === activeOrg.id), [projects, activeOrg]);
  const canCreate = can('create', 'projects');

  const handleCreateSubmit = (data: any) => {
    handleCreateProject(data);
    setIsModalOpen(false);
  };

  if (selectedProject) {
      // In a real app, you would navigate to a route. Here we just render the detail view.
      // We need to import ProjectDetails but it's not imported in this file to avoid circular dependency in this snippet.
      // Assuming ProjectDetails is handled by parent or router.
      return <div>Project Details View Placeholder</div>;
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <div>
            <h1 className="text-3xl font-bold text-text-primary dark:text-white">Projects</h1>
            <p className="text-text-secondary dark:text-gray-400">{activeOrg.name}</p>
        </div>
        {canCreate && (
            <Button onClick={() => setIsModalOpen(true)}>
                <Plus className="w-5 h-5 mr-2" />
                New Project
            </Button>
        )}
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {orgProjects.map(project => (
              <ProjectCard 
                key={project.id} 
                project={project} 
                users={usersList} 
                onView={() => setSelectedProject(project)} 
              />
          ))}
      </div>
      
       {orgProjects.length === 0 && !isLoading && (
            <div className="text-center py-12 bg-gray-50 dark:bg-white/5 rounded-xl border border-dashed border-gray-300 dark:border-gray-700">
                <Briefcase className="w-12 h-12 mx-auto text-gray-400 mb-3" />
                <h3 className="text-lg font-semibold text-gray-900 dark:text-white">No projects found</h3>
                <p className="text-gray-500 dark:text-gray-400 mt-1">Create a project to start managing your HSE operations.</p>
                {canCreate && <Button className="mt-4" onClick={() => setIsModalOpen(true)}>Create First Project</Button>}
            </div>
        )}

      <ProjectModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSubmit={handleCreateSubmit}
        users={usersList.filter(u => u.org_id === activeOrg.id)}
      />
    </div>
  );
};

==================================================
FILE: .\src\components\Ptw.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Project, User } from '../types';
import type { Ptw as PtwDoc } from '../types';
import { Button } from './ui/Button';
import { ptwTypeDetails } from '../config';
import { useAppContext } from '../contexts';
import { 
  Plus, Search, FileText, 
  AlertTriangle, Clock, Calendar, 
  MapPin, User as UserIcon, CheckCircle,
  Shield // <--- FIXED: Added missing import
} from 'lucide-react';

// === GEN 4 STYLES ===
const glassStyles = {
  card: "bg-slate-900/60 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden transition-all duration-300 hover:scale-[1.01] hover:border-cyan-500/30 group relative",
  badge: "px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border flex items-center gap-1",
  filterBtn: "px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border transition-all duration-300"
};

const getStatusConfig = (status: PtwDoc['status']) => {
    switch (status) {
      case 'ACTIVE': return { label: 'ACTIVE', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', icon: CheckCircle };
      case 'APPROVAL': return { label: 'PENDING APPROVAL', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20', icon: Clock };
      case 'PRE_SCREEN':
      case 'SITE_INSPECTION':
      case 'SUBMITTED': return { label: 'IN REVIEW', color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20', icon: FileText };
      case 'HOLD': return { label: 'ON HOLD', color: 'text-rose-400', bg: 'bg-rose-500/10', border: 'border-rose-500/20', icon: AlertTriangle };
      case 'COMPLETED':
      case 'CLOSED': return { label: 'CLOSED', color: 'text-slate-400', bg: 'bg-slate-500/10', border: 'border-slate-500/20', icon: CheckCircle };
      default: return { label: 'DRAFT', color: 'text-slate-500', bg: 'bg-slate-500/5', border: 'border-slate-500/10', icon: FileText };
    }
};

interface PtwProps {
  ptws: PtwDoc[];
  users: User[];
  projects: Project[];
  onCreatePtw: () => void;
  onAddExistingPtw: () => void;
  onSelectPtw: (ptw: PtwDoc) => void;
}

const StatCard: React.FC<{ label: string, value: number, color: string, icon: React.ReactNode }> = ({ label, value, color, icon }) => (
    <div className={`${glassStyles.card} p-4 flex items-center justify-between`}>
        <div>
            <p className="text-xs font-bold text-slate-500 uppercase tracking-wider">{label}</p>
            <p className={`text-2xl font-black ${color} mt-1`}>{value}</p>
        </div>
        <div className={`p-3 rounded-xl bg-white/5 ${color} opacity-80`}>
            {icon}
        </div>
    </div>
);

export const Ptw: React.FC<PtwProps> = ({ ptws, users, projects, onCreatePtw, onAddExistingPtw, onSelectPtw }) => {
  const { can } = useAppContext();
  const [filter, setFilter] = useState<'All' | 'Active' | 'Draft' | 'Closed'>('All');
  const [search, setSearch] = useState('');

  const filteredPtws = useMemo(() => {
    return ptws.filter(p => {
        const matchesSearch = !search || 
            p.title.toLowerCase().includes(search.toLowerCase()) || 
            p.payload.permit_no?.toLowerCase().includes(search.toLowerCase());
        
        if (filter === 'All') return matchesSearch;
        if (filter === 'Active') return matchesSearch && p.status === 'ACTIVE';
        if (filter === 'Draft') return matchesSearch && p.status === 'DRAFT';
        if (filter === 'Closed') return matchesSearch && (p.status === 'CLOSED' || p.status === 'COMPLETED');
        return matchesSearch;
    });
  }, [ptws, filter, search]);

  const stats = useMemo(() => ({
      total: ptws.length,
      active: ptws.filter(p => p.status === 'ACTIVE').length,
      pending: ptws.filter(p => p.status === 'APPROVAL' || p.status === 'SUBMITTED').length,
      highRisk: ptws.filter(p => p.type === 'Hot Work' || p.type === 'Confined Space Entry' || p.type === 'Lifting').length
  }), [ptws]);

  const getProjectName = (id: string) => projects.find(p => p.id === id)?.name || 'Unknown Project';

  return (
    <div className="min-h-screen bg-transparent text-slate-200 p-6">
      
      {/* HEADER */}
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
        <div>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                <FileText className="w-8 h-8 text-blue-400" />
                Permit to Work
            </h1>
            <p className="text-slate-400 mt-1">Manage authorization for high-risk activities.</p>
        </div>
        
        {can('create', 'ptw') && (
            <div className="flex gap-3">
                 <Button variant="secondary" onClick={onAddExistingPtw}>Add Existing</Button>
                 <Button onClick={onCreatePtw} className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white border-0 shadow-lg shadow-blue-900/20">
                    <Plus className="w-5 h-5 mr-2" />
                    New Permit
                </Button>
            </div>
        )}
      </div>

      {/* STATS */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <StatCard label="Active Permits" value={stats.active} color="text-emerald-400" icon={<CheckCircle className="w-6 h-6"/>} />
          <StatCard label="Pending Approval" value={stats.pending} color="text-amber-400" icon={<Clock className="w-6 h-6"/>} />
          <StatCard label="High Risk" value={stats.highRisk} color="text-rose-400" icon={<AlertTriangle className="w-6 h-6"/>} />
          <StatCard label="Total Permits" value={stats.total} color="text-blue-400" icon={<FileText className="w-6 h-6"/>} />
      </div>

      {/* FILTERS */}
      <div className="flex flex-col md:flex-row gap-4 mb-6">
          <div className="flex bg-slate-900/50 p-1 rounded-xl border border-white/10">
              {['All', 'Active', 'Draft', 'Closed'].map(f => (
                  <button
                    key={f}
                    onClick={() => setFilter(f as any)}
                    className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide transition-all ${
                        filter === f 
                        ? 'bg-blue-600 text-white shadow-lg' 
                        : 'text-slate-400 hover:text-white hover:bg-white/5'
                    }`}
                  >
                      {f}
                  </button>
              ))}
          </div>
          <div className="relative flex-1">
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
              <input 
                  type="text" 
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  placeholder="Search by Permit # or Title..." 
                  className="w-full h-full bg-slate-900/50 border border-white/10 rounded-xl pl-10 pr-4 text-sm text-slate-200 focus:border-blue-500/50 focus:outline-none placeholder:text-slate-600"
              />
          </div>
      </div>

      {/* GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredPtws.map((ptw) => {
            const statusConfig = getStatusConfig(ptw.status);
            // SAFE CHECK: Ensure type exists in config
            const typeDetails = ptwTypeDetails[ptw.type] || { icon: '?', hex: '#64748b' };
            const StatusIcon = statusConfig.icon;
            
            return (
                <div key={ptw.id} onClick={() => onSelectPtw(ptw)} className={glassStyles.card}>
                    {/* Color Strip */}
                    <div className="absolute left-0 top-0 bottom-0 w-1" style={{ backgroundColor: typeDetails.hex }} />
                    
                    <div className="p-5 pl-7">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 block mb-1">
                                    {ptw.payload.permit_no || 'DRAFT PERMIT'}
                                </span>
                                <h3 className="font-bold text-slate-100 text-lg line-clamp-1">{ptw.title}</h3>
                            </div>
                            <div className={`${glassStyles.badge} ${statusConfig.bg} ${statusConfig.color} ${statusConfig.border}`}>
                                <StatusIcon className="w-3 h-3" />
                                {statusConfig.label}
                            </div>
                        </div>

                        <div className="flex items-center gap-2 mb-4">
                             <span className="text-2xl">{typeDetails.icon}</span>
                             <span className="text-sm font-medium text-slate-300">{ptw.type}</span>
                        </div>

                        <div className="space-y-2 text-xs text-slate-400 mb-4">
                            <div className="flex items-center gap-2">
                                <MapPin className="w-3.5 h-3.5 text-slate-500" />
                                <span className="truncate">{ptw.payload.work.location}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <UserIcon className="w-3.5 h-3.5 text-slate-500" />
                                <span>{ptw.payload.requester.name}</span>
                            </div>
                             <div className="flex items-center gap-2">
                                <Shield className="w-3.5 h-3.5 text-slate-500" />
                                <span>{getProjectName(ptw.project_id)}</span>
                            </div>
                        </div>

                        <div className="pt-4 border-t border-white/5 flex items-center justify-between text-xs">
                             <div className="flex items-center gap-1.5 text-slate-500">
                                 <Calendar className="w-3.5 h-3.5" />
                                 <span>{new Date(ptw.payload.work.coverage.start_date).toLocaleDateString()}</span>
                             </div>
                             <div className="flex items-center gap-1.5 text-slate-500">
                                 <Clock className="w-3.5 h-3.5" />
                                 <span>{ptw.payload.work.coverage.start_time} - {ptw.payload.work.coverage.end_time}</span>
                             </div>
                        </div>
                    </div>
                </div>
            )
        })}

        {filteredPtws.length === 0 && (
            <div className="col-span-full py-20 text-center border-2 border-dashed border-white/10 rounded-3xl">
                <FileText className="w-12 h-12 text-slate-700 mx-auto mb-3" />
                <h3 className="text-lg font-bold text-slate-400">No Permits Found</h3>
                <p className="text-slate-600 text-sm">Adjust your filters or create a new permit.</p>
            </div>
        )}
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\PtwCreationModal.tsx
==================================================

import React, { useState } from 'react';
import type {
  Ptw,
  PtwType,
  PtwSafetyRequirement,
  CanonicalPtwPayload,
  PtwHotWorkPayload,
  PtwWorkAtHeightPayload,
  PtwConfinedSpacePayload,
  PtwExcavationPayload,
  PtwRoadClosurePayload,
  PtwLiftingPayload
} from '../types';
import { Button } from './ui/Button';
import { ptwTypeDetails, emptySignoff, emptySignature, emptyExtension, emptyClosure, ptwChecklistData } from '../config';
import { useDataContext, useAppContext } from '../contexts';
import { FormField } from './ui/FormField';

// Icons
const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>;
const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;

const GLOBAL_PTW_REQUIREMENTS = {
  mandatoryForAll: [
    "Risk Assessment completed and reviewed",
    "Emergency procedures communicated",
    "Energy isolation procedures defined (LOTO)",
    "Competent personnel identified",
  ],
  globalStandards: ["ISO 45001:2018", "OSHA 29 CFR 1910"]
};

interface PtwCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<Ptw, 'id' | 'org_id' | 'status'>, manualPermitNo?: string) => void;
  mode: 'new' | 'existing';
}

export const PtwCreationModal: React.FC<PtwCreationModalProps> = ({ isOpen, onClose, onSubmit, mode }) => {
    const { projects } = useDataContext();
    const { activeUser } = useAppContext();

    const [step, setStep] = useState(1);
    const [selectedType, setSelectedType] = useState<PtwType | null>(null);
    
    // COMPLIANCE
    const [globalCompliance, setGlobalCompliance] = useState({
      riskAssessmentCompleted: false,
      emergencyProcedures: false,
      energyIsolation: false,
      competentPersonnel: false,
    });
    
    // EVIDENCE
    const [evidenceFiles, setEvidenceFiles] = useState<File[]>([]);

    const [formData, setFormData] = useState({
        manual_permit_no: '',
        project_id: projects[0]?.id || '',
        work_location: '',
        contractor_name: '',
        work_description: '',
        starts_at: new Date().toISOString().slice(0, 16),
        ends_at: new Date(Date.now() + 8 * 60 * 60 * 1000).toISOString().slice(0, 16),
    });

    const [error, setError] = useState('');

    const handleSelectType = (type: PtwType) => {
        setSelectedType(type);
        setStep(2);
    };

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files) {
            setEvidenceFiles(prev => [...prev, ...Array.from(e.target.files!)]);
        }
    };

    const handleRemoveFile = (index: number) => {
        setEvidenceFiles(prev => prev.filter((_, i) => i !== index));
    };

    const resetForm = () => {
        setStep(1);
        setSelectedType(null);
        setError('');
        setEvidenceFiles([]);
        setGlobalCompliance({
            riskAssessmentCompleted: false,
            emergencyProcedures: false,
            energyIsolation: false,
            competentPersonnel: false,
        });
        setFormData({
            manual_permit_no: '',
            project_id: projects[0]?.id || '',
            work_location: '',
            contractor_name: '',
            work_description: '',
            starts_at: new Date().toISOString().slice(0, 16),
            ends_at: new Date(Date.now() + 8 * 60 * 60 * 1000).toISOString().slice(0, 16),
        });
    };

    const handleClose = () => {
        resetForm();
        onClose();
    };
    
    const validateGlobalCompliance = () => {
      return Object.values(globalCompliance).every(val => val === true);
    };
    
    const handleSubmit = () => {
        if (!formData.project_id || !formData.work_location.trim() || !formData.work_description.trim()) {
            setError('Please fill out all required fields.');
            return;
        }

        if (!validateGlobalCompliance()) {
          setError('Please check all Global Compliance boxes to proceed.');
          return;
        }

        if (!selectedType) return;
        
        const checklist: PtwSafetyRequirement[] = (ptwChecklistData[selectedType] || []).map(item => ({
            id: item.id,
            text: item.text,
            response: 'N/A' as const,
        }));
        
        const attachmentData = evidenceFiles.map((file) => ({
            name: file.name,
            url: `https://source.unsplash.com/random/200x200?sig=${Math.random()}` 
        }));

        const basePayload: CanonicalPtwPayload = {
            creator_id: activeUser?.id || 'unknown',
            permit_no: mode === 'new' ? '' : formData.manual_permit_no,
            category: 'standard',
            requester: { 
              name: activeUser?.name || 'Unknown', 
              email: activeUser?.email || '', 
              mobile: '555-0101', 
              designation: activeUser?.role || 'WORKER', 
              contractor: formData.contractor_name || 'Internal', 
              signature: '',
            },
            work: {
                location: formData.work_location,
                description: formData.work_description,
                coverage: { 
                    start_date: formData.starts_at.split('T')[0], 
                    end_date: formData.ends_at.split('T')[0], 
                    start_time: formData.starts_at.split('T')[1], 
                    end_time: formData.ends_at.split('T')[1] 
                },
                associated_permits: [],
            },
            safety_requirements: checklist,
            ppe: { hard_hat: true, safety_shoes: true, safety_harness: false, goggles: false, coverall: false, respirator: false, safety_gloves: false, vest: false },
            signoffs: { client_proponent: emptySignoff, other_stakeholders: [], client_hs: emptySignoff },
            joint_inspection: { remarks: '', requester: emptySignature, client_proponent: emptySignature, client_hs: emptySignature },
            holding_or_stoppage: [],
            extension: emptyExtension,
            closure: emptyClosure,
            attachments: attachmentData,
            audit: [],
            global_compliance: { standards: GLOBAL_PTW_REQUIREMENTS.globalStandards }
        };
        
        let payload: Ptw['payload'] = basePayload;

        // Initialize specific payloads based on type
        if (selectedType === 'Hot Work') {
             payload = { ...basePayload, fire_watcher: { name: '', mobile: '' }, post_watch_minutes: 30 } as PtwHotWorkPayload;
        } else if (selectedType === 'Work at Height') {
             payload = { ...basePayload, access_equipment: {} } as PtwWorkAtHeightPayload;
        } else if (selectedType === 'Confined Space Entry') {
             payload = { ...basePayload, gas_tests: [], entry_log: [] } as PtwConfinedSpacePayload;
        } else if (selectedType === 'Excavation') {
             payload = { ...basePayload, soil_type: 'A', cave_in_protection: [] } as PtwExcavationPayload;
        } else if (selectedType === 'Road Closure') {
             payload = { ...basePayload, closure_type: 'partial' } as PtwRoadClosurePayload;
        } else if (selectedType === 'Lifting') {
             payload = { ...basePayload, load_calculation: { load_weight: 0, crane_capacity: 0, utilization_percent: 0 } } as PtwLiftingPayload;
        }

        const newPtw: Omit<Ptw, 'id' | 'org_id'> = {
            project_id: formData.project_id,
            type: selectedType,
            status: 'DRAFT',
            title: formData.work_description,
            payload: payload,
            updated_at: new Date().toISOString(),
            audit_log: [],
            approvals: []
        }
        
        // @ts-ignore
        onSubmit(newPtw);
        handleClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={handleClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="border-b dark:border-dark-border px-6 py-4 flex justify-between items-center bg-white dark:bg-dark-card sticky top-0 z-10">
                    <div>
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">
                          {mode === 'existing' ? 'Add Existing Permit' : 'Create New Permit'}
                        </h2>
                        <p className="text-sm text-gray-500 dark:text-gray-400">
                          {step === 1 ? 'Step 1: Select Permit Type' : `Step 2: Enter Details for ${selectedType}`}
                        </p>
                    </div>
                    <button onClick={handleClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <CloseIcon className="w-6 h-6" />
                    </button>
                </div>
                
                <div className="p-6 overflow-y-auto">
                    {step === 1 && (
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {(Object.keys(ptwTypeDetails) as (keyof typeof ptwTypeDetails)[]).map(type => {
                                const details = ptwTypeDetails[type];
                                return (
                                    <button
                                        key={type}
                                        onClick={() => handleSelectType(type)}
                                        className="p-4 border border-gray-200 dark:border-gray-700 rounded-lg text-left hover:shadow-lg transition-all flex flex-col justify-between h-32 bg-white dark:bg-dark-background hover:border-blue-500 group"
                                    >
                                        <div className="text-3xl">{details.icon}</div>
                                        <div>
                                            <h3 className="font-bold text-sm text-gray-900 dark:text-white group-hover:text-blue-600">{type}</h3>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    )}

                    {step === 2 && selectedType && (
                        <div className="space-y-6">
                             {/* GLOBAL COMPLIANCE */}
                             <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                                <h3 className="font-bold text-blue-900 dark:text-blue-200 mb-3 flex items-center">
                                    <span className="mr-2">ðŸŒ</span> Mandatory Safety Checks
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {GLOBAL_PTW_REQUIREMENTS.mandatoryForAll.map((req, idx) => (
                                        <label key={idx} className="flex items-center space-x-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={globalCompliance[Object.keys(globalCompliance)[idx] as keyof typeof globalCompliance]}
                                                onChange={(e) => setGlobalCompliance(prev => ({
                                                    ...prev,
                                                    [Object.keys(globalCompliance)[idx] as keyof typeof globalCompliance]: e.target.checked
                                                }))}
                                                className="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4"
                                            />
                                            <span className="text-sm text-gray-700 dark:text-gray-300">{req}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            {/* FORM FIELDS */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <FormField label="Project">
                                    <select value={formData.project_id} onChange={e => setFormData(p => ({...p, project_id: e.target.value}))} className="w-full p-2 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-background text-gray-900 dark:text-white rounded-md shadow-sm">
                                        <option value="">Select Project...</option>
                                        {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                    </select>
                                </FormField>
                                <FormField label="Work Location">
                                    <input type="text" value={formData.work_location} onChange={e => setFormData(p => ({...p, work_location: e.target.value}))} placeholder="e.g., Level 12" className="w-full p-2 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-background text-gray-900 dark:text-white rounded-md shadow-sm" />
                                </FormField>
                                <FormField label="Work Description" fullWidth>
                                    <textarea rows={3} value={formData.work_description} onChange={e => setFormData(p => ({...p, work_description: e.target.value}))} placeholder="Describe work..." className="w-full p-2 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-background text-gray-900 dark:text-white rounded-md shadow-sm"></textarea>
                                </FormField>
                                <FormField label="Start Time">
                                    <input type="datetime-local" value={formData.starts_at} onChange={e => setFormData(p => ({...p, starts_at: e.target.value}))} className="w-full p-2 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-background text-gray-900 dark:text-white rounded-md shadow-sm" />
                                </FormField>
                                <FormField label="End Time">
                                    <input type="datetime-local" value={formData.ends_at} onChange={e => setFormData(p => ({...p, ends_at: e.target.value}))} className="w-full p-2 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-background text-gray-900 dark:text-white rounded-md shadow-sm" />
                                </FormField>
                            </div>

                            {/* EVIDENCE UPLOAD */}
                            <div className="border-t pt-4 dark:border-dark-border">
                                <h4 className="font-bold text-gray-900 dark:text-white mb-2">Attachments / Evidence</h4>
                                <div className="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 relative">
                                     <input 
                                        type="file" 
                                        multiple 
                                        accept="image/*,video/*,.pdf" 
                                        onChange={handleFileChange} 
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    />
                                    <div className="flex flex-col items-center text-gray-500 dark:text-gray-400">
                                        <UploadIcon />
                                        <span className="text-sm mt-1">Upload Photos, JSA, or Diagrams</span>
                                    </div>
                                </div>
                                {evidenceFiles.length > 0 && (
                                    <div className="mt-2 space-y-1">
                                        {evidenceFiles.map((file, i) => (
                                            <div key={i} className="flex justify-between text-xs bg-gray-100 dark:bg-white/10 p-2 rounded">
                                                <span className="truncate text-gray-700 dark:text-gray-300">{file.name}</span>
                                                <button onClick={() => handleRemoveFile(i)} className="text-red-500 font-bold">&times;</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {error && <p className="text-sm text-red-600 font-semibold bg-red-50 p-2 rounded">{error}</p>}
                        </div>
                    )}
                </div>

                {step === 2 && (
                    <div className="bg-gray-100 dark:bg-black/20 px-6 py-4 flex justify-between items-center border-t border-gray-200 dark:border-dark-border sticky bottom-0">
                         <Button variant="secondary" onClick={() => setStep(1)}>Back</Button>
                         <div className="flex gap-2">
                            <Button variant="secondary" onClick={handleClose}>Cancel</Button>
                            <Button 
                              onClick={handleSubmit} 
                              disabled={!validateGlobalCompliance()}
                              className={!validateGlobalCompliance() ? 'opacity-50 cursor-not-allowed' : ''}
                            >
                                {validateGlobalCompliance() ? 'Create Permit' : 'Check Requirements First'}
                            </Button>
                         </div>
                    </div>
                )}
            </div>
        </div>
    );
};

==================================================
FILE: .\src\components\PtwDetailModal.tsx
==================================================

import React, { useState, useEffect } from 'react';
import type { 
  Ptw, User, PtwSafetyRequirement, PtwLiftingPayload, PtwHotWorkPayload, 
  PtwConfinedSpacePayload, PtwWorkAtHeightPayload, PtwSignoff, PtwStoppage 
} from '../types';
import { Button } from './ui/Button';
import { ptwTypeDetails } from '../config';
import { Badge } from './ui/Badge';
import { useAppContext } from '../contexts';
import { WorkAtHeightPermit } from './WorkAtHeightPermit';
import { useToast } from './ui/Toast';
import { ActionsBar } from './ui/ActionsBar';
import { EmailModal } from './ui/EmailModal';
import { LoadCalculationSection } from './LoadCalculationSection';
import { GasTestLogSection } from './GasTestLogSection';
import { PersonnelEntryLogSection } from './PersonnelEntryLogSection';

interface PtwDetailModalProps {
  ptw: Ptw;
  onClose: () => void;
  onUpdate: (ptw: Ptw, action?: 'submit' | 'approve_proponent' | 'approve_hse' | 'reject' | 'request_revision' | 'activate' | 'close' | 'save' | 'suspend' | 'resume') => void;
}

type SectionKey = 'I' | 'II' | 'III' | 'IV' | 'V' | 'VI' | 'VII' | 'VIII' | 'IX';
const sections: { key: SectionKey, title: string }[] = [
    { key: 'I', title: 'General Information'},
    { key: 'II', title: 'Safety Requirement'},
    { key: 'III', title: 'Permit Requester'},
    { key: 'IV', title: 'Client Proponent'},
    { key: 'V', title: 'Client HSE Dept'},
    { key: 'VI', title: 'Joint Site Inspection'},
    { key: 'VII', title: 'Holding/Stoppage'},
    { key: 'VIII', title: 'Extension'},
    { key: 'IX', title: 'Permit Closure'},
];

const ChecklistRow: React.FC<{ index: number; item: PtwSafetyRequirement; onChange: (value: PtwSafetyRequirement) => void; disabled: boolean }> = ({ index, item, onChange, disabled }) => (
    <tr className={`border-b dark:border-dark-border ${disabled ? '' : 'hover:bg-gray-50 dark:hover:bg-dark-background'}`}>
        <td className="p-2 w-8 text-center text-gray-600 dark:text-gray-400">{index}</td>
        <td className="p-2 text-gray-900 dark:text-gray-200">{item.text}</td>
        <td className="p-2 w-16 text-center"><input type="radio" name={`check-${item.id}`} checked={item.response === 'Yes'} onChange={() => onChange({ ...item, response: 'Yes' })} disabled={disabled} className="w-4 h-4 text-blue-600" /></td>
        <td className="p-2 w-16 text-center"><input type="radio" name={`check-${item.id}`} checked={item.response === 'No'} onChange={() => onChange({ ...item, response: 'No' })} disabled={disabled} className="w-4 h-4 text-blue-600" /></td>
        <td className="p-2 w-16 text-center"><input type="radio" name={`check-${item.id}`} checked={item.response === 'N/A'} onChange={() => onChange({ ...item, response: 'N/A' })} disabled={disabled} className="w-4 h-4 text-blue-600" /></td>
    </tr>
);

const WorkflowActions: React.FC<{ onAction: (action: any) => void, onSave: () => void, ptw: Ptw }> = ({ onAction, onSave, ptw }) => {
    const { activeUser, can } = useAppContext();
    const canApprove = can('approve', 'ptw');
    const isCreator = ptw.payload.creator_id === activeUser?.id;
    const selfApprovalBlocked = false; 

    return (
        <div className="flex items-center space-x-2">
            {ptw.status === 'DRAFT' && <Button variant="secondary" onClick={onSave}>Save Draft</Button>}
            {ptw.status === 'DRAFT' && <Button onClick={() => onAction('submit')}>Submit for Review</Button>}
            
            {ptw.status === 'SUBMITTED' && canApprove && (
                <>
                    <Button variant="secondary" onClick={() => onAction('request_revision')}>Request Revision</Button>
                    <Button onClick={() => onAction('approve_proponent')} disabled={selfApprovalBlocked}>Approve (Proponent)</Button>
                </>
            )}
            
            {ptw.status === 'APPROVAL' && canApprove && (
                 <>
                    <Button variant="secondary" onClick={() => onAction('request_revision')}>Request Revision</Button>
                    <Button variant="danger" onClick={() => onAction('reject')}>Reject</Button>
                    <Button onClick={() => onAction('approve_hse')}>Approve (HSE)</Button>
                </>
            )}

            {ptw.status === 'ACTIVE' && canApprove && <Button variant="danger" onClick={() => onAction('suspend')}>Suspend Permit</Button>}
            {ptw.status === 'HOLD' && canApprove && <Button onClick={() => onAction('resume')}>Resume Work</Button>}
            {(ptw.status === 'ACTIVE' || ptw.status === 'HOLD') && <Button onClick={() => onAction('close')}>Close Permit</Button>}
        </div>
    )
}

const InfoField: React.FC<{label: string, value: React.ReactNode}> = ({label, value}) => (
    <div className="border-b py-2 dark:border-dark-border">
        <span className="font-semibold text-gray-600 dark:text-gray-400">{label}:</span>
        <span className="ml-2 text-gray-800 dark:text-gray-200">{value}</span>
    </div>
)

const FormInput: React.FC<{ label: string, value: any, onChange: (val: any) => void, type?: string, required?: boolean, disabled?: boolean }> = ({ label, value, onChange, type = 'text', required = false, disabled = false }) => (
    <div>
        <label className="block font-medium text-gray-700 dark:text-gray-300 text-sm">{label}</label>
        <input
            type={type}
            value={value || ''}
            onChange={e => onChange(e.target.value)}
            className="mt-1 w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-gray-100 text-sm read-only:bg-gray-100 dark:read-only:bg-white/5"
            required={required}
            readOnly={disabled}
        />
    </div>
);

const SignatureInput: React.FC<{ label: string, value: any, onChange: (val: any) => void, disabled?: boolean }> = ({ label, value, onChange, disabled = false }) => (
    <div>
        <label className="block font-medium text-gray-700 dark:text-gray-300 text-sm">{label}</label>
        <input
            type="text"
            value={value || ''}
            onChange={e => onChange(e.target.value)}
            className="mt-1 w-full p-2 border border-gray-300 dark:border-dark-border rounded-md font-serif text-lg bg-white dark:bg-dark-background text-blue-800 dark:text-blue-200 read-only:bg-gray-100 dark:read-only:bg-white/5"
            placeholder={disabled ? "Signed" : "Type name to sign"}
            readOnly={disabled}
        />
    </div>
);

export const PtwDetailModal: React.FC<PtwDetailModalProps> = (props) => {
  const { ptw, onClose, onUpdate } = props;
  const [formData, setFormData] = useState<Ptw>(JSON.parse(JSON.stringify(ptw)));
  const [activeSection, setActiveSection] = useState<SectionKey>('I');
  const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);
  const toast = useToast();
  
  const [stoppageFormData, setStoppageFormData] = useState<Partial<PtwStoppage>>({ reason: '', stopped_by: '', informed_to: '' });
  
  const isEditable = formData.status === 'DRAFT';
  const isProponentEditable = formData.status === 'SUBMITTED';
  const isHseEditable = formData.status === 'APPROVAL';
  const isInspectionEditable = formData.status === 'APPROVAL' || formData.status === 'ACTIVE';
  const isStoppageEditable = formData.status === 'ACTIVE' || formData.status === 'HOLD';
  const isExtensionEditable = formData.status === 'ACTIVE';
  const isClosureEditable = formData.status === 'ACTIVE' || formData.status === 'HOLD';

  useEffect(() => {
      setFormData(JSON.parse(JSON.stringify(ptw)));
  }, [ptw]);

  const handlePayloadChange = (path: string, value: any) => {
    setFormData(prev => {
        const keys = path.split('.');
        const newPayload = JSON.parse(JSON.stringify(prev.payload));
        let current: any = newPayload;
        for (let i = 0; i < keys.length - 1; i++) {
            if (!current[keys[i]]) current[keys[i]] = {};
            current = current[keys[i]];
        }
        current[keys[keys.length - 1]] = value;

        if (path.endsWith('.signature') && value) {
            const pathPrefix = path.substring(0, path.lastIndexOf('.'));
            const signedAtPath = `${pathPrefix}.signed_at`;
            let signedAtTarget: any = newPayload;
            const signedAtKeys = signedAtPath.split('.');
            try {
                for (let i = 0; i < signedAtKeys.length - 1; i++) {
                    signedAtTarget = signedAtTarget[signedAtKeys[i]];
                }
                if (signedAtTarget) {
                    signedAtTarget[signedAtKeys[signedAtKeys.length - 1]] = new Date().toISOString();
                }
            } catch (e) { console.error("Could not set signed_at date", e)}
        }

        return { ...prev, payload: newPayload };
    });
  };

  const handleChecklistChange = (updatedItem: PtwSafetyRequirement) => {
      setFormData(prev => {
          const newSafetyRequirements = prev.payload.safety_requirements.map(item => 
              item.id === updatedItem.id ? updatedItem : item
          );
          return { ...prev, payload: { ...prev.payload, safety_requirements: newSafetyRequirements } } as Ptw;
      });
  }
  
  const handleLogStoppage = () => {
    const newStoppage: PtwStoppage = {
        ...stoppageFormData,
        time: new Date().toISOString(),
        restarted_time: '',
        signature: '',
    } as PtwStoppage;

    const updatedFormData = {
        ...formData,
        payload: {
            ...formData.payload,
            holding_or_stoppage: [...(formData.payload.holding_or_stoppage || []), newStoppage]
        }
    };
    setFormData(updatedFormData);
    onUpdate(updatedFormData, 'suspend');
    setStoppageFormData({ reason: '', stopped_by: '', informed_to: '' });
  };
  
  const handleResumeWork = (signature: string) => {
      const updatedFormData = { ...formData };
      if (!updatedFormData.payload.holding_or_stoppage) {
          updatedFormData.payload.holding_or_stoppage = [];
      }
      const lastStoppageIndex = updatedFormData.payload.holding_or_stoppage.length - 1;
      if (lastStoppageIndex >= 0) {
          updatedFormData.payload.holding_or_stoppage[lastStoppageIndex].restarted_time = new Date().toISOString();
          updatedFormData.payload.holding_or_stoppage[lastStoppageIndex].signature = signature;
      }
      setFormData(updatedFormData);
      onUpdate(updatedFormData, 'resume');
  }

  const handleRequestExtension = () => {
      const updatedFormData = { ...formData };
      if (!updatedFormData.payload.extension) {
          updatedFormData.payload.extension = { is_requested: true, reason: '', days: { from: '', to: '' }, hours: { from: '', to: '' }, requester: { signature: '', signed_at: '' }, client_proponent: { signature: '', signed_at: '' }, client_hs: { signature: '', signed_at: '' } };
      } else {
          updatedFormData.payload.extension.is_requested = true;
      }
      setFormData(updatedFormData);
      onUpdate(updatedFormData, 'save');
  };
  
  const handleWorkflowAction = (action: any) => {
        if (!action) return;
        onUpdate(formData, action);
  };

  const renderSectionContent = () => {
    switch(activeSection) {
        case 'I':
            return (
                <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <InfoField label="Permit Type" value={formData.type} />
                        <InfoField label="Permit Status" value={
                            <Badge color={
                                formData.status === 'ACTIVE' ? 'green' : 
                                formData.status === 'HOLD' ? 'red' :
                                formData.status === 'APPROVAL' ? 'blue' :
                                'gray'
                            }>
                                {formData.status.replace(/_/g, ' ')}
                            </Badge>
                        } />
                        <InfoField label="Permit Number" value={formData.payload.permit_no || 'Draft'} />
                        <InfoField label="Project" value={formData.project_id} />
                        <InfoField label="Work Location" value={formData.payload.work.location} />
                        <InfoField label="Number of Workers" value={formData.payload.work.number_of_workers || 'Not specified'} />
                    </div>
                    
                    <div className="mt-4">
                        <h4 className="font-bold text-gray-800 dark:text-gray-200 mb-2">Work Description</h4>
                        <p className="text-gray-700 dark:text-gray-300 p-3 bg-gray-50 dark:bg-gray-900/30 rounded">
                            {formData.payload.work.description}
                        </p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <InfoField label="Start Time" value={`${formData.payload.work.coverage.start_date} ${formData.payload.work.coverage.start_time}`} />
                        <InfoField label="End Time" value={`${formData.payload.work.coverage.end_date} ${formData.payload.work.coverage.end_time}`} />
                        <InfoField label="Risk Assessment Ref" value={formData.payload.work.risk_assessment_ref || 'Not provided'} />
                        <InfoField label="Emergency Contact" value={formData.payload.work.emergency_contact || 'Not provided'} />
                    </div>
                </div>
            );
            
        case 'II':
            const isChecklistDisabled = !isEditable;
            return (
                <div className="space-y-6">
                    {formData.type === 'Lifting' && 'load_calculation' in formData.payload && (
                        <LoadCalculationSection 
                            // FIX: Cast to any to bypass strict optional check
                            loadCalc={formData.payload.load_calculation as any}
                            onChange={(calc) => handlePayloadChange('load_calculation', calc)}
                            disabled={!isEditable}
                        />
                    )}
                    
                    {formData.type === 'Confined Space Entry' && 'gas_tests' in formData.payload && (
                        <GasTestLogSection 
                            gasTests={formData.payload.gas_tests}
                            onChange={(tests) => handlePayloadChange('gas_tests', tests)}
                            disabled={!isEditable}
                        />
                    )}
                    
                    {formData.type === 'Confined Space Entry' && 'entry_log' in formData.payload && (
                        <PersonnelEntryLogSection 
                            entries={formData.payload.entry_log}
                            onChange={(entries) => handlePayloadChange('entry_log', entries)}
                            disabled={!isEditable}
                        />
                    )}
                    
                    {formData.type === 'Work at Height' && 'access_equipment' in formData.payload && (
                        <WorkAtHeightPermit 
                            payload={formData.payload as PtwWorkAtHeightPayload}
                            onChange={(updatedPayload) => setFormData(prev => ({ ...prev, payload: updatedPayload } as Ptw))}
                            readOnly={!isEditable}
                        />
                    )}
                    
                    <div className="border rounded-lg overflow-hidden">
                        <div className="bg-gray-100 dark:bg-gray-800 p-3 border-b">
                            <h4 className="font-bold text-gray-800 dark:text-gray-200">Safety Requirements Checklist</h4>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50 dark:bg-gray-900">
                                    <tr className="border-b dark:border-dark-border text-gray-700 dark:text-gray-300">
                                        <th className="p-3 w-8">#</th>
                                        <th className="p-3 text-left">Requirement</th>
                                        <th className="p-3 w-16 text-center">Yes</th>
                                        <th className="p-3 w-16 text-center">No</th>
                                        <th className="p-3 w-16 text-center">N/A</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {formData.payload.safety_requirements.map((item, index) => (
                                        <ChecklistRow 
                                            key={item.id}
                                            index={index + 1}
                                            item={item}
                                            onChange={handleChecklistChange}
                                            disabled={isChecklistDisabled}
                                        />
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div className="border rounded-lg p-4">
                        <h4 className="font-bold mb-3 text-base text-gray-800 dark:text-gray-200">Personal Protective Equipment (PPE)</h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {Object.entries(formData.payload.ppe || {}).map(([key, value]) => (
                                <label key={key} className="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        checked={!!value}
                                        onChange={(e) => handlePayloadChange(`ppe.${key}`, e.target.checked)}
                                        disabled={!isEditable}
                                        className="rounded"
                                    />
                                    <span className="text-sm capitalize">{key.replace(/_/g, ' ')}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>
            );
            
        case 'III':
            return (
                <div className="space-y-6">
                    <div className="border rounded-lg p-4">
                        <h3 className="text-base font-semibold mb-4 text-gray-800 dark:text-gray-200">Section III â€” Permit Requester Confirmation</h3>
                        <div className="p-4 border rounded-md bg-gray-50 dark:bg-dark-background mb-6">
                            <p className="text-sm italic text-gray-700 dark:text-gray-300">
                                "I hereby confirm that I have personally inspected the worksite and verified that all required precautionary measures and safety controls described in this permit have been fully implemented."
                            </p>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <h4 className="font-bold text-gray-800 dark:text-gray-200 border-b dark:border-dark-border pb-1 mb-3">Permit Holder Information</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <FormInput label="Permit Holder Name" value={formData.payload.requester.name} 
                                        onChange={val => handlePayloadChange('requester.name', val)} required disabled={!isEditable} />
                                    <FormInput label="Designation" value={formData.payload.requester.designation} 
                                        onChange={val => handlePayloadChange('requester.designation', val)} required disabled={!isEditable} />
                                    <FormInput label="Contractor Company" value={formData.payload.requester.contractor} 
                                        onChange={val => handlePayloadChange('requester.contractor', val)} required disabled={!isEditable} />
                                    <FormInput label="Email" type="email" value={formData.payload.requester.email} 
                                        onChange={val => handlePayloadChange('requester.email', val)} required disabled={!isEditable} />
                                    <FormInput label="Mobile No." type="tel" value={formData.payload.requester.mobile} 
                                        onChange={val => handlePayloadChange('requester.mobile', val)} required disabled={!isEditable} />
                                    <div className="md:col-span-2">
                                        <SignatureInput label="Signature" value={formData.payload.requester.signature} 
                                            onChange={val => handlePayloadChange('requester.signature', val)} disabled={!isEditable} />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

        case 'IV':
             return (
                <div>
                    <h3 className="text-base font-semibold mb-4 text-gray-800 dark:text-gray-200">Section IV â€“ Client Proponent / Stakeholder</h3>
                    <div className="space-y-8">
                        <div>
                            <h4 className="font-bold text-gray-800 dark:text-gray-200 border-b dark:border-dark-border pb-1 mb-3">Client Proponent (Primary Reviewer)</h4>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <FormInput label="Name" value={formData.payload.signoffs?.client_proponent.name} onChange={val => handlePayloadChange('signoffs.client_proponent.name', val)} required disabled={!isProponentEditable} />
                                <FormInput label="Designation" value={formData.payload.signoffs?.client_proponent.designation} onChange={val => handlePayloadChange('signoffs.client_proponent.designation', val)} required disabled={!isProponentEditable} />
                                <FormInput label="Email" type="email" value={formData.payload.signoffs?.client_proponent.email} onChange={val => handlePayloadChange('signoffs.client_proponent.email', val)} required disabled={!isProponentEditable} />
                                <FormInput label="Mobile No." type="tel" value={formData.payload.signoffs?.client_proponent.mobile} onChange={val => handlePayloadChange('signoffs.client_proponent.mobile', val)} required disabled={!isProponentEditable} />
                                <div className="col-span-2">
                                    <FormInput label="Remarks" value={formData.payload.signoffs?.client_proponent.remarks} onChange={val => handlePayloadChange('signoffs.client_proponent.remarks', val)} disabled={!isProponentEditable} />
                                </div>
                                <div className="col-span-2">
                                    <SignatureInput label="Signature" value={formData.payload.signoffs?.client_proponent.signature} onChange={val => handlePayloadChange('signoffs.client_proponent.signature', val)} disabled={!isProponentEditable} />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

        case 'V':
            return (
                 <div>
                    <h3 className="text-base font-semibold mb-4 text-gray-800 dark:text-gray-200">Section V â€“ Client HSE Department</h3>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                        <FormInput label="HSE Representative Name" value={formData.payload.signoffs?.client_hs.name} onChange={val => handlePayloadChange('signoffs.client_hs.name', val)} required disabled={!isHseEditable} />
                        <FormInput label="Designation" value={formData.payload.signoffs?.client_hs.designation} onChange={val => handlePayloadChange('signoffs.client_hs.designation', val)} disabled={!isHseEditable} />
                        <FormInput label="Email" type="email" value={formData.payload.signoffs?.client_hs.email} onChange={val => handlePayloadChange('signoffs.client_hs.email', val)} disabled={!isHseEditable} />
                        <FormInput label="Mobile No." type="tel" value={formData.payload.signoffs?.client_hs.mobile} onChange={val => handlePayloadChange('signoffs.client_hs.mobile', val)} disabled={!isHseEditable} />
                        <div className="col-span-2">
                             <FormInput label="Remarks" value={formData.payload.signoffs?.client_hs.remarks} onChange={val => handlePayloadChange('signoffs.client_hs.remarks', val)} disabled={!isHseEditable} />
                        </div>
                        <div className="col-span-2">
                            <SignatureInput label="Signature" value={formData.payload.signoffs?.client_hs.signature} onChange={val => handlePayloadChange('signoffs.client_hs.signature', val)} disabled={!isHseEditable} />
                        </div>
                    </div>
                </div>
            );

        case 'VI':
            return (
                <div>
                    <h3 className="text-base font-semibold mb-2 text-gray-800 dark:text-gray-200">Section VI â€” Joint Site Inspection</h3>
                    <div className="p-4 border rounded-md bg-gray-50 dark:bg-dark-background mb-6">
                        <p className="text-sm italic text-gray-700 dark:text-gray-300">â€œThe work area has been jointly inspected by all parties, and all safety requirements specified in Section II have been implemented and verified. The permit is now authorized for activation.â€</p>
                    </div>
                    <div className="space-y-6">
                        <FormInput label="Remarks" value={formData.payload.joint_inspection?.remarks} onChange={val => handlePayloadChange('joint_inspection.remarks', val)} disabled={!isInspectionEditable} />
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <SignatureInput label="Permit Requester" value={formData.payload.joint_inspection?.requester.signature} onChange={val => handlePayloadChange('joint_inspection.requester.signature', val)} disabled={!isInspectionEditable} />
                            <SignatureInput label="Client Proponent" value={formData.payload.joint_inspection?.client_proponent.signature} onChange={val => handlePayloadChange('joint_inspection.client_proponent.signature', val)} disabled={!isInspectionEditable} />
                            <SignatureInput label="Client HSE" value={formData.payload.joint_inspection?.client_hs.signature} onChange={val => handlePayloadChange('joint_inspection.client_hs.signature', val)} disabled={!isInspectionEditable} />
                        </div>
                    </div>
                </div>
            );

        case 'VII':
            return (
                <div>
                    <h3 className="text-base font-semibold mb-4 text-gray-800 dark:text-gray-200">Section VII â€“ Holding / Stoppage of Work</h3>
                    <div className="space-y-4">
                        {formData.payload.holding_or_stoppage?.map((stoppage, index) => (
                            <div key={index} className="p-4 border rounded-md dark:border-dark-border text-gray-800 dark:text-gray-200">
                                <p className="font-bold">Stoppage #{index+1} at {new Date(stoppage.time).toLocaleString()}</p>
                                <p><strong>Reason:</strong> {stoppage.reason}</p>
                                <p><strong>Stopped By:</strong> {stoppage.stopped_by}</p>
                                <p><strong>Informed To:</strong> {stoppage.informed_to}</p>
                                {stoppage.restarted_time ? (
                                    <div className="mt-2 pt-2 border-t dark:border-dark-border">
                                        <p className="text-green-600 font-semibold">Resumed at {new Date(stoppage.restarted_time).toLocaleString()}</p>
                                        <p><strong>Signed by:</strong> {stoppage.signature}</p>
                                    </div>
                                ) : (
                                     <div className="mt-4">
                                        {formData.status === 'HOLD' && (
                                            <div className="flex items-center space-x-2">
                                                <input type="text" placeholder="Your Name for Signature" className="w-full p-2 border rounded-md text-sm bg-white dark:bg-dark-background dark:border-dark-border text-gray-900 dark:text-white" onChange={e => {
                                                    const updatedStoppage = {...stoppage, signature: e.target.value};
                                                    const newStoppages = [...(formData.payload.holding_or_stoppage || [])];
                                                    newStoppages[index] = updatedStoppage;
                                                    setFormData(prev => ({...prev, payload: {...prev.payload, holding_or_stoppage: newStoppages}}))
                                                }} />
                                                <Button size="sm" onClick={() => handleResumeWork(stoppage.signature)}>Resume Work</Button>
                                            </div>
                                        )}
                                     </div>
                                )}
                            </div>
                        ))}
                        {(formData.payload.holding_or_stoppage?.length ?? 0) === 0 && <p className="text-sm text-gray-500 dark:text-gray-400">No work stoppages have been logged.</p>}
                    </div>

                    {isStoppageEditable && formData.status !== 'HOLD' && (
                        <div className="mt-6 border-t pt-4 dark:border-dark-border">
                            <h4 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">Log a New Work Stoppage</h4>
                             <div className="grid grid-cols-2 gap-4">
                                <FormInput label="Reason" value={stoppageFormData.reason} onChange={val => setStoppageFormData(p => ({...p, reason: val}))} />
                                <FormInput label="Stopped By" value={stoppageFormData.stopped_by} onChange={val => setStoppageFormData(p => ({...p, stopped_by: val}))} />
                                <div className="col-span-2"><FormInput label="Informed To" value={stoppageFormData.informed_to} onChange={val => setStoppageFormData(p => ({...p, informed_to: val}))} /></div>
                            </div>
                            <Button className="mt-4" variant="danger" onClick={handleLogStoppage}>Log Stoppage & Suspend Permit</Button>
                        </div>
                    )}
                </div>
            );

        case 'VIII':
            return (
                <div>
                    <h3 className="text-base font-semibold mb-4 text-gray-800 dark:text-gray-200">Section VIII â€“ Extension</h3>
                    {!formData.payload.extension?.is_requested && isExtensionEditable && (
                        <div className="text-center p-8 border-2 border-dashed rounded-lg dark:border-dark-border">
                            <p className="text-gray-600 dark:text-gray-400">No extension has been requested for this permit.</p>
                            <Button className="mt-4" onClick={handleRequestExtension}>Request Extension</Button>
                        </div>
                    )}
                    {formData.payload.extension?.is_requested && (
                        <div className="space-y-6">
                            <FormInput label="Reason for Extension" value={formData.payload.extension.reason} onChange={val => handlePayloadChange('extension.reason', val)} disabled={!isExtensionEditable} />
                            <div className="grid grid-cols-2 gap-4">
                                <FormInput label="New From Date/Time" type="datetime-local" value={formData.payload.extension.days.from} onChange={val => handlePayloadChange('extension.days.from', val)} disabled={!isExtensionEditable} />
                                <FormInput label="New To Date/Time" type="datetime-local" value={formData.payload.extension.hours.to} onChange={val => handlePayloadChange('extension.hours.to', val)} disabled={!isExtensionEditable} />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                                <SignatureInput label="Requester" value={formData.payload.extension.requester.signature} onChange={val => handlePayloadChange('extension.requester.signature', val)} disabled={!isExtensionEditable} />
                                <SignatureInput label="Client Proponent" value={formData.payload.extension.client_proponent.signature} onChange={val => handlePayloadChange('extension.client_proponent.signature', val)} disabled={!isExtensionEditable} />
                                <SignatureInput label="Client HSE" value={formData.payload.extension.client_hs.signature} onChange={val => handlePayloadChange('extension.client_hs.signature', val)} disabled={!isExtensionEditable} />
                            </div>
                        </div>
                    )}
                </div>
            );

        case 'IX':
            return (
                 <div>
                    <h3 className="text-base font-semibold mb-2 text-gray-800 dark:text-gray-200">Section IX â€“ Permit Closure</h3>
                    <div className="p-4 border rounded-md bg-gray-50 dark:bg-dark-background mb-6">
                        <p className="text-sm italic text-gray-700 dark:text-gray-300">â€œWe confirm the work is complete, the area is clean and safe, all isolations have been removed, and the permit is now closed.â€</p>
                    </div>
                    <FormInput label="Closure Note / Handover" value={formData.payload.closure?.note} onChange={val => handlePayloadChange('closure.note', val)} disabled={!isClosureEditable} />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                         <SignatureInput label="Requester Closure Sign" value={formData.payload.closure?.permit_requester.signature} onChange={val => handlePayloadChange('closure.permit_requester.signature', val)} disabled={!isClosureEditable} />
                         <SignatureInput label="Proponent Closure Sign" value={formData.payload.closure?.client_proponent.signature} onChange={val => handlePayloadChange('closure.client_proponent.signature', val)} disabled={!isClosureEditable} />
                         <SignatureInput label="HSE Closure Sign" value={formData.payload.closure?.client_hs.signature} onChange={val => handlePayloadChange('closure.client_hs.signature', val)} disabled={!isClosureEditable} />
                    </div>
                </div>
            );
        default:
            return null;
    }
  };

  return (
    <>
      <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4 print:hidden" onClick={onClose} aria-modal="true" role="dialog" aria-labelledby="ptw-title">
        <div id="ptw-printable-area" className="bg-white dark:bg-dark-card rounded-lg shadow-2xl w-full max-w-7xl h-[95vh] flex flex-col" onClick={e => e.stopPropagation()}>
          <header className="p-4 border-b dark:border-dark-border flex justify-between items-center flex-shrink-0 print:hidden">
            <div>
              <h2 id="ptw-title" className="text-xl font-bold text-gray-900 dark:text-gray-100">{ptw.type} - {ptw.payload.permit_no || `Draft #${ptw.id.slice(-6)}`}</h2>
              <div className="flex items-center space-x-2">
                <Badge color={
                    ptw.status === 'ACTIVE' ? 'green' : 
                    ptw.status.includes('SUBMITTED') ? 'yellow' : 
                    ptw.status === 'APPROVAL' ? 'blue' : 
                    'gray'
                }>
                    {ptw.status.replace(/_/g, ' ')}
                </Badge>
                {ptw.compliance_level && (
                    <span className="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
                        <span className="text-yellow-500">âš ï¸</span> {ptw.compliance_level} Compliance
                    </span>
                )}
              </div>
            </div>
            <div className="flex items-center gap-4">
              <ActionsBar onPrint={() => window.print()} onEmail={() => setIsEmailModalOpen(true)} downloadOptions={[{ label: 'Download PDF', handler: () => window.print() }]} />
              <button onClick={onClose} aria-label="Close modal" className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><CloseIcon className="w-6 h-6" /></button>
            </div>
          </header>

          <div className="flex-grow flex overflow-hidden">
            <nav className="w-64 bg-gray-50 dark:bg-dark-background border-r dark:border-dark-border overflow-y-auto p-4 flex-shrink-0 print:hidden">
              <h3 className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2 px-2">SECTIONS</h3>
              <ul className="space-y-1">
                {sections.map(section => (
                  <li key={section.key}>
                    <button
                      onClick={() => setActiveSection(section.key)}
                      className={`w-full text-left p-3 rounded-md text-sm font-medium transition-colors ${
                        activeSection === section.key 
                          ? 'bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300 border-l-4 border-primary-500' 
                          : 'hover:bg-gray-100 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300 border-l-4 border-transparent'
                      }`}
                    >
                      {section.key}. {section.title}
                    </button>
                  </li>
                ))}
              </ul>
            </nav>

            <main className="flex-1 p-8 overflow-y-auto">
              {renderSectionContent()}
            </main>
          </div>

          <footer className="p-4 border-t bg-gray-100 dark:bg-black/20 dark:border-dark-border flex justify-end items-center flex-shrink-0 print:hidden">
            <WorkflowActions onAction={handleWorkflowAction} onSave={() => onUpdate(formData, 'save')} ptw={formData} />
          </footer>
        </div>
      </div>

      <EmailModal 
        isOpen={isEmailModalOpen}
        onClose={() => setIsEmailModalOpen(false)}
        documentTitle={`PTW: ${ptw.payload.permit_no || ptw.id}`}
        documentLink={`${window.location.href}?ptw=${ptw.id}`}
        defaultRecipients={[...Object.values(ptw.payload.signoffs ?? {}).flat(), ptw.payload.requester, ptw.payload.contractor_safety_personnel].filter(Boolean) as Partial<User>[]}
      />

      <style>{`
          @media print {
              body * { visibility: hidden; }
              #ptw-printable-area, #ptw-printable-area * { visibility: visible; }
              #ptw-printable-area { position: absolute; left: 0; top: 0; width: 100%; height: auto; max-height: none; }
              @page { size: A4; margin: 1.5cm; }
          }
      `}</style>
    </>
  );
};

const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;

==================================================
FILE: .\src\components\Rams.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Rams as RamsType, RamsStatus } from '../types';
import { Button } from './ui/Button';
import { useDataContext, useAppContext } from '../contexts';
import { 
  Plus, Search, FileText, 
  ShieldAlert, CheckCircle, Clock, 
  Calendar, User as UserIcon,
  ArrowUpRight, Layers
} from 'lucide-react';

// === GEN 4 STYLES ===
const glassStyles = {
  card: "bg-slate-900/60 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden transition-all duration-300 hover:scale-[1.01] hover:border-cyan-500/30 group relative",
  badge: "px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border flex items-center gap-1",
  filterBtn: "px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border transition-all duration-300"
};

const getStatusConfig = (status: RamsStatus) => {
    switch (status) {
      case 'published': return { label: 'PUBLISHED', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', icon: CheckCircle };
      case 'approved': return { label: 'APPROVED', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20', icon: CheckCircle };
      case 'under_review': return { label: 'IN REVIEW', color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20', icon: Clock };
      case 'archived': return { label: 'ARCHIVED', color: 'text-slate-500', bg: 'bg-slate-500/10', border: 'border-slate-500/20', icon: FileText };
      default: return { label: 'DRAFT', color: 'text-slate-400', bg: 'bg-slate-500/5', border: 'border-slate-500/10', icon: FileText };
    }
};

const getRiskColor = (riskScore: number) => {
    if (riskScore >= 15) return { label: 'CRITICAL', color: 'text-rose-500', bg: 'bg-rose-500/20', border: 'border-rose-500/30' };
    if (riskScore >= 9) return { label: 'HIGH', color: 'text-orange-500', bg: 'bg-orange-500/20', border: 'border-orange-500/30' };
    if (riskScore >= 4) return { label: 'MEDIUM', color: 'text-yellow-500', bg: 'bg-yellow-500/20', border: 'border-yellow-500/30' };
    return { label: 'LOW', color: 'text-emerald-500', bg: 'bg-emerald-500/20', border: 'border-emerald-500/30' };
};

const RamsCard: React.FC<{ rams: RamsType; onSelect: (rams: RamsType) => void }> = ({ rams, onSelect }) => {
  const status = getStatusConfig(rams.status);
  const risk = getRiskColor(rams.overall_risk_after);

  return (
    <div onClick={() => onSelect(rams)} className={glassStyles.card}>
      {/* Risk Indicator Strip */}
      <div className={`absolute left-0 top-0 bottom-0 w-1 ${risk.bg.replace('/20', '')}`} />

      <div className="p-5 pl-7">
        <div className="flex justify-between items-start mb-4">
          <div className="flex items-center gap-3">
             <div className="p-2 rounded-lg bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">
                 <Layers className="w-5 h-5" />
             </div>
             <div>
                 <h3 className="font-bold text-slate-100 text-sm line-clamp-1">{rams.activity}</h3>
                 <span className="text-[10px] text-slate-500 font-mono">v{rams.version}</span>
             </div>
          </div>
          <div className={`${glassStyles.badge} ${status.bg} ${status.color} ${status.border}`}>
             <status.icon className="w-3 h-3" />
             {status.label}
          </div>
        </div>

        <div className="flex items-center gap-4 mb-4">
             <div className="flex-1 p-2 rounded-lg bg-black/20 border border-white/5 flex flex-col items-center">
                 <span className="text-[10px] text-slate-500 uppercase">Initial Risk</span>
                 <span className="text-lg font-bold text-slate-300">{rams.overall_risk_before}</span>
             </div>
             <div className={`flex-1 p-2 rounded-lg border flex flex-col items-center ${risk.bg} ${risk.border}`}>
                 <span className={`text-[10px] uppercase font-bold ${risk.color}`}>Residual Risk</span>
                 <span className={`text-lg font-bold ${risk.color}`}>{rams.overall_risk_after}</span>
             </div>
        </div>

        <div className="space-y-2 text-xs text-slate-500 mb-4">
            <div className="flex items-center gap-2">
                <MapPinIcon className="w-3.5 h-3.5" />
                <span className="truncate">{rams.location}</span>
            </div>
             <div className="flex items-center gap-2">
                <UserIcon className="w-3.5 h-3.5" />
                <span>{rams.prepared_by.name}</span>
            </div>
        </div>

        <div className="pt-3 border-t border-white/5 flex justify-between items-center">
             <div className="flex items-center gap-1.5 text-[10px] text-slate-500">
                <Calendar className="w-3 h-3" />
                Valid: {new Date(rams.times.valid_until).toLocaleDateString()}
             </div>
             <button className="p-1.5 rounded-lg hover:bg-white/10 text-cyan-400 transition-colors">
                 <ArrowUpRight className="w-4 h-4" />
             </button>
        </div>
      </div>
    </div>
  );
};

const FilterChip: React.FC<{label: string, active: boolean, onClick: () => void}> = ({ label, active, onClick }) => (
    <button
        onClick={onClick}
        className={`${glassStyles.filterBtn} ${
            active 
            ? 'bg-indigo-500/20 text-indigo-300 border-indigo-500/50 shadow-[0_0_15px_rgba(99,102,241,0.2)]' 
            : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10 hover:text-slate-200'
        }`}
    >
        {label}
    </button>
)

export const Rams: React.FC<{ onSelectRams: (r: RamsType) => void, onNewRams: () => void }> = ({ onSelectRams, onNewRams }) => {
  const { ramsList } = useDataContext();
  const { can } = useAppContext();
  const [statusFilter, setStatusFilter] = useState<RamsStatus | 'All'>('All');
  const [search, setSearch] = useState('');

  const filteredRams = useMemo(() => {
    return ramsList.filter(r => {
      const statusMatch = statusFilter === 'All' || r.status === statusFilter;
      const searchMatch = !search || r.activity.toLowerCase().includes(search.toLowerCase());
      return statusMatch && searchMatch;
    });
  }, [ramsList, statusFilter, search]);

  return (
    <div className="min-h-screen bg-transparent text-slate-200 p-6">
      
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
        <div>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                <ShieldAlert className="w-8 h-8 text-indigo-400" />
                Risk Assessments (RAMS)
            </h1>
            <p className="text-slate-400 mt-1">Method statements and hazard controls.</p>
        </div>
        
        {can('create', 'rams') && (
            <Button onClick={onNewRams} className="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg shadow-indigo-900/20 border-0">
                <Plus className="w-5 h-5 mr-2" />
                New RAMS
            </Button>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
          <div className="lg:col-span-3 space-y-4">
              <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                  <FilterChip label="All" active={statusFilter === 'All'} onClick={() => setStatusFilter('All')} />
                  {['draft', 'under_review', 'approved', 'published'].map(s => (
                      <FilterChip key={s} label={s.replace('_', ' ')} active={statusFilter === s} onClick={() => setStatusFilter(s as any)} />
                  ))}
              </div>
              <div className="relative">
                  <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" />
                  <input 
                      type="text" 
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                      placeholder="Search RAMS by activity or location..." 
                      className="w-full bg-slate-900/50 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-indigo-500/50 transition-all"
                  />
              </div>
          </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {filteredRams.map((ram) => (
          <RamsCard key={ram.id} rams={ram} onSelect={onSelectRams} />
        ))}
         {filteredRams.length === 0 && (
            <div className="col-span-full py-20 text-center border-2 border-dashed border-white/10 rounded-3xl">
                <FileText className="w-16 h-16 text-slate-700 mx-auto mb-3" />
                <h3 className="text-xl font-bold text-slate-400 mb-2">No RAMS Found</h3>
                <p className="text-slate-600">Create a new assessment to get started.</p>
            </div>
        )}
      </div>
    </div>
  );
};

const MapPinIcon = (props: any) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>;

==================================================
FILE: .\src\components\RamsCreationModal.tsx
==================================================

import React, { useState } from 'react';
import type { Project, User } from '../types';
import { Button } from './ui/Button';
import { generateRamsContent } from '../services/geminiService';

// Define the shape of the AI response
type AiContent = { 
    overview: string; 
    competence: string; 
    ppe_requirements?: string[];
    emergency_arrangements: string;
    sequence_of_operations: { 
        step_no: number;
        description: string; 
        hazards: { id: string; description: string }[]; 
        controls: { id: string; description: string; hierarchy: string }[];
        risk_before: { severity: number; likelihood: number };
        risk_after: { severity: number; likelihood: number };
    }[]; 
};

interface RamsCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: { activity: string; location: string; project_id: string, aiContent: AiContent }) => void;
  projects: Project[];
  activeUser: User;
}

const FormField: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
    <div className="mb-4">
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
        {children}
    </div>
);

export const RamsCreationModal: React.FC<RamsCreationModalProps> = ({ isOpen, onClose, onSubmit, projects }) => {
  const [formData, setFormData] = useState({
    activity: '',
    location: '',
    project_id: projects[0]?.id || '',
  });

  const [aiPrompt, setAiPrompt] = useState('');
  const [aiResult, setAiResult] = useState<AiContent | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState('');

  const handleChange = (field: keyof typeof formData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleGenerate = async () => {
      if (!aiPrompt.trim()) {
          setError("Please enter a description for the AI.");
          return;
      }

      setIsGenerating(true);
      setError('');
      setAiResult(null);

      try {
        const result = await generateRamsContent(aiPrompt);
        setAiResult(result);
        
        // Auto-fill Title if empty
        if (!formData.activity) {
            setFormData(prev => ({...prev, activity: aiPrompt.split('.')[0].substring(0, 50) }));
        }
      } catch(e: any) {
          console.error("RAMS Generation Error:", e);
          setError("Failed to generate content. Please check your API key or try a simpler prompt.");
      } finally {
        setIsGenerating(false);
      }
  };

  const handleSubmit = () => {
    if (!formData.activity.trim() || !formData.project_id) {
        setError('Please fill out the Activity Title and select a Project.');
        return;
    }
    if (!aiResult) {
        setError('Please generate the method statement with AI first.');
        return;
    }
    onSubmit({ ...formData, aiContent: aiResult });
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-gray-700 flex justify-between items-center">
          <div>
            <h3 className="text-xl font-bold text-gray-900 dark:text-white">Create Comprehensive RAMS</h3>
            <p className="text-sm text-gray-500 dark:text-gray-400">AI-Powered Risk Assessment & Method Statement</p>
          </div>
          <button onClick={onClose} className="text-gray-400 hover:text-white">âœ•</button>
        </div>

        {/* Scrollable Content */}
        <div className="p-6 flex-1 overflow-y-auto">
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div className="space-y-4">
                    <FormField label="Project">
                        <select 
                            value={formData.project_id} 
                            onChange={e => handleChange('project_id', e.target.value)} 
                            className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-white"
                        >
                            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                    </FormField>
                    <FormField label="Activity Title">
                        <input 
                            type="text" 
                            value={formData.activity} 
                            onChange={e => handleChange('activity', e.target.value)} 
                            className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-white" 
                            placeholder="e.g., Confined Space Welding"
                        />
                    </FormField>
                    <FormField label="Work Location">
                        <input 
                            type="text" 
                            value={formData.location} 
                            onChange={e => handleChange('location', e.target.value)} 
                            className="w-full p-2.5 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-white" 
                            placeholder="e.g., Basement Level 2"
                        />
                    </FormField>
                </div>

                {/* AI Input Area */}
                <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                    <div className="flex items-center gap-2 mb-2">
                        <span className="text-xl">ðŸ¤–</span>
                        <h4 className="font-semibold text-gray-900 dark:text-white">AI Assistant</h4>
                    </div>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-3">
                        Describe the task in detail. Include tools, height, materials, and environment.
                    </p>
                    <textarea 
                        value={aiPrompt} 
                        onChange={e => setAiPrompt(e.target.value)} 
                        rows={4} 
                        className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-900 text-sm focus:ring-2 focus:ring-emerald-500" 
                        placeholder="Example: Installation of heavy steel beams at 15m height using a 50-ton mobile crane. Ground conditions are sandy."
                    />
                    <Button 
                        onClick={handleGenerate} 
                        disabled={isGenerating}
                        className="w-full mt-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white"
                    >
                        {isGenerating ? 'Analyzing Risks & generating Steps...' : 'Generate Comprehensive RAMS'}
                    </Button>
                </div>
            </div>

            {/* AI Result Preview */}
            {aiResult && (
                <div className="space-y-6 animate-fadeIn">
                    <div className="p-4 bg-emerald-50 dark:bg-emerald-900/10 border border-emerald-200 dark:border-emerald-800 rounded-lg">
                        <h4 className="font-bold text-emerald-800 dark:text-emerald-400 mb-2">Overview</h4>
                        <p className="text-sm text-gray-700 dark:text-gray-300">{aiResult.overview}</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="p-4 border dark:border-gray-700 rounded-lg">
                            <h5 className="font-bold mb-2">Competence Required</h5>
                            <p className="text-sm text-gray-600 dark:text-gray-400">{aiResult.competence}</p>
                        </div>
                        <div className="p-4 border dark:border-gray-700 rounded-lg">
                            <h5 className="font-bold mb-2">Emergency Arrangements</h5>
                            <p className="text-sm text-gray-600 dark:text-gray-400">{aiResult.emergency_arrangements}</p>
                        </div>
                    </div>

                    <div>
                        <h4 className="font-bold text-lg mb-3 border-b dark:border-gray-700 pb-2">Method Statement Steps</h4>
                        <div className="space-y-4">
                            {aiResult.sequence_of_operations.map((step, i) => (
                                <div key={i} className="border dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-slate-800/30">
                                    <div className="flex justify-between mb-2">
                                        <h5 className="font-bold">Step {step.step_no}: {step.description}</h5>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <strong className="text-red-500">Hazards:</strong>
                                            <ul className="list-disc pl-4 mt-1 text-gray-600 dark:text-gray-400">
                                                {step.hazards.map((h, idx) => <li key={idx}>{h.description}</li>)}
                                            </ul>
                                        </div>
                                        <div>
                                            <strong className="text-emerald-500">Controls:</strong>
                                            <ul className="list-disc pl-4 mt-1 text-gray-600 dark:text-gray-400">
                                                {step.controls.map((c, idx) => <li key={idx}>{c.description} <span className="text-xs opacity-50">({c.hierarchy})</span></li>)}
                                            </ul>
                                        </div>
                                    </div>
                                    <div className="mt-3 flex gap-4 text-xs font-mono">
                                        <span className="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">Risk Before: {step.risk_before.severity * step.risk_before.likelihood}</span>
                                        <span className="bg-emerald-100 dark:bg-emerald-900 text-emerald-700 px-2 py-1 rounded">Residual: {step.risk_after.severity * step.risk_after.likelihood}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {error && <p className="text-red-500 text-center mt-4">{error}</p>}
        </div>

        {/* Footer */}
        <div className="p-6 border-t dark:border-gray-700 flex justify-end gap-3 bg-gray-50 dark:bg-slate-800/50 rounded-b-xl">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit} disabled={!aiResult || !formData.activity}>Create RAMS</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\RamsDetailModal.tsx
==================================================

import React, { useState } from 'react';
import type { Rams as RamsType, RamsStatus, RamsStep, User } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import ReactMarkdown from 'react-markdown';
import { RiskMatrixDisplay } from './RiskMatrixDisplay';
import { useAppContext } from '../contexts';
import { ActionsBar } from './ui/ActionsBar';
import { EmailModal } from './ui/EmailModal';

interface RamsDetailModalProps {
  rams: RamsType;
  onClose: () => void;
  onStatusChange: (ramsId: string, newStatus: RamsStatus) => void;
}

const getStatusColor = (status: RamsStatus): 'green' | 'blue' | 'yellow' | 'red' | 'gray' => {
  switch (status) {
    case 'published': return 'green';
    case 'approved': return 'blue';
    case 'under_review': return 'yellow';
    case 'archived': return 'gray';
    case 'draft':
    default: return 'gray';
  }
};

const DetailItem: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
  <div>
    <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">{label}</p>
    <div className="text-sm text-gray-800 dark:text-gray-200 mt-1">{children}</div>
  </div>
);

const PersonDetail: React.FC<{ person?: { name: string; email: string; signed_at?: string } }> = ({ person }) => {
    if (!person || !person.name) return <span className="text-gray-400">N/A</span>;
    return (
        <div>
            <p className="font-semibold">{person.name}</p>
            {person.signed_at && <p className="text-xs text-green-600">Signed at {new Date(person.signed_at).toLocaleString()}</p>}
        </div>
    );
}

const WorkflowActions: React.FC<{ status: RamsStatus, onAction: (newStatus: RamsStatus) => void }> = ({ status, onAction }) => {
    const { can } = useAppContext();
    const canApprove = can('approve', 'rams');
    return (
        <div className="flex items-center space-x-2">
            {status === 'draft' && <Button onClick={() => onAction('under_review')}>Submit for Review</Button>}
            {status === 'under_review' && canApprove && (
                <>
                    <Button variant="secondary" onClick={() => onAction('draft')}>Request Changes</Button>
                    <Button onClick={() => onAction('approved')}>Approve</Button>
                </>
            )}
             {status === 'approved' && canApprove && <Button onClick={() => onAction('published')}>Publish</Button>}
             {status === 'published' && canApprove && <Button variant="danger" onClick={() => onAction('archived')}>Archive</Button>}
        </div>
    );
}

const StepDisplay: React.FC<{ step: RamsStep }> = ({ step }) => (
    <div className="border dark:border-dark-border rounded-lg overflow-hidden">
        <div className="bg-gray-50 dark:bg-dark-background p-3 border-b dark:border-dark-border">
            <h4 className="font-bold">Step {step.step_no}: {step.description}</h4>
        </div>
        <div className="p-3 grid grid-cols-2 gap-4">
            <div>
                <h5 className="font-semibold text-sm mb-2">Hazards</h5>
                <ul className="list-disc list-inside text-sm space-y-1">
                    {step.hazards.map(h => <li key={h.id}>{h.description}</li>)}
                </ul>
            </div>
             <div>
                <h5 className="font-semibold text-sm mb-2">Controls</h5>
                <ul className="list-disc list-inside text-sm space-y-1">
                    {step.controls.map(c => <li key={c.id}>{c.description} <span className="text-xs text-gray-500">({c.hierarchy})</span></li>)}
                </ul>
            </div>
        </div>
        <div className="p-3 bg-gray-50 dark:bg-dark-background border-t dark:border-dark-border grid grid-cols-2 gap-4">
            <div>
                 <h5 className="font-semibold text-sm mb-2">Risk Before Controls</h5>
                 <RiskMatrixDisplay matrix={step.risk_before} />
            </div>
            <div>
                 <h5 className="font-semibold text-sm mb-2">Risk After Controls</h5>
                 <RiskMatrixDisplay matrix={step.risk_after} />
            </div>
        </div>
    </div>
);


export const RamsDetailModal: React.FC<RamsDetailModalProps> = ({ rams, onClose, onStatusChange }) => {
  const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);

  const handlePrint = () => window.print();

  return (
    <>
    <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <header className="p-4 border-b dark:border-dark-border flex justify-between items-center flex-shrink-0">
          <div>
            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">{rams.activity} ({rams.version})</h2>
            <p className="text-sm text-gray-500 dark:text-gray-400">Risk Assessment & Method Statement</p>
          </div>
          <div className="flex items-center gap-4">
             <ActionsBar onPrint={handlePrint} onDownloadPdf={handlePrint} onEmail={() => setIsEmailModalOpen(true)} />
             <Badge color={getStatusColor(rams.status)}>{rams.status.replace('_', ' ')}</Badge>
             <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><CloseIcon className="w-6 h-6" /></button>
          </div>
        </header>

        <div className="flex-grow flex overflow-hidden">
            <main className="flex-1 p-8 overflow-y-auto">
                <h3 className="text-lg font-bold">Method Statement</h3>
                <div className="prose dark:prose-invert max-w-none text-sm my-4"><ReactMarkdown>{rams.method_statement.overview}</ReactMarkdown></div>
                
                <h3 className="text-lg font-bold mt-6">Sequence of Operations</h3>
                <div className="space-y-4 mt-4">
                    {rams.method_statement.sequence_of_operations.map(step => (
                        <StepDisplay key={step.step_no} step={step} />
                    ))}
                </div>

                <h3 className="text-lg font-bold mt-6">Emergency Arrangements</h3>
                <div className="prose dark:prose-invert max-w-none text-sm my-4"><ReactMarkdown>{rams.method_statement.emergency_arrangements}</ReactMarkdown></div>

            </main>

            <aside className="w-80 bg-gray-50 dark:bg-dark-background border-l dark:border-dark-border p-6 overflow-y-auto flex-shrink-0">
                <h3 className="text-lg font-bold mb-4">Details</h3>
                <div className="space-y-4">
                    <DetailItem label="Prepared By"><PersonDetail person={rams.prepared_by} /></DetailItem>
                    <DetailItem label="Reviewed By"><PersonDetail person={rams.reviewed_by} /></DetailItem>
                    <DetailItem label="Client Approved By"><PersonDetail person={rams.approved_by_client} /></DetailItem>
                    <DetailItem label="Valid From">{new Date(rams.times.valid_from).toLocaleDateString()}</DetailItem>
                    <DetailItem label="Valid Until">{new Date(rams.times.valid_until).toLocaleDateString()}</DetailItem>
                </div>
                 <h3 className="text-lg font-bold mt-6 mb-4">Attachments</h3>
                 <ul className="space-y-2">
                     {rams.attachments.map(att => (
                         <li key={att.name} className="flex items-center p-2 bg-white dark:bg-dark-card border dark:border-dark-border rounded-md">
                             <PaperClipIcon className="w-5 h-5 text-gray-400 mr-2" />
                             <a href={att.url} target="_blank" rel="noopener noreferrer" className="text-sm text-primary-600 hover:underline flex-1 truncate">{att.name}</a>
                         </li>
                     ))}
                     {rams.attachments.length === 0 && <p className="text-sm text-gray-500">No attachments.</p>}
                 </ul>
            </aside>
        </div>

        <footer className="p-4 border-t bg-gray-100 dark:bg-dark-background dark:border-dark-border flex justify-end items-center flex-shrink-0">
            <WorkflowActions status={rams.status} onAction={(newStatus) => onStatusChange(rams.id, newStatus)} />
        </footer>
      </div>
    </div>
    <EmailModal 
        isOpen={isEmailModalOpen}
        onClose={() => setIsEmailModalOpen(false)}
        documentTitle={`RAMS: ${rams.activity}`}
        documentLink={`${window.location.href}?rams=${rams.id}`}
        defaultRecipients={[rams.prepared_by, rams.reviewed_by, rams.approved_by_client].filter(p => p && p.email) as User[]}
    />
    </>
  );
};


// Icons
const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
const PaperClipIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" />
    </svg>
);

==================================================
FILE: .\src\components\RamsEditorModal.tsx
==================================================

import React, { useState, useEffect } from 'react';
import type { Rams as RamsType, RamsStatus, RamsStep } from '../types';
import { Button } from './ui/Button';
import ReactMarkdown from 'react-markdown';
import { Badge } from './ui/Badge';
import { translateText } from '../services/geminiService';
import { RamsStepEditor } from './RamsStepEditor';
import { 
  getStatusColor, 
  getStatusDisplayText, 
  getRiskColor,
  getRiskLevel,
  calculateOverallRisk,
  formatDate 
} from '../utils/ramsUtils';
import { Loader2, Globe, Plus, Trash2, X, Paperclip } from 'lucide-react';

interface RamsEditorModalProps {
  rams: RamsType;
  onClose: () => void;
  onSave: (rams: RamsType) => void;
  onSubmitForReview: (ramsId: string, newStatus: RamsStatus) => void;
  onDelete?: (ramsId: string) => void;
}

type EditorSection = 'Overview' | 'Competence' | 'Steps' | 'Emergency' | 'Settings';

const RightRailSection: React.FC<{ title: string; children: React.ReactNode; className?: string }> = ({ 
  title, 
  children, 
  className = '' 
}) => (
  <div className={className}>
    <h3 className="text-sm font-bold uppercase text-gray-500 dark:text-gray-400 mb-2">{title}</h3>
    <div className="p-3 bg-white dark:bg-dark-card border dark:border-dark-border rounded-md space-y-2">
      {children}
    </div>
  </div>
);

const StepSummary: React.FC<{ step: RamsStep; onClick: () => void }> = ({ step, onClick }) => {
  const riskBefore = step.risk_before.severity * step.risk_before.likelihood;
  const riskAfter = step.risk_after.severity * step.risk_after.likelihood;
  const riskReduction = riskBefore - riskAfter;
  
  return (
    <div 
      className="p-3 border dark:border-dark-border rounded-lg bg-white dark:bg-dark-card hover:shadow-md transition-shadow cursor-pointer"
      onClick={onClick}
    >
      <div className="flex justify-between items-start">
        <div>
          <div className="flex items-center gap-2 mb-1">
            <span className="font-bold text-primary-600 dark:text-primary-400">Step {step.step_no}</span>
            <Badge color={riskAfter >= 13 ? 'red' : riskAfter >= 7 ? 'yellow' : 'green'}>
              Risk: {riskAfter}
            </Badge>
          </div>
          <p className="text-sm font-medium text-gray-900 dark:text-white">{step.description}</p>
        </div>
        {riskReduction > 0 && (
          <Badge color="green" className="animate-pulse">
            â†“ {riskReduction}
          </Badge>
        )}
      </div>
      <div className="mt-2 flex gap-4 text-xs text-gray-500 dark:text-gray-400">
        <span>{step.hazards.length} hazard{step.hazards.length !== 1 ? 's' : ''}</span>
        <span>{step.controls.length} control{step.controls.length !== 1 ? 's' : ''}</span>
      </div>
    </div>
  );
};

export const RamsEditorModal: React.FC<RamsEditorModalProps> = ({ 
  rams, 
  onClose, 
  onSave, 
  onSubmitForReview,
  onDelete 
}) => {
  const [editedRams, setEditedRams] = useState<RamsType>(JSON.parse(JSON.stringify(rams)));
  const [activeSection, setActiveSection] = useState<EditorSection>('Overview');
  const [isTranslating, setIsTranslating] = useState(false);
  const [editingStep, setEditingStep] = useState<RamsStep | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [showStepModal, setShowStepModal] = useState(false);
  const [autoSaveTimer, setAutoSaveTimer] = useState<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (autoSaveTimer) {
      clearTimeout(autoSaveTimer);
    }
    
    const timer = setTimeout(() => {
      if (!isSaving && JSON.stringify(editedRams) !== JSON.stringify(rams)) {
        handleAutoSave();
      }
    }, 5000);

    setAutoSaveTimer(timer);
    
    return () => {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
    };
  }, [editedRams]);

  const handleAutoSave = async () => {
    setIsSaving(true);
    try {
      console.log('Auto-saving...', editedRams);
    } catch (error) {
      console.error('Auto-save failed:', error);
    } finally {
      setIsSaving(false);
    }
  };

  useEffect(() => {
    const risks = calculateOverallRisk(editedRams.method_statement.sequence_of_operations);
    setEditedRams(prev => ({
      ...prev,
      overall_risk_before: risks.before,
      overall_risk_after: risks.after,
    }));
  }, [editedRams.method_statement.sequence_of_operations]);

  const handleSaveAndSubmit = async () => {
    setIsSaving(true);
    try {
      await onSave(editedRams);
      await onSubmitForReview(editedRams.id, 'under_review');
    } finally {
      setIsSaving(false);
    }
  };

  const handleTranslate = async () => {
    const textToTranslate = editedRams.method_statement.overview;
    if (!textToTranslate) return;
    setIsTranslating(true);
    try {
      const translatedText = await translateText(textToTranslate, 'Arabic');
      setEditedRams(prev => ({
        ...prev, 
        method_statement: { 
          ...prev.method_statement, 
          overview: translatedText 
        }
      }));
    } catch (error) {
      console.error("Translation failed:", error);
      alert('Translation failed. Please try again.');
    } finally {
      setIsTranslating(false);
    }
  };

  const handleUpdateStep = (updatedStep: RamsStep) => {
    setEditedRams(prev => ({
      ...prev,
      method_statement: {
        ...prev.method_statement,
        sequence_of_operations: prev.method_statement.sequence_of_operations.map(s => 
          s.step_no === updatedStep.step_no ? updatedStep : s
        )
      }
    }));
    setShowStepModal(false);
    setEditingStep(null);
  };

  const handleAddStep = () => {
    const newStep: RamsStep = {
      step_no: editedRams.method_statement.sequence_of_operations.length + 1,
      description: `New Step ${editedRams.method_statement.sequence_of_operations.length + 1}`,
      hazards: [],
      controls: [],
      risk_before: { severity: 3, likelihood: 3 },
      risk_after: { severity: 1, likelihood: 1 }
    };
    setEditingStep(newStep);
    setShowStepModal(true);
  };

  const handleDeleteStep = (stepNo: number) => {
    setEditedRams(prev => ({
      ...prev,
      method_statement: {
        ...prev.method_statement,
        sequence_of_operations: prev.method_statement.sequence_of_operations
          .filter(s => s.step_no !== stepNo)
          .map((s, idx) => ({ ...s, step_no: idx + 1 }))
      }
    }));
  };

  const renderSection = () => {
    switch(activeSection) {
      case 'Overview':
      case 'Competence':
      case 'Emergency':
        const keyMap = { 
          'Overview': 'overview', 
          'Competence': 'competence', 
          'Emergency': 'emergency_arrangements' 
        };
        const currentKey = keyMap[activeSection] as 'overview' | 'competence' | 'emergency_arrangements';
        
        return (
          <div>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white">{activeSection}</h2>
              {activeSection === 'Overview' && (
                <Button 
                  variant="outline" 
                  onClick={handleTranslate} 
                  disabled={isTranslating}
                  className="flex items-center gap-2"
                >
                  {isTranslating ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Translating...
                    </>
                  ) : (
                    <>
                      <Globe className="w-4 h-4" />
                      Translate to Arabic
                    </>
                  )}
                </Button>
              )}
            </div>
            <div className="flex flex-col lg:flex-row gap-4 mb-4">
              <div className="flex-1">
                <textarea 
                  value={editedRams.method_statement[currentKey]}
                  onChange={(e) => setEditedRams(prev => ({
                    ...prev, 
                    method_statement: { 
                      ...prev.method_statement, 
                      [currentKey]: e.target.value 
                    }
                  }))}
                  className="w-full h-[50vh] p-4 border rounded-lg bg-white dark:bg-dark-card dark:border-dark-border font-mono text-gray-900 dark:text-white"
                  placeholder={`Describe the ${activeSection.toLowerCase()}...`}
                  spellCheck="true"
                />
              </div>
              <div className="flex-1">
                <h4 className="font-semibold mb-2 text-gray-900 dark:text-white">Preview</h4>
                <div className="p-4 border rounded-lg h-[50vh] overflow-y-auto bg-gray-50 dark:bg-gray-900/50 dark:border-dark-border">
                  <ReactMarkdown className="prose dark:prose-invert max-w-none">
                    {editedRams.method_statement[currentKey] || `*No ${activeSection.toLowerCase()} content yet*`}
                  </ReactMarkdown>
                </div>
              </div>
            </div>
          </div>
        );
        
      case 'Steps':
        return (
          <div>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Sequence of Operations</h2>
              <Button onClick={handleAddStep}>
                <Plus className="w-5 h-5 mr-2" />
                Add Step
              </Button>
            </div>
            
            <div className="space-y-3 mb-6">
              {editedRams.method_statement.sequence_of_operations.map(step => (
                <StepSummary 
                  key={step.step_no} 
                  step={step} 
                  onClick={() => {
                    setEditingStep(step);
                    setShowStepModal(true);
                  }}
                />
              ))}
              
              {editedRams.method_statement.sequence_of_operations.length === 0 && (
                <div className="text-center py-12 border-2 border-dashed rounded-lg border-gray-300 dark:border-gray-700">
                  <p className="text-gray-500 dark:text-gray-400 mb-4">No steps defined yet</p>
                  <Button onClick={handleAddStep}>
                    Add First Step
                  </Button>
                </div>
              )}
            </div>
          </div>
        );
        
      case 'Settings':
        return (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Settings</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">RAMS Title</label>
                <input
                  type="text"
                  value={editedRams.activity}
                  onChange={(e) => setEditedRams(prev => ({ ...prev, activity: e.target.value }))}
                  className="w-full p-2 border rounded bg-white dark:bg-dark-background dark:border-dark-border dark:text-white"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Valid From</label>
                  <input
                    type="date"
                    value={editedRams.times.valid_from.split('T')[0]}
                    onChange={(e) => setEditedRams(prev => ({
                      ...prev,
                      times: { ...prev.times, valid_from: new Date(e.target.value).toISOString() }
                    }))}
                    className="w-full p-2 border rounded bg-white dark:bg-dark-background dark:border-dark-border dark:text-white"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Valid Until</label>
                  <input
                    type="date"
                    value={editedRams.times.valid_until.split('T')[0]}
                    onChange={(e) => setEditedRams(prev => ({
                      ...prev,
                      times: { ...prev.times, valid_until: new Date(e.target.value).toISOString() }
                    }))}
                    className="w-full p-2 border rounded bg-white dark:bg-dark-background dark:border-dark-border dark:text-white"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Linked PTW Types</label>
                <div className="flex flex-wrap gap-2">
                  {['Hot Work', 'Work at Height', 'Confined Space', 'Electrical', 'Excavation'].map(type => (
                    <label key={type} className="inline-flex items-center text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700">
                      <input
                        type="checkbox"
                        checked={(editedRams.linked_ptw_types || []).includes(type as any)}
                        onChange={(e) => {
                          setEditedRams(prev => ({
                            ...prev,
                            linked_ptw_types: e.target.checked
                              ? [...prev.linked_ptw_types, type as any]
                              : prev.linked_ptw_types.filter(t => t !== type)
                          }));
                        }}
                        className="mr-2 rounded text-primary-600 focus:ring-primary-500"
                      />
                      {type}
                    </label>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
        
      default: 
        return null;
    }
  };

  return (
    <>
      <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4" onClick={onClose}>
        <div className="bg-gray-100 dark:bg-dark-background rounded-lg shadow-2xl w-full max-w-7xl h-[95vh] flex flex-col" onClick={e => e.stopPropagation()}>
          <header className="p-4 border-b bg-white dark:bg-dark-card dark:border-dark-border flex justify-between items-center flex-shrink-0">
            <div className="flex items-center gap-3">
              <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">
                {editedRams.activity}
                {isSaving && <span className="ml-2 text-sm text-gray-500 font-normal">(Saving...)</span>}
              </h2>
              <Badge color={getStatusColor(editedRams.status)}>
                {getStatusDisplayText(editedRams.status)}
              </Badge>
              <span className="text-sm text-gray-500">v{editedRams.version}</span>
            </div>
            <div className="flex items-center gap-4">
              {onDelete && (
                <Button 
                  variant="ghost" 
                  onClick={() => setShowDeleteConfirm(true)}
                  className="text-red-600 hover:text-red-800 hover:bg-red-50 dark:hover:bg-red-900/20"
                >
                  <Trash2 className="w-4 h-4 mr-2" />
                  Delete
                </Button>
              )}
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <X className="w-6 h-6" />
              </button>
            </div>
          </header>

          <div className="flex-grow flex overflow-hidden">
            <nav className="w-60 bg-white dark:bg-dark-card border-r dark:border-dark-border overflow-y-auto p-4 flex-shrink-0">
              <h3 className="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 mb-2 px-2">Sections</h3>
              <ul className="space-y-1">
                {(['Overview', 'Competence', 'Steps', 'Emergency', 'Settings'] as EditorSection[]).map(section => (
                  <li key={section}>
                    <button
                      onClick={() => setActiveSection(section)}
                      className={`w-full text-left p-3 rounded-md text-sm font-medium flex items-center gap-2 transition-all ${
                        activeSection === section 
                          ? 'bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300' 
                          : 'hover:bg-gray-100 dark:hover:bg-dark-background text-gray-600 dark:text-gray-300'
                      }`}
                    >
                      {section === 'Steps' && (
                        <span className="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs px-2 py-0.5 rounded-full font-bold ml-auto">
                          {editedRams.method_statement.sequence_of_operations.length}
                        </span>
                      )}
                      {section}
                    </button>
                  </li>
                ))}
              </ul>
              
              <div className="mt-6 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800">
                <h4 className="font-semibold text-sm mb-3 text-gray-900 dark:text-white">Risk Summary</h4>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Initial Risk:</span>
                    <Badge color={getRiskColor(editedRams.overall_risk_before)}>
                      {getRiskLevel(editedRams.overall_risk_before)} ({editedRams.overall_risk_before})
                    </Badge>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Residual Risk:</span>
                    <Badge color={getRiskColor(editedRams.overall_risk_after)}>
                      {getRiskLevel(editedRams.overall_risk_after)} ({editedRams.overall_risk_after})
                    </Badge>
                  </div>
                  {editedRams.overall_risk_before > editedRams.overall_risk_after && (
                    <div className="text-xs text-green-600 dark:text-green-400 font-medium mt-1 pt-2 border-t border-gray-200 dark:border-gray-700">
                      â†“ Risk reduction: {editedRams.overall_risk_before - editedRams.overall_risk_after} points
                    </div>
                  )}
                </div>
              </div>
            </nav>

            <main className="flex-1 p-6 overflow-y-auto">
              {renderSection()}
            </main>

            <aside className="w-80 bg-gray-50 dark:bg-dark-background border-l dark:border-dark-border p-4 overflow-y-auto flex-shrink-0 space-y-6">
              <RightRailSection title="Overall Risk Score">
                <div className="grid grid-cols-2 gap-4 text-center">
                  <div className="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900/30">
                    <p className="text-xs font-bold mb-1 text-red-800 dark:text-red-300">BEFORE</p>
                    <p className="text-3xl font-black text-red-600 dark:text-red-400">{editedRams.overall_risk_before}</p>
                  </div>
                  <div className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-100 dark:border-green-900/30">
                    <p className="text-xs font-bold mb-1 text-green-800 dark:text-green-300">AFTER</p>
                    <p className="text-3xl font-black text-green-600 dark:text-green-400">{editedRams.overall_risk_after}</p>
                  </div>
                </div>
              </RightRailSection>

              <RightRailSection title="Timeline">
                <div className="space-y-3 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-500">Created:</span>
                    <span className="font-medium text-gray-900 dark:text-white">{formatDate(editedRams.times.created_at)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-500">Valid From:</span>
                    <span className="font-medium text-gray-900 dark:text-white">{formatDate(editedRams.times.valid_from)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-500">Valid Until:</span>
                    <span className="font-medium text-gray-900 dark:text-white">{formatDate(editedRams.times.valid_until)}</span>
                  </div>
                </div>
              </RightRailSection>

              <RightRailSection title="Linked PTW Types">
                <div className="flex flex-wrap gap-2">
                  {editedRams.linked_ptw_types.map(ptw => (
                    <Badge key={ptw} color="blue">{ptw}</Badge>
                  ))}
                  {editedRams.linked_ptw_types.length === 0 && (
                    <p className="text-xs text-gray-500 italic">No linked PTWs</p>
                  )}
                </div>
              </RightRailSection>

              <RightRailSection title="Attachments">
                <div className="space-y-2">
                  {editedRams.attachments.map(att => (
                    <div key={att.name} className="flex items-center justify-between p-2 bg-white dark:bg-dark-card hover:bg-gray-100 dark:hover:bg-gray-800 rounded border dark:border-gray-700 transition-colors">
                      <div className="flex items-center min-w-0">
                        <Paperclip className="w-4 h-4 mr-2 text-gray-400 flex-shrink-0"/>
                        <span className="truncate text-sm text-gray-700 dark:text-gray-300">{att.name}</span>
                      </div>
                      <a 
                        href={att.url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-primary-600 hover:text-primary-800 text-xs font-medium"
                      >
                        View
                      </a>
                    </div>
                  ))}
                  {editedRams.attachments.length === 0 && (
                    <p className="text-xs text-gray-500 italic text-center py-2">No attachments</p>
                  )}
                  <Button variant="outline" size="sm" className="w-full mt-2 border-dashed">
                    <Plus className="w-4 h-4 mr-2" />
                    Add Attachment
                  </Button>
                </div>
              </RightRailSection>
            </aside>
          </div>

          <footer className="p-4 border-t bg-white dark:bg-dark-card dark:border-dark-border flex justify-between items-center flex-shrink-0">
            <div className="flex items-center gap-2">
              {isSaving && (
                <div className="flex items-center text-sm text-gray-500">
                  <Loader2 className="w-4 h-4 animate-spin mr-2" />
                  <span>Auto-saving...</span>
                </div>
              )}
              {!isSaving && editedRams.times.updated_at && (
                <span className="text-xs text-gray-500">
                  Last saved: {new Date(editedRams.times.updated_at).toLocaleTimeString()}
                </span>
              )}
            </div>
            <div className="flex gap-2">
              <Button variant="secondary" onClick={onClose}>Cancel</Button>
              <Button 
                variant="outline" 
                onClick={() => onSave(editedRams)}
                disabled={isSaving}
              >
                Save Draft
              </Button>
              <Button 
                onClick={handleSaveAndSubmit} 
                disabled={isSaving}
                className="ml-2"
              >
                Save & Submit for Review
              </Button>
            </div>
          </footer>
        </div>
      </div>

      {showStepModal && editingStep && (
        <RamsStepEditor
          step={editingStep}
          onSave={handleUpdateStep}
          onClose={() => {
            setShowStepModal(false);
            setEditingStep(null);
          }}
          onDelete={() => {
            handleDeleteStep(editingStep.step_no);
            setShowStepModal(false);
            setEditingStep(null);
          }}
        />
      )}

      {showDeleteConfirm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-[60] flex justify-center items-center p-4" onClick={() => setShowDeleteConfirm(false)}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Delete RAMS</h3>
                <p className="text-gray-600 dark:text-gray-300 mb-6">
                    Are you sure you want to delete this RAMS document? This action cannot be undone.
                </p>
                <div className="flex justify-end gap-3">
                    <Button variant="secondary" onClick={() => setShowDeleteConfirm(false)}>Cancel</Button>
                    <Button variant="danger" onClick={() => {
                        if (onDelete) onDelete(editedRams.id);
                        setShowDeleteConfirm(false);
                        onClose();
                    }}>Delete</Button>
                </div>
            </div>
        </div>
      )}
    </>
  );
};

==================================================
FILE: .\src\components\RamsStepEditor.tsx
==================================================

import React, { useState } from 'react';
import type { RamsStep, RamsHazard, RamsControl, RamsHierarchy, Severity, Likelihood } from '../types';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { RiskMatrixInput } from './RiskMatrixInput';
import { X, Plus, Trash2 } from 'lucide-react';

interface RamsStepEditorProps {
  step: RamsStep;
  onSave: (step: RamsStep) => void;
  onClose: () => void;
  onDelete?: () => void;
}

const HIERARCHY_OPTIONS: { value: RamsHierarchy; label: string; color: string }[] = [
  { value: 'elimination', label: 'Elimination', color: 'green' },
  { value: 'substitution', label: 'Substitution', color: 'blue' },
  { value: 'engineering', label: 'Engineering', color: 'purple' },
  { value: 'administrative', label: 'Administrative', color: 'yellow' },
  { value: 'ppe', label: 'PPE', color: 'orange' },
];

export const RamsStepEditor: React.FC<RamsStepEditorProps> = ({ step, onSave, onClose, onDelete }) => {
  const [editedStep, setEditedStep] = useState<RamsStep>({ ...step });
  const [newHazard, setNewHazard] = useState('');
  const [newControl, setNewControl] = useState('');
  const [selectedHierarchy, setSelectedHierarchy] = useState<RamsHierarchy>('engineering');

  const handleAddHazard = () => {
    if (newHazard.trim()) {
      const hazard: RamsHazard = {
        id: `hazard-${Date.now()}`,
        description: newHazard.trim(),
      };
      setEditedStep(prev => ({
        ...prev,
        hazards: [...prev.hazards, hazard],
      }));
      setNewHazard('');
    }
  };

  const handleAddControl = () => {
    if (newControl.trim()) {
      const control: RamsControl = {
        id: `control-${Date.now()}`,
        description: newControl.trim(),
        hierarchy: selectedHierarchy,
      };
      setEditedStep(prev => ({
        ...prev,
        controls: [...prev.controls, control],
      }));
      setNewControl('');
    }
  };

  const handleRemoveHazard = (hazardId: string) => {
    setEditedStep(prev => ({
      ...prev,
      hazards: prev.hazards.filter(h => h.id !== hazardId),
    }));
  };

  const handleRemoveControl = (controlId: string) => {
    setEditedStep(prev => ({
      ...prev,
      controls: prev.controls.filter(c => c.id !== controlId),
    }));
  };

  const handleRiskBeforeChange = (val: { severity: number; likelihood: number }) => {
    setEditedStep(prev => ({
      ...prev,
      risk_before: {
          severity: val.severity as Severity,
          likelihood: val.likelihood as Likelihood
      },
    }));
  };

  const handleRiskAfterChange = (val: { severity: number; likelihood: number }) => {
    setEditedStep(prev => ({
      ...prev,
      risk_after: {
          severity: val.severity as Severity,
          likelihood: val.likelihood as Likelihood
      },
    }));
  };

  const calculateRiskScore = (severity: number, likelihood: number) => severity * likelihood;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-center p-4" onClick={onClose}>
        <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b dark:border-dark-border flex justify-between items-center">
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">Edit Step {step.step_no}</h2>
                <div className="flex gap-2">
                    {onDelete && (
                        <Button variant="danger" size="sm" onClick={onDelete}>
                        <Trash2 className="w-4 h-4 mr-1" /> Delete Step
                        </Button>
                    )}
                    <button onClick={onClose} className="p-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">
                        <X className="w-6 h-6 text-gray-500" />
                    </button>
                </div>
            </div>

            <div className="p-6 overflow-y-auto flex-grow space-y-6">
                {/* Step Description */}
                <div>
                <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Step Description</label>
                <textarea
                    value={editedStep.description}
                    onChange={(e) => setEditedStep(prev => ({ ...prev, description: e.target.value }))}
                    className="w-full p-3 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-background text-gray-900 dark:text-white h-24"
                    placeholder="Describe this step in detail..."
                />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Hazards Section */}
                <div className="bg-red-50 dark:bg-red-900/10 p-4 rounded-lg border border-red-100 dark:border-red-900/30">
                    <h3 className="font-bold text-red-800 dark:text-red-300 mb-3">Hazards</h3>
                    <div className="space-y-2 mb-3">
                    {editedStep.hazards.map(hazard => (
                        <div key={hazard.id} className="flex items-center justify-between p-2 bg-white dark:bg-dark-background border dark:border-red-900/30 rounded shadow-sm">
                        <span className="text-sm text-gray-700 dark:text-gray-200">{hazard.description}</span>
                        <button
                            onClick={() => handleRemoveHazard(hazard.id)}
                            className="text-red-500 hover:text-red-700"
                        >
                            <X className="w-4 h-4" />
                        </button>
                        </div>
                    ))}
                    </div>
                    <div className="flex gap-2">
                    <input
                        type="text"
                        value={newHazard}
                        onChange={(e) => setNewHazard(e.target.value)}
                        placeholder="Add new hazard..."
                        className="flex-1 p-2 text-sm border rounded dark:bg-dark-background dark:border-red-900/30 dark:text-white"
                        onKeyPress={(e) => e.key === 'Enter' && handleAddHazard()}
                    />
                    <Button size="sm" onClick={handleAddHazard} className="bg-red-600 hover:bg-red-700 text-white"><Plus className="w-4 h-4"/></Button>
                    </div>
                </div>

                {/* Controls Section */}
                <div className="bg-green-50 dark:bg-green-900/10 p-4 rounded-lg border border-green-100 dark:border-green-900/30">
                    <h3 className="font-bold text-green-800 dark:text-green-300 mb-3">Controls</h3>
                    <div className="space-y-2 mb-3">
                    {editedStep.controls.map(control => (
                        <div key={control.id} className="flex items-center justify-between p-2 bg-white dark:bg-dark-background border dark:border-green-900/30 rounded shadow-sm">
                        <div className="flex-1 min-w-0 mr-2">
                            <span className="text-sm text-gray-700 dark:text-gray-200 block truncate" title={control.description}>{control.description}</span>
                            <Badge color={HIERARCHY_OPTIONS.find(h => h.value === control.hierarchy)?.color as any} size="sm">
                            {control.hierarchy}
                            </Badge>
                        </div>
                        <button
                            onClick={() => handleRemoveControl(control.id)}
                            className="text-red-500 hover:text-red-700"
                        >
                            <X className="w-4 h-4" />
                        </button>
                        </div>
                    ))}
                    </div>
                    <div className="space-y-2">
                    <select
                        value={selectedHierarchy}
                        onChange={(e) => setSelectedHierarchy(e.target.value as RamsHierarchy)}
                        className="w-full p-2 text-sm border rounded dark:bg-dark-background dark:border-green-900/30 dark:text-white"
                    >
                        {HIERARCHY_OPTIONS.map(option => (
                        <option key={option.value} value={option.value}>
                            {option.label}
                        </option>
                        ))}
                    </select>
                    <div className="flex gap-2">
                        <input
                        type="text"
                        value={newControl}
                        onChange={(e) => setNewControl(e.target.value)}
                        placeholder="Add new control..."
                        className="flex-1 p-2 text-sm border rounded dark:bg-dark-background dark:border-green-900/30 dark:text-white"
                        onKeyPress={(e) => e.key === 'Enter' && handleAddControl()}
                        />
                        <Button size="sm" onClick={handleAddControl} className="bg-green-600 hover:bg-green-700 text-white"><Plus className="w-4 h-4"/></Button>
                    </div>
                    </div>
                </div>
                </div>

                {/* Risk Assessment */}
                <div className="mt-6 pt-6 border-t dark:border-dark-border grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">Risk Before Controls</h3>
                    <div className="flex flex-col items-center">
                        <RiskMatrixInput
                        value={editedStep.risk_before}
                        onChange={handleRiskBeforeChange}
                        />
                        <div className="mt-3">
                            <span className="text-gray-500 text-sm font-medium uppercase tracking-wide">Score</span>
                            <span className="ml-2 text-2xl font-bold text-red-600">
                                {calculateRiskScore(editedStep.risk_before.severity, editedStep.risk_before.likelihood)}
                            </span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 className="font-semibold text-gray-900 dark:text-white mb-3 text-center">Risk After Controls</h3>
                     <div className="flex flex-col items-center">
                        <RiskMatrixInput
                        value={editedStep.risk_after}
                        onChange={handleRiskAfterChange}
                        />
                        <div className="mt-3">
                            <span className="text-gray-500 text-sm font-medium uppercase tracking-wide">Score</span>
                            <span className={`ml-2 text-2xl font-bold ${
                                calculateRiskScore(editedStep.risk_after.severity, editedStep.risk_after.likelihood) >= 13 ? 'text-red-600' :
                                calculateRiskScore(editedStep.risk_after.severity, editedStep.risk_after.likelihood) >= 7 ? 'text-yellow-600' :
                                'text-green-600'
                            }`}>
                                {calculateRiskScore(editedStep.risk_after.severity, editedStep.risk_after.likelihood)}
                            </span>
                        </div>
                    </div>
                </div>
                </div>

                {/* Risk Reduction Message */}
                {calculateRiskScore(editedStep.risk_before.severity, editedStep.risk_before.likelihood) > 
                calculateRiskScore(editedStep.risk_after.severity, editedStep.risk_after.likelihood) && (
                <div className="mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-center border border-green-200 dark:border-green-800">
                    <p className="font-semibold text-green-700 dark:text-green-300">
                    Risk successfully reduced by {
                        (100 - (calculateRiskScore(editedStep.risk_after.severity, editedStep.risk_after.likelihood) / 
                        calculateRiskScore(editedStep.risk_before.severity, editedStep.risk_before.likelihood) * 100)).toFixed(0)
                    }%
                    </p>
                </div>
                )}
            </div>

            <div className="p-6 border-t dark:border-dark-border flex justify-end gap-3 bg-gray-50 dark:bg-dark-background/50 rounded-b-xl">
                <Button variant="secondary" onClick={onClose}>
                Cancel
                </Button>
                <Button onClick={() => onSave(editedStep)}>
                Save Changes
                </Button>
            </div>
        </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ReportCreationModal.tsx
==================================================

import React, { useState, useEffect, useMemo } from 'react';
import type { Report, Project, User, RiskMatrix, Severity, Likelihood, AccidentDetails, IncidentDetails, NearMissDetails, UnsafeActDetails, UnsafeConditionDetails, LeadershipEventDetails, CapaAction, ReportClassification, ImpactedParty, RootCause, ReportDistribution, ReportType } from '../types';
import { Button } from './ui/Button';
import { RiskMatrixInput } from './RiskMatrixInput';
import { FormField } from './ui/FormField';
import { useDataContext, useAppContext } from '../contexts';
import { uploadFileToCloud } from '../services/storageService';
import { generateSafetyReport } from '../services/geminiService';

interface ReportCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  initialData?: Partial<Omit<Report, 'id' | 'org_id' | 'reporter_id'>> | null;
}

const REPORT_TYPES: { type: ReportType; icon: string; description: string; color: string }[] = [
    { type: 'Incident', icon: 'â—', description: 'Unplanned event causing harm/damage.', color: 'bg-red-100 border-red-300 text-red-800' },
    { type: 'Accident', icon: 'ðŸš‘', description: 'Event resulting in injury or ill health.', color: 'bg-red-200 border-red-400 text-red-900' },
    { type: 'Near Miss', icon: 'âš ï¸', description: 'Unplanned event, no injury/damage but could have.', color: 'bg-amber-100 border-amber-300 text-amber-800' },
    { type: 'Unsafe Act', icon: 'ðŸš«', description: 'Human action creating risk.', color: 'bg-orange-100 border-orange-300 text-orange-800' },
    { type: 'Unsafe Condition', icon: 'ðŸšï¸', description: 'Hazardous workplace situation.', color: 'bg-yellow-100 border-yellow-300 text-yellow-800' },
    { type: 'First Aid Case (FAC)', icon: 'ðŸ©¹', description: 'Minor injury treated onsite.', color: 'bg-blue-100 border-blue-300 text-blue-800' },
    { type: 'Medical Treatment Case (MTC)', icon: 'ðŸ¥', description: 'Injury requiring professional care.', color: 'bg-indigo-100 border-indigo-300 text-indigo-800' },
    { type: 'Lost Time Injury (LTI)', icon: 'ðŸ›Œ', description: 'Injury causing missed workdays.', color: 'bg-red-100 border-red-300 text-red-800' },
    { type: 'Restricted Work Case (RWC)', icon: 'ðŸ¤•', description: 'Injury limiting work duties.', color: 'bg-purple-100 border-purple-300 text-purple-800' },
    { type: 'Property / Asset Damage', icon: 'ðŸ’¥', description: 'Damage to tools, equipment, etc.', color: 'bg-gray-200 border-gray-400 text-gray-800' },
    { type: 'Environmental Incident', icon: 'ðŸ›¢ï¸', description: 'Spill, leak, emission.', color: 'bg-emerald-100 border-emerald-300 text-emerald-800' },
    { type: 'Fire Event', icon: 'ðŸ”¥', description: 'Flame or smoke related.', color: 'bg-rose-100 border-rose-300 text-rose-800' },
    { type: 'Leadership Event', icon: 'ðŸ¤', description: 'Site visit, drill, or meeting.', color: 'bg-teal-100 border-teal-300 text-teal-800' },
    { type: 'Positive Observation', icon: 'ðŸŒŸ', description: 'Good safety practice observed.', color: 'bg-green-100 border-green-300 text-green-800' },
];

const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
const GpsIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>;
const SparklesIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624l-.259 1.035L16.38 20.624a3.375 3.375 0 00-2.455-2.455l-1.036-.259.259-1.035a3.375 3.375 0 002.456-2.456l.259-1.035.259 1.035a3.375 3.375 0 00-2.456 2.456z" /></svg>;

export const ReportCreationModal: React.FC<ReportCreationModalProps> = ({ isOpen, onClose, initialData }) => {
  const { projects, handleCreateReport } = useDataContext();
  const { activeUser, usersList, activeOrg } = useAppContext();
  
  const defaultDetails = useMemo(() => ({
    injury: { person_name: '', designation: '', nature_of_injury: 'Other', body_part_affected: '', treatment_given: '' } as AccidentDetails,
    incident: { property_damage_details: '', environmental_impact: null } as IncidentDetails,
    nearMiss: { potential_consequence: '' } as NearMissDetails,
    unsafeAct: { act_category: 'PPE Non-Compliance', coaching_given: false, coaching_notes: '' } as UnsafeActDetails,
    unsafeCondition: { condition_category: 'Housekeeping', temporary_control_applied: '' } as UnsafeConditionDetails,
    leadership: { event_type_code: 'TBD', leader_name: activeUser?.name || '', attendees_count: 0, key_observations: '' } as LeadershipEventDetails,
  }), [activeUser?.name]);

  const getInitialState = () => {
    const defaultState = {
        project_id: projects[0]?.id || '',
        type: 'Unsafe Condition' as ReportType,
        occurred_at: new Date().toISOString().slice(0, 16),
        location: { text: '', specific_area: '', geo: undefined },
        description: '',
        evidence_urls: [] as string[],
        risk_pre_control: { severity: 1 as Severity, likelihood: 1 as Likelihood },
        work_related: true,
        impacted_party: [] as ImpactedParty[],
        conditions: '',
        immediate_actions: '',
        further_corrective_action_required: false,
        details: defaultDetails.unsafeCondition,
        distribution: {
            user_ids: [],
            additional_recipients: [],
            send_alert_on_submit: true,
            notify_on_update: true,
        } as ReportDistribution,
        identification: { was_fire: false, was_injury: false, was_environment: false },
        classification_codes: [] as string[],
        ai_evidence_summary: '',
        ai_suggested_evidence: [] as string[],
    };
    if (initialData) {
      return { ...defaultState, ...initialData };
    }
    return defaultState;
  };

  // Use 'any' to prevent strict type checking issues during form state updates
  const [formData, setFormData] = useState<any>(getInitialState);
  const [evidenceFiles, setEvidenceFiles] = useState<File[]>([]);
  const [error, setError] = useState('');
  
  const [aiPrompt, setAiPrompt] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [uploadProgress, setUploadProgress] = useState('');

  useEffect(() => {
    if (!formData.project_id && projects.length > 0) {
        setFormData((prev: any) => ({ ...prev, project_id: projects[0].id }));
    }
  }, [projects, formData.project_id]);

  const handleTypeSelect = (newType: ReportType) => {
      let newDetails: any = defaultDetails.unsafeCondition;
      if (['First Aid Case (FAC)', 'Medical Treatment Case (MTC)', 'Lost Time Injury (LTI)', 'Restricted Work Case (RWC)', 'Accident', 'Incident'].includes(newType)) {
          newDetails = defaultDetails.injury;
      } else if (['Property / Asset Damage', 'Fire Event', 'Environmental Incident'].includes(newType)) {
          newDetails = defaultDetails.incident;
      } else if (newType === 'Near Miss') {
          newDetails = defaultDetails.nearMiss;
      } else if (newType === 'Unsafe Act') {
          newDetails = defaultDetails.unsafeAct;
      } else if (['Leadership Event', 'Positive Observation'].includes(newType)) {
          newDetails = defaultDetails.leadership;
      }
      setFormData((prev: any) => ({ ...prev, type: newType, details: newDetails }));
  };

  const handleChange = (field: string, value: any) => {
    setFormData((prev: any) => ({ ...prev, [field]: value }));
  };
  
  const handleDetailsChange = (field: string, value: any) => {
    setFormData((prev: any) => ({ ...prev, details: { ...prev.details, [field]: value } }));
  };

  const handleLocationChange = (field: 'text' | 'specific_area', value: string) => {
     setFormData((prev: any) => ({ ...prev, location: { ...prev.location, [field]: value }}));
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      setEvidenceFiles(prev => [...prev, ...Array.from(e.target.files!)]);
    }
  };

  const handleRemoveFile = (index: number) => {
    setEvidenceFiles(prev => prev.filter((_, i) => i !== index));
  };
  
  const handleGetGps = () => {
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            setFormData((prev: any) => ({
                ...prev,
                location: {
                    ...prev.location,
                    text: `GPS: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`,
                    geo: { lat: latitude, lng: longitude }
                }
            }));
        },
        (error) => {
            console.error("Error getting location", error);
            alert("Could not retrieve GPS location. Please enter it manually.");
        }
    );
  };

  const handleQuickAiReport = async () => {
      if(!aiPrompt.trim()) return;
      setIsAiLoading(true);
      setError('');
      try {
          const fullPrompt = `Type: ${formData.type}. Details: ${aiPrompt}`;
          const aiData = await generateSafetyReport(fullPrompt);
          if (!aiData) throw new Error("No data received from AI");

          const newFormData: any = {
              ...formData,
              description: aiData.description, 
              conditions: aiData.rootCause ? `Root Cause: ${aiData.rootCause}` : formData.conditions,
              immediate_actions: aiData.recommendation || formData.immediate_actions,
              risk_pre_control: {
                   severity: aiData.riskLevel === 'High' ? 3 : aiData.riskLevel === 'Medium' ? 2 : 1,
                   likelihood: aiData.riskLevel === 'High' ? 3 : aiData.riskLevel === 'Medium' ? 2 : 1
              },
              ai_evidence_summary: `AI Analysis: Risk detected as ${aiData.riskLevel}`,
              ai_suggested_evidence: [] 
          };
          setFormData(newFormData);
      } catch (e) {
          console.error(e);
          setError("AI analysis failed. Check your connection or API Key.");
      } finally {
          setIsAiLoading(false);
      }
  };

  const handleSubmit = async () => {
    if (!formData.project_id) {
        setError("A project must be selected.");
        return;
    }
    if (!formData.description.trim() && !isLeadership) {
        setError("The event description cannot be empty.");
        return;
    }
    
    setError('');
    setIsSubmitting(true);
    setUploadProgress('Uploading evidence...');

    try {
      let realUrls: string[] = [];
      if (evidenceFiles.length > 0) {
          const uploadPromises = evidenceFiles.map(file => uploadFileToCloud(file, 'reports'));
          realUrls = await Promise.all(uploadPromises);
      }

      setUploadProgress('Saving report...');
      await handleCreateReport({ ...formData, evidence_urls: realUrls });
      
      onClose();
    } catch (err: any) {
      console.error("Submission error:", err);
      setError(`Failed to submit: ${err.message}`);
    } finally {
      setIsSubmitting(false);
      setUploadProgress('');
    }
  };

  const isInjuryType = ['First Aid Case (FAC)', 'Medical Treatment Case (MTC)', 'Lost Time Injury (LTI)', 'Restricted Work Case (RWC)', 'Accident', 'Incident'].includes(formData.type);
  const isLeadership = ['Leadership Event', 'Positive Observation'].includes(formData.type);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-dark-border flex justify-between items-center bg-white dark:bg-dark-card sticky top-0 z-10 rounded-t-xl">
            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">New HSE Report</h2>
            <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full"><CloseIcon className="w-6 h-6 text-gray-500" /></button>
        </div>
        
        <div className="p-6 overflow-y-auto space-y-8 custom-scrollbar">
            {/* Report Type Selection - FIXED GRID */}
            <section>
                <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-4">What do you want to report?</label>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-3">
                    {REPORT_TYPES.map((rt) => (
                        <button
                            key={rt.type}
                            onClick={() => handleTypeSelect(rt.type)}
                            className={`p-3 rounded-xl border-2 text-center transition-all flex flex-col items-center justify-center gap-2 min-h-[100px] ${
                                formData.type === rt.type 
                                ? `${rt.color} border-transparent shadow-lg ring-2 ring-offset-2 ring-blue-400 dark:ring-offset-slate-900` 
                                : 'bg-gray-50 dark:bg-white/5 border-transparent hover:bg-gray-100 dark:hover:bg-white/10 text-gray-600 dark:text-gray-400'
                            }`}
                        >
                            <span className="text-2xl">{rt.icon}</span>
                            <span className="font-bold text-xs leading-tight">{rt.type}</span>
                        </button>
                    ))}
                </div>
            </section>

            {/* AI Helper */}
            <section className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                <div className="flex items-start gap-4">
                    <div className="bg-white dark:bg-black p-2 rounded-full shadow-sm text-blue-600"><SparklesIcon className="w-6 h-6" /></div>
                    <div className="flex-1">
                        <label className="block text-sm font-bold text-blue-900 dark:text-blue-100 mb-1">AI Form Assistant</label>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={aiPrompt} 
                                onChange={(e) => setAiPrompt(e.target.value)} 
                                onKeyDown={(e) => e.key === 'Enter' && handleQuickAiReport()}
                                placeholder={`Describe the ${formData.type.toLowerCase()}...`} 
                                className="flex-1 p-2 text-sm border border-blue-200 dark:border-blue-700 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-black/30 dark:text-white"
                            />
                            <Button onClick={handleQuickAiReport} disabled={isAiLoading || !aiPrompt.trim()}>
                                {isAiLoading ? 'Analyzing...' : 'Auto-Fill'}
                            </Button>
                        </div>
                    </div>
                </div>
            </section>

            {/* Main Form */}
            {!isLeadership && (
                <>
                    <section>
                        <h3 className="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Event Details</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormField label="Project">
                                <select value={formData.project_id} onChange={e => handleChange('project_id', e.target.value)} className="w-full p-2.5 border dark:border-dark-border bg-white dark:bg-dark-background rounded-lg text-gray-900 dark:text-white">
                                    {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                            </FormField>
                            <FormField label="Event Date & Time">
                                <input type="datetime-local" value={formData.occurred_at} onChange={e => handleChange('occurred_at', e.target.value)} className="w-full p-2.5 border dark:border-dark-border bg-white dark:bg-dark-background rounded-lg text-gray-900 dark:text-white" />
                            </FormField>
                            <div className="md:col-span-2">
                                <FormField label="Location" fullWidth>
                                    <div className="flex items-center space-x-2">
                                        <input type="text" value={formData.location.text} onChange={e => handleLocationChange('text', e.target.value)} className="w-full p-2.5 border dark:border-dark-border bg-white dark:bg-dark-background rounded-lg text-gray-900 dark:text-white" placeholder="e.g. Loading Dock, Sector 4" />
                                        <Button variant="secondary" onClick={handleGetGps} leftIcon={<GpsIcon />}>GPS</Button>
                                    </div>
                                </FormField>
                            </div>
                        </div>
                        <div className="mt-4 space-y-4">
                             <FormField label="Description" fullWidth>
                                <textarea value={formData.description} onChange={e => handleChange('description', e.target.value)} rows={3} className="w-full p-3 border dark:border-dark-border bg-white dark:bg-dark-background rounded-lg text-gray-900 dark:text-white" placeholder="Describe what happened in detail..." />
                             </FormField>
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <FormField label="Immediate Actions"><textarea value={formData.immediate_actions} onChange={e => handleChange('immediate_actions', e.target.value)} rows={2} className="w-full p-3 border dark:border-dark-border bg-white dark:bg-dark-background rounded-lg text-gray-900 dark:text-white" /></FormField>
                                <FormField label="Conditions"><textarea value={formData.conditions} onChange={e => handleChange('conditions', e.target.value)} rows={2} className="w-full p-3 border dark:border-dark-border bg-white dark:bg-dark-background rounded-lg text-gray-900 dark:text-white" /></FormField>
                             </div>
                        </div>
                    </section>

                    {isInjuryType && (
                        <section className="bg-red-50 dark:bg-red-900/10 p-4 rounded-xl border border-red-200 dark:border-red-800">
                            <h3 className="text-md font-bold mb-3 text-red-800 dark:text-red-300">Injury Details</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField label="Injured Person Name"><input type="text" value={(formData.details as AccidentDetails).person_name} onChange={e => handleDetailsChange('person_name', e.target.value)} className="w-full p-2 border rounded-lg bg-white dark:bg-black/20" /></FormField>
                                <FormField label="Nature of Injury">
                                    <select value={(formData.details as AccidentDetails).nature_of_injury} onChange={e => handleDetailsChange('nature_of_injury', e.target.value)} className="w-full p-2 border rounded-lg bg-white dark:bg-black/20">
                                        <option>Laceration</option><option>Burn</option><option>Fracture</option><option>Sprain</option><option>Other</option>
                                    </select>
                                </FormField>
                            </div>
                        </section>
                    )}

                    <section className="border-t dark:border-dark-border pt-4">
                        <h3 className="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Risk Assessment</h3>
                        <RiskMatrixInput value={formData.risk_pre_control} onChange={(val) => setFormData((p: any) => ({...p, risk_pre_control: val}))} />
                    </section>
                </>
            )}

            {/* Evidence Upload */}
            <section className="border-t dark:border-dark-border pt-6">
                 <h3 className="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Evidence</h3>
                 <div className="grid grid-cols-1 gap-4">
                    <FormField label="Photo/Video Evidence">
                        <div className="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-6 text-center hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                            <input type="file" multiple onChange={handleFileChange} className="hidden" id="file-upload" />
                            <label htmlFor="file-upload" className="cursor-pointer flex flex-col items-center">
                                <span className="text-4xl mb-2">ðŸ“·</span>
                                <span className="text-sm font-medium text-blue-600 dark:text-blue-400">Click to upload photos or videos</span>
                                <span className="text-xs text-gray-500">Supports JPG, PNG, MP4</span>
                            </label>
                            {evidenceFiles.length > 0 && (
                                <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {evidenceFiles.map((file, index) => (
                                        <div key={index} className="relative group bg-gray-100 dark:bg-white/10 p-2 rounded-lg flex items-center gap-2">
                                            <div className="w-8 h-8 bg-gray-300 rounded flex-shrink-0"></div>
                                            <span className="text-xs truncate flex-1 dark:text-white">{file.name}</span>
                                            <button onClick={() => handleRemoveFile(index)} className="text-red-500 hover:text-red-700 font-bold px-2">Ã—</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </FormField>
                 </div>
            </section>
            
            {error && <p className="text-sm text-red-500 mt-4 text-center font-semibold bg-red-50 p-2 rounded">{error}</p>}
        </div>
        
        <div className="bg-gray-50 dark:bg-dark-card px-6 py-4 flex justify-end space-x-3 border-t dark:border-dark-border rounded-b-xl sticky bottom-0 z-10">
            <Button variant="secondary" onClick={onClose} disabled={isSubmitting}>Cancel</Button>
            <Button onClick={handleSubmit} disabled={isSubmitting} className="bg-green-600 hover:bg-green-700 text-white shadow-lg shadow-green-900/20">
                {isSubmitting ? uploadProgress || 'Submitting...' : 'Submit Report'}
            </Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\ReportDetailModal.tsx
==================================================

import React, { useState } from 'react';
import type { Report, User, ReportStatus, CapaAction, AccidentDetails, IncidentDetails, NearMissDetails, UnsafeActDetails, UnsafeConditionDetails, LeadershipEventDetails, RootCause, ReportClassification } from '../types';
import { Card } from './ui/Card';
import { Badge } from './ui/Badge';
import { Button } from './ui/Button';
import ReactMarkdown from 'react-markdown';
import { generateReportSummary } from '../services/geminiService';
import { getRiskLevel } from '../utils/riskUtils';
import { RiskMatrixDisplay } from './RiskMatrixDisplay';
import { AuditTrail } from './AuditTrail';
import { useAppContext } from '../contexts';
import { ActionsBar } from './ui/ActionsBar';
import { EmailModal } from './ui/EmailModal';

interface ReportDetailModalProps {
  report: Report;
  users: User[];
  activeUser: User;
  onClose: () => void;
  onStatusChange: (reportId: string, newStatus: ReportStatus) => void;
  onCapaActionChange: (reportId: string, capaIndex: number, newStatus: CapaAction['status']) => void;
  onAcknowledgeReport: (reportId: string) => void;
}

const ALL_CAPA_STATUSES: CapaAction['status'][] = ['Open', 'In Progress', 'Closed'];

type Tab = 'details' | 'capa' | 'distribution' | 'audit';

const TabButton: React.FC<{ label: string; isActive: boolean; onClick: () => void; }> = ({ label, isActive, onClick }) => (
    <button onClick={onClick} className={`px-4 py-2 text-sm font-medium border-b-2 ${isActive ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
        {label}
    </button>
);

const Section: React.FC<{ title: string; children: React.ReactNode; fullWidth?: boolean }> = ({ title, children, fullWidth = false }) => (
  <div className={`py-4 border-b dark:border-dark-border ${fullWidth ? 'col-span-2' : ''}`}>
    <h3 className="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">{title}</h3>
    <div className="text-gray-800 dark:text-gray-200">{children || 'N/A'}</div>
  </div>
);

export const ReportDetailModal: React.FC<ReportDetailModalProps> = (props) => {
  const { report, users = [], activeUser, onClose, onStatusChange, onCapaActionChange, onAcknowledgeReport } = props;
  const { can } = useAppContext();
  const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);
  const [aiSummary, setAiSummary] = useState('');
  const [isLoadingSummary, setIsLoadingSummary] = useState(false);
  const [activeTab, setActiveTab] = useState<Tab>('details');
  
  if (!report) return null;

  const canApprove = can('approve', 'reports');
  const [editedClassification, setEditedClassification] = useState<ReportClassification>(report.classification || 'To Be Determined');
  const [editedRootCause, setEditedRootCause] = useState<RootCause | undefined>(report.root_cause);

  const handleGenerateSummary = async () => {
    setIsLoadingSummary(true);
    const summary = await generateReportSummary(JSON.stringify(report, null, 2));
    setAiSummary(summary);
    setIsLoadingSummary(false);
  };

  const getUser = (userId: string) => {
      if (!users || !userId) return { name: 'Unknown User' };
      return users.find(u => u.id === userId) || { name: 'Unknown User' };
  };
  
  const safeRiskMatrix = report.risk_pre_control || { severity: 1, likelihood: 1 };
  const risk = getRiskLevel(safeRiskMatrix);

  const acknowledgements = report.acknowledgements || [];
  const distributionList = report.distribution?.user_ids || [];
  const capaList = report.capa || [];
  const auditList = report.audit_trail || [];

  const hasAcknowledged = acknowledgements.some(ack => ack.user_id === activeUser?.id);
  const canAcknowledge = distributionList.includes(activeUser?.id) && !hasAcknowledged;

  const isCreator = report.creator_id === activeUser?.id;
  const isHighOrCritical = risk.level === 'High' || risk.level === 'Critical';
  const selfApprovalBlocked = isCreator && isHighOrCritical;

  const renderDetails = () => {
      const details = report.details || {}; 
      
      if (['Incident', 'Accident', 'First Aid Case (FAC)', 'Medical Treatment Case (MTC)', 'Lost Time Injury (LTI)', 'Restricted Work Case (RWC)'].includes(report.type)) {
          const acc = details as AccidentDetails;
          return <><Section title="Injured Person">{acc.person_name}</Section><Section title="Nature of Injury">{acc.nature_of_injury}</Section><Section title="Body Part Affected">{acc.body_part_affected}</Section><Section title="Treatment Given">{acc.treatment_given}</Section></>;
      }
      if (['Property / Asset Damage', 'Environmental Incident', 'Fire Event'].includes(report.type)) {
          const inc = details as IncidentDetails;
          return <><Section title="Property Damage">{inc.property_damage_details || 'N/A'}</Section>{inc.environmental_impact && <Section title="Environmental Impact" fullWidth>{inc.environmental_impact.type_of_impact}: {inc.environmental_impact.quantity_extent}</Section>}</>;
      }
      if (report.type === 'Near Miss') {
          const nm = details as NearMissDetails;
          return <Section title="Potential Consequence">{nm.potential_consequence}</Section>;
      }
      if (report.type === 'Unsafe Act') {
          const ua = details as UnsafeActDetails;
          return <><Section title="Act Category">{ua.act_category}</Section><Section title="Coaching Given">{ua.coaching_given ? `Yes: ${ua.coaching_notes || ''}` : 'No'}</Section></>;
      }
      if (report.type === 'Unsafe Condition') {
          const uc = details as UnsafeConditionDetails;
          return <><Section title="Condition Category">{uc.condition_category}</Section><Section title="Temporary Control">{uc.temporary_control_applied}</Section></>;
      }
      if (report.type === 'Leadership Event' || report.type === 'Positive Observation') {
          const le = details as LeadershipEventDetails;
          return (
              <>
                <Section title="Event Code"><Badge color="purple">{le.event_type_code || 'N/A'}</Badge></Section>
                <Section title="Leader">{le.leader_name}</Section>
                <Section title="Participants">{le.attendees_count}</Section>
                <Section title="Key Observations" fullWidth>{le.key_observations}</Section>
              </>
          );
      }
      return <p className="col-span-2 text-gray-500 italic p-4">No specific details recorded for this category.</p>;
  }
  
  return (
    <>
      <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4 print:hidden" onClick={onClose} aria-modal="true" role="dialog" aria-labelledby="report-title">
        <div className="bg-white dark:bg-dark-card rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col" onClick={e => e.stopPropagation()}>
          <header className="p-4 border-b dark:border-dark-border flex justify-between items-center flex-shrink-0">
            <div>
              <h2 id="report-title" className="text-xl font-bold text-gray-900 dark:text-gray-100 truncate max-w-2xl">{report.type} - {report.id}</h2>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                  Reported by {getUser(report.reporter_id)?.name} on {report.reported_at ? new Date(report.reported_at).toLocaleDateString() : 'N/A'}
              </p>
            </div>
            <div className="flex items-center gap-4">
              <ActionsBar onPrint={() => window.print()} onDownloadPdf={() => window.print()} onEmail={() => setIsEmailModalOpen(true)} />
              <button onClick={onClose} aria-label="Close modal" className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><CloseIcon/></button>
            </div>
          </header>

          <div className="flex-grow flex overflow-hidden">
            <main className="flex-1 p-6 overflow-y-auto">
              <div className="flex justify-between items-start mb-4">
                 <div className="flex gap-2 flex-wrap">
                    {report.classification_codes?.map(code => <Badge key={code} color="gray">{code}</Badge>)}
                    <Badge color={risk.color} size="md">{risk.level} Risk</Badge>
                 </div>
                 <Badge color={report.status === 'closed' ? 'green' : 'blue'}>{report.status?.replace('_', ' ') || 'Unknown'}</Badge>
              </div>
              
              {['Leadership Event', 'Positive Observation'].includes(report.type) ? (
                  <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg mb-6 border border-blue-100 dark:border-blue-800">
                      <h3 className="text-lg font-bold text-blue-800 dark:text-blue-300 mb-2">Leadership Engagement</h3>
                      <p className="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">{(report.details as LeadershipEventDetails)?.key_observations || 'No observations.'}</p>
                  </div>
              ) : (
                  <p className="text-gray-700 dark:text-gray-300 mb-6">{report.description || 'No description provided.'}</p>
              )}
              
              <div className="border-b dark:border-dark-border mb-4">
                <nav className="-mb-px flex space-x-4 overflow-x-auto">
                    <TabButton label="Details" isActive={activeTab === 'details'} onClick={() => setActiveTab('details')} />
                    <TabButton label="CAPA" isActive={activeTab === 'capa'} onClick={() => setActiveTab('capa')} />
                    <TabButton label="Distribution & Ack." isActive={activeTab === 'distribution'} onClick={() => setActiveTab('distribution')} />
                    <TabButton label="Audit Trail" isActive={activeTab === 'audit'} onClick={() => setActiveTab('audit')} />
                </nav>
              </div>
              
              <div className={activeTab === 'details' ? '' : 'hidden'}>
                {!['Leadership Event', 'Positive Observation'].includes(report.type) && (
                    <Card title="AI Executive Summary" actions={<Button variant="ghost" size="sm" onClick={handleGenerateSummary} disabled={isLoadingSummary}>{isLoadingSummary ? 'Generating...': 'âœ¨ Generate'}</Button>}>
                        {isLoadingSummary && <p className="text-sm text-gray-500">AI is analyzing the report...</p>}
                        {aiSummary && <div className="prose prose-sm max-w-none dark:prose-invert"><ReactMarkdown>{aiSummary}</ReactMarkdown></div>}
                        {!aiSummary && !isLoadingSummary && <p className="text-sm text-gray-500">Click "Generate" to create an AI-powered summary of this report.</p>}
                    </Card>
                )}

                <div className="grid grid-cols-2 gap-x-6 mt-4">
                    <Section title="Location">
                        {report.location?.text || 'Unknown'} {report.location?.specific_area ? `- ${report.location.specific_area}` : ''}
                    </Section>
                    <Section title="Date & Time">{report.occurred_at ? new Date(report.occurred_at).toLocaleString() : 'Unknown'}</Section>
                    
                    {!['Leadership Event', 'Positive Observation'].includes(report.type) && <Section title="Conditions">{report.conditions || 'N/A'}</Section>}
                    {!['Leadership Event', 'Positive Observation'].includes(report.type) && <Section title="Immediate Actions">{report.immediate_actions || 'N/A'}</Section>}
                    
                    {renderDetails()}
                    
                    {!['Leadership Event', 'Positive Observation'].includes(report.type) && (
                        <Section title="Initial Risk Assessment" fullWidth>
                            <RiskMatrixDisplay matrix={safeRiskMatrix} />
                        </Section>
                    )}
                    {report.ai_suggested_evidence && report.ai_suggested_evidence.length > 0 && (
                        <Section title="AI Suggested Evidence" fullWidth>
                            <ul className="list-disc list-inside text-sm text-blue-600 dark:text-blue-400">
                                {report.ai_suggested_evidence.map((ev, i) => <li key={i}>{ev}</li>)}
                            </ul>
                        </Section>
                    )}
                    
                    {report.evidence_urls && report.evidence_urls.length > 0 && (
                        <Section title="Evidence Photos" fullWidth>
                            <div className="flex gap-2 flex-wrap">
                                {report.evidence_urls.map((url, i) => (
                                    <a key={i} href={url} target="_blank" rel="noreferrer">
                                        <img src={url} alt="Evidence" className="w-24 h-24 object-cover rounded-md border border-gray-300 hover:opacity-75 transition-opacity" />
                                    </a>
                                ))}
                            </div>
                        </Section>
                    )}
                </div>
              </div>
              
              <div className={activeTab === 'capa' ? '' : 'hidden'}>
                <Card title="Corrective & Preventive Actions (CAPA)">
                  {canApprove && !['Leadership Event', 'Positive Observation'].includes(report.type) && (
                    <div className="grid grid-cols-2 gap-x-6 mb-4 p-4 border rounded-md bg-gray-50 dark:bg-dark-background">
                       <Section title="Classification">
                          <select value={editedClassification} onChange={e => setEditedClassification(e.target.value as ReportClassification)} className="w-full p-2 border dark:border-dark-border bg-transparent rounded-md">
                            {(['To Be Determined', 'Minor', 'Moderate', 'Major', 'Fatal'] as ReportClassification[]).map(c => <option key={c} value={c}>{c}</option>)}
                          </select>
                       </Section>
                       <Section title="Root Cause">
                         <select value={editedRootCause || 'Other'} onChange={e => setEditedRootCause(e.target.value as RootCause)} className="w-full p-2 border dark:border-dark-border bg-transparent rounded-md">
                             {(['Human Error', 'Equipment Failure', 'Process Deficiency', 'Environment', 'Other'] as RootCause[]).map(c => <option key={c} value={c}>{c}</option>)}
                         </select>
                       </Section>
                    </div>
                  )}
                  <div className="space-y-4">
                      {capaList.map((action, index) => (
                        <div key={index} className="p-3 border rounded-md">
                          <p className={`font-semibold text-sm ${action.type === 'Corrective' ? 'text-blue-600' : 'text-purple-600'}`}>{action.type} Action</p>
                          <p className="text-gray-800 dark:text-gray-200">{action.action}</p>
                          <div className="text-xs text-gray-500 mt-2 flex justify-between items-center">
                              <span>Owner: {getUser(action.owner_id)?.name} | Due: {action.due_date ? new Date(action.due_date).toLocaleDateString() : 'No Date'}</span>
                              <select 
                                value={action.status} 
                                onChange={(e) => onCapaActionChange(report.id, index, e.target.value as CapaAction['status'])}
                                className="p-1 border rounded bg-transparent"
                                disabled={activeUser.id !== action.owner_id && !canApprove}
                              >
                                {ALL_CAPA_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                              </select>
                          </div>
                        </div>
                      ))}
                      {capaList.length === 0 && <p className="text-sm text-gray-500 text-center">No CAPA items assigned yet.</p>}
                  </div>
                </Card>
              </div>

              <div className={activeTab === 'distribution' ? '' : 'hidden'}>
                  <Card title="Distribution & Acknowledgements">
                      <ul className="space-y-3">
                          {distributionList.map(userId => {
                              const user = getUser(userId);
                              const ack = acknowledgements.find(a => a.user_id === userId);
                              return (
                                  <li key={userId} className="flex justify-between items-center p-2 bg-gray-50 dark:bg-dark-background rounded-md">
                                      <span className="font-semibold text-sm">{user?.name}</span>
                                      {ack ? (
                                          <span className="text-xs text-green-600">Acknowledged on {new Date(ack.acknowledged_at).toLocaleDateString()}</span>
                                      ) : (
                                          <span className="text-xs text-yellow-600">Pending</span>
                                      )}
                                  </li>
                              )
                          })}
                          {distributionList.length === 0 && <p className="text-gray-500 text-sm italic">No distribution list defined.</p>}
                      </ul>
                  </Card>
              </div>
              
              <div className={activeTab === 'audit' ? '' : 'hidden'}>
                <AuditTrail logs={auditList} users={users} />
              </div>

            </main>
          </div>
          
          <footer className="p-4 border-t dark:border-dark-border bg-gray-100 dark:bg-black/20 flex-shrink-0 flex justify-between items-center">
            {canAcknowledge && <Button variant="secondary" onClick={() => onAcknowledgeReport(report.id)}>Acknowledge Receipt</Button>}
            <div></div>
            {canApprove && report.status !== 'closed' && (
                <div className="flex items-center space-x-2">
                    <Button variant="secondary">Request More Info</Button>
                    <Button 
                      onClick={() => onStatusChange(report.id, 'closed')} 
                      disabled={selfApprovalBlocked}
                      title={selfApprovalBlocked ? "Cannot approve a High/Critical report you created." : ""}
                    >
                      Verify & Close Report
                    </Button>
                </div>
            )}
          </footer>
        </div>
      </div>
      <EmailModal 
        isOpen={isEmailModalOpen}
        onClose={() => setIsEmailModalOpen(false)}
        documentTitle={`Report: ${report.type} - ${report.id}`}
        documentLink={`${window.location.href}?report=${report.id}`}
        defaultRecipients={report.distribution?.user_ids?.map(id => users.find(u => u.id === id)).filter(Boolean) as User[] || []}
      />
    </>
  );
};

const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;

==================================================
FILE: .\src\components\Reports.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { Report, ReportStatus, ReportType } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useDataContext, useModalContext, useAppContext } from '../contexts';
import { getRiskLevel } from '../utils/riskUtils'; // Imported from utils

const ReportCard: React.FC<{report: Report, onSelect: (report: Report) => void}> = ({ report, onSelect }) => {
    const risk = getRiskLevel(report.risk_pre_control);
    
    return (
        <Card onClick={() => onSelect(report)} className="hover:shadow-md hover:border-primary-300 transition-all cursor-pointer">
            <div className="flex justify-between items-start">
                <h3 className="font-bold text-md text-text-primary pr-2 truncate">{report.type}</h3>
                <Badge color={risk.color}>{risk.level} Risk</Badge>
            </div>
            <p className="text-sm text-text-secondary mt-2 line-clamp-2">{report.description || (report.details as any).key_observations}</p>
            <div className="text-xs text-gray-500 mt-4 space-y-1">
                <div className="flex items-center">
                    <MapPinIcon className="w-4 h-4 mr-2" />
                    <span>{report.location.text}</span>
                </div>
                <div className="flex items-center">
                    <CalendarIcon className="w-4 h-4 mr-2" />
                    <span>{new Date(report.occurred_at).toLocaleDateString()}</span>
                </div>
                {report.classification_codes && report.classification_codes.length > 0 && (
                    <div className="flex gap-1 mt-2">
                        {report.classification_codes.map(code => <span key={code} className="px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-700 text-[10px] font-mono">{code}</span>)}
                    </div>
                )}
            </div>
        </Card>
    )
}

const FilterButton: React.FC<{label: string, value: string, currentFilter: string, setFilter: (val: string) => void}> = ({ label, value, currentFilter, setFilter }) => (
    <button
        onClick={() => setFilter(value)}
        className={`px-3 py-1 text-sm font-medium rounded-full whitespace-nowrap ${
            currentFilter === value ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-white/10 dark:text-white dark:hover:bg-white/20'
        }`}
    >
        {label}
    </button>
)

const REPORT_CATEGORIES: ReportType[] = [
    'Incident', 'Accident', 'Near Miss', 'Unsafe Act', 'Unsafe Condition',
    'First Aid Case (FAC)', 'Medical Treatment Case (MTC)', 'Lost Time Injury (LTI)',
    'Restricted Work Case (RWC)', 'Property / Asset Damage', 'Environmental Incident',
    'Fire Event', 'Leadership Event', 'Positive Observation'
];

export const Reports: React.FC = () => {
  const { reportList } = useDataContext();
  const { setSelectedReport, setIsReportCreationModalOpen } = useModalContext();
  const { can } = useAppContext();

  const [typeFilter, setTypeFilter] = useState('All');
  const [riskFilter, setRiskFilter] = useState('All');
  const [statusFilter, setStatusFilter] = useState<ReportStatus | 'All'>('All');

  const filteredReports = useMemo(() => {
    return reportList.filter(report => {
        const typeMatch = typeFilter === 'All' || report.type === typeFilter;
        const riskMatch = riskFilter === 'All' || getRiskLevel(report.risk_pre_control).level === riskFilter;
        const statusMatch = statusFilter === 'All' || report.status === statusFilter;
        return typeMatch && riskMatch && statusMatch;
    });
  }, [reportList, typeFilter, riskFilter, statusFilter]);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-text-primary">Incident Reporting</h1>
        {can('create', 'reports') && (
            <Button onClick={() => setIsReportCreationModalOpen(true)}>
              <PlusIcon className="w-5 h-5 mr-2" />
              New Report
            </Button>
        )}
      </div>

      <Card className="mb-6">
        <div className="space-y-4">
            <div>
                <label className="text-sm font-semibold text-gray-600 dark:text-gray-400">Report Type</label>
                <div className="flex flex-wrap gap-2 mt-2">
                    <FilterButton label="All" value="All" currentFilter={typeFilter} setFilter={setTypeFilter} />
                    {REPORT_CATEGORIES.map(t => <FilterButton key={t} label={t} value={t} currentFilter={typeFilter} setFilter={setTypeFilter} />)}
                </div>
            </div>
             <div>
                <label className="text-sm font-semibold text-gray-600 dark:text-gray-400">Risk Level</label>
                <div className="flex flex-wrap gap-2 mt-2">
                    <FilterButton label="All" value="All" currentFilter={riskFilter} setFilter={setRiskFilter} />
                    {['Low', 'Medium', 'High', 'Critical'].map(c => <FilterButton key={c} label={c} value={c} currentFilter={riskFilter} setFilter={setRiskFilter} />)}
                </div>
            </div>
            <div>
                <label className="text-sm font-semibold text-gray-600 dark:text-gray-400">Status</label>
                <div className="flex flex-wrap gap-2 mt-2">
                    <FilterButton label="All" value="All" currentFilter={statusFilter} setFilter={setStatusFilter as (val: string) => void} />
                    {['under_review', 'submitted', 'closed', 'active'].map(s => <FilterButton key={s} label={s.replace('_', ' ')} value={s} currentFilter={statusFilter} setFilter={setStatusFilter as (val: string) => void} />)}
                </div>
            </div>
        </div>
      </Card>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredReports.map(report => (
            <ReportCard key={report.id} report={report} onSelect={setSelectedReport} />
        ))}
        {filteredReports.length === 0 && (
            <div className="col-span-full text-center py-12 text-gray-500">
                <p>No reports match the current filters.</p>
            </div>
        )}
      </div>
    </div>
  );
};

const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => (
  <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
  </svg>
);
const MapPinIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
    </svg>
);
const CalendarIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h27" />
    </svg>
);

==================================================
FILE: .\src\components\RiskMatrixDisplay.tsx
==================================================


import React from 'react';
import type { RiskMatrix } from '../types';

interface RiskMatrixDisplayProps {
  matrix: RiskMatrix;
}

const severityLabels = ['Insignificant', 'Minor', 'Moderate', 'Major', 'Catastrophic'];
const likelihoodLabels = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];

const getRiskColor = (severity: number, likelihood: number): string => {
    const score = severity * likelihood;
    if (score >= 15) return 'bg-red-600 text-white';
    if (score >= 9) return 'bg-orange-500 text-white';
    if (score >= 4) return 'bg-yellow-400 text-gray-800';
    return 'bg-green-500 text-white';
};

export const RiskMatrixDisplay: React.FC<RiskMatrixDisplayProps> = ({ matrix }) => {
  return (
    <div className="flex space-x-4 items-center">
      <div className="flex-shrink-0">
        <table className="border-collapse text-xs text-center">
          <tbody>
            {Array.from({ length: 5 }).map((_, rowIndex) => (
              <tr key={rowIndex}>
                {Array.from({ length: 5 }).map((_, colIndex) => {
                  const severity = 5 - rowIndex;
                  const likelihood = colIndex + 1;
                  const isSelected = matrix.severity === severity && matrix.likelihood === likelihood;
                  return (
                    <td
                      key={colIndex}
                      className={`w-8 h-8 border border-gray-300 ${getRiskColor(severity, likelihood)} ${isSelected ? 'ring-2 ring-offset-1 ring-blue-500' : ''}`}
                    >
                      {severity * likelihood}
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div>
        <p><span className="font-semibold">Severity:</span> {severityLabels[matrix.severity - 1] || 'N/A'} ({matrix.severity})</p>
        <p><span className="font-semibold">Likelihood:</span> {likelihoodLabels[matrix.likelihood - 1] || 'N/A'} ({matrix.likelihood})</p>
      </div>
    </div>
  );
};


==================================================
FILE: .\src\components\RiskMatrixInput.tsx
==================================================

import React from 'react';
import type { RiskMatrix, Severity, Likelihood } from '../types';
import { getRiskLevel } from '../utils/riskUtils'; // Imported from utils

interface RiskMatrixInputProps {
  value: RiskMatrix;
  onChange: (value: RiskMatrix) => void;
}

const severityLabels = ['Insignificant', 'Minor', 'Moderate', 'Major', 'Catastrophic'];
const likelihoodLabels = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];

const getRiskColorClass = (severity: number, likelihood: number): string => {
    const score = severity * likelihood;
    if (score >= 15) return 'bg-red-200 hover:bg-red-300';
    if (score >= 9) return 'bg-orange-200 hover:bg-orange-300';
    if (score >= 4) return 'bg-yellow-200 hover:bg-yellow-300';
    return 'bg-green-200 hover:bg-green-300';
};

export const RiskMatrixInput: React.FC<RiskMatrixInputProps> = ({ value, onChange }) => {
  const currentRisk = getRiskLevel(value);

  return (
    <div>
        <div className="flex flex-col md:flex-row gap-4">
            <div className="flex-shrink-0">
                <div className="flex">
                    <div className="w-12 text-xs flex items-center justify-center transform -rotate-90 text-gray-500 font-semibold">Severity</div>
                    <div className="grid grid-cols-5 gap-1">
                        {Array.from({ length: 5 }).map((_, rowIndex) => 
                            Array.from({ length: 5 }).map((_, colIndex) => {
                                const severity = (5 - rowIndex) as Severity;
                                const likelihood = (colIndex + 1) as Likelihood;
                                const isSelected = value.severity === severity && value.likelihood === likelihood;
                                return (
                                    <button
                                        type="button"
                                        key={`${rowIndex}-${colIndex}`}
                                        onClick={() => onChange({ severity, likelihood })}
                                        className={`w-12 h-12 rounded-md text-sm font-bold transition-all duration-150 ${getRiskColorClass(severity, likelihood)} ${isSelected ? 'ring-2 ring-primary-500' : ''}`}
                                    >
                                        {severity * likelihood}
                                    </button>
                                )
                            })
                        )}
                         <div className="col-span-5 text-center text-xs text-gray-500 font-semibold mt-1">Likelihood</div>
                    </div>
                </div>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg flex-grow">
                <h4 className="font-bold text-lg">Calculated Risk</h4>
                <div className={`mt-2 text-2xl font-bold`} style={{ color: currentRisk.color === 'yellow' ? '#ca8a04' : currentRisk.color }}>
                    {currentRisk.level}
                </div>
                <div className="mt-2 text-sm text-gray-600">
                    <p><span className="font-semibold">Severity:</span> {severityLabels[value.severity - 1]} ({value.severity})</p>
                    <p><span className="font-semibold">Likelihood:</span> {likelihoodLabels[value.likelihood - 1]} ({value.likelihood})</p>
                </div>
            </div>
        </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Roles.tsx
==================================================

import React, { useState } from 'react';
import type { Role, Resource, Action } from '../types';
import { allPossiblePermissions } from '../config';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { useAppContext } from '../contexts';

interface RolesProps {
  roles: Role[];
}

const PermissionRow: React.FC<{ resource: Resource, actions: Action[], rolePermissions: any, onPermissionChange: any }> = ({ resource, actions, rolePermissions, onPermissionChange }) => {
  return (
    <tr className="border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors">
      <td className="py-3 px-4 font-semibold capitalize text-slate-900 dark:text-slate-100">
        {resource.replace('_', ' ')}
      </td>
      {allPossiblePermissions.find(p => p.resource === 'reports')!.actions.map(action => (
        <td key={action} className="py-3 px-4 text-center">
          {actions.includes(action) ? (
            <input
              type="checkbox"
              className="h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 cursor-pointer"
              checked={rolePermissions[resource]?.actions.includes(action) || false}
              onChange={(e) => onPermissionChange(resource, action, e.target.checked)}
            />
          ) : (
            <span className="block w-4 h-4 mx-auto bg-gray-100 dark:bg-slate-800 rounded-sm opacity-50"></span>
          )}
        </td>
      ))}
    </tr>
  );
};

export const Roles: React.FC<RolesProps> = ({ roles: initialRoles }) => {
  const { can } = useAppContext();
  const [roles] = useState(initialRoles);
  const [selectedRole, setSelectedRole] = useState<Role>(roles[0]);

  const handlePermissionChange = (resource: Resource, action: Action, checked: boolean) => {
    setSelectedRole(prevRole => {
      const newPermissions = [...prevRole.permissions];
      const permissionIndex = newPermissions.findIndex(p => p.resource === resource);
      
      if (permissionIndex > -1) {
        const existingActions = newPermissions[permissionIndex].actions;
        if (checked && !existingActions.includes(action)) {
          newPermissions[permissionIndex].actions.push(action);
        } else if (!checked) {
          newPermissions[permissionIndex].actions = existingActions.filter(a => a !== action);
        }
      } else if (checked) {
        newPermissions.push({ resource, actions: [action], scope: 'org' });
      }

      return { ...prevRole, permissions: newPermissions };
    });
  };
  
  const getRolePermissionsMap = (role: Role) => {
    return role.permissions.reduce((acc, p) => {
      acc[p.resource] = { actions: p.actions, scope: p.scope };
      return acc;
    }, {} as Record<Resource, { actions: Action[], scope: any }>);
  };
  
  const rolePermissionsMap = getRolePermissionsMap(selectedRole);

  return (
    <div>
        <div className="flex justify-between items-center mb-6">
            <div>
                <h1 className="text-3xl font-bold text-white">Roles & Permissions</h1>
                <p className="text-slate-400 mt-1">Manage access levels and system capabilities</p>
            </div>
            {can('create', 'roles') && (
                <Button>
                    <PlusIcon className="w-5 h-5 mr-2" />
                    Create Role
                </Button>
            )}
        </div>

      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div className="md:col-span-1">
          <Card className="p-0 overflow-hidden">
            <div className="p-4 border-b dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50">
                <h3 className="font-bold text-slate-800 dark:text-white">Available Roles</h3>
            </div>
            <ul className="divide-y dark:divide-slate-700">
              {roles.map((role) => (
                <li key={role.key}>
                  <button
                    onClick={() => setSelectedRole(role)}
                    className={`w-full text-left px-4 py-3 text-sm transition-all duration-200 ${
                      selectedRole.key === role.key 
                        ? 'bg-primary-50 text-primary-700 font-bold border-l-4 border-primary-600 dark:bg-primary-900/20 dark:text-primary-400' 
                        : 'text-slate-600 hover:bg-gray-50 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200 border-l-4 border-transparent'
                    }`}
                  >
                    <div className="flex justify-between items-center">
                        <span>{role.label}</span>
                        {role.is_system && (
                            <span className="text-[10px] uppercase tracking-wider bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded dark:bg-slate-700 dark:text-slate-400">
                                System
                            </span>
                        )}
                    </div>
                  </button>
                </li>
              ))}
            </ul>
          </Card>
        </div>

        <div className="md:col-span-3">
          <Card>
             <div className="border-b dark:border-slate-700 pb-4 mb-4 flex justify-between items-center">
                <div>
                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{selectedRole.label}</h2>
                    <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        Configure resource access and functional permissions for this role.
                    </p>
                </div>
                <Button>Save Changes</Button>
            </div>
            
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead className="bg-gray-50 dark:bg-slate-800">
                  <tr className="border-b dark:border-slate-700">
                    <th className="py-3 px-4 text-left font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider text-xs">Resource</th>
                    {allPossiblePermissions.find(p => p.resource === 'reports')!.actions.map(action => (
                      <th key={action} className="py-3 px-4 text-center font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider text-xs w-24">
                          {action}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="divide-y dark:divide-slate-700">
                  {allPossiblePermissions.map(p => (
                    <PermissionRow 
                      key={p.resource}
                      resource={p.resource}
                      actions={p.actions}
                      rolePermissions={rolePermissionsMap}
                      onPermissionChange={handlePermissionChange}
                    />
                  ))}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      </div>
    </div>
  );
};

const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
    </svg>
);

==================================================
FILE: .\src\components\SafetyPulseModal.tsx
==================================================

import React, { useState, useEffect } from 'react';
import { Button } from './ui/Button';
import { ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

interface SafetyPulseModalProps {
    isOpen: boolean;
    onClose: () => void;
}

const seriesConfig = {
    incident: { name: 'Incident', color: '#FF5252' },
    unsafeAct: { name: 'Unsafe Act', color: '#FFB300' },
    unsafeCondition: { name: 'Unsafe Condition', color: '#42A5F5' },
    positiveObservation: { name: 'Positive Observation', color: '#66BB6A' },
};
type SeriesKey = keyof typeof seriesConfig;

const generateModalData = (minutes: number) => {
    const data = [];
    const now = new Date();
    for (let i = minutes - 1; i >= 0; i--) {
        const timestamp = new Date(now.getTime() - i * 60000);
        data.push({
            time: timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            incident: Math.random() > 0.98 ? 1 : 0,
            unsafeAct: Math.random() > 0.9 ? Math.floor(Math.random() * 2) + 1 : 0,
            unsafeCondition: Math.random() > 0.92 ? Math.floor(Math.random() * 2) : 0,
            positiveObservation: Math.random() > 0.85 ? Math.floor(Math.random() * 3) + 1 : 0,
        });
    }
    return data;
};

const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
        return (
            <div className="bg-white dark:bg-slate-900 p-3 border border-border-color dark:border-dark-border rounded-lg shadow-lg">
                <p className="font-bold text-text-primary dark:text-dark-text-primary">{label}</p>
                {payload.map((p: any) => (
                    <p key={p.name} style={{ color: p.color }} className="text-sm">
                        {`${p.name}: ${p.value}`}
                    </p>
                ))}
            </div>
        );
    }
    return null;
};

export const SafetyPulseModal: React.FC<SafetyPulseModalProps> = ({ isOpen, onClose }) => {
    const [data, setData] = useState(() => generateModalData(60));
    const [visibleSeries, setVisibleSeries] = useState<Record<SeriesKey, boolean>>({
        incident: true,
        unsafeAct: true,
        unsafeCondition: true,
        positiveObservation: true,
    });

    useEffect(() => {
        if (!isOpen) return;

        const interval = setInterval(() => {
            setData(prevData => {
                if (!prevData || !Array.isArray(prevData)) return generateModalData(60);

                const now = new Date();
                const newDataPoint = {
                    time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    incident: Math.random() > 0.99 ? 1 : 0,
                    unsafeAct: Math.random() > 0.95 ? 1 : 0,
                    unsafeCondition: Math.random() > 0.96 ? 1 : 0,
                    positiveObservation: Math.random() > 0.90 ? 1 : 0,
                };
                return [...prevData.slice(1), newDataPoint];
            });
        }, 5000);

        return () => clearInterval(interval);
    }, [isOpen]);

    const toggleSeries = (key: SeriesKey) => {
        setVisibleSeries(prev => ({ ...prev, [key]: !prev[key] }));
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/60 z-50 flex justify-end" onClick={onClose}>
            <div className="w-full lg:w-3/4 h-full bg-card dark:bg-dark-card shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                <header className="p-4 border-b dark:border-dark-border flex justify-between items-center flex-shrink-0">
                    <div>
                        <h2 className="text-xl font-bold text-text-primary dark:text-dark-text-primary">Live Safety Pulse Analytics</h2>
                        <p className="text-sm text-text-secondary dark:text-dark-text-secondary">Detailed view of real-time safety event rates.</p>
                    </div>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-border">
                        <XIcon className="w-6 h-6 text-text-secondary dark:text-dark-text-secondary" />
                    </button>
                </header>

                <div className="p-4 border-b dark:border-dark-border flex-shrink-0">
                    <div className="flex justify-between items-center">
                         <div className="flex items-center space-x-2">
                             <FilterIcon className="w-5 h-5 text-text-secondary dark:text-dark-text-secondary"/>
                             <select className="p-1 border rounded-md text-sm bg-transparent dark:bg-dark-background dark:border-dark-border"><option>All Projects</option></select>
                         </div>
                         <div className="flex items-center space-x-2">
                             <Button size="sm" variant="secondary">Export PNG</Button>
                         </div>
                    </div>
                </div>

                <main className="flex-grow p-4 overflow-auto">
                    <div className="h-[60vh] w-full">
                        <ResponsiveContainer>
                            <LineChart data={data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(128, 128, 128, 0.2)" />
                                <XAxis dataKey="time" tick={{ fontSize: 12 }} stroke="currentColor" className="text-text-secondary dark:text-dark-text-secondary" />
                                <YAxis tick={{ fontSize: 12 }} stroke="currentColor" className="text-text-secondary dark:text-dark-text-secondary" />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend onClick={(e) => toggleSeries(e.dataKey as SeriesKey)} wrapperStyle={{ fontSize: "12px" }} />
                                {Object.keys(seriesConfig).map(key => (
                                    <Line 
                                        key={key}
                                        type="monotone" 
                                        dataKey={key}
                                        name={seriesConfig[key as SeriesKey].name}
                                        stroke={seriesConfig[key as SeriesKey].color}
                                        strokeWidth={2}
                                        dot={{ r: 3 }}
                                        activeDot={{ r: 6 }}
                                        hide={!visibleSeries[key as SeriesKey]}
                                    />
                                ))}
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </main>
            </div>
        </div>
    );
};

const XIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
const FilterIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.572a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>;

==================================================
FILE: .\src\components\SafetyPulseWidget.tsx
==================================================

import React, { useState, useEffect } from 'react';
import { ResponsiveContainer, AreaChart, Area, XAxis, YAxis, Tooltip, CartesianGrid, ReferenceLine } from 'recharts';

interface SafetyPulseWidgetProps {
    onExpand: () => void;
    stats?: {
        incidents: number;
        unsafeActs: number;
        unsafeConditions: number;
        positiveObs: number;
    };
}

const seriesConfig = {
    incident: { name: 'Incident', color: '#ef4444', gradient: ['#ef4444', '#7f1d1d'] },
    unsafeAct: { name: 'Unsafe Act', color: '#f97316', gradient: ['#f97316', '#7c2d12'] },
    unsafeCondition: { name: 'Unsafe Cond.', color: '#06b6d4', gradient: ['#06b6d4', '#164e63'] },
    positiveObservation: { name: 'Positive Obs.', color: '#10b981', gradient: ['#10b981', '#064e3b'] },
};

// Mock Data Generator
const generateTrendData = (points: number) => {
    const data = [];
    const now = new Date();
    for (let i = points - 1; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 5 * 60000); // 5 min intervals
        data.push({
            time: time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            incident: 0,
            unsafeAct: Math.floor(Math.random() * 3) + 1,
            unsafeCondition: Math.floor(Math.random() * 2),
            positiveObservation: Math.floor(Math.random() * 4) + 1,
        });
    }
    return data;
};

const KPICard: React.FC<{ title: string; value: number; color: string }> = ({ title, value, color }) => (
    <div className="flex flex-col justify-between p-3 bg-white/5 border border-white/10 rounded-lg">
        <div>
            <p className="text-[10px] uppercase tracking-wider text-slate-400 font-bold">{title}</p>
            <p className="text-xl font-bold text-white mt-1">{value}</p>
        </div>
        <div className="flex items-center mt-2">
            <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                <div style={{ width: '60%', backgroundColor: color }} className="h-full rounded-full opacity-80"></div>
            </div>
        </div>
    </div>
);

export const SafetyPulseWidget: React.FC<SafetyPulseWidgetProps> = ({ onExpand, stats }) => {
    // Initialize with function to ensure it runs only once
    const [data, setData] = useState<any[]>(() => generateTrendData(24));
    const [selectedRange, setSelectedRange] = useState('Last 60m');

    useEffect(() => {
        const interval = setInterval(() => {
            setData(prev => {
                // CRITICAL FIX: If prev is undefined/null, reset it
                if (!prev || !Array.isArray(prev)) return generateTrendData(24);

                const nextTime = new Date();
                const newPoint = {
                    time: nextTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    incident: 0,
                    unsafeAct: Math.floor(Math.random() * 3),
                    unsafeCondition: Math.floor(Math.random() * 2),
                    positiveObservation: Math.floor(Math.random() * 3),
                };
                // Safe slice
                return [...prev.slice(1), newPoint];
            });
        }, 4000);
        return () => clearInterval(interval);
    }, []);

    // Default values if stats are loading
    const safeStats = stats || { incidents: 0, unsafeActs: 0, unsafeConditions: 0, positiveObs: 0 };

    return (
        <div className="h-full flex flex-col overflow-hidden bg-slate-900/50 rounded-xl border border-white/10 backdrop-blur-sm">
            {/* Header */}
            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-black/20">
                <div className="flex items-center space-x-3">
                    <h3 className="text-sm font-bold text-white uppercase tracking-widest">Real-Time Safety Pulse</h3>
                    <div className="flex items-center space-x-2 px-2 py-1 rounded-full bg-red-500/10 border border-red-500/30">
                        <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span className="text-[10px] font-bold text-red-400 uppercase tracking-wide">LIVE</span>
                    </div>
                </div>
                <div className="flex space-x-1 bg-white/5 p-1 rounded-lg">
                    {['Last 60m', '24h'].map(range => (
                        <button 
                            key={range}
                            onClick={() => setSelectedRange(range)}
                            className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${selectedRange === range ? 'bg-white/10 text-white' : 'text-slate-500 hover:text-slate-300'}`}
                        >
                            {range}
                        </button>
                    ))}
                    <button onClick={onExpand} className="px-3 py-1 text-xs font-medium text-sky-400 hover:text-white transition-colors">
                        Expand â†—
                    </button>
                </div>
            </div>

            {/* Content Body */}
            <div className="flex flex-1 overflow-hidden">
                {/* Left: Metrics & Chart */}
                <div className="flex-1 flex flex-col p-4">
                    {/* KPI Strip */}
                    <div className="grid grid-cols-4 gap-3 mb-4">
                        <KPICard title="Incidents" value={safeStats.incidents} color={seriesConfig.incident.color} />
                        <KPICard title="Unsafe Acts" value={safeStats.unsafeActs} color={seriesConfig.unsafeAct.color} />
                        <KPICard title="Conditions" value={safeStats.unsafeConditions} color={seriesConfig.unsafeCondition.color} />
                        <KPICard title="Positive Obs." value={safeStats.positiveObs} color={seriesConfig.positiveObservation.color} />
                    </div>

                    {/* Main Chart */}
                    <div className="flex-1 min-h-0 relative w-full h-full" style={{ minHeight: '150px' }}>
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={data} margin={{ top: 10, right: 0, left: -25, bottom: 0 }}>
                                <defs>
                                    {Object.keys(seriesConfig).map(key => (
                                        <linearGradient key={key} id={`grad-${key}`} x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor={(seriesConfig as any)[key].color} stopOpacity={0.4}/>
                                            <stop offset="95%" stopColor={(seriesConfig as any)[key].color} stopOpacity={0}/>
                                        </linearGradient>
                                    ))}
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
                                <XAxis dataKey="time" tick={{fill: '#64748b', fontSize: 10}} axisLine={false} tickLine={false} />
                                <YAxis tick={{fill: '#64748b', fontSize: 10}} axisLine={false} tickLine={false} />
                                <Tooltip 
                                    contentStyle={{ backgroundColor: 'rgba(15, 23, 42, 0.9)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', boxShadow: '0 4px 20px rgba(0,0,0,0.5)' }}
                                    itemStyle={{ fontSize: '11px', fontWeight: 600 }}
                                    labelStyle={{ color: '#94a3b8', marginBottom: '4px', fontSize: '10px' }}
                                />
                                <Area type="monotone" dataKey="unsafeAct" stroke={seriesConfig.unsafeAct.color} fill={`url(#grad-unsafeAct)`} strokeWidth={2} stackId="1" />
                                <Area type="monotone" dataKey="positiveObservation" stroke={seriesConfig.positiveObservation.color} fill={`url(#grad-positiveObservation)`} strokeWidth={2} stackId="1" />
                                <ReferenceLine y={10} stroke="#ef4444" strokeDasharray="3 3" label={{ value: 'Threshold', fill: '#ef4444', fontSize: 10, position: 'right' }} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
        </div>
    );
};

==================================================
FILE: .\src\components\SessionAttendanceModal.tsx
==================================================

import React, { useState } from 'react';
import type { TrainingSession, User } from '../types';
import { Button } from './ui/Button';

interface SessionAttendanceModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (sessionId: string, attendance: TrainingSession['attendance']) => void;
  session: TrainingSession;
  users: User[];
}

export const SessionAttendanceModal: React.FC<SessionAttendanceModalProps> = ({ isOpen, onClose, onSubmit, session, users }) => {
  const [attendance, setAttendance] = useState<TrainingSession['attendance']>(() => {
    // Initialize attendance from session roster if empty
    if (session.attendance.length > 0) return session.attendance;
    return session.roster.map(userId => ({ user_id: userId, attended: false, score: undefined }));
  });

  const handleAttendanceChange = (userId: string, attended: boolean) => {
    setAttendance(prev => prev.map(att => att.user_id === userId ? { ...att, attended } : att));
  };

  const handleScoreChange = (userId: string, score: string) => {
    const newScore = parseInt(score, 10);
    setAttendance(prev => prev.map(att => att.user_id === userId ? { ...att, score: isNaN(newScore) ? undefined : newScore } : att));
  };
  
  const getUser = (userId: string) => users.find(u => u.id === userId);

  const handleSubmit = () => {
    onSubmit(session.id, attendance);
  };

  if (!isOpen) return null;
  const isCompleted = session.status === 'completed';

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b">
          <h3 className="text-xl font-bold">Manage Session Attendance</h3>
          <p className="text-sm text-gray-500">Session ID: {session.id}</p>
        </div>
        <div className="p-6 flex-grow overflow-y-auto">
            <table className="min-w-full divide-y">
                <thead className="bg-gray-50"><tr>
                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                    <th className="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Attended</th>
                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Score (%)</th>
                </tr></thead>
                <tbody className="divide-y">
                    {attendance.map(att => {
                        const user = getUser(att.user_id);
                        if (!user) return null;
                        return (
                            <tr key={att.user_id}>
                                <td className="px-4 py-3 font-semibold text-sm">{user.name}</td>
                                <td className="px-4 py-3 text-center">
                                    <input 
                                        type="checkbox" 
                                        checked={att.attended}
                                        onChange={e => handleAttendanceChange(att.user_id, e.target.checked)}
                                        disabled={isCompleted}
                                        className="h-5 w-5 rounded text-primary-600"
                                    />
                                </td>
                                <td className="px-4 py-3">
                                    <input 
                                        type="number" 
                                        min="0" max="100"
                                        value={att.score ?? ''}
                                        onChange={e => handleScoreChange(att.user_id, e.target.value)}
                                        disabled={isCompleted}
                                        className="w-24 p-1 border rounded-md"
                                    />
                                </td>
                            </tr>
                        )
                    })}
                </tbody>
            </table>
        </div>
        <div className="bg-gray-50 px-6 py-3 flex justify-end space-x-2">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          {!isCompleted && <Button onClick={handleSubmit}>Finalize & Issue Certificates</Button>}
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Settings.tsx
==================================================

import React, { useState, useRef, useEffect } from 'react';
import type { User } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { roles } from '../config';
import { useAppContext } from '../contexts';
import { FormField } from './ui/FormField';
import { useToast } from './ui/Toast';

// --- FIREBASE IMPORTS ---
import { db } from '../firebase';
import { writeBatch, doc, setDoc } from 'firebase/firestore';
import { 
  projects, reports, inspections, checklistTemplates, 
  users as initialUsers, organizations, plans, rams, signs 
} from '../data';

// --- STORAGE SERVICE IMPORT ---
import { uploadFileToCloud } from '../services/storageService';

// --- EMAIL SERVICE IMPORT ---
import { sendInviteEmail } from '../services/emailService';

interface SettingsProps {}

type Tab =
  | 'Profile'
  | 'Organization'
  | 'Preferences'
  | 'Security'
  | 'Notifications'
  | 'Legal & Compliance'
  | 'Platform';

const TabButton: React.FC<{
  label: Tab;
  activeTab: Tab;
  onClick: (tab: Tab) => void;
}> = ({ label, activeTab, onClick }) => (
  <button
    onClick={() => onClick(label)}
    className={`px-4 py-2 text-sm font-medium rounded-md whitespace-nowrap transition-colors ${
      activeTab === label
        ? 'bg-primary-100 text-primary-700 dark:bg-primary-900/30 dark:text-primary-400'
        : 'text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-white/5'
    }`}
  >
    {label}
  </button>
);

const Section: React.FC<{
  title: string;
  description: string;
  children: React.ReactNode;
}> = ({ title, description, children }) => (
  <Card>
    <div className="md:grid md:grid-cols-3 md:gap-6">
      <div className="md:col-span-1">
        <h3 className="text-lg font-medium leading-6 text-text-primary dark:text-white">
          {title}
        </h3>
        <p className="mt-1 text-sm text-text-secondary dark:text-gray-400">{description}</p>
      </div>
      <div className="mt-5 md:mt-0 md:col-span-2">
        <div className="space-y-6">{children}</div>
      </div>
    </div>
  </Card>
);

const ComplianceItem: React.FC<{
  title: string;
  children?: React.ReactNode;
  action?: React.ReactNode;
}> = ({ title, children, action }) => (
  <div className="flex items-center justify-between py-4 border-b border-border-color dark:border-dark-border last:border-b-0">
    <div>
      <p className="font-medium text-text-primary dark:text-white">{title}</p>
      {children && (
        <p className="text-sm text-text-secondary dark:text-gray-400 mt-1">{children}</p>
      )}
    </div>
    {action && <div className="flex-shrink-0 ml-4">{action}</div>}
  </div>
);

export const Settings: React.FC<SettingsProps> = () => {
  const { activeUser, handleUpdateUser, usersList, activeOrg, handleInviteUser } = useAppContext();
  const toast = useToast();

  const [activeTab, setActiveTab] = useState<Tab>('Profile');
  const [editedUser, setEditedUser] = useState<User>(activeUser || {} as User);
  const [newAvatarPreviewUrl, setNewAvatarPreviewUrl] = useState<string | null>(null);
  const [isSeeding, setIsSeeding] = useState(false);
  const [isSendingInvite, setIsSendingInvite] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  
  // Invite State
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteName, setInviteName] = useState('');
  const [inviteRole, setInviteRole] = useState<User['role']>('WORKER');

  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if(activeUser) setEditedUser(activeUser);
  }, [activeUser]);

  // Clean up object URL if component unmounts before save
  useEffect(() => {
    return () => {
      // Only revoke if it looks like a blob url (optional safety check)
      if (newAvatarPreviewUrl && newAvatarPreviewUrl.startsWith('blob:')) {
        URL.revokeObjectURL(newAvatarPreviewUrl);
      }
    };
  }, [newAvatarPreviewUrl]);

  const handleSave = () => {
    const userToUpdate: User = {
      ...editedUser,
      avatar_url: newAvatarPreviewUrl || editedUser.avatar_url,
    };
    handleUpdateUser(userToUpdate);
    toast.success("Profile updated successfully");
  };

  const handlePictureChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files && event.target.files[0]) {
      const file = event.target.files[0];
      setIsUploading(true);
      
      try {
          // Show user that upload started
          toast.info("Uploading profile picture...");
          
          // Actual upload to Firebase Storage
          const url = await uploadFileToCloud(file, 'avatars');
          
          // Set the remote URL
          setNewAvatarPreviewUrl(url);
          toast.success("Image uploaded successfully");
      } catch (e) {
          console.error(e);
          toast.error("Failed to upload image");
      } finally {
          setIsUploading(false);
      }
    }
  };

  const handleChoosePictureClick = () => {
    fileInputRef.current?.click();
  };

  // --- INVITE MEMBER LOGIC ---
  const handleSendInvite = async () => {
      if(!inviteEmail || !inviteName) {
          toast.error("Please fill in name and email");
          return;
      }
      
      setIsSendingInvite(true);

      // Create new user object
      const newUser: User = {
          id: `user_${Date.now()}`,
          org_id: activeOrg.id,
          email: inviteEmail,
          name: inviteName,
          role: inviteRole,
          status: 'invited',
          avatar_url: `https://ui-avatars.com/api/?name=${inviteName}&background=random`,
          preferences: {
              language: 'en',
              default_view: 'dashboard',
              units: { temperature: 'C', wind_speed: 'km/h', height: 'm', weight: 'kg' }
          }
      };

      try {
          // 1. Save to Firestore (So they can log in later)
          await setDoc(doc(db, 'users', newUser.id), newUser);
          
          // 2. Update Local State
          handleInviteUser(newUser);
          
          // 3. Send Real Email via EmailJS
          await sendInviteEmail(
              inviteEmail, 
              inviteName, 
              inviteRole, 
              activeOrg.name, 
              activeUser?.name || 'Admin'
          );
          
          setInviteEmail('');
          setInviteName('');
          toast.success(`Invitation sent to ${inviteEmail}`);
      } catch (e: any) {
          console.error(e);
          toast.error("Failed to send invite. Check console.");
      } finally {
          setIsSendingInvite(false);
      }
  };

  // --- DATABASE SEEDING LOGIC ---
  const handleSeedDatabase = async () => {
    if (!window.confirm("âš ï¸ WARNING: This will upload initial data to your database. Continue?")) return;
    
    setIsSeeding(true);
    try {
        const batch = writeBatch(db);

        organizations.forEach(org => {
            const ref = doc(db, 'organizations', org.id);
            batch.set(ref, org);
        });

        initialUsers.forEach(u => {
            const ref = doc(db, 'users', u.id);
            batch.set(ref, u);
        });

        projects.forEach(p => {
            const ref = doc(db, 'projects', p.id);
            batch.set(ref, p);
        });

        reports.forEach(r => {
            const ref = doc(db, 'reports', r.id);
            batch.set(ref, r);
        });

        checklistTemplates.forEach(t => {
            const ref = doc(db, 'checklist_templates', t.id);
            batch.set(ref, t);
        });

        inspections.forEach(i => {
            const ref = doc(db, 'inspections', i.id);
            batch.set(ref, i);
        });
        
        plans.forEach(p => {
            const ref = doc(db, 'plans', p.id);
            batch.set(ref, p);
        });

        rams.forEach(r => {
            const ref = doc(db, 'rams', r.id);
            batch.set(ref, r);
        });

        signs.forEach(s => {
            const ref = doc(db, 'signs', s.id);
            batch.set(ref, s);
        });

        await batch.commit();
        toast.success("Database populated successfully! Refresh the page.");
        setTimeout(() => window.location.reload(), 1500);

    } catch (error: any) {
        console.error("Seeding failed:", error);
        toast.error(`Seeding failed: ${error.message}`);
    } finally {
        setIsSeeding(false);
    }
  };

  if (!activeUser) return null;

  const userRole = roles.find((r) => r.key === editedUser.role);
  const isAdmin = activeUser.role === 'ADMIN' || activeUser.role === 'ORG_ADMIN';

  return (
    <div className="max-w-5xl mx-auto">
      <h1 className="text-3xl font-bold text-text-primary dark:text-white mb-2">Settings</h1>
      <p className="text-text-secondary dark:text-gray-400 mb-6">
        Manage your profile, preferences, and system settings.
      </p>

      <div className="flex space-x-2 border-b border-gray-200 dark:border-dark-border mb-6 overflow-x-auto pb-px">
        <TabButton label="Profile" activeTab={activeTab} onClick={setActiveTab} />
        {isAdmin && <TabButton label="Organization" activeTab={activeTab} onClick={setActiveTab} />}
        <TabButton label="Preferences" activeTab={activeTab} onClick={setActiveTab} />
        <TabButton label="Security" activeTab={activeTab} onClick={setActiveTab} />
        <TabButton label="Notifications" activeTab={activeTab} onClick={setActiveTab} />
        <TabButton label="Legal & Compliance" activeTab={activeTab} onClick={setActiveTab} />
        {activeUser.role === 'ADMIN' && (
          <TabButton label="Platform" activeTab={activeTab} onClick={setActiveTab} />
        )}
      </div>

      <div className="space-y-8">
        {activeTab === 'Profile' && (
          <Section
            title="Profile & Identity"
            description="This information will be displayed publicly so be careful what you share."
          >
            <div className="grid grid-cols-3 gap-6">
              <label className="block text-sm font-medium text-text-primary dark:text-gray-300 col-span-1 pt-2">
                Profile Picture
              </label>
              <div className="col-span-2">
                <div className="flex items-center space-x-4">
                  <img
                    src={newAvatarPreviewUrl || editedUser.avatar_url}
                    alt="Profile"
                    className="w-16 h-16 rounded-full object-cover border dark:border-gray-600"
                  />
                  <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handlePictureChange}
                    className="hidden"
                    accept="image/*"
                  />
                  <Button
                    variant="secondary"
                    type="button"
                    onClick={handleChoosePictureClick}
                    disabled={isUploading}
                  >
                    {isUploading ? 'Uploading...' : 'Change Picture'}
                  </Button>
                </div>
              </div>
            </div>

            <FormField label="Full Name">
              <input
                type="text"
                value={editedUser.name}
                onChange={(e) =>
                  setEditedUser({ ...editedUser, name: e.target.value })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white"
              />
            </FormField>

            <FormField label="Email Address">
              <input
                type="email"
                value={editedUser.email}
                onChange={(e) =>
                  setEditedUser({ ...editedUser, email: e.target.value })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white"
              />
            </FormField>

            <FormField label="Mobile Number">
              <input
                type="tel"
                value={editedUser.mobile || ''}
                onChange={(e) =>
                  setEditedUser({ ...editedUser, mobile: e.target.value })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white"
              />
            </FormField>

            <FormField label="Designation">
              <input
                type="text"
                value={editedUser.designation || ''}
                onChange={(e) =>
                  setEditedUser({ ...editedUser, designation: e.target.value })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white"
              />
            </FormField>

            <FormField label="Company / Contractor">
              <input
                type="text"
                value={editedUser.company || ''}
                onChange={(e) =>
                  setEditedUser({ ...editedUser, company: e.target.value })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white"
              />
            </FormField>
            
            <div className="flex justify-end mt-4">
                <Button type="button" onClick={handleSave}>Save Profile</Button>
            </div>
          </Section>
        )}

        {/* --- ORGANIZATION TAB --- */}
        {activeTab === 'Organization' && isAdmin && (
            <>
            <Section title="Organization Details" description="Manage your company branding and details.">
                <div className="flex items-center gap-4 mb-4">
                    <img src={activeOrg.branding.logoUrl} alt="Logo" className="w-16 h-16 rounded-lg border dark:border-gray-700" />
                    <div>
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">{activeOrg.name}</h3>
                        <p className="text-sm text-gray-500">{activeOrg.industry} â€¢ {activeOrg.country}</p>
                    </div>
                </div>
                <FormField label="Company Name">
                    <input type="text" defaultValue={activeOrg.name} className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white" />
                </FormField>
                <FormField label="Domain">
                    <input type="text" defaultValue={activeOrg.domain} disabled className="w-full p-2 border bg-gray-100 rounded-md dark:bg-white/5 dark:border-dark-border dark:text-gray-400 cursor-not-allowed" />
                </FormField>
            </Section>

            <Section title="Team Management" description="Invite new members and manage access roles.">
                <div className="bg-gray-50 dark:bg-white/5 p-4 rounded-lg border dark:border-dark-border mb-6">
                    <h4 className="font-bold text-sm text-gray-700 dark:text-gray-300 mb-3">Invite New Member</h4>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input 
                            type="text" 
                            placeholder="Full Name" 
                            value={inviteName}
                            onChange={e => setInviteName(e.target.value)}
                            className="p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white text-sm"
                        />
                        <input 
                            type="email" 
                            placeholder="Email Address" 
                            value={inviteEmail}
                            onChange={e => setInviteEmail(e.target.value)}
                            className="p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white text-sm"
                        />
                        <div className="flex gap-2">
                            <select 
                                value={inviteRole}
                                onChange={e => setInviteRole(e.target.value as User['role'])}
                                className="p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white text-sm flex-1"
                            >
                                {roles.map(r => <option key={r.key} value={r.key}>{r.label}</option>)}
                            </select>
                            <Button onClick={handleSendInvite} disabled={isSendingInvite}>
                                {isSendingInvite ? 'Sending...' : 'Invite'}
                            </Button>
                        </div>
                    </div>
                </div>

                <div className="overflow-hidden border rounded-lg dark:border-dark-border">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-dark-border">
                        <thead className="bg-gray-50 dark:bg-white/5">
                            <tr>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-dark-border">
                            {usersList.filter(u => u.org_id === activeOrg.id).map(user => (
                                <tr key={user.id}>
                                    <td className="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">{user.name}</td>
                                    <td className="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">{roles.find(r => r.key === user.role)?.label || user.role}</td>
                                    <td className="px-4 py-3 text-sm">
                                        <Badge color={user.status === 'active' ? 'green' : 'yellow'}>{user.status}</Badge>
                                    </td>
                                    <td className="px-4 py-3 text-right text-sm">
                                        <button className="text-blue-600 hover:text-blue-800 dark:text-blue-400 mr-3">Edit</button>
                                        <button className="text-red-600 hover:text-red-800 dark:text-red-400">Remove</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Section>
            </>
        )}

        {activeTab === 'Preferences' && (
          <Section
            title="Preferences & Display"
            description="Customize how EviroSafe looks and feels for you."
          >
            <FormField label="Language">
              <select
                value={editedUser.preferences?.language || 'en'} // FIX: Safe access
                onChange={(e) =>
                  setEditedUser({
                    ...editedUser,
                    preferences: {
                      ...editedUser.preferences,
                      language: e.target.value as 'en' | 'ar',
                    },
                  })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white dark:bg-dark-background"
              >
                <option value="en">English</option>
                <option value="ar">Arabic</option>
              </select>
            </FormField>

            <FormField label="Default Home Screen">
              <select
                value={editedUser.preferences?.default_view || 'dashboard'} // FIX: Safe access
                onChange={(e) =>
                  setEditedUser({
                    ...editedUser,
                    preferences: {
                      ...editedUser.preferences,
                      default_view:
                        e.target.value as User['preferences']['default_view'],
                    },
                  })
                }
                className="w-full p-2 border bg-transparent rounded-md dark:border-dark-border dark:text-white dark:bg-dark-background"
              >
                <option value="dashboard">Dashboard</option>
                <option value="reports">Reporting</option>
                <option value="ptw">Permit to Work</option>
                <option value="inspections">Inspections</option>
                <option value="tbt">Toolbox Talks</option>
                <option value="training">Trainings</option>
              </select>
            </FormField>
            
            <div className="flex justify-end mt-4">
                <Button type="button" onClick={handleSave}>Save Preferences</Button>
            </div>
          </Section>
        )}

        {activeTab === 'Security' && (
          <Section
            title="Access & Security"
            description="Manage your login credentials and view your permissions."
          >
            <FormField label="Current Role">
              <input
                type="text"
                readOnly
                value={userRole?.label || editedUser.role}
                className="w-full p-2 border bg-gray-100 rounded-md dark:bg-white/5 dark:border-dark-border dark:text-gray-300"
              />
            </FormField>

            <FormField label="Permissions">
              <div className="p-4 border rounded-md max-h-60 overflow-y-auto dark:border-dark-border dark:bg-black/20">
                <ul className="space-y-2 text-sm">
                  {userRole?.permissions.map((p) => (
                    <li key={p.resource}>
                      <span className="font-semibold capitalize text-gray-700 dark:text-gray-300">
                        {p.resource}:{' '}
                      </span>
                      <span className="text-sm text-gray-600 dark:text-gray-400">
                        {p.actions.join(', ')}
                      </span>
                    </li>
                  ))}
                </ul>
              </div>
            </FormField>
          </Section>
        )}

        {activeTab === 'Notifications' && (
          <Section
            title="Notifications"
            description="Configure how EviroSafe keeps you informed about safety activity."
          >
            <FormField label="Email notifications">
              <div className="space-y-2 text-sm text-text-secondary dark:text-gray-400">
                <label className="flex items-center space-x-2">
                  <input type="checkbox" className="rounded" defaultChecked />
                  <span>Incident reports assigned to me</span>
                </label>
                <label className="flex items-center space-x-2">
                  <input type="checkbox" className="rounded" defaultChecked />
                  <span>Permit to Work approvals & expiries</span>
                </label>
                <label className="flex items-center space-x-2">
                  <input type="checkbox" className="rounded" defaultChecked />
                  <span>Upcoming trainings & toolbox talks</span>
                </label>
              </div>
            </FormField>
          </Section>
        )}

        {activeTab === 'Legal & Compliance' && (
          <Section
            title="Legal & Compliance"
            description="Manage your consents and review key compliance information."
          >
            <ComplianceItem
              title="Data Processing & Privacy"
              action={<Button variant="ghost">View Policy</Button>}
            >
              EviroSafe processes data in line with your organizationâ€™s
              contractual requirements and local regulations.
            </ComplianceItem>

            <ComplianceItem
              title="Terms of Use"
              action={<Button variant="ghost">View Terms</Button>}
            >
              Updated terms apply to all users accessing EviroSafe systems.
            </ComplianceItem>

            <ComplianceItem title="Audit Trail">
              All key safety actions (PTW approvals, RAMS updates, incident
              closures) are logged for auditing and regulatory review.
            </ComplianceItem>
          </Section>
        )}

        {activeTab === 'Platform' && activeUser.role === 'ADMIN' && (
          <Section
            title="Platform Administration"
            description="High-level controls for EviroSafe modules and tenant configuration."
          >
            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg mb-6">
                <h4 className="font-bold text-blue-800 dark:text-blue-300 mb-2">Database Management</h4>
                <p className="text-sm text-blue-700 dark:text-blue-400 mb-4">
                    Your database is currently live. If you see empty screens, you can seed the database with initial demo data.
                </p>
                <Button onClick={handleSeedDatabase} disabled={isSeeding}>
                    {isSeeding ? 'Uploading Data...' : 'ðŸš€ Seed Database with Demo Data'}
                </Button>
            </div>

            <FormField label="Enabled modules">
              <div className="flex flex-wrap gap-2 text-sm">
                {['Incident Reporting', 'Inspections', 'Permit to Work', 'RAMS', 'Trainings'].map(m => (
                    <span key={m} className="px-2 py-1 rounded-full bg-primary-50 text-primary-700 dark:bg-primary-900/30 dark:text-primary-300">
                    {m}
                    </span>
                ))}
              </div>
            </FormField>
          </Section>
        )}
      </div>

      <div className="flex justify-end mt-8">
        <Button type="button" onClick={handleSave}>
          Save Changes
        </Button>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Sidebar.tsx
==================================================

import React, { useState } from 'react';
import { logoSrc } from '../config';
import { useAuth } from '../contexts/AuthContext';
import { useAppContext, useDataContext } from '../contexts';
import { NotificationsPanel } from './NotificationsPanel';
import { Bell } from 'lucide-react';

interface SidebarProps {
  currentView: string;
  setCurrentView: (view: string) => void;
  isOpen: boolean;
  setOpen: (isOpen: boolean) => void;
}

// --- Icons Data ---
const icons: Record<string, JSX.Element> = {
  dashboard: <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />,
  'ai-insights': <path d="M13 10V3L4 14h7v7l9-11h-7z" />,
  'hse-statistics': <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />,
  'site-map': <path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />,
  reports: <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM14 9V3.5L18.5 9H14z" />,
  actions: <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />,
  inspections: <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />,
  ptw: <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />,
  checklists: <path d="M5 13l4 4L19 7" />,
  plans: <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />,
  rams: <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />,
  signage: <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />,
  tbt: <path d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />,
  training: <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />,
  people: <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />,
  settings: <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />,
  certification: <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />,
};

const NavItem: React.FC<{
  label: string;
  view: string;
  currentView: string;
  setCurrentView: (view: string) => void;
  isOpen: boolean;
}> = ({ label, view, currentView, setCurrentView, isOpen }) => {
  const isActive = currentView === view;

  return (
    <button
      onClick={() => setCurrentView(view)}
      className={`flex items-center w-full rounded-xl transition-all duration-200 group relative overflow-hidden mb-1
        ${isActive
          ? 'bg-cyan-500/20 text-cyan-200 shadow-[0_0_20px_rgba(34,211,238,0.25)]'
          : 'text-slate-400 hover:bg-slate-800/80 hover:text-slate-50'}
        ${isOpen ? 'px-4 py-2.5 mx-2 w-auto' : 'h-10 w-10 justify-center mx-auto'}
      `}
    >
      {isActive && (
        <div className="absolute left-0 top-1 bottom-1 w-1 rounded-r-full bg-cyan-400" />
      )}
      <div
        className={`w-5 h-5 shrink-0 relative z-10 ${
          isActive
            ? 'text-cyan-300'
            : 'text-slate-500 group-hover:text-slate-200'
        }`}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth={2}
        >
          {icons[view] || icons.dashboard}
        </svg>
      </div>
      {isOpen && (
        <span className="ml-3 text-sm font-medium tracking-wide truncate relative z-10">
          {label}
        </span>
      )}
    </button>
  );
};

export const Sidebar: React.FC<SidebarProps> = ({
  currentView,
  setCurrentView,
  isOpen,
  setOpen,
}) => {
  const { logout, currentUser } = useAuth();
  const { notifications } = useDataContext();
  const { activeUser } = useAppContext();
  const [showNotifications, setShowNotifications] = useState(false);

  // Calculate unread notifications for the current user
  const unreadCount = notifications.filter(n => n.user_id === activeUser?.id && !n.is_read).length;

  const menuItems = [
    { label: 'Dashboard', view: 'dashboard' },
    { label: 'AI Insights', view: 'ai-insights' },
    { label: 'HSE Statistics', view: 'hse-statistics' },
    { label: 'Site Map', view: 'site-map' },
    { label: 'My Certificate', view: 'certification' },
    { label: 'Reporting', view: 'reports' },
    { label: 'Action Tracker', view: 'actions' },
    { label: 'Inspections', view: 'inspections' },
    { label: 'Permit to Work', view: 'ptw' },
    { label: 'Checklists', view: 'checklists' },
    { label: 'Plans', view: 'plans' },
    { label: 'RAMS', view: 'rams' },
    { label: 'Signage', view: 'signage' },
    { label: 'Toolbox Talks', view: 'tbt' },
    { label: 'Training', view: 'training' },
    { label: 'People', view: 'people' },
    { label: 'Organizations', view: 'organizations' },
    // Projects removed from here to enforce Organization -> Project workflow
    { label: 'Settings', view: 'settings' },
  ];

  return (
    <>
    <div
      className={`shrink-0 h-screen flex flex-col transition-all duration-300 z-50
        border-r border-slate-800/60
        bg-slate-950/80 backdrop-blur-xl
        ${isOpen ? 'w-64' : 'w-20'}
      `}
    >
      {/* Header / Logo */}
      <div
        className={`flex items-center h-16 border-b border-slate-800/60 shrink-0
          ${isOpen ? 'px-6' : 'justify-center'}
        `}
      >
        <img src={logoSrc} alt="Logo" className="w-8 h-8 rounded-lg" />
        {isOpen && (
          <span className="ml-3 text-lg font-semibold text-slate-50 tracking-wide">
            EviroSafe
          </span>
        )}
      </div>

      {/* Navigation */}
      <nav className="flex-1 py-4 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700/70 space-y-0.5">
        {menuItems.map((item) => (
          <NavItem
            key={item.view}
            label={item.label}
            view={item.view}
            isOpen={isOpen}
            currentView={currentView}
            setCurrentView={setCurrentView}
          />
        ))}
      </nav>

      {/* Notification & Toggle */}
      <div className="p-2 border-t border-slate-800/60 bg-slate-950/70 flex flex-col gap-2">
        
        {/* Notification Button */}
        <button
          onClick={() => setShowNotifications(true)}
          className="w-full flex items-center justify-center p-2 rounded-lg text-slate-400 hover:text-slate-100 hover:bg-slate-800/70 transition-colors relative"
        >
          <Bell className="w-5 h-5" />
          {isOpen && <span className="ml-3 text-sm">Notifications</span>}
          {unreadCount > 0 && (
            <span className="absolute top-1 right-1 md:top-2 md:right-2 flex h-3 w-3">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
            </span>
          )}
        </button>

        <button
          onClick={() => setOpen(!isOpen)}
          className="w-full flex items-center justify-center p-2 rounded-lg text-slate-400 hover:text-slate-100 hover:bg-slate-800/70 transition-colors"
        >
          <svg
            className={`w-5 h-5 transition-transform ${
              !isOpen ? 'rotate-180' : ''
            }`}
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M11 19l-7-7 7-7m8 14l-7-7 7-7"
            />
          </svg>
        </button>
      </div>

      {/* User Footer */}
      <div
        className={`p-4 border-t border-slate-800/60 bg-slate-950/80 ${
          !isOpen && 'flex flex-col items-center'
        }`}
      >
        <div
          className={`flex items-center gap-3 mb-4 ${
            isOpen ? 'px-2' : ''
          }`}
        >
          <div className="w-8 h-8 rounded-full bg-cyan-500 flex items-center justify-center text-slate-900 font-bold text-xs shrink-0 shadow-md">
            {currentUser?.email?.charAt(0).toUpperCase() || 'U'}
          </div>
          {isOpen && (
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-slate-100 truncate">
                {currentUser?.email}
              </p>
              <p className="text-xs text-slate-500 truncate">Admin</p>
            </div>
          )}
        </div>
        <button
          onClick={() => logout()}
          className="w-full flex items-center justify-center p-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors font-medium"
        >
          Sign Out
        </button>
      </div>
    </div>

    {/* Notification Panel Overlay */}
    {showNotifications && (
        <NotificationsPanel onClose={() => setShowNotifications(false)} />
    )}
    </>
  );
};

==================================================
FILE: .\src\components\Signage.tsx
==================================================

import React, { useState, useMemo } from 'react';
import { Card } from './ui/Card';
import { Button } from './ui/Button';

// --- TYPES ---
type SignCategory = 'Mandatory' | 'Warning' | 'Prohibition' | 'Emergency' | 'Fire';

interface SignDef {
  id: string;
  title: string;
  category: SignCategory;
  icon: string;
  code: string;
}

// --- 50+ HSE SIGNAGE LIBRARY ---
const SIGN_LIBRARY: SignDef[] = [
  { id: 'm1', title: 'Wear Safety Helmet', category: 'Mandatory', icon: 'â›‘ï¸', code: 'M001' },
  { id: 'm2', title: 'Wear Safety Footwear', category: 'Mandatory', icon: 'ðŸ¥¾', code: 'M002' },
  { id: 'm3', title: 'Wear Ear Protection', category: 'Mandatory', icon: 'ðŸŽ§', code: 'M003' },
  { id: 'm4', title: 'Wear Eye Protection', category: 'Mandatory', icon: 'ðŸ¥½', code: 'M004' },
  { id: 'm5', title: 'Wear Respiratory Mask', category: 'Mandatory', icon: 'ðŸ˜·', code: 'M005' },
  { id: 'w1', title: 'General Danger', category: 'Warning', icon: 'â—', code: 'W001' },
  { id: 'w2', title: 'High Voltage', category: 'Warning', icon: 'âš¡', code: 'W002' },
  { id: 'w3', title: 'Flammable Material', category: 'Warning', icon: 'ðŸ”¥', code: 'W003' },
  { id: 'p1', title: 'No Entry', category: 'Prohibition', icon: 'â›”', code: 'P001' },
  { id: 'p2', title: 'No Smoking', category: 'Prohibition', icon: 'ðŸš­', code: 'P002' },
  { id: 'e1', title: 'First Aid', category: 'Emergency', icon: 'â›‘ï¸', code: 'E001' },
  { id: 'e2', title: 'Emergency Exit', category: 'Emergency', icon: 'ðŸƒ', code: 'E002' },
  { id: 'f1', title: 'Fire Extinguisher', category: 'Fire', icon: 'ðŸ§¯', code: 'F001' },
];

const SignVisual: React.FC<{ sign: SignDef; size?: 'sm' | 'lg' }> = ({ sign, size = 'sm' }) => {
  const sizeClass = size === 'sm' ? 'w-24 h-24 text-4xl' : 'w-96 h-96 text-[8rem]';
  const containerClass = "flex items-center justify-center shadow-sm transition-transform";

  switch (sign.category) {
    case 'Mandatory':
      return <div className={`${sizeClass} ${containerClass} rounded-full bg-blue-600 border-[6px] border-white ring-[6px] ring-blue-600 text-white`}>{sign.icon}</div>;
    case 'Prohibition':
      return <div className={`${sizeClass} ${containerClass} rounded-full bg-white border-[10px] border-red-600 relative overflow-hidden`}><div className="absolute inset-0 flex items-center justify-center text-black z-0">{sign.icon}</div><div className="absolute w-[120%] h-[10%] bg-red-600 -rotate-45 transform origin-center z-10"></div></div>;
    case 'Warning':
      return <div className={`${sizeClass} ${containerClass} relative`}><svg viewBox="0 0 100 87" className="w-full h-full drop-shadow-sm"><polygon points="50,0 100,87 0,87" className="fill-yellow-400 stroke-black stroke-[3]" /><text x="50" y="65" fontSize="40" textAnchor="middle" dominantBaseline="middle">{sign.icon}</text></svg></div>;
    case 'Emergency':
      return <div className={`${sizeClass} ${containerClass} rounded-lg bg-green-600 text-white border-[4px] border-white ring-[4px] ring-green-600`}>{sign.icon}</div>;
    case 'Fire':
      return <div className={`${sizeClass} ${containerClass} rounded-lg bg-red-600 text-white border-[4px] border-white ring-[4px] ring-red-600`}>{sign.icon}</div>;
    default:
      return <div>{sign.icon}</div>;
  }
};

const SignCard: React.FC<{ sign: SignDef; onPrint: (sign: SignDef) => void }> = ({ sign, onPrint }) => {
  return (
    <div className="flex flex-col items-center p-4 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-xl hover:shadow-lg transition-all group">
      <div className="mb-4 transform group-hover:scale-110 transition-transform duration-300">
        <SignVisual sign={sign} size="sm" />
      </div>
      <h3 className="font-bold text-gray-900 dark:text-white text-center text-sm h-10 flex items-center justify-center">
        {sign.title}
      </h3>
      <div className="mt-2 flex gap-2 w-full">
        <Button variant="secondary" size="sm" className="w-full text-xs" onClick={() => onPrint(sign)}>
            <PrinterIcon className="w-3 h-3 mr-1" /> Print
        </Button>
      </div>
      <span className="text-[10px] text-gray-400 mt-2 font-mono">{sign.code}</span>
    </div>
  );
};

const PrintableSignView: React.FC<{ sign: SignDef }> = ({ sign }) => {
    const getColor = () => {
        switch(sign.category) {
            case 'Mandatory': return 'bg-blue-600';
            case 'Prohibition': return 'bg-red-600';
            case 'Warning': return 'bg-yellow-400 text-black';
            case 'Emergency': return 'bg-green-600';
            case 'Fire': return 'bg-red-600';
            default: return 'bg-gray-500';
        }
    }

    return (
        <div className="w-full h-full flex flex-col items-center justify-center p-12 border-[10px] border-gray-900 bg-white">
            <div className="transform scale-[1.5] mb-16">
                <SignVisual sign={sign} size="lg" />
            </div>
            <div className={`w-full py-8 text-center ${getColor()} text-white print-color-adjust-exact`}>
                <h1 className="text-7xl font-black uppercase tracking-wider">{sign.title}</h1>
            </div>
            <div className="mt-12 text-2xl font-mono text-gray-500">
                ISO 7010 Compliant â€¢ Code: {sign.code} â€¢ EviroSafe
            </div>
        </div>
    )
}

export const Signage: React.FC = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState<string>('All');
  const [signToPrint, setSignToPrint] = useState<SignDef | null>(null);

  const filteredSigns = useMemo(() => {
    return SIGN_LIBRARY.filter(sign => {
      const matchesSearch = sign.title.toLowerCase().includes(searchTerm.toLowerCase()) || sign.code.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesCategory = categoryFilter === 'All' || sign.category === categoryFilter;
      return matchesSearch && matchesCategory;
    });
  }, [searchTerm, categoryFilter]);

  const handlePrint = (sign: SignDef) => {
      setSignToPrint(sign);
      setTimeout(() => {
          window.print();
          setTimeout(() => setSignToPrint(null), 1000);
      }, 500);
  };

  return (
    <div>
      {signToPrint && (
          <div className="print-overlay">
              <PrintableSignView sign={signToPrint} />
          </div>
      )}

      <style>{`
        @media print {
            body { background: white; }
            #root { display: none; }
            .print-overlay {
                display: flex !important;
                position: fixed;
                top: 0; left: 0; width: 100vw; height: 100vh;
                z-index: 9999;
                background: white;
                align-items: center;
                justify-content: center;
            }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        .print-overlay { display: none; }
      `}</style>

      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
          <h1 className="text-3xl font-bold text-text-primary dark:text-white">Signage Library</h1>
          <p className="text-text-secondary dark:text-gray-400">50+ ISO-compliant safety signs ready for download and printing.</p>
        </div>
        
        <div className="flex gap-2">
            <div className="relative">
                <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                <input 
                    type="text" 
                    placeholder="Search signs..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-9 pr-4 py-2 rounded-lg border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-card text-sm w-64 focus:ring-2 focus:ring-primary-500 outline-none"
                />
            </div>
        </div>
      </div>

      <Card className="mb-8">
          <div className="flex flex-wrap gap-2">
              {['All', 'Mandatory', 'Warning', 'Prohibition', 'Emergency', 'Fire'].map(cat => (
                  <button
                    key={cat}
                    onClick={() => setCategoryFilter(cat)}
                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                        categoryFilter === cat 
                        ? 'bg-slate-800 text-white dark:bg-white dark:text-slate-900 shadow-md' 
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-white/5 dark:text-gray-400 dark:hover:bg-white/10'
                    }`}
                  >
                      {cat}
                  </button>
              ))}
          </div>
      </Card>

      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
        {filteredSigns.map(sign => (
            <SignCard key={sign.id} sign={sign} onPrint={handlePrint} />
        ))}
      </div>

      {filteredSigns.length === 0 && (
          <div className="text-center py-20">
              <p className="text-gray-500 text-lg">No signs found matching "{searchTerm}"</p>
              <Button variant="ghost" onClick={() => {setSearchTerm(''); setCategoryFilter('All');}} className="mt-4">Clear Filters</Button>
          </div>
      )}
    </div>
  );
};

const SearchIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>;
const PrinterIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03-.48.062-.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.32 0c.045-.247.075-.5.075-.75V13.5c0-.75-.03-1.492-.075-2.221m-11.245 0c-.045.729-.075 1.471-.075 2.221v3.75c0 .25.03.495.075.75m11.245 0c.383 0 .75.053 1.102.143m-12.447 0c.352-.09.719-.143 1.102-.143m10.245 0c.373 0 .73.056 1.074.156M4.86 18c.344-.1.691-.156 1.074-.156m12.092 0c.344.1.691.156 1.074.156" /></svg>;

==================================================
FILE: .\src\components\SignageCreationModal.tsx
==================================================

import React, { useState, useEffect } from 'react';
import type { Sign, SignCategory, HazardType, PtwType } from '../types';
import { Button } from './ui/Button';
import { FormField } from './ui/FormField';
import { signageConfig, ptwTypeDetails } from '../config';

interface SignageCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<Sign, 'id' | 'org_id'>) => void;
  initialData?: Sign | null;
}

const HAZARDS: HazardType[] = ['Fire', 'Fall', 'Electrical', 'Chemical', 'Noise', 'Dropped Object', 'Overhead Load', 'Trip', 'Slippery', 'Explosion', 'Moving Machinery', 'Confined Space', 'Excavation'];

export const SignageCreationModal: React.FC<SignageCreationModalProps> = ({ isOpen, onClose, onSubmit, initialData }) => {
  const [formData, setFormData] = useState({
    title: '',
    category: 'Mandatory' as SignCategory,
    icon_url: 'âš ï¸',
    description: '',
    matched_activities: [] as PtwType[],
    hazards: [] as HazardType[],
  });

  useEffect(() => {
    if (initialData) {
      setFormData({
        title: initialData.title['en'] || '',
        category: initialData.category,
        icon_url: initialData.icon_url,
        description: initialData.description['en'] || '',
        matched_activities: initialData.matched_activities,
        hazards: initialData.hazards,
      });
    } else {
        setFormData({
            title: '',
            category: 'Mandatory',
            icon_url: 'âš ï¸',
            description: '',
            matched_activities: [],
            hazards: [],
        });
    }
  }, [initialData, isOpen]);

  const handleSubmit = () => {
    if (!formData.title || !formData.icon_url) {
        alert("Title and Icon are required.");
        return;
    }

    const signData: Omit<Sign, 'id' | 'org_id'> = {
        category: formData.category,
        title: { en: formData.title },
        description: { en: formData.description },
        icon_url: formData.icon_url,
        matched_activities: formData.matched_activities,
        hazards: formData.hazards,
    };

    onSubmit(signData);
    onClose();
  };

  const toggleSelection = (list: string[], item: string, field: 'matched_activities' | 'hazards') => {
      const newList = list.includes(item) ? list.filter(i => i !== item) : [...list, item];
      // @ts-ignore
      setFormData(prev => ({ ...prev, [field]: newList }));
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b dark:border-dark-border">
          <h3 className="text-xl font-bold text-gray-900 dark:text-white">
            {initialData ? 'Edit Sign' : 'Add New Sign'}
          </h3>
        </div>
        
        <div className="p-6 space-y-4 overflow-y-auto">
            <div className="grid grid-cols-2 gap-4">
                <FormField label="Sign Category">
                    <select 
                        value={formData.category} 
                        onChange={e => setFormData(p => ({...p, category: e.target.value as SignCategory}))}
                        className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white"
                    >
                        {Object.keys(signageConfig).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                    </select>
                </FormField>
                <FormField label="Icon / Emoji">
                    <input 
                        type="text" 
                        value={formData.icon_url} 
                        onChange={e => setFormData(p => ({...p, icon_url: e.target.value}))}
                        className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white text-center text-2xl"
                        placeholder="e.g. âš ï¸"
                    />
                </FormField>
            </div>

            <FormField label="Sign Title (English)">
                <input 
                    type="text" 
                    value={formData.title} 
                    onChange={e => setFormData(p => ({...p, title: e.target.value}))}
                    className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white"
                    placeholder="e.g. Wear Safety Helmet"
                />
            </FormField>

            <FormField label="Description">
                <textarea 
                    rows={2}
                    value={formData.description} 
                    onChange={e => setFormData(p => ({...p, description: e.target.value}))}
                    className="w-full p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white"
                    placeholder="Brief explanation of the sign..."
                />
            </FormField>

            <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Related Hazards</label>
                <div className="flex flex-wrap gap-2">
                    {HAZARDS.map(h => (
                        <button
                            key={h}
                            onClick={() => toggleSelection(formData.hazards, h, 'hazards')}
                            className={`px-2 py-1 text-xs rounded-full border transition-colors ${
                                formData.hazards.includes(h) 
                                ? 'bg-red-100 border-red-500 text-red-700 dark:bg-red-900/30 dark:text-red-300' 
                                : 'bg-gray-50 border-gray-200 text-gray-600 dark:bg-white/5 dark:border-white/10 dark:text-gray-400'
                            }`}
                        >
                            {h}
                        </button>
                    ))}
                </div>
            </div>

            <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Required for Activities</label>
                <div className="flex flex-wrap gap-2">
                    {Object.keys(ptwTypeDetails).map(act => (
                        <button
                            key={act}
                            onClick={() => toggleSelection(formData.matched_activities, act, 'matched_activities')}
                            className={`px-2 py-1 text-xs rounded-full border transition-colors ${
                                formData.matched_activities.includes(act as PtwType) 
                                ? 'bg-blue-100 border-blue-500 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' 
                                : 'bg-gray-50 border-gray-200 text-gray-600 dark:bg-white/5 dark:border-white/10 dark:text-gray-400'
                            }`}
                        >
                            {act}
                        </button>
                    ))}
                </div>
            </div>
        </div>

        <div className="p-6 border-t dark:border-dark-border flex justify-end gap-2">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>{initialData ? 'Update Sign' : 'Create Sign'}</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\SiteMap.tsx
==================================================

import React, { useState, useMemo } from 'react';
import { useDataContext, useModalContext } from '../contexts';
import type { Ptw, Report, Project } from '../types';
import { ptwTypeDetails } from '../config';
import { getRiskLevel } from '../utils/riskUtils';

interface MarkerProps {
    x: number;
    y: number;
    type: 'ptw' | 'incident';
    data: any;
    onClick: () => void;
}

interface SiteMapProps {
    embedded?: boolean;
}

const Marker: React.FC<MarkerProps> = ({ x, y, type, data, onClick }) => {
    let color = '';
    
    if (type === 'ptw') {
        const ptw = data as Ptw;
        const details = ptwTypeDetails[ptw.type];
        color = details.hex;
    } else if (type === 'incident') {
        const report = data as Report;
        const risk = getRiskLevel(report.risk_pre_control);
        color = risk.color === 'red' ? '#ef4444' : '#f59e0b';
    }

    return (
        <g transform={`translate(${x}, ${y})`} onClick={(e) => { e.stopPropagation(); onClick(); }} className="cursor-pointer hover:scale-125 transition-transform duration-200">
            <circle r="16" fill={color} fillOpacity="0.4" className="animate-pulse" />
            <circle r="6" fill={color} stroke="white" strokeWidth="2" className="drop-shadow-[0_0_8px_rgba(255,255,255,0.8)]" />
            <line x1="0" y1="0" x2="0" y2="20" stroke={color} strokeWidth="2" strokeOpacity="0.5" />
            <circle cx="0" cy="20" r="2" fill={color} fillOpacity="0.5" />
        </g>
    );
};

const MapZone: React.FC<{ 
    d: string; 
    label: string; 
    isActive: boolean;
    riskScore: number; 
    onClick: () => void 
}> = ({ d, label, isActive, riskScore, onClick }) => {
    const getRiskFill = (score: number) => {
        if (score === 0) return 'rgba(255, 255, 255, 0.02)';
        if (score < 5) return 'rgba(250, 204, 21, 0.1)';
        if (score < 10) return 'rgba(251, 146, 60, 0.2)';
        return 'rgba(248, 113, 113, 0.3)';
    };

    return (
        <g onClick={onClick} className="cursor-pointer group">
            <path 
                d={d} 
                fill={getRiskFill(riskScore)} 
                stroke={isActive ? '#00f3ff' : '#64748b'} 
                strokeWidth={isActive ? 2 : 1} 
                className="transition-all duration-300 hover:fill-opacity-20 hover:stroke-white/80"
                style={{ filter: isActive ? 'drop-shadow(0 0 8px rgba(0, 243, 255, 0.5))' : 'none' }}
            />
             {(() => {
                 const bboxMatch = d.match(/M\s(\d+),(\d+)\sH\s(\d+)\sV\s(\d+)/);
                 let x = 0, y = 0;
                 if (bboxMatch) {
                     x = (parseInt(bboxMatch[1]) + parseInt(bboxMatch[3])) / 2;
                     y = (parseInt(bboxMatch[2]) + parseInt(bboxMatch[4])) / 2;
                 }
                 return (
                     <text 
                        x={x} y={y} 
                        textAnchor="middle" 
                        dominantBaseline="middle"
                        className="pointer-events-none font-bold uppercase text-[10px] fill-slate-400 select-none tracking-widest"
                     >
                         {label}
                     </text>
                 )
             })()}
        </g>
    );
};

export const SiteMap: React.FC<SiteMapProps> = ({ embedded = false }) => {
    const { projects } = useDataContext();
    const { ptwList, reportList } = useDataContext();
    const { setSelectedPtw, setSelectedReport } = useModalContext();
    
    const [selectedProject] = useState<Project | null>(projects[0] || null);
    const [selectedZone, setSelectedZone] = useState<string | null>(null);
    const [showHeatmap, setShowHeatmap] = useState(true);
    const [showPtws, setShowPtws] = useState(true);
    const [showIncidents, setShowIncidents] = useState(true);

    const zones = [
        { id: 'zone_a', label: 'Tower A', d: 'M 50,50 H 250 V 300 H 50 Z' },
        { id: 'zone_b', label: 'Tower B', d: 'M 300,50 H 500 V 300 H 300 Z' },
        { id: 'zone_laydown', label: 'Laydown', d: 'M 550,50 H 750 V 200 H 550 Z' },
        { id: 'zone_excavation', label: 'Pit', d: 'M 50,350 H 400 V 550 H 50 Z' },
        { id: 'zone_office', label: 'Office', d: 'M 450,400 H 750 V 550 H 450 Z' },
    ];

    const mapItemToZone = (locationText: string): { zoneId: string, x: number, y: number } | null => {
        if (!locationText) return null;
        const lowerLoc = locationText.toLowerCase();
        const rand = (min: number, max: number) => Math.random() * (max - min) + min;
        if (lowerLoc.includes('tower a') || lowerLoc.includes('sector a')) return { zoneId: 'zone_a', x: rand(60, 240), y: rand(60, 290) };
        if (lowerLoc.includes('tower b') || lowerLoc.includes('sector b')) return { zoneId: 'zone_b', x: rand(310, 490), y: rand(60, 290) };
        if (lowerLoc.includes('laydown')) return { zoneId: 'zone_laydown', x: rand(560, 740), y: rand(60, 190) };
        if (lowerLoc.includes('excavation') || lowerLoc.includes('pit')) return { zoneId: 'zone_excavation', x: rand(60, 390), y: rand(360, 540) };
        if (lowerLoc.includes('office')) return { zoneId: 'zone_office', x: rand(460, 740), y: rand(410, 540) };
        return null;
    };

    const mappedData = useMemo(() => {
        const ptws = ptwList
            .filter(p => p.status === 'ACTIVE' && p.project_id === selectedProject?.id)
            .map(p => ({ ...p, mapLoc: mapItemToZone(p.payload?.work?.location || '') }))
            .filter(p => p.mapLoc !== null);
            
        const incidents = reportList
            .filter(r => r.status !== 'closed' && r.project_id === selectedProject?.id)
            .map(r => {
                const locText = r.location?.text || '';
                const specificArea = r.location?.specific_area || '';
                return { ...r, mapLoc: mapItemToZone(locText + ' ' + specificArea) };
            })
            .filter(r => r.mapLoc !== null);

        return { ptws, incidents };
    }, [ptwList, reportList, selectedProject]);

    const zoneRiskScores = useMemo(() => {
        const scores: Record<string, number> = {};
        zones.forEach(z => scores[z.id] = 0);
        mappedData.incidents.forEach(inc => { if (inc.mapLoc) scores[inc.mapLoc.zoneId] += (inc.risk_pre_control.severity * inc.risk_pre_control.likelihood); });
        mappedData.ptws.forEach(ptw => { if (ptw.mapLoc) scores[ptw.mapLoc.zoneId] += 2; });
        return scores;
    }, [mappedData, zones]);

    const selectedZoneItems = useMemo(() => {
        if (!selectedZone) return { ptws: [], incidents: [] };
        return {
            ptws: mappedData.ptws.filter(p => p.mapLoc?.zoneId === selectedZone),
            incidents: mappedData.incidents.filter(i => i.mapLoc?.zoneId === selectedZone)
        };
    }, [selectedZone, mappedData]);

    if (!selectedProject) return <div className="p-8 text-center text-gray-500">Please select or create a project.</div>;

    return (
        <div className="h-full flex flex-col">
            {!embedded && (
                <div className="p-4 flex justify-between items-center shrink-0">
                    <div>
                        <h1 className="text-2xl font-bold text-text-primary dark:text-white">Site Digital Twin</h1>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Live view of {selectedProject.name}</p>
                    </div>
                    <div className="flex items-center space-x-2">
                        <ToggleButton label="Heatmap" active={showHeatmap} onClick={() => setShowHeatmap(!showHeatmap)} />
                        <ToggleButton label="Permits" active={showPtws} onClick={() => setShowPtws(!showPtws)} />
                        <ToggleButton label="Incidents" active={showIncidents} onClick={() => setShowIncidents(!showIncidents)} />
                    </div>
                </div>
            )}

            <div className={`flex-1 flex overflow-hidden relative ${embedded ? 'rounded-none' : ''}`}>
                <div className={`flex-1 relative overflow-auto flex items-center justify-center ${embedded ? '' : 'bg-slate-100 dark:bg-slate-900/50 rounded-xl mx-4 mb-4 border border-slate-200 dark:border-white/10 shadow-inner'}`}>
                    <div className="relative" style={{ width: '800px', height: '600px' }}>
                        <div className="absolute inset-0 opacity-10 dark:opacity-5" style={{ backgroundImage: 'radial-gradient(#64748b 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                        
                        <svg width="800" height="600" className="absolute inset-0">
                            {zones.map(zone => (
                                <MapZone 
                                    key={zone.id}
                                    d={zone.d}
                                    label={zone.label}
                                    isActive={selectedZone === zone.id}
                                    riskScore={showHeatmap ? zoneRiskScores[zone.id] : 0}
                                    onClick={() => setSelectedZone(zone.id)}
                                />
                            ))}
                            {showPtws && mappedData.ptws.map((ptw: any) => (
                                <Marker key={ptw.id} x={ptw.mapLoc.x} y={ptw.mapLoc.y} type="ptw" data={ptw} onClick={() => { setSelectedPtw(ptw); setSelectedZone(ptw.mapLoc.zoneId); }} />
                            ))}
                            {showIncidents && mappedData.incidents.map((inc: any) => (
                                <Marker key={inc.id} x={inc.mapLoc.x} y={inc.mapLoc.y} type="incident" data={inc} onClick={() => { setSelectedReport(inc); setSelectedZone(inc.mapLoc.zoneId); }} />
                            ))}
                        </svg>
                    </div>
                </div>

                <div className={`absolute top-4 right-4 w-72 max-h-[calc(100%-2rem)] glass-panel rounded-xl shadow-2xl overflow-hidden transition-transform duration-300 flex flex-col ${selectedZone ? 'translate-x-0' : 'translate-x-[120%]'}`}>
                    <div className="p-3 border-b border-gray-200 dark:border-white/10 bg-gray-50/80 dark:bg-white/5 backdrop-blur-md flex justify-between items-center">
                        <h2 className="font-bold text-slate-800 dark:text-white text-sm">{zones.find(z => z.id === selectedZone)?.label}</h2>
                        <button onClick={() => setSelectedZone(null)} className="text-gray-500 hover:text-red-500">&times;</button>
                    </div>
                    <div className="p-3 overflow-y-auto space-y-4">
                         <div>
                            <h3 className="text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-2">Active Permits</h3>
                             <div className="space-y-2">
                                {selectedZoneItems.ptws.map((ptw: any) => (
                                    <div key={ptw.id} onClick={() => setSelectedPtw(ptw)} className="p-2 rounded bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 hover:border-primary-400 cursor-pointer text-xs transition-colors">
                                        <p className="font-semibold text-slate-800 dark:text-slate-200">{ptw.type}</p>
                                        <p className="text-[10px] text-slate-600 dark:text-slate-400 truncate">{ptw.payload.work.description}</p>
                                    </div>
                                ))}
                                {selectedZoneItems.ptws.length === 0 && <p className="text-xs text-slate-400 italic">None.</p>}
                             </div>
                        </div>
                         <div>
                            <h3 className="text-[10px] font-bold uppercase text-slate-500 dark:text-slate-400 mb-2">Incidents</h3>
                             <div className="space-y-2">
                                {selectedZoneItems.incidents.map((inc: any) => (
                                    <div key={inc.id} onClick={() => setSelectedReport(inc)} className="p-2 rounded bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/30 hover:border-red-400 cursor-pointer text-xs transition-colors">
                                        <p className="font-semibold text-red-700 dark:text-red-300">{inc.type}</p>
                                        <p className="text-[10px] text-slate-600 dark:text-slate-400 truncate">{inc.description}</p>
                                    </div>
                                ))}
                                {selectedZoneItems.incidents.length === 0 && <p className="text-xs text-slate-400 italic">None.</p>}
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

const ToggleButton: React.FC<{ label: string; active: boolean; onClick: () => void }> = ({ label, active, onClick }) => (
    <button 
        onClick={onClick}
        className={`px-3 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide transition-all border ${
            active 
            ? 'bg-slate-800 border-slate-800 text-white dark:bg-neon-blue dark:text-black dark:border-neon-blue shadow-neon-blue' 
            : 'bg-transparent border-slate-300 text-slate-500 dark:border-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-white/5'
        }`}
    >
        {label}
    </button>
);

==================================================
FILE: .\src\components\Tbt.tsx
==================================================

import React, { useState, useMemo } from 'react';
import type { TbtSession } from '../types';
import { Button } from './ui/Button';
import { useAppContext, useDataContext, useModalContext } from '../contexts';
import { 
  Plus, Search, Calendar, MapPin, 
  Users, CheckCircle, Clock, FileText, 
  Megaphone, PenTool, Hash
} from 'lucide-react';

// === GEN 4 STYLES ===
const glassStyles = {
  card: "bg-slate-900/60 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden transition-all duration-300 hover:scale-[1.01] hover:border-emerald-500/30 group relative",
  header: "bg-gradient-to-br from-slate-900/80 to-slate-950/80 backdrop-blur-xl border-b border-white/10 p-6 sticky top-0 z-30",
  badge: "px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider border flex items-center gap-1",
  filterBtn: "px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border transition-all duration-300"
};

const getStatusConfig = (status: TbtSession['status']) => {
    switch (status) {
        case 'delivered':
        case 'closed': return { label: 'DELIVERED', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', icon: CheckCircle };
        case 'scheduled': return { label: 'SCHEDULED', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20', icon: Calendar };
        case 'draft': return { label: 'DRAFT', color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20', icon: PenTool };
        case 'archived': return { label: 'ARCHIVED', color: 'text-slate-500', bg: 'bg-slate-500/10', border: 'border-slate-500/20', icon: FileText };
        default: return { label: status, color: 'text-slate-400', bg: 'bg-slate-500/10', border: 'border-slate-500/20', icon: FileText };
    }
};

const TbtCard: React.FC<{ session: TbtSession; onSelect: (s: TbtSession) => void }> = ({ session, onSelect }) => {
    const status = getStatusConfig(session.status);
    const StatusIcon = status.icon;

    return (
        <div onClick={() => onSelect(session)} className={glassStyles.card}>
            {/* Left Accent Bar */}
            <div className={`absolute left-0 top-0 bottom-0 w-1 ${status.bg.replace('/10', '/50')}`} />
            
            <div className="p-5 pl-7">
                <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-3">
                        <div className="p-2.5 rounded-xl bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 text-emerald-400">
                            <Megaphone className="w-5 h-5" />
                        </div>
                        <div>
                            <h3 className="font-bold text-slate-100 text-sm line-clamp-1">{session.title}</h3>
                            <span className="text-[10px] text-slate-500 font-mono">ID: {session.id.slice(-6)}</span>
                        </div>
                    </div>
                    <div className={`${glassStyles.badge} ${status.bg} ${status.color} ${status.border}`}>
                        <StatusIcon className="w-3 h-3" />
                        {status.label}
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-3 mb-4">
                     <div className="p-2 rounded-lg bg-white/5 border border-white/5 flex items-center gap-2">
                        <Calendar className="w-4 h-4 text-slate-500" />
                        <div>
                            <p className="text-[10px] text-slate-500 uppercase">Date</p>
                            <p className="text-xs font-medium text-slate-300">{new Date(session.date).toLocaleDateString()}</p>
                        </div>
                     </div>
                     <div className="p-2 rounded-lg bg-white/5 border border-white/5 flex items-center gap-2">
                        <Users className="w-4 h-4 text-slate-500" />
                        <div>
                            <p className="text-[10px] text-slate-500 uppercase">Attendees</p>
                            <p className="text-xs font-medium text-slate-300">{session.attendees.length} Signed</p>
                        </div>
                     </div>
                </div>

                <div className="space-y-2 text-xs text-slate-500 mb-2">
                    <div className="flex items-center gap-2">
                        <MapPin className="w-3.5 h-3.5" />
                        <span className="truncate">{session.location}</span>
                    </div>
                </div>

                <div className="pt-3 border-t border-white/5 flex justify-between items-center">
                    <div className="flex items-center gap-2 text-xs text-slate-500">
                        <span className="w-2 h-2 rounded-full bg-slate-600"></span>
                        {session.topic_category}
                    </div>
                    <button className="text-xs font-bold text-emerald-400 hover:text-emerald-300 transition-colors">
                        VIEW DETAILS â†’
                    </button>
                </div>
            </div>
        </div>
    );
};

const StatCard: React.FC<{ title: string; value: string | number; icon: React.ReactNode; color: string }> = ({ title, value, icon, color }) => (
    <div className={`${glassStyles.card} p-4 flex items-center justify-between`}>
        <div>
            <p className="text-xs font-bold text-slate-500 uppercase tracking-wider">{title}</p>
            <p className={`text-2xl font-black mt-1 ${color}`}>{value}</p>
        </div>
        <div className={`p-3 rounded-xl bg-white/5 opacity-80 ${color}`}>
            {icon}
        </div>
    </div>
);

const FilterChip: React.FC<{label: string, active: boolean, onClick: () => void}> = ({ label, active, onClick }) => (
    <button
        onClick={onClick}
        className={`${glassStyles.filterBtn} ${
            active 
            ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/50 shadow-[0_0_15px_rgba(16,185,129,0.2)]' 
            : 'bg-white/5 text-slate-400 border-white/10 hover:bg-white/10 hover:text-slate-200'
        }`}
    >
        {label}
    </button>
)

export const Tbt: React.FC = () => {
  const { tbtList } = useDataContext();
  const { setIsTbtCreationModalOpen, setSelectedTbt } = useModalContext();
  const { can } = useAppContext();
  
  const [filter, setFilter] = useState<'All' | 'Upcoming' | 'Delivered'>('All');
  const [search, setSearch] = useState('');

  const stats = useMemo(() => ({
      total: tbtList.length,
      upcoming: tbtList.filter(s => s.status === 'scheduled' || s.status === 'draft').length,
      delivered: tbtList.filter(s => s.status === 'delivered').length,
      attendees: tbtList.reduce((acc, curr) => acc + curr.attendees.length, 0)
  }), [tbtList]);

  const filteredList = useMemo(() => {
      return tbtList.filter(s => {
          const searchMatch = !search || s.title.toLowerCase().includes(search.toLowerCase());
          if (filter === 'All') return searchMatch;
          if (filter === 'Upcoming') return searchMatch && (s.status === 'scheduled' || s.status === 'draft');
          if (filter === 'Delivered') return searchMatch && s.status === 'delivered';
          return searchMatch;
      });
  }, [tbtList, filter, search]);

  return (
    <div className="min-h-screen bg-transparent text-slate-200 p-6">
      
      {/* HEADER */}
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
        <div>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                <Megaphone className="w-8 h-8 text-emerald-400" />
                Toolbox Talks
            </h1>
            <p className="text-slate-400 mt-1">Briefings, attendance logs, and safety communication.</p>
        </div>
        
        {can('create', 'tbt') && (
            <Button onClick={() => setIsTbtCreationModalOpen(true)} className="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white shadow-lg shadow-emerald-900/20 border-0">
                <Plus className="w-5 h-5 mr-2" />
                New TBT Session
            </Button>
        )}
      </div>

      {/* STATS */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <StatCard title="Total Sessions" value={stats.total} color="text-blue-400" icon={<Hash className="w-6 h-6"/>} />
          <StatCard title="Upcoming" value={stats.upcoming} color="text-amber-400" icon={<Clock className="w-6 h-6"/>} />
          <StatCard title="Delivered" value={stats.delivered} color="text-emerald-400" icon={<CheckCircle className="w-6 h-6"/>} />
          <StatCard title="Total Attendees" value={stats.attendees} color="text-purple-400" icon={<Users className="w-6 h-6"/>} />
      </div>

      {/* FILTERS */}
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
          <div className="lg:col-span-3 space-y-4">
              <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                  <FilterChip label="All" active={filter === 'All'} onClick={() => setFilter('All')} />
                  <FilterChip label="Upcoming" active={filter === 'Upcoming'} onClick={() => setFilter('Upcoming')} />
                  <FilterChip label="Delivered" active={filter === 'Delivered'} onClick={() => setFilter('Delivered')} />
              </div>
              <div className="relative">
                  <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" />
                  <input 
                      type="text" 
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                      placeholder="Search talks by title or location..." 
                      className="w-full bg-slate-900/50 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-slate-200 placeholder:text-slate-600 focus:outline-none focus:border-emerald-500/50 transition-all"
                  />
              </div>
          </div>
      </div>

      {/* GRID */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {filteredList.map(session => (
              <TbtCard key={session.id} session={session} onSelect={setSelectedTbt} />
          ))}

          {filteredList.length === 0 && (
            <div className="col-span-full py-20 text-center border-2 border-dashed border-white/10 rounded-3xl">
                <Megaphone className="w-16 h-16 text-slate-700 mx-auto mb-3" />
                <h3 className="text-xl font-bold text-slate-400 mb-2">No Talks Found</h3>
                <p className="text-slate-600">Schedule a new Toolbox Talk to get started.</p>
            </div>
        )}
      </div>

    </div>
  );
};

==================================================
FILE: .\src\components\TbtCreationModal.tsx
==================================================

import React, { useState } from 'react';
import type { TbtSession, Project, User } from '../types';
import { Button } from './ui/Button';
import { generateTbtContent } from '../services/geminiService';
import { tbtTopicsLibrary } from '../config';
import { FormField } from './ui/FormField';

interface TbtCreationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<TbtSession, 'id' | 'org_id' | 'attendees' | 'attachments' | 'audit_log'>) => void;
  projects: Project[];
  activeUser: User;
}

// Icons
const SparklesIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624l-.259 1.035L16.38 20.624a3.375 3.375 0 00-2.455-2.455l-1.036-.259.259-1.035a3.375 3.375 0 002.456-2.456l.259-1.035.259 1.035a3.375 3.375 0 00-2.456 2.456z" /></svg>;
const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;

export const TbtCreationModal: React.FC<TbtCreationModalProps> = ({ isOpen, onClose, onSubmit, projects, activeUser }) => {
  const [formData, setFormData] = useState<Omit<TbtSession, 'id' | 'org_id' | 'attendees' | 'attachments' | 'audit_log'>>({
    project_id: projects[0]?.id || '',
    title: '',
    topic_category: Object.keys(tbtTopicsLibrary)[0],
    method: 'daily',
    location: '',
    conducted_by: { name: activeUser.name, role: activeUser.role, signature: '' },
    date: new Date().toISOString().split('T')[0],
    time: new Date().toTimeString().slice(0, 5),
    summary: '',
    hazards_discussed: [],
    controls_discussed: [],
    discussion_points: [],
    linked_rams_ids: [],
    linked_ptw_types: [],
    linked_plan_ids: [],
    status: 'draft',
  });
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState('');

  const handleAiGenerate = async () => {
    if (!formData.title) {
        setError("Please enter a title for the TBT first to provide context for the AI.");
        return;
    }
    setError('');
    setIsGenerating(true);
    try {
        const content = await generateTbtContent(formData.title);
        setFormData(prev => ({
            ...prev,
            summary: content.summary,
            hazards_discussed: content.hazards,
            controls_discussed: content.controls,
            discussion_points: content.questions,
        }));
    } catch (e) {
        setError("Failed to generate AI content. Please try again.");
    } finally {
        setIsGenerating(false);
    }
  };
  
  const handleSubmit = () => {
      if (!formData.title || !formData.location) {
          setError("Title and Location are required.");
          return;
      }
      onSubmit(formData);
      onClose();
  }

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header */}
        <div className="p-6 border-b dark:border-dark-border flex justify-between items-center bg-white dark:bg-dark-card sticky top-0 z-10">
          <h3 className="text-xl font-bold text-gray-900 dark:text-white">New Toolbox Talk Session</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <CloseIcon className="w-6 h-6" />
          </button>
        </div>

        <div className="p-6 space-y-6 overflow-y-auto">
          
          {/* Core Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <FormField label="Topic Category">
                <select 
                    value={formData.topic_category} 
                    onChange={e => setFormData(p => ({...p, topic_category: e.target.value, title: ''}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                >
                    {Object.keys(tbtTopicsLibrary).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                </select>
            </FormField>
             <FormField label="Talk Title">
                <select 
                    value={formData.title} 
                    onChange={e => setFormData(p => ({...p, title: e.target.value}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                >
                    <option value="">Select a title or type below</option>
                    {(tbtTopicsLibrary[formData.topic_category as keyof typeof tbtTopicsLibrary] || []).map(topic => <option key={topic} value={topic}>{topic}</option>)}
                </select>
            </FormField>
          </div>

          <FormField label="Or Enter Custom Title" fullWidth>
            <input 
                type="text" 
                value={formData.title} 
                onChange={e => setFormData(p => ({...p, title: e.target.value}))} 
                className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                placeholder="e.g. Working at Height Safety"
            />
          </FormField>
          
           {/* AI Generator */}
           <div className="p-4 border border-dashed border-primary-300 dark:border-primary-700 bg-primary-50 dark:bg-primary-900/10 rounded-lg">
               <div className="flex justify-between items-center">
                   <div>
                       <h4 className="font-semibold text-primary-900 dark:text-primary-100">AI Content Generator</h4>
                       <p className="text-xs text-primary-700 dark:text-primary-300">Auto-fill summary, hazards, and controls based on the title.</p>
                   </div>
                    <Button onClick={handleAiGenerate} disabled={isGenerating || !formData.title} className="bg-primary-600 text-white">
                        {isGenerating ? 'Generating...' : <><SparklesIcon className="w-4 h-4 mr-2" /> Generate Content</>}
                    </Button>
               </div>
           </div>
          
           {/* Logistics */}
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <FormField label="Project">
                <select 
                    value={formData.project_id} 
                    onChange={e => setFormData(p => ({...p, project_id: e.target.value}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                >
                    {projects.map(proj => <option key={proj.id} value={proj.id}>{proj.name}</option>)}
                </select>
            </FormField>
             <FormField label="Location">
                <input 
                    type="text" 
                    value={formData.location} 
                    onChange={e => setFormData(p => ({...p, location: e.target.value}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                    placeholder="e.g. Site C, Assembly Area"
                />
            </FormField>
            <FormField label="Date">
                <input 
                    type="date" 
                    value={formData.date} 
                    onChange={e => setFormData(p => ({...p, date: e.target.value}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                />
            </FormField>
            <FormField label="Time">
                <input 
                    type="time" 
                    value={formData.time} 
                    onChange={e => setFormData(p => ({...p, time: e.target.value}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white"
                />
            </FormField>
           </div>
           
            {/* Content Fields */}
            <FormField label="Summary" fullWidth>
                <textarea 
                    rows={3} 
                    value={formData.summary} 
                    onChange={e => setFormData(p => ({...p, summary: e.target.value}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                />
            </FormField>
            <FormField label="Hazards Discussed" fullWidth>
                <textarea 
                    rows={3} 
                    value={formData.hazards_discussed?.join('\n') || ''} 
                    onChange={e => setFormData(p => ({...p, hazards_discussed: e.target.value.split('\n')}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                    placeholder="One hazard per line"
                />
            </FormField>
            <FormField label="Controls Discussed" fullWidth>
                <textarea 
                    rows={3} 
                    value={formData.controls_discussed?.join('\n') || ''} 
                    onChange={e => setFormData(p => ({...p, controls_discussed: e.target.value.split('\n')}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                    placeholder="One control per line"
                />
            </FormField>
            <FormField label="Questions for Workers" fullWidth>
                <textarea 
                    rows={3} 
                    value={formData.discussion_points?.join('\n') || ''} 
                    onChange={e => setFormData(p => ({...p, discussion_points: e.target.value.split('\n')}))} 
                    className="w-full p-2 border border-gray-300 dark:border-dark-border rounded-md bg-white dark:bg-dark-background text-gray-900 dark:text-white" 
                    placeholder="One question per line"
                />
            </FormField>

            {error && (
                <div className="p-3 bg-red-100 border border-red-400 text-red-700 rounded text-sm font-semibold">
                    {error}
                </div>
            )}
        </div>

        <div className="bg-gray-50 dark:bg-black/20 px-6 py-4 flex justify-end space-x-2 border-t dark:border-dark-border sticky bottom-0">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Create TBT</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\TbtSessionModal.tsx
==================================================

import React, { useState, useRef, useEffect } from 'react';
import type { TbtSession, TbtAttendee, User } from '../types';
import { Button } from './ui/Button';
import { ActionsBar } from './ui/ActionsBar';
import { EmailModal } from './ui/EmailModal';

interface TbtSessionModalProps {
  session: TbtSession;
  onClose: () => void;
  onUpdate: (session: TbtSession) => void;
  users: User[];
}

const DetailItem: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
    <div className="py-2">
        <p className="text-sm font-medium text-gray-500 dark:text-gray-400">{label}</p>
        <div className="text-base text-gray-900 dark:text-white mt-1">{children}</div>
    </div>
);

const SignaturePad: React.FC<{ onSave: (dataUrl: string) => void }> = ({ onSave }) => {
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const [isDrawing, setIsDrawing] = useState(false);

    useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
    }, []);

    const startDrawing = ({ nativeEvent }: React.MouseEvent<HTMLCanvasElement>) => {
        const { offsetX, offsetY } = nativeEvent;
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY);
        setIsDrawing(true);
    };

    const draw = ({ nativeEvent }: React.MouseEvent<HTMLCanvasElement>) => {
        if (!isDrawing) return;
        const { offsetX, offsetY } = nativeEvent;
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.lineTo(offsetX, offsetY);
        ctx.stroke();
    };

    const stopDrawing = () => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.closePath();
        setIsDrawing(false);
    };

    const clear = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    const handleSave = () => {
        const dataUrl = canvasRef.current?.toDataURL() || '';
        onSave(dataUrl);
    };

    return (
        <div className="space-y-2">
            <canvas
                ref={canvasRef}
                width={300}
                height={150}
                className="border bg-white rounded-md cursor-crosshair"
                onMouseDown={startDrawing}
                onMouseMove={draw}
                onMouseUp={stopDrawing}
                onMouseLeave={stopDrawing}
            />
            <div className="space-x-2">
                <Button variant="secondary" size="sm" onClick={clear}>Clear</Button>
                <Button size="sm" onClick={handleSave}>Save Signature</Button>
            </div>
        </div>
    );
};

export const TbtSessionModal: React.FC<TbtSessionModalProps> = ({ session, onClose, onUpdate, users = [] }) => {
    const [editedSession, setEditedSession] = useState(session);
    const [newAttendee, setNewAttendee] = useState({ name: '', company: '', role: '' });
    const [isSigning, setIsSigning] = useState(false);
    const [isEmailModalOpen, setIsEmailModalOpen] = useState(false);
    const isViewMode = session.status === 'delivered' || session.status === 'closed';

    const handleAddAttendee = (signature: string) => {
        const attendee: TbtAttendee = {
            ...newAttendee,
            signature,
            attendance_time: new Date().toISOString(),
        };
        setEditedSession(prev => ({ ...prev, attendees: [...prev.attendees, attendee]}));
        setNewAttendee({ name: '', company: '', role: '' });
        setIsSigning(false);
    };
    
    const handleFinalize = () => {
        const finalSession = { ...editedSession, status: 'delivered' as const };
        onUpdate(finalSession);
    };

    const handlePrint = () => window.print();

    // Safety check: ensure users is an array before finding
    const conductedByUser = (users || []).find(u => u.name === editedSession.conducted_by.name);

    return (
        <>
        <div id="printable-tbt" className="hidden print:block p-8 bg-white text-black">
            <h1 className="text-2xl font-bold">{editedSession.title}</h1>
            <p><strong>Date:</strong> {editedSession.date} at {editedSession.time}</p>
            <p><strong>Location:</strong> {editedSession.location}</p>
            <p><strong>Conducted By:</strong> {editedSession.conducted_by.name}</p>
            <h2 className="text-xl font-bold mt-4 border-b">Summary</h2>
            <p className="mt-2">{editedSession.summary}</p>
            <h2 className="text-xl font-bold mt-4 border-b">Attendance</h2>
            <table className="w-full mt-2 text-sm border-collapse border">
                <thead><tr className="bg-gray-100">
                    <th className="border p-2">Name</th><th className="border p-2">Company</th><th className="border p-2">Signature</th>
                </tr></thead>
                <tbody>
                    {editedSession.attendees.map((att, i) => (
                        <tr key={i}><td className="border p-2">{att.name}</td><td className="border p-2">{att.company}</td><td className="border p-2"><img src={att.signature} className="h-8" alt="sig"/></td></tr>
                    ))}
                </tbody>
            </table>
        </div>
        <style>{`
        @media print {
          body * { visibility: hidden; }
          #printable-tbt, #printable-tbt * { visibility: visible; }
          #printable-tbt { position: absolute; left: 0; top: 0; width: 100%; }
           @page { size: A4; margin: 1.5cm; }
        }
      `}</style>
        <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4 print:hidden" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <header className="p-4 border-b dark:border-dark-border flex justify-between items-center bg-white dark:bg-dark-card sticky top-0 z-10">
                    <div>
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">{session.title}</h2>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Toolbox Talk Record</p>
                    </div>
                    <div className="flex items-center gap-4">
                        <ActionsBar onPrint={handlePrint} onDownloadPdf={handlePrint} onEmail={() => setIsEmailModalOpen(true)} />
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><CloseIcon className="w-6 h-6"/></button>
                    </div>
                </header>
                <div className="flex-grow flex overflow-hidden">
                    <main className="flex-1 p-6 overflow-y-auto space-y-6 bg-white dark:bg-dark-card">
                        <DetailItem label="Summary">{editedSession.summary}</DetailItem>
                        <DetailItem label="Hazards Discussed"><ul className="list-disc list-inside text-gray-700 dark:text-gray-300">{editedSession.hazards_discussed.map((h,i) => <li key={i}>{h}</li>)}</ul></DetailItem>
                        <DetailItem label="Controls Discussed"><ul className="list-disc list-inside text-gray-700 dark:text-gray-300">{editedSession.controls_discussed.map((c,i) => <li key={i}>{c}</li>)}</ul></DetailItem>
                        {editedSession.discussion_points && <DetailItem label="Discussion Points"><ul className="list-disc list-inside text-gray-700 dark:text-gray-300">{editedSession.discussion_points.map((q,i) => <li key={i}>{q}</li>)}</ul></DetailItem>}
                    </main>
                    <aside className="w-96 bg-gray-50 dark:bg-dark-background border-l dark:border-dark-border p-4 overflow-y-auto">
                        <h3 className="font-bold text-lg mb-4 text-gray-900 dark:text-white">Attendance</h3>
                        <div className="space-y-2">
                           {editedSession.attendees.map((att, index) => (
                               <div key={index} className="p-2 border dark:border-dark-border rounded-md bg-white dark:bg-dark-card flex items-center">
                                   <div className="flex-grow">
                                       <p className="font-semibold text-sm text-gray-900 dark:text-white">{att.name}</p>
                                       <p className="text-xs text-gray-500 dark:text-gray-400">{att.company}</p>
                                   </div>
                                   <img src={att.signature} alt="signature" className="h-8 w-20 object-contain bg-white rounded"/>
                               </div>
                           ))}
                        </div>
                         {!isViewMode && (
                            <div className="mt-4 border-t dark:border-dark-border pt-4">
                                {isSigning ? (
                                    <div className="space-y-2">
                                        <h4 className="font-semibold text-gray-900 dark:text-white">Sign In</h4>
                                        <SignaturePad onSave={handleAddAttendee}/>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        <h4 className="font-semibold text-gray-900 dark:text-white">Add Attendee</h4>
                                        <input value={newAttendee.name} onChange={e => setNewAttendee(p => ({...p, name: e.target.value}))} placeholder="Name" className="w-full p-2 border dark:border-dark-border rounded-md text-sm bg-white dark:bg-dark-card text-gray-900 dark:text-white"/>
                                        <input value={newAttendee.company} onChange={e => setNewAttendee(p => ({...p, company: e.target.value}))} placeholder="Company" className="w-full p-2 border dark:border-dark-border rounded-md text-sm bg-white dark:bg-dark-card text-gray-900 dark:text-white"/>
                                        <Button onClick={() => setIsSigning(true)} disabled={!newAttendee.name || !newAttendee.company} className="w-full">Proceed to Sign</Button>
                                    </div>
                                )}
                            </div>
                         )}
                    </aside>
                </div>
                 {!isViewMode && (
                     <footer className="p-4 border-t bg-gray-100 dark:bg-dark-background dark:border-dark-border flex justify-end sticky bottom-0 z-10">
                        <Button onClick={handleFinalize}>Finalize & Deliver Session</Button>
                    </footer>
                 )}
            </div>
        </div>
        <EmailModal 
            isOpen={isEmailModalOpen}
            onClose={() => setIsEmailModalOpen(false)}
            documentTitle={`TBT Summary: ${session.title}`}
            defaultRecipients={conductedByUser ? [conductedByUser] : []}
            documentLink="#"
        />
        </>
    );
};

const CloseIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;

==================================================
FILE: .\src\components\TrainingAnalytics.tsx
==================================================

import React from 'react';
import type { TrainingRecord, TrainingCourse } from '../types';
import { Card } from './ui/Card';
import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, Legend } from 'recharts';

interface TrainingAnalyticsProps {
  records: TrainingRecord[];
  courses: TrainingCourse[];
}

const COLORS = ['#10B981', '#F59E0B', '#EF4444']; // Green, Amber, Red

export const TrainingAnalytics: React.FC<TrainingAnalyticsProps> = ({ records, courses }) => {
  
  // Calculate Status Distribution
  const statusData = [
    { name: 'Valid', value: records.filter(r => r.status === 'valid').length },
    { name: 'Expiring Soon', value: records.filter(r => r.status === 'expiring_soon').length },
    { name: 'Expired', value: records.filter(r => r.status === 'expired').length },
  ];

  // Calculate Course Popularity/Completion
  const courseData = courses.map(c => ({
    name: c.title.length > 15 ? c.title.substring(0, 15) + '...' : c.title,
    count: records.filter(r => r.course_id === c.id).length
  })).sort((a, b) => b.count - a.count).slice(0, 5);

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <Card title="Compliance Status">
        <div className="h-64 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={statusData}
                cx="50%"
                cy="50%"
                innerRadius={60}
                outerRadius={80}
                fill="#8884d8"
                paddingAngle={5}
                dataKey="value"
              >
                {statusData.map((_, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                ))}
              </Pie>
              <Tooltip 
                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }}
              />
              <Legend verticalAlign="bottom" height={36}/>
            </PieChart>
          </ResponsiveContainer>
        </div>
      </Card>

      <Card title="Top Completed Courses">
        <div className="h-64 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart
              data={courseData}
              layout="vertical"
              margin={{ top: 5, right: 30, left: 40, bottom: 5 }}
            >
              <XAxis type="number" hide />
              <YAxis type="category" dataKey="name" width={100} tick={{fontSize: 11}} />
              <Tooltip cursor={{fill: 'transparent'}} />
              <Bar dataKey="count" fill="#3B82F6" radius={[0, 4, 4, 0]} barSize={20} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </Card>
    </div>
  );
};

==================================================
FILE: .\src\components\TrainingAttendanceModal.tsx
==================================================

import React, { useState } from 'react';
import { Button } from './ui/Button';
import type { TrainingSession, User } from '../types';

interface TrainingAttendanceModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (sessionId: string, attendance: TrainingSession['attendance']) => void;
  session: TrainingSession;
  users: User[];
}

export const TrainingAttendanceModal: React.FC<TrainingAttendanceModalProps> = ({
  isOpen,
  onClose,
  onSubmit,
  session,
  users
}) => {
  // Initialize state with existing attendance or default to false
  const [attendance, setAttendance] = useState<TrainingSession['attendance']>(() => {
    // If we have previous attendance data, use it
    if (session.attendance && session.attendance.length > 0) {
        return session.attendance;
    }
    // Otherwise create default entries for everyone in the roster
    if (session.roster) {
        return session.roster.map(uid => ({ user_id: uid, attended: false, score: undefined }));
    }
    return [];
  });

  const handleToggle = (userId: string) => {
    setAttendance(prev => prev.map(a => 
        a.user_id === userId ? { ...a, attended: !a.attended } : a
    ));
  };

  const handleScoreChange = (userId: string, val: string) => {
    const score = parseInt(val);
    setAttendance(prev => prev.map(a => 
        a.user_id === userId ? { ...a, score: isNaN(score) ? undefined : score } : a
    ));
  };

  const handleSubmit = () => {
    onSubmit(session.id, attendance);
    onClose();
  };

  if (!isOpen) return null;

  // Get user objects for the roster IDs
  const enrolledUsers = session.roster 
    ? session.roster.map(id => users.find(u => u.id === id)).filter(Boolean) as User[]
    : [];

  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b dark:border-gray-700 bg-white dark:bg-dark-card shrink-0">
          <h3 className="text-xl font-bold text-gray-900 dark:text-white">Mark Attendance</h3>
          <p className="text-sm text-gray-500 mt-1">Session ID: {session.id}</p>
        </div>
        
        <div className="p-6 overflow-y-auto">
          {enrolledUsers.length > 0 ? (
            <div className="space-y-3">
              {enrolledUsers.map(user => {
                const record = attendance.find(a => a.user_id === user.id);
                const isAttended = record?.attended;
                
                return (
                    <div key={user.id} className={`flex items-center justify-between p-4 border rounded-xl transition-all ${isAttended ? 'bg-green-50 border-green-200 dark:bg-green-900/10 dark:border-green-900/30' : 'bg-white border-gray-200 dark:bg-dark-background dark:border-gray-700'}`}>
                    <div className="flex items-center gap-4">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${isAttended ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300'}`}>
                        {user.name.charAt(0)}
                        </div>
                        <div>
                        <p className="font-semibold text-gray-900 dark:text-white">{user.name}</p>
                        <p className="text-xs text-gray-500">{user.role}</p>
                        </div>
                    </div>

                    <div className="flex items-center gap-4">
                        {isAttended && (
                             <div className="flex items-center gap-2">
                                <label className="text-xs text-gray-500 font-medium">Score:</label>
                                <input 
                                    type="number" 
                                    min="0" max="100" 
                                    className="w-16 p-1 text-sm border rounded text-center dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                                    value={record?.score ?? ''}
                                    onChange={(e) => handleScoreChange(user.id, e.target.value)}
                                    onClick={(e) => e.stopPropagation()}
                                    placeholder="%"
                                />
                             </div>
                        )}
                        <button 
                            onClick={() => handleToggle(user.id)}
                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${isAttended ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600'}`}
                        >
                            {isAttended ? 'Present' : 'Absent'}
                        </button>
                    </div>
                    </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500 dark:text-gray-400">
                <p>No employees are enrolled in this session.</p>
                <p className="text-xs mt-1">Edit the session to add attendees.</p>
            </div>
          )}
        </div>

        <div className="p-6 border-t dark:border-gray-700 bg-gray-50 dark:bg-dark-background/50 shrink-0 flex justify-end gap-3">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Save Attendance</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\TrainingCourseModal.tsx
==================================================

import React, { useState } from 'react';
import type { TrainingCourse } from '../types';
import { Button } from './ui/Button';
import { generateCourseContent } from '../services/geminiService';
import { Sparkles } from 'lucide-react';

interface TrainingCourseModalProps {
  isOpen: boolean;
  onClose: () => void;
  courses: TrainingCourse[];
  onUpdateCourse: (course: TrainingCourse) => void;
}

const FormField: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
    <div className="mb-4">
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
        {children}
    </div>
);

export const TrainingCourseModal: React.FC<TrainingCourseModalProps> = ({ isOpen, onClose, onUpdateCourse }) => {
  const [newCourse, setNewCourse] = useState<Omit<TrainingCourse, 'id' | 'org_id'>>({
    title: '',
    category: '',
    validity_months: 24,
    syllabus: '',
    learning_objectives: [],
    requires_assessment: true,
  });
  
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState('');

  const handleAiGenerate = async () => {
    if (!newCourse.title) {
        setError("Please provide a Course Title for the AI context.");
        return;
    }
    setError('');
    setIsGenerating(true);
    
    try {
        const content = await generateCourseContent(newCourse.title);
        setNewCourse(prev => ({
            ...prev,
            syllabus: content.syllabus,
            learning_objectives: content.learning_objectives,
        }));
    } catch (e) {
        console.error(e);
        setError("Failed to generate content. Please try again.");
    } finally {
        setIsGenerating(false);
    }
  };

  const handleAddCourse = () => {
    if (!newCourse.title) {
        setError("Course Title is required.");
        return;
    }
    const course: TrainingCourse = {
        ...newCourse,
        id: `tc_${Date.now()}`,
        org_id: 'org_1'
    };
    onUpdateCourse(course);
    onClose();
    // Reset form
    setNewCourse({
        title: '',
        category: '',
        validity_months: 24,
        syllabus: '',
        learning_objectives: [],
        requires_assessment: true,
    });
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center items-center p-4" onClick={onClose}>
      <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b dark:border-gray-800 flex justify-between items-center">
          <h3 className="text-xl font-bold text-gray-900 dark:text-white">Manage Training Courses</h3>
          <button onClick={onClose} className="text-gray-500 hover:text-white">âœ•</button>
        </div>
        
        <div className="p-6 flex-grow overflow-y-auto">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                     <FormField label="Course Title">
                        <input type="text" placeholder="e.g. Working at Height" value={newCourse.title} onChange={e => setNewCourse(p => ({...p, title: e.target.value}))} className="w-full p-2 border rounded-lg dark:bg-slate-800 dark:border-gray-700 dark:text-white"/>
                     </FormField>
                     
                     <div className="grid grid-cols-2 gap-4">
                        <FormField label="Category">
                            <input type="text" placeholder="High Risk" value={newCourse.category} onChange={e => setNewCourse(p => ({...p, category: e.target.value}))} className="w-full p-2 border rounded-lg dark:bg-slate-800 dark:border-gray-700 dark:text-white"/>
                        </FormField>
                        <FormField label="Validity (months)">
                            <input type="number" value={newCourse.validity_months} onChange={e => setNewCourse(p => ({...p, validity_months: parseInt(e.target.value)}))} className="w-full p-2 border rounded-lg dark:bg-slate-800 dark:border-gray-700 dark:text-white"/>
                        </FormField>
                     </div>

                     {/* AI Button */}
                     <div className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border border-purple-200 dark:border-purple-800">
                        <div className="flex justify-between items-center">
                            <div>
                                <h4 className="font-semibold text-purple-900 dark:text-purple-300">AI Syllabus Creator</h4>
                                <p className="text-xs text-gray-500 dark:text-gray-400">Generates modules & objectives.</p>
                            </div>
                            <Button onClick={handleAiGenerate} disabled={isGenerating}>
                                {isGenerating ? 'Creating...' : <><Sparkles className="w-4 h-4 mr-2"/>Draft with AI</>}
                            </Button>
                        </div>
                    </div>

                    <FormField label="Learning Objectives">
                        {newCourse.learning_objectives.length > 0 ? (
                            <ul className="list-disc pl-5 text-sm space-y-1 text-gray-700 dark:text-gray-300">
                                {newCourse.learning_objectives.map((obj, i) => <li key={i}>{obj}</li>)}
                            </ul>
                        ) : (
                            <p className="text-xs text-gray-500 italic">No objectives yet. Use AI to generate.</p>
                        )}
                    </FormField>
                    
                    {error && <p className="text-sm text-red-500">{error}</p>}
                </div>

                <div className="h-full flex flex-col">
                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Syllabus (Markdown)</label>
                    <textarea 
                        value={newCourse.syllabus} 
                        onChange={e => setNewCourse(p => ({...p, syllabus: e.target.value}))} 
                        className="w-full flex-grow p-4 border rounded-lg font-mono text-sm dark:bg-slate-800 dark:border-gray-700 dark:text-gray-300"
                        placeholder="# Module 1..."
                    />
                </div>
            </div>
        </div>

        <div className="bg-gray-50 dark:bg-slate-800 px-6 py-4 flex justify-end gap-3 rounded-b-xl border-t dark:border-gray-700">
          <Button variant="secondary" onClick={onClose}>Close</Button>
          <Button onClick={handleAddCourse}>Add New Course</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\TrainingManagement.tsx
==================================================

import React, { useState } from 'react';
import type { TrainingCourse, TrainingRecord, TrainingSession, User, Project } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge'; // <--- Added this import
import { useAppContext } from '../contexts';
import { TrainingMatrixView } from './TrainingMatrixView';
import { TrainingAnalytics } from './TrainingAnalytics';
import { 
    GraduationCap, Calendar, Users, 
    BarChart3, Table, Plus 
} from 'lucide-react';

interface TrainingManagementProps {
  courses: TrainingCourse[];
  records: TrainingRecord[];
  sessions: TrainingSession[];
  users: User[];
  projects: Project[];
  onManageCourses: () => void;
  onScheduleSession: (course: TrainingCourse) => void;
  onManageAttendance: (session: TrainingSession) => void;
}

export const EnhancedTrainings: React.FC<TrainingManagementProps> = (props) => {
  const { courses, records, sessions, users, onManageCourses, onScheduleSession, onManageAttendance } = props;
  const { can } = useAppContext();
  const [activeTab, setActiveTab] = useState<'Overview' | 'Matrix' | 'Sessions' | 'Courses'>('Overview');

  const stats = {
      totalCourses: courses.length,
      activeSessions: sessions.filter(s => s.status === 'scheduled').length,
      certifiedUsers: new Set(records.map(r => r.user_id)).size,
      complianceRate: 92 // Mock for now
  };

  const getCourseTitle = (id: string) => courses.find(c => c.id === id)?.title || 'Unknown';
  const getUserName = (id: string) => users.find(u => u.id === id)?.name || 'Unknown';

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-text-primary dark:text-white">Training Academy</h1>
          <p className="text-text-secondary dark:text-gray-400">Manage competency, schedule sessions, and track compliance.</p>
        </div>
        <div className="flex gap-2">
            {can('create', 'training') && (
                <>
                    <Button onClick={onManageCourses} variant="outline">
                        <GraduationCap className="w-5 h-5 mr-2" /> Manage Courses
                    </Button>
                    <Button onClick={() => courses.length > 0 && onScheduleSession(courses[0])}>
                        <Plus className="w-5 h-5 mr-2" /> Schedule Session
                    </Button>
                </>
            )}
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-4">
              <div className="p-3 bg-blue-100 text-blue-600 rounded-lg"><GraduationCap className="w-6 h-6"/></div>
              <div><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.totalCourses}</p><p className="text-xs text-gray-500">Active Courses</p></div>
          </div>
           <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-4">
              <div className="p-3 bg-purple-100 text-purple-600 rounded-lg"><Calendar className="w-6 h-6"/></div>
              <div><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.activeSessions}</p><p className="text-xs text-gray-500">Upcoming Sessions</p></div>
          </div>
           <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-4">
              <div className="p-3 bg-green-100 text-green-600 rounded-lg"><Users className="w-6 h-6"/></div>
              <div><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.certifiedUsers}</p><p className="text-xs text-gray-500">Trained Personnel</p></div>
          </div>
           <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-4">
              <div className="p-3 bg-amber-100 text-amber-600 rounded-lg"><BarChart3 className="w-6 h-6"/></div>
              <div><p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.complianceRate}%</p><p className="text-xs text-gray-500">Compliance Rate</p></div>
          </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-200 dark:border-gray-700">
        <nav className="-mb-px flex space-x-6">
            {['Overview', 'Matrix', 'Sessions', 'Courses'].map((tab) => (
                <button
                    key={tab}
                    onClick={() => setActiveTab(tab as any)}
                    className={`
                        py-4 px-1 border-b-2 font-medium text-sm flex items-center
                        ${activeTab === tab 
                            ? 'border-primary-500 text-primary-600 dark:text-primary-400' 
                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}
                    `}
                >
                    {tab === 'Overview' && <BarChart3 className="w-4 h-4 mr-2"/>}
                    {tab === 'Matrix' && <Table className="w-4 h-4 mr-2"/>}
                    {tab}
                </button>
            ))}
        </nav>
      </div>

      {/* Tab Content */}
      <div className="min-h-[400px]">
          {activeTab === 'Overview' && (
              <TrainingAnalytics records={records} courses={courses} />
          )}

          {activeTab === 'Matrix' && (
              <TrainingMatrixView users={users} courses={courses} records={records} />
          )}

          {activeTab === 'Sessions' && (
             <Card title="Scheduled Sessions">
                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead className="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Course</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Date</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Trainer</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                            <th className="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                        {sessions.map(s => (
                            <tr key={s.id}>
                                <td className="px-6 py-4 font-medium text-gray-900 dark:text-white">{getCourseTitle(s.course_id)}</td>
                                <td className="px-6 py-4 text-gray-500">{new Date(s.scheduled_at).toLocaleDateString()}</td>
                                <td className="px-6 py-4 text-gray-500">{getUserName(s.trainer_id)}</td>
                                <td className="px-6 py-4">
                                    <Badge color={s.status === 'completed' ? 'green' : 'blue'}>{s.status}</Badge>
                                </td>
                                <td className="px-6 py-4 text-right">
                                    {can('update', 'training') && (
                                        <Button size="sm" variant="ghost" onClick={() => onManageAttendance(s)}>
                                            {s.status === 'scheduled' ? 'Manage' : 'View'}
                                        </Button>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
             </Card>
          )}

          {activeTab === 'Courses' && (
               <Card title="Course Catalog">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {courses.map(c => (
                        <div key={c.id} className="border dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow bg-white dark:bg-gray-900">
                            <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1">{c.title}</h3>
                            <Badge color="purple" size="sm">{c.category}</Badge>
                            <p className="text-xs text-gray-500 mt-3 mb-4 line-clamp-2">{c.syllabus.substring(0, 100)}...</p>
                            <div className="flex justify-between items-center text-xs text-gray-400 border-t dark:border-gray-700 pt-3">
                                <span>Valid: {c.validity_months} months</span>
                                <Button size="sm" variant="ghost" onClick={() => onScheduleSession(c)}>Schedule</Button>
                            </div>
                        </div>
                    ))}
                </div>
               </Card>
          )}
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\TrainingMatrixView.tsx
==================================================

import React from 'react';
import type { User, TrainingCourse, TrainingRecord } from '../types';
import { CheckCircle, XCircle, AlertTriangle, Minus } from 'lucide-react';

interface TrainingMatrixViewProps {
  users: User[];
  courses: TrainingCourse[];
  records: TrainingRecord[];
}

export const TrainingMatrixView: React.FC<TrainingMatrixViewProps> = ({ users, courses, records }) => {
  
  const getStatus = (userId: string, courseId: string) => {
    const record = records.find(r => r.user_id === userId && r.course_id === courseId);
    if (!record) return 'missing';
    
    // Check expiry
    const expiryDate = new Date(record.expires_at);
    const today = new Date();
    const daysUntilExpiry = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

    if (daysUntilExpiry < 0) return 'expired';
    if (daysUntilExpiry < 30) return 'expiring';
    return 'valid';
  };

  const renderCell = (status: string) => {
    switch (status) {
      case 'valid':
        return <div className="flex justify-center"><CheckCircle className="w-5 h-5 text-green-500" /></div>;
      case 'expiring':
        return <div className="flex justify-center"><AlertTriangle className="w-5 h-5 text-amber-500" /></div>;
      case 'expired':
        return <div className="flex justify-center"><XCircle className="w-5 h-5 text-red-500" /></div>;
      default:
        return <div className="flex justify-center"><Minus className="w-4 h-4 text-gray-300" /></div>;
    }
  };

  return (
    <div className="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
      <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead className="bg-gray-50 dark:bg-gray-800">
          <tr>
            <th className="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider bg-gray-50 dark:bg-gray-800 sticky left-0 z-10 w-48 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
              Employee Name
            </th>
            {courses.map(course => (
              <th key={course.id} className="px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-24">
                <div className="transform -rotate-45 h-20 w-24 flex items-end justify-center pb-2 translate-y-4">
                  <span className="block truncate w-32">{course.title}</span>
                </div>
              </th>
            ))}
            <th className="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-24">
              Compliance
            </th>
          </tr>
        </thead>
        <tbody className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
          {users.map(user => {
            const userRecords = records.filter(r => r.user_id === user.id);
            const validCount = userRecords.filter(r => new Date(r.expires_at) > new Date()).length;
            const compliance = Math.round((validCount / courses.length) * 100);

            return (
              <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white sticky left-0 z-10 bg-white dark:bg-gray-900 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                  <div className="flex items-center">
                    <img className="h-8 w-8 rounded-full mr-3" src={user.avatar_url || 'https://i.pravatar.cc/150'} alt="" />
                    <div>
                        <div className="font-bold">{user.name}</div>
                        <div className="text-xs text-gray-500">{user.role}</div>
                    </div>
                  </div>
                </td>
                {courses.map(course => (
                  <td key={course.id} className="px-2 py-3 whitespace-nowrap border-l dark:border-gray-800">
                    {renderCell(getStatus(user.id, course.id))}
                  </td>
                ))}
                <td className="px-4 py-3 text-center">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        compliance === 100 ? 'bg-green-100 text-green-800' :
                        compliance >= 70 ? 'bg-blue-100 text-blue-800' :
                        'bg-red-100 text-red-800'
                    }`}>
                        {compliance}%
                    </span>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
};

==================================================
FILE: .\src\components\TrainingRecordModal.tsx
==================================================

import React, { useState, useEffect } from 'react';
import type { TrainingRecord, User, TrainingCourse } from '../types';
import { Button } from './ui/Button';

interface TrainingRecordModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<TrainingRecord, 'id' | 'org_id' | 'status'>) => void;
  users: User[];
  courses: TrainingCourse[];
}

const FormField: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700">{label}</label>
        <div className="mt-1">{children}</div>
    </div>
);

export const TrainingRecordModal: React.FC<TrainingRecordModalProps> = ({ isOpen, onClose, onSubmit, users, courses }) => {
  const [formData, setFormData] = useState({
    user_id: users[0]?.id || '',
    course_id: courses[0]?.id || '',
    issued_at: new Date().toISOString().split('T')[0],
    expires_at: '',
    session_id: 'manual_entry',
    score: 80,
  });
  
  const [error, setError] = useState('');
  
  useEffect(() => {
    if (courses.length > 0) {
        handleCourseChange(courses[0].id);
    }
  }, [courses]);

  const handleCourseChange = (courseId: string) => {
    const course = courses.find(c => c.id === courseId);
    if (course) {
        const issueDate = new Date(formData.issued_at);
        issueDate.setMonth(issueDate.getMonth() + course.validity_months);
        setFormData(prev => ({ 
            ...prev,
            course_id: courseId,
            expires_at: issueDate.toISOString().split('T')[0]
        }));
    }
  };

  const handleSubmit = () => {
    if (!formData.user_id || !formData.course_id || !formData.expires_at) {
        setError('Please fill out all fields.');
        return;
    }
    onSubmit(formData);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b">
          <h3 className="text-xl font-bold">Add Manual Training Record</h3>
          <p className="text-sm text-gray-500">For externally completed courses or historical data.</p>
        </div>
        <div className="p-6 space-y-4">
            <FormField label="Select Employee">
                <select value={formData.user_id} onChange={e => setFormData(p => ({...p, user_id: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md">
                    {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                </select>
            </FormField>
            <FormField label="Select Course">
                <select value={formData.course_id} onChange={e => handleCourseChange(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md">
                     {courses.map(c => <option key={c.id} value={c.id}>{c.title}</option>)}
                </select>
            </FormField>
            <div className="grid grid-cols-2 gap-4">
                <FormField label="Date Issued">
                    <input type="date" value={formData.issued_at} onChange={e => setFormData(p => ({...p, issued_at: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md"/>
                </FormField>
                 <FormField label="Expiration Date">
                    <input type="date" value={formData.expires_at} onChange={e => setFormData(p => ({...p, expires_at: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md"/>
                </FormField>
            </div>
            {error && <p className="text-sm text-red-600">{error}</p>}
        </div>
        <div className="bg-gray-50 px-6 py-3 flex justify-end space-x-2">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Add Record</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Trainings.tsx
==================================================

import React, { useState } from 'react';
import type { TrainingCourse, TrainingRecord, TrainingSession, User, Project } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';
import { useAppContext } from '../contexts';
import { CompetencyMatrix } from './training/CompetencyMatrix';
import { TrainingAnalytics } from './training/TrainingAnalytics';
import { Plus } from 'lucide-react';

interface TrainingsProps {
  courses: TrainingCourse[];
  records: TrainingRecord[];
  sessions: TrainingSession[];
  users: User[];
  projects: Project[];
  onManageCourses: () => void;
  onScheduleSession: (course: TrainingCourse) => void;
  onManageAttendance: (session: TrainingSession) => void;
}

type Tab = 'Dashboard' | 'Matrix' | 'Courses' | 'Sessions';

export const Trainings: React.FC<TrainingsProps> = (props) => {
  const { courses, records, sessions, users, onManageCourses, onScheduleSession, onManageAttendance } = props;
  const { can } = useAppContext();
  const [activeTab, setActiveTab] = useState<Tab>('Dashboard');

  const getCourseTitle = (courseId: string) => courses.find(c => c.id === courseId)?.title || 'Unknown';
  const getUserName = (userId: string) => users.find(u => u.id === userId)?.name || 'Unknown';
  
  const getSessionStatusColor = (status: TrainingSession['status']): 'green' | 'blue' | 'gray' => {
      switch(status) {
          case 'completed': return 'green';
          case 'scheduled': return 'blue';
          case 'cancelled': return 'gray';
          default: return 'gray';
      }
  };

  const TabButton: React.FC<{ tab: Tab }> = ({ tab }) => (
    <button
      onClick={() => setActiveTab(tab)}
      className={`px-4 py-2 text-sm font-semibold rounded-t-lg border-b-2 transition-colors ${
        activeTab === tab 
        ? 'border-blue-600 text-blue-600 bg-blue-50 dark:bg-white/5' 
        : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50 dark:hover:bg-white/5'
      }`}
    >
      {tab}
    </button>
  );

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Training & Competency</h1>
            <p className="text-slate-500 dark:text-slate-400">Manage workforce skills, certifications, and compliance.</p>
        </div>
         {can('create', 'training') && (
            <Button onClick={onManageCourses}>
                <Plus className="w-5 h-5 mr-2" />
                Manage Courses
            </Button>
         )}
      </div>
      
      <div className="border-b border-slate-200 dark:border-slate-800">
        <nav className="-mb-px flex space-x-1">
            <TabButton tab="Dashboard" />
            <TabButton tab="Matrix" />
            <TabButton tab="Courses" />
            <TabButton tab="Sessions" />
        </nav>
      </div>

      {activeTab === 'Dashboard' && <TrainingAnalytics />}
      {activeTab === 'Matrix' && <CompetencyMatrix users={users} records={records} requirements={[]} />}
      
      {activeTab === 'Courses' && (
        <Card>
            <div className="p-6">
                <h3 className="text-lg font-bold mb-4">Course Library</h3>
                <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-800">
                    <thead className="bg-slate-50 dark:bg-slate-800/50"><tr>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Title</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Category</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Validity</th>
                        <th className="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase">Actions</th>
                    </tr></thead>
                    <tbody className="divide-y divide-slate-200 dark:divide-slate-800">
                        {courses.map(course => (
                            <tr key={course.id}>
                                <td className="px-4 py-3 font-semibold">{course.title}</td>
                                <td className="px-4 py-3"><Badge color="blue" size="sm">{course.category}</Badge></td>
                                <td className="px-4 py-3 text-sm text-slate-500">{course.validity_months} months</td>
                                <td className="px-4 py-3 text-right">
                                    {can('create', 'training') && <Button size="sm" variant="secondary" onClick={() => onScheduleSession(course)}>Schedule</Button>}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </Card>
      )}

      {activeTab === 'Sessions' && (
        <Card>
           <div className="p-6">
               <h3 className="text-lg font-bold mb-4">Training Sessions</h3>
               <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-800">
                    <thead className="bg-slate-50 dark:bg-slate-800/50"><tr>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Course</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Date</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Trainer</th>
                        <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                        <th className="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase">Actions</th>
                    </tr></thead>
                    <tbody className="divide-y divide-slate-200 dark:divide-slate-800">
                        {sessions.map(session => (
                            <tr key={session.id}>
                                <td className="px-4 py-3 font-semibold">{getCourseTitle(session.course_id)}</td>
                                <td className="px-4 py-3 text-sm text-slate-500">{new Date(session.scheduled_at).toLocaleDateString()}</td>
                                <td className="px-4 py-3 text-sm text-slate-500">{getUserName(session.trainer_id)}</td>
                                <td className="px-4 py-3"><Badge color={getSessionStatusColor(session.status)}>{session.status}</Badge></td>
                                <td className="px-4 py-3 text-right">
                                    {can('update', 'training') && (
                                        <Button size="sm" variant="ghost" onClick={() => onManageAttendance(session)}>
                                            {session.status === 'scheduled' ? 'Manage' : 'View'}
                                        </Button>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
           </div>
        </Card>
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\TrainingSessionModal.tsx
==================================================

import React, { useState } from 'react';
import type { TrainingSession, TrainingCourse, Project, User } from '../types';
import { Button } from './ui/Button';

interface TrainingSessionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (data: Omit<TrainingSession, 'id' | 'status' | 'roster' | 'attendance'>) => void;
  course: TrainingCourse;
  projects: Project[];
  users: User[];
}

const FormField: React.FC<{ label: string; children: React.ReactNode }> = ({ label, children }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700">{label}</label>
        <div className="mt-1">{children}</div>
    </div>
);

export const TrainingSessionModal: React.FC<TrainingSessionModalProps> = ({ isOpen, onClose, onSubmit, course, projects, users }) => {
  const [formData, setFormData] = useState({
    course_id: course.id,
    project_id: projects[0]?.id || '',
    scheduled_at: new Date().toISOString().slice(0, 16),
    trainer_id: users.find(u => u.role === 'SUPERVISOR' || u.role === 'HSE_MANAGER')?.id || '',
  });
  
  const [error, setError] = useState('');

  const handleSubmit = () => {
    if (!formData.project_id || !formData.trainer_id) {
        setError('Please fill out all fields.');
        return;
    }
    onSubmit(formData);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center" onClick={onClose}>
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
        <div className="p-6 border-b">
          <h3 className="text-xl font-bold">Schedule New Session</h3>
          <p className="text-sm text-gray-600 mt-1">Course: {course.title}</p>
        </div>
        <div className="p-6 space-y-4">
            <FormField label="Project">
                <select value={formData.project_id} onChange={e => setFormData(p => ({...p, project_id: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md">
                    {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                </select>
            </FormField>
            <div className="grid grid-cols-2 gap-4">
                <FormField label="Scheduled Date & Time">
                    <input type="datetime-local" value={formData.scheduled_at} onChange={e => setFormData(p => ({...p, scheduled_at: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md"/>
                </FormField>
                <FormField label="Trainer">
                    <select value={formData.trainer_id} onChange={e => setFormData(p => ({...p, trainer_id: e.target.value}))} className="w-full p-2 border border-gray-300 rounded-md">
                        {users.filter(u => ['SUPERVISOR', 'HSE_MANAGER', 'ADMIN'].includes(u.role)).map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                    </select>
                </FormField>
            </div>
            {error && <p className="text-sm text-red-600">{error}</p>}
        </div>
        <div className="bg-gray-50 px-6 py-3 flex justify-end space-x-2">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button onClick={handleSubmit}>Schedule Session</Button>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\Users.tsx
==================================================

import React from 'react';
import type { User } from '../types';
import { Card } from './ui/Card';
import { Button } from './ui/Button';
import { Badge } from './ui/Badge';

interface UsersProps {
  users: User[];
}

export const Users: React.FC<UsersProps> = ({ users }) => {
  const getStatusColor = (status: User['status']): 'green' | 'yellow' | 'gray' => {
    switch (status) {
      case 'active': return 'green';
      case 'invited': return 'yellow';
      case 'inactive': return 'gray';
      default: return 'gray';
    }
  };

  const getRoleColor = (role: User['role']): 'blue' | 'purple' | 'gray' => {
      switch (role) {
          case 'ADMIN': return 'purple';
          case 'HSE_MANAGER':
          case 'SUPERVISOR': return 'blue';
          default: return 'gray';
      }
  }

  return (
    <div>
        <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-text-primary">User Management</h1>
            <Button>
                <PlusIcon className="w-5 h-5 mr-2" />
                Invite User
            </Button>
        </div>
      
      <Card>
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th scope="col" className="relative px-6 py-3"><span className="sr-only">Edit</span></th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      <div className="flex-shrink-0 h-10 w-10">
                        <img className="h-10 w-10 rounded-full" src={user.avatar_url} alt="" />
                      </div>
                      <div className="ml-4">
                        <div className="text-sm font-medium text-gray-900">{user.name}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                     {/* FIX: Check if role exists before replacing */}
                     <Badge color={getRoleColor(user.role)}>{(user.role || 'User').replace('_', ' ')}</Badge>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <Badge color={getStatusColor(user.status)}>
                        {(user.status || 'unknown').charAt(0).toUpperCase() + (user.status || 'unknown').slice(1)}
                    </Badge>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="#" className="text-primary-600 hover:text-primary-900">Edit</a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

// Icon
const PlusIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
    </svg>
);

==================================================
FILE: .\src\components\WorkAtHeightPermit.tsx
==================================================

import React from 'react';
import type { PtwWorkAtHeightPayload } from '../types';

interface WorkAtHeightPermitProps {
  payload: PtwWorkAtHeightPayload;
  onChange: (updatedPayload: PtwWorkAtHeightPayload) => void;
  readOnly?: boolean;
}

const EQUIPMENT_LABELS: Record<keyof PtwWorkAtHeightPayload['access_equipment'], string> = {
    step_ladder: 'Step Ladder',
    independent_scaffolding: 'Independent Scaffolding',
    tower_mobile_scaffolding: 'Mobile Tower Scaffold',
    scissor_lift: 'Scissor Lift',
    articulated_telescopic_boom: 'Articulated/Telescopic Boom',
    boatswain_chair: 'Boatswain Chair',
    man_basket: 'Man Basket',
    rope_access_system: 'Rope Access System',
    roof_ladder: 'Roof Ladder',
    other: 'Other',
};

export const WorkAtHeightPermit: React.FC<WorkAtHeightPermitProps> = ({ payload, onChange, readOnly = false }) => {
  
  const handleToggle = (key: keyof PtwWorkAtHeightPayload['access_equipment']) => {
      if (readOnly || key === 'other') return;
      
      const newEquipment = { 
          ...payload.access_equipment,
          [key]: !payload.access_equipment[key]
      };
      onChange({ ...payload, access_equipment: newEquipment });
  };

  const handleOtherChange = (value: string) => {
      if (readOnly) return;
      const newEquipment = {
          ...payload.access_equipment,
          other: value
      };
      onChange({ ...payload, access_equipment: newEquipment });
  };

  return (
    <div className="mb-6 border rounded-xl p-5 bg-sky-50/50 dark:bg-sky-900/10 border-sky-100 dark:border-sky-800">
        <div className="flex items-center gap-2 mb-4">
            <span className="text-2xl">ðŸ§—</span>
            <h4 className="font-bold text-base text-sky-900 dark:text-sky-100">Access Equipment Selection</h4>
        </div>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
            {(Object.keys(EQUIPMENT_LABELS) as Array<keyof typeof EQUIPMENT_LABELS>).filter(k => k !== 'other').map(key => (
                <div 
                    key={key as string} 
                    onClick={() => handleToggle(key)}
                    className={`
                        flex items-center p-3 rounded-lg border transition-all cursor-pointer select-none
                        ${payload.access_equipment[key] 
                            ? 'bg-sky-100 border-sky-300 dark:bg-sky-800 dark:border-sky-600 shadow-sm' 
                            : 'bg-white dark:bg-dark-background border-gray-200 dark:border-dark-border hover:border-sky-300 dark:hover:border-sky-700'}
                        ${readOnly ? 'cursor-default opacity-90' : ''}
                    `}
                >
                    <input
                        type="checkbox"
                        checked={payload.access_equipment[key]}
                        readOnly
                        className={`h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500 ${readOnly ? 'pointer-events-none' : ''}`}
                    />
                    <span className={`ml-3 font-medium ${payload.access_equipment[key] ? 'text-sky-900 dark:text-sky-100' : 'text-gray-700 dark:text-gray-300'}`}>
                        {EQUIPMENT_LABELS[key]}
                    </span>
                </div>
            ))}
        </div>

        <div className="mt-4">
            <label htmlFor="equip-other" className="block text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-1">
                Other Equipment / Method
            </label>
            <input
                type="text"
                id="equip-other"
                value={payload.access_equipment.other}
                onChange={e => handleOtherChange(e.target.value)}
                placeholder="Specify any other equipment..."
                className="w-full p-2.5 text-sm text-gray-900 dark:text-white bg-white dark:bg-dark-background border border-gray-300 dark:border-dark-border rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-transparent outline-none transition-all"
                disabled={readOnly}
            />
        </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\EvidenceCollector.tsx
==================================================

import React, { useState, useRef, useEffect } from 'react';
import { 
  Camera, Video, Mic, FileText,
  X, Upload, ZoomIn, RotateCw, Trash2, Eye
} from 'lucide-react';
import { Evidence } from '../../types/hse-inspection';

// Define locally since it wasn't exported from types
type EvidenceType = 'photograph' | 'video_recording' | 'audio_note' | 'document_scan';

interface EvidenceCollectorProps {
  inspectionId: string;
  onEvidenceCaptured: (evidence: Evidence) => void;
  onEvidenceRemoved: (evidenceId: string) => void;
  existingEvidence: Evidence[];
  maxFiles?: number;
  allowedTypes?: EvidenceType[];
}

export const EvidenceCollector: React.FC<EvidenceCollectorProps> = ({
  inspectionId: _inspectionId, // Prefix with _ to ignore unused
  onEvidenceCaptured,
  onEvidenceRemoved,
  existingEvidence = [],
  maxFiles = 20,
  allowedTypes: _allowedTypes // Prefix with _ to ignore unused
}) => {
  const [capturing, setCapturing] = useState<'photo' | 'video' | 'audio' | null>(null);
  const [uploading, setUploading] = useState(false);
  const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [deviceInfo, setDeviceInfo] = useState<any>(null);
  
  const videoRef = useRef<HTMLVideoElement>(null);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const chunksRef = useRef<Blob[]>([]);
  
  // Get device information
  useEffect(() => {
    const info = {
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      online: navigator.onLine,
      // @ts-ignore
      deviceMemory: navigator.deviceMemory,
      hardwareConcurrency: navigator.hardwareConcurrency
    };
    setDeviceInfo(info);
    
    // Get geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        },
        (error) => {
          console.warn('Failed to get location:', error);
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }
  }, []);
  
  // Capture photo using camera
  const capturePhoto = async () => {
    try {
      setCapturing('photo');
      
      // Request camera access
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        await videoRef.current.play();
      }
      
      // Wait for stream to be ready
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Capture frame
      const canvas = document.createElement('canvas');
      const video = videoRef.current;
      
      if (video) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        if (ctx) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          // Convert to blob
          canvas.toBlob(async (blob) => {
            if (blob) {
              // Create evidence object
              const evidence: Evidence = {
                id: `evidence_${Date.now()}`,
                type: 'photograph',
                title: `Photo Evidence - ${new Date().toLocaleString()}`,
                description: 'Photo captured during HSE inspection',
                url: URL.createObjectURL(blob),
                file_name: `photo_${Date.now()}.jpg`,
                file_size: blob.size,
                file_type: 'image/jpeg',
                uploaded_by: 'current_user', 
                uploaded_at: new Date(),
                gps_coordinates: location ? {
                  latitude: location.lat,
                  longitude: location.lng,
                  accuracy: 10
                } : undefined,
                timestamp: new Date(),
                device_info: deviceInfo,
                tags: ['photo', 'onsite', 'hse'],
                encrypted: false,
                access_control: []
              };
              
              onEvidenceCaptured(evidence);
              stream.getTracks().forEach(track => track.stop());
            }
          }, 'image/jpeg', 0.9);
        }
      }
      
    } catch (error) {
      console.error('Failed to capture photo:', error);
      alert('Camera access denied or not available');
    } finally {
      setCapturing(null);
    }
  };
  
  // Record video
  const startVideoRecording = async () => {
    try {
      setCapturing('video');
      
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
      
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        await videoRef.current.play();
      }
      
      // Setup media recorder
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      chunksRef.current = [];
      
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          chunksRef.current.push(event.data);
        }
      };
      
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunksRef.current, { type: 'video/mp4' });
        
        const evidence: Evidence = {
          id: `evidence_${Date.now()}`,
          type: 'video_recording',
          title: `Video Evidence - ${new Date().toLocaleString()}`,
          description: 'Video recorded during HSE inspection',
          url: URL.createObjectURL(blob),
          file_name: `video_${Date.now()}.mp4`,
          file_size: blob.size,
          file_type: 'video/mp4',
          uploaded_by: 'current_user',
          uploaded_at: new Date(),
          gps_coordinates: location ? { latitude: location.lat, longitude: location.lng, accuracy: 10 } : undefined,
          timestamp: new Date(),
          device_info: deviceInfo,
          tags: ['video', 'onsite', 'hse'],
          encrypted: false,
          access_control: []
        };
        
        onEvidenceCaptured(evidence);
        stream.getTracks().forEach(track => track.stop());
      };
      
      mediaRecorder.start();
      
    } catch (error) {
      console.error('Failed to start video recording:', error);
      setCapturing(null);
    }
  };
  
  const stopVideoRecording = () => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
      mediaRecorderRef.current.stop();
      setCapturing(null);
    }
  };
  
  // Record audio
  const startAudioRecording = async () => {
    try {
      setCapturing('audio');
      
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      chunksRef.current = [];
      
      mediaRecorder.ondataavailable = (event) => {
        chunksRef.current.push(event.data);
      };
      
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunksRef.current, { type: 'audio/wav' });
        
        const evidence: Evidence = {
          id: `evidence_${Date.now()}`,
          type: 'audio_note',
          title: `Audio Note - ${new Date().toLocaleString()}`,
          description: 'Audio note recorded during inspection',
          url: URL.createObjectURL(blob),
          file_name: `audio_${Date.now()}.wav`,
          file_size: blob.size,
          file_type: 'audio/wav',
          uploaded_by: 'current_user',
          uploaded_at: new Date(),
          timestamp: new Date(),
          device_info: deviceInfo,
          tags: ['audio', 'note', 'hse'],
          encrypted: false,
          access_control: []
        };
        
        onEvidenceCaptured(evidence);
        stream.getTracks().forEach(track => track.stop());
      };
      
      mediaRecorder.start();
      
    } catch (error) {
      console.error('Failed to start audio recording:', error);
      setCapturing(null);
    }
  };
  
  const stopAudioRecording = () => {
    if (mediaRecorderRef.current) {
      mediaRecorderRef.current.stop();
      setCapturing(null);
    }
  };
  
  // Handle file upload
  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files) return;
    
    setUploading(true);
    
    for (const file of Array.from(files)) {
      if (file.size > 50 * 1024 * 1024) {
        alert(`File ${file.name} is too large. Maximum size is 50MB.`);
        continue;
      }
      
      const fileType = getEvidenceType(file.type);
      
      const evidence: Evidence = {
        id: `evidence_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        type: fileType,
        title: file.name,
        description: `Uploaded file: ${file.name}`,
        url: URL.createObjectURL(file),
        file_name: file.name,
        file_size: file.size,
        file_type: file.type,
        uploaded_by: 'current_user',
        uploaded_at: new Date(),
        gps_coordinates: location ? { latitude: location.lat, longitude: location.lng, accuracy: 10 } : undefined,
        timestamp: new Date(),
        device_info: deviceInfo,
        tags: ['uploaded', fileType, 'hse'],
        encrypted: false,
        access_control: []
      };
      
      onEvidenceCaptured(evidence);
    }
    
    setUploading(false);
    event.target.value = '';
  };
  
  const getEvidenceType = (fileType: string): EvidenceType => {
    if (fileType.startsWith('image/')) return 'photograph';
    if (fileType.startsWith('video/')) return 'video_recording';
    if (fileType.startsWith('audio/')) return 'audio_note';
    return 'document_scan';
  };
  
  const renderEvidencePreview = (evidence: Evidence) => {
    const isImage = evidence.type === 'photograph';
    const isVideo = evidence.type === 'video_recording';
    const isAudio = evidence.type === 'audio_note';

    return (
      <div key={evidence.id} className="relative group bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div className="aspect-square bg-gray-100 dark:bg-gray-900 flex items-center justify-center">
          {isImage ? (
            <img src={evidence.url} alt={evidence.title} className="w-full h-full object-cover" />
          ) : isVideo ? (
            <video src={evidence.url} className="w-full h-full object-cover" controls />
          ) : isAudio ? (
            <div className="p-4 text-center">
              <Mic className="w-12 h-12 text-blue-500 mx-auto mb-2" />
              <audio src={evidence.url} controls className="w-full" />
            </div>
          ) : (
            <div className="p-4 text-center">
              <FileText className="w-12 h-12 text-gray-500 mx-auto mb-2" />
              <p className="text-sm font-medium truncate">{evidence.file_name}</p>
              <p className="text-xs text-gray-500">{(evidence.file_size / 1024 / 1024).toFixed(2)} MB</p>
            </div>
          )}
        </div>
        
        <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
          <button onClick={() => window.open(evidence.url, '_blank')} className="p-2 bg-white rounded-full hover:bg-gray-100" title="View"><Eye className="w-4 h-4" /></button>
          <button onClick={() => onEvidenceRemoved(evidence.id)} className="p-2 bg-red-500 text-white rounded-full hover:bg-red-600" title="Delete"><Trash2 className="w-4 h-4" /></button>
        </div>
      </div>
    );
  };
  
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-lg font-bold text-gray-900 dark:text-white">Evidence Collection</h3>
          <p className="text-sm text-gray-600 dark:text-gray-400">Capture photos, videos, audio notes, and upload documents</p>
        </div>
        <div className="text-sm text-gray-500">{existingEvidence.length} / {maxFiles} files</div>
      </div>
      
      <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <button onClick={capturePhoto} disabled={capturing === 'photo' || existingEvidence.length >= maxFiles} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 transition-colors flex flex-col items-center gap-2">
            <Camera className="w-10 h-10 text-blue-500" />
            <span className="font-medium dark:text-white">Take Photo</span>
          </button>
          
          <button onClick={capturing === 'video' ? stopVideoRecording : startVideoRecording} disabled={existingEvidence.length >= maxFiles} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 transition-colors flex flex-col items-center gap-2">
            <Video className={`w-10 h-10 ${capturing === 'video' ? 'text-red-500 animate-pulse' : 'text-red-500'}`} />
            <span className="font-medium dark:text-white">{capturing === 'video' ? 'Stop' : 'Record Video'}</span>
          </button>
          
          <button onClick={capturing === 'audio' ? stopAudioRecording : startAudioRecording} disabled={existingEvidence.length >= maxFiles} className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 transition-colors flex flex-col items-center gap-2">
            <Mic className={`w-10 h-10 ${capturing === 'audio' ? 'text-green-500 animate-pulse' : 'text-green-500'}`} />
            <span className="font-medium dark:text-white">{capturing === 'audio' ? 'Stop' : 'Record Audio'}</span>
          </button>
          
          <label className="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-blue-500 transition-colors cursor-pointer flex flex-col items-center gap-2">
            <Upload className="w-10 h-10 text-purple-500" />
            <span className="font-medium dark:text-white">Upload Files</span>
            <input type="file" multiple onChange={handleFileUpload} className="hidden" accept="image/*,video/*,audio/*,.pdf,.doc,.docx" />
          </label>
        </div>
        
        {(capturing === 'photo' || capturing === 'video') && (
          <div className="mt-4 relative">
            <video ref={videoRef} className="w-full h-64 object-cover rounded-lg" autoPlay muted playsInline />
            <div className="absolute top-4 right-4 flex gap-2">
                <button className="p-2 bg-black/50 text-white rounded-full"><ZoomIn className="w-4 h-4" /></button>
                <button className="p-2 bg-black/50 text-white rounded-full"><RotateCw className="w-4 h-4" /></button>
                <button onClick={() => setCapturing(null)} className="p-2 bg-black/50 text-white rounded-full"><X className="w-4 h-4" /></button>
            </div>
          </div>
        )}
        
        {uploading && <div className="text-center mt-2 text-sm text-blue-500">Uploading...</div>}
      </div>
      
      {existingEvidence.length > 0 ? (
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
          {existingEvidence.map(renderEvidencePreview)}
        </div>
      ) : (
        <div className="text-center py-12 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl">
          <Camera className="w-12 h-12 text-gray-400 mx-auto mb-3" />
          <p className="text-gray-500">No evidence collected yet</p>
        </div>
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step1Identification.tsx
==================================================

import React from 'react';
import { HSEInspection, InspectionType } from '../../../types/hse-inspection';
import { Shield, Globe, Users, Target, FileText, AlertTriangle } from 'lucide-react';

interface Step1Props {
  formData: Partial<HSEInspection>;
  setFormData: (data: Partial<HSEInspection>) => void;
  projects: any[];
}

export const Step1Identification: React.FC<Step1Props> = ({ formData, setFormData, projects }) => {
  const inspectionTypes = [
    { id: 'safety', label: 'Safety', icon: Shield },
    { id: 'environmental', label: 'Environmental', icon: Globe },
    { id: 'health', label: 'Health', icon: Users },
    { id: 'fire', label: 'Fire', icon: AlertTriangle },
    { id: 'equipment', label: 'Equipment', icon: Target },
    { id: 'process', label: 'Process', icon: FileText },
  ];

  return (
    <div className="space-y-6">
      <div className="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4">Core Identification</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title</label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              className="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
              placeholder="e.g. Weekly Site Inspection"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project / Site</label>
            <select
              value={formData.entity_id}
              onChange={(e) => setFormData({ ...formData, entity_id: e.target.value })}
              className="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
            >
              <option value="">Select Project</option>
              {projects.map(p => (
                <option key={p.id} value={p.id}>{p.name}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4">Inspection Type</h3>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
          {inspectionTypes.map(type => (
            <button
              key={type.id}
              onClick={() => setFormData({ ...formData, type: type.id as InspectionType })}
              className={`p-4 rounded-lg border flex flex-col items-center gap-2 transition-all ${
                formData.type === type.id
                  ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300'
                  : 'border-gray-200 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800'
              }`}
            >
              <type.icon className="w-6 h-6" />
              <span className="font-medium">{type.label}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step2Planning.tsx
==================================================

import React from 'react';
import { HSEInspection } from '../../../types/hse-inspection';

interface Step2Props {
  formData: Partial<HSEInspection>;
  setFormData: (data: Partial<HSEInspection>) => void;
}

export const Step2Planning: React.FC<Step2Props> = ({ formData, setFormData }) => {
  return (
    <div className="space-y-6">
      <div className="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4">Schedule & Frequency</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
            <input
              type="date"
              value={formData.schedule?.scheduled_date ? new Date(formData.schedule.scheduled_date).toISOString().split('T')[0] : ''}
              onChange={(e) => setFormData({
                ...formData,
                schedule: { ...formData.schedule!, scheduled_date: new Date(e.target.value) }
              })}
              className="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time</label>
            <input
              type="time"
              value={formData.schedule?.scheduled_time}
              onChange={(e) => setFormData({
                ...formData,
                schedule: { ...formData.schedule!, scheduled_time: e.target.value }
              })}
              className="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
            />
          </div>
        </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step3Team.tsx
==================================================

import React from 'react';
import { HSEInspection } from '../../../types/hse-inspection';

interface Step3Props {
  formData: Partial<HSEInspection>;
  setFormData: (data: Partial<HSEInspection>) => void;
  users: any[];
  contractors: any[];
}

export const Step3Team: React.FC<Step3Props> = ({ formData, setFormData, users }) => {
  return (
    <div className="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
      <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4">Inspection Team</h3>
      <div>
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lead Inspector</label>
        <select
          value={formData.inspection_team?.team_lead?.id}
          onChange={(e) => {
            const user = users.find(u => u.id === e.target.value);
            if (user) {
              setFormData({
                ...formData,
                inspection_team: {
                  ...formData.inspection_team!,
                  team_lead: {
                    id: user.id,
                    name: user.name,
                    role: user.role,
                    qualification: 'N/A',
                    contact: { email: user.email, phone: '' }
                  }
                }
              });
            }
          }}
          className="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
        >
          <option value="">Select Lead</option>
          {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
        </select>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step4Checklist.tsx
==================================================

import React from 'react';

interface Step4Props {
  templates: any[];
}

export const Step4Checklist: React.FC<Step4Props> = ({ templates }) => {
  return (
    <div className="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
      <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-4">Select Checklist</h3>
      <div className="space-y-2">
        {templates.map(tpl => (
            <div key={tpl.id} className="p-3 border rounded-lg flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-800">
                <span>{tpl.title.en || tpl.title}</span>
                <button className="text-blue-600 text-sm font-medium">Select</button>
            </div>
        ))}
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step5Execution.tsx
==================================================

import React, { useState, useEffect } from 'react';
import { 
  CheckCircle, XCircle, MinusCircle, 
  MessageSquare, Camera, ChevronDown, ChevronUp 
} from 'lucide-react';
import { HSEInspection, ChecklistItem } from '../../../types/hse-inspection';

interface Step5Props {
  formData: Partial<HSEInspection>;
  setFormData: (data: Partial<HSEInspection>) => void;
}

export const Step5Execution: React.FC<Step5Props> = ({ formData, setFormData }) => {
  // If checklist items are empty, we might need to load them from the template (mock logic here)
  // In a real app, Step 4 would have populated formData.checklist_items
  
  const [items, setItems] = useState<ChecklistItem[]>(formData.checklist_items || []);
  const [expandedItem, setExpandedItem] = useState<string | null>(null);

  useEffect(() => {
    // Sync local state back to parent
    setFormData({ ...formData, checklist_items: items });
  }, [items]);

  const handleResponse = (itemId: string, value: 'pass' | 'fail' | 'na') => {
    setItems(prev => prev.map(item => {
      if (item.id === itemId) {
        return {
          ...item,
          response: {
            ...item.response,
            value: value,
            timestamp: new Date(),
            responder: 'Current User', // Replace with activeUser.name
            evidence_ids: item.response?.evidence_ids || []
          }
        };
      }
      return item;
    }));
    
    // Auto-collapse and move to next (optional UX improvement)
    setExpandedItem(null);
  };

  const handleComment = (itemId: string, comment: string) => {
    setItems(prev => prev.map(item => 
      item.id === itemId 
        ? { ...item, response: { ...item.response!, comments: comment } } 
        : item
    ));
  };

  // Group items by category for better UI
  const groupedItems = useMemo(() => {
    const groups: Record<string, ChecklistItem[]> = {};
    items.forEach(item => {
      const cat = item.category || 'General';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(item);
    });
    return groups;
  }, [items]);

  const progress = Math.round((items.filter(i => i.response?.value).length / items.length) * 100) || 0;

  return (
    <div className="space-y-6">
      {/* Progress Header */}
      <div className="bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-800 sticky top-0 z-10 shadow-sm">
        <div className="flex justify-between items-center mb-2">
          <h3 className="font-bold text-gray-900 dark:text-white">Inspection Progress</h3>
          <span className="text-sm font-bold text-blue-600">{progress}% Completed</span>
        </div>
        <div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div className="h-full bg-blue-600 transition-all duration-300" style={{ width: `${progress}%` }} />
        </div>
      </div>

      {Object.entries(groupedItems).length === 0 && (
        <div className="text-center py-10 text-gray-500">
          No checklist items loaded. Please select a template in Step 4.
        </div>
      )}

      {Object.entries(groupedItems).map(([category, categoryItems]) => (
        <div key={category} className="space-y-3">
          <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wider ml-1">{category}</h4>
          
          {categoryItems.map((item) => (
            <div key={item.id} className={`bg-white dark:bg-gray-900 border rounded-xl overflow-hidden transition-all ${
              item.response?.value === 'fail' ? 'border-red-300 dark:border-red-900' : 
              item.response?.value === 'pass' ? 'border-green-300 dark:border-green-900' : 
              'border-gray-200 dark:border-gray-800'
            }`}>
              <div className="p-4 flex items-start gap-4">
                <div className="flex-1">
                  <p className="font-medium text-gray-900 dark:text-white">{item.requirement}</p>
                  <p className="text-sm text-gray-500 mt-1">{item.criteria}</p>
                </div>
                
                <div className="flex gap-2 shrink-0">
                  <button
                    onClick={() => handleResponse(item.id, 'pass')}
                    className={`p-2 rounded-lg flex flex-col items-center gap-1 min-w-[60px] transition-colors ${
                      item.response?.value === 'pass' 
                        ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' 
                        : 'bg-gray-50 text-gray-400 hover:bg-gray-100 dark:bg-gray-800'
                    }`}
                  >
                    <CheckCircle className="w-6 h-6" />
                    <span className="text-[10px] font-bold uppercase">Pass</span>
                  </button>

                  <button
                    onClick={() => handleResponse(item.id, 'fail')}
                    className={`p-2 rounded-lg flex flex-col items-center gap-1 min-w-[60px] transition-colors ${
                      item.response?.value === 'fail' 
                        ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' 
                        : 'bg-gray-50 text-gray-400 hover:bg-gray-100 dark:bg-gray-800'
                    }`}
                  >
                    <XCircle className="w-6 h-6" />
                    <span className="text-[10px] font-bold uppercase">Fail</span>
                  </button>

                  <button
                    onClick={() => handleResponse(item.id, 'na')}
                    className={`p-2 rounded-lg flex flex-col items-center gap-1 min-w-[60px] transition-colors ${
                      item.response?.value === 'na' 
                        ? 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300' 
                        : 'bg-gray-50 text-gray-400 hover:bg-gray-100 dark:bg-gray-800'
                    }`}
                  >
                    <MinusCircle className="w-6 h-6" />
                    <span className="text-[10px] font-bold uppercase">N/A</span>
                  </button>
                </div>
              </div>

              {/* Expanded Area for Comments/Evidence (Auto expands on Fail) */}
              {(expandedItem === item.id || item.response?.value === 'fail') && (
                <div className="px-4 pb-4 pt-0 animate-fade-in-down">
                  <div className="flex gap-3 mt-3">
                    <div className="flex-1 relative">
                      <MessageSquare className="w-4 h-4 absolute left-3 top-3 text-gray-400" />
                      <input 
                        type="text" 
                        placeholder="Add remarks or observations..."
                        value={item.response?.comments || ''}
                        onChange={(e) => handleComment(item.id, e.target.value)}
                        className="w-full pl-9 pr-3 py-2 text-sm border rounded-lg dark:bg-gray-800 dark:border-gray-700"
                      />
                    </div>
                    <button className="px-3 py-2 border rounded-lg flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800">
                      <Camera className="w-4 h-4" />
                      Evidence
                    </button>
                  </div>
                </div>
              )}
              
              <button 
                onClick={() => setExpandedItem(expandedItem === item.id ? null : item.id)}
                className="w-full flex justify-center py-1 bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400"
              >
                {expandedItem === item.id ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
              </button>
            </div>
          ))}
        </div>
      ))}
    </div>
  );
};

// Helper for useMemo
import { useMemo } from 'react';

==================================================
FILE: .\src\components\hse\steps\Step6Findings.tsx
==================================================

import React, { useState } from 'react';
import { Plus, AlertTriangle, Trash2, AlertCircle } from 'lucide-react';
import { HSEInspection, HSEFinding } from '../../../types/hse-inspection';
import { Button } from '../../ui/Button';

interface Step6Props {
  formData: Partial<HSEInspection>;
  setFormData: (data: Partial<HSEInspection>) => void;
}

export const Step6Findings: React.FC<Step6Props> = ({ formData, setFormData }) => {
  const [showAddForm, setShowAddForm] = useState(false);
  const [newFinding, setNewFinding] = useState<Partial<HSEFinding>>({
    description: '',
    risk_assessment: { severity: 1, likelihood: 1, risk_level: 'low', risk_score: 1, people_at_risk: 1, potential_consequences: [] },
    type: 'non_conformity',
    status: 'open'
  });

  const calculateRisk = (sev: number, like: number) => {
    const score = sev * like;
    let level = 'low';
    if (score >= 15) level = 'extreme';
    else if (score >= 10) level = 'high';
    else if (score >= 5) level = 'medium';
    return { score, level };
  };

  const handleAddFinding = () => {
    if (!newFinding.description) return;

    const risk = calculateRisk(newFinding.risk_assessment!.severity, newFinding.risk_assessment!.likelihood);
    
    const finding: HSEFinding = {
      ...newFinding as HSEFinding,
      id: `find_${Date.now()}`,
      finding_number: `F-${(formData.findings?.length || 0) + 1}`,
      risk_assessment: {
        ...newFinding.risk_assessment!,
        risk_score: risk.score,
        risk_level: risk.level as any
      },
      created_at: new Date(),
      updated_at: new Date(),
      created_by: 'current_user', // Replace with context user
      evidence_ids: [],
      corrective_action_required: risk.score > 5
    };

    setFormData({
      ...formData,
      findings: [...(formData.findings || []), finding]
    });
    
    // Reset form
    setNewFinding({
      description: '',
      risk_assessment: { severity: 1, likelihood: 1, risk_level: 'low', risk_score: 1, people_at_risk: 1, potential_consequences: [] },
      type: 'non_conformity',
      status: 'open'
    });
    setShowAddForm(false);
  };

  const removeFinding = (id: string) => {
    setFormData({
      ...formData,
      findings: formData.findings?.filter(f => f.id !== id)
    });
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
            <h3 className="text-lg font-bold text-gray-900 dark:text-white">Findings & Observations</h3>
            <p className="text-sm text-gray-500">Record non-conformities, hazards, or positive observations.</p>
        </div>
        <Button onClick={() => setShowAddForm(true)}>
            <Plus className="w-4 h-4 mr-2" /> Add Finding
        </Button>
      </div>

      {showAddForm && (
        <div className="bg-gray-50 dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 animate-fade-in-up">
            <h4 className="font-bold mb-4 dark:text-white">New Finding Details</h4>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Type</label>
                    <select 
                        className="w-full p-2 rounded border dark:bg-gray-900 dark:border-gray-700"
                        value={newFinding.type}
                        onChange={e => setNewFinding({...newFinding, type: e.target.value as any})}
                    >
                        <option value="non_conformity">Non-Conformity</option>
                        <option value="observation">Observation</option>
                        <option value="opportunity_for_improvement">Opportunity for Improvement</option>
                        <option value="compliment">Positive Compliment</option>
                    </select>
                </div>
                 <div>
                    <label className="block text-sm font-medium mb-1 dark:text-gray-300">Description</label>
                    <input 
                        type="text" 
                        className="w-full p-2 rounded border dark:bg-gray-900 dark:border-gray-700"
                        placeholder="Describe the hazard..."
                        value={newFinding.description}
                        onChange={e => setNewFinding({...newFinding, description: e.target.value})}
                    />
                </div>
            </div>

            <div className="mb-4">
                <h5 className="text-sm font-bold mb-2 dark:text-gray-300">Risk Assessment</h5>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="text-xs text-gray-500">Severity (1-5)</label>
                        <input 
                            type="range" min="1" max="5" 
                            value={newFinding.risk_assessment?.severity}
                            onChange={e => setNewFinding({...newFinding, risk_assessment: {...newFinding.risk_assessment!, severity: parseInt(e.target.value) as any}})}
                            className="w-full"
                        />
                        <div className="text-center font-bold">{newFinding.risk_assessment?.severity}</div>
                    </div>
                    <div>
                        <label className="text-xs text-gray-500">Likelihood (1-5)</label>
                        <input 
                            type="range" min="1" max="5" 
                            value={newFinding.risk_assessment?.likelihood}
                            onChange={e => setNewFinding({...newFinding, risk_assessment: {...newFinding.risk_assessment!, likelihood: parseInt(e.target.value) as any}})}
                            className="w-full"
                        />
                        <div className="text-center font-bold">{newFinding.risk_assessment?.likelihood}</div>
                    </div>
                </div>
            </div>

            <div className="flex justify-end gap-2">
                <Button variant="secondary" onClick={() => setShowAddForm(false)}>Cancel</Button>
                <Button onClick={handleAddFinding}>Save Finding</Button>
            </div>
        </div>
      )}

      <div className="space-y-3">
        {(formData.findings || []).map((finding) => (
            <div key={finding.id} className="p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg flex justify-between items-start hover:shadow-md transition-shadow">
                <div className="flex gap-3">
                    <div className={`p-2 rounded-lg h-fit ${
                        finding.risk_assessment.risk_level === 'extreme' ? 'bg-red-100 text-red-600' :
                        finding.risk_assessment.risk_level === 'high' ? 'bg-orange-100 text-orange-600' :
                        'bg-blue-100 text-blue-600'
                    }`}>
                        <AlertTriangle className="w-5 h-5" />
                    </div>
                    <div>
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-gray-900 dark:text-white">{finding.finding_number}</span>
                            <span className={`text-xs px-2 py-0.5 rounded-full uppercase font-bold ${
                                finding.type === 'non_conformity' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'
                            }`}>{finding.type.replace(/_/g, ' ')}</span>
                        </div>
                        <p className="text-gray-600 dark:text-gray-300 mt-1">{finding.description}</p>
                        <div className="text-xs text-gray-500 mt-2 flex gap-4">
                            <span>Risk Score: <strong>{finding.risk_assessment.risk_score}</strong></span>
                            <span>Level: <strong className="uppercase">{finding.risk_assessment.risk_level}</strong></span>
                        </div>
                    </div>
                </div>
                <button onClick={() => removeFinding(finding.id)} className="text-gray-400 hover:text-red-500">
                    <Trash2 className="w-5 h-5" />
                </button>
            </div>
        ))}
        {(!formData.findings || formData.findings.length === 0) && !showAddForm && (
            <div className="text-center py-10 border-2 border-dashed border-gray-200 dark:border-gray-800 rounded-xl">
                <AlertCircle className="w-10 h-10 text-gray-300 mx-auto mb-2" />
                <p className="text-gray-500">No findings recorded yet.</p>
            </div>
        )}
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step7Evidence.tsx
==================================================

import React from 'react';
import { HSEInspection, Evidence } from '../../../types/hse-inspection';
import { EvidenceCollector } from '../EvidenceCollector'; // Adjust path if EvidenceCollector is elsewhere
import { Camera, FileText } from 'lucide-react';

interface Step7Props {
  formData: Partial<HSEInspection>;
  setFormData: (data: Partial<HSEInspection>) => void;
}

export const Step7Evidence: React.FC<Step7Props> = ({ formData, setFormData }) => {
  
  // Handle adding new evidence (photo/video/audio)
  const handleEvidenceCaptured = (evidence: Evidence) => {
    const currentEvidence = formData.evidence || [];
    setFormData({
      ...formData,
      evidence: [...currentEvidence, evidence]
    });
  };

  // Handle removing evidence
  const handleEvidenceRemoved = (evidenceId: string) => {
    const currentEvidence = formData.evidence || [];
    setFormData({
      ...formData,
      evidence: currentEvidence.filter(e => e.id !== evidenceId)
    });
  };

  return (
    <div className="space-y-6">
      {/* Header Section */}
      <div className="bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 p-4 rounded-xl border border-purple-200 dark:border-purple-800">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
            <Camera className="w-6 h-6 text-purple-600 dark:text-purple-400" />
          </div>
          <div>
            <h2 className="text-xl font-bold text-gray-900 dark:text-white">Evidence Collection</h2>
            <p className="text-sm text-gray-600 dark:text-gray-400">
              Attach photos, videos, or documents to support your inspection results.
            </p>
          </div>
        </div>
      </div>

      {/* Main Collector Area */}
      <div className="bg-white dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-800">
        
        {/* Stats Summary */}
        <div className="flex gap-4 mb-6 text-sm">
          <div className="px-3 py-1.5 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center gap-2">
            <FileText className="w-4 h-4 text-gray-500" />
            <span className="font-semibold dark:text-white">{formData.evidence?.length || 0}</span>
            <span className="text-gray-500">Files Attached</span>
          </div>
        </div>

        {/* The Collector Component */}
        <EvidenceCollector
          inspectionId={formData.inspection_id || 'temp_id'}
          existingEvidence={formData.evidence || []}
          onEvidenceCaptured={handleEvidenceCaptured}
          onEvidenceRemoved={handleEvidenceRemoved}
          maxFiles={50} // Allow up to 50 files
        />
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step8Review.tsx
==================================================

import React from 'react';
import { HSEInspection } from '../../../types/hse-inspection';
import { Card } from '../../ui/Card';
import { Badge } from '../../ui/Badge';
import { CheckCircle, AlertTriangle, Camera, Users, Calendar } from 'lucide-react';

interface Step8Props {
  formData: Partial<HSEInspection>;
  projects: any[];
  users: any[];
  contractors?: any[];
}

export const Step8Review: React.FC<Step8Props> = ({ formData, projects, users }) => {
  const project = projects.find(p => p.id === formData.entity_id);
  const lead = users.find(u => u.id === formData.inspection_team?.team_lead?.id);

  const findingsCount = formData.findings?.length || 0;
  const criticalCount = formData.findings?.filter(f => f.risk_assessment.risk_level === 'high' || f.risk_assessment.risk_level === 'extreme').length || 0;
  const evidenceCount = formData.evidence?.length || 0;

  return (
    <div className="space-y-6">
      <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800">
        <h2 className="text-xl font-bold text-blue-900 dark:text-blue-100">Review & Validate</h2>
        <p className="text-sm text-blue-700 dark:text-blue-300">Please review all inspection details before final submission.</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <Card title="Identification">
             <div className="space-y-3 text-sm">
                 <div className="flex justify-between border-b pb-2">
                     <span className="text-gray-500">Title</span>
                     <span className="font-medium dark:text-white">{formData.title}</span>
                 </div>
                 <div className="flex justify-between border-b pb-2">
                     <span className="text-gray-500">Type</span>
                     <Badge color="blue">{formData.type}</Badge>
                 </div>
                 <div className="flex justify-between border-b pb-2">
                     <span className="text-gray-500">Project</span>
                     <span className="font-medium dark:text-white">{project?.name || 'N/A'}</span>
                 </div>
                  <div className="flex justify-between">
                     <span className="text-gray-500">Date</span>
                     <span className="font-medium dark:text-white flex items-center gap-1">
                        <Calendar className="w-3 h-3"/> {new Date(formData.schedule?.scheduled_date || Date.now()).toLocaleDateString()}
                     </span>
                 </div>
             </div>
          </Card>

          <Card title="Team">
             <div className="space-y-3 text-sm">
                 <div className="flex justify-between border-b pb-2">
                     <span className="text-gray-500">Lead Inspector</span>
                     <span className="font-medium dark:text-white">{lead?.name || 'N/A'}</span>
                 </div>
                 <div className="flex justify-between">
                     <span className="text-gray-500">Team Size</span>
                     <span className="font-medium dark:text-white flex items-center gap-1">
                        <Users className="w-3 h-3"/> {1 + (formData.inspection_team?.inspectors?.length || 0)} Members
                     </span>
                 </div>
             </div>
          </Card>
      </div>

      <Card title="Inspection Summary">
          <div className="grid grid-cols-3 gap-4 text-center">
              <div className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                  <div className="text-2xl font-bold text-gray-900 dark:text-white">{findingsCount}</div>
                  <div className="text-xs text-gray-500 uppercase tracking-wider">Total Findings</div>
              </div>
              <div className="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-900">
                  <div className="text-2xl font-bold text-red-600 dark:text-red-400">{criticalCount}</div>
                  <div className="text-xs text-red-500 uppercase tracking-wider flex justify-center items-center gap-1">
                      <AlertTriangle className="w-3 h-3"/> Critical
                  </div>
              </div>
              <div className="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                  <div className="text-2xl font-bold text-purple-600 dark:text-purple-400">{evidenceCount}</div>
                  <div className="text-xs text-purple-500 uppercase tracking-wider flex justify-center items-center gap-1">
                      <Camera className="w-3 h-3"/> Evidence Files
                  </div>
              </div>
          </div>
      </Card>

      <div className="flex items-start gap-3 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg">
          <CheckCircle className="w-5 h-5 text-yellow-600 shrink-0 mt-0.5" />
          <div>
              <p className="font-bold text-yellow-800 dark:text-yellow-200 text-sm">Declaration</p>
              <p className="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                  By submitting this inspection, I declare that the information provided is accurate and represents the site conditions at the time of inspection.
              </p>
          </div>
      </div>
    </div>
  );
};

==================================================
FILE: .\src\components\hse\steps\Step9Submission.tsx
==================================================

import React from 'react';
import { Button } from '../../ui/Button';
import { Send, CheckCircle, ShieldCheck } from 'lucide-react';

interface Step9Props {
  onSubmit: () => void;
  saving: boolean;
  formData: any;
}

export const Step9Submission: React.FC<Step9Props> = ({ onSubmit, saving, formData }) => {
  return (
    <div className="flex flex-col items-center justify-center h-full py-10 text-center">
      <div className="w-24 h-24 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-6 animate-pulse">
        <ShieldCheck className="w-12 h-12 text-green-600 dark:text-green-400" />
      </div>
      
      <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">Ready to Submit</h2>
      <p className="text-gray-500 max-w-md mb-8">
        Your inspection <strong>{formData.title}</strong> is ready for submission. 
        This will generate the final report, notify stakeholders, and log findings in the action tracker.
      </p>

      <div className="w-full max-w-md bg-gray-50 dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 mb-8 text-left">
          <h4 className="font-bold text-gray-700 dark:text-gray-300 mb-4 border-b pb-2">Submission Checklist</h4>
          <ul className="space-y-3">
              <li className="flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
                  <CheckCircle className="w-4 h-4 text-green-500"/> Team assigned
              </li>
              <li className="flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
                  <CheckCircle className="w-4 h-4 text-green-500"/> Checklist completed
              </li>
              <li className="flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
                  <CheckCircle className="w-4 h-4 text-green-500"/> Findings recorded
              </li>
              <li className="flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
                  <CheckCircle className="w-4 h-4 text-green-500"/> Evidence attached
              </li>
          </ul>
      </div>

      <Button onClick={onSubmit} disabled={saving} size="lg" className="w-64 justify-center bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white shadow-lg shadow-blue-500/30">
        {saving ? (
            <span className="flex items-center gap-2">Processing...</span>
        ) : (
            <span className="flex items-center gap-2">
                <Send className="w-5 h-5" /> Submit Inspection
            </span>
        )}
      </Button>
    </div>
  );
};

==================================================
FILE: .\src\components\layout\Header.tsx
==================================================

import React, { useState, useRef, useEffect } from 'react';
import type { Organization, User } from '../../types';
import { useDataContext, useAppContext } from '../../contexts';
import { useAuth } from '../../contexts/AuthContext';
import { supportedLanguages } from '../../config';
import { 
  Menu as MenuIcon, 
  ChevronDown as ChevronDownIcon, 
  Check as CheckIcon, 
  Sun as SunIcon, 
  Moon as MoonIcon, 
  Globe as LanguageIcon, 
  Bell as BellIcon 
} from 'lucide-react';

interface HeaderProps {
  activeOrg: Organization;
  setActiveOrg: (org: Organization) => void;
  organizations: Organization[];
  user: User;
  toggleSidebar: () => void;
}

export const Header: React.FC<HeaderProps> = ({ activeOrg, setActiveOrg, organizations, user, toggleSidebar }) => {
  const { notifications } = useDataContext();
  const { language, handleUpdateUser, logout: clearLocalSession, theme, toggleTheme } = useAppContext();
  const { logout } = useAuth();
  const [orgDropdownOpen, setOrgDropdownOpen] = useState(false);
  const [userDropdownOpen, setUserDropdownOpen] = useState(false);
  const [notificationDropdownOpen, setNotificationDropdownOpen] = useState(false);
  const [languageDropdownOpen, setLanguageDropdownOpen] = useState(false);
  
  const orgDropdownRef = useRef<HTMLDivElement>(null);
  const userDropdownRef = useRef<HTMLDivElement>(null);
  const notificationDropdownRef = useRef<HTMLDivElement>(null);
  const languageDropdownRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (orgDropdownRef.current && !orgDropdownRef.current.contains(event.target as Node)) {
        setOrgDropdownOpen(false);
      }
      if (userDropdownRef.current && !userDropdownRef.current.contains(event.target as Node)) {
        setUserDropdownOpen(false);
      }
      if (notificationDropdownRef.current && !notificationDropdownRef.current.contains(event.target as Node)) {
        setNotificationDropdownOpen(false);
      }
       if (languageDropdownRef.current && !languageDropdownRef.current.contains(event.target as Node)) {
        setLanguageDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const unreadNotifications = notifications.filter(n => !n.is_read);
  
  // SAFE CHECK: Ensure user.role exists before replacing
  const userRole = user?.role ? user.role.replace('_', ' ') : 'User';

  return (
    <header className="flex items-center justify-between h-16 px-6 glass-header shrink-0 z-40 relative transition-all duration-200">
       <div className="flex items-center">
            <button onClick={toggleSidebar} className="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white focus:outline-none md:hidden mr-4">
                 <MenuIcon className="w-6 h-6" />
            </button>
            <div ref={orgDropdownRef} className="relative">
                <button onClick={() => setOrgDropdownOpen(!orgDropdownOpen)} className="flex items-center space-x-2 py-1.5 px-2 rounded hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                    <div className="h-6 w-6 rounded bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
                        {activeOrg?.name?.substring(0, 2).toUpperCase() || 'OR'}
                    </div>
                    <span className="hidden sm:inline font-semibold text-sm text-slate-700 dark:text-slate-200">{activeOrg?.name || 'Organization'}</span>
                    <ChevronDownIcon className="w-4 h-4 text-slate-400" />
                </button>
                {orgDropdownOpen && (
                    <div className="absolute top-full left-0 mt-1 w-60 bg-white dark:bg-dark-card rounded-lg shadow-lg border border-border-color dark:border-dark-border z-50">
                        <div className="p-1">
                            {organizations.map(org => (
                                <button
                                    key={org.id}
                                    onClick={() => {
                                        setActiveOrg(org);
                                        setOrgDropdownOpen(false);
                                    }}
                                    className="flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-white/5 rounded-md"
                                >
                                    <div className="h-5 w-5 rounded bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-[10px] font-bold text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 mr-3">
                                        {org.name.substring(0, 2).toUpperCase()}
                                    </div>
                                    <span>{org.name}</span>
                                    {org.id === activeOrg.id && <CheckIcon className="w-4 h-4 ml-auto text-primary-600" />}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
            </div>
       </div>

      <div className="flex items-center space-x-2 sm:space-x-3">
         {/* Theme Toggle */}
         <button 
            onClick={toggleTheme} 
            className="p-2 rounded-full text-slate-500 hover:bg-slate-50 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-colors"
            title={theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
         >
            {theme === 'dark' ? <SunIcon className="w-5 h-5" /> : <MoonIcon className="w-5 h-5" />}
         </button>

         <div ref={languageDropdownRef} className="relative">
            <button
                onClick={() => setLanguageDropdownOpen(prev => !prev)}
                className="p-2 rounded-full text-slate-500 hover:bg-slate-50 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-colors"
                title="Language"
            >
                <LanguageIcon className="w-5 h-5" />
            </button>
             {languageDropdownOpen && (
                <div className="absolute right-0 mt-1 w-40 bg-white dark:bg-dark-card rounded-lg shadow-lg border border-border-color dark:border-dark-border z-50">
                    <div className="p-1">
                        {supportedLanguages.map(lang => (
                            <button
                                key={lang.code}
                                onClick={() => {
                                    handleUpdateUser({ ...user, preferences: { ...user.preferences, language: lang.code }});
                                    setLanguageDropdownOpen(false);
                                }}
                                className="flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-white/5 rounded-md"
                            >
                                <span>{lang.name}</span>
                                {lang.code === language && <CheckIcon className="w-4 h-4 ml-auto text-primary-600" />}
                            </button>
                        ))}
                    </div>
                </div>
             )}
        </div>

        <div ref={notificationDropdownRef} className="relative">
          <button onClick={() => setNotificationDropdownOpen(prev => !prev)} className="relative p-2 rounded-full text-slate-500 hover:bg-slate-50 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-white/5 dark:hover:text-white transition-colors">
              <BellIcon className="w-5 h-5"/>
              {unreadNotifications.length > 0 && (
                <span className="absolute top-1.5 right-1.5 h-2 w-2 bg-red-500 rounded-full ring-2 ring-white dark:ring-dark-card"></span>
              )}
          </button>
          {notificationDropdownOpen && (
            <div className="absolute right-0 mt-1 w-80 bg-white dark:bg-dark-card rounded-lg shadow-lg border border-border-color dark:border-dark-border z-50">
                <div className="px-4 py-3 font-semibold text-sm border-b border-border-color dark:border-dark-border text-slate-800 dark:text-slate-200">Notifications</div>
                <div className="max-h-80 overflow-y-auto">
                    {notifications.length > 0 ? (
                      notifications.map(notif => (
                        <div key={notif.id} className="px-4 py-3 hover:bg-slate-50 dark:hover:bg-white/5 border-b border-slate-50 dark:border-dark-border last:border-0 cursor-pointer">
                          <p className="text-sm font-medium text-slate-800 dark:text-slate-200">{notif.message}</p>
                          <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{new Date(notif.timestamp).toLocaleString()}</p>
                        </div>
                      ))
                    ) : (
                      <p className="text-center text-sm text-slate-500 py-8">No new notifications.</p>
                    )}
                </div>
            </div>
          )}
        </div>

        <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>

        <div ref={userDropdownRef} className="relative">
          <button onClick={() => setUserDropdownOpen(!userDropdownOpen)} className="flex items-center space-x-3 pl-2">
            <div className="flex flex-col items-end hidden sm:flex">
                <span className="text-sm font-medium text-slate-700 dark:text-slate-200 leading-tight">{user?.name || 'User'}</span>
                <span className="text-xs text-slate-500 dark:text-slate-400 leading-tight">{userRole}</span>
            </div>
            <img className="h-8 w-8 rounded-full object-cover border border-slate-200 dark:border-slate-600" src={user?.avatar_url || 'https://i.pravatar.cc/150'} alt="Avatar" />
          </button>
          {userDropdownOpen && (
            <div className="absolute right-0 mt-2 w-56 bg-white dark:bg-dark-card rounded-lg shadow-lg border border-border-color dark:border-dark-border z-50">
                <div className="p-1">
                    <div className="px-3 py-2 border-b border-slate-100 dark:border-dark-border mb-1 sm:hidden">
                        <p className="font-medium text-slate-900 dark:text-slate-200">{user?.name}</p>
                        <p className="text-xs text-slate-500 dark:text-slate-400">{user?.email}</p>
                    </div>
                    <a href="#" className="block px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-white/5 rounded-md">Profile Settings</a>
                    <a href="#" className="block px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-white/5 rounded-md">Help & Support</a>
                    <div className="my-1 border-t border-slate-100 dark:border-dark-border"></div>
                    <button onClick={async () => { await logout(); clearLocalSession(); }} className="block w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md">Sign Out</button>
                </div>
            </div>
          )}
        </div>
      </div>
    </header>
  );
};

==================================================
FILE: .\src\components\training\CompetencyMatrix.tsx
==================================================

import React from 'react';
import { Card } from '../ui/Card';
import type { User, TrainingRecord } from '../../types';

interface CompetencyMatrixProps {
  users: User[];
  records: TrainingRecord[];
  requirements: any[];
}

export const CompetencyMatrix: React.FC<CompetencyMatrixProps> = ({ users, records }) => {
  const getUserStatus = (userId: string, courseIds: string[]) => {
    const userRecords = records.filter(r => r.user_id === userId && courseIds.includes(r.course_id));
    if (userRecords.length === 0) return 'missing';
    const hasExpired = userRecords.some(r => r.status === 'expired');
    if (hasExpired) return 'expired';
    const isExpiring = userRecords.some(r => r.status === 'expiring_soon');
    if (isExpiring) return 'warning';
    return 'valid';
  };

  const getStatusColor = (status: string) => {
    switch(status) {
      case 'valid': return 'bg-green-500';
      case 'warning': return 'bg-yellow-500';
      case 'expired': return 'bg-red-500';
      default: return 'bg-gray-200 dark:bg-gray-700';
    }
  };

  return (
    <Card title="Workforce Competency Matrix" className="overflow-hidden">
      <div className="overflow-x-auto">
        <table className="min-w-full text-sm text-left">
          <thead className="bg-gray-50 dark:bg-white/5 text-xs uppercase font-semibold text-gray-500">
            <tr>
              <th className="px-4 py-3 sticky left-0 bg-gray-50 dark:bg-slate-900 z-10">Employee</th>
              <th className="px-4 py-3">Role</th>
              <th className="px-4 py-3 text-center">HSE Induction</th>
              <th className="px-4 py-3 text-center">Work at Height</th>
              <th className="px-4 py-3 text-center">Confined Space</th>
              <th className="px-4 py-3 text-center">Electrical Safety</th>
              <th className="px-4 py-3 text-center">First Aid</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100 dark:divide-white/10">
            {users.map(user => (
              <tr key={user.id} className="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                <td className="px-4 py-3 font-medium sticky left-0 bg-white dark:bg-slate-950 z-10">
                  <div className="flex items-center gap-3">
                    <img src={user.avatar_url || 'https://i.pravatar.cc/150'} alt="" className="w-8 h-8 rounded-full" />
                    <div>
                      <div className="text-gray-900 dark:text-white">{user.name}</div>
                      <div className="text-xs text-gray-500">{user.email}</div>
                    </div>
                  </div>
                </td>
                {/* FIX: Safe role replacement */}
                <td className="px-4 py-3 text-gray-500">{(user.role || 'Unknown').replace('_', ' ')}</td>
                {['ind_001', 'wah_001', 'cs_001', 'elec_001', 'fa_001'].map(courseId => {
                   const status = getUserStatus(user.id, [courseId]);
                   return (
                     <td key={courseId} className="px-4 py-3 text-center">
                       <div className={`w-3 h-3 rounded-full mx-auto ${getStatusColor(status)}`} title={status} />
                     </td>
                   );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </Card>
  );
};

==================================================
FILE: .\src\components\training\TrainingAnalytics.tsx
==================================================

import React from 'react';
import { Card } from '../ui/Card';
import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, PieChart, Pie, Cell } from 'recharts';

const complianceData = [
  { name: 'Valid', value: 65, color: '#10b981' },
  { name: 'Expiring', value: 15, color: '#f59e0b' },
  { name: 'Expired', value: 10, color: '#ef4444' },
  { name: 'Missing', value: 10, color: '#94a3b8' },
];

const gapData = [
  { role: 'Electrician', gap: 20 },
  { role: 'Scaffolder', gap: 15 },
  { role: 'Welder', gap: 5 },
  { role: 'Supervisor', gap: 30 },
];

export const TrainingAnalytics: React.FC = () => {
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <Card title="Workforce Compliance Status">
        <div className="h-64 w-full">
          <ResponsiveContainer>
            <PieChart>
              <Pie data={complianceData} innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                {complianceData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
              </Pie>
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        </div>
        <div className="flex justify-center gap-4 text-xs">
          {complianceData.map(d => (
            <div key={d.name} className="flex items-center gap-1">
              <div className="w-2 h-2 rounded-full" style={{ backgroundColor: d.color }} />
              <span>{d.name} ({d.value}%)</span>
            </div>
          ))}
        </div>
      </Card>

      <Card title="Critical Competency Gaps by Role">
        <div className="h-64 w-full">
          <ResponsiveContainer>
            <BarChart data={gapData} layout="vertical">
              <XAxis type="number" hide />
              <YAxis dataKey="role" type="category" width={100} tick={{fontSize: 12}} />
              <Tooltip cursor={{fill: 'transparent'}} />
              <Bar dataKey="gap" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={20} />
            </BarChart>
          </ResponsiveContainer>
        </div>
        <p className="text-xs text-gray-500 mt-2 text-center">% of required certifications missing per role</p>
      </Card>
    </div>
  );
};

==================================================
FILE: .\src\components\ui\ActionsBar.tsx
==================================================


import React, { useState, useRef, useEffect } from 'react';
import { Button } from './Button';

interface ActionsBarProps {
  onEmail?: () => void;
  onPrint?: () => void;
  onDownloadPdf?: () => void;
  downloadOptions?: {
      label: string;
      handler: () => void;
  }[];
}

export const ActionsBar: React.FC<ActionsBarProps> = ({ onEmail, onPrint, onDownloadPdf, downloadOptions }) => {
  const [downloadOpen, setDownloadOpen] = useState(false);
  const downloadRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (downloadRef.current && !downloadRef.current.contains(event.target as Node)) {
        setDownloadOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  return (
    <div className="flex items-center space-x-2 print:hidden">
      {onPrint && <Button variant="secondary" size="sm" onClick={onPrint} leftIcon={<PrinterIcon />}>Print</Button>}
      
      {onDownloadPdf && !downloadOptions && (
          <Button variant="secondary" size="sm" onClick={onDownloadPdf} leftIcon={<DownloadIcon />}>Download PDF</Button>
      )}

      {downloadOptions && downloadOptions.length > 0 && (
        <div className="relative" ref={downloadRef}>
            <Button variant="secondary" size="sm" onClick={() => setDownloadOpen(prev => !prev)} leftIcon={<DownloadIcon />}>
            Download â–¾
            </Button>
            {downloadOpen && (
            <div className="absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-dark-card shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-20 border dark:border-dark-border">
                <div className="py-1" role="menu" aria-orientation="vertical">
                {downloadOptions.map(opt => (
                    <a
                        key={opt.label}
                        href="#"
                        onClick={(e) => { e.preventDefault(); opt.handler(); setDownloadOpen(false); }}
                        className="text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/10 block px-4 py-2 text-sm"
                        role="menuitem"
                    >
                        {opt.label}
                    </a>
                ))}
                </div>
            </div>
            )}
        </div>
      )}

      {onEmail && <Button variant="secondary" size="sm" onClick={onEmail} leftIcon={<MailIcon />}>Email</Button>}
    </div>
  );
};

// Icons
const PrinterIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03-.48.062-.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.32 0c.045-.247.075-.5.075-.75V13.5c0-.75-.03-1.492-.075-2.221m-11.245 0c-.045.729-.075 1.471-.075 2.221v3.75c0 .25.03.495.075.75m11.245 0c.383 0 .75.053 1.102.143m-12.447 0c.352-.09.719-.143 1.102-.143m10.245 0c.373 0 .73.056 1.074.156M4.86 18c.344-.1.691-.156 1.074-.156m12.092 0c.344.1.691.156 1.074.156" /></svg>;
const DownloadIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>;
const MailIcon = (props: React.SVGProps<SVGSVGElement>) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>;


==================================================
FILE: .\src\components\ui\Alert.tsx
==================================================

import React from 'react';
// We use a simple SVG icon here to avoid dependency issues if lucide-react isn't imported correctly in this file
const InfoIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
    <circle cx="12" cy="12" r="10"></circle>
    <line x1="12" y1="16" x2="12" y2="12"></line>
    <line x1="12" y1="8" x2="12.01" y2="8"></line>
  </svg>
);

const CheckIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
    <polyline points="22 4 12 14.01 9 11.01"></polyline>
  </svg>
);

const WarningIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5">
    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
    <line x1="12" y1="9" x2="12" y2="13"></line>
    <line x1="12" y1="17" x2="12.01" y2="17"></line>
  </svg>
);

interface AlertProps {
  type: 'success' | 'error' | 'warning' | 'info';
  children: React.ReactNode;
  className?: string;
}

export const Alert: React.FC<AlertProps> = ({ type, children, className = '' }) => {
  const configs = {
    success: { bg: 'bg-green-50 dark:bg-green-900/20', text: 'text-green-800 dark:text-green-300', border: 'border-green-200 dark:border-green-800', icon: CheckIcon },
    error: { bg: 'bg-red-50 dark:bg-red-900/20', text: 'text-red-800 dark:text-red-300', border: 'border-red-200 dark:border-red-800', icon: WarningIcon },
    warning: { bg: 'bg-yellow-50 dark:bg-yellow-900/20', text: 'text-yellow-800 dark:text-yellow-300', border: 'border-yellow-200 dark:border-yellow-800', icon: WarningIcon },
    info: { bg: 'bg-blue-50 dark:bg-blue-900/20', text: 'text-blue-800 dark:text-blue-300', border: 'border-blue-200 dark:border-blue-800', icon: InfoIcon },
  };

  const Config = configs[type];
  const Icon = Config.icon;

  return (
    <div className={`p-4 rounded-lg border flex items-start gap-3 ${Config.bg} ${Config.border} ${className}`}>
      <div className={`flex-shrink-0 ${Config.text}`}>
        <Icon />
      </div>
      <div className={`text-sm ${Config.text}`}>{children}</div>
    </div>
  );
};

==================================================
FILE: .\src\components\ui\Badge.tsx
==================================================

import React from 'react';

interface BadgeProps {
  children: React.ReactNode;
  color: 'green' | 'blue' | 'yellow' | 'red' | 'gray' | 'purple' | 'indigo' | 'amber';
  size?: 'sm' | 'md';
  className?: string;
}

export const Badge: React.FC<BadgeProps> = ({ children, color, size = 'md', className = '' }) => {
    const baseClasses = 'inline-flex items-center font-bold rounded-full border backdrop-blur-md shadow-sm';

    const colorClasses = {
        green: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20 shadow-emerald-500/10',
        blue: 'bg-blue-500/10 text-blue-400 border-blue-500/20 shadow-blue-500/10',
        yellow: 'bg-amber-500/10 text-amber-400 border-amber-500/20 shadow-amber-500/10',
        amber: 'bg-amber-500/10 text-amber-400 border-amber-500/20 shadow-amber-500/10',
        red: 'bg-red-500/10 text-red-400 border-red-500/20 shadow-red-500/10',
        gray: 'bg-gray-500/10 text-gray-400 border-gray-500/20',
        purple: 'bg-purple-500/10 text-purple-400 border-purple-500/20 shadow-purple-500/10',
        indigo: 'bg-indigo-500/10 text-indigo-400 border-indigo-500/20 shadow-indigo-500/10',
    };

    const sizeClasses = {
        sm: 'px-2 py-0.5 text-[10px]',
        md: 'px-3 py-1 text-xs', 
    };

    return (
        <span className={`${baseClasses} ${colorClasses[color]} ${sizeClasses[size]} ${className}`}>
            {children}
        </span>
    );
}

==================================================
FILE: .\src\components\ui\BaseModal.tsx
==================================================

import React, { useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';

interface BaseModalProps {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  children: React.ReactNode;
  size?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | 'full';
}

export const BaseModal: React.FC<BaseModalProps> = ({ 
  isOpen, 
  onClose, 
  title, 
  children, 
  size = 'md' 
}) => {
  const modalRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      document.body.style.overflow = 'hidden';
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  const sizeClasses = {
    sm: 'max-w-md',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
    '2xl': 'max-w-6xl',
    full: 'max-w-[95vw] h-[95vh]',
  };

  return createPortal(
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <div className="absolute inset-0" onClick={onClose} />
      <div 
        ref={modalRef}
        className={`
          relative bg-white dark:bg-slate-900 rounded-xl shadow-2xl 
          w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col
          border border-slate-200 dark:border-slate-700
          animate-in fade-in zoom-in-95 duration-200
        `}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 shrink-0">
          <h3 className="text-lg font-bold text-slate-900 dark:text-white">{title}</h3>
          <button onClick={onClose} className="p-1 rounded-lg text-slate-400 hover:text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div className="p-6 overflow-y-auto">
          {children}
        </div>
      </div>
    </div>,
    document.body
  );
};

==================================================
FILE: .\src\components\ui\Button.tsx
==================================================

import React from 'react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode;
  variant?: 'primary' | 'secondary' | 'danger' | 'ghost' | 'outline';
  size?: 'sm' | 'md' | 'lg';
  leftIcon?: React.ReactNode;
}

export const Button: React.FC<ButtonProps> = ({ children, variant = 'primary', size = 'md', leftIcon, className = '', ...props }) => {
  const baseClasses = 'inline-flex items-center justify-center font-semibold rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95';
  
  const variantClasses = {
    // Green gradient
    primary: 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 hover:from-emerald-400 hover:to-emerald-500 border border-transparent',
    // Gray background for Light Mode, Transparent for Dark Mode
    secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-white/10 dark:text-white dark:hover:bg-white/20 border border-transparent backdrop-blur-sm',
    // Outlined
    outline: 'bg-transparent text-emerald-600 border border-emerald-600 hover:bg-emerald-50 dark:text-emerald-400 dark:border-emerald-500/50 dark:hover:bg-emerald-500/10',
    // Red gradient
    danger: 'bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30 hover:shadow-red-500/40 border border-transparent',
    // Ghost
    ghost: 'bg-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-white/5',
  };

  const sizeClasses = {
    sm: 'px-3 py-1.5 text-xs',
    md: 'px-5 py-2.5 text-sm',
    lg: 'px-6 py-3 text-base',
  };

  return (
    <button className={`${baseClasses} ${variantClasses[variant]} ${sizeClasses[size]} ${className}`} {...props}>
      {leftIcon && <span className="mr-2 -ml-0.5 h-4 w-4 flex items-center">{leftIcon}</span>}
      {children}
    </button>
  );
};

==================================================
FILE: .\src\components\ui\Card.tsx
==================================================


import React from 'react';

interface CardProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode;
  className?: string;
  title?: string;
  actions?: React.ReactNode;
  noPadding?: boolean;
  edgeColor?: 'orange' | 'blue' | 'purple' | 'green' | 'red'; // AI Edge Bar color
  depth?: boolean; // Enable 3D transform
  variant?: 'solid' | 'glass'; // New Prop
}

export const Card: React.FC<CardProps> = ({ 
  children, 
  className = '', 
  title, 
  actions, 
  noPadding = false, 
  edgeColor,
  depth = false,
  variant = 'solid', // Default to solid for functional pages
  ...props 
}) => {
  
  const edgeColorClass = {
    orange: 'from-neon-orange to-orange-600',
    blue: 'from-neon-blue to-blue-600',
    purple: 'from-neon-purple to-purple-600',
    green: 'from-neon-green to-emerald-600',
    red: 'from-neon-pink to-red-600',
  };

  // Determine base class based on variant
  const cardBaseClass = variant === 'glass' ? 'evirosafe-card-glass' : 'evirosafe-card-solid';

  return (
    <div 
      className={`${cardBaseClass} relative overflow-hidden group ${depth ? 'hover:-translate-y-1' : ''} ${className}`} 
      style={depth ? { transition: 'transform 0.3s ease, box-shadow 0.3s ease', transform: 'translateZ(12px)' } : {}}
      {...props}
    >
      {/* AI Edge Bar */}
      {edgeColor && (
        <div className={`absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b ${edgeColorClass[edgeColor]} shadow-[0_0_15px_currentColor] opacity-80 group-hover:opacity-100 transition-opacity`}></div>
      )}
      
      {/* Subtle Inner Border for Depth (Glass only) */}
      {variant === 'glass' && (
        <div className="absolute inset-0 rounded-[24px] border border-white/5 pointer-events-none"></div>
      )}

      {(title || actions) && (
        <div className={`px-6 py-4 border-b ${variant === 'glass' ? 'border-white/10' : 'border-[#1f2937]'} flex justify-between items-center ${edgeColor ? 'pl-8' : ''} ${variant === 'glass' ? 'bg-gradient-to-r from-white/5 to-transparent' : 'bg-[#0f172a]'}`}>
          {title && <h3 className="text-lg font-bold tracking-tight text-text-primary dark:text-white drop-shadow-sm">{title}</h3>}
          {actions && <div className="flex items-center space-x-2">{actions}</div>}
        </div>
      )}
      <div className={`${noPadding ? '' : 'p-6'} ${edgeColor ? 'pl-8' : ''} relative z-10`}>
        {children}
      </div>
    </div>
  );
};


==================================================
FILE: .\src\components\ui\ConfirmationDialog.tsx
==================================================

import React from 'react';
import { BaseModal } from './BaseModal'; // <--- Updated import
import { Button } from './Button';

interface ConfirmationDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  message: string;
  confirmLabel?: string;
  cancelLabel?: string;
  variant?: 'danger' | 'primary';
}

export const ConfirmationDialog: React.FC<ConfirmationDialogProps> = ({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  confirmLabel = 'Confirm',
  cancelLabel = 'Cancel',
  variant = 'primary',
}) => {
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} title={title} size="sm">
      <div className="space-y-4">
        <p className="text-sm text-gray-600 dark:text-gray-300">
          {message}
        </p>
        <div className="flex justify-end space-x-3">
          <Button variant="secondary" onClick={onClose}>
            {cancelLabel}
          </Button>
          <Button 
            variant={variant === 'danger' ? 'danger' : 'primary'} 
            onClick={() => {
              onConfirm();
              onClose();
            }}
          >
            {confirmLabel}
          </Button>
        </div>
      </div>
    </BaseModal>
  );
};

==================================================
FILE: .\src\components\ui\EmailModal.tsx
==================================================

import React, { useState } from 'react';
import type { User } from '../../types';
import { Button } from './Button';
import { sendDocumentEmail } from '../../services/emailService';

interface EmailModalProps {
    isOpen: boolean;
    onClose: () => void;
    documentTitle: string;
    documentLink: string;
    defaultRecipients: Partial<User>[];
}

export const EmailModal: React.FC<EmailModalProps> = ({ isOpen, onClose, documentTitle, documentLink, defaultRecipients }) => {
    const [recipients] = useState<string[]>(defaultRecipients.map(u => u.email).filter(Boolean) as string[]);
    const [additionalEmails, setAdditionalEmails] = useState('');
    const [message, setMessage] = useState(`Hello,\n\nPlease review the attached document.\n\nThank you.`);
    const [isSending, setIsSending] = useState(false);
    const [isSent, setIsSent] = useState(false);

    const handleSend = async () => {
        setIsSending(true);
        
        const extra = additionalEmails.split(',').map(e => e.trim()).filter(e => e);
        const allEmails = [...new Set([...recipients, ...extra])];

        try {
            const promises = allEmails.map(email => 
                sendDocumentEmail(email, documentTitle, documentLink, message)
            );
            
            await Promise.all(promises);
            
            setIsSent(true);
            setTimeout(() => {
                onClose();
                setIsSent(false);
            }, 2000);
        } catch (error) {
            alert("Failed to send emails. Check console.");
        } finally {
            setIsSending(false);
        }
    };
    
    const handleClose = () => {
        if (isSending) return;
        setIsSent(false);
        onClose();
    }

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 print:hidden" onClick={handleClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-2xl" onClick={e => e.stopPropagation()}>
                {isSent ? (
                    <div className="p-12 text-center">
                        <CheckCircleIcon className="w-16 h-16 text-green-500 mx-auto mb-4" />
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">Email Sent!</h3>
                        <p className="text-text-secondary dark:text-dark-text-secondary">Your document has been successfully sent.</p>
                    </div>
                ) : (
                    <>
                        <div className="p-6 border-b dark:border-dark-border"><h3 className="text-xl font-bold text-gray-900 dark:text-white">Email Document</h3></div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-sm font-medium text-gray-700 dark:text-gray-300">To:</label>
                                <div className="flex flex-wrap gap-2 p-2 border rounded-md mt-1 dark:border-dark-border bg-gray-50 dark:bg-dark-background">
                                    {recipients.map(email => (<span key={email} className="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm px-2 py-1 rounded-full">{email}</span>))}
                                    {recipients.length === 0 && <span className="text-gray-400 text-sm">No default recipients</span>}
                                </div>
                            </div>
                            <div>
                                <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Add more recipients (comma separated):</label>
                                <input type="text" value={additionalEmails} onChange={(e) => setAdditionalEmails(e.target.value)} className="w-full mt-1 p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" placeholder="colleague@company.com" />
                            </div>
                            <div>
                                <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Message:</label>
                                <textarea value={message} onChange={(e) => setMessage(e.target.value)} rows={5} className="w-full mt-1 p-2 border rounded-md dark:bg-dark-background dark:border-dark-border dark:text-white" />
                                <p className="text-xs text-text-secondary dark:text-dark-text-secondary mt-1">A link to "{documentTitle}" will be included automatically.</p>
                            </div>
                        </div>
                        <div className="bg-gray-50 dark:bg-dark-background px-6 py-3 flex justify-end space-x-2 border-t dark:border-dark-border">
                            <Button variant="secondary" onClick={handleClose}>Cancel</Button>
                            <Button onClick={handleSend} disabled={isSending}>{isSending ? 'Sending...' : 'Send Email'}</Button>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
};

const CheckCircleIcon = (props: React.SVGProps<SVGSVGElement>) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
);

==================================================
FILE: .\src\components\ui\EmptyState.tsx
==================================================

import React from 'react';
import { Button } from './Button';
import { Inbox } from 'lucide-react';

interface EmptyStateProps {
  title: string;
  description: string;
  actionLabel?: string;
  onAction?: () => void;
  icon?: React.ReactNode;
}

export const EmptyState: React.FC<EmptyStateProps> = ({ 
  title, 
  description, 
  actionLabel, 
  onAction,
  icon 
}) => {
  return (
    <div className="flex flex-col items-center justify-center p-12 text-center border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900/30">
      <div className="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-400">
        {icon || <Inbox className="w-8 h-8" />}
      </div>
      <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-1">
        {title}
      </h3>
      <p className="text-sm text-gray-500 dark:text-gray-400 max-w-sm mb-6">
        {description}
      </p>
      {actionLabel && onAction && (
        <Button onClick={onAction}>
          {actionLabel}
        </Button>
      )}
    </div>
  );
};

==================================================
FILE: .\src\components\ui\FormField.tsx
==================================================

import React from 'react';

interface FormFieldProps {
  label: string;
  children: React.ReactNode; // Changed to ReactNode to accept multiple elements
  fullWidth?: boolean;
  className?: string;
}

export const FormField: React.FC<FormFieldProps> = ({ label, children, fullWidth = false, className = '' }) => {
    return (
        <div className={`${fullWidth ? 'md:col-span-2' : ''} ${className}`}>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                {label}
            </label>
            <div className="mt-1">
                {children}
            </div>
        </div>
    );
};

==================================================
FILE: .\src\components\ui\loader.tsx
==================================================

import React from 'react';

interface LoaderProps {
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export const Loader: React.FC<LoaderProps> = ({ size = 'md', className = '' }) => {
  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-6 h-6',
    lg: 'w-8 h-8',
  };

  return (
    <svg 
      className={`animate-spin text-current ${sizeClasses[size]} ${className}`} 
      xmlns="http://www.w3.org/2000/svg" 
      fill="none" 
      viewBox="0 0 24 24"
    >
      <circle 
        className="opacity-25" 
        cx="12" 
        cy="12" 
        r="10" 
        stroke="currentColor" 
        strokeWidth="4"
      ></circle>
      <path 
        className="opacity-75" 
        fill="currentColor" 
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
      ></path>
    </svg>
  );
};

==================================================
FILE: .\src\components\ui\LoadingSpinner.tsx
==================================================

import React from 'react';
import { Loader2 } from 'lucide-react';

interface LoadingSpinnerProps {
  size?: 'sm' | 'md' | 'lg' | 'xl';
  className?: string;
}

export const LoadingSpinner: React.FC<LoadingSpinnerProps> = ({ size = 'md', className = '' }) => {
  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-6 h-6',
    lg: 'w-8 h-8',
    xl: 'w-12 h-12'
  };

  return (
    <div className={`flex justify-center items-center ${className}`}>
      <Loader2 className={`animate-spin text-primary-600 dark:text-primary-400 ${sizeClasses[size]}`} />
    </div>
  );
};

==================================================
FILE: .\src\components\ui\SearchInput.tsx
==================================================

import React from 'react';
import { Search } from 'lucide-react';

interface SearchInputProps {
  value: string;
  onChange: (value: string) => void;
  className?: string;
  placeholder?: string;
}

export const SearchInput: React.FC<SearchInputProps> = ({ value, onChange, className = '', placeholder = 'Search...' }) => {
  return (
    <div className={`relative ${className}`}>
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full pl-10 pr-4 py-2 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
      />
    </div>
  );
};

==================================================
FILE: .\src\components\ui\Select.tsx
==================================================

import React from 'react';

interface SelectOption {
  value: string;
  label: string;
}

interface SelectProps extends React.SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  options: SelectOption[];
  error?: string;
}

export const Select: React.FC<SelectProps> = ({ label, options, error, className = '', ...props }) => {
  return (
    <div className="w-full">
      {label && (
        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
          {label}
        </label>
      )}
      <div className="relative">
        <select
          className={`
            block w-full rounded-lg border-gray-300 bg-white py-2 pl-3 pr-10 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500
            dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:focus:border-primary-500
            disabled:cursor-not-allowed disabled:bg-gray-50 dark:disabled:bg-gray-900
            ${error ? 'border-red-500 focus:border-red-500 focus:ring-red-500' : ''}
            ${className}
          `}
          {...props}
        >
          {options.map((option) => (
            <option key={option.value} value={option.value}>
              {option.label}
            </option>
          ))}
        </select>
      </div>
      {error && <p className="mt-1 text-sm text-red-500">{error}</p>}
    </div>
  );
};

==================================================
FILE: .\src\components\ui\SignaturePadModal.tsx
==================================================


import React, { useState, useRef, useEffect } from 'react';
import { Button } from './Button';

interface SignaturePadModalProps {
  onClose: () => void;
  onSave: (dataUrl: string) => void;
  personName: string;
}

export const SignaturePadModal: React.FC<SignaturePadModalProps> = ({ onClose, onSave, personName }) => {
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const [isDrawing, setIsDrawing] = useState(false);

    useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        // Set canvas size for high-res displays
        const scale = window.devicePixelRatio;
        canvas.width = canvas.offsetWidth * scale;
        canvas.height = canvas.offsetHeight * scale;
        ctx.scale(scale, scale);

        ctx.strokeStyle = '#1e293b'; // text-primary
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    }, []);

    const getCoords = (event: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
        const canvas = canvasRef.current;
        if (!canvas) return { x: 0, y: 0 };
        const rect = canvas.getBoundingClientRect();
        if ('touches' in event.nativeEvent) {
             return {
                x: event.nativeEvent.touches[0].clientX - rect.left,
                y: event.nativeEvent.touches[0].clientY - rect.top
            };
        }
        return {
            x: event.nativeEvent.offsetX,
            y: event.nativeEvent.offsetY
        };
    }

    const startDrawing = (event: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
        const { x, y } = getCoords(event);
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
    };

    const draw = (event: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
        if (!isDrawing) return;
        const { x, y } = getCoords(event);
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.lineTo(x, y);
        ctx.stroke();
    };

    const stopDrawing = () => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.closePath();
        setIsDrawing(false);
    };

    const clear = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    const handleSave = () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        // Check if canvas is empty
        const context = canvas.getContext('2d');
        if(!context) return;
        const pixelBuffer = new Uint32Array(context.getImageData(0, 0, canvas.width, canvas.height).data.buffer);
        const isEmpty = !pixelBuffer.some(color => color !== 0);

        if(isEmpty) {
            alert("Please provide a signature before saving.");
            return;
        }

        const dataUrl = canvas.toDataURL('image/png');
        onSave(dataUrl);
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white dark:bg-dark-card rounded-lg shadow-xl w-full max-w-lg" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b dark:border-dark-border">
                    <h3 className="text-lg font-bold">Signing for {personName}</h3>
                    <p className="text-sm text-text-secondary dark:text-dark-text-secondary">Please sign in the box below.</p>
                </div>
                <div className="p-4">
                    <canvas
                        ref={canvasRef}
                        className="border bg-gray-50 dark:bg-dark-background dark:border-dark-border rounded-md cursor-crosshair w-full h-48"
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        onTouchStart={startDrawing}
                        onTouchMove={draw}
                        onTouchEnd={stopDrawing}
                    />
                </div>
                <div className="bg-gray-50 dark:bg-dark-background px-4 py-3 flex justify-between items-center border-t dark:border-dark-border">
                    <Button variant="secondary" size="sm" onClick={clear}>Clear</Button>
                    <div className="space-x-2">
                        <Button variant="secondary" size="sm" onClick={onClose}>Cancel</Button>
                        <Button size="sm" onClick={handleSave}>Save Signature</Button>
                    </div>
                </div>
            </div>
        </div>
    );
};


==================================================
FILE: .\src\components\ui\Switch.tsx
==================================================

import React from 'react';

interface SwitchProps {
  checked: boolean;
  onChange: (checked: boolean) => void;
  disabled?: boolean;
  className?: string;
}

export const Switch: React.FC<SwitchProps> = ({ checked, onChange, disabled, className = '' }) => {
  return (
    <button
      type="button"
      role="switch"
      aria-checked={checked}
      disabled={disabled}
      onClick={() => !disabled && onChange(!checked)}
      className={`
        relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent 
        transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2
        ${checked ? 'bg-primary-600' : 'bg-gray-200 dark:bg-gray-700'}
        ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
        ${className}
      `}
    >
      <span
        aria-hidden="true"
        className={`
          pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 
          transition duration-200 ease-in-out
          ${checked ? 'translate-x-5' : 'translate-x-0'}
        `}
      />
    </button>
  );
};

==================================================
FILE: .\src\components\ui\Toast.tsx
==================================================

import React, { createContext, useState, useContext, useCallback } from 'react';
import { CheckCircle, XCircle, Info } from 'lucide-react';

type ToastType = 'success' | 'error' | 'info';

interface ToastMessage {
  id: string;
  message: string;
  type: ToastType;
}

interface ToastContextType {
  addToast: (message: string, type: ToastType) => void;
  success: (message: string) => void;
  error: (message: string) => void;
  info: (message: string) => void;
}

const ToastContext = createContext<ToastContextType | undefined>(undefined);

export const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [toasts, setToasts] = useState<ToastMessage[]>([]);
  
  const addToast = useCallback((message: string, type: ToastType) => {
    const id = crypto.randomUUID();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setToasts(prev => prev.filter(toast => toast.id !== id));
    }, 5000);
  }, []);

  const value = {
    addToast,
    success: (message: string) => addToast(message, 'success'),
    error: (message: string) => addToast(message, 'error'),
    info: (message: string) => addToast(message, 'info'),
  };

  return (
    <ToastContext.Provider value={value}>
      {children}
      <ToastContainer toasts={toasts} />
    </ToastContext.Provider>
  );
};

export const useToast = () => {
  const context = useContext(ToastContext);
  if (context === undefined) {
    throw new Error('useToast must be used within a ToastProvider');
  }
  return context;
};

const ToastContainer: React.FC<{ toasts: ToastMessage[] }> = ({ toasts }) => {
  return (
    <div className="fixed top-5 right-5 z-[100] space-y-2 w-full max-w-sm">
      {toasts.map(toast => (
        <Toast key={toast.id} {...toast} />
      ))}
    </div>
  );
};

const Toast: React.FC<ToastMessage> = ({ message, type }) => {
  const baseClasses = 'w-full p-4 rounded-lg shadow-lg text-sm font-semibold flex items-center animate-fade-in-right';
  const typeClasses = {
    success: 'bg-green-500 text-white',
    error: 'bg-red-500 text-white',
    info: 'bg-blue-500 text-white',
  };

  const icons = {
    success: <CheckCircle className="w-5 h-5 mr-3" />,
    error: <XCircle className="w-5 h-5 mr-3" />,
    info: <Info className="w-5 h-5 mr-3" />,
  }

  return (
    <div className={`${baseClasses} ${typeClasses[type]}`}>
      {icons[type]}
      {message}
    </div>
  );
};

==================================================
FILE: .\src\components\ui\Tooltip.tsx
==================================================

import React, { useState } from 'react';

interface TooltipProps {
  content: string;
  children: React.ReactElement;
  position?: 'top' | 'bottom' | 'left' | 'right';
}

export const Tooltip: React.FC<TooltipProps> = ({ content, children, position = 'top' }) => {
  const [isVisible, setIsVisible] = useState(false);

  const positionClasses = {
    top: 'bottom-full left-1/2 -translate-x-1/2 -translate-y-2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 translate-y-2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 -translate-x-2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 translate-x-2 ml-2',
  };

  return (
    <div 
      className="relative inline-flex"
      onMouseEnter={() => setIsVisible(true)}
      onMouseLeave={() => setIsVisible(false)}
    >
      {children}
      {isVisible && (
        <div className={`absolute z-50 px-2 py-1 text-xs font-medium text-white bg-gray-900 rounded-md shadow-lg whitespace-nowrap pointer-events-none transition-opacity duration-200 ${positionClasses[position]}`}>
          {content}
          {/* Arrow */}
          <div className={`absolute w-2 h-2 bg-gray-900 transform rotate-45 
            ${position === 'top' ? 'bottom-[-4px] left-1/2 -translate-x-1/2' : ''}
            ${position === 'bottom' ? 'top-[-4px] left-1/2 -translate-x-1/2' : ''}
            ${position === 'left' ? 'right-[-4px] top-1/2 -translate-y-1/2' : ''}
            ${position === 'right' ? 'left-[-4px] top-1/2 -translate-y-1/2' : ''}
          `} />
        </div>
      )}
    </div>
  );
};

==================================================
FILE: .\src\config\index.ts
==================================================

import type { PtwType } from '../types/ptw';

export const ptwChecklistData: Record<PtwType, { id: string; text: string }[]> = {
  'Utility Work': [
    { id: 'uw_1', text: 'Does the work require announcement to the community?' },
    { id: 'uw_2', text: 'Method Statement / Risk Assessment provided?' },
    { id: 'uw_3', text: 'Work area barricaded with barriers and proper safety signages displayed?' },
    { id: 'uw_4', text: 'Underground service drawing(s) available?' },
    { id: 'uw_5', text: 'Service isolated and locked as per LOTO procedure?' },
    { id: 'uw_6', text: 'Underground installations are protected, supported, or removed as required?' },
    { id: 'uw_7', text: 'Firewatcher trained to extinguish fire and initiate emergency procedure?' },
    { id: 'uw_8', text: 'Firefighters aware of work and deployed (as required)?' },
    { id: 'uw_9', text: 'Back-up plan in place and approved where shutdown of utility services required?' },
    { id: 'uw_10', text: 'Employees trained & briefed on the Risk Assessment and work environment?' },
    { id: 'uw_11', text: 'Weather conditions suitable to execute the work?' },
    { id: 'uw_12', text: 'Equipment to be used inspected, tested and tagged?' },
    { id: 'uw_13', text: 'Adequate access provided for pedestrian and utility services vehicles?' },
    { id: 'uw_14', text: 'Road diversion plan approved and in place (if required)?' },
    { id: 'uw_15', text: 'Hard barriers installed when excavations are next to roadways?' }
  ],
  'Work at Height': [
    { id: 'wah_1', text: 'Does the work require announcement to the community?' },
    { id: 'wah_2', text: 'Method Statement / Risk Assessment provided?' },
    { id: 'wah_3', text: 'Work area barricaded with barriers and proper safety signages displayed?' },
    { id: 'wah_4', text: 'Environmental factors assessed & suitable for work?' },
    { id: 'wah_5', text: 'Safety Clearance from adjacent structures / FM team?' },
    { id: 'wah_6', text: 'MEWP / Scaffolding is clearly marked with safe Working Load and maximum persons?' },
    { id: 'wah_7', text: 'Scaffolding erected, inspected and tagged by competent personnel?' },
    { id: 'wah_8', text: 'Level and sturdy solid ground surface for access equipment?' },
    { id: 'wah_9', text: 'Minimum distance maintained for overhead power lines?' },
    { id: 'wah_10', text: 'Third-party certificate for MEWP / BMU?' },
    { id: 'wah_11', text: 'Personnel are trained and certified for the job?' },
    { id: 'wah_12', text: 'Electrical systems, pipes, tanks, or valves isolated?' },
    { id: 'wah_13', text: 'Full body harness with shock absorber provided?' },
    { id: 'wah_14', text: 'Ladders/ scaffolds/ MEWP/ BMU are free from defects?' },
    { id: 'wah_15', text: 'If the work on-road, flag man / banks man provided?' }
  ],
  'General Work': [
    { id: 'gw_1', text: 'Risk assessment and method statement approved?' },
    { id: 'gw_2', text: 'Work area barricaded with proper signage?' },
    { id: 'gw_3', text: 'Safe Workplace regarding Lighting and ventilation?' },
    { id: 'gw_4', text: 'Services isolated (LOTO) if required?' },
    { id: 'gw_5', text: 'Fire extinguisher provided nearby?' },
    { id: 'gw_6', text: 'Employees aware of emergency assembly point?' },
    { id: 'gw_7', text: 'Chemicals have MSDS / COSHH present?' },
    { id: 'gw_8', text: 'Toolbox talk conducted?' },
    { id: 'gw_9', text: 'Mandatory PPEs provided and checked?' },
    { id: 'gw_10', text: 'First Aid Kit available at site?' }
  ],
  'Confined Space Entry': [
    { id: 'cs_1', text: 'Risk assessment and method statement approved?' },
    { id: 'cs_2', text: 'Suitable ventilation (natural or mechanical) provided?' },
    { id: 'cs_3', text: 'Proper means of access and egress available?' },
    { id: 'cs_4', text: 'Entrants, standby and supervisor identified?' },
    { id: 'cs_5', text: 'Emergency Rescue plan provided?' },
    { id: 'cs_6', text: 'Gas detector available and calibrated?' },
    { id: 'cs_7', text: 'Retrieval equipment available (tripod, rope)?' },
    { id: 'cs_8', text: 'Communication devices in place?' }
  ],
  'Night Work': [
    { id: 'nw_1', text: 'Adequate lighting provided?' },
    { id: 'nw_2', text: 'Hi-visibility jackets with reflective strips provided?' },
    { id: 'nw_3', text: 'Continuous supervision maintained?' },
    { id: 'nw_4', text: 'Emergency arrangements in place?' }
  ],
  'Electrical Work': [
    { id: 'ew_1', text: 'Personnel qualified for electrical work?' },
    { id: 'ew_2', text: 'Power source isolated and locked (LOTO)?' },
    { id: 'ew_3', text: 'Insulated tools in good condition?' },
    { id: 'ew_4', text: 'Equipment properly grounded?' }
  ],
  'Excavation': [
    { id: 'ex_1', text: 'Underground service drawings available?' },
    { id: 'ex_2', text: 'Cave-in protection in place?' },
    { id: 'ex_3', text: 'Exclusion zones marked?' },
    { id: 'ex_4', text: 'Hard barriers for excavations near roadways?' }
  ],
  'Hot Work': [
    { id: 'hw_1', text: 'Fire watch appointed?' },
    { id: 'hw_2', text: 'Combustibles removed from area?' },
    { id: 'hw_3', text: 'Fire extinguisher (ABC) available?' },
    { id: 'hw_4', text: 'Flashback arrestors fitted on gas hoses?' },
    { id: 'hw_5', text: 'Welding machine certified?' }
  ],
  'Road Closure': [
    { id: 'rc_1', text: 'Diversion plan approved?' },
    { id: 'rc_2', text: 'Reflective signage erected?' },
    { id: 'rc_3', text: 'Hard barriers installed?' },
    { id: 'rc_4', text: 'Flag man / banksman appointed?' }
  ],
  'Lifting': [
    { id: 'li_1', text: 'Lifting plan approved?' },
    { id: 'li_2', text: 'Crane capacity suitable for load?' },
    { id: 'li_3', text: 'Outriggers fully extended on pads?' },
    { id: 'li_4', text: 'Rigging gear certified?' },
    { id: 'li_5', text: 'Taglines attached to load?' }
  ],
  'Mechanical Work': [
    { id: 'mw_1', text: 'Equipment isolated?' },
    { id: 'mw_2', text: 'Tools inspected?' },
    { id: 'mw_3', text: 'PPE provided?' }
  ],
  'Chemical Handling': [
    { id: 'ch_1', text: 'MSDS available?' },
    { id: 'ch_2', text: 'Spill kit available?' },
    { id: 'ch_3', text: 'Appropriate PPE (gloves, mask) used?' }
  ]
};

==================================================
FILE: .\src\config\ptw-checklists.ts
==================================================

import type { PtwType } from '../types/ptw';

export const ptwChecklistData: Record<PtwType, { id: string; text: string }[]> = {
  'Utility Work': [
    { id: 'uw_1', text: 'Does the work require announcement to the community?' },
    { id: 'uw_2', text: 'Method Statement / Risk Assessment provided?' },
    { id: 'uw_3', text: 'Work area barricaded with barriers and proper safety signages displayed?' },
    { id: 'uw_4', text: 'Underground service drawing(s) available?' },
    { id: 'uw_5', text: 'Service isolated and locked as per LOTO procedure?' },
    { id: 'uw_6', text: 'Underground installations are protected, supported, or removed as required?' },
    { id: 'uw_7', text: 'Firewatcher trained to extinguish fire and initiate emergency procedure?' },
    { id: 'uw_8', text: 'Firefighters aware of work and deployed (as required)?' },
    { id: 'uw_9', text: 'Back-up plan in place and approved where shutdown of utility services required?' },
    { id: 'uw_10', text: 'Employees trained & briefed on the Risk Assessment and work environment?' },
    { id: 'uw_11', text: 'Weather conditions suitable to execute the work?' },
    { id: 'uw_12', text: 'Equipment to be used inspected, tested and tagged?' },
    { id: 'uw_13', text: 'Adequate access provided for pedestrian and utility services vehicles?' },
    { id: 'uw_14', text: 'Road diversion plan approved and in place (if required)?' },
    { id: 'uw_15', text: 'Hard barriers installed when excavations are next to roadways?' }
  ],
  'Work at Height': [
    { id: 'wah_1', text: 'Does the work require announcement to the community?' },
    { id: 'wah_2', text: 'Method Statement / Risk Assessment provided?' },
    { id: 'wah_3', text: 'Work area barricaded with barriers and proper safety signages displayed?' },
    { id: 'wah_4', text: 'Environmental factors assessed & suitable for work?' },
    { id: 'wah_5', text: 'Safety Clearance from adjacent structures / FM team?' },
    { id: 'wah_6', text: 'MEWP / Scaffolding is clearly marked with safe Working Load and maximum persons?' },
    { id: 'wah_7', text: 'Scaffolding erected, inspected and tagged by competent personnel?' },
    { id: 'wah_8', text: 'Level and sturdy solid ground surface for access equipment?' },
    { id: 'wah_9', text: 'Minimum distance maintained for overhead power lines?' },
    { id: 'wah_10', text: 'Third-party certificate for MEWP / BMU?' },
    { id: 'wah_11', text: 'Personnel are trained and certified for the job?' },
    { id: 'wah_12', text: 'Electrical systems, pipes, tanks, or valves isolated?' },
    { id: 'wah_13', text: 'Full body harness with shock absorber provided?' },
    { id: 'wah_14', text: 'Ladders/ scaffolds/ MEWP/ BMU are free from defects?' },
    { id: 'wah_15', text: 'If the work on-road, flag man / banks man provided?' }
  ],
  'General Work': [
    { id: 'gw_1', text: 'Risk assessment and method statement approved?' },
    { id: 'gw_2', text: 'Work area barricaded with proper signage?' },
    { id: 'gw_3', text: 'Safe Workplace regarding Lighting and ventilation?' },
    { id: 'gw_4', text: 'Services isolated (LOTO) if required?' },
    { id: 'gw_5', text: 'Fire extinguisher provided nearby?' },
    { id: 'gw_6', text: 'Employees aware of emergency assembly point?' },
    { id: 'gw_7', text: 'Chemicals have MSDS / COSHH present?' },
    { id: 'gw_8', text: 'Toolbox talk conducted?' },
    { id: 'gw_9', text: 'Mandatory PPEs provided and checked?' },
    { id: 'gw_10', text: 'First Aid Kit available at site?' }
  ],
  'Confined Space Entry': [
    { id: 'cs_1', text: 'Risk assessment and method statement approved?' },
    { id: 'cs_2', text: 'Suitable ventilation (natural or mechanical) provided?' },
    { id: 'cs_3', text: 'Proper means of access and egress available?' },
    { id: 'cs_4', text: 'Entrants, standby and supervisor identified?' },
    { id: 'cs_5', text: 'Emergency Rescue plan provided?' },
    { id: 'cs_6', text: 'Gas detector available and calibrated?' },
    { id: 'cs_7', text: 'Retrieval equipment available (tripod, rope)?' },
    { id: 'cs_8', text: 'Communication devices in place?' }
  ],
  'Night Work': [
    { id: 'nw_1', text: 'Adequate lighting provided?' },
    { id: 'nw_2', text: 'Hi-visibility jackets with reflective strips provided?' },
    { id: 'nw_3', text: 'Continuous supervision maintained?' },
    { id: 'nw_4', text: 'Emergency arrangements in place?' }
  ],
  'Electrical Work': [
    { id: 'ew_1', text: 'Personnel qualified for electrical work?' },
    { id: 'ew_2', text: 'Power source isolated and locked (LOTO)?' },
    { id: 'ew_3', text: 'Insulated tools in good condition?' },
    { id: 'ew_4', text: 'Equipment properly grounded?' }
  ],
  'Excavation': [
    { id: 'ex_1', text: 'Underground service drawings available?' },
    { id: 'ex_2', text: 'Cave-in protection in place?' },
    { id: 'ex_3', text: 'Exclusion zones marked?' },
    { id: 'ex_4', text: 'Hard barriers for excavations near roadways?' }
  ],
  'Hot Work': [
    { id: 'hw_1', text: 'Fire watch appointed?' },
    { id: 'hw_2', text: 'Combustibles removed from area?' },
    { id: 'hw_3', text: 'Fire extinguisher (ABC) available?' },
    { id: 'hw_4', text: 'Flashback arrestors fitted on gas hoses?' },
    { id: 'hw_5', text: 'Welding machine certified?' }
  ],
  'Road Closure': [
    { id: 'rc_1', text: 'Diversion plan approved?' },
    { id: 'rc_2', text: 'Reflective signage erected?' },
    { id: 'rc_3', text: 'Hard barriers installed?' },
    { id: 'rc_4', text: 'Flag man / banksman appointed?' }
  ],
  'Lifting': [
    { id: 'li_1', text: 'Lifting plan approved?' },
    { id: 'li_2', text: 'Crane capacity suitable for load?' },
    { id: 'li_3', text: 'Outriggers fully extended on pads?' },
    { id: 'li_4', text: 'Rigging gear certified?' },
    { id: 'li_5', text: 'Taglines attached to load?' }
  ],
  'Mechanical Work': [
    { id: 'mw_1', text: 'Equipment isolated?' },
    { id: 'mw_2', text: 'Tools inspected?' },
    { id: 'mw_3', text: 'PPE provided?' }
  ],
  'Chemical Handling': [
    { id: 'ch_1', text: 'MSDS available?' },
    { id: 'ch_2', text: 'Spill kit available?' },
    { id: 'ch_3', text: 'Appropriate PPE (gloves, mask) used?' }
  ]
};

==================================================
FILE: .\src\config\ptw-types.ts
==================================================

// src/config/ptw-types.ts

import type { PtwType } from '../types/ptw';

export const ptwTypeDetails: Record<PtwType, {
  icon: string;
  hex: string;
  description: string;
  category: 'general' | 'specialized' | 'hazardous';
  max_duration_hours: number;
  requires_risk_assessment: boolean;
  requires_method_statement: boolean;
  requires_loto: boolean;
  global_standards: string[];
}> = {
  'Utility Work': {
    icon: 'ðŸ”§',
    hex: '#4F46E5',
    description: 'Work involving utility systems, underground services, or public infrastructure',
    category: 'general',
    max_duration_hours: 24,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'OSHA 1926 Subpart P', 'Local Utility Regulations']
  },
  'Work at Height': {
    icon: 'ðŸªœ',
    hex: '#0EA5E9',
    description: 'Any work at height above 1.8 meters or where fall hazards exist',
    category: 'hazardous',
    max_duration_hours: 12,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: false,
    global_standards: ['ISO 45001', 'OSHA 1926 Subpart M', 'Fall Protection Standards']
  },
  'General Work': {
    icon: 'ðŸ‘·',
    hex: '#6B7280',
    description: 'General maintenance, repair, or construction activities',
    category: 'general',
    max_duration_hours: 24,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'OSHA General Industry Standards']
  },
  'Confined Space Entry': {
    icon: 'âš ï¸',
    hex: '#DC2626',
    description: 'Entry into confined spaces with limited entry/exit and hazardous atmosphere',
    category: 'hazardous',
    max_duration_hours: 8,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'OSHA 1910.146', 'Confined Space Regulations']
  },
  'Night Work': {
    icon: 'ðŸŒ™',
    hex: '#1E40AF',
    description: 'Work conducted during night hours with reduced visibility',
    category: 'specialized',
    max_duration_hours: 12,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'Night Work Safety Guidelines']
  },
  'Electrical Work': {
    icon: 'âš¡',
    hex: '#F59E0B',
    description: 'Work on electrical systems, equipment, or installations',
    category: 'hazardous',
    max_duration_hours: 12,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'NFPA 70E', 'Electrical Safety Standards']
  },
  'Excavation': {
    icon: 'â›ï¸',
    hex: '#92400E',
    description: 'Excavation, trenching, or digging work',
    category: 'hazardous',
    max_duration_hours: 24,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'OSHA 1926 Subpart P', 'Excavation Safety']
  },
  'Hot Work': {
    icon: 'ðŸ”¥',
    hex: '#EF4444',
    description: 'Work involving heat, sparks, or open flame',
    category: 'hazardous',
    max_duration_hours: 8,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'NFPA 51B', 'Hot Work Safety Standards']
  },
  'Road Closure': {
    icon: 'ðŸ›£ï¸',
    hex: '#10B981',
    description: 'Partial or complete closure of roads or public pathways',
    category: 'specialized',
    max_duration_hours: 24,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: false,
    global_standards: ['ISO 45001', 'MUTCD Standards', 'Traffic Management']
  },
  'Lifting': {
    icon: 'ðŸ—ï¸',
    hex: '#8B5CF6',
    description: 'Lifting operations using cranes, hoists, or lifting equipment',
    category: 'hazardous',
    max_duration_hours: 12,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: false,
    global_standards: ['ISO 45001', 'ASME B30', 'Lifting Operations Standards']
  },
  'Mechanical Work': {
    icon: 'ðŸ”©',
    hex: '#6366F1',
    description: 'Mechanical equipment maintenance and repair',
    category: 'general',
    max_duration_hours: 24,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'Machine Safety Standards']
  },
  'Chemical Handling': {
    icon: 'ðŸ§ª',
    hex: '#8B5CF6',
    description: 'Handling, storage, or use of hazardous chemicals',
    category: 'hazardous',
    max_duration_hours: 8,
    requires_risk_assessment: true,
    requires_method_statement: true,
    requires_loto: true,
    global_standards: ['ISO 45001', 'OSHA 1910.1200', 'GHS Standards']
  }
};

// --- Default Values (Moved here from ptw-checklists.ts) ---

export const emptySignoff = {
  name: '',
  designation: '',
  email: '',
  mobile: '',
  signature: '',
  remarks: '',
  signed_at: ''
};

export const emptySignature = { signature: '' };

export const emptyExtension = { 
  is_requested: false, 
  reason: '', 
  days: { from: '', to: '' }, 
  hours: { from: '', to: '' } 
};

export const emptyClosure = {
  note: '',
  permit_requester: emptySignoff,
  client_proponent: emptySignoff,
  client_hs: emptySignoff
};

==================================================
FILE: .\src\contexts\AuthContext.tsx
==================================================

import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import { auth, db } from '../firebase';
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  User as FirebaseUser,
} from 'firebase/auth';
import { doc, getDoc } from 'firebase/firestore';

interface AuthContextType {
  currentUser: FirebaseUser | null;
  userRole: string | null;
  userStatus: string | null;
  loading: boolean;
  signup: (email: string, pass: string) => Promise<void>;
  login: (email: string, pass: string) => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const useAuth = (): AuthContextType => {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used within an AuthProvider');
  return ctx;
};

export function AuthProvider({ children }: { children: ReactNode }) {
  const [currentUser, setCurrentUser] = useState<FirebaseUser | null>(null);
  const [userRole, setUserRole] = useState<string | null>(null);
  const [userStatus, setUserStatus] = useState<string | null>(null); // 'active', 'pending'
  const [loading, setLoading] = useState<boolean>(true);

  // 1. Monitor Auth State Changes
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setCurrentUser(user);
      
      if (user) {
        // User is logged in, check their Firestore Profile
        try {
          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            setUserRole(data.role);
            setUserStatus(data.status);
          } else {
            // User exists in Auth but NOT in Database (Uninvited)
            setUserRole(null);
            setUserStatus('unregistered');
          }
        } catch (error) {
          console.error("Error fetching user profile:", error);
          setUserStatus('error');
        }
      } else {
        setUserRole(null);
        setUserStatus(null);
      }
      
      setLoading(false);
    });

    return unsubscribe;
  }, []);

  async function signup(email: string, pass: string) {
    await createUserWithEmailAndPassword(auth, email, pass);
  }

  async function login(email: string, pass: string) {
    await signInWithEmailAndPassword(auth, email, pass);
  }

  async function logout() {
    await signOut(auth);
    setUserRole(null);
    setUserStatus(null);
  }

  const value: AuthContextType = {
    currentUser,
    userRole,
    userStatus,
    loading,
    signup,
    login,
    logout,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

==================================================
FILE: .\src\contexts\PtwWorkflowContext.tsx
==================================================

import React, { createContext, useContext, useState, ReactNode } from 'react';
import type { Ptw, PtwWorkflowStage } from '../types';
import { PtwWorkflowEngine } from '../utils/workflowEngine';

interface PtwWorkflowContextType {
  moveToNextStage: (ptw: Ptw, userId: string, comments?: string) => Ptw | null;
  getNextPossibleStages: (ptw: Ptw) => PtwWorkflowStage[];
  validateUserPermission: (ptw: Ptw, userId: string, userRole: string) => boolean;
  getStageResponsibilities: (stage: PtwWorkflowStage) => string[];
}

const PtwWorkflowContext = createContext<PtwWorkflowContextType | undefined>(undefined);

export const usePtwWorkflow = () => {
  const context = useContext(PtwWorkflowContext);
  if (!context) {
    throw new Error('usePtwWorkflow must be used within a PtwWorkflowProvider');
  }
  return context;
};

export const PtwWorkflowProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const moveToNextStage = (ptw: Ptw, userId: string, comments?: string): Ptw | null => {
    const nextStages = PtwWorkflowEngine.getNextStages(ptw.status);
    if (nextStages.length === 0) return null;

    // Get the next logical stage (usually first in array)
    const nextStage = nextStages[0];
    
    // Create updated PTW
    const updatedPtw: Ptw = {
      ...ptw,
      status: nextStage,
      workflow_log: [
        ...(ptw.workflow_log || []),
        {
          stage: nextStage,
          action: `Moved to ${nextStage}`,
          user_id: userId,
          timestamp: new Date().toISOString(),
          comments,
          signoff_type: 'digital' // FIX: Added this property
        }
      ],
      updated_at: new Date().toISOString()
    };

    return updatedPtw;
  };

  const getNextPossibleStages = (ptw: Ptw): PtwWorkflowStage[] => {
    return PtwWorkflowEngine.getNextStages(ptw.status);
  };

  const validateUserPermission = (ptw: Ptw, userId: string, userRole: string): boolean => {
    const permission = PtwWorkflowEngine.validateRolePermission(
      ptw.status,
      userRole,
      userId,
      ptw
    );
    return permission.allowed;
  };

  const getStageResponsibilities = (stage: PtwWorkflowStage): string[] => {
    const responsibilities: Record<PtwWorkflowStage, string[]> = {
      DRAFT: ['Requester: Complete application details'],
      REQUESTED: ['Issuer: Review application', 'HSE: Verify risk assessment'],
      ISSUER_REVIEW: ['Issuer: Verify site conditions', 'Issuer: Confirm isolations'],
      ISSUER_SIGNED: ['IV Provider: Independent verification (if critical)'],
      IV_REVIEW: ['IV Provider: Conduct safety review', 'IV Provider: Verify controls'],
      PENDING_APPROVAL: ['Approver: Review and authorize'],
      APPROVAL: ['Approver: Final safety check', 'Approver: Budget/scope verification'],
      APPROVER_SIGNED: ['Issuer: Prepare for handover'],
      AUTHORIZATION: ['Issuer: Generate permit documents'],
      HANDOVER_PENDING: ['Issuer: Conduct pre-job briefing'],
      SITE_HANDOVER: ['Receiver: Accept responsibility', 'Receiver: Verify site conditions'],
      ACTIVE: ['Receiver: Supervise work', 'Safety Watch: Monitor conditions'],
      SUSPENDED: ['Receiver: Secure work area', 'Issuer: Review suspension reason'],
      COMPLETION_PENDING: ['Receiver: Clean work area', 'Receiver: Remove tools'],
      JOINT_INSPECTION: ['Issuer & Receiver: Inspect work area', 'Issuer: Verify isolations removed'],
      CLOSED: ['Issuer: Archive documents', 'System: Update asset records'],
      CANCELLED: ['Issuer: Document cancellation reason'],
      ARCHIVED: ['System: Retention period compliance'],
      SUBMITTED: ['Reviewer: Check details'],
      PRE_SCREEN: ['HSE: Initial check'],
      SITE_INSPECTION: ['Inspector: Verify site'],
      HOLD: ['Issuer: Pause work'],
      COMPLETED: ['Receiver: Finish work'],
      REJECTED: ['Issuer: Reject permit']
    };

    return responsibilities[stage] || [];
  };

  return (
    <PtwWorkflowContext.Provider value={{
      moveToNextStage,
      getNextPossibleStages,
      validateUserPermission,
      getStageResponsibilities
    }}>
      {children}
    </PtwWorkflowContext.Provider>
  );
};

==================================================
FILE: .\src\data\checklistLibrary.ts
==================================================

import type { ChecklistTemplate } from '../types';

export const MASTER_CHECKLIST_LIBRARY: Omit<ChecklistTemplate, 'id' | 'org_id'>[] = [
  // --- GENERAL SAFETY ---
  {
    category: 'General Safety',
    title: { en: 'Daily Site Safety Inspection' },
    items: [
      { id: 'gen_1', text: { en: 'Access routes clear and safe' }, description: { en: 'Walkways free of debris/tripping hazards' } },
      { id: 'gen_2', text: { en: 'Proper PPE being worn' }, description: { en: 'Helmets, boots, vests visible' } },
      { id: 'gen_3', text: { en: 'Work areas tidy (Housekeeping)' }, description: { en: 'No loose materials or waste' } },
      { id: 'gen_4', text: { en: 'Safety signage visible' }, description: { en: 'Warning signs in place' } },
      { id: 'gen_5', text: { en: 'Lighting adequate' }, description: { en: 'Work areas well lit' } }
    ]
  },
  {
    category: 'General Safety',
    title: { en: 'PPE Compliance Check' },
    items: [
      { id: 'ppe_1', text: { en: 'Head protection worn' }, description: { en: 'Hard hats' } },
      { id: 'ppe_2', text: { en: 'Foot protection worn' }, description: { en: 'Safety boots' } },
      { id: 'ppe_3', text: { en: 'Eye protection worn' }, description: { en: 'Safety glasses/goggles' } },
      { id: 'ppe_4', text: { en: 'High visibility vests worn' }, description: { en: 'Reflective vests' } },
      { id: 'ppe_5', text: { en: 'Hand protection available' }, description: { en: 'Gloves suitable for task' } }
    ]
  },
  {
    category: 'General Safety',
    title: { en: 'Shift Handover Safety Check' },
    items: [
      { id: 'sh_1', text: { en: 'Hazards communicated to next shift' }, description: { en: '' } },
      { id: 'sh_2', text: { en: 'Equipment status verified' }, description: { en: '' } },
      { id: 'sh_3', text: { en: 'Housekeeping completed' }, description: { en: '' } }
    ]
  },

  // --- FIRE SAFETY ---
  {
    category: 'Fire Safety',
    title: { en: 'Fire Extinguisher Inspection' },
    items: [
      { id: 'fe_1', text: { en: 'Extinguisher in correct location' }, description: { en: '' } },
      { id: 'fe_2', text: { en: 'Pressure gauge in green zone' }, description: { en: '' } },
      { id: 'fe_3', text: { en: 'Safety pin and seal intact' }, description: { en: '' } },
      { id: 'fe_4', text: { en: 'No physical damage/corrosion' }, description: { en: '' } },
      { id: 'fe_5', text: { en: 'Inspection tag updated' }, description: { en: '' } }
    ]
  },
  {
    category: 'Fire Safety',
    title: { en: 'Hot Work Area Safety' },
    items: [
      { id: 'hw_1', text: { en: 'Combustibles removed (10m radius)' }, description: { en: '' } },
      { id: 'hw_2', text: { en: 'Fire extinguisher immediately available' }, description: { en: '' } },
      { id: 'hw_3', text: { en: 'Fire watch appointed' }, description: { en: '' } },
      { id: 'hw_4', text: { en: 'Flashback arrestors on gas cylinders' }, description: { en: '' } }
    ]
  },
  {
    category: 'Fire Safety',
    title: { en: 'Emergency Exit Route Check' },
    items: [
      { id: 'er_1', text: { en: 'Exit routes unobstructed' }, description: { en: '' } },
      { id: 'er_2', text: { en: 'Emergency lighting functional' }, description: { en: '' } },
      { id: 'er_3', text: { en: 'Exit signs visible' }, description: { en: '' } },
      { id: 'er_4', text: { en: 'Assembly point clear' }, description: { en: '' } }
    ]
  },

  // --- WORK AT HEIGHT ---
  {
    category: 'Work at Height',
    title: { en: 'Scaffolding Inspection (Weekly)' },
    items: [
      { id: 'sc_1', text: { en: 'Base plates/sole boards secure' }, description: { en: 'Ground is stable' } },
      { id: 'sc_2', text: { en: 'Standards upright and braced' }, description: { en: '' } },
      { id: 'sc_3', text: { en: 'Guardrails and toe boards in place' }, description: { en: 'Top, mid, and toe' } },
      { id: 'sc_4', text: { en: 'Planks secured and no gaps' }, description: { en: '' } },
      { id: 'sc_5', text: { en: 'Scafftag updated (Green)' }, description: { en: '' } }
    ]
  },
  {
    category: 'Work at Height',
    title: { en: 'Ladder Safety Check' },
    items: [
      { id: 'ld_1', text: { en: 'Rungs/steps in good condition' }, description: { en: 'No cracks or bends' } },
      { id: 'ld_2', text: { en: 'Anti-slip feet present' }, description: { en: '' } },
      { id: 'ld_3', text: { en: 'Ladder secured/tied off' }, description: { en: '' } },
      { id: 'ld_4', text: { en: 'Correct angle (1:4 ratio)' }, description: { en: '' } }
    ]
  },
  {
    category: 'Work at Height',
    title: { en: 'Safety Harness Inspection' },
    items: [
      { id: 'sh_1', text: { en: 'Webbing free from cuts/fraying' }, description: { en: '' } },
      { id: 'sh_2', text: { en: 'Buckles and D-rings distortion-free' }, description: { en: '' } },
      { id: 'sh_3', text: { en: 'Shock absorber intact (not deployed)' }, description: { en: '' } },
      { id: 'sh_4', text: { en: 'Inspection tag valid' }, description: { en: '' } }
    ]
  },
  {
    category: 'Work at Height',
    title: { en: 'MEWP Pre-Use Inspection' },
    items: [
      { id: 'mw_1', text: { en: 'Controls functioning correctly' }, description: { en: '' } },
      { id: 'mw_2', text: { en: 'Tires/wheels in good condition' }, description: { en: '' } },
      { id: 'mw_3', text: { en: 'Outriggers/stabilizers functional' }, description: { en: '' } },
      { id: 'mw_4', text: { en: 'Emergency lowering mechanism working' }, description: { en: '' } }
    ]
  },

  // --- ELECTRICAL ---
  {
    category: 'Electrical',
    title: { en: 'Portable Power Tools Check' },
    items: [
      { id: 'pt_1', text: { en: 'Casing intact (no cracks)' }, description: { en: '' } },
      { id: 'pt_2', text: { en: 'Cables free from damage/tape' }, description: { en: '' } },
      { id: 'pt_3', text: { en: 'Plug intact and fused correctly' }, description: { en: '' } },
      { id: 'pt_4', text: { en: 'PAT test tag valid' }, description: { en: '' } }
    ]
  },
  {
    category: 'Electrical',
    title: { en: 'Temporary Electrical Panel' },
    items: [
      { id: 'ep_1', text: { en: 'Panel door closed and locked' }, description: { en: '' } },
      { id: 'ep_2', text: { en: 'ELCB/RCD installed and tested' }, description: { en: '' } },
      { id: 'ep_3', text: { en: 'Cables routed safely (overhead/underground)' }, description: { en: '' } },
      { id: 'ep_4', text: { en: 'Proper earthing connected' }, description: { en: '' } }
    ]
  },
  {
    category: 'Electrical',
    title: { en: 'Lock Out Tag Out (LOTO) Audit' },
    items: [
      { id: 'lo_1', text: { en: 'Isolation points identified' }, description: { en: '' } },
      { id: 'lo_2', text: { en: 'Locks and tags applied' }, description: { en: '' } },
      { id: 'lo_3', text: { en: 'Keys held by authorized person' }, description: { en: '' } },
      { id: 'lo_4', text: { en: 'Zero energy verified' }, description: { en: '' } }
    ]
  },

  // --- EXCAVATION ---
  {
    category: 'Excavation',
    title: { en: 'Daily Excavation Inspection' },
    items: [
      { id: 'ex_1', text: { en: 'Shoring/benching adequate' }, description: { en: '' } },
      { id: 'ex_2', text: { en: 'No water accumulation' }, description: { en: '' } },
      { id: 'ex_3', text: { en: 'Access/egress (ladder) every 7.5m' }, description: { en: '' } },
      { id: 'ex_4', text: { en: 'Spoil pile 1m away from edge' }, description: { en: '' } },
      { id: 'ex_5', text: { en: 'Barriers and signage in place' }, description: { en: '' } }
    ]
  },

  // --- LIFTING ---
  {
    category: 'Lifting',
    title: { en: 'Crane Pre-Use Inspection' },
    items: [
      { id: 'cr_1', text: { en: 'Visual check of wire ropes' }, description: { en: '' } },
      { id: 'cr_2', text: { en: 'Outriggers fully extended' }, description: { en: '' } },
      { id: 'cr_3', text: { en: 'Load chart available' }, description: { en: '' } },
      { id: 'cr_4', text: { en: 'Anti-two block device working' }, description: { en: '' } },
      { id: 'cr_5', text: { en: 'Ground conditions stable' }, description: { en: '' } }
    ]
  },
  {
    category: 'Lifting',
    title: { en: 'Lifting Gear Inspection' },
    items: [
      { id: 'lg_1', text: { en: 'Slings free from cuts/abrasion' }, description: { en: '' } },
      { id: 'lg_2', text: { en: 'Shackles not distorted' }, description: { en: '' } },
      { id: 'lg_3', text: { en: 'Hooks have safety latches' }, description: { en: '' } },
      { id: 'lg_4', text: { en: 'Color code current' }, description: { en: '' } }
    ]
  },

  // --- VEHICLES & PLANT ---
  {
    category: 'Vehicles',
    title: { en: 'Heavy Equipment Inspection' },
    items: [
      { id: 'he_1', text: { en: 'Brakes functioning' }, description: { en: '' } },
      { id: 'he_2', text: { en: 'Reverse alarm working' }, description: { en: '' } },
      { id: 'he_3', text: { en: 'Lights and mirrors intact' }, description: { en: '' } },
      { id: 'he_4', text: { en: 'No hydraulic leaks' }, description: { en: '' } },
      { id: 'he_5', text: { en: 'Operator license valid' }, description: { en: '' } }
    ]
  },
  {
    category: 'Vehicles',
    title: { en: 'Light Vehicle Check' },
    items: [
      { id: 'lv_1', text: { en: 'Seatbelts working' }, description: { en: '' } },
      { id: 'lv_2', text: { en: 'Tires tread depth adequate' }, description: { en: '' } },
      { id: 'lv_3', text: { en: 'Indicators and lights working' }, description: { en: '' } },
      { id: 'lv_4', text: { en: 'First aid kit and extinguisher present' }, description: { en: '' } }
    ]
  },

  // --- CHEMICALS ---
  {
    category: 'Chemicals',
    title: { en: 'Chemical Storage Inspection' },
    items: [
      { id: 'ch_1', text: { en: 'MSDS available for all chemicals' }, description: { en: '' } },
      { id: 'ch_2', text: { en: 'Containers labeled correctly' }, description: { en: '' } },
      { id: 'ch_3', text: { en: 'Secondary containment (drip trays) used' }, description: { en: '' } },
      { id: 'ch_4', text: { en: 'Spill kit available nearby' }, description: { en: '' } },
      { id: 'ch_5', text: { en: 'Ventilation adequate' }, description: { en: '' } }
    ]
  },

  // --- WELFARE ---
  {
    category: 'Welfare',
    title: { en: 'Canteen / Dining Area Hygiene' },
    items: [
      { id: 'wf_1', text: { en: 'Tables and chairs clean' }, description: { en: '' } },
      { id: 'wf_2', text: { en: 'Hand washing facilities working' }, description: { en: '' } },
      { id: 'wf_3', text: { en: 'Drinking water available' }, description: { en: '' } },
      { id: 'wf_4', text: { en: 'Bins provided and emptied' }, description: { en: '' } },
      { id: 'wf_5', text: { en: 'No pest infestation signs' }, description: { en: '' } }
    ]
  },
  {
    category: 'Welfare',
    title: { en: 'Toilet / Washroom Inspection' },
    items: [
      { id: 'tl_1', text: { en: 'Toilets clean and flushed' }, description: { en: '' } },
      { id: 'tl_2', text: { en: 'Soap and paper towels available' }, description: { en: '' } },
      { id: 'tl_3', text: { en: 'Lights working' }, description: { en: '' } },
      { id: 'tl_4', text: { en: 'Cleaning schedule signed' }, description: { en: '' } }
    ]
  },

  // --- OFFICE ---
  {
    category: 'Office',
    title: { en: 'Office Safety Inspection' },
    items: [
      { id: 'of_1', text: { en: 'Walkways clear of cables/boxes' }, description: { en: '' } },
      { id: 'of_2', text: { en: 'Fire exits unlocked and clear' }, description: { en: '' } },
      { id: 'of_3', text: { en: 'Electrical sockets not overloaded' }, description: { en: '' } },
      { id: 'of_4', text: { en: 'Shelving units stable' }, description: { en: '' } }
    ]
  },
  {
    category: 'Office',
    title: { en: 'Ergonomic Assessment' },
    items: [
      { id: 'er_1', text: { en: 'Chair adjusted correctly' }, description: { en: '' } },
      { id: 'er_2', text: { en: 'Monitor at eye level' }, description: { en: '' } },
      { id: 'er_3', text: { en: 'Keyboard/mouse within reach' }, description: { en: '' } },
      { id: 'er_4', text: { en: 'Lighting causes no glare' }, description: { en: '' } }
    ]
  },

  // --- ENVIRONMENT ---
  {
    category: 'Environment',
    title: { en: 'Waste Management Check' },
    items: [
      { id: 'wm_1', text: { en: 'Waste segregated (General/Hazardous/Recyclable)' }, description: { en: '' } },
      { id: 'wm_2', text: { en: 'Bins labeled and covered' }, description: { en: '' } },
      { id: 'wm_3', text: { en: 'No littering on site' }, description: { en: '' } },
      { id: 'wm_4', text: { en: 'Hazardous waste stored in bunded area' }, description: { en: '' } }
    ]
  },
  {
    category: 'Environment',
    title: { en: 'Spill Control Inspection' },
    items: [
      { id: 'sp_1', text: { en: 'Spill kits fully stocked' }, description: { en: '' } },
      { id: 'sp_2', text: { en: 'Drip trays under static plant' }, description: { en: '' } },
      { id: 'sp_3', text: { en: 'No evidence of ground contamination' }, description: { en: '' } }
    ]
  },

  // --- CONFINED SPACE ---
  {
    category: 'Confined Space',
    title: { en: 'Confined Space Entry Check' },
    items: [
      { id: 'cs_1', text: { en: 'Gas test conducted and safe' }, description: { en: '' } },
      { id: 'cs_2', text: { en: 'Ventilation running' }, description: { en: '' } },
      { id: 'cs_3', text: { en: 'Attendant (Standby Man) present' }, description: { en: '' } },
      { id: 'cs_4', text: { en: 'Rescue equipment (tripod/harness) ready' }, description: { en: '' } },
      { id: 'cs_5', text: { en: 'Communication system tested' }, description: { en: '' } }
    ]
  }
];

==================================================
FILE: .\src\hooks\useFirestore.ts
==================================================

import { useState, useEffect } from 'react';
import { 
  collection, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  query, 
  orderBy
} from 'firebase/firestore';
import { db } from '../firebase';

// Generic hook to fetch real-time data from a collection
export const useCollection = <T>(collectionName: string, initialData: T[] = []) => {
  const [data, setData] = useState<T[]>(initialData);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    try {
      const q = query(collection(db, collectionName), orderBy('created_at', 'desc'));
      
      const unsubscribe = onSnapshot(q, (snapshot) => {
        const results: any[] = [];
        snapshot.forEach((doc) => {
          results.push({ id: doc.id, ...doc.data() });
        });
        setData(results);
        setLoading(false);
      }, (err) => {
        console.error(`Error fetching ${collectionName}:`, err);
        setError(err.message);
        setLoading(false);
      });

      return () => unsubscribe();
    } catch (err: any) {
      // Fallback if query fails (e.g. missing index or offline)
      console.warn(`Firestore query failed for ${collectionName}, falling back to simple fetch.`);
      const unsubscribe = onSnapshot(collection(db, collectionName), (snapshot) => {
         const results: any[] = [];
         snapshot.forEach((doc) => {
           results.push({ id: doc.id, ...doc.data() });
         });
         setData(results);
         setLoading(false);
      });
      return () => unsubscribe();
    }
  }, [collectionName]);

  return { data, loading, error };
};

// CRUD Helpers
export const addDocument = async (collectionName: string, data: any) => {
  try {
    // Add server timestamp
    const docRef = await addDoc(collection(db, collectionName), {
      ...data,
      created_at: new Date().toISOString(), // Store as string for easier frontend parsing
      updated_at: new Date().toISOString()
    });
    return docRef.id;
  } catch (error) {
    console.error("Error adding document: ", error);
    throw error;
  }
};

export const updateDocument = async (collectionName: string, id: string, data: any) => {
  try {
    const docRef = doc(db, collectionName, id);
    await updateDoc(docRef, {
      ...data,
      updated_at: new Date().toISOString()
    });
  } catch (error) {
    console.error("Error updating document: ", error);
    throw error;
  }
};

export const deleteDocument = async (collectionName: string, id: string) => {
  try {
    await deleteDoc(doc(db, collectionName, id));
  } catch (error) {
    console.error("Error deleting document: ", error);
    throw error;
  }
};

==================================================
FILE: .\src\lib\gemini.js
==================================================

import { GoogleGenerativeAI } from "@google/generative-ai";

const apiKey = import.meta.env.VITE_GEMINI_API_KEY;
const genAI = new GoogleGenerativeAI(apiKey);

// THE WORD "export" BELOW IS CRITICAL
export async function generateSafetyReport(userInput) {
  if (!userInput) return null;

  try {
    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
    const prompt = `
      Act as a Senior HSE Officer.
      Convert this incident description into a JSON safety report.
      Incident: "${userInput}"

      Output JSON format only:
      {
        "title": "Short professional title",
        "description": "Technical description of what happened",
        "rootCause": "Likely root cause",
        "recommendation": "Actionable step to fix",
        "riskLevel": "Low, Medium, or High"
      }
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    const cleanJson = text.replace(/```json|```/g, '').trim();
    
    return JSON.parse(cleanJson);
  } catch (error) {
    console.error("AI Generation Error:", error);
    return null;
  }
}

==================================================
FILE: .\src\services\dbService.ts
==================================================

import { 
  collection, 
  addDoc, 
  updateDoc, 
  doc, 
  getDocs, 
  query, 
  orderBy 
} from "firebase/firestore";
import { db } from "../firebase";
import type { Report, Project, Ptw, Inspection } from "../types";

// --- GENERIC HELPERS ---

// Helper to fetch all documents from a collection
const fetchCollection = async <T>(collectionName: string): Promise<T[]> => {
  try {
    const q = query(collection(db, collectionName), orderBy("created_at", "desc"));
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as T));
  } catch (error) {
    console.error(`Error fetching ${collectionName}:`, error);
    return [];
  }
};

// Helper to add a document
const addDocument = async (collectionName: string, data: any) => {
  try {
    const docRef = await addDoc(collection(db, collectionName), {
      ...data,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    });
    console.log(`Document written to ${collectionName} with ID: `, docRef.id);
    return { id: docRef.id, ...data };
  } catch (error) {
    console.error(`Error adding to ${collectionName}:`, error);
    throw error;
  }
};

// --- SPECIFIC FUNCTIONS ---

// 1. PROJECTS
export const getProjects = () => fetchCollection<Project>("projects");
export const createProject = (data: any) => addDocument("projects", data);

// 2. REPORTS (Incidents)
export const getReports = () => fetchCollection<Report>("reports");
export const createReport = (data: any) => addDocument("reports", data);
export const updateReport = async (id: string, data: any) => {
  const ref = doc(db, "reports", id);
  await updateDoc(ref, { ...data, updated_at: new Date().toISOString() });
};

// 3. PERMITS (PTW)
export const getPtws = () => fetchCollection<Ptw>("ptws");
export const createPtw = (data: any) => addDocument("ptws", data);
export const updatePtw = async (id: string, data: any) => {
  const ref = doc(db, "ptws", id);
  await updateDoc(ref, { ...data, updated_at: new Date().toISOString() });
};

// 4. INSPECTIONS
export const getInspections = () => fetchCollection<Inspection>("inspections");
export const createInspection = (data: any) => addDocument("inspections", data);
export const updateInspection = async (id: string, data: any) => {
  const ref = doc(db, "inspections", id);
  await updateDoc(ref, { ...data, updated_at: new Date().toISOString() });
};

==================================================
FILE: .\src\services\emailService.ts
==================================================

import emailjs from '@emailjs/browser';

// --- CONFIGURATION ---
const SERVICE_ID = "service_eqrbs0v"; 
const TEMPLATE_ID_INVITE = "template_usz6c6u"; 
const TEMPLATE_ID_DOC = "template_usz6c6u"; // Using the same template for docs for now
const PUBLIC_KEY = "W0kvh4Mc_PKDX4AQf"; 

export const sendInviteEmail = async (
  toEmail: string,
  toName: string,
  role: string,
  orgName: string,
  inviterName: string
) => {
  try {
    const templateParams = {
      to_email: toEmail,
      to_name: toName,
      role: role,
      org_name: orgName,
      inviter_name: inviterName,
      invite_link: window.location.origin, // The URL of your app
    };

    await emailjs.send(SERVICE_ID, TEMPLATE_ID_INVITE, templateParams, PUBLIC_KEY);
    return true;
  } catch (error) {
    console.error("Failed to send email:", error);
    throw error;
  }
};

export const sendDocumentEmail = async (
  toEmail: string,
  documentTitle: string,
  documentLink: string,
  _message: string // Prefixed with _ to indicate unused
) => {
  try {
    const templateParams = {
      to_email: toEmail,
      // We map these to the variables available in your 'Welcome' template
      // Since we are reusing the invite template, we map title -> org_name for now
      // Ideally, you create a specific 'Document' template later.
      to_name: "User", 
      org_name: documentTitle, 
      inviter_name: "EviroSafe System",
      role: "Viewer",
      invite_link: documentLink,
    };

    await emailjs.send(SERVICE_ID, TEMPLATE_ID_DOC, templateParams, PUBLIC_KEY);
    return true;
  } catch (error) {
    console.error("Failed to send email:", error);
    throw error;
  }
};

==================================================
FILE: .\src\services\firestoreService.ts
==================================================

import { db } from '../firebase';
import { 
  collection, 
  addDoc, 
  updateDoc, 
  doc, 
  query, 
  onSnapshot
} from 'firebase/firestore';

// --- GENERIC HELPERS ---

// 1. Real-time Listener (Auto-updates when DB changes)
export const subscribeToCollection = (collectionName: string, callback: (data: any[]) => void) => {
  try {
    // Order by created_at descending (newest first)
    // Note: You might need to create an index in Firebase Console if this query fails initially,
    // but usually it works fine for small datasets.
    const q = query(collection(db, collectionName)); 
    
    return onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      callback(data);
    });
  } catch (error) {
    console.error(`Error subscribing to ${collectionName}:`, error);
    return () => {}; // Return empty unsubscribe function
  }
};

// 2. Add Document
export const addToCollection = async (collectionName: string, data: any) => {
  try {
    // Firestore doesn't like 'undefined', so we sanitize the object
    const cleanData = JSON.parse(JSON.stringify(data));
    
    const docRef = await addDoc(collection(db, collectionName), {
      ...cleanData,
      created_at: new Date().toISOString(), // Store as string for easy frontend parsing
      updated_at: new Date().toISOString()
    });
    console.log(`Document written to ${collectionName} with ID: ${docRef.id}`);
    return docRef.id;
  } catch (e) {
    console.error("Error adding document: ", e);
    throw e;
  }
};

// 3. Update Document
export const updateInCollection = async (collectionName: string, docId: string, data: any) => {
  try {
    const cleanData = JSON.parse(JSON.stringify(data));
    const docRef = doc(db, collectionName, docId);
    
    await updateDoc(docRef, {
      ...cleanData,
      updated_at: new Date().toISOString()
    });
    console.log(`Document ${docId} updated in ${collectionName}`);
  } catch (e) {
    console.error("Error updating document: ", e);
    throw e;
  }
};

==================================================
FILE: .\src\services\geminiService.ts
==================================================

import { GoogleGenerativeAI } from "@google/generative-ai";

// Initialize Gemini
const apiKey = (import.meta as any).env.VITE_GEMINI_API_KEY || "";
const genAI = new GoogleGenerativeAI(apiKey);

// --- FIX: Use 'gemini-pro' (Standard Model) ---
const model = genAI.getGenerativeModel({ model: "gemini-pro" });

// --- HELPER: CLEAN JSON ---
const cleanJson = (text: string) => {
  return text.replace(/```json/g, "").replace(/```/g, "").trim();
};

// --- 1. GENERIC RESPONSE ---
export const generateResponse = async (prompt: string) => {
  if (!apiKey) return "AI not configured. Please add VITE_GEMINI_API_KEY.";
  try {
    const result = await model.generateContent(prompt);
    return result.response.text();
  } catch (error) {
    console.error("AI Error:", error);
    return "Error generating response. Please check your API Key.";
  }
};

// --- 2. INCIDENT ANALYSIS ---
export const generateSafetyReport = async (prompt: string) => {
  if (!apiKey) return mockSafetyReport(prompt);

  try {
    const result = await model.generateContent(`
      Act as a Senior HSE Manager. Analyze this incident description: "${prompt}".
      Return a JSON object with these fields:
      - description: A professional summary of the event.
      - rootCause: The likely root cause (Human Error, Equipment Failure, Process, Environment).
      - riskLevel: High, Medium, or Low.
      - recommendation: 3 bullet points of immediate corrective actions.
    `);
    const response = await result.response;
    return JSON.parse(cleanJson(response.text()));
  } catch (error) {
    console.error("AI Error:", error);
    return mockSafetyReport(prompt);
  }
};

// --- 3. RAMS GENERATION ---
export const generateRamsContent = async (activity: string) => {
  if (!apiKey) return mockRams(activity);

  try {
    const result = await model.generateContent(`
      Create a Method Statement for construction activity: "${activity}".
      Return strictly valid JSON with this structure:
      {
        "overview": "Brief summary of the work",
        "competence": "Required training/certs",
        "emergency_arrangements": "Emergency procedures",
        "sequence_of_operations": [
          {
            "step_no": 1,
            "description": "Step description",
            "hazards": [{"id": "h1", "description": "Hazard name"}],
            "controls": [{"id": "c1", "description": "Control measure", "hierarchy": "engineering"}],
            "risk_before": {"severity": 4, "likelihood": 4},
            "risk_after": {"severity": 2, "likelihood": 2}
          }
        ]
      }
    `);
    const response = await result.response;
    return JSON.parse(cleanJson(response.text()));
  } catch (error) {
    return mockRams(activity);
  }
};

// --- 4. TOOLBOX TALK GENERATION ---
export const generateTbtContent = async (topic: string) => {
  if (!apiKey) return mockTbt(topic);

  try {
    const result = await model.generateContent(`
      Create a Toolbox Talk for: "${topic}".
      Return JSON:
      {
        "summary": "Key message",
        "hazards": ["Hazard 1", "Hazard 2"],
        "controls": ["Control 1", "Control 2"],
        "questions": ["Question 1", "Question 2"]
      }
    `);
    const response = await result.response;
    return JSON.parse(cleanJson(response.text()));
  } catch (error) {
    return mockTbt(topic);
  }
};

// --- 5. COURSE GENERATION ---
export const generateCourseContent = async (title: string) => {
  if (!apiKey) return mockCourse(title);

  try {
    const result = await model.generateContent(`
      Create a training syllabus for: "${title}".
      Return JSON:
      {
        "syllabus": "Markdown formatted syllabus content",
        "learning_objectives": ["Obj 1", "Obj 2", "Obj 3"]
      }
    `);
    const response = await result.response;
    return JSON.parse(cleanJson(response.text()));
  } catch (error) {
    return mockCourse(title);
  }
};

// --- 6. CERTIFICATION INSIGHT ---
export const generateCertificationInsight = async (profile: any) => {
  if (!apiKey) return mockCertInsight();

  try {
    const result = await model.generateContent(`
      Analyze this HSE profile: ${JSON.stringify(profile)}.
      Suggest 1 recommendation to reach the next level and 2 missing requirements.
      Return JSON: { "nextLevelRecommendation": "string", "missingItems": ["string"] }
    `);
    const response = await result.response;
    return JSON.parse(cleanJson(response.text()));
  } catch (error) {
    return mockCertInsight();
  }
};

export const generateReportSummary = async (json: string) => {
    if (!apiKey) return "AI Summary unavailable (No API Key).";
    try {
        const result = await model.generateContent(`Summarize this incident report in 2 sentences: ${json}`);
        return result.response.text();
    } catch (e) { return "Error generating summary."; }
};

export const translateText = async (text: string, lang: string) => {
    if (!apiKey) return `[Mock Translate]: ${text}`;
    try {
        const result = await model.generateContent(`Translate this to ${lang}: "${text}"`);
        return result.response.text();
    } catch (e) { return text; }
};

export const generateAiRiskForecast = async () => {
    return {
        risk_level: 'Medium',
        summary: 'AI Analysis: Moderate risk due to high activity levels and potential heat stress.',
        recommendations: ['Enforce hydration breaks', 'Check lifting gear certification', 'Monitor wind speeds']
    };
};

export const getPredictiveInsights = generateAiRiskForecast;

// --- FALLBACK MOCKS ---
const mockSafetyReport = (prompt: string) => ({
  description: `Report: ${prompt}`,
  rootCause: "Pending Investigation",
  riskLevel: "Medium",
  recommendation: "Review safety procedures and conduct TBT."
});

const mockRams = (activity: string) => ({
  overview: `Method Statement for ${activity}`,
  competence: "Standard HSE Training",
  emergency_arrangements: "Muster Point A",
  sequence_of_operations: [{
    step_no: 1, description: "Prepare work area",
    hazards: [{ id: "h1", description: "General Hazard" }],
    controls: [{ id: "c1", description: "Standard Controls", hierarchy: "administrative" }],
    risk_before: { severity: 3, likelihood: 3 },
    risk_after: { severity: 2, likelihood: 1 }
  }]
});

const mockTbt = (topic: string) => ({
  summary: `Discussion on ${topic}`,
  hazards: ["General Hazard"],
  controls: ["Follow SOP"],
  questions: ["Do you understand the risks?"]
});

const mockCourse = (title: string) => ({
  syllabus: `# ${title}\n\nStandard syllabus content.`,
  learning_objectives: ["Understand basics", "Safety compliance"]
});

const mockCertInsight = () => ({
  nextLevelRecommendation: "Continue logging safe hours.",
  missingItems: ["Advanced Training"]
});

==================================================
FILE: .\src\services\pdfService.ts
==================================================

import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

export const generatePdf = async (elementId: string, fileName: string) => {
  const element = document.getElementById(elementId);
  if (!element) {
    console.error(`Element with id ${elementId} not found`);
    return;
  }

  try {
    // 1. Capture the element as a high-res canvas
    const canvas = await html2canvas(element, {
      scale: 2, // Increases resolution for crisp text
      useCORS: true, // Allows loading cross-origin images (like avatars)
      logging: false,
      backgroundColor: '#fdfbf7', // Match certificate background
      windowWidth: 1920 // Force desktop rendering width
    });

    // 2. Convert to PDF
    const imgData = canvas.toDataURL('image/png');
    
    // A4 Landscape dimensions in mm
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    });

    const pdfWidth = 297;
    const pdfHeight = 210;

    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${fileName}.pdf`);

  } catch (error) {
    console.error("PDF Generation Error:", error);
    alert("Failed to generate PDF. Please try again.");
  }
};

==================================================
FILE: .\src\services\reportService.ts
==================================================

import { db } from "../firebase";
import { collection, addDoc, getDocs, query, orderBy } from "firebase/firestore";

// We use "reports" to keep it separate from your old test data
const REPORTS_COLLECTION = "reports";

// 1. SAVE a new report
export const saveReportToDb = async (reportData: any) => {
  try {
    const docRef = await addDoc(collection(db, REPORTS_COLLECTION), {
      ...reportData,
      created_at: new Date().toISOString(),
    });
    console.log("Saved to Cloud with ID: ", docRef.id);
    return { id: docRef.id, ...reportData };
  } catch (e) {
    console.error("Error saving to DB: ", e);
    throw e;
  }
};

// 2. LOAD all reports
export const fetchReportsFromDb = async () => {
  try {
    const q = query(collection(db, REPORTS_COLLECTION), orderBy("created_at", "desc"));
    const querySnapshot = await getDocs(q);
    
    return querySnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
  } catch (e) {
    console.error("Error loading from DB: ", e);
    return [];
  }
};

==================================================
FILE: .\src\services\storageService.ts
==================================================

import { storage } from '../firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';

export const uploadFileToCloud = async (file: File, folder: string = 'general'): Promise<string> => {
  try {
    // 1. Create a reference
    const filename = `${folder}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
    const storageRef = ref(storage, filename);
    
    // 2. Try to upload (This will fail if no bucket exists)
    console.log(`Attempting upload for ${file.name}...`);
    const snapshot = await uploadBytes(storageRef, file);
    
    // 3. Get URL if successful
    return await getDownloadURL(snapshot.ref);

  } catch (error: any) {
    // 4. CATCH THE ERROR so the app doesn't crash
    console.warn("Storage Upload Failed (likely no bucket or CORS). Using placeholder.");
    
    // Return a fake image URL so the report can still be submitted
    return `https://placehold.co/600x400/FF0000/FFFFFF?text=Storage+Not+Configured`;
  }
};

==================================================
FILE: .\src\services\supabaseService.ts
==================================================


import type { Project, Report, Inspection, ChecklistRun, Plan, Rams, TbtSession, TrainingCourse, TrainingRecord, TrainingSession, Notification, Ptw, Sign, ChecklistTemplate } from '../types';
import { 
    projects as initialProjects, 
    reports as initialReports, 
    inspections as initialInspections, 
    checklistRuns as initialChecklistRuns, 
    plans as initialPlans, 
    rams as initialRams, 
    tbtSessions as initialTbtSessions, 
    trainingCourses as initialTrainingCourses, 
    trainingRecords as initialTrainingRecords, 
    trainingSessions as initialTrainingSessions, 
    notifications as initialNotifications, 
    ptws as initialPtws,
    signs as initialSigns,
    checklistTemplates as initialChecklistTemplates
} from '../data';

// --- API Wrapper ---
// In a real app, this would come from an auth context after login.
const FAKE_AUTH_TOKEN = 'fake-jwt-token-for-demonstration';
const API_BASE_URL = '/api'; // Placeholder for the real backend URL

const apiFetch = async (endpoint: string, options: RequestInit = {}) => {
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${FAKE_AUTH_TOKEN}`,
        ...options.headers,
    };
    const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
    if (!response.ok) {
        throw new Error(`API call failed: ${response.statusText}`);
    }
    return response.json();
};


// --- MOCK DATABASE (localStorage for Projects) ---
const DB_KEY = 'evirosafe_db';

const getDb = () => {
    try {
        const db = localStorage.getItem(DB_KEY);
        if (db) return JSON.parse(db);
    } catch (error) {
        console.error("Error reading from localStorage", error);
    }
    const initialDb = { projects: initialProjects };
    localStorage.setItem(DB_KEY, JSON.stringify(initialDb));
    return initialDb;
};

const saveDb = (db: any) => {
    try {
        localStorage.setItem(DB_KEY, JSON.stringify(db));
    } catch (error) {
        console.error("Error writing to localStorage", error);
    }
};


// --- API FUNCTIONS ---
// Each function now demonstrates how a real API call would be made,
// with a fallback to the mock data to keep the demo app functional.

export const getProjects = async (): Promise<Project[]> => {
    try {
        return await apiFetch('/projects');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getProjects.");
        const db = getDb();
        return db.projects || [];
    }
};

export const createProject = async (projectData: Omit<Project, 'id'>): Promise<Project> => {
    try {
        return await apiFetch('/projects', {
            method: 'POST',
            body: JSON.stringify(projectData),
        });
    } catch (error) {
        // console.debug("Offline mode: using mock implementation for createProject.");
        const db = getDb();
        const newProject: Project = { ...projectData, id: `proj_${Date.now()}` };
        db.projects.push(newProject);
        saveDb(db);
        return newProject;
    }
};

export const getReports = async (): Promise<Report[]> => {
    try {
        return await apiFetch('/reports');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getReports.");
        return initialReports;
    }
};

export const getPtws = async (): Promise<Ptw[]> => {
    try {
        return await apiFetch('/ptws');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getPtws.");
        return initialPtws;
    }
};

export const getInspections = async (): Promise<Inspection[]> => {
    try {
        return await apiFetch('/inspections');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getInspections.");
        return initialInspections;
    }
};

export const getChecklistRuns = async (): Promise<ChecklistRun[]> => {
    try {
        return await apiFetch('/checklist-runs');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getChecklistRuns.");
        return initialChecklistRuns;
    }
};

export const getPlans = async (): Promise<Plan[]> => {
    try {
        return await apiFetch('/plans');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getPlans.");
        return initialPlans;
    }
};

export const getRams = async (): Promise<Rams[]> => {
    try {
        return await apiFetch('/rams');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getRams.");
        return initialRams;
    }
};

export const getTbtSessions = async (): Promise<TbtSession[]> => {
    try {
        return await apiFetch('/tbt-sessions');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getTbtSessions.");
        return initialTbtSessions;
    }
};

export const getTrainingCourses = async (): Promise<TrainingCourse[]> => {
    try {
        return await apiFetch('/training-courses');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getTrainingCourses.");
        return initialTrainingCourses;
    }
};

export const getTrainingRecords = async (): Promise<TrainingRecord[]> => {
    try {
        return await apiFetch('/training-records');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getTrainingRecords.");
        return initialTrainingRecords;
    }
};

export const getTrainingSessions = async (): Promise<TrainingSession[]> => {
    try {
        return await apiFetch('/training-sessions');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getTrainingSessions.");
        return initialTrainingSessions;
    }
};

export const getNotifications = async (): Promise<Notification[]> => {
    try {
        return await apiFetch('/notifications');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getNotifications.");
        return initialNotifications;
    }
};

export const getSigns = async (): Promise<Sign[]> => {
    try {
        return await apiFetch('/signs');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getSigns.");
        return initialSigns;
    }
};

export const getChecklistTemplates = async (): Promise<ChecklistTemplate[]> => {
    try {
        return await apiFetch('/checklist-templates');
    } catch (error) {
        // console.debug("Offline mode: using mock data for getChecklistTemplates.");
        return initialChecklistTemplates;
    }
};


==================================================
FILE: .\src\types\hse-inspection.ts
==================================================

export type InspectionType = 'safety' | 'environmental' | 'health' | 'fire' | 'equipment' | 'process';

export interface Evidence {
  id: string;
  type: 'photograph' | 'video_recording' | 'audio_note' | 'document_scan';
  title: string;
  description: string;
  url: string;
  file_name: string;
  file_size: number;
  file_type: string;
  uploaded_by: string;
  uploaded_at: Date;
  gps_coordinates?: { latitude: number; longitude: number; accuracy: number };
  timestamp: Date;
  device_info?: any;
  tags: string[];
  encrypted: boolean;
  access_control: string[];
}

export interface ChecklistResponse {
  value: 'pass' | 'fail' | 'na';
  comments?: string;
  evidence_ids?: string[];
  timestamp: Date;
  responder: string;
}

export interface ChecklistItem {
  id: string;
  category?: string;
  requirement: string;
  criteria: string;
  response?: ChecklistResponse;
}

export interface HSEFinding {
  id: string;
  finding_number: string;
  type: 'non_conformity' | 'observation' | 'opportunity_for_improvement' | 'compliment';
  description: string;
  risk_assessment: {
    severity: 1 | 2 | 3 | 4 | 5;
    likelihood: 1 | 2 | 3 | 4 | 5;
    risk_score: number;
    risk_level: 'low' | 'medium' | 'high' | 'extreme';
    people_at_risk: number;
    potential_consequences: string[];
  };
  status: 'open' | 'closed';
  created_at: Date;
  updated_at: Date;
  created_by: string;
  evidence_ids: string[];
  corrective_action_required: boolean;
}

export interface HSEInspection {
  inspection_id?: string;
  title: string;
  entity_id: string; // Project ID
  type: InspectionType;
  schedule?: {
    scheduled_date: Date;
    scheduled_time: string;
  };
  inspection_team?: {
    team_lead?: { id: string; name: string; role: string; qualification: string; contact: any };
    inspectors?: any[];
  };
  checklist_items?: ChecklistItem[];
  findings?: HSEFinding[];
  evidence?: Evidence[];
  status?: string;
}

==================================================
FILE: .\src\types\ptw.ts
==================================================

// src/types/ptw.ts

export type PtwType = 
  | 'Utility Work'
  | 'Work at Height'
  | 'General Work'
  | 'Confined Space Entry'
  | 'Night Work'
  | 'Electrical Work'
  | 'Excavation'
  | 'Hot Work'
  | 'Road Closure'
  | 'Lifting'
  | 'Mechanical Work'
  | 'Chemical Handling';

export type PtwStatus = 
  | 'DRAFT'
  | 'SUBMITTED'
  | 'PRE_SCREEN'
  | 'SITE_INSPECTION'
  | 'APPROVAL'
  | 'ACTIVE'
  | 'HOLD'
  | 'CLOSED'
  | 'COMPLETED'
  | 'REJECTED'
  | 'CANCELLED';

export type PtwCategory = 'standard' | 'operational' | 'emergency' | 'urgent';

// ========== BASE PTW INTERFACES ==========
export interface PtwPpe {
  hard_hat: boolean;
  safety_harness: boolean;
  safety_shoes: boolean;
  goggles: boolean;
  coverall: boolean;
  respirator: boolean;
  safety_gloves: boolean;
  vest: boolean;
  hearing_protection?: boolean;
  face_shield?: boolean;
  chemical_suit?: boolean;
  apron?: boolean;
  rubber_boots?: boolean;
}

export interface PtwSafetyRequirement {
  id: string;
  text: string;
  response: 'Yes' | 'No' | 'N/A';
}

export interface PtwSignoff {
  name: string;
  designation?: string;
  email?: string;
  mobile?: string;
  signature: string;
  remarks?: string;
  signed_at?: string;
}

export interface PtwStoppage {
  reason: string;
  stopped_by: string;
  informed_to: string;
  time: string;
  restarted_time?: string;
  signature?: string;
}

export interface PtwExtension {
  is_requested: boolean;
  reason?: string;
  days: {
    from: string;
    to: string;
  };
  hours: {
    from: string;
    to: string;
  };
  approved?: boolean;
  approved_by?: string;
  approved_at?: string;
}

export interface PtwClosure {
  note?: string;
  permit_requester: PtwSignoff;
  client_proponent: PtwSignoff;
  client_hs: PtwSignoff;
}

export interface PtwJointInspection {
  remarks: string;
  requester: { signature: string };
  client_proponent: { signature: string };
  client_hs: { signature: string };
}

// ========== TYPE-SPECIFIC PAYLOADS ==========
export interface PtwUtilityWorkPayload {
  community_announcement_required: boolean;
  underground_drawings_available: boolean;
  backup_plan_available: boolean;
  road_diversion_plan_available: boolean;
  service_shutdown_required: boolean;
  utility_type: 'water' | 'sewer' | 'electricity' | 'gas' | 'telecom';
  as_built_drawings_available: boolean;
}

export interface PtwWorkAtHeightPayload {
  access_equipment: {
    step_ladder: boolean;
    independent_scaffolding: boolean;
    tower_mobile_scaffolding: boolean;
    scissor_lift: boolean;
    articulated_telescopic_boom: boolean;
    boatswain_chair: boolean;
    man_basket: boolean;
    rope_access_system: boolean;
    roof_ladder: boolean;
    other: string;
  };
  fall_protection: {
      anchor_points_certified: boolean;
      rescue_plan_available: boolean;
      weather_monitoring: boolean;
  };
}

export interface PtwGeneralWorkPayload {
  msds_coshh_available: boolean;
  toolbox_talk_conducted: boolean;
  drinking_water_available: boolean;
  rest_area_available: boolean;
  first_aid_available: boolean;
  heat_stress_precautions: {
    work_rest_cycle: boolean;
    shades_ventilation: boolean;
    light_clothing: boolean;
  };
}

export interface PtwConfinedSpacePayload {
  gas_tests: any[];
  entry_log: any[];
  rescue_plan: {
    team_available: boolean;
    equipment_available: boolean;
    practiced_recently: boolean;
  };
}

export interface PtwNightWorkPayload {
  hi_visibility_jackets_available: boolean;
  flashing_beacon_lights: boolean;
  communication_tools_available: boolean;
  continuous_supervision: boolean;
  work_rotation_planned: boolean;
  emergency_arrangements: boolean;
  lighting_level_lux: number;
  rest_area_provided: boolean;
}

export interface PtwElectricalWorkPayload {
  personnel_qualified: boolean;
  fiberglass_ladder_required: boolean;
  no_jewelry_metal: boolean;
  area_free_from_hazards: boolean;
  equipment_properly_grounded: boolean;
  deenergization_infeasible: boolean;
  voltage_level: 'low' | 'medium' | 'high';
  loto_procedure: string;
  insulated_tools_class: string;
}

export interface PtwExcavationPayload {
  soil_type: 'A' | 'B' | 'C';
  cave_in_protection: string[];
  utilities_marked: boolean;
  daily_inspection_required: boolean;
  safety_shoring: {
      type: string;
      installed_by: string;
      inspection_date: string;
  };
}

export interface PtwHotWorkPayload {
  fire_watcher: {
    name: string;
    mobile: string;
    certified: boolean;
  };
  post_watch_minutes: number;
  fire_precautions: {
    extinguishers_available: boolean;
    water_supply_available: boolean;
    combustibles_removed: boolean;
    fire_blanket_available: boolean;
  };
}

export interface PtwRoadClosurePayload {
  closure_type: 'partial' | 'complete';
  traffic_management: {
    alternative_route_planned?: boolean;
    signage_reflective?: boolean;
    sunflower_lights_available?: boolean;
    banksman_appointed?: boolean;
    speed_limit_signs_erected?: boolean;
    plan_available: boolean;
    signage_available: boolean;
    flaggers_certified: boolean;
  };
}

export interface PtwLiftingPayload {
  load_calculation: {
    hook_rigging_weight?: number;
    load_weight: number;
    total_weight?: number;
    boom_length?: number;
    max_working_radius?: number;
    crane_capacity_at_radius?: number;
    crane_capacity: number;
    utilization_percent: number;
    lift_plan_ref: string;
    crane_certification_no: string;
    operator_certification_no: string;
  };
}

// ========== CANONICAL PTW PAYLOAD ==========
export interface CanonicalPtwPayload {
  creator_id: string;
  permit_no: string;
  category: PtwCategory;
  requester: {
    name: string;
    email: string;
    mobile: string;
    designation: string;
    contractor: string;
    signature: string;
    hse_certified?: boolean;
  };
  contractor_safety_personnel: {
    name: string;
    email: string;
    mobile: string;
    designation: string;
    signature: string;
  };
  work: {
    location: string;
    description: string;
    coverage: {
      start_date: string;
      end_date: string;
      start_time: string;
      end_time: string;
    };
    associated_permits: string[];
    number_of_workers?: number;
    work_method_statement?: string;
    emergency_contact?: string;
    risk_assessment_ref?: string;
    environmental_concerns?: string;
  };
  safety_requirements: PtwSafetyRequirement[];
  ppe: PtwPpe;
  signoffs: {
    client_proponent: PtwSignoff;
    other_stakeholders: PtwSignoff[];
    client_hs: PtwSignoff;
  };
  joint_inspection: PtwJointInspection;
  holding_or_stoppage: PtwStoppage[];
  extension: PtwExtension;
  closure: PtwClosure;
  attachments: any[];
  audit: any[];
  global_compliance?: {
    standards: string[];
    requirements_met: Record<string, boolean>;
    created_at: string;
    last_audit: string | null;
  };
}

// ========== MAIN PTW DOCUMENT ==========
export interface Ptw {
  id: string;
  org_id: string;
  project_id: string;
  type: PtwType;
  status: PtwStatus;
  title: string;
  payload: CanonicalPtwPayload & (
    | PtwUtilityWorkPayload
    | PtwWorkAtHeightPayload
    | PtwGeneralWorkPayload
    | PtwConfinedSpacePayload
    | PtwNightWorkPayload
    | PtwElectricalWorkPayload
    | PtwExcavationPayload
    | PtwHotWorkPayload
    | PtwRoadClosurePayload
    | PtwLiftingPayload
  );
  created_at: string;
  updated_at: string;
  version: string;
  compliance_level: 'FULL' | 'PARTIAL' | 'NONE';
}

==================================================
FILE: .\src\utils\pdfGenerator.ts
==================================================

import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

export const generatePDF = async (elementId: string, fileName: string) => {
  const element = document.getElementById(elementId);
  if (!element) {
    console.error(`Element with ID '${elementId}' not found.`);
    return;
  }

  try {
    const canvas = await html2canvas(element, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff'
    });

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    const imgX = (pdfWidth - imgWidth * ratio) / 2;
    const imgY = 10;

    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
    pdf.save(`${fileName}.pdf`);

  } catch (error) {
    console.error("PDF Generation failed:", error);
    alert("Failed to generate PDF.");
  }
};

==================================================
FILE: .\src\utils\ptwLogic.ts
==================================================

import type { Ptw, PtwType, PtwRiskAnalysis, SimopsConflict } from '../types';

// Mock Asset Database
export const ASSETS = [
    { id: 'PUMP-001', name: 'Main Feed Pump A', location: 'Zone 1', status: 'Running' },
    { id: 'TANK-505', name: 'Crude Storage Tank', location: 'Zone 3', status: 'Maintenance' },
    { id: 'SUB-B', name: 'Substation B', location: 'Zone 2', status: 'Live' },
];

// 1. Algorithmic Risk Scoring
export const calculateDynamicRisk = (
    type: PtwType, 
    isNightWork: boolean, 
    weatherCondition: 'Clear' | 'Rain' | 'Windy' | 'Hot'
): PtwRiskAnalysis => {
    let baseScore = 10;
    let complexity = 1;
    
    // Base Risk by Type
    switch(type) {
        case 'Hot Work': baseScore = 40; complexity = 1.5; break;
        case 'Confined Space Entry': baseScore = 50; complexity = 2.0; break;
        case 'Lifting': baseScore = 35; complexity = 1.8; break;
        case 'Electrical Work': baseScore = 45; complexity = 1.9; break;
        case 'Excavation': baseScore = 30; complexity = 1.4; break;
        default: baseScore = 10;
    }

    // Environmental Factors
    let weatherFactor = 1.0;
    if (weatherCondition === 'Windy' && type === 'Lifting') weatherFactor = 1.5;
    if (weatherCondition === 'Rain' && type === 'Electrical Work') weatherFactor = 2.0;
    if (weatherCondition === 'Hot') weatherFactor = 1.2;

    // Time Factor
    const timeFactor = isNightWork ? 1.4 : 1.0;

    // Calculation
    const totalScore = Math.min(100, Math.round(baseScore * complexity * weatherFactor * timeFactor));
    
    let level: PtwRiskAnalysis['risk_level'] = 'Low';
    if (totalScore > 75) level = 'Critical';
    else if (totalScore > 50) level = 'High';
    else if (totalScore > 25) level = 'Medium';

    // AI Suggestions
    const suggestions = [];
    if (level === 'Critical') suggestions.push('Mandatory Independent Verification (IV) required.');
    if (isNightWork) suggestions.push('Ensure auxiliary lighting towers are deployed.');
    if (weatherCondition === 'Hot') suggestions.push('Implement heat stress management plan (15/45 cycle).');

    return {
        base_score: baseScore,
        complexity_factor: complexity,
        weather_factor: weatherFactor,
        time_factor: timeFactor,
        total_risk_score: totalScore,
        risk_level: level,
        auto_controls: suggestions
    };
};

// 2. SIMOPS Detection (Spatial Conflict)
export const checkSimopsConflicts = (
    currentLocation: string, 
    activePermits: Ptw[]
): SimopsConflict[] => {
    const conflicts: SimopsConflict[] = [];
    
    // Simple string matching for demo (In real life, use GIS coordinates)
    const nearbyPermits = activePermits.filter(p => 
        p.status === 'ACTIVE' && 
        p.payload.work.location.toLowerCase().includes(currentLocation.toLowerCase())
    );

    nearbyPermits.forEach(p => {
        conflicts.push({
            conflicting_ptw_id: p.id,
            conflict_type: 'Spatial',
            description: `Conflict with active permit #${p.payload.permit_no} (${p.type}) in same location.`
        });
    });

    return conflicts;
};

// 3. Competency Check (Mock)
export const verifyCompetency = (_userId: string, role: string, _ptwType: string): boolean => {
    // In a real app, check database for valid certificates
    // For demo, we assume everyone is competent except "Guest"
    return role !== 'GUEST';
};

==================================================
FILE: .\src\utils\ramsUtils.ts
==================================================

// src/utils/ramsUtils.ts
import type { RamsStatus } from '../types';

export const getStatusColor = (status: RamsStatus): 'green' | 'blue' | 'yellow' | 'red' | 'gray' => {
  switch (status) {
    case 'published': return 'green';
    case 'approved': return 'blue';
    case 'under_review': return 'yellow';
    case 'archived': return 'gray';
    case 'draft':
    default: return 'gray';
  }
};

export const getStatusDisplayText = (status: RamsStatus | undefined | null): string => {
  if (!status) return 'Unknown'; // <--- FIXED: Safety check
  return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
};

export const getRiskColor = (riskScore: number): 'green' | 'yellow' | 'red' => {
  if (riskScore >= 13) return 'red';
  if (riskScore >= 7) return 'yellow';
  return 'green';
};

export const getRiskLevel = (riskScore: number): 'Low' | 'Medium' | 'High' => {
  if (riskScore >= 13) return 'High';
  if (riskScore >= 7) return 'Medium';
  return 'Low';
};

export const formatDate = (date: Date | string): string => {
  if (!date) return 'N/A';
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};

export const calculateOverallRisk = (steps: any[]): { before: number, after: number } => {
  if (steps.length === 0) return { before: 0, after: 0 };
  const beforeScores = steps.map((s: any) => s.risk_before.severity * s.risk_before.likelihood);
  const afterScores = steps.map((s: any) => s.risk_after.severity * s.risk_after.likelihood);
  return {
    before: Math.max(...beforeScores),
    after: Math.max(...afterScores)
  };
};

==================================================
FILE: .\src\utils\riskUtils.ts
==================================================

import type { RiskMatrix } from '../types';

export const getRiskLevel = (matrix: RiskMatrix): { level: 'Low' | 'Medium' | 'High' | 'Critical', color: 'green' | 'yellow' | 'red' } => {
    // Safety check
    if (!matrix || typeof matrix.severity !== 'number' || typeof matrix.likelihood !== 'number') {
        return { level: 'Low', color: 'green' };
    }
    
    const riskScore = matrix.severity * matrix.likelihood;
    if (riskScore >= 15) return { level: 'Critical', color: 'red' };
    if (riskScore >= 9) return { level: 'High', color: 'red' };
    if (riskScore >= 4) return { level: 'Medium', color: 'yellow' };
    return { level: 'Low', color: 'green' };
};

==================================================
FILE: .\src\utils\workflowEngine.ts
==================================================

import type { Ptw, PtwWorkflowStage, PtwWorkflowLog } from '../types';

export class PtwWorkflowEngine {
  // Define valid transitions
  private static transitions: Record<PtwWorkflowStage, PtwWorkflowStage[]> = {
    DRAFT: ['REQUESTED', 'SUBMITTED'],
    SUBMITTED: ['PRE_SCREEN', 'DRAFT'],
    PRE_SCREEN: ['SITE_INSPECTION', 'REJECTED'],
    SITE_INSPECTION: ['APPROVAL', 'REJECTED'],
    REQUESTED: ['ISSUER_REVIEW', 'DRAFT'],
    ISSUER_REVIEW: ['ISSUER_SIGNED', 'DRAFT'],
    ISSUER_SIGNED: ['IV_REVIEW', 'PENDING_APPROVAL'],
    IV_REVIEW: ['PENDING_APPROVAL', 'DRAFT'],
    PENDING_APPROVAL: ['APPROVAL'],
    APPROVAL: ['APPROVER_SIGNED', 'DRAFT', 'ACTIVE'],
    APPROVER_SIGNED: ['AUTHORIZATION'],
    AUTHORIZATION: ['HANDOVER_PENDING'],
    HANDOVER_PENDING: ['SITE_HANDOVER'],
    SITE_HANDOVER: ['ACTIVE'],
    ACTIVE: ['SUSPENDED', 'COMPLETION_PENDING', 'HOLD', 'COMPLETED'],
    HOLD: ['ACTIVE', 'CANCELLED'],
    SUSPENDED: ['ACTIVE', 'CANCELLED'],
    COMPLETION_PENDING: ['JOINT_INSPECTION'],
    COMPLETED: ['CLOSED'],
    JOINT_INSPECTION: ['CLOSED', 'ACTIVE'],
    CLOSED: ['ARCHIVED'],
    CANCELLED: ['ARCHIVED'],
    REJECTED: ['ARCHIVED'],
    ARCHIVED: []
  };

  // Check if transition is valid
  static canTransition(from: PtwWorkflowStage, to: PtwWorkflowStage): boolean {
    return this.transitions[from]?.includes(to) || false;
  }

  // Get next possible stages
  static getNextStages(current: PtwWorkflowStage): PtwWorkflowStage[] {
    return this.transitions[current] || [];
  }

  // Create workflow log entry
  static createLogEntry(
    stage: PtwWorkflowStage,
    action: string,
    userId: string,
    comments?: string
  ): PtwWorkflowLog {
    return {
      stage,
      action,
      user_id: userId,
      timestamp: new Date().toISOString(),
      comments,
      signoff_type: 'digital'
    };
  }

  // Validate role permissions for transition
  static validateRolePermission(
    currentStage: PtwWorkflowStage,
    userRole: string,
    _userId: string,
    _ptw: Ptw
  ): { allowed: boolean; message: string } {
    const isAdmin = userRole === 'ADMIN';
    const isHSE = userRole === 'HSE_MANAGER';
    const isIssuer = userRole === 'SUPERVISOR' || userRole === 'HSE_MANAGER';
    const isApprover = userRole === 'HSE_MANAGER' || userRole === 'ORG_ADMIN';
    const isReceiver = true;

    if (isAdmin) return { allowed: true, message: 'Admin Override' };

    switch (currentStage) {
      case 'DRAFT':
        return { allowed: true, message: '' };
      
      case 'REQUESTED':
      case 'SUBMITTED':
        return { allowed: isIssuer || isHSE, message: 'Only issuer can review requested permits' };
      
      case 'ISSUER_REVIEW':
      case 'PRE_SCREEN':
        return { allowed: isIssuer, message: 'Only issuer can sign off on review' };
      
      case 'ISSUER_SIGNED':
      case 'SITE_INSPECTION':
        return { allowed: true, message: '' };
      
      case 'PENDING_APPROVAL':
      case 'APPROVAL':
        return { allowed: isApprover, message: 'Only approver can review and sign' };
      
      case 'AUTHORIZATION':
        return { allowed: isIssuer, message: 'Only issuer can authorize permit' };
      
      case 'HANDOVER_PENDING':
      case 'SITE_HANDOVER':
        return { allowed: isReceiver || isIssuer, message: 'Only receiver can accept handover' };
      
      case 'ACTIVE':
        return { allowed: isReceiver || isIssuer, message: 'Only receiver can update work status' };
      
      case 'COMPLETION_PENDING':
      case 'COMPLETED':
        return { allowed: isReceiver || isIssuer, message: 'Only receiver can mark work complete' };
      
      case 'JOINT_INSPECTION':
        return { allowed: isIssuer || isHSE, message: 'Joint inspection requires issuer' };
      
      case 'CLOSED':
        return { allowed: isIssuer, message: 'Only issuer can close permit' };
      
      default:
        return { allowed: false, message: 'Action not allowed' };
    }
  }
}
